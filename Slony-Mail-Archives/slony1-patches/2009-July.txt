From aleksander.kmetec at intera.si  Sat Jul 25 00:29:52 2009
From: aleksander.kmetec at intera.si (Aleksander Kmetec)
Date: Sat Jul 25 00:30:23 2009
Subject: [Slony1-patches] Patch for dataloss & statement blocking bug in
	logswitch_finish()
Message-ID: <4A6AB470.5060004@intera.si>

SGksCgp0aGUgYXR0YWNoZWQgcGF0Y2ggZml4ZXMgMiBidWdzIEkgcHJldmlvdXNseSByZXBvcnRl
ZCBvbiBzbG9ueTEtZ2VuZXJhbC4KCkRhdGFsb3NzIGJ1ZywgZGVzY3JpYmVkIGhlcmU6Cmh0dHA6
Ly9saXN0cy5zbG9ueS5pbmZvL3BpcGVybWFpbC9zbG9ueTEtZ2VuZXJhbC8yMDA5LUp1bHkvMDA5
NjYzLmh0bWwKClN0YXRlbWVudCBibG9ja2luZyBidWcsIGRlc2NyaWJlZCBoZXJlOgpodHRwOi8v
bGlzdHMuc2xvbnkuaW5mby9waXBlcm1haWwvc2xvbnkxLWdlbmVyYWwvMjAwOS1KdWx5LzAwOTY2
NC5odG1sCgpUaGUgcmVhc29uIGZvciBib3RoIGJ1Z3Mgd2FzIHRoZSBUUlVOQ0FURSBzdGF0ZW1l
bnQgd2hpY2ggd291bGQgd2FpdCB1bnRpbCB0aGUgY29uY3VycmVudCB0cmFuc2FjdGlvbiB3aGlj
aCB3YXMgd3JpdGluZyAKdG8gc2xfbG9nX04gd291bGQgY29tbWl0LCBhdCB3aGljaCBwb2ludCBp
dCB3b3VsZCBpbW1lZGlhdGVseSBkZXN0cm95IGFsbCB0aGUgcm93cyBjcmVhdGVkIGJ5IHRoYXQg
dHJhbnNhY3Rpb24uIFdoaWxlIAp3YWl0aW5nIGZvciBhIGxvbmdlciBwZXJpb2Qgb2YgdGltZSwg
aXQgd291bGQgYWxzbyBibG9jayBvdGhlciB0cmFuc2FjdGlvbnMgZnJvbSB3cml0aW5nIHRvIHNs
X2xvZ19OLCBjYXVzaW5nIHN0YXRlbWVudHMgCnRvIHRpbWUgb3V0LgoKQnkgdHJ5aW5nIHRvIGdl
dCBhbiBleGNsdXNpdmUgbG9jayBvbiBzbF9sb2dfTiAoYW5kIGV4aXRpbmcgaWYgdGhhdCBmYWls
cykgaXQgaXMgZ3VhcmFudGVlZCB0aGF0IFRSVU5DQVRFIHdpbGwgbm90IGJlIApleGVjdXRlZCB3
aGlsZSBhbm90aGVyIHRyYW5zYWN0aW9uIGlzIHdyaXRpbmcgdG8gc2xfbG9nLgoKV2hhdCBJIGRv
bid0IGtub3cgaXMgd2hldGhlciB0aGlzIGNoYW5nZSB3aWxsIGhhdmUgYW55IG5lZ2F0aXZlIGVm
ZmVjdCBvbiBsb2cgc3dpdGNoaW5nIGFuZCByb3cgYWNjdW11bGF0aW9uIGluIGxvZyAKdGFibGVz
LiBIb3BlZnVsbHksIHNvbWVvbmUgd2lsbCBiZSBhYmxlIHRvIHRlbGwgaWYgdGhlcmUgYXJlIHVu
d2FudGVkIHNpZGUgZWZmZWN0cy4KClRoZSBwYXRjaCBpcyBhZ2FpbnN0IENWUyBIRUFEICh3aGlj
aCBkb2Vzbid0IGJ1aWxkIHJpZ2h0IG5vdywgQlRXLCBiZWNhdXNlIHNsb255MV9iYXNlLnY4NC5z
cWwgYW5kIHNsb255MV9mdW5jcy52ODQuc3FsIApmaWxlcyBhcmUgbWlzc2luZykuCgpSZWdhcmRz
LApBbGVrc2FuZGVyCi0tLS0tLS0tLS0tLS0tIG5leHQgcGFydCAtLS0tLS0tLS0tLS0tLQpJbmRl
eDogc3JjL2JhY2tlbmQvc2xvbnkxX2Z1bmNzLnNxbA0KPT09PT09PT09PT09PT09PT09PT09PT09
PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KUkNTIGZpbGU6IC9z
bG9ueTEvc2xvbnkxLWVuZ2luZS9zcmMvYmFja2VuZC9zbG9ueTFfZnVuY3Muc3FsLHYNCnJldHJp
ZXZpbmcgcmV2aXNpb24gMS4xNTANCmRpZmYgLWMgLXIxLjE1MCBzbG9ueTFfZnVuY3Muc3FsDQoq
Kiogc3JjL2JhY2tlbmQvc2xvbnkxX2Z1bmNzLnNxbAkyMSBKdWwgMjAwOSAyMToxODo0MyAtMDAw
MAkxLjE1MA0KLS0tIHNyYy9iYWNrZW5kL3Nsb255MV9mdW5jcy5zcWwJMjUgSnVsIDIwMDkgMDY6
NTc6NTggLTAwMDANCioqKioqKioqKioqKioqKg0KKioqIDUyMzUsNTI0NiAqKioqDQogIAktLSAt
LS0tDQogIAlpZiB2X2N1cnJlbnRfc3RhdHVzID0gMiB0aGVuDQogIAkJdl9wdXJnZWFibGUgOj0g
J3RydWUnOw0KICAJCS0tIC0tLS0NCiAgCQktLSBUaGUgY2xlYW51cCB0aHJlYWQgY2FsbHMgdXMg
YWZ0ZXIgaXQgZGlkIHRoZSBkZWxldGUgYW5kDQogIAkJLS0gdmFjdXVtIG9mIGJvdGggbG9nIHRh
Ymxlcy4gSWYgc2xfbG9nXzIgaXMgZW1wdHkgbm93LCB3ZQ0KICAJCS0tIGNhbiB0cnVuY2F0ZSBp
dCBhbmQgdGhlIGxvZyBzd2l0Y2ggaXMgZG9uZS4NCiAgCQktLSAtLS0tDQotIAkJDQogIAkgICAg
ICAgIGZvciB2X29yaWdpbiwgdl9zZXFubywgdl94bWluIGluDQogIAkJICBzZWxlY3QgZXZfb3Jp
Z2luLCBldl9zZXFubywgInBnX2NhdGFsb2ciLnR4aWRfc25hcHNob3RfeG1pbihldl9zbmFwc2hv
dCkgZnJvbSBATkFNRVNQQUNFQC5zbF9ldmVudA0KICAJICAgICAgICAgIHdoZXJlIChldl9vcmln
aW4sIGV2X3NlcW5vKSBpbiAoc2VsZWN0IGV2X29yaWdpbiwgbWluKGV2X3NlcW5vKSBmcm9tIEBO
QU1FU1BBQ0VALnNsX2V2ZW50IHdoZXJlIGV2X3R5cGUgPSAnU1lOQycgZ3JvdXAgYnkgZXZfb3Jp
Z2luKQ0KLS0tIDUyMzUsNTI2MSAtLS0tDQogIAktLSAtLS0tDQogIAlpZiB2X2N1cnJlbnRfc3Rh
dHVzID0gMiB0aGVuDQogIAkJdl9wdXJnZWFibGUgOj0gJ3RydWUnOw0KKyAJCQ0KKyAJCS0tIC0t
LS0NCisgCQktLSBBdHRlbXB0IHRvIGxvY2sgc2xfbG9nXzIgaW4gb3JkZXIgdG8gbWFrZSBzdXJl
IHRoZXJlIGFyZSBubyBvdGhlciB0cmFuc2FjdGlvbnMgDQorIAkJLS0gY3VycmVudGx5IHdyaXRp
bmcgdG8gaXQuIEV4aXQgaWYgaXQgaXMgc3RpbGwgaW4gdXNlLiBUaGlzIHByZXZlbnRzIFRSVU5D
QVRFIGZyb20gDQorIAkJLS0gYmxvY2tpbmcgd3JpdGVycyB0byBzbF9sb2dfMiB3aGlsZSBpdCBp
cyB3YWl0aW5nIGZvciBhIGxvY2suIEl0IGFsc28gcHJldmVudHMgaXQgDQorIAkJLS0gaW1tZWRp
YXRlbHkgdHJ1bmNhdGluZyBsb2cgZGF0YSBnZW5lcmF0ZWQgaW5zaWRlIHRoZSB0cmFuc2FjdGlv
biB3aGljaCB3YXMgYWN0aXZlIA0KKyAJCS0tIHdoZW4gbG9nc3dpdGNoX2ZpbmlzaCgpIHdhcyBj
YWxsZWQgKGFuZCB3YXMgYmxvY2tpbmcgVFJVTkNBVEUpIGFzIHNvb24gYXMgdGhhdCANCisgCQkt
LSB0cmFuc2FjdGlvbiBpcyBjb21taXR0ZWQuDQorIAkJLS0gLS0tLQ0KKyAJCWJlZ2luDQorIAkJ
CWxvY2sgdGFibGUgQE5BTUVTUEFDRUAuc2xfbG9nXzIgaW4gZXhjbHVzaXZlIG1vZGUgbm93YWl0
Ow0KKyAJCWV4Y2VwdGlvbiB3aGVuIGxvY2tfbm90X2F2YWlsYWJsZSB0aGVuDQorIAkJCXJhaXNl
IG5vdGljZSAnU2xvbnktSTogY291bGQgbm90IGxvY2sgc2xfbG9nXzIgLSBzbF9sb2dfMiBub3Qg
dHJ1bmNhdGVkJzsNCisgCQkJcmV0dXJuIC0xOw0KKyAJCWVuZDsNCisgDQogIAkJLS0gLS0tLQ0K
ICAJCS0tIFRoZSBjbGVhbnVwIHRocmVhZCBjYWxscyB1cyBhZnRlciBpdCBkaWQgdGhlIGRlbGV0
ZSBhbmQNCiAgCQktLSB2YWN1dW0gb2YgYm90aCBsb2cgdGFibGVzLiBJZiBzbF9sb2dfMiBpcyBl
bXB0eSBub3csIHdlDQogIAkJLS0gY2FuIHRydW5jYXRlIGl0IGFuZCB0aGUgbG9nIHN3aXRjaCBp
cyBkb25lLg0KICAJCS0tIC0tLS0NCiAgCSAgICAgICAgZm9yIHZfb3JpZ2luLCB2X3NlcW5vLCB2
X3htaW4gaW4NCiAgCQkgIHNlbGVjdCBldl9vcmlnaW4sIGV2X3NlcW5vLCAicGdfY2F0YWxvZyIu
dHhpZF9zbmFwc2hvdF94bWluKGV2X3NuYXBzaG90KSBmcm9tIEBOQU1FU1BBQ0VALnNsX2V2ZW50
DQogIAkgICAgICAgICAgd2hlcmUgKGV2X29yaWdpbiwgZXZfc2Vxbm8pIGluIChzZWxlY3QgZXZf
b3JpZ2luLCBtaW4oZXZfc2Vxbm8pIGZyb20gQE5BTUVTUEFDRUAuc2xfZXZlbnQgd2hlcmUgZXZf
dHlwZSA9ICdTWU5DJyBncm91cCBieSBldl9vcmlnaW4pDQoqKioqKioqKioqKioqKioNCioqKiA1
Mjc0LDUyNzkgKioqKg0KLS0tIDUyODksNTMxMCAtLS0tDQogIAktLSAtLS0tDQogIAlpZiB2X2N1
cnJlbnRfc3RhdHVzID0gMyB0aGVuDQogIAkJdl9wdXJnZWFibGUgOj0gJ3RydWUnOw0KKyANCisg
CQktLSAtLS0tDQorIAkJLS0gQXR0ZW1wdCB0byBsb2NrIHNsX2xvZ18xIGluIG9yZGVyIHRvIG1h
a2Ugc3VyZSB0aGVyZSBhcmUgbm8gb3RoZXIgdHJhbnNhY3Rpb25zIA0KKyAJCS0tIGN1cnJlbnRs
eSB3cml0aW5nIHRvIGl0LiBFeGl0IGlmIGl0IGlzIHN0aWxsIGluIHVzZS4gVGhpcyBwcmV2ZW50
cyBUUlVOQ0FURSBmcm9tIA0KKyAJCS0tIGJsb2NraW5nIHdyaXRlcyB0byBzbF9sb2dfMSB3aGls
ZSBpdCBpcyB3YWl0aW5nIGZvciBhIGxvY2suIEl0IGFsc28gcHJldmVudHMgaXQgDQorIAkJLS0g
aW1tZWRpYXRlbHkgdHJ1bmNhdGluZyBsb2cgZGF0YSBnZW5lcmF0ZWQgaW5zaWRlIHRoZSB0cmFu
c2FjdGlvbiB3aGljaCB3YXMgYWN0aXZlIA0KKyAJCS0tIHdoZW4gbG9nc3dpdGNoX2ZpbmlzaCgp
IHdhcyBjYWxsZWQgKGFuZCB3YXMgYmxvY2tpbmcgVFJVTkNBVEUpIGFzIHNvb24gYXMgdGhhdCAN
CisgCQktLSB0cmFuc2FjdGlvbiBpcyBjb21taXR0ZWQuDQorIAkJLS0gLS0tLQ0KKyAJCWJlZ2lu
DQorIAkJCWxvY2sgdGFibGUgQE5BTUVTUEFDRUAuc2xfbG9nXzEgaW4gZXhjbHVzaXZlIG1vZGUg
bm93YWl0Ow0KKyAJCWV4Y2VwdGlvbiB3aGVuIGxvY2tfbm90X2F2YWlsYWJsZSB0aGVuDQorIAkJ
CXJhaXNlIG5vdGljZSAnU2xvbnktSTogY291bGQgbm90IGxvY2sgc2xfbG9nXzEgLSBzbF9sb2df
MSBub3QgdHJ1bmNhdGVkJzsNCisgCQkJcmV0dXJuIC0xOw0KKyAJCWVuZDsNCisgDQogIAkJLS0g
LS0tLQ0KICAJCS0tIFRoZSBjbGVhbnVwIHRocmVhZCBjYWxscyB1cyBhZnRlciBpdCBkaWQgdGhl
IGRlbGV0ZSBhbmQNCiAgCQktLSB2YWN1dW0gb2YgYm90aCBsb2cgdGFibGVzLiBJZiBzbF9sb2df
MiBpcyBlbXB0eSBub3csIHdlDQo=
From cbbrowne at ca.afilias.info  Tue Jul 28 08:59:54 2009
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Tue Jul 28 09:00:04 2009
Subject: [Slony1-patches] Patch for dataloss & statement blocking bug in
	logswitch_finish()
In-Reply-To: <4A6AB470.5060004@intera.si> (Aleksander Kmetec's message of
	"Sat, 25 Jul 2009 09:29:52 +0200")
References: <4A6AB470.5060004@intera.si>
Message-ID: <87skggn6h1.fsf@dba2.int.libertyrms.com>

Aleksander Kmetec <aleksander.kmetec@intera.si> writes:
> the attached patch fixes 2 bugs I previously reported on slony1-general.
>
> Dataloss bug, described here:
> http://lists.slony.info/pipermail/slony1-general/2009-July/009663.html
>
> Statement blocking bug, described here:
> http://lists.slony.info/pipermail/slony1-general/2009-July/009664.html
>
> The reason for both bugs was the TRUNCATE statement which would wait
> until the concurrent transaction which was writing to sl_log_N would
> commit, at which point it would immediately destroy all the rows
> created by that transaction. While waiting for a longer period of
> time, it would also block other transactions from writing to sl_log_N,
> causing statements to time out.
>
> By trying to get an exclusive lock on sl_log_N (and exiting if that
> fails) it is guaranteed that TRUNCATE will not be executed while
> another transaction is writing to sl_log.
>
> What I don't know is whether this change will have any negative effect
> on log switching and row accumulation in log tables. Hopefully,
> someone will be able to tell if there are unwanted side effects.
>

I like that patch a lot!

Thank you, Aleksander!  Will commit to 2.0+HEAD.
-- 
(reverse (concatenate 'string "ofni.sailifa.ac" "@" "enworbbc"))
<http://dba2.int.libertyrms.com/>
Christopher Browne
(416) 673-4124 (land)
"Bother,"  said Pooh,  "Eeyore, ready  two photon  torpedoes  and lock
phasers on the Heffalump, Piglet, meet me in transporter room three"
