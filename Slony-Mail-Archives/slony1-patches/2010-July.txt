From JanWieck at Yahoo.com  Mon Jul  5 09:32:05 2010
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Mon, 05 Jul 2010 12:32:05 -0400
Subject: [Slony1-patches] [Slony1-general] [rangerrick@befunk.com: slony
 patch for osx]
In-Reply-To: <4BFE9A69.6060502@ca.afilias.info>
References: <20100423160654.GA18954@fetter.org>	<4BDC9C8D.104@ca.afilias.info>	<4BDC3FA2.1070703@Yahoo.com>	<4BE18607.70202@ca.afilias.info>	<20100505152058.GB32707@fetter.org>	<4BE1970D.6050400@ca.afilias.info>
	<4BE1CD3B.6000304@ca.afilias.info>
	<4BFE9A69.6060502@ca.afilias.info>
Message-ID: <4C320905.1020302@Yahoo.com>

On 5/27/2010 12:14 PM, Christopher Browne wrote:
> Steve Singer wrote:
>> Steve Singer wrote:
>>> David Fetter wrote:
>>>
>>>
>>> I think I can replace our direct use of yyleng with calls to 
>>> yyget_len() to avoid this issue
>> 
>> 
>> David, does this patch (in addition to the autoconf changes) get things 
>> working on your version of OSX? I've replaced uses of yyleng with 
>> yyget_len() and am having flex generate a proper prototype for it.
>> 
>> 
>> 
>> http://github.com/ssinger/slony/commit/0febbf93046600e3fd7c59e37ca3b14cc137eb64 
> 
> FYI, result of some discussion that should get exposed on list...
> 
> yyget_len() is available on modern versions of flex (at least as far 
> back as 2.5.31, which is what PostgreSQL requires, of late).
> 
> So, I'm suggesting that configure be modified to check for 2.5.31 (or 
> later), for which a sample test may be gotten from config/programs.m4 in 
> the PostgreSQL tree.  Given that, it'll be very clear to people that 
> have any difficulties that they're using a too-old flex.

Has this been done? If not, I'm in favor of this solution.


Jan


> 
> I don't feel badly about going back as far as PostgreSQL does ;-).
> 
> I could do this change; it may be opportunity for Steve to improve his 
> configure-foo.
> 
> That's better than putting some documentation somewhere saying "oh, by 
> the way, you need to use version X of flex".


-- 
Anyone who trades liberty for security deserves neither
liberty nor security. -- Benjamin Franklin

From ssinger at ca.afilias.info  Tue Jul  6 06:29:18 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Tue, 06 Jul 2010 09:29:18 -0400
Subject: [Slony1-patches] bug 118 patch
In-Reply-To: <87fx041l6d.fsf@cbbrowne.afilias-int.info>
References: <4C2B4C5E.3050902@ca.afilias.info>
	<87fx041l6d.fsf@cbbrowne.afilias-int.info>
Message-ID: <4C332FAE.5030602@ca.afilias.info>

Christopher Browne wrote:
> Steve Singer <ssinger at ca.afilias.info> writes:
>> Attached is a patch that fixes bug 118 by performing a TRUNCATE ONLY
>> during the pre-subscription on 8.4 systems.
> 
> I have not tested the patch, but the approach certainly seems apropos
> to me.
> 
> E.g...  
> 
>   - Fold out the TRUNCATE request to a separate function
>   - Function for 8.4 does "TRUNCATE ONLY"
>   - Function for pre-8.4 does "TRUNCATE"
> 

I've applied this to 2.0
I am working on preparing a patch for 1.2, I will post it before I 
commit it.

However, my patch as posted/applied doesn't change the usage of 
'truncate' in the add_empty_table_to_replication function that is called 
by the replicate_partition function in sllony1_funcs.sql.  I don't see 
that function used anywhere.   Chris, do you remember what that function 
is intended for?


-- 
Steve Singer
Afilias Canada
Data Services Developer
416-673-1142

From cbbrowne at ca.afilias.info  Tue Jul  6 12:17:58 2010
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Tue, 06 Jul 2010 15:17:58 -0400
Subject: [Slony1-patches] bug 118 patch
In-Reply-To: <4C332FAE.5030602@ca.afilias.info> (Steve Singer's message of
	"Tue, 06 Jul 2010 09:29:18 -0400")
References: <4C2B4C5E.3050902@ca.afilias.info>
	<87fx041l6d.fsf@cbbrowne.afilias-int.info>
	<4C332FAE.5030602@ca.afilias.info>
Message-ID: <8739vwzaft.fsf@cbbrowne.afilias-int.info>

Steve Singer <ssinger at ca.afilias.info> writes:
> Christopher Browne wrote:
>> Steve Singer <ssinger at ca.afilias.info> writes:
>>> Attached is a patch that fixes bug 118 by performing a TRUNCATE ONLY
>>> during the pre-subscription on 8.4 systems.
>> I have not tested the patch, but the approach certainly seems apropos
>> to me.
>> E.g...    - Fold out the TRUNCATE request to a separate function
>>   - Function for 8.4 does "TRUNCATE ONLY"
>>   - Function for pre-8.4 does "TRUNCATE"
>>
>
> I've applied this to 2.0
> I am working on preparing a patch for 1.2, I will post it before I
> commit it.
>
> However, my patch as posted/applied doesn't change the usage of
> 'truncate' in the add_empty_table_to_replication function that is
> called by the replicate_partition function in sllony1_funcs.sql.  I
> don't see that function used anywhere.   Chris, do you remember what
> that function is intended for?

That's documented as a way of cheaply adding empty inherited
partitions to an existing replication set.  You'd run it inside
EXECUTE SCRIPT.

http://www.slony.info/documentation/partitioning.html
-- 
output = ("cbbrowne" "@" "ca.afilias.info")
Christopher Browne
"Bother,"  said Pooh,  "Eeyore, ready  two photon  torpedoes  and lock
phasers on the Heffalump, Piglet, meet me in transporter room three"

From singh.gurjeet at gmail.com  Wed Jul  7 11:22:17 2010
From: singh.gurjeet at gmail.com (Gurjeet Singh)
Date: Wed, 7 Jul 2010 14:22:17 -0400
Subject: [Slony1-patches] [Slony1-hackers] A small patch for Slony
In-Reply-To: <4C24B795.6070208@ca.afilias.info>
References: <AANLkTileEeTrQUT-8-2j_c4e3xTb1k7j6zyER29g645_@mail.gmail.com> 
	<4C24B795.6070208@ca.afilias.info>
Message-ID: <AANLkTinjrzAaBtp0IBZHMMDKVbOzdyNcmbR7RLhF3E3A@mail.gmail.com>

I haven't tested it, but from the diff it seems that slon_kill.pl message
still needs some fixing.

http://main.slony.info/viewcvs/viewvc.cgi/slony1-engine/tools/altperl/slon_kill.pl?r1=1.14&r2=1.15&diff_format=h

This might cause messages like:
<when killing watchdog>
No slon_watchdog _watchdog  is running for the cluster mycluster!

OR
<when killing slon>
No slon_watchdog   is running for the cluster mycluster!

Also, there are spurious spaces before the word "is"; 2 when killing
watchdog, and 3 when killing slon.

Regards,

On Fri, Jun 25, 2010 at 10:05 AM, Steve Singer <ssinger at ca.afilias.info>wrote:

> Gurjeet Singh wrote:
>
>> Hi All,
>>
>>    Attached is a patch of 2.0.3 with the following:
>>
>> 1) New script slonik_add_node. This adds the capability to add a node to
>> the cluster. This node could be from the fact that the config file was
>> edited to add new node's info, or maybe it was previously dropped from the
>> cluster.
>>
>
> This looks fine to me
>
>
>
>
>> 2) An enhancement to the slonik_drop_node script. The original version
>> assumed that $MASTERNODE is available for this operation to complete, but
>> that might not always be the case. Now one needs to specify an event_node#
>> which should be capable of sending the event notification to other nodes in
>> the cluster.
>>
>>
> This looks fine.
>
>
>
>     For backward compatibility the new parameter can be made optional.
>>
>> 3) A minor improvement to the message emitted by slon_kill, to
>> differentiate between when the Slon processes are being killed vs. when the
>> watchdog processes are being killed.
>>
>>
> I'd rather see  $watchdog_suffix passed as an argument to shut_off_process
> vs using a global argument.  I'd also encourage declaring watchdog_suffix
> with my.  I know the scripts don't currently work with 'use strict' but we
> should aim to get closer to that.
>
> Thanks for your patches.  If no one else has any concerns I'll plan on
> committing these to the 2.0 branch sometime next week.
>
>
>  Regards,
>> --
>> gurjeet.singh
>> @ EnterpriseDB - The Enterprise Postgres Company
>> http://www.enterprisedb.com
>>
>> singh.gurjeet@{ gmail | yahoo }.com
>> Twitter/Skype: singh_gurjeet
>>
>> Mail sent from my BlackLaptop device
>>
>>
>> ------------------------------------------------------------------------
>>
>> _______________________________________________
>> Slony1-hackers mailing list
>> Slony1-hackers at lists.slony.info
>> http://lists.slony.info/mailman/listinfo/slony1-hackers
>>
>
>
> --
> Steve Singer
> Afilias Canada
> Data Services Developer
> 416-673-1142
>



-- 
gurjeet.singh
@ EnterpriseDB - The Enterprise Postgres Company
http://www.EnterpriseDB.com

singh.gurjeet@{ gmail | yahoo }.com
Twitter/Skype: singh_gurjeet

Mail sent from my BlackLaptop device
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-patches/attachments/20100707/9cdb27cf/attachment.htm 

From ssinger at ca.afilias.info  Fri Jul  9 06:21:52 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Fri, 09 Jul 2010 09:21:52 -0400
Subject: [Slony1-patches] fix for bug #120
In-Reply-To: <4C29EF8F.7030001@ca.afilias.info>
References: <4C29EF8F.7030001@ca.afilias.info>
Message-ID: <4C372270.3050703@ca.afilias.info>

Steve Singer wrote:

Attached is a revised version of the patch updated after I talked to Jan 
about it.  Instead we just call rtcfg_enableNode() from the CLONE_NODE 
processing block.

In my testing I am noticing that after a CLONE FINISH I sometimes get 
duplicate key violations trying to insert into sl_event, (I also see 
these with CLONE FINISH without the patch).  I'm thinking that is due to 
another issue with clone node not bug120.

> The attached patch tries to fix bug # 120.
> 
> As it is longer than a trivial patch someone else should look it over 
> before I apply it.
> 
> Thanks
> 
> http://github.com/ssinger/slony/commit/c36394565260d751a493abdfa2b61fb90f2912b3 
> 
> 
> 
> 
> ------------------------------------------------------------------------
> 
> _______________________________________________
> Slony1-patches mailing list
> Slony1-patches at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-patches


-- 
Steve Singer
Afilias Canada
Data Services Developer
416-673-1142
-------------- next part --------------
A non-text attachment was scrubbed...
Name: 0001-Fix-for-Bug-120.patch
Type: text/x-patch
Size: 0 bytes
Desc: not available
Url : http://lists.slony.info/pipermail/slony1-patches/attachments/20100709/21c4d8b5/attachment.bin 

From ssinger at ca.afilias.info  Fri Jul  9 06:17:36 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Fri, 9 Jul 2010 09:17:36 -0400
Subject: [PATCH] Fix for Bug #120
 Call enableNode as part of the CLONE NODE processing.
 This will start the worker thread for the cloned node.
Message-ID: <mailman.5.1278681716.4684.slony1-patches@lists.slony.info>

---
 src/slon/remote_worker.c |   24 +++++++++++++++++++++++-
 1 files changed, 23 insertions(+), 1 deletions(-)

diff --git a/src/slon/remote_worker.c b/src/slon/remote_worker.c
index a3d58e5..1d9670f 100644
--- a/src/slon/remote_worker.c
+++ b/src/slon/remote_worker.c
@@ -830,13 +830,35 @@ remoteWorkerThread_main(void *cdata)
 				int			no_id = (int) strtol(event->ev_data1, NULL, 10);
 				int			no_provider = (int) strtol(event->ev_data2, NULL, 10);
 				char	   *no_comment = event->ev_data3;
+				int64       last_event_id;
+				PGresult   *res;
 
 				rtcfg_storeNode(no_id, no_comment);
-
 				slon_appendquery(&query1,
 							"select %s.cloneNodePrepare_int(%d, %d, '%q'); ",
 								 rtcfg_namespace,
 								 no_id, no_provider, no_comment);
+				slon_appendquery(&query1,"select coalesce(max(con_seqno),0)"
+								 "from %s.sl_confirm "
+								 "  where con_origin = %d  and con_received"
+								 "= %d", rtcfg_namespace, node->no_id, no_id);
+				res = PQexec(local_dbconn, dstring_data(&query1));
+				if (PQresultStatus(res) != PGRES_TUPLES_OK )
+				{
+				  slon_log(SLON_ERROR,"remoteWorkerThread_%d error querying "
+						   "last confirmed id for node %d in CLONE NODE\n",
+						   node->no_id, no_id);
+				  slon_retry();
+				}
+				if( PQntuples(res) 	!= 0)
+				{
+				  last_event_id = strtoll(PQgetvalue(res, 0, 0),NULL,10);
+				  rtcfg_setNodeLastEvent(no_id, last_event_id);
+				}
+				PQclear(res);
+				dstring_reset(&query1);
+				rtcfg_enableNode(no_id);
+
 			}
 			else if (strcmp(event->ev_type, "STORE_PATH") == 0)
 			{
-- 
1.6.3.3


--------------080404030707050004080008--

From ssinger at ca.afilias.info  Fri Jul  9 06:32:59 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Fri, 09 Jul 2010 09:32:59 -0400
Subject: [Slony1-patches] [Slony1-hackers] A small patch for Slony
In-Reply-To: <AANLkTinjrzAaBtp0IBZHMMDKVbOzdyNcmbR7RLhF3E3A@mail.gmail.com>
References: <AANLkTileEeTrQUT-8-2j_c4e3xTb1k7j6zyER29g645_@mail.gmail.com>
	<4C24B795.6070208@ca.afilias.info>
	<AANLkTinjrzAaBtp0IBZHMMDKVbOzdyNcmbR7RLhF3E3A@mail.gmail.com>
Message-ID: <4C37250B.7060408@ca.afilias.info>

Gurjeet Singh wrote:
> I haven't tested it, but from the diff it seems that slon_kill.pl 
> <http://slon_kill.pl> message still needs some fixing.
> 
> http://main.slony.info/viewcvs/viewvc.cgi/slony1-engine/tools/altperl/slon_kill.pl?r1=1.14&r2=1.15&diff_format=h 
> <http://main.slony.info/viewcvs/viewvc.cgi/slony1-engine/tools/altperl/slon_kill.pl?r1=1.14&r2=1.15&diff_format=h>
> 
> This might cause messages like:
> <when killing watchdog>
> No slon_watchdog _watchdog  is running for the cluster mycluster!
> 
> OR
> <when killing slon>
> No slon_watchdog   is running for the cluster mycluster!
> 
> Also, there are spurious spaces before the word "is"; 2 when killing 
> watchdog, and 3 when killing slon.

Thanks,

I've checked in a change for this.

Let me know if you still see issues.

-- 
Steve Singer
Afilias Canada
Data Services Developer
416-673-1142

From z-saito at guitar.ocn.ne.jp  Sat Jul 10 10:54:59 2010
From: z-saito at guitar.ocn.ne.jp (Hiroshi Saito)
Date: Sun, 11 Jul 2010 02:54:59 +0900
Subject: [Slony1-patches] some problem current head for pg91dev
Message-ID: <1A513C5BD09440739707BCCB29111FDF@acer08f817a9b5>

Jan-san.

some strange states now.... 
Please see,
http://winpg.jp/~saito/Slony-I/

I want this to be taken into consideration. 
thanks.

P.S)
Possibly back-patch may be necessity. 

Regards,
Hiroshi Saito
-------------- next part --------------
A non-text attachment was scrubbed...
Name: win32_patch
Type: application/octet-stream
Size: 1727 bytes
Desc: not available
Url : http://lists.slony.info/pipermail/slony1-patches/attachments/20100711/09c7dcb6/attachment.obj 

From JanWieck at Yahoo.com  Mon Jul 12 06:24:52 2010
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Mon, 12 Jul 2010 09:24:52 -0400
Subject: [Slony1-patches] fix for bug #120
In-Reply-To: <4C372270.3050703@ca.afilias.info>
References: <4C29EF8F.7030001@ca.afilias.info>
	<4C372270.3050703@ca.afilias.info>
Message-ID: <4C3B17A4.1070109@Yahoo.com>

On 7/9/2010 9:21 AM, Steve Singer wrote:
> Steve Singer wrote:
> 
> Attached is a revised version of the patch updated after I talked to Jan 
> about it.  Instead we just call rtcfg_enableNode() from the CLONE_NODE 
> processing block.
> 
> In my testing I am noticing that after a CLONE FINISH I sometimes get 
> duplicate key violations trying to insert into sl_event, (I also see 
> these with CLONE FINISH without the patch).  I'm thinking that is due to 
> another issue with clone node not bug120.

Me thinks this would possibly be a slightly too old sl_confirm, 
resulting in the clone trying to apply events that the source had 
already processed again.

This would very much depend on how the clone was actually created. 
Assume you create a clone of node 2 as node 3. If there is a gap between 
the prepare clone and when the actual copy is made, a running slon for 
node 2 has time to process more events. IIRC it is the clone preparation 
that creates the configuration copy including the content of sl_confirm.

Can you make sure that in your tests you stop the slon before doing the 
clone prepare and restart it only after the pg_dump transaction for the 
cloning has taken its snapshot?


Jan

> 
>> The attached patch tries to fix bug # 120.
>> 
>> As it is longer than a trivial patch someone else should look it over 
>> before I apply it.
>> 
>> Thanks
>> 
>> http://github.com/ssinger/slony/commit/c36394565260d751a493abdfa2b61fb90f2912b3 
>> 
>> 
>> 
>> 
>> ------------------------------------------------------------------------
>> 
>> _______________________________________________
>> Slony1-patches mailing list
>> Slony1-patches at lists.slony.info
>> http://lists.slony.info/mailman/listinfo/slony1-patches
> 
> 
> 
> 
> ------------------------------------------------------------------------
> 
> _______________________________________________
> Slony1-patches mailing list
> Slony1-patches at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-patches


-- 
Anyone who trades liberty for security deserves neither
liberty nor security. -- Benjamin Franklin

From ssinger at ca.afilias.info  Mon Jul 12 07:38:26 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Mon, 12 Jul 2010 10:38:26 -0400
Subject: [Slony1-patches] fix for bug #120
In-Reply-To: <4C3B17A4.1070109@Yahoo.com>
References: <4C29EF8F.7030001@ca.afilias.info>
	<4C372270.3050703@ca.afilias.info> <4C3B17A4.1070109@Yahoo.com>
Message-ID: <4C3B28E2.3080501@ca.afilias.info>

Jan Wieck wrote:
> On 7/9/2010 9:21 AM, Steve Singer wrote:
>> Steve Singer wrote:
> 
> Me thinks this would possibly be a slightly too old sl_confirm, 
> resulting in the clone trying to apply events that the source had 
> already processed again.
> 
> This would very much depend on how the clone was actually created. 
> Assume you create a clone of node 2 as node 3. If there is a gap between 
> the prepare clone and when the actual copy is made, a running slon for 
> node 2 has time to process more events. IIRC it is the clone preparation 
> that creates the configuration copy including the content of sl_confirm.
> 
> Can you make sure that in your tests you stop the slon before doing the 
> clone prepare and restart it only after the pg_dump transaction for the 
> cloning has taken its snapshot?

I'm thinking that this was actually being caused by an issue in my test 
that was leaving an old version of the 'clone' database around from the 
previous run.  Since addressing that issue I've been unable to reproduce 
those duplicates in my log.

That doesn't really answer the question of do you need to stop the slons 
  in-between the CLONE PREPARE and taking the pg_dump.  If this is the 
case then we should update the documentation but I'm not yet convinced 
that this is the case.



> 
> 
> Jan
> 
>>
>>> The attached patch tries to fix bug # 120.
>>>
>>> As it is longer than a trivial patch someone else should look it over 
>>> before I apply it.
>>>
>>> Thanks
>>>
>>> http://github.com/ssinger/slony/commit/c36394565260d751a493abdfa2b61fb90f2912b3 
>>>
>>>
>>>
>>>
>>> ------------------------------------------------------------------------
>>>
>>> _______________________________________________
>>> Slony1-patches mailing list
>>> Slony1-patches at lists.slony.info
>>> http://lists.slony.info/mailman/listinfo/slony1-patches
>>
>>
>>
>>
>> ------------------------------------------------------------------------
>>
>> _______________________________________________
>> Slony1-patches mailing list
>> Slony1-patches at lists.slony.info
>> http://lists.slony.info/mailman/listinfo/slony1-patches
> 
> 


-- 
Steve Singer
Afilias Canada
Data Services Developer
416-673-1142

From JanWieck at Yahoo.com  Mon Jul 12 08:03:21 2010
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Mon, 12 Jul 2010 11:03:21 -0400
Subject: [Slony1-patches] fix for bug #120
In-Reply-To: <4C3B28E2.3080501@ca.afilias.info>
References: <4C29EF8F.7030001@ca.afilias.info>
	<4C372270.3050703@ca.afilias.info> <4C3B17A4.1070109@Yahoo.com>
	<4C3B28E2.3080501@ca.afilias.info>
Message-ID: <4C3B2EB9.4080806@Yahoo.com>

On 7/12/2010 10:38 AM, Steve Singer wrote:
> Jan Wieck wrote:
>> On 7/9/2010 9:21 AM, Steve Singer wrote:
>>> Steve Singer wrote:
>> 
>> Me thinks this would possibly be a slightly too old sl_confirm, 
>> resulting in the clone trying to apply events that the source had 
>> already processed again.
>> 
>> This would very much depend on how the clone was actually created. 
>> Assume you create a clone of node 2 as node 3. If there is a gap between 
>> the prepare clone and when the actual copy is made, a running slon for 
>> node 2 has time to process more events. IIRC it is the clone preparation 
>> that creates the configuration copy including the content of sl_confirm.
>> 
>> Can you make sure that in your tests you stop the slon before doing the 
>> clone prepare and restart it only after the pg_dump transaction for the 
>> cloning has taken its snapshot?
> 
> I'm thinking that this was actually being caused by an issue in my test 
> that was leaving an old version of the 'clone' database around from the 
> previous run.  Since addressing that issue I've been unable to reproduce 
> those duplicates in my log.
> 
> That doesn't really answer the question of do you need to stop the slons 
>   in-between the CLONE PREPARE and taking the pg_dump.  If this is the 
> case then we should update the documentation but I'm not yet convinced 
> that this is the case.

If my assumption is right and the sl_confirm data for the new node is 
generated at CLONE PREPARE time, then you definitely need to stop at 
least the slon that serves the node you are cloning during that. 
Otherwise the clone thinks it did not process events yet that got 
processed and confirmed by the clone source in between.


Jan

-- 
Anyone who trades liberty for security deserves neither
liberty nor security. -- Benjamin Franklin

From ssinger at ca.afilias.info  Tue Jul 13 06:06:36 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Tue, 13 Jul 2010 09:06:36 -0400
Subject: [Slony1-patches] monitor the startup status of localListenThread
Message-ID: <4C3C64DC.1070002@ca.afilias.info>


If the localListenThread terminates before it signals the main slon 
thread that the localListener has started then the main slon thread will 
block forever on this condition waiting for a signal that will never come.

This patch will set a status flag to indicate that the local listen has 
failed to start and signal the mutex.



-- 
Steve Singer
Afilias Canada
Data Services Developer
416-673-1142
-------------- next part --------------
A non-text attachment was scrubbed...
Name: 0001-Fix-for-when-local-listen-fails-to-start-properly.patch
Type: text/x-patch
Size: 0 bytes
Desc: not available
Url : http://lists.slony.info/pipermail/slony1-patches/attachments/20100713/38979981/attachment.bin 

From ssinger at ca.afilias.info  Tue Jul 13 06:02:54 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Tue, 13 Jul 2010 09:02:54 -0400
Subject: [PATCH] Fix for when local listen fails to start properly.
 It was observed that slon can wait for the local listen cond
 to be set where the local listener thread stops on an error.
 In this case we want to signal the mutex but flag the local listener
 as not having started.  The main slon thread should then abort.
Message-ID: <mailman.6.1279026399.4684.slony1-patches@lists.slony.info>

---
 src/slon/local_listen.c |    9 +++++++++
 src/slon/slon.c         |    9 +++++++++
 src/slon/slon.h         |    2 +-
 3 files changed, 19 insertions(+), 1 deletions(-)

diff --git a/src/slon/local_listen.c b/src/slon/local_listen.c
index e10efe7..9290ac5 100644
--- a/src/slon/local_listen.c
+++ b/src/slon/local_listen.c
@@ -77,6 +77,10 @@ localListenThread_main(/* @unused@ */ void *dummy)
 				 dstring_data(&query1), PQresultErrorMessage(res));
 		PQclear(res);
 		dstring_free(&query1);
+		pthread_mutex_lock(&slon_wait_listen_lock);
+		slon_listen_started=0;
+		pthread_cond_signal(&slon_wait_listen_cond);
+		pthread_mutex_unlock(&slon_wait_listen_lock);
 		slon_retry();
 	}
 	PQclear(res);
@@ -107,6 +111,10 @@ localListenThread_main(/* @unused@ */ void *dummy)
 		    
 		PQclear(res);
 		dstring_free(&query1);
+		pthread_mutex_lock(&slon_wait_listen_lock);
+		slon_listen_started=0;
+		pthread_cond_signal(&slon_wait_listen_cond);
+		pthread_mutex_unlock(&slon_wait_listen_lock);
 		slon_abort();
 	}
 	PQclear(res);
@@ -116,6 +124,7 @@ localListenThread_main(/* @unused@ */ void *dummy)
 	 * other threads.
 	 */
 	pthread_mutex_lock(&slon_wait_listen_lock);
+	slon_listen_started=1;
 	pthread_cond_signal(&slon_wait_listen_cond);
 	pthread_mutex_unlock(&slon_wait_listen_lock);
 
diff --git a/src/slon/slon.c b/src/slon/slon.c
index 627de17..de05635 100644
--- a/src/slon/slon.c
+++ b/src/slon/slon.c
@@ -53,6 +53,7 @@ int			sched_wakeuppipe[2];
 
 pthread_mutex_t slon_wait_listen_lock;
 pthread_cond_t slon_wait_listen_cond;
+int            slon_listen_started=0;
 
 /* ---------- 
  * Local data 
@@ -695,6 +696,14 @@ SlonMain(void)
 		slon_retry();
 	}
 	pthread_cond_wait(&slon_wait_listen_cond, &slon_wait_listen_lock);
+	if(!slon_listen_started)
+	{
+		/**
+		 * The local listen thread did not start up properly.
+		 */
+		slon_log(SLON_FATAL,"main: localListenThread did not start\n");
+		slon_abort();
+	}
 	pthread_mutex_unlock(&slon_wait_listen_lock);
 
 	/*
diff --git a/src/slon/slon.h b/src/slon/slon.h
index b6e509a..57c1bf1 100644
--- a/src/slon/slon.h
+++ b/src/slon/slon.h
@@ -419,7 +419,7 @@ extern void Usage(char *const argv[]);
 extern int	sched_wakeuppipe[];
 extern pthread_mutex_t slon_wait_listen_lock;
 extern pthread_cond_t slon_wait_listen_cond;
-
+extern int slon_listen_started;
 
 /* ----------
  * Functions in runtime_config.c
-- 
1.6.3.3


--------------010805010706030806040109--

From cbbrowne at ca.afilias.info  Fri Jul 16 08:21:02 2010
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Fri, 16 Jul 2010 11:21:02 -0400
Subject: [Slony1-patches] Patch for .gitignore
Message-ID: <87wrsv78rl.fsf@cbbrowne.afilias-int.info>

A non-text attachment was scrubbed...
Name: gitignore.diff
Type: text/x-diff
Size: 12125 bytes
Desc: not available
Url : http://lists.slony.info/pipermail/slony1-patches/attachments/20100716/6382a64d/attachment.diff 

From ssinger at ca.afilias.info  Fri Jul 16 09:02:59 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Fri, 16 Jul 2010 12:02:59 -0400
Subject: [Slony1-patches] Patch for .gitignore
In-Reply-To: <87wrsv78rl.fsf@cbbrowne.afilias-int.info>
References: <87wrsv78rl.fsf@cbbrowne.afilias-int.info>
Message-ID: <4C4082B3.2070801@ca.afilias.info>

Christopher Browne wrote:
> Patch below to do the following:
> 
>     Revise .cvsignore files --> .gitignore
> 
>     In many cases, existing .cvsignore files need only be renamed.
> 
>     In a few cases, new .gitignore files needed to be created as there
>     wasn't a .cvsignore file (e.g. - for doc/adminguide, src/parsestatements).
> 
>     Some were missing material (e.g. - src/slon didn't have enough in it).
> 
> Any objections?

Looks okay to me.
I agree with not keeping configure in source control


> 
> 
> 
> ------------------------------------------------------------------------
> 
> _______________________________________________
> Slony1-patches mailing list
> Slony1-patches at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-patches


-- 
Steve Singer
Afilias Canada
Data Services Developer
416-673-1142

From cbbrowne at ca.afilias.info  Fri Jul 16 13:36:53 2010
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Fri, 16 Jul 2010 16:36:53 -0400
Subject: [Slony1-patches] Removing $Id$ tags from Git
Message-ID: <8739vj6u56.fsf@cbbrowne.afilias-int.info>

A non-text attachment was scrubbed...
Name: removeid.sh
Type: text/x-sh
Size: 168 bytes
Desc: not available
Url : http://lists.slony.info/pipermail/slony1-patches/attachments/20100716/498e6cc2/attachment-0001.sh 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: HEAD-remove-ids.diff
Type: text/x-diff
Size: 86441 bytes
Desc: not available
Url : http://lists.slony.info/pipermail/slony1-patches/attachments/20100716/498e6cc2/attachment-0005.diff 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: 2.0-remove-ids.diff
Type: text/x-diff
Size: 86441 bytes
Desc: not available
Url : http://lists.slony.info/pipermail/slony1-patches/attachments/20100716/498e6cc2/attachment-0006.diff 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: 1.2-remove-ids.diff
Type: text/x-diff
Size: 86441 bytes
Desc: not available
Url : http://lists.slony.info/pipermail/slony1-patches/attachments/20100716/498e6cc2/attachment-0007.diff 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: 1.1-remove-ids.diff
Type: text/x-diff
Size: 86441 bytes
Desc: not available
Url : http://lists.slony.info/pipermail/slony1-patches/attachments/20100716/498e6cc2/attachment-0008.diff 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: 1.0-remove-ids.diff
Type: text/x-diff
Size: 86441 bytes
Desc: not available
Url : http://lists.slony.info/pipermail/slony1-patches/attachments/20100716/498e6cc2/attachment-0009.diff 

From dpage at pgadmin.org  Fri Jul 16 13:46:53 2010
From: dpage at pgadmin.org (Dave Page)
Date: Fri, 16 Jul 2010 21:46:53 +0100
Subject: [Slony1-patches] Removing $Id$ tags from Git
In-Reply-To: <8739vj6u56.fsf@cbbrowne.afilias-int.info>
References: <8739vj6u56.fsf@cbbrowne.afilias-int.info>
Message-ID: <AANLkTin5pja1hRpJEU9kT6oxW6bYAlEL9AyjYYaK2S1s@mail.gmail.com>

2010/7/16 Christopher Browne <cbbrowne at ca.afilias.info>:
> Attached are patches and tooling for removing CVS Id tags.

Thats handy - I was just about to write the same for the pgAdmin repo :-D

Thanks!

-- 
Dave Page
EnterpriseDB UK: http://www.enterprisedb.com
The Enterprise Postgres Company

From ssinger at ca.afilias.info  Mon Jul 19 11:26:01 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Mon, 19 Jul 2010 14:26:01 -0400
Subject: [Slony1-patches] some problem current head for pg91dev
In-Reply-To: <1A513C5BD09440739707BCCB29111FDF@acer08f817a9b5>
References: <1A513C5BD09440739707BCCB29111FDF@acer08f817a9b5>
Message-ID: <4C4498B9.1010205@ca.afilias.info>

Hiroshi Saito wrote:
> Jan-san.
> 
> some strange states now.... Please see,
> http://winpg.jp/~saito/Slony-I/
> 
> I want this to be taken into consideration. thanks.
> 
> P.S)
> Possibly back-patch may be necessity.
> Regards,
> Hiroshi Saito

Thank you for your patch

I have applied your patch to both the master and REL_2_0_STABLE branches.


> 
> 
> ------------------------------------------------------------------------
> 
> _______________________________________________
> Slony1-patches mailing list
> Slony1-patches at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-patches


-- 
Steve Singer
Afilias Canada
Data Services Developer
416-673-1142

From z-saito at guitar.ocn.ne.jp  Thu Jul 22 08:29:34 2010
From: z-saito at guitar.ocn.ne.jp (Hiroshi Saito)
Date: Fri, 23 Jul 2010 00:29:34 +0900
Subject: [Slony1-patches] some problem current head for pg91dev
References: <1A513C5BD09440739707BCCB29111FDF@acer08f817a9b5>
	<4C4498B9.1010205@ca.afilias.info>
Message-ID: <20306D68ECA648C08D31613244C4D2CD@acer08f817a9b5>

Hi Steve-san.

Oh, sorry,thanks!!

Regards,
Hiroshi Saito

----- Original Message ----- 
From: "Steve Singer" <ssinger at ca.afilias.info>

(snip)
> 
> Thank you for your patch
> 
> I have applied your patch to both the master and REL_2_0_STABLE branches.


From ssinger at ca.afilias.info  Tue Jul 27 08:37:04 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Tue, 27 Jul 2010 11:37:04 -0400
Subject: [Slony1-patches] bug 118 patch
In-Reply-To: <4C2B4C5E.3050902@ca.afilias.info>
References: <4C2B4C5E.3050902@ca.afilias.info>
Message-ID: <4C4EFD20.1080909@ca.afilias.info>

Steve Singer wrote:

This is a version of the bug118 patch for the 1.2 branch.

Do we want to backport this bug to 1.2?

(I'm thinking we do)



> Attached is a patch that fixes bug 118 by performing a TRUNCATE ONLY 
> during the pre-subscription on 8.4 systems.
> 
> 
> 
> 
> 
> ------------------------------------------------------------------------
> 
> _______________________________________________
> Slony1-patches mailing list
> Slony1-patches at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-patches


-- 
Steve Singer
Afilias Canada
Data Services Developer
416-673-1142
-------------- next part --------------
A non-text attachment was scrubbed...
Name: 0001-This-fixes-bug-118-subscribing-to-a-set-with-an-inhe.patch
Type: text/x-patch
Size: 0 bytes
Desc: not available
Url : http://lists.slony.info/pipermail/slony1-patches/attachments/20100727/df5626e9/attachment.bin 

From ssinger at ca.afilias.info  Tue Jul 27 08:32:04 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Tue, 27 Jul 2010 11:32:04 -0400
Subject: [PATCH]     This fixes bug # 118 - subscribing to a set with an inherited
     table  where the inheriting table has a lower tab_id than the
     parent table deletes all of the data in the parent table
Message-ID: <mailman.7.1280245027.4684.slony1-patches@lists.slony.info>

    Merged from REL_2_0_STABLE added support for more pg versions +
    accounted for that prepareTableForCopy is in the version specific file

   - add_empty_table_to_replication will call TruncateOnlyTable instead of 'truncate' This is the behaviour this function would want.
   -adding support for v84 specific behaviour + listing 9.0 as supported.
---
 src/backend/slony1_funcs.sql     |    3 +-
 src/backend/slony1_funcs.v73.sql |   13 ++++
 src/backend/slony1_funcs.v74.sql |   14 ++++
 src/backend/slony1_funcs.v80.sql |   16 ++++-
 src/backend/slony1_funcs.v81.sql |   17 ++++-
 src/backend/slony1_funcs.v84.sql |  149 ++++++++++++++++++++++++++++++++++++++
 src/slonik/slonik.c              |   36 ++++++----
 7 files changed, 231 insertions(+), 17 deletions(-)
 create mode 100644 src/backend/slony1_funcs.v84.sql

diff --git a/src/backend/slony1_funcs.sql b/src/backend/slony1_funcs.sql
index 32b44aa..59d95f8 100644
--- a/src/backend/slony1_funcs.sql
+++ b/src/backend/slony1_funcs.sql
@@ -6092,8 +6092,7 @@ begin
 	end if;
    else
 	-- On other nodes, TRUNCATE the table
-        v_query := ''truncate '' || v_fqname || '';'';
-	execute v_query;
+		perform @NAMESPACE at .TruncateOnlyTable(v_fqname);
    end if;
 -- If p_idxname is NULL, then look up the PK index, and RAISE EXCEPTION if one does not exist
    if p_idxname is NULL then
diff --git a/src/backend/slony1_funcs.v73.sql b/src/backend/slony1_funcs.v73.sql
index 80e9366..36ec2cf 100644
--- a/src/backend/slony1_funcs.v73.sql
+++ b/src/backend/slony1_funcs.v73.sql
@@ -111,3 +111,16 @@ create or replace function @NAMESPACE at .make_function_strict (text, text) returns
 
 comment on function @NAMESPACE at .make_function_strict (text, text) is
 'Equivalent to 8.1+ ALTER FUNCTION ... STRICT';
+
+
+create or replace function @NAMESPACE at .TruncateOnlyTable ( name) returns void as
+$$
+begin
+	execute 'truncate '|| @NAMESPACE at .slon_quote_input($1);
+end;
+$$
+LANGUAGE plpgsql;
+
+
+comment on function @NAMESPACE at .TruncateOnlyTable(name) is
+'Calls TRUNCATE with out specifying ONLY, syntax supported in versions 8.3 and below';
\ No newline at end of file
diff --git a/src/backend/slony1_funcs.v74.sql b/src/backend/slony1_funcs.v74.sql
index 0ea2d24..e6ee65d 100644
--- a/src/backend/slony1_funcs.v74.sql
+++ b/src/backend/slony1_funcs.v74.sql
@@ -113,3 +113,17 @@ end
 
 comment on function @NAMESPACE at .make_function_strict (text, text) is
 'Equivalent to 8.1+ ALTER FUNCTION ... STRICT';
+
+
+
+create or replace function @NAMESPACE at .TruncateOnlyTable ( name) returns void as
+$$
+begin
+	execute 'truncate '|| @NAMESPACE at .slon_quote_input($1);
+end;
+$$
+LANGUAGE plpgsql;
+
+
+comment on function @NAMESPACE at .TruncateOnlyTable(name) is
+'Calls TRUNCATE with out specifying ONLY, syntax supported in versions 8.3 and below';
\ No newline at end of file
diff --git a/src/backend/slony1_funcs.v80.sql b/src/backend/slony1_funcs.v80.sql
index 064a109..ec623a5 100644
--- a/src/backend/slony1_funcs.v80.sql
+++ b/src/backend/slony1_funcs.v80.sql
@@ -51,7 +51,7 @@ begin
 	-- Try using truncate to empty the table and fallback to
 	-- delete on error.
 	-- ----
-	execute ''truncate '' || @NAMESPACE at .slon_quote_input(v_tab_fqname);
+	perform @NAMESPACE at .TruncateOnlyTable(v_tab_fqname);
 	raise notice ''truncate of % succeeded'', v_tab_fqname;
 	return 1;
 	exception when others then
@@ -126,3 +126,17 @@ end
 
 comment on function @NAMESPACE at .make_function_strict (text, text) is
 'Equivalent to 8.1+ ALTER FUNCTION ... STRICT';
+
+
+
+create or replace function @NAMESPACE at .TruncateOnlyTable ( name) returns void as
+$$
+begin
+	execute 'truncate '|| @NAMESPACE at .slon_quote_input($1);
+end;
+$$
+LANGUAGE plpgsql;
+
+
+comment on function @NAMESPACE at .TruncateOnlyTable(name) is
+'Calls TRUNCATE with out specifying ONLY, syntax supported in versions 8.3 and below';
\ No newline at end of file
diff --git a/src/backend/slony1_funcs.v81.sql b/src/backend/slony1_funcs.v81.sql
index d5ea13e..a5c8cb5 100644
--- a/src/backend/slony1_funcs.v81.sql
+++ b/src/backend/slony1_funcs.v81.sql
@@ -43,7 +43,7 @@ begin
 	-- Try using truncate to empty the table and fallback to
 	-- delete on error.
 	-- ----
-	execute ''truncate '' || @NAMESPACE at .slon_quote_input(v_tab_fqname);
+	perform @NAMESPACE at .TruncateOnlyTable(v_tab_fqname);
 	raise notice ''truncate of % succeeded'', v_tab_fqname;
 
 	-- ----
@@ -131,3 +131,18 @@ end
 
 comment on function @NAMESPACE at .make_function_strict (text, text) is
 'Equivalent to 8.1+ ALTER FUNCTION ... STRICT';
+
+
+
+
+create or replace function @NAMESPACE at .TruncateOnlyTable ( name) returns void as
+$$
+begin
+	execute 'truncate '|| @NAMESPACE at .slon_quote_input($1);
+end;
+$$
+LANGUAGE plpgsql;
+
+
+comment on function @NAMESPACE at .TruncateOnlyTable(name) is
+'Calls TRUNCATE with out specifying ONLY, syntax supported in versions 8.3 and below';
\ No newline at end of file
diff --git a/src/backend/slony1_funcs.v84.sql b/src/backend/slony1_funcs.v84.sql
new file mode 100644
index 0000000..669ed88
--- /dev/null
+++ b/src/backend/slony1_funcs.v84.sql
@@ -0,0 +1,149 @@
+-- ----------------------------------------------------------------------
+-- slony1_funcs.v83.sql
+--
+--    Version 8.3 specific part of the replication support functions.
+--
+--	Copyright (c) 2007-2009, PostgreSQL Global Development Group
+--	Author: Jan Wieck, Afilias USA INC.
+--
+-- $Id: slony1_funcs.v84.sql,v 1.1.2.3 2010-05-17 17:15:19 ssinger Exp $
+-- ----------------------------------------------------------------------
+
+
+-- ----------------------------------------------------------------------
+-- FUNCTION prepareTableForCopy(tab_id)
+--
+--	Remove all content from a table before the subscription
+--	content is loaded via COPY and disable index maintenance.
+-- ----------------------------------------------------------------------
+create or replace function @NAMESPACE at .prepareTableForCopy(int4)
+returns int4
+as '
+declare
+	p_tab_id		alias for $1;
+	v_tab_oid		oid;
+	v_tab_fqname	text;
+begin
+	-- ----
+	-- Get the OID and fully qualified name for the table
+	-- ---
+	select	PGC.oid,
+			@NAMESPACE at .slon_quote_brute(PGN.nspname) || ''.'' ||
+			@NAMESPACE at .slon_quote_brute(PGC.relname) as tab_fqname
+		into v_tab_oid, v_tab_fqname
+			from @NAMESPACE at .sl_table T,
+				"pg_catalog".pg_class PGC, "pg_catalog".pg_namespace PGN
+				where T.tab_id = p_tab_id
+				and T.tab_reloid = PGC.oid
+				and PGC.relnamespace = PGN.oid;
+	if not found then
+		raise exception ''Table with ID % not found in sl_table'', p_tab_id;
+	end if;
+
+	-- ----
+	-- Try using truncate to empty the table and fallback to
+	-- delete on error.
+	-- ----
+	perform @NAMESPACE at .TruncateOnlyTable(v_tab_fqname);
+	raise notice ''truncate of % succeeded'', v_tab_fqname;
+
+	-- ----
+	-- Setting pg_class.relhasindex to false will cause copy not to
+	-- maintain any indexes. At the end of the copy we will reenable
+	-- them and reindex the table. This bulk creating of indexes is
+	-- faster.
+	-- ----
+	update pg_class set relhasindex = ''f'' where oid = v_tab_oid;
+
+	return 1;
+	exception when others then
+		raise notice ''truncate of % failed - doing delete'', v_tab_fqname;
+		update pg_class set relhasindex = ''f'' where oid = v_tab_oid;
+		execute ''delete from only '' || @NAMESPACE at .slon_quote_input(v_tab_fqname);
+		return 0;
+end;
+' language plpgsql;
+
+comment on function @NAMESPACE at .prepareTableForCopy(int4) is
+'Delete all data and suppress index maintenance';
+
+-- ----------------------------------------------------------------------
+-- FUNCTION finishTableAfterCopy(tab_id)
+--
+--	Reenable index maintenance and reindex the table after COPY.
+-- ----------------------------------------------------------------------
+create or replace function @NAMESPACE at .finishTableAfterCopy(int4)
+returns int4
+as '
+declare
+	p_tab_id		alias for $1;
+	v_tab_oid		oid;
+	v_tab_fqname	text;
+begin
+	-- ----
+	-- Get the tables OID and fully qualified name
+	-- ---
+	select	PGC.oid,
+			@NAMESPACE at .slon_quote_brute(PGN.nspname) || ''.'' ||
+			@NAMESPACE at .slon_quote_brute(PGC.relname) as tab_fqname
+		into v_tab_oid, v_tab_fqname
+			from @NAMESPACE at .sl_table T,
+				"pg_catalog".pg_class PGC, "pg_catalog".pg_namespace PGN
+				where T.tab_id = p_tab_id
+				and T.tab_reloid = PGC.oid
+				and PGC.relnamespace = PGN.oid;
+	if not found then
+		raise exception ''Table with ID % not found in sl_table'', p_tab_id;
+	end if;
+
+	-- ----
+	-- Reenable indexes and reindex the table.
+	-- ----
+	update pg_class set relhasindex = ''t'' where oid = v_tab_oid;
+	execute ''reindex table '' || @NAMESPACE at .slon_quote_input(v_tab_fqname);
+
+	return 1;
+end;
+' language plpgsql;
+
+comment on function @NAMESPACE at .finishTableAfterCopy(int4) is
+'Reenable index maintenance and reindex the table';
+
+create or replace function @NAMESPACE at .pre74()
+returns integer
+as 'select 0' language sql;
+
+comment on function @NAMESPACE at .pre74() is
+'Returns 1/0 based on whether or not the DB is running a
+version earlier than 7.4';
+
+create or replace function @NAMESPACE at .make_function_strict (text, text) returns void as
+'
+declare
+   fun alias for $1;
+   parms alias for $2;
+   stmt text;
+begin
+   stmt := ''ALTER FUNCTION "_ at CLUSTERNAME@".'' || fun || '' '' || parms || '' STRICT;'';
+   execute stmt;
+   return;
+end
+' language plpgsql;
+
+comment on function @NAMESPACE at .make_function_strict (text, text) is
+'Equivalent to 8.1+ ALTER FUNCTION ... STRICT';
+
+
+
+
+create or replace function @NAMESPACE at .TruncateOnlyTable ( name) returns void as
+$$
+begin
+	execute 'truncate only '|| @NAMESPACE at .slon_quote_input($1);
+end;
+$$
+LANGUAGE plpgsql;
+
+
+comment on function @NAMESPACE at .TruncateOnlyTable(name) is
+'Calls TRUNCATE with out specifying ONLY, syntax supported in versions 8.3 and below';
\ No newline at end of file
diff --git a/src/slonik/slonik.c b/src/slonik/slonik.c
index 8b4bd2d..a1e67b2 100644
--- a/src/slonik/slonik.c
+++ b/src/slonik/slonik.c
@@ -1905,15 +1905,20 @@ load_slony_base(SlonikStmt * stmt, int no_id)
 		use_major = 8;
 		use_minor = 0;
 	}
-	else if ((adminfo->pg_version >= 80100) && adminfo->pg_version < 80500)	/* 8.1, 8.2, 8.3, 8.4 */
+	else if ((adminfo->pg_version >= 80100) && adminfo->pg_version < 80400)	/* 8.1, 8.2, 8.3 */
 	{
 		use_major = 8;
 		use_minor = 1;
 	}
-	else	/* 8.5+ */
+	else if((adminfo->pg_version >= 80400) && adminfo->pg_version < 90100)	/* 8.4+ */
 	{
 		use_major = 8;
-		use_minor = 1;
+		use_minor = 4;
+	}
+	else
+	{
+		use_major=8;
+		use_minor=4;
 		printf("%s:%d: Possible unsupported PostgreSQL "
 			"version (%d) %d.%d, defaulting to 8.1 support\n",
                         stmt->stmt_filename, stmt->stmt_lno, adminfo->pg_version,
@@ -2005,20 +2010,25 @@ load_slony_functions(SlonikStmt * stmt, int no_id)
                 use_major = 8;
                 use_minor = 0;
         }
-       else if ((adminfo->pg_version >= 80100) && adminfo->pg_version < 80300)	/* 8.1 and 8.2 */
+       else if ((adminfo->pg_version >= 80100) && adminfo->pg_version < 80400)	/* 8.1 and 8.2 and 8.3*/
        {
 	       use_major = 8;
 	       use_minor = 1;
        }
-        else    /* 8.3 and above */
-        {
-                use_major = 8;
-                use_minor = 1;
-                printf("%s:%d: Possible unsupported PostgreSQL "
-                        "version %d.%d, defaulting to 8.1 support\n",
-                        stmt->stmt_filename, stmt->stmt_lno,
-                        (adminfo->pg_version/10000), ((adminfo->pg_version%10000)/100));
-        }
+	   else if  ((adminfo->pg_version >= 80400) && adminfo->pg_version < 90100)    /* 8.4 and above */
+	   {
+		   use_major = 8;
+		   use_minor = 4;
+	   }
+	   else
+	   {
+		   use_major=8;
+		   use_minor=4;
+		   printf("%s:%d: Possible unsupported PostgreSQL "
+				  "version %d.%d, defaulting to 8.1 support\n",
+				  stmt->stmt_filename, stmt->stmt_lno,
+				  (adminfo->pg_version/10000), ((adminfo->pg_version%10000)/100));
+	   }
 
 	/* Load schema, DB version specific */
 	db_notice_silent = true;
-- 
1.6.3.3


--------------090901080308090608060503--

From ssinger at ca.afilias.info  Tue Jul 27 08:57:12 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Tue, 27 Jul 2010 11:57:12 -0400
Subject: [Slony1-patches] bug 122
Message-ID: <4C4F01D8.5010808@ca.afilias.info>


Attached is a patch for bug 122.
Any objections to applying it?



-- 
Steve Singer
Afilias Canada
Data Services Developer
416-673-1142
-------------- next part --------------
A non-text attachment was scrubbed...
Name: 0001-Fix-for-bug-122.patch
Type: text/x-patch
Size: 0 bytes
Desc: not available
Url : http://lists.slony.info/pipermail/slony1-patches/attachments/20100727/577446a1/attachment.bin 

From ssinger at ca.afilias.info  Mon Jul 19 08:51:48 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Mon, 19 Jul 2010 11:51:48 -0400
Subject: [PATCH] Fix for bug # 122
Message-ID: <mailman.8.1280246235.4684.slony1-patches@lists.slony.info>

Print a better error message when using a receiver node id that does not exist
---
 src/backend/slony1_funcs.sql |    8 ++++++++
 1 files changed, 8 insertions(+), 0 deletions(-)

diff --git a/src/backend/slony1_funcs.sql b/src/backend/slony1_funcs.sql
index 625c50c..3e33c97 100644
--- a/src/backend/slony1_funcs.sql
+++ b/src/backend/slony1_funcs.sql
@@ -4131,6 +4131,14 @@ begin
 		raise exception 'Slony-I: subscribeSet() must be called on provider';
 	end if;
 
+	--
+	-- Check that the receiver exists
+	--
+	if not exists (select no_id from @NAMESPACE at .sl_node where no_id=
+	       	      p_sub_receiver) then
+		      raise exception 'Slony-I: subscribeSet() the receiver does not exist';
+	end if;
+
 	-- ----
 	-- Check that the origin and provider of the set are remote
 	-- ----
-- 
1.6.3.3


--------------090809050801030305010704--

From ssinger at ca.afilias.info  Thu Jul 29 12:04:25 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Thu, 29 Jul 2010 15:04:25 -0400
Subject: [PATCH 1/4] If a origin node fails a subscriber might
 not be listening for events from the new origin. The FAILOVER event gets
 processed on the subscriber but nothing after might be since the
 sl_listen rows are setup so all events from the new origin get routed
 through the node that used to be the provider(even if a direct
 path from the new origin to the subscriber exists).
Message-ID: <mailman.12.1281365715.4684.slony1-patches@lists.slony.info>

On processing the FAILOVER event we will mark the old origin as no
inactive.  RebuildListenEntries will now not remove paths that are
dedundent if the (otherwise) preferred path flows through a disabled
node.
---
 src/backend/slony1_funcs.sql |   11 +++++++++--
 1 files changed, 9 insertions(+), 2 deletions(-)

diff --git a/src/backend/slony1_funcs.sql b/src/backend/slony1_funcs.sql
index 2e782a6..ce2edf5 100644
--- a/src/backend/slony1_funcs.sql
+++ b/src/backend/slony1_funcs.sql
@@ -1400,6 +1400,10 @@ begin
 				where set_id = p_set_id;
 	end if;
 
+	update @NAMESPACE at .sl_node
+		   set no_active=false WHERE 
+		   no_id=p_failed_node;
+
 	-- Rewrite sl_listen table
 	perform @NAMESPACE at .RebuildListenEntries();
 
@@ -4913,12 +4917,15 @@ begin
 		-- If we use the event origin as a data provider for any
 		-- set that originates on that very node, we are a direct
 		-- subscriber to that origin and listen there only.
-		if exists (select true from @NAMESPACE at .sl_set, @NAMESPACE at .sl_subscribe
+		if exists (select true from @NAMESPACE at .sl_set, @NAMESPACE at .sl_subscribe				, @NAMESPACE at .sl_node p		   		
 				where set_origin = v_row.origin
 				  and sub_set = set_id
 				  and sub_provider = v_row.origin
 				  and sub_receiver = v_row.receiver
-				  and sub_active)
+				  and sub_active
+				  and p.no_active
+				  and p.no_id=sub_provider
+				  )
 		then
 			delete from @NAMESPACE at .sl_listen
 				where li_origin = v_row.origin
-- 
1.6.3.3


--------------020106060301020405000608
Content-Type: text/x-patch;
 name="0003-When-doing-a-fail-node-where-the-failed-node-is-not-.patch"
Content-Transfer-Encoding: 7bit
Content-Disposition: inline;
 filename*0="0003-When-doing-a-fail-node-where-the-failed-node-is-not-.pa";
 filename*1="tch"


From ssinger at ca.afilias.info  Fri Jul 30 12:55:17 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Fri, 30 Jul 2010 15:55:17 -0400
Subject: [PATCH 3/4] When doing a fail node where the failed node is not a provider of the backup node
 we need to delete any subscribe entries that are used to forward data to the backup
 node.  These will not be needed when the backup node becomes the new origin.
 Until that happens they get in the way of the FAILOVER_SET message
 that will be posted on the 'most ahead node' but iwth an origin of
 the old origin from getting to this node.
Message-ID: <mailman.13.1281365715.4684.slony1-patches@lists.slony.info>

---
 src/backend/slony1_funcs.sql |    4 ++++
 1 files changed, 4 insertions(+), 0 deletions(-)

diff --git a/src/backend/slony1_funcs.sql b/src/backend/slony1_funcs.sql
index 8dcaf03..8c77c8d 100644
--- a/src/backend/slony1_funcs.sql
+++ b/src/backend/slony1_funcs.sql
@@ -1277,8 +1277,12 @@ begin
 								where pa_server = p_backup_node
 								  and pa_client = @NAMESPACE at .sl_subscribe.sub_receiver
 						);
+			delete from @NAMESPACE at .sl_subscribe
+					where sub_set = v_row.set_id
+						and sub_receiver = p_backup_node;				
 		end if;
 	end loop;
+	
 
 	-- Rewrite sl_listen table
 	perform @NAMESPACE at .RebuildListenEntries();
-- 
1.6.3.3


--------------020106060301020405000608
Content-Type: text/x-patch;
 name="0004-Bug-136.patch"
Content-Transfer-Encoding: 7bit
Content-Disposition: inline;
 filename="0004-Bug-136.patch"


