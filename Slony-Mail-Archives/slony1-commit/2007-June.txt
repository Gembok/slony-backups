From devrim at lists.slony.info  Sun Jun  3 02:01:13 2007
From: devrim at lists.slony.info (Devrim GUNDUZ)
Date: Sun Jun  3 02:01:15 2007
Subject: [Slony1-commit] slony1-engine postgresql-slony1-engine.spec.in
Message-ID: <20070603090113.B922E290C0F@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine
In directory main.slony.info:/tmp/cvs-serv5097

Modified Files:
      Tag: REL_1_2_STABLE
	postgresql-slony1-engine.spec.in 
Log Message:
(Updated changelog for the following)
- Install init script with rpm.
- Fix --with-pgconfigdir parameter.



Index: postgresql-slony1-engine.spec.in
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/postgresql-slony1-engine.spec.in,v
retrieving revision 1.31.2.11
retrieving revision 1.31.2.12
diff -C2 -d -r1.31.2.11 -r1.31.2.12
*** postgresql-slony1-engine.spec.in	28 May 2007 14:05:03 -0000	1.31.2.11
--- postgresql-slony1-engine.spec.in	3 Jun 2007 09:01:11 -0000	1.31.2.12
***************
*** 151,154 ****
--- 151,156 ----
  %changelog
  * Thu May 17 2007 Devrim Gunduz <devrim@CommandPrompt.com>
+ - Install init script with rpm.
+ - Fix --with-pgconfigdir parameter.
  - Fix rpm build problem when the system has pg_config in both under
    /usr/local/pgsql/bin and /usr/bin

From devrim at lists.slony.info  Sun Jun  3 02:35:06 2007
From: devrim at lists.slony.info (Devrim GUNDUZ)
Date: Sun Jun  3 02:35:07 2007
Subject: [Slony1-commit] slony1-engine postgresql-slony1-engine.spec.in
Message-ID: <20070603093506.86C52290BFF@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine
In directory main.slony.info:/tmp/cvs-serv5307

Modified Files:
      Tag: REL_1_2_STABLE
	postgresql-slony1-engine.spec.in 
Log Message:
Copy-paste from test environment is considered harmful


Index: postgresql-slony1-engine.spec.in
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/postgresql-slony1-engine.spec.in,v
retrieving revision 1.31.2.12
retrieving revision 1.31.2.13
diff -C2 -d -r1.31.2.12 -r1.31.2.13
*** postgresql-slony1-engine.spec.in	3 Jun 2007 09:01:11 -0000	1.31.2.12
--- postgresql-slony1-engine.spec.in	3 Jun 2007 09:35:04 -0000	1.31.2.13
***************
*** 115,119 ****
  
  %post
! chkconfig --add pypgreplicate
  
  %preun
--- 115,119 ----
  
  %post
! chkconfig --add slon
  
  %preun

From wieck at lists.slony.info  Mon Jun  4 15:51:21 2007
From: wieck at lists.slony.info (Jan Wieck)
Date: Mon Jun  4 15:51:22 2007
Subject: [Slony1-commit] slony1-engine/src/slonik slonik.c
Message-ID: <20070604225121.C3521290C25@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slonik
In directory main.slony.info:/tmp/cvs-serv31948/src/slonik

Modified Files:
      Tag: REL_1_2_STABLE
	slonik.c 
Log Message:
Fixed EXECUTE SCRIPT with respect to WAIT FOR EVENT. It will
now record the scripts event seqno inside of slonik's conninfo
state so that WAIT FOR EVENT will wait for the right seqno.

Jan


Index: slonik.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slonik/slonik.c,v
retrieving revision 1.67.2.9
retrieving revision 1.67.2.10
diff -C2 -d -r1.67.2.9 -r1.67.2.10
*** slonik.c	15 May 2007 16:56:37 -0000	1.67.2.9
--- slonik.c	4 Jun 2007 22:51:19 -0000	1.67.2.10
***************
*** 3935,3970 ****
  			printf("DDL Statement failed - %s\n", PQresStatus(rstat));
  			dstring_free(&query);
  			return -1;
  		}
  		/* rstat = PQresultStatus(res); */
  		/* printf ("Success - %s\n", PQresStatus(rstat)); */
  	}
  	
! 		printf("Complete DDL Event...\n");
! 		
! 		slon_mkquery(&query, "select \"_%s\".ddlScript_complete(%d, $1::text, %d); ", 
! 					 stmt->hdr.script->clustername,
! 					 stmt->ddl_setid,  
! 					 stmt->only_on_node);
! 		
! 		paramlens[PARMCOUNT-1] = 0;
! 		paramfmts[PARMCOUNT-1] = 0;
! 		params[PARMCOUNT-1] = dstring_data(&script);
! 		
! 		res = PQexecParams(adminfo1->dbconn, dstring_data(&query), PARMCOUNT,
! 						   NULL, params, paramlens, paramfmts, 0);
! 		
! 		if (PQresultStatus(res) != PGRES_COMMAND_OK && 
! 			PQresultStatus(res) != PGRES_TUPLES_OK &&
! 			PQresultStatus(res) != PGRES_EMPTY_QUERY)
! 			{
! 				rstat = PQresultStatus(res);
! 				printf("Event submission for DDL failed - %s\n", PQresStatus(rstat));
! 				dstring_free(&query);
! 				return -1;
! 			} else {
! 				rstat = PQresultStatus(res);
! 				printf ("DDL submission to initial node - %s\n", PQresStatus(rstat));
! 			}
  	dstring_free(&script);
  	dstring_free(&query);
--- 3935,3991 ----
  			printf("DDL Statement failed - %s\n", PQresStatus(rstat));
  			dstring_free(&query);
+ 			PQclear(res);
  			return -1;
  		}
  		/* rstat = PQresultStatus(res); */
  		/* printf ("Success - %s\n", PQresStatus(rstat)); */
+ 
+ 		PQclear(res);
  	}
  	
! 	printf("Complete DDL Event...\n");
! 	
! 	slon_mkquery(&query, "select \"_%s\".ddlScript_complete(%d, $1::text, %d); ", 
! 				 stmt->hdr.script->clustername,
! 				 stmt->ddl_setid,  
! 				 stmt->only_on_node);
! 	
! 	paramlens[PARMCOUNT-1] = 0;
! 	paramfmts[PARMCOUNT-1] = 0;
! 	params[PARMCOUNT-1] = dstring_data(&script);
! 	
! 	res = PQexecParams(adminfo1->dbconn, dstring_data(&query), PARMCOUNT,
! 					   NULL, params, paramlens, paramfmts, 0);
! 	
! 	/*
! 	 * Check that the event submission returned exactly one result row
! 	 */
! 	if (PQresultStatus(res) != PGRES_TUPLES_OK)
! 	{
! 		rstat = PQresultStatus(res);
! 		printf("Event submission for DDL failed - %s\n", PQresStatus(rstat));
! 		dstring_free(&script);
! 		dstring_free(&query);
! 		PQclear(res);
! 		return -1;
! 	}
! 	if (PQntuples(res) != 1)
! 	{
! 		printf("Event submission for DDL failed - query returned %d rows (expected 1)\n", PQntuples(res));
! 		dstring_free(&script);
! 		dstring_free(&query);
! 		PQclear(res);
! 		return -1;
! 	}
! 
! 	/*
! 	 * ... which should be the event-seqno for the DDL_SCRIPT event.
! 	 * We remember that in the admin conninfo for WAIT.
! 	 */
! 	slon_scanint64(PQgetvalue(res, 0, 0), &(adminfo1->last_event));
! 
! 	rstat = PQresultStatus(res);
! 	PQclear(res);
! 	printf ("DDL submission to initial node - %s\n", PQresStatus(rstat));
  	dstring_free(&script);
  	dstring_free(&query);

From wieck at lists.slony.info  Mon Jun  4 15:51:21 2007
From: wieck at lists.slony.info (Jan Wieck)
Date: Mon Jun  4 15:51:23 2007
Subject: [Slony1-commit] slony1-engine/src/ducttape test_5_ddlscript
	test_5_pgbench.in
Message-ID: <20070604225121.B818C290C24@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/ducttape
In directory main.slony.info:/tmp/cvs-serv31948/src/ducttape

Modified Files:
      Tag: REL_1_2_STABLE
	test_5_ddlscript test_5_pgbench.in 
Log Message:
Fixed EXECUTE SCRIPT with respect to WAIT FOR EVENT. It will
now record the scripts event seqno inside of slonik's conninfo
state so that WAIT FOR EVENT will wait for the right seqno.

Jan


Index: test_5_pgbench.in
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/ducttape/test_5_pgbench.in,v
retrieving revision 1.2
retrieving revision 1.2.2.1
diff -C2 -d -r1.2 -r1.2.2.1
*** test_5_pgbench.in	1 Jun 2006 12:35:52 -0000	1.2
--- test_5_pgbench.in	4 Jun 2007 22:51:19 -0000	1.2.2.1
***************
*** 265,275 ****
  done
  echo "**** pgbench finished"
! echo "**** please terminate the replication engines when caught up."
! wait $slon1_pid
! wait $slon2_pid
  
  kill $pgbench_pid 2>/dev/null
- kill $slon1_pid 2>/dev/null
- kill $slon2_pid 2>/dev/null
  
  echo -n "**** comparing databases ... "
--- 265,286 ----
  done
  echo "**** pgbench finished"
! sleep 1
! 
! slonik <<_EOF_
! 	cluster name = T1;
! 	node 1 admin conninfo = 'dbname=$DB1';
! 	node 2 admin conninfo = 'dbname=$DB2';
! 
! 	echo '**** Issuing slonik SYNC against DB1';
! 	sync (id = 1);
! 
! 	echo '**** Waiting for DB2 to catch up';
! 	wait for event (origin = 1, confirmed = 2, wait on = 1);
! _EOF_
! 
! 
! echo "**** you can terminate the replication engines."
  
  kill $pgbench_pid 2>/dev/null
  
  echo -n "**** comparing databases ... "

Index: test_5_ddlscript
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/ducttape/test_5_ddlscript,v
retrieving revision 1.2
retrieving revision 1.2.6.1
diff -C2 -d -r1.2 -r1.2.6.1
*** test_5_ddlscript	18 Jun 2004 20:22:01 -0000	1.2
--- test_5_ddlscript	4 Jun 2007 22:51:19 -0000	1.2.6.1
***************
*** 82,88 ****
--- 82,98 ----
  
  	try {
+ 		echo '  execute script';
  		execute script (set id = 1, filename = 'test_5_tmp.sql',
  			event node = 1);
+ 	}
+ 	on error {
+ 		exit 1;
+ 	}
+ 
+ 	echo '  wait for execute script';
+ 	wait for event (origin = 1, confirmed = 2);
  
+ 	try {
+ 		echo '  create temporary set 999';
  		create set (id = 999, origin = 1, comment = 'temp set for new objects');
  
***************
*** 99,102 ****
--- 109,116 ----
  		exit 1;
  	}
+ 
+ 	echo '  wait for create set &co';
+ 	wait for event (origin = 1, confirmed = all, wait on = 1);
+ 	echo '  temporary set 999 ready for subscription';
  _EOF_
  

From cbbrowne at lists.slony.info  Tue Jun  5 07:38:08 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Jun  5 07:38:09 2007
Subject: [Slony1-commit] slony1-engine/tests/testlogship README exec_ddl.sh
Message-ID: <20070605143808.33367290BD2@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/tests/testlogship
In directory main.slony.info:/tmp/cvs-serv3262

Modified Files:
      Tag: REL_1_2_STABLE
	README exec_ddl.sh 
Log Message:
Add a series of STORE TRIGGER requests so as to hopefully have multiple
non-SYNC events in a row to test


Index: README
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tests/testlogship/README,v
retrieving revision 1.1.2.2
retrieving revision 1.1.2.3
diff -C2 -d -r1.1.2.2 -r1.1.2.3
*** README	20 Apr 2007 21:40:02 -0000	1.1.2.2
--- README	5 Jun 2007 14:38:06 -0000	1.1.2.3
***************
*** 28,30 ****
  table 4, adding two new columns, one to be populated via a default,
  for new tuples; the other has no default, but we assign the value 42
! to all tuples existing at the time that the DDL script runs.
\ No newline at end of file
--- 28,34 ----
  table 4, adding two new columns, one to be populated via a default,
  for new tuples; the other has no default, but we assign the value 42
! to all tuples existing at the time that the DDL script runs.
! 
! Surrounding that DDL script are several STORE TRIGGER requests in
! order to try to ensure that we have a series of non-SYNC events in a
! row.

Index: exec_ddl.sh
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tests/testlogship/exec_ddl.sh,v
retrieving revision 1.1.2.1
retrieving revision 1.1.2.2
diff -C2 -d -r1.1.2.1 -r1.1.2.2
*** exec_ddl.sh	20 Apr 2007 21:40:02 -0000	1.1.2.1
--- exec_ddl.sh	5 Jun 2007 14:38:06 -0000	1.1.2.2
***************
*** 1,4 ****
--- 1,7 ----
  testname=$1
  echo "
+   store trigger (table id=1, trigger name='nonexistant trigger', event node=1);
+   store trigger (table id=1, trigger name='another nonexistant trigger', event node=1);
+   store trigger (table id=1, trigger name='still another nonexistant trigger', event node=1);
    EXECUTE SCRIPT (
         SET ID = 1,
***************
*** 6,8 ****
--- 9,13 ----
         EVENT NODE = 1
      );
+   store trigger (table id=1, trigger name='late, another nonexistant trigger', event node=1);
+   store trigger (table id=1, trigger name='late, still another nonexistant trigger', event node=1);
  "

From cbbrowne at lists.slony.info  Tue Jun  5 09:14:56 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Jun  5 09:14:59 2007
Subject: [Slony1-commit] slony1-engine RELEASE configure
Message-ID: <20070605161458.453D1290C00@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine
In directory main.slony.info:/tmp/cvs-serv3864

Modified Files:
      Tag: REL_1_2_STABLE
	RELEASE configure 
Log Message:
1.  Add additional items Jan modified to RELEASE notes

2.  Update configure after an autoconf run



Index: RELEASE
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/RELEASE,v
retrieving revision 1.1.2.1
retrieving revision 1.1.2.2
diff -C2 -d -r1.1.2.1 -r1.1.2.2
*** RELEASE	28 May 2007 20:12:46 -0000	1.1.2.1
--- RELEASE	5 Jun 2007 16:14:54 -0000	1.1.2.2
***************
*** 21,29 ****
    PG_GETARG_VARLENA(0)
  
- 
  - Slonik's SYNC command never recorded the new seqno in the admin
    conninfo, with potential wacky results for WAIT FOR EVENT
  
- 
  - Fix rpm build problem when the system has pg_config in both under
    /usr/local/pgsql/bin and /usr/bin
--- 21,27 ----
***************
*** 31,34 ****
--- 29,42 ----
  - Add init script for Red Hat / Fedora
  
+ - Fix archive log ship tracking. Slon now tracks the setsync status in
+   memory and generates a void archive with the correct old,new event
+   seqno for all events.
+ 
+ - EXECUTE SCRIPT wasn't setting sl_setsync, which broke WAIT FOR EVENT
+   on these events
+ 
+ - Ducttape test #5 (which performs DDL changes) augmented to test use
+   of WAIT FOR EVENT
+ 
  RELEASE 1.2.9
  

Index: configure
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/configure,v
retrieving revision 1.70.2.5
retrieving revision 1.70.2.6
diff -C2 -d -r1.70.2.5 -r1.70.2.6
*** configure	31 May 2007 13:29:47 -0000	1.70.2.5
--- configure	5 Jun 2007 16:14:54 -0000	1.70.2.6
***************
*** 1,7 ****
  #! /bin/sh
  # Guess values for system-dependent variables and create Makefiles.
! # Generated by GNU Autoconf 2.59 for postgresql-slony1-engine 1.2.STABLE.
  #
! # Copyright (C) 2003 Free Software Foundation, Inc.
  # This configure script is free software; the Free Software Foundation
  # gives unlimited permission to copy, distribute and modify it.
--- 1,8 ----
  #! /bin/sh
  # Guess values for system-dependent variables and create Makefiles.
[...17498 lines suppressed...]
        { echo "$as_me:$LINENO: $ac_file is unchanged" >&5
  echo "$as_me: $ac_file is unchanged" >&6;}
      else
        rm -f $ac_file
!       mv "$tmp/config.h" $ac_file
      fi
    else
!     echo "/* $configure_input  */"
!     cat "$ac_result"
    fi
!   rm -f "$tmp/out12"
!  ;;
! 
! 
!   esac
! 
! done # for ac_tag
  
  
  { (exit 0); exit 0; }

From cbbrowne at lists.slony.info  Tue Jun  5 09:23:37 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Jun  5 09:23:39 2007
Subject: [Slony1-commit] slony1-www/content news.txt
Message-ID: <20070605162337.A56A82903FE@main.slony.info>

Update of /home/cvsd/slony1/slony1-www/content
In directory main.slony.info:/tmp/cvs-serv4064

Modified Files:
	news.txt 
Log Message:
1.2.10 nearly ready for release


Index: news.txt
===================================================================
RCS file: /home/cvsd/slony1/slony1-www/content/news.txt,v
retrieving revision 1.17
retrieving revision 1.18
diff -C2 -d -r1.17 -r1.18
*** news.txt	2 May 2007 21:44:05 -0000	1.17
--- news.txt	5 Jun 2007 16:23:35 -0000	1.18
***************
*** 16,19 ****
--- 16,79 ----
  Here are <a href="http://winpg.jp/~saito/Slony-I-sample/">sample configuration files</a> for the usage of Slony-I 1.2.9 on Windows.
  ---
+ Slony-I Release approaching readiness - 1.2.10
+ http://main.slony.info/downloads/1.2
+ 2007-06-05
+ Chris Browne
+ 
+ Here are the release notes as they stand now; with Jan's commits over
+ the last day, it looks like we have everything committed to resolve
+ issues with EXECUTE SCRIPT and log shipping.
+ 
+ <P> I'll be doing some testing on my "platforms of interest" over the next
+ couple of days; if others can run tests they care about, that would be
+ a great thing.
+ 
+ <P> I plan to tag and release 1.2.10 by the end of the week; the hope is
+ that this will be the final version in the 1.2 branch, as work now
+ progresses on an 8.3-oriented "2.0" branch on HEAD.
+ 
+ -- chris
+ 
+ <h2>RELEASE 1.2.10</h2>
+ 
+ <ol>
+ <li>Fixed problem with EXECUTE SCRIPT (EXECUTE ONLY ON = <node>)
+ 
+   <P> The script was being executed on too many nodes...
+ 
+ <li> Added a test script for log shipping
+ 
+   <P> ... And alter it to add invocation of a DDL script.  This
+   allows testing for an event-counting problem in log shipping.
+ 
+ <li> Changes to support PostgreSQL 8.3 as VARATT_SIZEP has been deprecated
+ 
+ <li> in xxid.c, changes to support PostgreSQL 8.3 as tuple compression has
+   more extensive support
+ 
+ <P>  <tt>VARDATA_ANY(PG_DETOAST_DATUM_PACKED((PG_GETARG_DATUM(0))))</tt>
+   tends to replace
+   <tt>PG_GETARG_VARLENA(0)</tt>
+ 
+ <li> Slonik's SYNC command never recorded the new seqno in the admin
+   conninfo, with potential wacky results for WAIT FOR EVENT
+ 
+ <li> Fix rpm build problem when the system has pg_config in both under
+   /usr/local/pgsql/bin and /usr/bin
+ 
+ <li> Add init script for Red Hat / Fedora
+ 
+ <li> Fix archive log ship tracking. Slon now tracks the setsync status in
+   memory and generates a void archive with the correct old,new event
+   seqno for all events.
+ 
+ <li> EXECUTE SCRIPT wasn't setting sl_setsync, which broke WAIT FOR EVENT
+   on these events
+ 
+ <li> Ducttape test #5 (which performs DDL changes) augmented to test use
+   of WAIT FOR EVENT
+ 
+ </ol>
+ ---
  Slony-I Release - 1.2.9
  http://main.slony.info/downloads/1.2

From xfade at lists.slony.info  Tue Jun  5 09:40:00 2007
From: xfade at lists.slony.info (Niels Breet)
Date: Tue Jun  5 09:40:02 2007
Subject: [Slony1-commit] slony1-www/content news.txt
Message-ID: <20070605164001.07E27290BD2@main.slony.info>

Update of /home/cvsd/slony1/slony1-www/content
In directory main.slony.info:/tmp/cvs-serv4219

Modified Files:
	news.txt 
Log Message:
<tt> kills the layout when using superlongwordswithoutspaces. Just added some spaces for now, needs a CSS fix to fix it permanently.

Index: news.txt
===================================================================
RCS file: /home/cvsd/slony1/slony1-www/content/news.txt,v
retrieving revision 1.18
retrieving revision 1.19
diff -C2 -d -r1.18 -r1.19
*** news.txt	5 Jun 2007 16:23:35 -0000	1.18
--- news.txt	5 Jun 2007 16:39:58 -0000	1.19
***************
*** 52,56 ****
    more extensive support
  
! <P>  <tt>VARDATA_ANY(PG_DETOAST_DATUM_PACKED((PG_GETARG_DATUM(0))))</tt>
    tends to replace
    <tt>PG_GETARG_VARLENA(0)</tt>
--- 52,56 ----
    more extensive support
  
! <P>  <tt>VARDATA_ANY( PG_DETOAST_DATUM_PACKED( (PG_GETARG_DATUM(0))))</tt>
    tends to replace
    <tt>PG_GETARG_VARLENA(0)</tt>

From devrim at lists.slony.info  Tue Jun  5 11:17:33 2007
From: devrim at lists.slony.info (Devrim GUNDUZ)
Date: Tue Jun  5 11:17:34 2007
Subject: [Slony1-commit] slony1-engine/redhat slon.init
Message-ID: <20070605181733.B1558290C21@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/redhat
In directory main.slony.info:/tmp/cvs-serv4944

Modified Files:
      Tag: REL_1_2_STABLE
	slon.init 
Log Message:
Add reload() to init script


Index: slon.init
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/redhat/slon.init,v
retrieving revision 1.1.2.1
retrieving revision 1.1.2.2
diff -C2 -d -r1.1.2.1 -r1.1.2.2
*** slon.init	17 May 2007 07:13:55 -0000	1.1.2.1
--- slon.init	5 Jun 2007 18:17:31 -0000	1.1.2.2
***************
*** 10,13 ****
--- 10,15 ----
  # v1.0.0 Devrim GUNDUZ <devrim@CommandPrompt.com>
  # - Initial version of Red Hat / Fedora init script, based on Ubuntu one.
+ # v1.0.0 Devrim GUNDUZ <devrim@CommandPrompt.com>
+ # - Added reload()
  
  if [ -r /etc/sysconfig/slony1 ]; then
***************
*** 49,53 ****
  SLONCONF=/etc/slon.conf
  SLONPID=/var/run/slon.pid
! 
  test -x $SLONDAEMON || exit 5
  
--- 51,55 ----
  SLONCONF=/etc/slon.conf
  SLONPID=/var/run/slon.pid
! SLONLOG=/var/log/slony1
  test -x $SLONDAEMON || exit 5
  
***************
*** 59,63 ****
  
  	echo -n "$SLON_START"
! 	daemon $SLONDAEMON -f $SLONCONF -p $SLONPID 2>&1 </dev/null &
  	sleep 2
  
--- 61,65 ----
  
  	echo -n "$SLON_START"
! 	$SU -l postgres -c "$SLONDAEMON -f $SLONCONF &" >> "$SLONLOG" 2>&1 < /dev/null
  	sleep 2
  
***************
*** 94,97 ****
--- 96,110 ----
  }
  
+ reload(){
+ echo -n $"Reloading ${NAME}: "
+    if [ -n "`pidfileofproc $SLONDAEMON`" ] ; then
+       killproc $SLONDAEMON -HUP
+    else
+       failure $"Reloading ${NAME}"
+    fi
+    RETVAL=$?
+    echo
+ }
+ 
  condrestart(){
      [ -e /var/lock/subsys/${NAME} ] && restart
***************
*** 111,115 ****
          ;;
    status)
!         status postmaster
          script_result=$?
          ;;
--- 124,128 ----
          ;;
    status)
!         status slon
          script_result=$?
          ;;
***************
*** 117,120 ****
--- 130,136 ----
          restart
          ;;
+   reload|force-reload)
+         reload
+         ;;
    condrestart)
          condrestart
***************
*** 124,128 ****
          ;;
    *)
!         echo $"Usage: $0 {start|stop|status|restart|condrestart|condstop}"
          exit 1
  esac
--- 140,144 ----
          ;;
    *)
!         echo $"Usage: $0 {start|stop|status|restart|condrestart|condstop|reload|force-reload}"
          exit 1
  esac

From devrim at lists.slony.info  Tue Jun  5 11:18:14 2007
From: devrim at lists.slony.info (Devrim GUNDUZ)
Date: Tue Jun  5 11:18:16 2007
Subject: [Slony1-commit] slony1-engine/redhat postgresql-slony1-engine.spec
	slony-I.specfile
Message-ID: <20070605181814.F0716290C22@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/redhat
In directory main.slony.info:/tmp/cvs-serv4972

Added Files:
      Tag: REL_1_2_STABLE
	postgresql-slony1-engine.spec 
Removed Files:
      Tag: REL_1_2_STABLE
	slony-I.specfile 
Log Message:
Rename the spec file and improve it.


--- NEW FILE: postgresql-slony1-engine.spec ---
%define sname	slony1

%{!?perltools:%define perltools 1}
%{!?docs:%define docs 1}
%{?buildrhel3:%define kerbdir /usr/kerberos}
%{!?kerbdir:%define kerbdir "/usr"}

%define pg_version	%(rpm -qv postgresql-devel|head -n 1|awk -F '-' '{print $3}')

Summary:	A "master to multiple slaves" replication system with cascading and failover
Name:		postgresql-slony1-engine
Version:	1.2.9
Release:	2_PG%{pg_version}%{?dist}
License:	BSD
Group:		Applications/Databases
URL:		http://main.slony.info/
Source0:	http://main.slony.info/downloads/1.2/source/%{sname}-%{version}.tar.bz2
Source2:	postgresql-%{sname}-engine.init
BuildRoot:	%{_tmppath}/%{name}-%{version}-%{release}-root-%(%{__id_u} -n)
BuildRequires:	postgresql-devel = %{pg_version}
Requires:	postgresql-server = %{pg_version}

%if %docs
BuildRequires:	docbook-style-dsssl
%endif

%define prefix /usr

%description
Slony-I is a "master to multiple slaves" replication 
system for PostgreSQL with cascading and failover.

The big picture for the development of Slony-I is to build
a master-slave system that includes all features and
capabilities needed to replicate large databases to a
reasonably limited number of slave systems.

Slony-I is a system for data centers and backup
sites, where the normal mode of operation is that all nodes
are available

%if %docs
%package docs
Summary:	Documentation for Slony-I
Group:		Applications/Databases
Requires:	%{name}-%{version}-%{release}

%description docs
The postgresql-slony1-engine-docs package includes some 
documentation for Slony-I.
%endif

%prep
%setup -q -n %{sname}-%{version}

%build

# Temporary measure for 1.2.9
%if %docs
chmod 644 doc/concept/*
chmod 644 doc/adminguide/*
chmod 644 doc/implementation/*
chmod 644 doc/howto/*
chmod 644 doc/concept/*
chmod 644 doc/support/*
%endif

CFLAGS="${CFLAGS:-%optflags}" ; export CFLAGS
CXXFLAGS="${CXXFLAGS:-%optflags}" ; export CXXFLAGS
CPPFLAGS="${CPPFLAGS} -I%{_includedir}/et -I%{kerbdir}/include" ; export CPPFLAGS
CFLAGS="${CFLAGS} -I%{_includedir}/et -I%{kerbdir}/include" ; export CFLAGS

# Strip out -ffast-math from CFLAGS....

CFLAGS=`echo $CFLAGS|xargs -n 1|grep -v ffast-math|xargs -n 100`
export LIBNAME=%{_lib}
%configure --includedir %{_includedir}/pgsql --with-pgconfigdir=%{_bindir} \
%if %perltools
	--with-perltools=%{_bindir} --with-toolsbin=%{_bindir} \
%endif
%if %docs
	--with-docs --with-docdir=%{_docdir}/%{name}-%{version} \
%endif
	--datadir %{_datadir}/pgsql --sysconfdir=%{_sysconfdir} --with-pglibdir=%{_libdir}/pgsql 

autoconf

make %{?_smp_mflags}
%if %perltools
	make %{?_smp_mflags} -C tools
%endif

%install
rm -rf %{buildroot}
install -d %{buildroot}%{_sysconfdir}
install -d %{buildroot}%{_datadir}/pgsql/
install -d %{buildroot}%{_libdir}/pgsql/
make %{?_smp_mflags} DESTDIR=%{buildroot} install
install -m 0755 src/backend/slony1_funcs.so %{buildroot}%{_libdir}/pgsql/slony1_funcs.so
install -m 0755 src/xxid/xxid.so %{buildroot}%{_libdir}/pgsql/xxid.so
install -m 0644 src/backend/*.sql %{buildroot}%{_datadir}/pgsql/
install -m 0644 src/xxid/*.sql %{buildroot}%{_datadir}/pgsql/
install -m 0755 tools/*.sh  %{buildroot}%{_bindir}/
install -m 0644 share/slon.conf-sample %{buildroot}%{_sysconfdir}/slon.conf

if [ -d /etc/rc.d/init.d ]
then
	install -d %{buildroot}/etc/rc.d/init.d
	install -m 755 %{SOURCE2} %{buildroot}/etc/rc.d/init.d/postgresql-slony1-engine
fi

# Temporary measure for 1.2.9
%if %docs
	rm -f doc/implementation/.cvsignore
	rm -f doc/concept/.cvsignore
%endif

%if %perltools
cd tools
make %{?_smp_mflags} DESTDIR=%{buildroot} install
/bin/rm -rf altperl/*.pl altperl/ToDo altperl/README altperl/Makefile altperl/CVS
install -m 0644 altperl/slon_tools.conf-sample  %{buildroot}%{_sysconfdir}/slon_tools.conf
install -m 0755 altperl/* %{buildroot}%{_bindir}/
install -m 0644 altperl/slon-tools  %{buildroot}%{_libdir}/pgsql/slon-tools.pm
/bin/rm -f %{buildroot}%{_sysconfdir}/slon_tools.conf-sample
/bin/rm -f %{buildroot}%{_bindir}/slon_tools.conf-sample
#/bin/rm -f %{buildroot}%{_libdir}/pgsql/slon-tools.pm
/bin/rm -f %{buildroot}%{_bindir}/slon-tools.pm
/bin/rm -f %{buildroot}%{_bindir}/slon-tools
/bin/rm -f %{buildroot}%{_bindir}/pgsql/slon-tools
/bin/rm -f altperl/old-apache-rotatelogs.patch
%endif

%clean
rm -rf %{buildroot}

%post
chkconfig --add postgresql-slony1-engine

%preun
if [ $1 = 0 ] ; then
	/sbin/service slon condstop >/dev/null 2>&1
	chkconfig --del postgresql-slony1-engine
fi

%postun
if [ $1 -ge 1 ]; then
	/sbin/service postgresql-slony1-engine condrestart >/dev/null 2>&1
fi


%files
%defattr(-,root,root,-)
%attr(755,root,root) %{_docdir}/%{name}
%attr(644,root,root) %doc COPYRIGHT UPGRADING HISTORY-1.1 INSTALL SAMPLE RELEASE-1.2.1 RELEASE-1.2.2 RELEASE-1.2.5 RELEASE-1.2.6 RELEASE-1.2.7 RELEASE-1.2.8 RELEASE-1.2.9
%{_bindir}/*
%{_libdir}/pgsql/slony1_funcs.so
%{_libdir}/pgsql/xxid.so
%{_datadir}/pgsql/*.sql
%config(noreplace) %{_sysconfdir}/slon.conf
%if %perltools
%{_libdir}/pgsql/slon-tools.pm
%config(noreplace) %{_sysconfdir}/slon_tools.conf
%attr(755,root,root) %{_sysconfdir}/rc.d/init.d/postgresql-slony1-engine
%endif

%if %docs
%files docs
%doc doc/adminguide  doc/concept  doc/howto  doc/implementation  doc/support
%endif

%changelog
* Sun Jun 3 2007 Devrim Gunduz <devrim@CommandPrompt.com>
- Some more fixes for Fedora review.
- Remove executable bits from docs.

* Thu May 17 2007 Devrim Gunduz <devrim@CommandPrompt.com>
- Install init script with rpm.
- Fix --with-pgconfigdir parameter
- Fix rpm build problem when the system has pg_config in both under
  /usr/local/pgsql/bin and /usr/bin

* Wed Mar 22 2007 Christopher Browne <cbbrowne@ca.afilias.info>
- Added more recent release notes

* Wed Mar 7 2007 Christopher Browne <cbbrowne@ca.afilias.info>
- Added more recent release notes

* Thu Jan 4 2007 Devrim Gunduz <devrim@CommandPrompt.com>
- Add docs package (It should be added before but...)

* Wed Nov 8 2006 Devrim Gunduz <devrim@CommandPrompt.com>
- On 64-bit boxes, both 32 and 64 bit -devel packages may be installed. 
  Fix version check script
- Revert tar name patch
- Macros cannot be used in various parts of the spec file. Revert that commit
- Spec file cleanup

* Tue Oct 31 2006 Trevor Astrope <astrope@sitesell.com>
- Fixup tar name and install slon-tools as slon-tools.pm

* Mon Jul 17 2006 Devrim Gunduz <devrim@CommandPrompt.com> postgresql-slony1-engine
- Updated spec and cleaned up rpmlint errors and warnings

* Wed Dec 21 2005 Devrim Gunduz <devrim@commandprompt.com> postgresql-slony1-engine
- Added a buildrhel3 macro to fix RHEL 3 RPM builds
- Added a kerbdir macro

* Wed Dec 14 2005 Devrim Gunduz <devrim@commandprompt.com> postgresql-slony1-engine
- Fixed the spec file so that during upgrade, conf files will not be replaced, and a .rpmnew will be created.

* Thu Nov 24 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Created bindir

* Wed Oct 26 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Modify CPPFLAGS and CFLAGS to fix builds on RHEL -- Per Philip Yarra

* Tue Oct 18 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Created a new package : -docs and moved all the docs there.

* Tue Oct 18 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Fixed the problem in http://gborg.postgresql.org/pipermail/slony1-general/2005-October/003105.html

* Sat Oct 01 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Upgrade to 1.1.1

* Tue Jul 12 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Added a line to check postgresql RPM version and tag SlonyI RPM with it.
- Updated Requires files so that it checks correct PostgreSQL version
- Moved autoconf line into correct place.

* Thu Jun 08 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Added UPGRADING, HISTORY-1.1, INSTALL, SAMPLE among installed files, reflecting the change in GNUMakefile.in

* Thu Jun 02 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Apply a new docs macro and disable building of docs by default.
- Remove slon-tools.conf-sample from bindir.
- Removed --bindir and --libdir, since they are not needed.

* Mon Apr 10 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- More fixes on RPM builds

* Thu Apr 07 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- More fixes on RPM builds

* Tue Apr 04 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Fix RPM build errors, regarding to tools/ .

* Thu Apr 02 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Added docs to installed files list.
- Added perltools, so that tools/altperl may be compiled.
- Updated the spec file

* Thu Mar 17 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Update to 1.1.0beta1
- Remove PostgreSQL source dependency

* Thu Mar 17 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Fix RPM builds

* Thu Mar 18 2004 Daniel Berrange <berrange@redhat.com> postgresql-slony1-engine
- Initial RPM packaging


--- slony-I.specfile DELETED ---

From devrim at lists.slony.info  Tue Jun  5 11:26:00 2007
From: devrim at lists.slony.info (Devrim GUNDUZ)
Date: Tue Jun  5 11:26:01 2007
Subject: [Slony1-commit] slony1-engine/redhat postgresql-slony1-engine.init
	slon.init
Message-ID: <20070605182600.6CD04290C2D@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/redhat
In directory main.slony.info:/tmp/cvs-serv5261

Added Files:
      Tag: REL_1_2_STABLE
	postgresql-slony1-engine.init 
Removed Files:
      Tag: REL_1_2_STABLE
	slon.init 
Log Message:
Rename the init script; and add various improvements


--- slon.init DELETED ---

--- NEW FILE: postgresql-slony1-engine.init ---
#!/bin/sh
# postgresql    This is the init script for starting up the Slony-I
#
# chkconfig: - 64 36
# description: Starts and stops the Slon daemon that handles
#              Slony-I replication.
# processname: postgresql-slony1-engine
# pidfile:	/var/run/postgresql-slony1-engine.pid
#
# v1.0.0 Devrim GUNDUZ <devrim@CommandPrompt.com>
# - Initial version of Red Hat / Fedora init script, based on Ubuntu one.
# v1.0.0 Devrim GUNDUZ <devrim@CommandPrompt.com>
# - Added reload()

if [ -r /etc/sysconfig/slony1 ]; then
    . /etc/sysconfig/slony1
fi

# Source function library.
INITD=/etc/rc.d/init.d
. $INITD/functions

# Get function listing for cross-distribution logic.
TYPESET=`typeset -f|grep "declare"`

# Get config.
. /etc/sysconfig/network

# For SELinux we need to use 'runuser' not 'su'
if [ -x /sbin/runuser ]
then
	SU=runuser
else
	SU=su
fi

# Check that networking is up.
# We need it for postgresql-slony1-engine
[ "${NETWORKING}" = "no" ] && exit 0

# Find the name of the script
NAME=postgresql-slony1-engine

# Set defaults for configuration variables
SLONENGINE=/usr/bin
SLONDAEMON=$SLONENGINE/slon
SLONCONF=/etc/slon.conf
SLONPID=/var/run/slon.pid
SLONLOG=/var/log/slony1
test -x $SLONDAEMON || exit 5


script_result=0

start(){
	SLON_START=$"Starting ${NAME} service: "

	echo -n "$SLON_START"
	$SU -l postgres -c "$SLONDAEMON -f $SLONCONF &" >> "$SLONLOG" 2>&1 < /dev/null
	sleep 2

	pid=`pidof -s "$SLONDAEMON"`
	if [ $pid ] 
	then
		success "$SLON_START"
		touch /var/lock/subsys/${NAME}
		echo
	else
		failure "$PSQL_START"
		echo
		script_result=1
	fi
}

stop(){
	echo -n $"Stopping ${NAME} service: "
        if [ $UID -ne 0 ]; then
                RETVAL=1
                failure
        else
                killproc /usr/bin/slon
                RETVAL=$?
                [ $RETVAL -eq 0 ] && rm -f /var/lock/subsys/${NAME}
        fi;
        echo
        return $RETVAL
}

restart(){
    stop
    start
}

reload(){
echo -n $"Reloading ${NAME}: "
   if [ -n "`pidfileofproc $SLONDAEMON`" ] ; then
      killproc $SLONDAEMON -HUP
   else
      failure $"Reloading ${NAME}"
   fi
   RETVAL=$?
   echo
}

condrestart(){
    [ -e /var/lock/subsys/${NAME} ] && restart
}

condstop(){
    [ -e /var/lock/subsys/${NAME} ] && stop
}

# See how we were called.
case "$1" in
  start)
        start
        ;;
  stop)
        stop
        ;;
  status)
        status slon
        script_result=$?
        ;;
  restart)
        restart
        ;;
  reload|force-reload)
        reload
        ;;
  condrestart)
        condrestart
        ;;
  condstop)
        condstop
        ;;
  *)
        echo $"Usage: $0 {start|stop|status|restart|condrestart|condstop|reload|force-reload}"
        exit 1
esac

exit $script_result

From devrim at lists.slony.info  Tue Jun  5 11:45:59 2007
From: devrim at lists.slony.info (Devrim GUNDUZ)
Date: Tue Jun  5 11:46:01 2007
Subject: [Slony1-commit] slony1-engine/redhat postgresql-slony1-engine.spec
	postgresql-slony1-engine.specfile
Message-ID: <20070605184559.C808029045F@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/redhat
In directory main.slony.info:/tmp/cvs-serv5421

Added Files:
      Tag: REL_1_2_STABLE
	postgresql-slony1-engine.specfile 
Removed Files:
      Tag: REL_1_2_STABLE
	postgresql-slony1-engine.spec 
Log Message:
Ouch, if this file name and the tarball name matches, rpmbuild picks up this file from tarball while running -ta. So we need to change its name.


--- postgresql-slony1-engine.spec DELETED ---

--- NEW FILE: postgresql-slony1-engine.specfile ---
%define sname	slony1

%{!?perltools:%define perltools 1}
%{!?docs:%define docs 1}
%{?buildrhel3:%define kerbdir /usr/kerberos}
%{!?kerbdir:%define kerbdir "/usr"}

%define pg_version	%(rpm -qv postgresql-devel|head -n 1|awk -F '-' '{print $3}')

Summary:	A "master to multiple slaves" replication system with cascading and failover
Name:		postgresql-slony1-engine
Version:	1.2.9
Release:	2_PG%{pg_version}%{?dist}
License:	BSD
Group:		Applications/Databases
URL:		http://main.slony.info/
Source0:	http://main.slony.info/downloads/1.2/source/%{sname}-%{version}.tar.bz2
Source2:	postgresql-%{sname}-engine.init
BuildRoot:	%{_tmppath}/%{name}-%{version}-%{release}-root-%(%{__id_u} -n)
BuildRequires:	postgresql-devel = %{pg_version}
Requires:	postgresql-server = %{pg_version}

%if %docs
BuildRequires:	docbook-style-dsssl
%endif

%define prefix /usr

%description
Slony-I is a "master to multiple slaves" replication 
system for PostgreSQL with cascading and failover.

The big picture for the development of Slony-I is to build
a master-slave system that includes all features and
capabilities needed to replicate large databases to a
reasonably limited number of slave systems.

Slony-I is a system for data centers and backup
sites, where the normal mode of operation is that all nodes
are available

%if %docs
%package docs
Summary:	Documentation for Slony-I
Group:		Applications/Databases
Requires:	%{name}-%{version}-%{release}

%description docs
The postgresql-slony1-engine-docs package includes some 
documentation for Slony-I.
%endif

%prep
%setup -q -n %{sname}-%{version}

%build

# Temporary measure for 1.2.9
%if %docs
chmod 644 doc/concept/*
chmod 644 doc/adminguide/*
chmod 644 doc/implementation/*
chmod 644 doc/howto/*
chmod 644 doc/concept/*
chmod 644 doc/support/*
%endif

CFLAGS="${CFLAGS:-%optflags}" ; export CFLAGS
CXXFLAGS="${CXXFLAGS:-%optflags}" ; export CXXFLAGS
CPPFLAGS="${CPPFLAGS} -I%{_includedir}/et -I%{kerbdir}/include" ; export CPPFLAGS
CFLAGS="${CFLAGS} -I%{_includedir}/et -I%{kerbdir}/include" ; export CFLAGS

# Strip out -ffast-math from CFLAGS....

CFLAGS=`echo $CFLAGS|xargs -n 1|grep -v ffast-math|xargs -n 100`
export LIBNAME=%{_lib}
%configure --includedir %{_includedir}/pgsql --with-pgconfigdir=%{_bindir} \
%if %perltools
	--with-perltools=%{_bindir} --with-toolsbin=%{_bindir} \
%endif
%if %docs
	--with-docs --with-docdir=%{_docdir}/%{name}-%{version} \
%endif
	--datadir %{_datadir}/pgsql --sysconfdir=%{_sysconfdir} --with-pglibdir=%{_libdir}/pgsql 

autoconf

make %{?_smp_mflags}
%if %perltools
	make %{?_smp_mflags} -C tools
%endif

%install
rm -rf %{buildroot}
install -d %{buildroot}%{_sysconfdir}
install -d %{buildroot}%{_datadir}/pgsql/
install -d %{buildroot}%{_libdir}/pgsql/
make %{?_smp_mflags} DESTDIR=%{buildroot} install
install -m 0755 src/backend/slony1_funcs.so %{buildroot}%{_libdir}/pgsql/slony1_funcs.so
install -m 0755 src/xxid/xxid.so %{buildroot}%{_libdir}/pgsql/xxid.so
install -m 0644 src/backend/*.sql %{buildroot}%{_datadir}/pgsql/
install -m 0644 src/xxid/*.sql %{buildroot}%{_datadir}/pgsql/
install -m 0755 tools/*.sh  %{buildroot}%{_bindir}/
install -m 0644 share/slon.conf-sample %{buildroot}%{_sysconfdir}/slon.conf

if [ -d /etc/rc.d/init.d ]
then
	install -d %{buildroot}/etc/rc.d/init.d
	install -m 755 %{SOURCE2} %{buildroot}/etc/rc.d/init.d/postgresql-slony1-engine
fi

# Temporary measure for 1.2.9
%if %docs
	rm -f doc/implementation/.cvsignore
	rm -f doc/concept/.cvsignore
%endif

%if %perltools
cd tools
make %{?_smp_mflags} DESTDIR=%{buildroot} install
/bin/rm -rf altperl/*.pl altperl/ToDo altperl/README altperl/Makefile altperl/CVS
install -m 0644 altperl/slon_tools.conf-sample  %{buildroot}%{_sysconfdir}/slon_tools.conf
install -m 0755 altperl/* %{buildroot}%{_bindir}/
install -m 0644 altperl/slon-tools  %{buildroot}%{_libdir}/pgsql/slon-tools.pm
/bin/rm -f %{buildroot}%{_sysconfdir}/slon_tools.conf-sample
/bin/rm -f %{buildroot}%{_bindir}/slon_tools.conf-sample
#/bin/rm -f %{buildroot}%{_libdir}/pgsql/slon-tools.pm
/bin/rm -f %{buildroot}%{_bindir}/slon-tools.pm
/bin/rm -f %{buildroot}%{_bindir}/slon-tools
/bin/rm -f %{buildroot}%{_bindir}/pgsql/slon-tools
/bin/rm -f altperl/old-apache-rotatelogs.patch
%endif

%clean
rm -rf %{buildroot}

%post
chkconfig --add postgresql-slony1-engine

%preun
if [ $1 = 0 ] ; then
	/sbin/service slon condstop >/dev/null 2>&1
	chkconfig --del postgresql-slony1-engine
fi

%postun
if [ $1 -ge 1 ]; then
	/sbin/service postgresql-slony1-engine condrestart >/dev/null 2>&1
fi


%files
%defattr(-,root,root,-)
%attr(755,root,root) %{_docdir}/%{name}
%attr(644,root,root) %doc COPYRIGHT UPGRADING HISTORY-1.1 INSTALL SAMPLE RELEASE-1.2.1 RELEASE-1.2.2 RELEASE-1.2.5 RELEASE-1.2.6 RELEASE-1.2.7 RELEASE-1.2.8 RELEASE-1.2.9
%{_bindir}/*
%{_libdir}/pgsql/slony1_funcs.so
%{_libdir}/pgsql/xxid.so
%{_datadir}/pgsql/*.sql
%config(noreplace) %{_sysconfdir}/slon.conf
%if %perltools
%{_libdir}/pgsql/slon-tools.pm
%config(noreplace) %{_sysconfdir}/slon_tools.conf
%attr(755,root,root) %{_sysconfdir}/rc.d/init.d/postgresql-slony1-engine
%endif

%if %docs
%files docs
%doc doc/adminguide  doc/concept  doc/howto  doc/implementation  doc/support
%endif

%changelog
* Sun Jun 3 2007 Devrim Gunduz <devrim@CommandPrompt.com>
- Some more fixes for Fedora review.
- Remove executable bits from docs.

* Thu May 17 2007 Devrim Gunduz <devrim@CommandPrompt.com>
- Install init script with rpm.
- Fix --with-pgconfigdir parameter
- Fix rpm build problem when the system has pg_config in both under
  /usr/local/pgsql/bin and /usr/bin

* Wed Mar 22 2007 Christopher Browne <cbbrowne@ca.afilias.info>
- Added more recent release notes

* Wed Mar 7 2007 Christopher Browne <cbbrowne@ca.afilias.info>
- Added more recent release notes

* Thu Jan 4 2007 Devrim Gunduz <devrim@CommandPrompt.com>
- Add docs package (It should be added before but...)

* Wed Nov 8 2006 Devrim Gunduz <devrim@CommandPrompt.com>
- On 64-bit boxes, both 32 and 64 bit -devel packages may be installed. 
  Fix version check script
- Revert tar name patch
- Macros cannot be used in various parts of the spec file. Revert that commit
- Spec file cleanup

* Tue Oct 31 2006 Trevor Astrope <astrope@sitesell.com>
- Fixup tar name and install slon-tools as slon-tools.pm

* Mon Jul 17 2006 Devrim Gunduz <devrim@CommandPrompt.com> postgresql-slony1-engine
- Updated spec and cleaned up rpmlint errors and warnings

* Wed Dec 21 2005 Devrim Gunduz <devrim@commandprompt.com> postgresql-slony1-engine
- Added a buildrhel3 macro to fix RHEL 3 RPM builds
- Added a kerbdir macro

* Wed Dec 14 2005 Devrim Gunduz <devrim@commandprompt.com> postgresql-slony1-engine
- Fixed the spec file so that during upgrade, conf files will not be replaced, and a .rpmnew will be created.

* Thu Nov 24 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Created bindir

* Wed Oct 26 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Modify CPPFLAGS and CFLAGS to fix builds on RHEL -- Per Philip Yarra

* Tue Oct 18 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Created a new package : -docs and moved all the docs there.

* Tue Oct 18 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Fixed the problem in http://gborg.postgresql.org/pipermail/slony1-general/2005-October/003105.html

* Sat Oct 01 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Upgrade to 1.1.1

* Tue Jul 12 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Added a line to check postgresql RPM version and tag SlonyI RPM with it.
- Updated Requires files so that it checks correct PostgreSQL version
- Moved autoconf line into correct place.

* Thu Jun 08 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Added UPGRADING, HISTORY-1.1, INSTALL, SAMPLE among installed files, reflecting the change in GNUMakefile.in

* Thu Jun 02 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Apply a new docs macro and disable building of docs by default.
- Remove slon-tools.conf-sample from bindir.
- Removed --bindir and --libdir, since they are not needed.

* Mon Apr 10 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- More fixes on RPM builds

* Thu Apr 07 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- More fixes on RPM builds

* Tue Apr 04 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Fix RPM build errors, regarding to tools/ .

* Thu Apr 02 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Added docs to installed files list.
- Added perltools, so that tools/altperl may be compiled.
- Updated the spec file

* Thu Mar 17 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Update to 1.1.0beta1
- Remove PostgreSQL source dependency

* Thu Mar 17 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Fix RPM builds

* Thu Mar 18 2004 Daniel Berrange <berrange@redhat.com> postgresql-slony1-engine
- Initial RPM packaging


From devrim at lists.slony.info  Tue Jun  5 11:52:20 2007
From: devrim at lists.slony.info (Devrim GUNDUZ)
Date: Tue Jun  5 11:52:22 2007
Subject: [Slony1-commit] slony1-engine postgresql-slony1-engine.spec.in
Message-ID: <20070605185220.6ED3E290C1A@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine
In directory main.slony.info:/tmp/cvs-serv5488

Modified Files:
      Tag: REL_1_2_STABLE
	postgresql-slony1-engine.spec.in 
Log Message:
Final fixes for the main spec file.


Index: postgresql-slony1-engine.spec.in
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/postgresql-slony1-engine.spec.in,v
retrieving revision 1.31.2.13
retrieving revision 1.31.2.14
diff -C2 -d -r1.31.2.13 -r1.31.2.14
*** postgresql-slony1-engine.spec.in	3 Jun 2007 09:35:04 -0000	1.31.2.13
--- postgresql-slony1-engine.spec.in	5 Jun 2007 18:52:18 -0000	1.31.2.14
***************
*** 4,17 ****
  %{!?kerbdir:%define kerbdir "/usr"}
  
! %define pg_version   %(rpm -qv postgresql-devel|head -n 1|awk -F '-' '{print $3}')
  
  Summary:	A "master to multiple slaves" replication system with cascading and failover
  Name:		@PACKAGE_NAME@
  Version:	@PACKAGE_VERSION@
! Release:	1_PG%{pg_version}
  License:	BSD
  Group:		Applications/Databases
! URL:		http://slony.info/
! Source0:	@PACKAGE_NAME@-%{version}.tar.gz
  BuildRoot:	%{_tmppath}/%{name}-%{version}-%{release}-root-%(%{__id_u} -n)
  BuildRequires:	postgresql-devel
--- 4,17 ----
  %{!?kerbdir:%define kerbdir "/usr"}
  
! %define pg_version	%(rpm -qv postgresql-devel|head -n 1|awk -F '-' '{print $3}')
  
  Summary:	A "master to multiple slaves" replication system with cascading and failover
  Name:		@PACKAGE_NAME@
  Version:	@PACKAGE_VERSION@
! Release:	2_PG%{pg_version}%{?dist}
  License:	BSD
  Group:		Applications/Databases
! URL:		http://main.slony.info/
! Source0:	http://main.slony.info/downloads/1.2/source/@PACKAGE_NAME@-%{version}.tar.gz
  BuildRoot:	%{_tmppath}/%{name}-%{version}-%{release}-root-%(%{__id_u} -n)
  BuildRequires:	postgresql-devel
***************
*** 44,48 ****
  
  %description docs
! The @PACKAGE_NAME@-docs package includes some documentation for Slony-I.
  %endif
  
--- 44,49 ----
  
  %description docs
! The @PACKAGE_NAME@-docs package includes some 
! documentation for Slony-I.
  %endif
  
***************
*** 51,54 ****
--- 52,66 ----
  
  %build
+ 
+ # Temporary measure for 1.2.9
+ %if %docs
+ chmod 644 doc/concept/*
+ chmod 644 doc/adminguide/*
+ chmod 644 doc/implementation/*
+ chmod 644 doc/howto/*
+ chmod 644 doc/concept/*
+ chmod 644 doc/support/*
+ %endif
+ 
  CFLAGS="${CFLAGS:-%optflags}" ; export CFLAGS
  CXXFLAGS="${CXXFLAGS:-%optflags}" ; export CXXFLAGS
***************
*** 62,71 ****
  ./configure --includedir %{_includedir}/pgsql --with-pgconfigdir=%{_bindir} \
  %if %perltools
!         --with-perltools=%{_bindir} --with-toolsbin=%{_bindir} \
  %endif
  %if %docs
!         --with-docs --with-docdir=%{_docdir}/%{name}-%{version} \
  %endif
!         --datadir %{_datadir}/pgsql --sysconfdir=%{_sysconfdir} --with-pglibdir=%{_libdir}/pgsql 
  
  autoconf
--- 74,83 ----
  ./configure --includedir %{_includedir}/pgsql --with-pgconfigdir=%{_bindir} \
  %if %perltools
! 	--with-perltools=%{_bindir} --with-toolsbin=%{_bindir} \
  %endif
  %if %docs
! 	--with-docs --with-docdir=%{_docdir}/%{name}-%{version} \
  %endif
! 	--datadir %{_datadir}/pgsql --sysconfdir=%{_sysconfdir} --with-pglibdir=%{_libdir}/pgsql 
  
  autoconf
***************
*** 73,77 ****
  make %{?_smp_mflags}
  %if %perltools
!         make %{?_smp_mflags} -C tools
  %endif
  
--- 85,89 ----
  make %{?_smp_mflags}
  %if %perltools
! 	make %{?_smp_mflags} -C tools
  %endif
  
***************
*** 92,98 ****
  then
  	install -d %{buildroot}/etc/rc.d/init.d
! 	install -m 755 redhat/slon.init %{buildroot}/etc/rc.d/init.d/slon
  fi
  
  
  %if %perltools
--- 104,115 ----
  then
  	install -d %{buildroot}/etc/rc.d/init.d
! 	install -m 755 redhat/@PACKAGE_NAME@.init %{buildroot}/etc/rc.d/init.d/@PACKAGE_NAME@
  fi
  
+ # Temporary measure for 1.2.9
+ %if %docs
+ 	rm -f doc/implementation/.cvsignore
+ 	rm -f doc/concept/.cvsignore
+ %endif
  
  %if %perltools
***************
*** 105,109 ****
  /bin/rm -f %{buildroot}%{_sysconfdir}/slon_tools.conf-sample
  /bin/rm -f %{buildroot}%{_bindir}/slon_tools.conf-sample
- #/bin/rm -f %{buildroot}%{_libdir}/pgsql/slon-tools.pm
  /bin/rm -f %{buildroot}%{_bindir}/slon-tools.pm
  /bin/rm -f %{buildroot}%{_bindir}/slon-tools
--- 122,125 ----
***************
*** 115,135 ****
  
  %post
! chkconfig --add slon
  
  %preun
  if [ $1 = 0 ] ; then
! 	/sbin/service slon condstop >/dev/null 2>&1
! 	chkconfig --del slon
  fi
  
  %postun
  if [ $1 -ge 1 ]; then
! 	/sbin/service slon condrestart >/dev/null 2>&1
  fi
  
- 
  %files
  %defattr(-,root,root,-)
! %doc COPYRIGHT UPGRADING HISTORY-1.1 INSTALL SAMPLE RELEASE-1.2.1 RELEASE-1.2.2 RELEASE-1.2.5 RELEASE-1.2.6 RELEASE-1.2.7 RELEASE-1.2.8 RELEASE-1.2.9
  %{_bindir}/*
  %{_libdir}/pgsql/slony1_funcs.so
--- 131,150 ----
  
  %post
! chkconfig --add @PACKAGE_NAME@
  
  %preun
  if [ $1 = 0 ] ; then
! 	/sbin/service @PACKAGE_NAME@ condstop >/dev/null 2>&1
! 	chkconfig --del @PACKAGE_NAME@
  fi
  
  %postun
  if [ $1 -ge 1 ]; then
! 	/sbin/service @PACKAGE_NAME@ condrestart >/dev/null 2>&1
  fi
  
  %files
  %defattr(-,root,root,-)
! %attr(644,root,root) %doc COPYRIGHT UPGRADING HISTORY-1.1 INSTALL SAMPLE RELEASE
  %{_bindir}/*
  %{_libdir}/pgsql/slony1_funcs.so
***************
*** 140,153 ****
  %{_libdir}/pgsql/slon-tools.pm
  %config(noreplace) %{_sysconfdir}/slon_tools.conf
! %{_sysconfdir}/rc.d/init.d/slon
  %endif
  
  %if %docs
  %files docs
! %defattr(-,root,root,-)
  %doc doc/adminguide  doc/concept  doc/howto  doc/implementation  doc/support
  %endif
  
  %changelog
  * Thu May 17 2007 Devrim Gunduz <devrim@CommandPrompt.com>
  - Install init script with rpm.
--- 155,173 ----
  %{_libdir}/pgsql/slon-tools.pm
  %config(noreplace) %{_sysconfdir}/slon_tools.conf
! %attr(755,root,root) %{_sysconfdir}/rc.d/init.d/@PACKAGE_NAME@
  %endif
  
  %if %docs
  %files docs
! %defattr(644,root,root,-)
! %attr(755,root,root) %{_docdir}/%{name}-%{version}
  %doc doc/adminguide  doc/concept  doc/howto  doc/implementation  doc/support
  %endif
  
  %changelog
+ * Sun Jun 3 2007 Devrim Gunduz <devrim@CommandPrompt.com> 1.2.9-2
+ - Some more fixes for Fedora review.
+ - Remove executable bits from docs.
+ 
  * Thu May 17 2007 Devrim Gunduz <devrim@CommandPrompt.com>
  - Install init script with rpm.

From wieck at lists.slony.info  Tue Jun  5 15:22:09 2007
From: wieck at lists.slony.info (Jan Wieck)
Date: Tue Jun  5 15:22:11 2007
Subject: [Slony1-commit] slony1-engine/src/ducttape test_5_ddlscript
	test_5_pgbench.in
Message-ID: <20070605222209.24E5B290C0C@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/ducttape
In directory main.slony.info:/tmp/cvs-serv6954/src/ducttape

Modified Files:
	test_5_ddlscript test_5_pgbench.in 
Log Message:
Fix EXECUTE SCRIPT so that it records the ev_seqno for WAIT FOR EVENT
and make sure all DDL is executed in session_replication_role "local"
on the origin as well as all subscribers. This will cause the slony
triggers to ignore all DML statements while user triggers follow the
regular configuration options for ENABLE [REPLICA/ALWAYS] or DISABLE.

TODO: Put the correct session_replication_role setting into archive
logs as well.

Jan


Index: test_5_pgbench.in
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/ducttape/test_5_pgbench.in,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** test_5_pgbench.in	15 May 2007 19:40:16 -0000	1.3
--- test_5_pgbench.in	5 Jun 2007 22:22:07 -0000	1.4
***************
*** 265,275 ****
  done
  echo "**** pgbench finished"
! echo "**** please terminate the replication engines when caught up."
! wait $slon1_pid
! wait $slon2_pid
  
  kill $pgbench_pid 2>/dev/null
- kill $slon1_pid 2>/dev/null
- kill $slon2_pid 2>/dev/null
  
  echo -n "**** comparing databases ... "
--- 265,286 ----
  done
  echo "**** pgbench finished"
! sleep 1
! 
! slonik <<_EOF_
! 	cluster name = T1;
! 	node 1 admin conninfo = 'dbname=$DB1';
! 	node 2 admin conninfo = 'dbname=$DB2';
! 
! 	echo '**** Issuing slonik SYNC against DB1';
! 	sync (id = 1);
! 
! 	echo '**** Waiting for DB2 to catch up';
! 	wait for event (origin = 1, confirmed = 2, wait on = 1);
! _EOF_
! 
! 
! echo "**** you can terminate the replication engines."
  
  kill $pgbench_pid 2>/dev/null
  
  echo -n "**** comparing databases ... "

Index: test_5_ddlscript
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/ducttape/test_5_ddlscript,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** test_5_ddlscript	18 Jun 2004 20:22:01 -0000	1.2
--- test_5_ddlscript	5 Jun 2007 22:22:07 -0000	1.3
***************
*** 82,88 ****
--- 82,98 ----
  
  	try {
+ 		echo '  execute script';
  		execute script (set id = 1, filename = 'test_5_tmp.sql',
  			event node = 1);
+ 	}
+ 	on error {
+ 		exit 1;
+ 	}
+ 
+ 	echo '  wait for execute script';
+ 	wait for event (origin = 1, confirmed = 2);
  
+ 	try {
+ 		echo '  create temporary set 999';
  		create set (id = 999, origin = 1, comment = 'temp set for new objects');
  
***************
*** 99,102 ****
--- 109,116 ----
  		exit 1;
  	}
+ 
+ 	echo '  wait for create set &co';
+ 	wait for event (origin = 1, confirmed = all, wait on = 1);
+ 	echo '  temporary set 999 ready for subscription';
  _EOF_
  

From wieck at lists.slony.info  Tue Jun  5 15:22:09 2007
From: wieck at lists.slony.info (Jan Wieck)
Date: Tue Jun  5 15:22:11 2007
Subject: [Slony1-commit] slony1-engine/src/slonik dbutil.c slonik.c slonik.h
Message-ID: <20070605222209.5BA46290C19@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slonik
In directory main.slony.info:/tmp/cvs-serv6954/src/slonik

Modified Files:
	dbutil.c slonik.c slonik.h 
Log Message:
Fix EXECUTE SCRIPT so that it records the ev_seqno for WAIT FOR EVENT
and make sure all DDL is executed in session_replication_role "local"
on the origin as well as all subscribers. This will cause the slony
triggers to ignore all DML statements while user triggers follow the
regular configuration options for ENABLE [REPLICA/ALWAYS] or DISABLE.

TODO: Put the correct session_replication_role setting into archive
logs as well.

Jan


Index: slonik.h
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slonik/slonik.h,v
retrieving revision 1.30
retrieving revision 1.31
diff -C2 -d -r1.30 -r1.31
*** slonik.h	18 Apr 2007 15:03:51 -0000	1.30
--- slonik.h	5 Jun 2007 22:22:07 -0000	1.31
***************
*** 579,593 ****
  int			db_disconnect(SlonikStmt * stmt, SlonikAdmInfo * adminfo);
  
! int db_exec_command(SlonikStmt * stmt, SlonikAdmInfo * adminfo,
  				SlonDString * query);
! int db_exec_evcommand(SlonikStmt * stmt, SlonikAdmInfo * adminfo,
! 				  SlonDString * query);
! PGresult *db_exec_select(SlonikStmt * stmt, SlonikAdmInfo * adminfo,
! 			   SlonDString * query);
! int db_get_version(SlonikStmt * stmt, SlonikAdmInfo * adminfo);
! int db_check_namespace(SlonikStmt * stmt, SlonikAdmInfo * adminfo,
! 				   char *clustername);
! int db_check_requirements(SlonikStmt * stmt, SlonikAdmInfo * adminfo,
! 					  char *clustername);
  int			db_get_nodeid(SlonikStmt * stmt, SlonikAdmInfo * adminfo);
  int			db_begin_xact(SlonikStmt * stmt, SlonikAdmInfo * adminfo);
--- 579,597 ----
  int			db_disconnect(SlonikStmt * stmt, SlonikAdmInfo * adminfo);
  
! int			db_exec_command(SlonikStmt * stmt, SlonikAdmInfo * adminfo,
  				SlonDString * query);
! int			db_exec_evcommand(SlonikStmt * stmt, SlonikAdmInfo * adminfo,
! 				SlonDString * query);
! int			db_exec_evcommand_p(SlonikStmt * stmt, SlonikAdmInfo * adminfo,
! 				SlonDString * query, int nParams, const Oid *paramTypes, 
! 				const char *const *paramValues, const int *paramLengths, 
! 				const int *paramFormats, int resultFormat);
! PGresult   *db_exec_select(SlonikStmt * stmt, SlonikAdmInfo * adminfo,
! 				SlonDString * query);
! int			db_get_version(SlonikStmt * stmt, SlonikAdmInfo * adminfo);
! int			db_check_namespace(SlonikStmt * stmt, SlonikAdmInfo * adminfo,
! 				char *clustername);
! int			db_check_requirements(SlonikStmt * stmt, SlonikAdmInfo * adminfo,
! 				char *clustername);
  int			db_get_nodeid(SlonikStmt * stmt, SlonikAdmInfo * adminfo);
  int			db_begin_xact(SlonikStmt * stmt, SlonikAdmInfo * adminfo);

Index: slonik.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slonik/slonik.c,v
retrieving revision 1.77
retrieving revision 1.78
diff -C2 -d -r1.77 -r1.78
*** slonik.c	31 May 2007 16:46:18 -0000	1.77
--- slonik.c	5 Jun 2007 22:22:07 -0000	1.78
***************
*** 3665,3669 ****
  	SlonDString script;
  	int			rc;
! 	int num_statements = -1, stmtno;
  	char		buf[4096];
  	char		rex1[256];
--- 3665,3669 ----
  	SlonDString script;
  	int			rc;
! 	int			num_statements = -1, stmtno;
  	char		buf[4096];
  	char		rex1[256];
***************
*** 3671,3676 ****
  	char		rex3[256];
  	char		rex4[256];
- 	PGresult *res;
- 	ExecStatusType rstat;
  
  #define PARMCOUNT 1  
--- 3671,3674 ----
***************
*** 3745,3761 ****
  		free(dest);
  
! 		res = PQexec(adminfo1->dbconn, dstring_data(&query));
! 
! 		if (PQresultStatus(res) != PGRES_COMMAND_OK && 
! 		    PQresultStatus(res) != PGRES_TUPLES_OK &&
! 		    PQresultStatus(res) != PGRES_EMPTY_QUERY)
  		{
- 			rstat = PQresultStatus(res);
- 			printf("DDL Statement failed - %s\n", PQresStatus(rstat));
  			dstring_free(&query);
  			return -1;
  		}
- 		/* rstat = PQresultStatus(res); */
- 		/* printf ("Success - %s\n", PQresStatus(rstat)); */
  	}
  	
--- 3743,3751 ----
  		free(dest);
  
! 		if (db_exec_command((SlonikStmt *)stmt, adminfo1, &query) < 0)
  		{
  			dstring_free(&query);
  			return -1;
  		}
  	}
  	
***************
*** 3771,3788 ****
  	params[PARMCOUNT-1] = dstring_data(&script);
  
! 	res = PQexecParams(adminfo1->dbconn, dstring_data(&query), PARMCOUNT,
! 			   NULL, params, paramlens, paramfmts, 0);
! 	
! 	if (PQresultStatus(res) != PGRES_COMMAND_OK && 
! 	    PQresultStatus(res) != PGRES_TUPLES_OK &&
! 	    PQresultStatus(res) != PGRES_EMPTY_QUERY)
  	{
- 		rstat = PQresultStatus(res);
- 		printf("Event submission for DDL failed - %s\n", PQresStatus(rstat));
  		dstring_free(&query);
  		return -1;
- 	} else {
- 		rstat = PQresultStatus(res);
- 		printf ("DDL on origin - %s\n", PQresStatus(rstat));
  	}
  	
--- 3761,3769 ----
  	params[PARMCOUNT-1] = dstring_data(&script);
  
! 	if (db_exec_evcommand_p((SlonikStmt *)stmt, adminfo1, &query,
! 				PARMCOUNT, NULL, params, paramlens, paramfmts, 0) < 0)
  	{
  		dstring_free(&query);
  		return -1;
  	}
  	

Index: dbutil.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slonik/dbutil.c,v
retrieving revision 1.13
retrieving revision 1.14
diff -C2 -d -r1.13 -r1.14
*** dbutil.c	18 Apr 2007 15:03:51 -0000	1.13
--- dbutil.c	5 Jun 2007 22:22:07 -0000	1.14
***************
*** 140,144 ****
  
  	dstring_init(&query);
! 	slon_mkquery(&query,"SET datestyle to 'ISO'");
  
  	adminfo->dbconn = dbconn;
--- 140,145 ----
  
  	dstring_init(&query);
! 	slon_mkquery(&query,"SET datestyle TO 'ISO'; "
! 						"SET session_replication_role TO local; ");
  
  	adminfo->dbconn = dbconn;
***************
*** 257,260 ****
--- 258,310 ----
  
  /* ----------
+  * db_exec_evcommand_p
+  *
+  *	Execute a stored procedure returning an event sequence and remember
+  *	that in the admin info for later wait events. Differs from
+  *	db_exec_evcommand by using PQexecParams().
+  * ----------
+  */
+ int
+ db_exec_evcommand_p(SlonikStmt * stmt, SlonikAdmInfo * adminfo, 
+ 		SlonDString * query, int nParams, const Oid *paramTypes,
+ 		const char *const *paramValues, const int *paramLengths,
+ 		const int *paramFormats, int resultFormat)
+ {
+ 	PGresult   *res;
+ 
+ 	db_notice_stmt = stmt;
+ 
+ 	if (db_begin_xact(stmt, adminfo) < 0)
+ 		return -1;
+ 
+ 	res = PQexecParams(adminfo->dbconn, dstring_data(query),
+ 			nParams, paramTypes, paramValues, paramLengths,
+ 			paramFormats, resultFormat);
+ 	if (PQresultStatus(res) != PGRES_TUPLES_OK)
+ 	{
+ 		fprintf(stderr, "%s:%d: %s %s - %s",
+ 				stmt->stmt_filename, stmt->stmt_lno,
+ 				PQresStatus(PQresultStatus(res)),
+ 				dstring_data(query), PQresultErrorMessage(res));
+ 		PQclear(res);
+ 		return -1;
+ 	}
+ 	if (PQntuples(res) != 1)
+ 	{
+ 		fprintf(stderr, "%s:%d: %s - did not return 1 row",
+ 				stmt->stmt_filename, stmt->stmt_lno,
+ 				dstring_data(query));
+ 		PQclear(res);
+ 		return -1;
+ 	}
+ 
+ 	slon_scanint64(PQgetvalue(res, 0, 0), &(adminfo->last_event));
+ 	PQclear(res);
+ 
+ 	return 0;
+ }
+ 
+ 
+ /* ----------
   * db_exec_select
   *

From wieck at lists.slony.info  Tue Jun  5 15:22:09 2007
From: wieck at lists.slony.info (Jan Wieck)
Date: Tue Jun  5 15:22:11 2007
Subject: [Slony1-commit] slony1-engine/src/slon remote_worker.c
Message-ID: <20070605222209.3A76F290C12@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slon
In directory main.slony.info:/tmp/cvs-serv6954/src/slon

Modified Files:
	remote_worker.c 
Log Message:
Fix EXECUTE SCRIPT so that it records the ev_seqno for WAIT FOR EVENT
and make sure all DDL is executed in session_replication_role "local"
on the origin as well as all subscribers. This will cause the slony
triggers to ignore all DML statements while user triggers follow the
regular configuration options for ENABLE [REPLICA/ALWAYS] or DISABLE.

TODO: Put the correct session_replication_role setting into archive
logs as well.

Jan


Index: remote_worker.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/remote_worker.c,v
retrieving revision 1.140
retrieving revision 1.141
diff -C2 -d -r1.140 -r1.141
*** remote_worker.c	31 May 2007 16:46:18 -0000	1.140
--- remote_worker.c	5 Jun 2007 22:22:07 -0000	1.141
***************
*** 1315,1318 ****
--- 1315,1319 ----
  
  				slon_appendquery(&query1,
+ 						 "set session_replication_role to local; "
  						 "select %s.ddlScript_prepare_int(%d, %d); ",
  						 rtcfg_namespace,
***************
*** 1371,1375 ****
  				}
  	
! 				(void) slon_mkquery(&query1, "select %s.ddlScript_complete_int(%d, %d); ", 
  					     rtcfg_namespace,
  					     ddl_setid,
--- 1372,1378 ----
  				}
  	
! 				(void) slon_mkquery(&query1,
! 						"select %s.ddlScript_complete_int(%d, %d); " 
! 						"set session_replication_role to replica; ",
  					     rtcfg_namespace,
  					     ddl_setid,

From wieck at lists.slony.info  Wed Jun  6 09:20:58 2007
From: wieck at lists.slony.info (Jan Wieck)
Date: Wed Jun  6 09:21:00 2007
Subject: [Slony1-commit] slony1-engine/src/slon remote_worker.c
Message-ID: <20070606162058.1ED6B290C03@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slon
In directory main.slony.info:/tmp/cvs-serv10660/src/slon

Modified Files:
	remote_worker.c 
Log Message:
Let the logshipping files also switch to session_replication_role = "replica"
or "local" (for DDL).

Jan


Index: remote_worker.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/remote_worker.c,v
retrieving revision 1.141
retrieving revision 1.142
diff -C2 -d -r1.141 -r1.142
*** remote_worker.c	5 Jun 2007 22:22:07 -0000	1.141
--- remote_worker.c	6 Jun 2007 16:20:56 -0000	1.142
***************
*** 1391,1396 ****
--- 1391,1400 ----
  					{
  
+ 						if (archive_append_str(node, "set session_replication_role to local;\n") < 0)
+ 							slon_retry();
  						if (archive_append_str(node, ddl_script) < 0)
  							slon_retry();
+ 						if (archive_append_str(node, "set session_replication_role to replica;\n") < 0)
+ 							slon_retry();
  					}
  				}
***************
*** 5170,5173 ****
--- 5174,5178 ----
  				   "-- Slony-I log shipping archive\n"
  				   "-- Node %d, Event %s\n"
+ 				   "set session_replication_role to replica;\n"
  				   "start transaction;\n",
  				   node->no_id, seqbuf);

From wieck at lists.slony.info  Wed Jun  6 09:20:58 2007
From: wieck at lists.slony.info (Jan Wieck)
Date: Wed Jun  6 09:21:00 2007
Subject: [Slony1-commit] slony1-engine/src/ducttape test_8_logship.in
Message-ID: <20070606162058.0AB31290BFF@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/ducttape
In directory main.slony.info:/tmp/cvs-serv10660/src/ducttape

Modified Files:
	test_8_logship.in 
Log Message:
Let the logshipping files also switch to session_replication_role = "replica"
or "local" (for DDL).

Jan


Index: test_8_logship.in
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/ducttape/test_8_logship.in,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** test_8_logship.in	31 May 2007 13:29:26 -0000	1.2
--- test_8_logship.in	6 Jun 2007 16:20:55 -0000	1.3
***************
*** 282,292 ****
  done
  echo "**** pgbench finished"
! echo "**** please terminate the replication engines when caught up."
! wait $slon1_pid
! wait $slon2_pid
  
! kill $pgbench_pid 2>/dev/null
! kill $slon1_pid 2>/dev/null
! kill $slon2_pid 2>/dev/null
  
  sh ./compare_pgbench_dumps $DB1 $DB2
--- 282,293 ----
  done
  echo "**** pgbench finished"
! slonik <<_EOF_
! 	include <$PREAMBLE_FILE>;
  
! 	echo '**** waiting for DB2 to catch up';
! 	sync (id = 1);
! 	wait for event (origin = 1, confirmed = 2, wait on = 1);
! _EOF_
! echo "**** you can terminate the replication engines."
  
  sh ./compare_pgbench_dumps $DB1 $DB2

From cbbrowne at lists.slony.info  Wed Jun  6 15:17:12 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Wed Jun  6 15:17:14 2007
Subject: [Slony1-commit] slony1-engine/doc/adminguide faq.sgml
	loganalysis.sgml
Message-ID: <20070606221712.B2B0C29047B@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/doc/adminguide
In directory main.slony.info:/tmp/cvs-serv5758

Modified Files:
      Tag: REL_1_2_STABLE
	faq.sgml loganalysis.sgml 
Log Message:
Elaborate on documentation in a couple places


Index: faq.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/faq.sgml,v
retrieving revision 1.66.2.4
retrieving revision 1.66.2.5
diff -C2 -d -r1.66.2.4 -r1.66.2.5
*** faq.sgml	16 Mar 2007 19:01:26 -0000	1.66.2.4
--- faq.sgml	6 Jun 2007 22:17:10 -0000	1.66.2.5
***************
*** 346,349 ****
--- 346,353 ----
  could also announce an admin to take a look...  </para> </answer>
  
+ <answer><para> As of &postgres; 8.3, this should no longer be an
+ issue, as this version has code which invalidates query plans when
+ tables are altered. </para> </answer>
+ 
  </qandaentry>
  

Index: loganalysis.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/loganalysis.sgml,v
retrieving revision 1.4.2.3
retrieving revision 1.4.2.4
diff -C2 -d -r1.4.2.3 -r1.4.2.4
*** loganalysis.sgml	16 Feb 2007 23:36:18 -0000	1.4.2.3
--- loganalysis.sgml	6 Jun 2007 22:17:10 -0000	1.4.2.4
***************
*** 695,699 ****
  <listitem><para><command>ERROR: remoteWorkerThread_%d: SYNC aborted</command></para> 
  
! <para> If any errors have been encountered that haven't already aborted the <command>SYNC</command>, this catches and aborts it.</para></listitem>
  
  <listitem><para><command>DEBUG2: remoteWorkerThread_%d: new sl_rowid_seq value: %s</command></para> 
--- 695,707 ----
  <listitem><para><command>ERROR: remoteWorkerThread_%d: SYNC aborted</command></para> 
  
! <para>The <command>SYNC</command> has been aborted. The &lslon; will
! likely retry this <command>SYNC</command> some time soon.  If the
! <command>SYNC</command> continues to fail, there is some continuing
! problem, and replication will likely never catch up without
! intervention.  It may be necessary to unsubscribe/resubscribe the
! affected slave set, or, if there is only one set on the slave node, it
! may be simpler to drop and recreate the slave node.  If application
! connections may be shifted over to the master during this time,
! application downtime may not be necessary.  </para></listitem>
  
  <listitem><para><command>DEBUG2: remoteWorkerThread_%d: new sl_rowid_seq value: %s</command></para> 

From cbbrowne at lists.slony.info  Wed Jun  6 15:18:24 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Wed Jun  6 15:18:25 2007
Subject: [Slony1-commit] slony1-engine/tests support_funcs.sh
	random_number.c random_string.c Makefile
Message-ID: <20070606221824.1F6EA290BDF@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/tests
In directory main.slony.info:/tmp/cvs-serv5803

Modified Files:
      Tag: REL_1_2_STABLE
	support_funcs.sh 
Added Files:
      Tag: REL_1_2_STABLE
	random_number.c random_string.c Makefile 
Log Message:
Add in faster C-based "generate random stuff" programs to help generate
random data for scripts


Index: support_funcs.sh
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tests/support_funcs.sh,v
retrieving revision 1.4
retrieving revision 1.4.2.1
diff -C2 -d -r1.4 -r1.4.2.1
*** support_funcs.sh	21 Mar 2006 22:36:05 -0000	1.4
--- support_funcs.sh	6 Jun 2007 22:18:22 -0000	1.4.2.1
***************
*** 88,91 ****
--- 88,94 ----
    _upperbound=$2
  
+   if [ -e ./random_number ] ; then
+     rannum=`./random_number ${_lowerbound} ${_upperbound}`
+   else
    case `uname` in
    *BSD|Darwin)
***************
*** 113,116 ****
--- 116,120 ----
    ;;
    esac
+   fi
    echo ${rannum}
  }

--- NEW FILE: random_string.c ---
/* $Id: random_string.c,v 1.1.2.1 2007-06-06 22:18:22 cbbrowne Exp $ */

#include <stdlib.h>
#include <stdio.h>

int main(int argc, const char *argv[])
{
	int length, i;
	int base, result;
	if (argc != 2) {
		printf("args: %d - random_string: length\n", argc);
		exit (1);
	}
	sscanf(argv[1], "%d", &length);

	srand(time(0));
	for (i = 0; i< length; i++) 
		printf("%c", (rand() % (122-48))+48);
	printf("\n", result);
}

--- NEW FILE: Makefile ---
all: random_number random_string

random_number: random_number.c
	$(CC) random_number.c -o random_number

random_string: random_string.c
	$(CC) random_string.c -o random_string
--- NEW FILE: random_number.c ---
/* $Id: random_number.c,v 1.1.2.1 2007-06-06 22:18:22 cbbrowne Exp $ */

#include <stdlib.h>
#include <stdio.h>

int main(int argc, const char *argv[])
{
	int lower, upper;
	int base, result;
	if (argc != 3) {
		printf("args: %d - random_number: lower_limit upper_limit\n", argc);
		exit (1);
	}
	sscanf(argv[1], "%d", &lower);
	sscanf(argv[2], "%d", &upper);

	srand(time(0));
	base = rand();
	result = (base % (upper - lower)) + lower;

	printf("%d\n", result);
}

From cbbrowne at lists.slony.info  Wed Jun  6 15:20:41 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Wed Jun  6 15:20:43 2007
Subject: [Slony1-commit] slony1-engine/tests Makefile random_number.c
	random_string.c support_funcs.sh
Message-ID: <20070606222041.C6914290BE5@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/tests
In directory main.slony.info:/tmp/cvs-serv5846

Modified Files:
	support_funcs.sh 
Added Files:
	Makefile random_number.c random_string.c 
Log Message:
Add in C programs to more efficiently generate random numbers and strings
for generating random transactions


Index: support_funcs.sh
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tests/support_funcs.sh,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** support_funcs.sh	21 Mar 2006 22:36:05 -0000	1.4
--- support_funcs.sh	6 Jun 2007 22:20:39 -0000	1.5
***************
*** 88,91 ****
--- 88,94 ----
    _upperbound=$2
  
+   if [ -e ./random_number ] ; then
+     rannum=`./random_number ${_lowerbound} ${_upperbound}`
+   else
    case `uname` in
    *BSD|Darwin)
***************
*** 113,116 ****
--- 116,120 ----
    ;;
    esac
+   fi
    echo ${rannum}
  }
***************
*** 123,126 ****
--- 127,133 ----
  
    _length=$1
+   if [ -e ./random_string ] ; then
+     rannum=`./random_string ${_length}`
+   else
    case `uname` in
    *BSD|Darwin)
***************
*** 151,155 ****
    ;;
    esac
! 
    echo ${ranstring}
  }
--- 158,162 ----
    ;;
    esac
!   fi
    echo ${ranstring}
  }

--- NEW FILE: random_string.c ---
/* $Id: random_string.c,v 1.2 2007-06-06 22:20:39 cbbrowne Exp $ */

#include <stdlib.h>
#include <stdio.h>

int main(int argc, const char *argv[])
{
	int length, i;
	int base, result;
	if (argc != 2) {
		printf("args: %d - random_string: length\n", argc);
		exit (1);
	}
	sscanf(argv[1], "%d", &length);

	srand(time(0));
	for (i = 0; i< length; i++) 
		printf("%c", (rand() % (122-48))+48);
	printf("\n", result);
}

--- NEW FILE: Makefile ---
all: random_number random_string

random_number: random_number.c
	$(CC) random_number.c -o random_number

random_string: random_string.c
	$(CC) random_string.c -o random_string
--- NEW FILE: random_number.c ---
/* $Id: random_number.c,v 1.2 2007-06-06 22:20:39 cbbrowne Exp $ */

#include <stdlib.h>
#include <stdio.h>

int main(int argc, const char *argv[])
{
	int lower, upper;
	int base, result;
	if (argc != 3) {
		printf("args: %d - random_number: lower_limit upper_limit\n", argc);
		exit (1);
	}
	sscanf(argv[1], "%d", &lower);
	sscanf(argv[2], "%d", &upper);

	srand(time(0));
	base = rand();
	result = (base % (upper - lower)) + lower;

	printf("%d\n", result);
}

From cbbrowne at lists.slony.info  Wed Jun  6 15:21:16 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Wed Jun  6 15:21:18 2007
Subject: [Slony1-commit] slony1-engine/tests support_funcs.sh
Message-ID: <20070606222116.CD7E3290BDF@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/tests
In directory main.slony.info:/tmp/cvs-serv5878

Modified Files:
      Tag: REL_1_2_STABLE
	support_funcs.sh 
Log Message:
Add usage of random_string C program to support_funcs.sh


Index: support_funcs.sh
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tests/support_funcs.sh,v
retrieving revision 1.4.2.1
retrieving revision 1.4.2.2
diff -C2 -d -r1.4.2.1 -r1.4.2.2
*** support_funcs.sh	6 Jun 2007 22:18:22 -0000	1.4.2.1
--- support_funcs.sh	6 Jun 2007 22:21:14 -0000	1.4.2.2
***************
*** 127,130 ****
--- 127,133 ----
  
    _length=$1
+   if [ -e ./random_string ] ; then
+     rannum=`./random_string ${_length}`
+   else
    case `uname` in
    *BSD|Darwin)
***************
*** 155,159 ****
    ;;
    esac
! 
    echo ${ranstring}
  }
--- 158,162 ----
    ;;
    esac
!   fi
    echo ${ranstring}
  }

From cbbrowne at lists.slony.info  Wed Jun  6 15:23:19 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Wed Jun  6 15:23:21 2007
Subject: [Slony1-commit] slony1-engine config.h.in
Message-ID: <20070606222319.1D572290BE8@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine
In directory main.slony.info:/tmp/cvs-serv5929

Modified Files:
      Tag: REL_1_2_STABLE
	config.h.in 
Log Message:
Update version number to 1.2.10


Index: config.h.in
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/config.h.in,v
retrieving revision 1.17.2.6
retrieving revision 1.17.2.7
diff -C2 -d -r1.17.2.6 -r1.17.2.7
*** config.h.in	22 Mar 2007 20:41:27 -0000	1.17.2.6
--- config.h.in	6 Jun 2007 22:23:17 -0000	1.17.2.7
***************
*** 13,18 ****
  #define SLONY_I_CONFIG_H
  
! #define SLONY_I_VERSION_STRING	"1.2.9"
! #define SLONY_I_VERSION_STRING_DEC 1,2,9
  
  #ifndef PG_VERSION_MAJOR
--- 13,18 ----
  #define SLONY_I_CONFIG_H
  
! #define SLONY_I_VERSION_STRING	"1.2.10"
! #define SLONY_I_VERSION_STRING_DEC 1,2,10
  
  #ifndef PG_VERSION_MAJOR

From cbbrowne at lists.slony.info  Wed Jun  6 15:23:19 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Wed Jun  6 15:23:21 2007
Subject: [Slony1-commit] slony1-engine/src/backend slony1_funcs.sql
Message-ID: <20070606222319.172A8290BE5@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/backend
In directory main.slony.info:/tmp/cvs-serv5929/src/backend

Modified Files:
      Tag: REL_1_2_STABLE
	slony1_funcs.sql 
Log Message:
Update version number to 1.2.10


Index: slony1_funcs.sql
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/backend/slony1_funcs.sql,v
retrieving revision 1.98.2.15
retrieving revision 1.98.2.16
diff -C2 -d -r1.98.2.15 -r1.98.2.16
*** slony1_funcs.sql	18 Apr 2007 19:28:27 -0000	1.98.2.15
--- slony1_funcs.sql	6 Jun 2007 22:23:16 -0000	1.98.2.16
***************
*** 431,435 ****
  as '
  begin
! 	return 9;
  end;
  ' language plpgsql;
--- 431,435 ----
  as '
  begin
! 	return 10;
  end;
  ' language plpgsql;

From wieck at lists.slony.info  Wed Jun  6 18:45:33 2007
From: wieck at lists.slony.info (Jan Wieck)
Date: Wed Jun  6 18:45:34 2007
Subject: [Slony1-commit] slony1-engine/src/misc  - New directory
Message-ID: <20070607014533.642CF29043E@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/misc
In directory main.slony.info:/tmp/cvs-serv7180/src/misc

Log Message:
Directory /home/cvsd/slony1/slony1-engine/src/misc added to the repository


From wieck at lists.slony.info  Thu Jun  7 06:01:12 2007
From: wieck at lists.slony.info (Jan Wieck)
Date: Thu Jun  7 06:01:14 2007
Subject: [Slony1-commit] slony1-engine/src/ducttape test_1_pgbench.in
Message-ID: <20070607130112.8CA2329028B@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/ducttape
In directory main.slony.info:/tmp/cvs-serv25549/src/ducttape

Modified Files:
	test_1_pgbench.in 
Log Message:
Attempt to remove the sl_seqlog flood.

This patch adds a new function seqtrack(seqid,seqvalue) that will return
NULL if called with the same seqvalue before, the seqvalue instead. This
function is used to suppress sl_seqlog rows of sequences that didn't change
since the last SYNC. 

Jan


Index: test_1_pgbench.in
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/ducttape/test_1_pgbench.in,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** test_1_pgbench.in	15 May 2007 14:05:15 -0000	1.2
--- test_1_pgbench.in	7 Jun 2007 13:01:10 -0000	1.3
***************
*** 158,161 ****
--- 158,164 ----
  			id = 4, fully qualified name = 'public.history',
  			comment = 'Table history');
+ 		set add sequence (set id = 1, origin = 11,
+ 			id = 5, fully qualified name = 'public.history_seq',
+ 			comment = 'Sequence history_seq');
  	}
  	on error {

From wieck at lists.slony.info  Thu Jun  7 06:01:12 2007
From: wieck at lists.slony.info (Jan Wieck)
Date: Thu Jun  7 06:01:14 2007
Subject: [Slony1-commit] slony1-engine/src/slon remote_worker.c
Message-ID: <20070607130112.B36932903DF@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slon
In directory main.slony.info:/tmp/cvs-serv25549/src/slon

Modified Files:
	remote_worker.c 
Log Message:
Attempt to remove the sl_seqlog flood.

This patch adds a new function seqtrack(seqid,seqvalue) that will return
NULL if called with the same seqvalue before, the seqvalue instead. This
function is used to suppress sl_seqlog rows of sequences that didn't change
since the last SYNC. 

Jan


Index: remote_worker.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/remote_worker.c,v
retrieving revision 1.142
retrieving revision 1.143
diff -C2 -d -r1.142 -r1.143
*** remote_worker.c	6 Jun 2007 16:20:56 -0000	1.142
--- remote_worker.c	7 Jun 2007 13:01:10 -0000	1.143
***************
*** 3129,3133 ****
  	 */
  	(void) slon_mkquery(&query1,
! 				 "select SL.seql_seqid, SL.seql_last_value, "
  				 "    %s.slon_quote_brute(PGN.nspname) || '.' || "
  				 "    %s.slon_quote_brute(PGC.relname) as tab_fqname "
--- 3129,3133 ----
  	 */
  	(void) slon_mkquery(&query1,
! 				 "select SL.seql_seqid, max(SL.seql_last_value), "
  				 "    %s.slon_quote_brute(PGN.nspname) || '.' || "
  				 "    %s.slon_quote_brute(PGC.relname) as tab_fqname "
***************
*** 3137,3143 ****
  				 "	where SQ.seq_set = %d "
  				 "		and SL.seql_seqid = SQ.seq_id "
! 				 "		and SL.seql_ev_seqno = '%s' "
  				 "		and PGC.oid = SQ.seq_reloid "
! 				 "		and PGN.oid = PGC.relnamespace; ",
  				 rtcfg_namespace,
  				 rtcfg_namespace,
--- 3137,3144 ----
  				 "	where SQ.seq_set = %d "
  				 "		and SL.seql_seqid = SQ.seq_id "
! 				 "		and SL.seql_ev_seqno <= '%s' "
  				 "		and PGC.oid = SQ.seq_reloid "
! 				 "		and PGN.oid = PGC.relnamespace "
! 				 "  group by 1, 3; ",
  				 rtcfg_namespace,
  				 rtcfg_namespace,
***************
*** 3174,3204 ****
  
  
! 		/*
! 		 * sequence with ID 0 is a nodes rowid ... only remember in seqlog.
! 		 */
! 		if (strtol(seql_seqid, NULL, 10) != 0)
! 		{
! 			(void) slon_mkquery(&query1,
! 						 "select \"pg_catalog\".setval('%q', '%s'); ",
! 						 seq_fqname, seql_last_value);
  
! 			if (archive_dir)
! 			{
! 				rc = archive_append_ds(node, &query1);
! 				if (rc < 0) {
! 				  PQclear(res1);
! 				  slon_disconnectdb(pro_conn);
! 				  dstring_free(&query1);
! 				  dstring_free(&query2);
! 				  dstring_free(&query3);
! 				  dstring_free(&lsquery);
! 				  dstring_free(&indexregenquery);
! 				  archive_terminate(node);
! 				  return -1;
! 				}
  			}
  		}
! 		else
! 			dstring_reset(&query1);
  		slon_appendquery(&query1,
  						 "insert into %s.sl_seqlog "
--- 3175,3198 ----
  
  
! 		(void) slon_mkquery(&query1,
! 					 "select \"pg_catalog\".setval('%q', '%s'); ",
! 					 seq_fqname, seql_last_value);
  
! 		if (archive_dir)
! 		{
! 			rc = archive_append_ds(node, &query1);
! 			if (rc < 0) {
! 			  PQclear(res1);
! 			  slon_disconnectdb(pro_conn);
! 			  dstring_free(&query1);
! 			  dstring_free(&query2);
! 			  dstring_free(&query3);
! 			  dstring_free(&lsquery);
! 			  dstring_free(&indexregenquery);
! 			  archive_terminate(node);
! 			  return -1;
  			}
  		}
! 
  		slon_appendquery(&query1,
  						 "insert into %s.sl_seqlog "
***************
*** 3588,3591 ****
--- 3582,3586 ----
  
  	int			actionlist_len;
+ 	int64		min_ssy_seqno;
  
  	gettimeofday(&tv_start, NULL);
***************
*** 3740,3743 ****
--- 3735,3739 ----
  					 event->ev_maxxid_c);
  
+ 	min_ssy_seqno = -1;
  	for (provider = wd->provider_head; provider; provider = provider->next)
  	{
***************
*** 3806,3809 ****
--- 3802,3810 ----
  			char	   *ssy_xip = PQgetvalue(res1, tupno1, 4);
  			char	   *ssy_action_list = PQgetvalue(res1, tupno1, 5);
+ 			int64		ssy_seqno;
+ 
+ 			slon_scanint64(PQgetvalue(res1, tupno1, 1), &ssy_seqno);
+ 			if (min_ssy_seqno < 0 || ssy_seqno < min_ssy_seqno)
+ 				min_ssy_seqno = ssy_seqno;
  
  			/*
***************
*** 4281,4300 ****
  		int			ntuples1;
  		int			tupno1;
  
  		(void) slon_mkquery(&query,
! 					 "select SL.seql_seqid, SL.seql_last_value "
  					 "	from %s.sl_seqlog SL, "
  					 "		%s.sl_sequence SQ "
  					 "	where SQ.seq_id = SL.seql_seqid "
  					 "		and SL.seql_origin = %d "
! 					 "		and SL.seql_ev_seqno = '%s' "
  					 "		and SQ.seq_set in (",
  					 rtcfg_namespace, rtcfg_namespace,
! 					 node->no_id, seqbuf);
  		for (pset = provider->set_head; pset; pset = pset->next)
  			slon_appendquery(&query, "%s%d",
  							 (pset->prev == NULL) ? "" : ",",
  							 pset->set_id);
! 		slon_appendquery(&query, "); ");
  
  		res1 = PQexec(provider->conn->dbconn, dstring_data(&query));
--- 4282,4306 ----
  		int			ntuples1;
  		int			tupno1;
+ 		char		min_ssy_seqno_buf[64];
+ 
+ 		sprintf(min_ssy_seqno_buf, INT64_FORMAT, min_ssy_seqno);
  
  		(void) slon_mkquery(&query,
! 					 "select SL.seql_seqid, max(SL.seql_last_value) "
  					 "	from %s.sl_seqlog SL, "
  					 "		%s.sl_sequence SQ "
  					 "	where SQ.seq_id = SL.seql_seqid "
  					 "		and SL.seql_origin = %d "
! 					 "		and SL.seql_ev_seqno <= '%s' "
! 					 "		and SL.seql_ev_seqno >= '%s' "
  					 "		and SQ.seq_set in (",
  					 rtcfg_namespace, rtcfg_namespace,
! 					 node->no_id, seqbuf, min_ssy_seqno_buf);
  		for (pset = provider->set_head; pset; pset = pset->next)
  			slon_appendquery(&query, "%s%d",
  							 (pset->prev == NULL) ? "" : ",",
  							 pset->set_id);
! 		slon_appendquery(&query, ") "
! 					"  group by 1; ");
  
  		res1 = PQexec(provider->conn->dbconn, dstring_data(&query));

From wieck at lists.slony.info  Thu Jun  7 06:01:12 2007
From: wieck at lists.slony.info (Jan Wieck)
Date: Thu Jun  7 06:01:15 2007
Subject: [Slony1-commit] slony1-engine/src/misc avl_tree.c avl_tree.h
Message-ID: <20070607130112.9E2572902B3@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/misc
In directory main.slony.info:/tmp/cvs-serv25549/src/misc

Added Files:
	avl_tree.c avl_tree.h 
Log Message:
Attempt to remove the sl_seqlog flood.

This patch adds a new function seqtrack(seqid,seqvalue) that will return
NULL if called with the same seqvalue before, the seqvalue instead. This
function is used to suppress sl_seqlog rows of sequences that didn't change
since the last SYNC. 

Jan


--- NEW FILE: avl_tree.c ---
/* ----------------------------------------------------------------------
 * avl_tree.c
 *
 *	AVL style self balancing tree support.
 *
 *  Copyright (c) 2007, PostgreSQL Global Development Group
 *  Author: Jan Wieck, Afilias USA INC.
 *
 *  $Id: avl_tree.c,v 1.1 2007-06-07 13:01:10 wieck Exp $
 * ----------------------------------------------------------------------
 */

#include "avl_tree.h"

/* ----
 * local function declarations
 * ----
 */
static AVLnode	   *avl_makenode(void);
static void			avl_reset_node(AVLnode *node, AVLfreefunc *freefunc);
static int			avl_insertinto(AVLtree *tree, AVLnode **node,
									void *cdata, AVLnode **result);
static void			avl_rotate_left(AVLnode **node);
static void			avl_rotate_right(AVLnode **node);


/* ----
 * avl_init() -
 *
 *	Initilize an AVL tree structure.
 *
 *	compfunc is a user supplied tri-state comparision function that compares
 *	two tree elements and returns <0, 0 or >0 (like strcmp).
 *
 *	If freefunc is specified, it is called to free no longer used elements.
 *	Note that the element will not immediately be free'd on avl_delete(),
 *	but only on a avl_delete, avl_insert sequence using the same key.
 * ----
 */
void
avl_init(AVLtree *tree, AVLcompfunc *compfunc, AVLfreefunc *freefunc)
{
	tree->root = NULL;
	tree->compfunc = compfunc;
	tree->freefunc = freefunc;
}


/* ----
 * avl_reset() -
 *
 *	Reset an AVL tree to empty. This will call the user defined
 *	free function for all elements in the tree, destroy all nodes
 *	and declare the tree empty again.
 * ----
 */
void
avl_reset(AVLtree *tree)
{
	avl_reset_node(tree->root, tree->freefunc);
	tree->root = NULL;
}


/* ----
 * avl_reset_node() - 
 *
 *	avl_reset()'s workhorse.
 * ----
 */
void
avl_reset_node(AVLnode *node, AVLfreefunc *freefunc)
{
	if (node == NULL)
		return;
	
	avl_reset_node(node->lnode, freefunc);
	avl_reset_node(node->rnode, freefunc);

	if (freefunc != NULL)
		freefunc(node->cdata);
	free(node);
}


/* ----
 * avl_insert() -
 *
 *	Insert an element into an AVL tree. On return AVL_DATA(node) might
 *	point to an existing entry with the same key. If the caller replaces
 *	the entry, it must free the existing one since AVL will no longer
 *	keep track of it.
 * ----
 */
AVLnode *
avl_insert(AVLtree *tree, void *cdata)
{
	AVLnode	   *result;
	int			depth;

	/*
	 * If this is an empty tree, create the root node.
	 */
	if (tree->root == NULL)
		return (tree->root = avl_makenode());

	/*
	 * Traverse the tree to find the insert point.
	 */
	result = NULL;
	depth = avl_insertinto(tree, &(tree->root), cdata, &result);
	return result;
}


/* ----
 * avl_lookup() -
 *
 *	Search for an existing key in the tree.
 * ----
 */
AVLnode *
avl_lookup(AVLtree *tree, void *cdata)
{
	AVLnode	   *node;
	int			cmp;

	node = tree->root;
	while (node != NULL)
	{
		cmp = tree->compfunc(cdata, node->cdata);
		if (cmp == 0)
		{
			/*
			 * Found the node. If it is marked deleted, return NULL
			 * anyway. Otherwise return this node.
			 */
			if (node->deleted)
				return NULL;
			return node;
		}

		/*
		 * Search on ...
		 */
		if (cmp < 0)
			node = node->lnode;
		else
			node = node->rnode;
	}

	/*
	 * No such element found
	 */
	return NULL;
}


/* ----
 * avl_delete() -
 *
 *	Mark a given element as deleted. Subsequent lookups for the element
 *	will return NULL. Note that the caller should NOT free the memory
 *	of the element, as it is AVL's property altogether after the delete.
 *
 *	avl_delete() returns 1 on success, 0 if no such element was found.
 * ----
 */
int
avl_delete(AVLtree *tree, void *cdata)
{
	AVLnode	   *node;

	if ((node = avl_lookup(tree, cdata)) == NULL)
		return 0;

	node->deleted = 1;
	return 1;
}


/* ----
 * avl_insertinto() -
 *
 *	The heart of avl_insert().
 * ----
 */
static	int
avl_insertinto(AVLtree *tree, AVLnode **node,
				void *cdata, AVLnode **result)
{
	int		cmp;

	/*
	 * Compare the node at hand with the new elements key.
	 */
	cmp = (tree->compfunc)(cdata, (*node)->cdata);

	if (cmp > 0)
	{
		/*
		 * New element is > than node. Insert to the right.
		 */
		if ((*node)->rnode == NULL)
		{
			/* 
			 * Right side of current node is empty. Create a new node
			 * there and return new maximum depth. Note that this can
			 * only be 1 because otherwise this node would have been
			 * unbalanced before.
			 */
			(*node)->rnode = *result = avl_makenode();
			(*node)->rdepth = 1;
			return 1;
		}

		/*
		 * Right hand node exists. Recurse into that and remember the
		 * new right hand side depth.
		 */
		(*node)->rdepth = avl_insertinto(tree, &((*node)->rnode), 
						cdata, result) + 1;

		/*
		 * A right hand side insert can unbalance this node only to the
		 * right. 
		 */
		if (AVL_BALANCE(*node) > 1)
		{
			if (AVL_BALANCE((*node)->rnode) > 0)
			{
				/*
				 * RR situation, rebalance the tree by left rotating
				 * this node.
				 */
				avl_rotate_left(node);
			}
			else
			{
				/*
				 * RL situation, rebalance the tree by first right
				 * rotating the right hand side, then left rotating
				 * this node.
				 */
				avl_rotate_right(&((*node)->rnode));
				avl_rotate_left(node);
			}
		}

		return AVL_MAXDEPTH(*node);
	}
	else if (cmp < 0)
	{
		/*
		 * New element is < than node. Insert to the left.
		 */
		if ((*node)->lnode == NULL)
		{
			/* 
			 * Left side of current node is empty. Create a new node
			 * there and return new maximum depth. Note that this can
			 * only be 1 because otherwise this node would have been
			 * unbalanced before.
			 */
			(*node)->lnode = *result = avl_makenode();
			(*node)->ldepth = 1;
			return AVL_MAXDEPTH(*node);
		}

		/*
		 * Left hand node exists. Recurse into that and remember the
		 * new left hand side depth.
		 */
		(*node)->ldepth = avl_insertinto(tree, &((*node)->lnode), 
						cdata, result) + 1;

		/*
		 * A left hand side insert can unbalance this node only to the
		 * left. 
		 */
		if (AVL_BALANCE(*node) < -1)
		{
			if (AVL_BALANCE((*node)->lnode) < 0)
			{
				/*
				 * LL situation, rebalance the tree by right rotating
				 * this node.
				 */
				avl_rotate_right(node);
			}
			else
			{
				/*
				 * LR situation, rebalance the tree by first left rotating
				 * the left node, then right rotating this node.
				 */
				avl_rotate_left(&((*node)->lnode));
				avl_rotate_right(node);
			}
		}

		return AVL_MAXDEPTH(*node);
	}
	else {
		/*
		 * The new element is equal to this node. If it is marked
		 * for deletion, free the user element data now. The caller
		 * is supposed to replace it with a new element having the
		 * the key.
		 */
		if ((*node)->deleted && tree->freefunc != NULL)
		{
			(tree->freefunc)((*node)->cdata);
			(*node)->cdata = NULL;
			(*node)->deleted = 0;
		}
		*result = *node;
		return AVL_MAXDEPTH(*node);
	}
}


/* ----
 * avl_makenode() -
 *
 *	Create a new empty node.
 * ----
 */
static	AVLnode *
avl_makenode(void)
{
	AVLnode	   *new;

	new = (AVLnode *)malloc(sizeof(AVLnode));
	memset(new, 0, sizeof(AVLnode));

	return new;
}


/* ----
 * avl_rotate_left() -
 *
 *	Rebalance a node to the left.
 * ----
 */
static void
avl_rotate_left(AVLnode **node)
{
	AVLnode	   *rtmp;

	/*
	 * save right node
	 */
	rtmp = (*node)->rnode;

	/*
	 * move right nodes left side to this nodes right
	 */
	(*node)->rnode = rtmp->lnode;
	if (rtmp->lnode != NULL)
		(*node)->rdepth = AVL_MAXDEPTH(rtmp->lnode) + 1;
	else
		(*node)->rdepth = 0;

	/*
	 * Move this node to right nodes left side
	 */
	rtmp->lnode = *node;
	rtmp->ldepth = AVL_MAXDEPTH(*node) + 1;

	/*
	 * Let parent point to right node
	 */
	*node = rtmp;
}


/* ----
 * avl_rotate_right() -
 *
 *	Rebalance a node to the right.
 * ----
 */
static void
avl_rotate_right(AVLnode **node)
{
	AVLnode	   *ltmp;

	/*
	 * save left node
	 */
	ltmp = (*node)->lnode;

	/*
	 * move left nodes right side to this nodes left
	 */
	(*node)->lnode = ltmp->rnode;
	if (ltmp->rnode != NULL)
		(*node)->ldepth = AVL_MAXDEPTH(ltmp->rnode) + 1;
	else
		(*node)->ldepth = 0;

	/*
	 * Move this node to left nodes right side
	 */
	ltmp->rnode = *node;
	ltmp->rdepth = AVL_MAXDEPTH(*node) + 1;

	/*
	 * Let parent point to left node
	 */
	*node = ltmp;
}



--- NEW FILE: avl_tree.h ---
/* ----------------------------------------------------------------------
 * avl_tree.h
 *
 *	Declarations for AVL style balanced tree support.
 *
 *  Copyright (c) 2003-2007, PostgreSQL Global Development Group
 *  Author: Jan Wieck, Afilias USA INC.
 *
 *  $Id: avl_tree.h,v 1.1 2007-06-07 13:01:10 wieck Exp $
 * ----------------------------------------------------------------------
 */

#ifndef _AVL_TREE_H_INCLUDED_
#define _AVL_TREE_H_INCLUDED_

/* ----
 * Callback function type declarations
 * ----
 */
typedef int  (AVLcompfunc) (void *, void *);
typedef void (AVLfreefunc) (void *);


/* ----
 * Data structures
 * ----
 */
typedef struct AVLnode_s {
	struct AVLnode_s   *lnode, *rnode;
	int					ldepth, rdepth;
	void			   *cdata;
	int					deleted;
} AVLnode;

typedef struct AVLtree_s {
	AVLnode		   *root;
	AVLcompfunc	   *compfunc;
	AVLfreefunc	   *freefunc;
} AVLtree;

/* ----
 * Macros
 * ----
 */
#define		AVL_DATA(n)		(n)->cdata
#define		AVL_SETDATA(n,p) ((n)->cdata = (p))
#define		AVL_MAXDEPTH(n)	(((n)->ldepth > (n)->rdepth) ? (n)->ldepth : (n)->rdepth)
#define		AVL_BALANCE(n)	((n)->rdepth - (n)->ldepth)

#define		AVL_INITIALIZER(cmp,free) {NULL, (cmp), (free)}


/* ----
 * Public functions
 * ----
 */
void		avl_init(AVLtree *tree, AVLcompfunc *compfunc,
					AVLfreefunc *freefunc);
void		avl_reset(AVLtree *tree);
AVLnode	   *avl_insert(AVLtree *tree, void *cdata);
AVLnode	   *avl_lookup(AVLtree *tree, void *cdata);
int			avl_delete(AVLtree *tree, void *cdata);

#endif /* _AVL_TREE_H_INCLUDED_ */

From wieck at lists.slony.info  Thu Jun  7 06:01:12 2007
From: wieck at lists.slony.info (Jan Wieck)
Date: Thu Jun  7 06:01:15 2007
Subject: [Slony1-commit] slony1-engine/src/backend Makefile slony1_funcs.c
	slony1_funcs.sql
Message-ID: <20070607130113.1D3D72902B3@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/backend
In directory main.slony.info:/tmp/cvs-serv25549/src/backend

Modified Files:
	Makefile slony1_funcs.c slony1_funcs.sql 
Log Message:
Attempt to remove the sl_seqlog flood.

This patch adds a new function seqtrack(seqid,seqvalue) that will return
NULL if called with the same seqvalue before, the seqvalue instead. This
function is used to suppress sl_seqlog rows of sequences that didn't change
since the last SYNC. 

Jan


Index: slony1_funcs.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/backend/slony1_funcs.c,v
retrieving revision 1.61
retrieving revision 1.62
diff -C2 -d -r1.61 -r1.62
*** slony1_funcs.c	31 May 2007 16:46:18 -0000	1.61
--- slony1_funcs.c	7 Jun 2007 13:01:10 -0000	1.62
***************
*** 14,17 ****
--- 14,19 ----
  #include "config.h"
  
+ #include "avl_tree.c"
+ 
  #include "miscadmin.h"
  #include "nodes/makefuncs.h"
***************
*** 52,55 ****
--- 54,58 ----
  PG_FUNCTION_INFO_V1(_Slony_I_lockedSet);
  PG_FUNCTION_INFO_V1(_Slony_I_killBackend);
+ PG_FUNCTION_INFO_V1(_Slony_I_seqtrack);
  
  PG_FUNCTION_INFO_V1(_slon_quote_ident);
***************
*** 64,67 ****
--- 67,71 ----
  Datum		_Slony_I_lockedSet(PG_FUNCTION_ARGS);
  Datum		_Slony_I_killBackend(PG_FUNCTION_ARGS);
+ Datum		_Slony_I_seqtrack(PG_FUNCTION_ARGS);
  
  Datum		_slon_quote_ident(PG_FUNCTION_ARGS);
***************
*** 76,84 ****
  #define PLAN_INSERT_LOG		(1 << 2)
  
- #define SLON_ROLE_UNSET		0
- #define SLON_ROLE_NORMAL	1
- #define SLON_ROLE_SLON		2
- 
- 
  
  /* ----
--- 80,83 ----
***************
*** 960,963 ****
--- 959,1026 ----
  
  
+ typedef struct {
+ 	int32	seqid;
+ 	int64	seqval;
+ } SeqTrack_elem;
+ 
+ static int
+ seqtrack_cmp(void *seq1, void *seq2)
+ {
+ 	return (((SeqTrack_elem *)seq1)->seqid - ((SeqTrack_elem *)seq2)->seqid);
+ }
+ 
+ static void 
+ seqtrack_free(void *seq)
+ {
+ 	free(seq);
+ }
+ 
+ Datum
+ _Slony_I_seqtrack(PG_FUNCTION_ARGS)
+ {
+ 	static AVLtree seqmem = AVL_INITIALIZER(seqtrack_cmp, seqtrack_free);
+ 	AVLnode		   *node;
+ 	SeqTrack_elem  *elem;
+ 	int32			seqid;
+ 	int64			seqval;
+ 
+ 	seqid = PG_GETARG_INT32(0);
+ 	seqval = PG_GETARG_INT64(1);
+ 
+ 	/*
+ 	 * Try to insert the sequence id into the AVL tree.
+ 	 */
+ 	if ((node = avl_insert(&seqmem, &seqid)) == NULL)
+ 		elog(ERROR, "Slony-I: unexpected NULL return from avl_insert()");
+ 
+ 	if (AVL_DATA(node) == NULL)
+ 	{
+ 		/*
+ 		 * This is a new (not seen before) sequence. Create the element,
+ 		 * remember the current lastval and return it to the caller.
+ 		 */
+ 		elem = (SeqTrack_elem *)malloc(sizeof(SeqTrack_elem));
+ 		elem->seqid = seqid;
+ 		elem->seqval = seqval;
+ 		AVL_SETDATA(node, elem);
+ 
+ 		PG_RETURN_INT64(seqval);
+ 	}
+ 
+ 	/*
+ 	 * This is a sequence seen before. If the value has changed
+ 	 * remember and return it. If it did not, return NULL.
+ 	 */
+ 	elem = AVL_DATA(node);
+ 
+ 	if (elem->seqval == seqval)
+ 		PG_RETURN_NULL();
+ 	else
+ 		elem->seqval = seqval;
+ 
+ 	PG_RETURN_INT64(seqval);
+ }
+ 
+ 
  static char *
  slon_quote_literal(char *str)
***************
*** 1278,1291 ****
  			"insert into %s.sl_seqlog "
  			"(seql_seqid, seql_origin, seql_ev_seqno, seql_last_value) "
! 			"select seq_id, '%d', currval('%s.sl_event_seq'), seq_last_value "
  			"from %s.sl_seqlastvalue "
! 			"where seq_origin = '%d'; "
! 			"insert into %s.sl_seqlog "
! 			"(seql_seqid, seql_origin, seql_ev_seqno) "
! 			"select '0', '%d', currval('%s.sl_event_seq'); ",
  			cs->clusterident,
  			cs->localNodeId, cs->clusterident,
  			cs->clusterident, cs->localNodeId,
- 			cs->clusterident, cs->localNodeId,
  			cs->clusterident);
  
--- 1341,1352 ----
  			"insert into %s.sl_seqlog "
  			"(seql_seqid, seql_origin, seql_ev_seqno, seql_last_value) "
! 			"select * from ("
! 			"select seq_id, %d, currval('%s.sl_event_seq'), seq_last_value "
  			"from %s.sl_seqlastvalue "
! 			"where seq_origin = '%d') as FOO "
! 			"where NOT %s.seqtrack(seq_id, seq_last_value) IS NULL; ",
  			cs->clusterident,
  			cs->localNodeId, cs->clusterident,
  			cs->clusterident, cs->localNodeId,
  			cs->clusterident);
  

Index: Makefile
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/backend/Makefile,v
retrieving revision 1.25
retrieving revision 1.26
diff -C2 -d -r1.25 -r1.26
*** Makefile	31 May 2007 16:46:18 -0000	1.25
--- Makefile	7 Jun 2007 13:01:10 -0000	1.26
***************
*** 42,47 ****
  $(SO_NAME):	$(SO_OBJS)
  
  clean distclean maintainer-clean:
! 	rm -f $(SO_NAME) $(SO_OBJS)
  
  splint:
--- 42,55 ----
  $(SO_NAME):	$(SO_OBJS)
  
+ $(NAME).o:	$(NAME).c avl_tree.c avl_tree.h
+ 
+ avl_tree.c:	../misc/avl_tree.c
+ 	cp $< $@
+ 
+ avl_tree.h:	../misc/avl_tree.h
+ 	cp $< $@
+ 
  clean distclean maintainer-clean:
! 	rm -f $(SO_NAME) $(SO_OBJS) avl_tree.c avl_tree.h
  
  splint:

Index: slony1_funcs.sql
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/backend/slony1_funcs.sql,v
retrieving revision 1.110
retrieving revision 1.111
diff -C2 -d -r1.110 -r1.111
*** slony1_funcs.sql	31 May 2007 17:44:02 -0000	1.110
--- slony1_funcs.sql	7 Jun 2007 13:01:10 -0000	1.111
***************
*** 256,259 ****
--- 256,271 ----
  
  -- ----------------------------------------------------------------------
+ -- FUNCTION seqtrack (seqid, seqval)
+ --
+ --	
+ -- ----------------------------------------------------------------------
+ create or replace function @NAMESPACE@.seqtrack (int4, int8) returns int8
+     as '$libdir/slony1_funcs', '_Slony_I_seqtrack'
+ 	strict language C;
+ 
+ comment on function @NAMESPACE@.seqtrack(int4, int8) is
+   'Returns NULL if seqval has not changed since the last call for seqid';
+ 
+ -- ----------------------------------------------------------------------
  -- FUNCTION slon_quote_brute(text)
  --

From cbbrowne at lists.slony.info  Thu Jun  7 09:03:27 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Thu Jun  7 09:03:28 2007
Subject: [Slony1-commit] slony1-engine RELEASE-2.0
Message-ID: <20070607160327.50DF22903FE@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine
In directory main.slony.info:/tmp/cvs-serv9348

Added Files:
	RELEASE-2.0 
Log Message:
Add in release notes for v2.0, with comments pulled from various of
Jan's CVS commits of late to HEAD.

The "short answer" on this is that v2.0 drops support for PG versions
elder than 8.3; by virtue of this, it does not need to do any "catalog
trickery" of gross sorts, so that pg_dump works fine on subscribers.


--- NEW FILE: RELEASE-2.0 ---
$Id: RELEASE-2.0,v 1.1 2007-06-07 16:03:25 cbbrowne Exp $

Differences from 1.2 stream

- Removal of TABLE ADD KEY

- It drops all support for databases prior to Postgres version 8.3.

This is required because we now make use of new functionality in
Postgres, namely the trigger and rule support for session replication
role. As of now, every node (origin/subscriber/mixed) can be dumped with
pg_dump and result in a consistent snapshot of the database.

- Still need alterTableRestore() for the upgrade from 1.2.x to 2.0.
upgradeSchema() will restore the system catalog to a consistent
state and define+configure the new versions of the log and deny_access
triggers. 

- Fix EXECUTE SCRIPT so that it records the ev_seqno for WAIT FOR EVENT
and make sure all DDL is executed in session_replication_role "local"
on the origin as well as all subscribers. This will cause the slony
triggers to ignore all DML statements while user triggers follow the
regular configuration options for ENABLE [REPLICA/ALWAYS] or DISABLE.

- Let the logshipping files also switch to session_replication_role =
"replica" or "local" (for DDL).

From cbbrowne at lists.slony.info  Thu Jun  7 09:06:37 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Thu Jun  7 09:06:38 2007
Subject: [Slony1-commit] slony1-engine RELEASE-2.0
Message-ID: <20070607160637.BA8D22903A4@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine
In directory main.slony.info:/tmp/cvs-serv9396

Modified Files:
	RELEASE-2.0 
Log Message:
Sequence tracking made cheaper


Index: RELEASE-2.0
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/RELEASE-2.0,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** RELEASE-2.0	7 Jun 2007 16:03:25 -0000	1.1
--- RELEASE-2.0	7 Jun 2007 16:06:35 -0000	1.2
***************
*** 25,26 ****
--- 25,33 ----
  - Let the logshipping files also switch to session_replication_role =
  "replica" or "local" (for DDL).
+ 
+ - Sequence tracking becomes enormously less expensive; rather than
+ polling *ALL* sequence values for each and every SYNC, the slon
+ stores the last value, and only records entries in sl_seqlog when
+ the value changes from that last value.  If most sequences are
+ relatively inactive, they won't require entries in sl_seqlog very
+ often.

From wieck at lists.slony.info  Thu Jun  7 12:36:16 2007
From: wieck at lists.slony.info (Jan Wieck)
Date: Thu Jun  7 12:36:17 2007
Subject: [Slony1-commit] slony1-engine/src/slonik slonik.c
Message-ID: <20070607193616.4052F290436@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slonik
In directory main.slony.info:/tmp/cvs-serv10960/src/slonik

Modified Files:
      Tag: REL_1_2_STABLE
	slonik.c 
Log Message:
Removed the warnind about "possible unsupported Postgres Version"
for 8.3. I think this is "supposed" to be a supported version now.

Jan


Index: slonik.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slonik/slonik.c,v
retrieving revision 1.67.2.10
retrieving revision 1.67.2.11
diff -C2 -d -r1.67.2.10 -r1.67.2.11
*** slonik.c	4 Jun 2007 22:51:19 -0000	1.67.2.10
--- slonik.c	7 Jun 2007 19:36:14 -0000	1.67.2.11
***************
*** 1887,1891 ****
  		use_minor = 0;
  	}
! 	else if ((adminfo->pg_version >= 80100) && adminfo->pg_version < 80300)	/* 8.1 and 8.2 */
  	{
  		use_major = 8;
--- 1887,1891 ----
  		use_minor = 0;
  	}
! 	else if ((adminfo->pg_version >= 80100) && adminfo->pg_version < 80400)	/* 8.1, 8.2 and 8.3 */
  	{
  		use_major = 8;

From wieck at lists.slony.info  Thu Jun  7 15:40:25 2007
From: wieck at lists.slony.info (Jan Wieck)
Date: Thu Jun  7 15:40:27 2007
Subject: [Slony1-commit] slony1-engine/src/backend slony1_funcs.sql
Message-ID: <20070607224025.3380B290BF3@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/backend
In directory main.slony.info:/tmp/cvs-serv12347

Modified Files:
	slony1_funcs.sql 
Log Message:
Adjust Slony-I functions to the more restricted casting to text
that was recently introduced.

Jan


Index: slony1_funcs.sql
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/backend/slony1_funcs.sql,v
retrieving revision 1.111
retrieving revision 1.112
diff -C2 -d -r1.111 -r1.112
*** slony1_funcs.sql	7 Jun 2007 13:01:10 -0000	1.111
--- slony1_funcs.sql	7 Jun 2007 22:40:23 -0000	1.112
***************
*** 729,733 ****
  	perform @NAMESPACE@.storeNode_int (p_no_id, p_no_comment, p_no_spool);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''STORE_NODE'',
! 									p_no_id, p_no_comment, v_no_spool_txt);
  end;
  ' language plpgsql
--- 729,734 ----
  	perform @NAMESPACE@.storeNode_int (p_no_id, p_no_comment, p_no_spool);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''STORE_NODE'',
! 									p_no_id::text, p_no_comment::text, 
! 									v_no_spool_txt::text);
  end;
  ' language plpgsql
***************
*** 835,839 ****
  	perform @NAMESPACE@.enableNode_int (p_no_id);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''ENABLE_NODE'',
! 									p_no_id);
  end;
  ' language plpgsql;
--- 836,840 ----
  	perform @NAMESPACE@.enableNode_int (p_no_id);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''ENABLE_NODE'',
! 									p_no_id::text);
  end;
  ' language plpgsql;
***************
*** 1015,1019 ****
  	perform @NAMESPACE@.dropNode_int(p_no_id);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''DROP_NODE'',
! 									p_no_id);
  end;
  ' language plpgsql;
--- 1016,1020 ----
  	perform @NAMESPACE@.dropNode_int(p_no_id);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''DROP_NODE'',
! 									p_no_id::text);
  end;
  ' language plpgsql;
***************
*** 1477,1481 ****
  			p_pa_conninfo, p_pa_connretry);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''STORE_PATH'', 
! 			p_pa_server, p_pa_client, p_pa_conninfo, p_pa_connretry);
  end;
  ' language plpgsql;
--- 1478,1483 ----
  			p_pa_conninfo, p_pa_connretry);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''STORE_PATH'', 
! 			p_pa_server::text, p_pa_client::text, 
! 			p_pa_conninfo::text, p_pa_connretry::text);
  end;
  ' language plpgsql;
***************
*** 1611,1615 ****
  
  	return  @NAMESPACE@.createEvent (''_@CLUSTERNAME@'', ''DROP_PATH'',
! 			p_pa_server, p_pa_client);
  end;
  ' language plpgsql;
--- 1613,1617 ----
  
  	return  @NAMESPACE@.createEvent (''_@CLUSTERNAME@'', ''DROP_PATH'',
! 			p_pa_server::text, p_pa_client::text);
  end;
  ' language plpgsql;
***************
*** 1680,1684 ****
  	perform @NAMESPACE@.storeListen_int (p_origin, p_provider, p_receiver);
  	return  @NAMESPACE@.createEvent (''_@CLUSTERNAME@'', ''STORE_LISTEN'',
! 			p_origin, p_provider, p_receiver);
  end;
  ' language plpgsql
--- 1682,1686 ----
  	perform @NAMESPACE@.storeListen_int (p_origin, p_provider, p_receiver);
  	return  @NAMESPACE@.createEvent (''_@CLUSTERNAME@'', ''STORE_LISTEN'',
! 			p_origin::text, p_provider::text, p_receiver::text);
  end;
  ' language plpgsql
***************
*** 1769,1773 ****
  	
  	return  @NAMESPACE@.createEvent (''_@CLUSTERNAME@'', ''DROP_LISTEN'',
! 			p_li_origin, p_li_provider, p_li_receiver);
  end;
  ' language plpgsql;
--- 1771,1775 ----
  	
  	return  @NAMESPACE@.createEvent (''_@CLUSTERNAME@'', ''DROP_LISTEN'',
! 			p_li_origin::text, p_li_provider::text, p_li_receiver::text);
  end;
  ' language plpgsql;
***************
*** 1839,1843 ****
  
  	return @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''STORE_SET'', 
! 			p_set_id, v_local_node_id, p_set_comment);
  end;
  ' language plpgsql;
--- 1841,1845 ----
  
  	return @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''STORE_SET'', 
! 			p_set_id::text, v_local_node_id::text, p_set_comment::text);
  end;
  ' language plpgsql;
***************
*** 2128,2132 ****
  	-- ----
  	return @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''MOVE_SET'', 
! 			p_set_id, v_local_node_id, p_new_origin);
  end;
  ' language plpgsql;
--- 2130,2134 ----
  	-- ----
  	return @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''MOVE_SET'', 
! 			p_set_id::text, v_local_node_id::text, p_new_origin::text);
  end;
  ' language plpgsql;
***************
*** 2175,2179 ****
  		perform @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''SYNC'', NULL);
  		perform @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''ACCEPT_SET'', 
! 			p_set_id, p_old_origin, p_new_origin, p_wait_seqno);
  	end if;
  
--- 2177,2182 ----
  		perform @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''SYNC'', NULL);
  		perform @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''ACCEPT_SET'', 
! 			p_set_id::text, p_old_origin::text, 
! 			p_new_origin::text, p_wait_seqno::text);
  	end if;
  
***************
*** 2358,2362 ****
  	perform @NAMESPACE@.dropSet_int(p_set_id);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''DROP_SET'', 
! 			p_set_id);
  end;
  ' language plpgsql;
--- 2361,2365 ----
  	perform @NAMESPACE@.dropSet_int(p_set_id);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''DROP_SET'', 
! 			p_set_id::text);
  end;
  ' language plpgsql;
***************
*** 2507,2511 ****
  	perform @NAMESPACE@.mergeSet_int(p_set_id, p_add_id);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''MERGE_SET'', 
! 			p_set_id, p_add_id);
  end;
  ' language plpgsql;
--- 2510,2514 ----
  	perform @NAMESPACE@.mergeSet_int(p_set_id, p_add_id);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''MERGE_SET'', 
! 			p_set_id::text, p_add_id::text);
  end;
  ' language plpgsql;
***************
*** 2599,2604 ****
  			p_tab_idxname, p_tab_comment);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''SET_ADD_TABLE'',
! 			p_set_id, p_tab_id, p_fqname,
! 			p_tab_idxname, p_tab_comment);
  end;
  ' language plpgsql;
--- 2602,2607 ----
  			p_tab_idxname, p_tab_comment);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''SET_ADD_TABLE'',
! 			p_set_id::text, p_tab_id::text, p_fqname::text,
! 			p_tab_idxname::text, p_tab_comment::text);
  end;
  ' language plpgsql;
***************
*** 2784,2788 ****
  	-- ----
  	perform @NAMESPACE@.setDropTable_int(p_tab_id);
! 	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''SET_DROP_TABLE'', p_tab_id);
  end;
  ' language plpgsql;
--- 2787,2792 ----
  	-- ----
  	perform @NAMESPACE@.setDropTable_int(p_tab_id);
! 	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''SET_DROP_TABLE'', 
! 				p_tab_id::text);
  end;
  ' language plpgsql;
***************
*** 2906,2910 ****
  			p_seq_comment);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''SET_ADD_SEQUENCE'',
! 			p_set_id, p_seq_id, p_fqname, p_seq_comment);
  end;
  ' language plpgsql;
--- 2910,2915 ----
  			p_seq_comment);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''SET_ADD_SEQUENCE'',
! 						p_set_id::text, p_seq_id::text, 
! 						p_fqname::text, p_seq_comment::text);
  end;
  ' language plpgsql;
***************
*** 3070,3074 ****
  	perform @NAMESPACE@.setDropSequence_int(p_seq_id);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''SET_DROP_SEQUENCE'',
! 			p_seq_id);
  end;
  ' language plpgsql;
--- 3075,3079 ----
  	perform @NAMESPACE@.setDropSequence_int(p_seq_id);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''SET_DROP_SEQUENCE'',
! 					p_seq_id::text);
  end;
  ' language plpgsql;
***************
*** 3235,3239 ****
  	perform @NAMESPACE@.setMoveTable_int(p_tab_id, p_new_set_id);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''SET_MOVE_TABLE'', 
! 			p_tab_id, p_new_set_id);
  end;
  ' language plpgsql;
--- 3240,3244 ----
  	perform @NAMESPACE@.setMoveTable_int(p_tab_id, p_new_set_id);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''SET_MOVE_TABLE'', 
! 			p_tab_id::text, p_new_set_id::text);
  end;
  ' language plpgsql;
***************
*** 3358,3362 ****
  	perform @NAMESPACE@.setMoveSequence_int(p_seq_id, p_new_set_id);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''SET_MOVE_SEQUENCE'', 
! 			p_seq_id, p_new_set_id);
  end;
  ' language plpgsql;
--- 3363,3367 ----
  	perform @NAMESPACE@.setMoveSequence_int(p_seq_id, p_new_set_id);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''SET_MOVE_SEQUENCE'', 
! 			p_seq_id::text, p_new_set_id::text);
  end;
  ' language plpgsql;
***************
*** 3457,3461 ****
  	perform @NAMESPACE@.storeTrigger_int(p_trig_tabid, p_trig_tgname);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''STORE_TRIGGER'',
! 			p_trig_tabid, p_trig_tgname);
  end;
  ' language plpgsql;
--- 3462,3466 ----
  	perform @NAMESPACE@.storeTrigger_int(p_trig_tabid, p_trig_tgname);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''STORE_TRIGGER'',
! 			p_trig_tabid::text, p_trig_tgname::text);
  end;
  ' language plpgsql;
***************
*** 3528,3532 ****
  	perform @NAMESPACE@.dropTrigger_int(p_trig_tabid, p_trig_tgname);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''DROP_TRIGGER'',
! 			p_trig_tabid, p_trig_tgname);
  end;
  ' language plpgsql;
--- 3533,3537 ----
  	perform @NAMESPACE@.dropTrigger_int(p_trig_tabid, p_trig_tgname);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''DROP_TRIGGER'',
! 			p_trig_tabid::text, p_trig_tgname::text);
  end;
  ' language plpgsql;
***************
*** 3647,3651 ****
  	if p_only_on_node = -1 then
  		return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''DDL_SCRIPT'', 
! 			p_set_id, p_script, p_only_on_node);
  	end if;
  	return NULL;
--- 3652,3656 ----
  	if p_only_on_node = -1 then
  		return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''DDL_SCRIPT'', 
! 			p_set_id::text, p_script::text, p_only_on_node::text);
  	end if;
  	return NULL;
***************
*** 4145,4149 ****
  	-- ----
  	v_ev_seqno :=  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''SUBSCRIBE_SET'', 
! 			p_sub_set, p_sub_provider, p_sub_receiver, 
  			case p_sub_forward when true then ''t'' else ''f'' end);
  
--- 4150,4154 ----
  	-- ----
  	v_ev_seqno :=  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''SUBSCRIBE_SET'', 
! 			p_sub_set::text, p_sub_provider::text, p_sub_receiver::text, 
  			case p_sub_forward when true then ''t'' else ''f'' end);
  
***************
*** 4244,4248 ****
  	if v_set_origin = @NAMESPACE@.getLocalNodeId(''_@CLUSTERNAME@'') then
  		perform @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''ENABLE_SUBSCRIPTION'', 
! 				p_sub_set, p_sub_provider, p_sub_receiver, 
  				case p_sub_forward when true then ''t'' else ''f'' end);
  		perform @NAMESPACE@.enableSubscription(p_sub_set, 
--- 4249,4253 ----
  	if v_set_origin = @NAMESPACE@.getLocalNodeId(''_@CLUSTERNAME@'') then
  		perform @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''ENABLE_SUBSCRIPTION'', 
! 				p_sub_set::text, p_sub_provider::text, p_sub_receiver::text, 
  				case p_sub_forward when true then ''t'' else ''f'' end);
  		perform @NAMESPACE@.enableSubscription(p_sub_set, 
***************
*** 4339,4343 ****
  	-- ----
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''UNSUBSCRIBE_SET'', 
! 			p_sub_set, p_sub_receiver);
  end;
  ' language plpgsql;
--- 4344,4348 ----
  	-- ----
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''UNSUBSCRIBE_SET'', 
! 			p_sub_set::text, p_sub_receiver::text);
  end;
  ' language plpgsql;
***************
*** 5059,5063 ****
  
          return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''RESET_CONFIG'',
!                         p_set_id, p_only_on_node);
  end;
  ' language plpgsql;
--- 5064,5068 ----
  
          return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''RESET_CONFIG'',
!                         p_set_id::text, p_only_on_node::text);
  end;
  ' language plpgsql;

From wieck at lists.slony.info  Thu Jun  7 17:08:05 2007
From: wieck at lists.slony.info (Jan Wieck)
Date: Thu Jun  7 17:08:07 2007
Subject: [Slony1-commit] slony1-engine/src/backend slony1_funcs.sql
Message-ID: <20070608000805.2F26D2903FE@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/backend
In directory main.slony.info:/tmp/cvs-serv13073/src/backend

Modified Files:
      Tag: REL_1_2_STABLE
	slony1_funcs.sql 
Log Message:
Backpatch the fixes for the restricted text casts in 8.3. Tested against
8.3 and 8.2 ... need much more tests before we can release 1.2.10.

Jan


Index: slony1_funcs.sql
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/backend/slony1_funcs.sql,v
retrieving revision 1.98.2.16
retrieving revision 1.98.2.17
diff -C2 -d -r1.98.2.16 -r1.98.2.17
*** slony1_funcs.sql	6 Jun 2007 22:23:16 -0000	1.98.2.16
--- slony1_funcs.sql	8 Jun 2007 00:08:03 -0000	1.98.2.17
***************
*** 754,758 ****
  	perform @NAMESPACE@.storeNode_int (p_no_id, p_no_comment, p_no_spool);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''STORE_NODE'',
! 									p_no_id, p_no_comment, v_no_spool_txt);
  end;
  ' language plpgsql
--- 754,759 ----
  	perform @NAMESPACE@.storeNode_int (p_no_id, p_no_comment, p_no_spool);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''STORE_NODE'',
! 									p_no_id::text, p_no_comment::text, 
! 									v_no_spool_txt::text);
  end;
  ' language plpgsql
***************
*** 860,864 ****
  	perform @NAMESPACE@.enableNode_int (p_no_id);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''ENABLE_NODE'',
! 									p_no_id);
  end;
  ' language plpgsql;
--- 861,865 ----
  	perform @NAMESPACE@.enableNode_int (p_no_id);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''ENABLE_NODE'',
! 									p_no_id::text);
  end;
  ' language plpgsql;
***************
*** 1040,1044 ****
  	perform @NAMESPACE@.dropNode_int(p_no_id);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''DROP_NODE'',
! 									p_no_id);
  end;
  ' language plpgsql;
--- 1041,1045 ----
  	perform @NAMESPACE@.dropNode_int(p_no_id);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''DROP_NODE'',
! 									p_no_id::text);
  end;
  ' language plpgsql;
***************
*** 1515,1519 ****
  			p_pa_conninfo, p_pa_connretry);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''STORE_PATH'', 
! 			p_pa_server, p_pa_client, p_pa_conninfo, p_pa_connretry);
  end;
  ' language plpgsql;
--- 1516,1521 ----
  			p_pa_conninfo, p_pa_connretry);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''STORE_PATH'', 
! 			p_pa_server::text, p_pa_client::text, 
! 			p_pa_conninfo::text, p_pa_connretry::text);
  end;
  ' language plpgsql;
***************
*** 1649,1653 ****
  
  	return  @NAMESPACE@.createEvent (''_@CLUSTERNAME@'', ''DROP_PATH'',
! 			p_pa_server, p_pa_client);
  end;
  ' language plpgsql;
--- 1651,1655 ----
  
  	return  @NAMESPACE@.createEvent (''_@CLUSTERNAME@'', ''DROP_PATH'',
! 			p_pa_server::text, p_pa_client::text);
  end;
  ' language plpgsql;
***************
*** 1718,1722 ****
  	perform @NAMESPACE@.storeListen_int (p_origin, p_provider, p_receiver);
  	return  @NAMESPACE@.createEvent (''_@CLUSTERNAME@'', ''STORE_LISTEN'',
! 			p_origin, p_provider, p_receiver);
  end;
  ' language plpgsql
--- 1720,1724 ----
  	perform @NAMESPACE@.storeListen_int (p_origin, p_provider, p_receiver);
  	return  @NAMESPACE@.createEvent (''_@CLUSTERNAME@'', ''STORE_LISTEN'',
! 			p_origin::text, p_provider::text, p_receiver::text);
  end;
  ' language plpgsql
***************
*** 1807,1811 ****
  	
  	return  @NAMESPACE@.createEvent (''_@CLUSTERNAME@'', ''DROP_LISTEN'',
! 			p_li_origin, p_li_provider, p_li_receiver);
  end;
  ' language plpgsql;
--- 1809,1813 ----
  	
  	return  @NAMESPACE@.createEvent (''_@CLUSTERNAME@'', ''DROP_LISTEN'',
! 			p_li_origin::text, p_li_provider::text, p_li_receiver::text);
  end;
  ' language plpgsql;
***************
*** 1877,1881 ****
  
  	return @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''STORE_SET'', 
! 			p_set_id, v_local_node_id, p_set_comment);
  end;
  ' language plpgsql;
--- 1879,1883 ----
  
  	return @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''STORE_SET'', 
! 			p_set_id::text, v_local_node_id::text, p_set_comment::text);
  end;
  ' language plpgsql;
***************
*** 2167,2171 ****
  	-- ----
  	return @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''MOVE_SET'', 
! 			p_set_id, v_local_node_id, p_new_origin);
  end;
  ' language plpgsql;
--- 2169,2173 ----
  	-- ----
  	return @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''MOVE_SET'', 
! 			p_set_id::text, v_local_node_id::text, p_new_origin::text);
  end;
  ' language plpgsql;
***************
*** 2227,2231 ****
  		perform @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''SYNC'', NULL);
  		perform @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''ACCEPT_SET'', 
! 			p_set_id, p_old_origin, p_new_origin, p_wait_seqno);
  	end if;
  
--- 2229,2234 ----
  		perform @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''SYNC'', NULL);
  		perform @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''ACCEPT_SET'', 
! 			p_set_id::text, p_old_origin::text, 
! 			p_new_origin::text, p_wait_seqno::text);
  	end if;
  
***************
*** 2410,2414 ****
  	perform @NAMESPACE@.dropSet_int(p_set_id);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''DROP_SET'', 
! 			p_set_id);
  end;
  ' language plpgsql;
--- 2413,2417 ----
  	perform @NAMESPACE@.dropSet_int(p_set_id);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''DROP_SET'', 
! 			p_set_id::text);
  end;
  ' language plpgsql;
***************
*** 2561,2565 ****
  	perform @NAMESPACE@.mergeSet_int(p_set_id, p_add_id);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''MERGE_SET'', 
! 			p_set_id, p_add_id);
  end;
  ' language plpgsql;
--- 2564,2568 ----
  	perform @NAMESPACE@.mergeSet_int(p_set_id, p_add_id);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''MERGE_SET'', 
! 			p_set_id::text, p_add_id::text);
  end;
  ' language plpgsql;
***************
*** 2653,2658 ****
  			p_tab_idxname, p_tab_comment);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''SET_ADD_TABLE'',
! 			p_set_id, p_tab_id, p_fqname,
! 			p_tab_idxname, p_tab_comment);
  end;
  ' language plpgsql;
--- 2656,2661 ----
  			p_tab_idxname, p_tab_comment);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''SET_ADD_TABLE'',
! 			p_set_id::text, p_tab_id::text, p_fqname::text,
! 			p_tab_idxname::text, p_tab_comment::text);
  end;
  ' language plpgsql;
***************
*** 2838,2842 ****
  	-- ----
  	perform @NAMESPACE@.setDropTable_int(p_tab_id);
! 	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''SET_DROP_TABLE'', p_tab_id);
  end;
  ' language plpgsql;
--- 2841,2846 ----
  	-- ----
  	perform @NAMESPACE@.setDropTable_int(p_tab_id);
! 	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''SET_DROP_TABLE'', 
! 				p_tab_id::text);
  end;
  ' language plpgsql;
***************
*** 2961,2965 ****
  			p_seq_comment);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''SET_ADD_SEQUENCE'',
! 			p_set_id, p_seq_id, p_fqname, p_seq_comment);
  end;
  ' language plpgsql;
--- 2965,2970 ----
  			p_seq_comment);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''SET_ADD_SEQUENCE'',
! 						p_set_id::text, p_seq_id::text, 
! 						p_fqname::text, p_seq_comment::text);
  end;
  ' language plpgsql;
***************
*** 3125,3129 ****
  	perform @NAMESPACE@.setDropSequence_int(p_seq_id);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''SET_DROP_SEQUENCE'',
! 			p_seq_id);
  end;
  ' language plpgsql;
--- 3130,3134 ----
  	perform @NAMESPACE@.setDropSequence_int(p_seq_id);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''SET_DROP_SEQUENCE'',
! 					p_seq_id::text);
  end;
  ' language plpgsql;
***************
*** 3290,3294 ****
  	perform @NAMESPACE@.setMoveTable_int(p_tab_id, p_new_set_id);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''SET_MOVE_TABLE'', 
! 			p_tab_id, p_new_set_id);
  end;
  ' language plpgsql;
--- 3295,3299 ----
  	perform @NAMESPACE@.setMoveTable_int(p_tab_id, p_new_set_id);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''SET_MOVE_TABLE'', 
! 			p_tab_id::text, p_new_set_id::text);
  end;
  ' language plpgsql;
***************
*** 3413,3417 ****
  	perform @NAMESPACE@.setMoveSequence_int(p_seq_id, p_new_set_id);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''SET_MOVE_SEQUENCE'', 
! 			p_seq_id, p_new_set_id);
  end;
  ' language plpgsql;
--- 3418,3422 ----
  	perform @NAMESPACE@.setMoveSequence_int(p_seq_id, p_new_set_id);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''SET_MOVE_SEQUENCE'', 
! 			p_seq_id::text, p_new_set_id::text);
  end;
  ' language plpgsql;
***************
*** 3512,3516 ****
  	perform @NAMESPACE@.storeTrigger_int(p_trig_tabid, p_trig_tgname);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''STORE_TRIGGER'',
! 			p_trig_tabid, p_trig_tgname);
  end;
  ' language plpgsql;
--- 3517,3521 ----
  	perform @NAMESPACE@.storeTrigger_int(p_trig_tabid, p_trig_tgname);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''STORE_TRIGGER'',
! 			p_trig_tabid::text, p_trig_tgname::text);
  end;
  ' language plpgsql;
***************
*** 3597,3601 ****
  	perform @NAMESPACE@.dropTrigger_int(p_trig_tabid, p_trig_tgname);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''DROP_TRIGGER'',
! 			p_trig_tabid, p_trig_tgname);
  end;
  ' language plpgsql;
--- 3602,3606 ----
  	perform @NAMESPACE@.dropTrigger_int(p_trig_tabid, p_trig_tgname);
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''DROP_TRIGGER'',
! 			p_trig_tabid::text, p_trig_tgname::text);
  end;
  ' language plpgsql;
***************
*** 3742,3746 ****
  
  		return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''DDL_SCRIPT'', 
! 			p_set_id, p_script, p_only_on_node);
  	else
  		perform @NAMESPACE@.alterTableForReplication(tab_id) from @NAMESPACE@.sl_table;
--- 3747,3751 ----
  
  		return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''DDL_SCRIPT'', 
! 			p_set_id::text, p_script::text, p_only_on_node::text);
  	else
  		perform @NAMESPACE@.alterTableForReplication(tab_id) from @NAMESPACE@.sl_table;
***************
*** 4199,4203 ****
  	-- ----
  	v_ev_seqno :=  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''SUBSCRIBE_SET'', 
! 			p_sub_set, p_sub_provider, p_sub_receiver, 
  			case p_sub_forward when true then ''t'' else ''f'' end);
  
--- 4204,4208 ----
  	-- ----
  	v_ev_seqno :=  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''SUBSCRIBE_SET'', 
! 			p_sub_set::text, p_sub_provider::text, p_sub_receiver::text, 
  			case p_sub_forward when true then ''t'' else ''f'' end);
  
***************
*** 4298,4302 ****
  	if v_set_origin = @NAMESPACE@.getLocalNodeId(''_@CLUSTERNAME@'') then
  		perform @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''ENABLE_SUBSCRIPTION'', 
! 				p_sub_set, p_sub_provider, p_sub_receiver, 
  				case p_sub_forward when true then ''t'' else ''f'' end);
  		perform @NAMESPACE@.enableSubscription(p_sub_set, 
--- 4303,4307 ----
  	if v_set_origin = @NAMESPACE@.getLocalNodeId(''_@CLUSTERNAME@'') then
  		perform @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''ENABLE_SUBSCRIPTION'', 
! 				p_sub_set::text, p_sub_provider::text, p_sub_receiver::text, 
  				case p_sub_forward when true then ''t'' else ''f'' end);
  		perform @NAMESPACE@.enableSubscription(p_sub_set, 
***************
*** 4395,4399 ****
  	-- ----
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''UNSUBSCRIBE_SET'', 
! 			p_sub_set, p_sub_receiver);
  end;
  ' language plpgsql;
--- 4400,4404 ----
  	-- ----
  	return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''UNSUBSCRIBE_SET'', 
! 			p_sub_set::text, p_sub_receiver::text);
  end;
  ' language plpgsql;
***************
*** 5409,5413 ****
  
          return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''RESET_CONFIG'',
!                         p_set_id, p_only_on_node);
  end;
  ' language plpgsql;
--- 5414,5418 ----
  
          return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', ''RESET_CONFIG'',
!                         p_set_id::text, p_only_on_node::text);
  end;
  ' language plpgsql;

From wieck at lists.slony.info  Fri Jun  8 06:25:04 2007
From: wieck at lists.slony.info (Jan Wieck)
Date: Fri Jun  8 06:25:08 2007
Subject: [Slony1-commit] slony1-engine/src/ducttape test_1_pgbench.in
Message-ID: <20070608132504.9D4522903DF@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/ducttape
In directory main.slony.info:/tmp/cvs-serv417/src/ducttape

Modified Files:
	test_1_pgbench.in 
Log Message:
Let the test use SYNC,WAIT after pgbench finished.

Jan


Index: test_1_pgbench.in
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/ducttape/test_1_pgbench.in,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** test_1_pgbench.in	7 Jun 2007 13:01:10 -0000	1.3
--- test_1_pgbench.in	8 Jun 2007 13:25:02 -0000	1.4
***************
*** 95,98 ****
--- 95,102 ----
  	update history set seqno = nextval('history_seq') where seqno is null;
  	alter table history add primary key (seqno);
+ 
+ 	create sequence unused_seq;
+ 	select nextval('unused_seq');
+ 	select nextval('unused_seq');
  _EOF_
  pg_dump -s $DB1 >pgbench_schema.sql
***************
*** 161,164 ****
--- 165,171 ----
  			id = 5, fully qualified name = 'public.history_seq',
  			comment = 'Sequence history_seq');
+ 		set add sequence (set id = 1, origin = 11,
+ 			id = 6, fully qualified name = 'public.unused_seq',
+ 			comment = 'Sequence history_seq');
  	}
  	on error {
***************
*** 269,279 ****
  done
  echo "**** pgbench finished"
! echo "**** please terminate the replication engines when caught up."
! wait $slon1_pid
! wait $slon2_pid
  
! kill $pgbench_pid 2>/dev/null
! kill $slon1_pid 2>/dev/null
! kill $slon2_pid 2>/dev/null
  
  ./compare_pgbench_dumps $DB1 $DB2
--- 276,288 ----
  done
  echo "**** pgbench finished"
! slonik <<_EOF_
! $PREAMBLE
  
! 	sync (id = 11);
! 	echo '**** waiting for node 22 to catch up';
! 	wait for event (origin = 11, confirmed = 22, wait on = 11);
! 	echo '**** done.';
! _EOF_
! echo "**** you might terminate the replication engines."
  
  ./compare_pgbench_dumps $DB1 $DB2

From devrim at lists.slony.info  Sun Jun 10 14:26:13 2007
From: devrim at lists.slony.info (Devrim GUNDUZ)
Date: Sun Jun 10 14:26:15 2007
Subject: [Slony1-commit] slony1-engine postgresql-slony1-engine.spec.in
Message-ID: <20070610212613.C695D2903AC@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine
In directory main.slony.info:/tmp/cvs-serv8825

Modified Files:
      Tag: REL_1_2_STABLE
	postgresql-slony1-engine.spec.in 
Log Message:
Some more fixes, per Fedora review


Index: postgresql-slony1-engine.spec.in
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/postgresql-slony1-engine.spec.in,v
retrieving revision 1.31.2.14
retrieving revision 1.31.2.15
diff -C2 -d -r1.31.2.14 -r1.31.2.15
*** postgresql-slony1-engine.spec.in	5 Jun 2007 18:52:18 -0000	1.31.2.14
--- postgresql-slony1-engine.spec.in	10 Jun 2007 21:26:11 -0000	1.31.2.15
***************
*** 15,19 ****
  Source0:	http://main.slony.info/downloads/1.2/source/@PACKAGE_NAME@-%{version}.tar.gz
  BuildRoot:	%{_tmppath}/%{name}-%{version}-%{release}-root-%(%{__id_u} -n)
! BuildRequires:	postgresql-devel
  Requires:	postgresql-server = %{pg_version}
  
--- 15,19 ----
  Source0:	http://main.slony.info/downloads/1.2/source/@PACKAGE_NAME@-%{version}.tar.gz
  BuildRoot:	%{_tmppath}/%{name}-%{version}-%{release}-root-%(%{__id_u} -n)
! BuildRequires:	postgresql-devel, postgresql-server, autoconf
  Requires:	postgresql-server = %{pg_version}
  
***************
*** 41,45 ****
  Summary:	Documentation for Slony-I
  Group:		Applications/Databases
! Prereq:		@PACKAGE_NAME@-@PACKAGE_VERSION@-%{release}
  
  %description docs
--- 41,46 ----
  Summary:	Documentation for Slony-I
  Group:		Applications/Databases
! Requires:	@PACKAGE_NAME@-@PACKAGE_VERSION@-%{release}
! BuildRequires:	libjpeg, netpbm-progs, groff, docbook-style-dsssl, ghostscript
  
  %description docs
***************
*** 72,76 ****
  CFLAGS=`echo $CFLAGS|xargs -n 1|grep -v ffast-math|xargs -n 100`
  export LIBNAME=%{_lib}
! ./configure --includedir %{_includedir}/pgsql --with-pgconfigdir=%{_bindir} \
  %if %perltools
  	--with-perltools=%{_bindir} --with-toolsbin=%{_bindir} \
--- 73,77 ----
  CFLAGS=`echo $CFLAGS|xargs -n 1|grep -v ffast-math|xargs -n 100`
  export LIBNAME=%{_lib}
! ./configure --includedir %{_includedir}/pgsql --with-pgconfigdir=%{_bindir} --libdir=%{_libdir} \
  %if %perltools
  	--with-perltools=%{_bindir} --with-toolsbin=%{_bindir} \

From devrim at lists.slony.info  Sun Jun 10 22:54:58 2007
From: devrim at lists.slony.info (Devrim GUNDUZ)
Date: Sun Jun 10 22:54:59 2007
Subject: [Slony1-commit] slony1-engine/redhat
	postgresql-slony1-engine.specfile
Message-ID: <20070611055458.3903F2902B3@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/redhat
In directory main.slony.info:/tmp/cvs-serv11704

Modified Files:
      Tag: REL_1_2_STABLE
	postgresql-slony1-engine.specfile 
Log Message:
Sync with fedora spec file


Index: postgresql-slony1-engine.specfile
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/redhat/Attic/postgresql-slony1-engine.specfile,v
retrieving revision 1.1.2.1
retrieving revision 1.1.2.2
diff -C2 -d -r1.1.2.1 -r1.1.2.2
*** postgresql-slony1-engine.specfile	5 Jun 2007 18:45:57 -0000	1.1.2.1
--- postgresql-slony1-engine.specfile	11 Jun 2007 05:54:56 -0000	1.1.2.2
***************
*** 6,23 ****
  %{!?kerbdir:%define kerbdir "/usr"}
  
- %define pg_version	%(rpm -qv postgresql-devel|head -n 1|awk -F '-' '{print $3}')
- 
  Summary:	A "master to multiple slaves" replication system with cascading and failover
  Name:		postgresql-slony1-engine
  Version:	1.2.9
! Release:	2_PG%{pg_version}%{?dist}
  License:	BSD
  Group:		Applications/Databases
  URL:		http://main.slony.info/
  Source0:	http://main.slony.info/downloads/1.2/source/%{sname}-%{version}.tar.bz2
- Source2:	postgresql-%{sname}-engine.init
  BuildRoot:	%{_tmppath}/%{name}-%{version}-%{release}-root-%(%{__id_u} -n)
! BuildRequires:	postgresql-devel = %{pg_version}
! Requires:	postgresql-server = %{pg_version}
  
  %if %docs
--- 6,20 ----
  %{!?kerbdir:%define kerbdir "/usr"}
  
  Summary:	A "master to multiple slaves" replication system with cascading and failover
  Name:		postgresql-slony1-engine
  Version:	1.2.9
! Release:	3%{?dist}
  License:	BSD
  Group:		Applications/Databases
  URL:		http://main.slony.info/
  Source0:	http://main.slony.info/downloads/1.2/source/%{sname}-%{version}.tar.bz2
  BuildRoot:	%{_tmppath}/%{name}-%{version}-%{release}-root-%(%{__id_u} -n)
! BuildRequires:	postgresql-devel, postgresql-server
! Requires:	postgresql-server
  
  %if %docs
***************
*** 45,48 ****
--- 42,46 ----
  Group:		Applications/Databases
  Requires:	%{name}-%{version}-%{release}
+ BuildRequires	libjpeg, netpbm-progs, groff, docbook-style-dsssl, ghostscript
  
  %description docs
***************
*** 82,88 ****
  	--with-docs --with-docdir=%{_docdir}/%{name}-%{version} \
  %endif
! 	--datadir %{_datadir}/pgsql --sysconfdir=%{_sysconfdir} --with-pglibdir=%{_libdir}/pgsql 
! 
! autoconf
  
  make %{?_smp_mflags}
--- 80,84 ----
  	--with-docs --with-docdir=%{_docdir}/%{name}-%{version} \
  %endif
! 	--datadir %{_datadir}/pgsql --with-pglibdir=%{_libdir}/pgsql 
  
  make %{?_smp_mflags}
***************
*** 129,133 ****
  /bin/rm -f %{buildroot}%{_bindir}/slon-tools
  /bin/rm -f %{buildroot}%{_bindir}/pgsql/slon-tools
- /bin/rm -f altperl/old-apache-rotatelogs.patch
  %endif
  
--- 125,128 ----
***************
*** 149,157 ****
  fi
  
- 
  %files
  %defattr(-,root,root,-)
! %attr(755,root,root) %{_docdir}/%{name}
! %attr(644,root,root) %doc COPYRIGHT UPGRADING HISTORY-1.1 INSTALL SAMPLE RELEASE-1.2.1 RELEASE-1.2.2 RELEASE-1.2.5 RELEASE-1.2.6 RELEASE-1.2.7 RELEASE-1.2.8 RELEASE-1.2.9
  %{_bindir}/*
  %{_libdir}/pgsql/slony1_funcs.so
--- 144,150 ----
  fi
  
  %files
  %defattr(-,root,root,-)
! %attr(644,root,root) %doc COPYRIGHT UPGRADING HISTORY-1.1 INSTALL SAMPLE RELEASE*
  %{_bindir}/*
  %{_libdir}/pgsql/slony1_funcs.so
***************
*** 171,174 ****
--- 164,171 ----
  
  %changelog
+ * Mon Jun 11 2007 Devrim Gunduz <devrim@CommandPrompt.com> 1.2.9-3
+ - Add BuildRequires for docs subpackage, per RH#199154 (Thanks Ruben)
+ - Various small fixes
+ 
  * Sun Jun 3 2007 Devrim Gunduz <devrim@CommandPrompt.com>
  - Some more fixes for Fedora review.

From cbbrowne at lists.slony.info  Mon Jun 11 09:01:00 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Mon Jun 11 09:01:02 2007
Subject: [Slony1-commit] slony1-engine/doc/adminguide faq.sgml
Message-ID: <20070611160100.7582A290447@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/doc/adminguide
In directory main.slony.info:/tmp/cvs-serv12997

Modified Files:
      Tag: REL_1_2_STABLE
	faq.sgml 
Log Message:
Add in docs on problem with UPDATE FUNCTIONS on PG 8.1.[0-3]


Index: faq.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/faq.sgml,v
retrieving revision 1.66.2.5
retrieving revision 1.66.2.6
diff -C2 -d -r1.66.2.5 -r1.66.2.6
*** faq.sgml	6 Jun 2007 22:17:10 -0000	1.66.2.5
--- faq.sgml	11 Jun 2007 16:00:58 -0000	1.66.2.6
***************
*** 163,166 ****
--- 163,236 ----
  </qandaentry>
  
+ <qandaentry id="pg81funs">
+ 
+ <question> <para> I'm trying to upgrade to a newer version of &slony1;
+ and am running into a problem with <xref
+ linkend="stmtupdatefunctions">.  When I run <xref
+ linkend="stmtupdatefunctions">, my
+ <application>postmaster</application> falls over with a Signal 11.
+ There aren't any seeming errors in the log files, aside from the
+ &postgres; logs indicating that, yes indeed, the postmaster fell
+ over.</para>
+ 
+ <para> I connected a debugger to the core file, and it indicates that
+ it was trying to commit a transaction at the time of the
+ failure. </para>
+ 
+ <para> By the way I'm on &postgres; 8.1.[0-3]. </para>
+ </question>
+ 
+ <answer> <para> Unfortunately, early releases of &postgres; 8.1 had a
+ problem where if you redefined a function (such as, say,
+ <function>upgradeSchema(text)</function>), and then, in the same
+ transaction, ran that function, the
+ <application>postmaster</application> would fall over, and the
+ transaction would fail to commit.  </para>
+ 
+ <para> The &lslonik; command <xref linkend="stmtupdatefunctions">
+ functions like that; it, in one transaction, tries to:
+ 
+ <itemizedlist>
+ <listitem><para> Load the new functions (from <filename>slony1_funcs.sql</filename>), notably including <function>upgradeSchema(text)</function>.  </para> </listitem>
+ <listitem><para> Run <function>upgradeSchema(text)</function> to do any necessary upgrades to the database schema. </para> </listitem>
+ <listitem><para> Notify &lslon; processes of a change of configuration.</para> </listitem>
+ </itemizedlist>
+ </para>
+ 
+ <para> Unfortunately, on &postgres; 8.1.0, 8.1.1, 8.1.2, and 8.1.3,
+ this conflicts with a bug where using and modifying a plpgsql function
+ in the same transaction leads to a crash. </para>
+ 
+ <para> Several workarounds are available. </para>
+ 
+ </answer>
+ 
+ <answer> <para> The preferred answer would be to upgrade &postgres; to
+ 8.1.4 or some later version.  Changes between minor versions do not
+ require rebuilding databases; it should merely require copying a
+ suitable 8.1.x build into place, and restarting the
+ <application>postmaster</application> with the new version.  </para>
+ </answer>
+ 
+ <answer><para> If that is unsuitable, it would be possible to perform
+ the upgrade via a series of transactions, performing the equivalent of
+ what &lslonik; does <quote>by hand</quote>: </para>
+ 
+ <itemizedlist>
+ <listitem><para> Take <filename>slony1_funcs.sql</filename> and do three replacements within it: </para> 
+ 
+ <itemizedlist>
+ <listitem><para> Replace <quote>@CLUSTERNAME@</quote> with the name of the cluster </para> </listitem>
+ <listitem><para> Replace <quote>@MODULEVERSION@</quote> with the &slony1; version string, such as <quote>1.2.10</quote> </para> </listitem>
+ <listitem><para> Replace <quote>@NAMESPACE@</quote> with the <quote>double-quoted</quote> name of the cluster namespace, such as "_MyCluster" </para> </listitem>
+ </itemizedlist>
+ </listitem>
+ <listitem><para> Load that <quote>remapped</quote> set of functions into the database.</para> </listitem>
+ <listitem><para> Run the stored function via <command>select <function>upgradeSchema('1.2.7')</function>; </command>, assuming that the previous version of &slony1; in use was version 1.2.7. </para> </listitem>
+ <listitem><para> Restarting all &lslon; processes would probably be a wise move with this sort of <quote>surgery.</quote> </para> </listitem>
+ </itemizedlist>
+ </answer>
+ </qandaentry>
+ 
  </qandadiv>
  

From cbbrowne at lists.slony.info  Mon Jun 11 09:01:35 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Mon Jun 11 09:01:37 2007
Subject: [Slony1-commit] slony1-engine/doc/adminguide addthings.sgml
	ddlchanges.sgml defineset.sgml firstdb.sgml installation.sgml
	intro.sgml listenpaths.sgml monitoring.sgml
	prerequisites.sgml usingslonik.sgml
Message-ID: <20070611160136.33978290447@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/doc/adminguide
In directory main.slony.info:/tmp/cvs-serv13028

Modified Files:
      Tag: REL_1_2_STABLE
	addthings.sgml ddlchanges.sgml defineset.sgml firstdb.sgml 
	installation.sgml intro.sgml listenpaths.sgml monitoring.sgml 
	prerequisites.sgml usingslonik.sgml 
Log Message:
Add more index entries, linkages surrounding issue with PG 8.1.[0-3]


Index: ddlchanges.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/ddlchanges.sgml,v
retrieving revision 1.29
retrieving revision 1.29.2.1
diff -C2 -d -r1.29 -r1.29.2.1
*** ddlchanges.sgml	6 Oct 2006 20:19:43 -0000	1.29
--- ddlchanges.sgml	11 Jun 2007 16:01:33 -0000	1.29.2.1
***************
*** 263,266 ****
--- 263,268 ----
  <sect2><title> Testing DDL Changes </title>
  
+ <indexterm><primary> testing DDL changes </primary></indexterm>
+ 
  <para> A method for testing DDL changes has been pointed out as a
  likely <quote>best practice.</quote></para>

Index: defineset.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/defineset.sgml,v
retrieving revision 1.25.2.1
retrieving revision 1.25.2.2
diff -C2 -d -r1.25.2.1 -r1.25.2.2
*** defineset.sgml	16 Mar 2007 19:01:26 -0000	1.25.2.1
--- defineset.sgml	11 Jun 2007 16:01:33 -0000	1.25.2.2
***************
*** 93,96 ****
--- 93,98 ----
  <sect2 id="definesets"><title>Grouping tables into sets</title>
  
+ <indexterm><primary> grouping tables into replication sets </primary></indexterm>
+ 
  <para> It will be vital to group tables together into a single set if
  those tables are related via foreign key constraints.  If tables that

Index: prerequisites.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/prerequisites.sgml,v
retrieving revision 1.26.2.1
retrieving revision 1.26.2.2
diff -C2 -d -r1.26.2.1 -r1.26.2.2
*** prerequisites.sgml	5 Dec 2006 20:39:17 -0000	1.26.2.1
--- prerequisites.sgml	11 Jun 2007 16:01:33 -0000	1.26.2.2
***************
*** 1,7 ****
  <!-- $Id -->
  <sect1 id="requirements">
! <title>System Requirements</title> <para>Any platform that can run
! &postgres; should be able to run
! &slony1;.</para>
  
  <para>The platforms that have received specific testing at the time of
--- 1,10 ----
  <!-- $Id -->
  <sect1 id="requirements">
! <title>System Requirements</title> 
! 
! <para>Any platform that can run &postgres; should be able, in
! principle, to run &slony1;.</para>
! 
! <indexterm><primary> platforms where &slony1; runs </primary> </indexterm>
  
  <para>The platforms that have received specific testing at the time of
***************
*** 15,18 ****
--- 18,23 ----
  <title> &slony1; Software Dependancies</title>
  
+ <indexterm><primary> software dependancies </primary> </indexterm>
+ 
  <para> At present, &slony1; <emphasis>as well as &postgres;</emphasis>
  need to be able to be compiled from source at your site.</para>
***************
*** 56,59 ****
--- 61,70 ----
  </para>
  
+ <para> If you are running versions 8.1.0 thru 8.1.3, there is a bug
+ (addressed in 8.1.4) which prevents <xref
+ linkend="stmtupdatefunctions"> from running properly.  For more
+ details see the <xref linkend="FAQ">, <link
+ linkend="pg81funs"> on &postgres; 8.1.[0-3] </link>. </para>
+ 
  </listitem>
  
***************
*** 103,109 ****
  <title> Getting &slony1; Source</title>
  
  <para>You can get the &slony1; source from <ulink
!     url="http://developer.postgresql.org/~wieck/slony1/download/">
! http://developer.postgresql.org/~wieck/slony1/download/</ulink>
  </para>
  
--- 114,122 ----
  <title> Getting &slony1; Source</title>
  
+ <indexterm><primary>downloading &slony1; sources</primary></indexterm>
+ 
  <para>You can get the &slony1; source from <ulink
!     url="http://main.slony.info/downloads/">
! http://main.slony.info/downloads/</ulink>
  </para>
  
***************
*** 113,116 ****
--- 126,131 ----
  <title> Database Encoding </title>
  
+ <indexterm><primary> database encodings</primary></indexterm>
+ 
  <para> &postgres; databases may be created in a number of language
  encodings, set up via the <command>createdb --encoding=$ENCODING
***************
*** 147,150 ****
--- 162,167 ----
  <title> Time Synchronization</title>
  
+ <indexterm><primary> time synchronization</primary></indexterm>
+ 
  <para> All the servers used within the replication cluster need to
  have their Real Time Clocks in sync. This is to ensure that <xref
***************
*** 199,202 ****
--- 216,221 ----
  <sect2><title> Network Connectivity</title>
  
+ <indexterm><primary> network connectivity</primary></indexterm>
+ 
  <para>It is necessary that the hosts that are to replicate between one
  another have <emphasis>bidirectional</emphasis> network communications

Index: intro.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/intro.sgml,v
retrieving revision 1.25.2.1
retrieving revision 1.25.2.2
diff -C2 -d -r1.25.2.1 -r1.25.2.2
*** intro.sgml	16 Mar 2007 19:01:26 -0000	1.25.2.1
--- intro.sgml	11 Jun 2007 16:01:33 -0000	1.25.2.2
***************
*** 3,6 ****
--- 3,8 ----
  <title>Introduction to &slony1;</title>
  
+ <indexterm><primary> introduction to &slony1; </primary></indexterm>
+ 
  <sect2> <title>What &slony1; is</title>
  

Index: monitoring.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/monitoring.sgml,v
retrieving revision 1.29.2.7
retrieving revision 1.29.2.8
diff -C2 -d -r1.29.2.7 -r1.29.2.8
*** monitoring.sgml	9 May 2007 19:24:44 -0000	1.29.2.7
--- monitoring.sgml	11 Jun 2007 16:01:33 -0000	1.29.2.8
***************
*** 168,171 ****
--- 168,173 ----
  <sect2 id="search-logs"> <title> <command>search-logs.sh</command> </title>
  
+ <indexterm><primary> search &slony1; logs using search-logs.sh </primary></indexterm>
+ 
  <para> This script is constructed to search for &slony1; log files at
  a given path (<envar>LOGHOME</envar>), based both on the naming
***************
*** 187,190 ****
--- 189,194 ----
  <sect2 id="wikigen"> <title> Building MediaWiki Cluster Summary </title>
  
+ <indexterm><primary> generating Wiki documentation of a cluster </primary></indexterm>
+ 
  <para> The script <filename>mkmediawiki.pl </filename>, in
  <filename>tools</filename>, may be used to generate a cluster summary

Index: usingslonik.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/usingslonik.sgml,v
retrieving revision 1.18
retrieving revision 1.18.2.1
diff -C2 -d -r1.18 -r1.18.2.1
*** usingslonik.sgml	2 Aug 2006 18:34:59 -0000	1.18
--- usingslonik.sgml	11 Jun 2007 16:01:33 -0000	1.18.2.1
***************
*** 93,96 ****
--- 93,98 ----
  <sect1 id="slonikshell"><title> Embedding Slonik in Shell Scripts </title>
  
+ <indexterm><primary> embedding slonik in shell scripts </primary></indexterm>
+ 
  <para> As mentioned earlier, there are numerous &slony1; test scripts
  in <filename>src/ducttape</filename> that embed the generation of
***************
*** 277,280 ****
--- 279,284 ----
  Functions </title>
  
+ <indexterm><primary> bare metal &slony1; functions </primary></indexterm>
+ 
  <para> There are cases where it may make sense to directly use the
  stored functions that implement the various pieces of &slony1;.

Index: installation.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/installation.sgml,v
retrieving revision 1.28.2.1
retrieving revision 1.28.2.2
diff -C2 -d -r1.28.2.1 -r1.28.2.2
*** installation.sgml	16 Mar 2007 19:01:26 -0000	1.28.2.1
--- installation.sgml	11 Jun 2007 16:01:33 -0000	1.28.2.2
***************
*** 40,43 ****
--- 40,45 ----
  <title>Short Version</title>
  
+ <indexterm><primary> installation: short version </primary></indexterm>
+ 
  <para>
  <screen>
***************
*** 189,192 ****
--- 191,197 ----
  </itemizedlist>
  
+ <para> (Note that as things change, the list of version-specific files
+ may grow...) </para>
+ 
  <para>The <filename>.sql</filename> files are not fully substituted
  yet.  And yes, both the 7.3, 7.4 and the 8.0 files get installed on every
***************
*** 206,209 ****
--- 211,216 ----
  <sect2> <title> Building Documentation: Admin Guide </title>
  
+ <indexterm><primary> building &slony1; documentation </primary></indexterm>
+ 
  <para> The document you are reading now is a fairly extensive
  <quote>Administrator's Guide</quote> containing what wisdom has been

Index: listenpaths.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/listenpaths.sgml,v
retrieving revision 1.19
retrieving revision 1.19.2.1
diff -C2 -d -r1.19 -r1.19.2.1
*** listenpaths.sgml	2 Aug 2006 18:34:58 -0000	1.19
--- listenpaths.sgml	11 Jun 2007 16:01:33 -0000	1.19.2.1
***************
*** 4,12 ****
  <indexterm><primary>listen paths</primary></indexterm>
  
! <note><para> If you are running version
! &slony1; 1.1 or later it should be
! <emphasis>completely unnecessary</emphasis> to read this section as it
! introduces a way to automatically manage this part of its
! configuration.  For earlier versions, however, it is needful.</para>
  </note>
  
--- 4,12 ----
  <indexterm><primary>listen paths</primary></indexterm>
  
! <note><para> If you are running version &slony1; 1.2 or later it
! should be <emphasis>completely unnecessary</emphasis> to read this
! section as it introduces a way to automatically manage this part of
! its configuration.  For earlier versions, however, it is
! needful.</para>
  </note>
  
***************
*** 34,37 ****
--- 34,39 ----
  <sect2><title>How listening can break</title>
  
+ <indexterm><primary> listening breakage </primary></indexterm>
+ 
  <para>On one occasion, I had a need to drop a subscriber node (#2) and
  recreate it.  That node was the data provider for another subscriber
***************
*** 175,178 ****
--- 177,182 ----
  <sect2 id="autolisten"><title>Automated Listen Path Generation</title>
  
+ <indexterm><primary> automated listen path generation </primary></indexterm>
+ 
  <para> In &slony1; version 1.1, a heuristic scheme is introduced to
  automatically generate <envar>sl_listen</envar> entries.  This

Index: firstdb.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/firstdb.sgml,v
retrieving revision 1.20.2.2
retrieving revision 1.20.2.3
diff -C2 -d -r1.20.2.2 -r1.20.2.3
*** firstdb.sgml	16 Mar 2007 19:01:26 -0000	1.20.2.2
--- firstdb.sgml	11 Jun 2007 16:01:33 -0000	1.20.2.3
***************
*** 144,147 ****
--- 144,149 ----
  <sect3><title>Using the altperl scripts</title>
  
+ <indexterm><primary> altperl script usage </primary></indexterm>
+ 
  <para>
  Using the <xref linkend="altperl"> scripts is an easy way to get started.  The
***************
*** 174,180 ****
  
  <sect3><title>Using slonik command directly</title>
- <para>The traditional approach to administering slony is to craft slonik
- commands directly. An example of this given here. </para>
  
  
  <para> The script to create
--- 176,182 ----
  
  <sect3><title>Using slonik command directly</title>
  
+ <para>The traditional approach to administering slony is to craft
+ slonik commands directly. An example of this given here. </para>
  
  <para> The script to create

Index: addthings.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/addthings.sgml,v
retrieving revision 1.23.2.4
retrieving revision 1.23.2.5
diff -C2 -d -r1.23.2.4 -r1.23.2.5
*** addthings.sgml	16 Mar 2007 19:01:26 -0000	1.23.2.4
--- addthings.sgml	11 Jun 2007 16:01:33 -0000	1.23.2.5
***************
*** 61,64 ****
--- 61,66 ----
  <sect2><title> Adding a table to replication </title>
  
+ <indexterm><primary> adding a table to replication </primary></indexterm>
+ 
  <para> &slony1; does not allow you to add a table to a replication set
  that is already being replicated. In principle, it would certainly be
***************
*** 120,123 ****
--- 122,127 ----
  <sect2><title> How to add columns to a replicated table </title>
  
+ <indexterm><primary> adding columns to a replicated table </primary></indexterm>
+ 
  <para> This also answers the question <quote>How do I rename columns
  on a replicated table?</quote>, and, more generally, other questions

From cbbrowne at lists.slony.info  Mon Jun 11 09:02:52 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Mon Jun 11 09:02:53 2007
Subject: [Slony1-commit] slony1-engine/doc/adminguide addthings.sgml
	ddlchanges.sgml defineset.sgml faq.sgml firstdb.sgml
	installation.sgml intro.sgml listenpaths.sgml
	loganalysis.sgml monitoring.sgml prerequisites.sgml usingslonik.sgml
Message-ID: <20070611160252.8905E290BEA@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/doc/adminguide
In directory main.slony.info:/tmp/cvs-serv13051

Modified Files:
	addthings.sgml ddlchanges.sgml defineset.sgml faq.sgml 
	firstdb.sgml installation.sgml intro.sgml listenpaths.sgml 
	loganalysis.sgml monitoring.sgml prerequisites.sgml 
	usingslonik.sgml 
Log Message:
Added documentation for problem with PG 8.1.[0-3], linked it into docs,
added various additional index entries.


Index: ddlchanges.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/ddlchanges.sgml,v
retrieving revision 1.29
retrieving revision 1.30
diff -C2 -d -r1.29 -r1.30
*** ddlchanges.sgml	6 Oct 2006 20:19:43 -0000	1.29
--- ddlchanges.sgml	11 Jun 2007 16:02:50 -0000	1.30
***************
*** 263,266 ****
--- 263,268 ----
  <sect2><title> Testing DDL Changes </title>
  
+ <indexterm><primary> testing DDL changes </primary></indexterm>
+ 
  <para> A method for testing DDL changes has been pointed out as a
  likely <quote>best practice.</quote></para>

Index: defineset.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/defineset.sgml,v
retrieving revision 1.27
retrieving revision 1.28
diff -C2 -d -r1.27 -r1.28
*** defineset.sgml	18 Apr 2007 15:03:51 -0000	1.27
--- defineset.sgml	11 Jun 2007 16:02:50 -0000	1.28
***************
*** 95,98 ****
--- 95,100 ----
  <sect2 id="definesets"><title>Grouping tables into sets</title>
  
+ <indexterm><primary> grouping tables into replication sets </primary></indexterm>
+ 
  <para> It will be vital to group tables together into a single set if
  those tables are related via foreign key constraints.  If tables that

Index: prerequisites.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/prerequisites.sgml,v
retrieving revision 1.27
retrieving revision 1.28
diff -C2 -d -r1.27 -r1.28
*** prerequisites.sgml	5 Dec 2006 20:39:34 -0000	1.27
--- prerequisites.sgml	11 Jun 2007 16:02:50 -0000	1.28
***************
*** 1,7 ****
  <!-- $Id -->
  <sect1 id="requirements">
! <title>System Requirements</title> <para>Any platform that can run
! &postgres; should be able to run
! &slony1;.</para>
  
  <para>The platforms that have received specific testing at the time of
--- 1,10 ----
  <!-- $Id -->
  <sect1 id="requirements">
! <title>System Requirements</title> 
! 
! <para>Any platform that can run &postgres; should be able, in
! principle, to run &slony1;.</para>
! 
! <indexterm><primary> platforms where &slony1; runs </primary> </indexterm>
  
  <para>The platforms that have received specific testing at the time of
***************
*** 15,18 ****
--- 18,23 ----
  <title> &slony1; Software Dependancies</title>
  
+ <indexterm><primary> software dependancies </primary> </indexterm>
+ 
  <para> At present, &slony1; <emphasis>as well as &postgres;</emphasis>
  need to be able to be compiled from source at your site.</para>
***************
*** 56,59 ****
--- 61,70 ----
  </para>
  
+ <para> If you are running versions 8.1.0 thru 8.1.3, there is a bug
+ (addressed in 8.1.4) which prevents <xref
+ linkend="stmtupdatefunctions"> from running properly.  For more
+ details see the <xref linkend="FAQ">, <link
+ linkend="pg81funs"> on &postgres; 8.1.[0-3] </link>. </para>
+ 
  </listitem>
  
***************
*** 103,109 ****
  <title> Getting &slony1; Source</title>
  
  <para>You can get the &slony1; source from <ulink
!     url="http://developer.postgresql.org/~wieck/slony1/download/">
! http://developer.postgresql.org/~wieck/slony1/download/</ulink>
  </para>
  
--- 114,122 ----
  <title> Getting &slony1; Source</title>
  
+ <indexterm><primary>downloading &slony1; sources</primary></indexterm>
+ 
  <para>You can get the &slony1; source from <ulink
!     url="http://main.slony.info/downloads/">
! http://main.slony.info/downloads/</ulink>
  </para>
  
***************
*** 113,116 ****
--- 126,131 ----
  <title> Database Encoding </title>
  
+ <indexterm><primary> database encodings</primary></indexterm>
+ 
  <para> &postgres; databases may be created in a number of language
  encodings, set up via the <command>createdb --encoding=$ENCODING
***************
*** 147,150 ****
--- 162,167 ----
  <title> Time Synchronization</title>
  
+ <indexterm><primary> time synchronization</primary></indexterm>
+ 
  <para> All the servers used within the replication cluster need to
  have their Real Time Clocks in sync. This is to ensure that <xref
***************
*** 199,202 ****
--- 216,221 ----
  <sect2><title> Network Connectivity</title>
  
+ <indexterm><primary> network connectivity</primary></indexterm>
+ 
  <para>It is necessary that the hosts that are to replicate between one
  another have <emphasis>bidirectional</emphasis> network communications

Index: intro.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/intro.sgml,v
retrieving revision 1.27
retrieving revision 1.28
diff -C2 -d -r1.27 -r1.28
*** intro.sgml	1 Dec 2006 23:15:43 -0000	1.27
--- intro.sgml	11 Jun 2007 16:02:50 -0000	1.28
***************
*** 3,6 ****
--- 3,8 ----
  <title>Introduction to &slony1;</title>
  
+ <indexterm><primary> introduction to &slony1; </primary></indexterm>
+ 
  <sect2> <title>What &slony1; is</title>
  

Index: monitoring.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/monitoring.sgml,v
retrieving revision 1.36
retrieving revision 1.37
diff -C2 -d -r1.36 -r1.37
*** monitoring.sgml	9 May 2007 19:20:03 -0000	1.36
--- monitoring.sgml	11 Jun 2007 16:02:50 -0000	1.37
***************
*** 168,171 ****
--- 168,173 ----
  <sect2 id="search-logs"> <title> <command>search-logs.sh</command> </title>
  
+ <indexterm><primary> search &slony1; logs using search-logs.sh </primary></indexterm>
+ 
  <para> This script is constructed to search for &slony1; log files at
  a given path (<envar>LOGHOME</envar>), based both on the naming
***************
*** 187,190 ****
--- 189,194 ----
  <sect2 id="wikigen"> <title> Building MediaWiki Cluster Summary </title>
  
+ <indexterm><primary> generating Wiki documentation of a cluster </primary></indexterm>
+ 
  <para> The script <filename>mkmediawiki.pl </filename>, in
  <filename>tools</filename>, may be used to generate a cluster summary

Index: firstdb.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/firstdb.sgml,v
retrieving revision 1.23
retrieving revision 1.24
diff -C2 -d -r1.23 -r1.24
*** firstdb.sgml	13 Mar 2007 16:06:28 -0000	1.23
--- firstdb.sgml	11 Jun 2007 16:02:50 -0000	1.24
***************
*** 144,147 ****
--- 144,149 ----
  <sect3><title>Using the altperl scripts</title>
  
+ <indexterm><primary> altperl script usage </primary></indexterm>
+ 
  <para>
  Using the <xref linkend="altperl"> scripts is an easy way to get started.  The
***************
*** 174,180 ****
  
  <sect3><title>Using slonik command directly</title>
- <para>The traditional approach to administering slony is to craft slonik
- commands directly. An example of this given here. </para>
  
  
  <para> The script to create
--- 176,182 ----
  
  <sect3><title>Using slonik command directly</title>
  
+ <para>The traditional approach to administering slony is to craft
+ slonik commands directly. An example of this given here. </para>
  
  <para> The script to create

Index: usingslonik.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/usingslonik.sgml,v
retrieving revision 1.18
retrieving revision 1.19
diff -C2 -d -r1.18 -r1.19
*** usingslonik.sgml	2 Aug 2006 18:34:59 -0000	1.18
--- usingslonik.sgml	11 Jun 2007 16:02:50 -0000	1.19
***************
*** 93,96 ****
--- 93,98 ----
  <sect1 id="slonikshell"><title> Embedding Slonik in Shell Scripts </title>
  
+ <indexterm><primary> embedding slonik in shell scripts </primary></indexterm>
+ 
  <para> As mentioned earlier, there are numerous &slony1; test scripts
  in <filename>src/ducttape</filename> that embed the generation of
***************
*** 277,280 ****
--- 279,284 ----
  Functions </title>
  
+ <indexterm><primary> bare metal &slony1; functions </primary></indexterm>
+ 
  <para> There are cases where it may make sense to directly use the
  stored functions that implement the various pieces of &slony1;.

Index: listenpaths.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/listenpaths.sgml,v
retrieving revision 1.19
retrieving revision 1.20
diff -C2 -d -r1.19 -r1.20
*** listenpaths.sgml	2 Aug 2006 18:34:58 -0000	1.19
--- listenpaths.sgml	11 Jun 2007 16:02:50 -0000	1.20
***************
*** 4,12 ****
  <indexterm><primary>listen paths</primary></indexterm>
  
! <note><para> If you are running version
! &slony1; 1.1 or later it should be
! <emphasis>completely unnecessary</emphasis> to read this section as it
! introduces a way to automatically manage this part of its
! configuration.  For earlier versions, however, it is needful.</para>
  </note>
  
--- 4,12 ----
  <indexterm><primary>listen paths</primary></indexterm>
  
! <note><para> If you are running version &slony1; 1.2 or later it
! should be <emphasis>completely unnecessary</emphasis> to read this
! section as it introduces a way to automatically manage this part of
! its configuration.  For earlier versions, however, it is
! needful.</para>
  </note>
  
***************
*** 34,37 ****
--- 34,39 ----
  <sect2><title>How listening can break</title>
  
+ <indexterm><primary> listening breakage </primary></indexterm>
+ 
  <para>On one occasion, I had a need to drop a subscriber node (#2) and
  recreate it.  That node was the data provider for another subscriber
***************
*** 175,178 ****
--- 177,182 ----
  <sect2 id="autolisten"><title>Automated Listen Path Generation</title>
  
+ <indexterm><primary> automated listen path generation </primary></indexterm>
+ 
  <para> In &slony1; version 1.1, a heuristic scheme is introduced to
  automatically generate <envar>sl_listen</envar> entries.  This

Index: faq.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/faq.sgml,v
retrieving revision 1.70
retrieving revision 1.71
diff -C2 -d -r1.70 -r1.71
*** faq.sgml	18 Apr 2007 15:03:51 -0000	1.70
--- faq.sgml	11 Jun 2007 16:02:50 -0000	1.71
***************
*** 162,165 ****
--- 162,235 ----
  </qandaentry>
  
+ <qandaentry id="pg81funs">
+ 
+ <question> <para> I'm trying to upgrade to a newer version of &slony1;
+ and am running into a problem with <xref
+ linkend="stmtupdatefunctions">.  When I run <xref
+ linkend="stmtupdatefunctions">, my
+ <application>postmaster</application> falls over with a Signal 11.
+ There aren't any seeming errors in the log files, aside from the
+ &postgres; logs indicating that, yes indeed, the postmaster fell
+ over.</para>
+ 
+ <para> I connected a debugger to the core file, and it indicates that
+ it was trying to commit a transaction at the time of the
+ failure. </para>
+ 
+ <para> By the way I'm on &postgres; 8.1.[0-3]. </para>
+ </question>
+ 
+ <answer> <para> Unfortunately, early releases of &postgres; 8.1 had a
+ problem where if you redefined a function (such as, say,
+ <function>upgradeSchema(text)</function>), and then, in the same
+ transaction, ran that function, the
+ <application>postmaster</application> would fall over, and the
+ transaction would fail to commit.  </para>
+ 
+ <para> The &lslonik; command <xref linkend="stmtupdatefunctions">
+ functions like that; it, in one transaction, tries to:
+ 
+ <itemizedlist>
+ <listitem><para> Load the new functions (from <filename>slony1_funcs.sql</filename>), notably including <function>upgradeSchema(text)</function>.  </para> </listitem>
+ <listitem><para> Run <function>upgradeSchema(text)</function> to do any necessary upgrades to the database schema. </para> </listitem>
+ <listitem><para> Notify &lslon; processes of a change of configuration.</para> </listitem>
+ </itemizedlist>
+ </para>
+ 
+ <para> Unfortunately, on &postgres; 8.1.0, 8.1.1, 8.1.2, and 8.1.3,
+ this conflicts with a bug where using and modifying a plpgsql function
+ in the same transaction leads to a crash. </para>
+ 
+ <para> Several workarounds are available. </para>
+ 
+ </answer>
+ 
+ <answer> <para> The preferred answer would be to upgrade &postgres; to
+ 8.1.4 or some later version.  Changes between minor versions do not
+ require rebuilding databases; it should merely require copying a
+ suitable 8.1.x build into place, and restarting the
+ <application>postmaster</application> with the new version.  </para>
+ </answer>
+ 
+ <answer><para> If that is unsuitable, it would be possible to perform
+ the upgrade via a series of transactions, performing the equivalent of
+ what &lslonik; does <quote>by hand</quote>: </para>
+ 
+ <itemizedlist>
+ <listitem><para> Take <filename>slony1_funcs.sql</filename> and do three replacements within it: </para> 
+ 
+ <itemizedlist>
+ <listitem><para> Replace <quote>@CLUSTERNAME@</quote> with the name of the cluster </para> </listitem>
+ <listitem><para> Replace <quote>@MODULEVERSION@</quote> with the &slony1; version string, such as <quote>1.2.10</quote> </para> </listitem>
+ <listitem><para> Replace <quote>@NAMESPACE@</quote> with the <quote>double-quoted</quote> name of the cluster namespace, such as "_MyCluster" </para> </listitem>
+ </itemizedlist>
+ </listitem>
+ <listitem><para> Load that <quote>remapped</quote> set of functions into the database.</para> </listitem>
+ <listitem><para> Run the stored function via <command>select <function>upgradeSchema('1.2.7')</function>; </command>, assuming that the previous version of &slony1; in use was version 1.2.7. </para> </listitem>
+ <listitem><para> Restarting all &lslon; processes would probably be a wise move with this sort of <quote>surgery.</quote> </para> </listitem>
+ </itemizedlist>
+ </answer>
+ </qandaentry>
+ 
  </qandadiv>
  

Index: installation.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/installation.sgml,v
retrieving revision 1.31
retrieving revision 1.32
diff -C2 -d -r1.31 -r1.32
*** installation.sgml	4 Dec 2006 07:12:49 -0000	1.31
--- installation.sgml	11 Jun 2007 16:02:50 -0000	1.32
***************
*** 40,43 ****
--- 40,45 ----
  <title>Short Version</title>
  
+ <indexterm><primary> installation: short version </primary></indexterm>
+ 
  <para>
  <screen>
***************
*** 189,192 ****
--- 191,197 ----
  </itemizedlist>
  
+ <para> (Note that as things change, the list of version-specific files
+ may grow...) </para>
+ 
  <para>The <filename>.sql</filename> files are not fully substituted
  yet.  And yes, both the 7.3, 7.4 and the 8.0 files get installed on every
***************
*** 206,209 ****
--- 211,216 ----
  <sect2> <title> Building Documentation: Admin Guide </title>
  
+ <indexterm><primary> building &slony1; documentation </primary></indexterm>
+ 
  <para> The document you are reading now is a fairly extensive
  <quote>Administrator's Guide</quote> containing what wisdom has been

Index: loganalysis.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/loganalysis.sgml,v
retrieving revision 1.8
retrieving revision 1.9
diff -C2 -d -r1.8 -r1.9
*** loganalysis.sgml	16 Feb 2007 23:35:13 -0000	1.8
--- loganalysis.sgml	11 Jun 2007 16:02:50 -0000	1.9
***************
*** 695,699 ****
  <listitem><para><command>ERROR: remoteWorkerThread_%d: SYNC aborted</command></para> 
  
! <para> If any errors have been encountered that haven't already aborted the <command>SYNC</command>, this catches and aborts it.</para></listitem>
  
  <listitem><para><command>DEBUG2: remoteWorkerThread_%d: new sl_rowid_seq value: %s</command></para> 
--- 695,707 ----
  <listitem><para><command>ERROR: remoteWorkerThread_%d: SYNC aborted</command></para> 
  
! <para>The <command>SYNC</command> has been aborted. The &lslon; will
! likely retry this <command>SYNC</command> some time soon.  If the
! <command>SYNC</command> continues to fail, there is some continuing
! problem, and replication will likely never catch up without
! intervention.  It may be necessary to unsubscribe/resubscribe the
! affected slave set, or, if there is only one set on the slave node, it
! may be simpler to drop and recreate the slave node.  If application
! connections may be shifted over to the master during this time,
! application downtime may not be necessary.  </para></listitem>
  
  <listitem><para><command>DEBUG2: remoteWorkerThread_%d: new sl_rowid_seq value: %s</command></para> 

Index: addthings.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/addthings.sgml,v
retrieving revision 1.28
retrieving revision 1.29
diff -C2 -d -r1.28 -r1.29
*** addthings.sgml	18 Apr 2007 15:03:51 -0000	1.28
--- addthings.sgml	11 Jun 2007 16:02:50 -0000	1.29
***************
*** 61,64 ****
--- 61,66 ----
  <sect2><title> Adding a table to replication </title>
  
+ <indexterm><primary> adding a table to replication </primary></indexterm>
+ 
  <para> &slony1; does not allow you to add a table to a replication set
  that is already being replicated. In principle, it would certainly be
***************
*** 120,123 ****
--- 122,127 ----
  <sect2><title> How to add columns to a replicated table </title>
  
+ <indexterm><primary> adding columns to a replicated table </primary></indexterm>
+ 
  <para> This also answers the question <quote>How do I rename columns
  on a replicated table?</quote>, and, more generally, other questions

From cbbrowne at lists.slony.info  Mon Jun 11 10:55:25 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Mon Jun 11 10:55:26 2007
Subject: [Slony1-commit] slony1-www/content news.txt
Message-ID: <20070611175525.11D522903AC@main.slony.info>

Update of /home/cvsd/slony1/slony1-www/content
In directory main.slony.info:/tmp/cvs-serv13702/content

Modified Files:
	news.txt 
Log Message:
Add in new news about 1.2.10 testing


Index: news.txt
===================================================================
RCS file: /home/cvsd/slony1/slony1-www/content/news.txt,v
retrieving revision 1.19
retrieving revision 1.20
diff -C2 -d -r1.19 -r1.20
*** news.txt	5 Jun 2007 16:39:58 -0000	1.19
--- news.txt	11 Jun 2007 17:55:22 -0000	1.20
***************
*** 10,13 ****
--- 10,31 ----
  <!-- Please keep this item at the top of the news list -->
  ---
+ Version 1.2.10 testing still under way
+ http://main.slony.info/downloads/1.2
+ 2007-06-11
+ Chris Browne
+ 
+ I have done further updates to documentation after discovering a
+ problem with compatibility of UPDATE FUNCTIONS with versions 8.1.0
+ thru 8.1.3.  Alas, you won't have much success running UPDATE
+ FUNCTIONS on those versions.
+ 
+ <P> Jan Wieck has made various casting changes throughout the code to
+ address a change in how version 8.3 handles the automatic casting of
+ string values.  This has resulted in my needing to run the latest CVS
+ thru a comprehensive set of cross-PG-version tests, again, because
+ there is a potential for this to break compatibility with elder
+ versions of PostgreSQL.  (Hopefully not, but we'd better test, hadn't
+ we...)
+ ---
  Sample of configuring Slony-I on Windows
  http://winpg.jp/~saito/Slony-I-sample/

From cbbrowne at lists.slony.info  Mon Jun 11 10:59:39 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Mon Jun 11 10:59:39 2007
Subject: [Slony1-commit] slony1-engine RELEASE INSTALL
Message-ID: <20070611175939.74CBD290BD9@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine
In directory main.slony.info:/tmp/cvs-serv13784

Modified Files:
      Tag: REL_1_2_STABLE
	RELEASE INSTALL 
Log Message:
Note incompatibility between 8.1.[0-3] and UPDATE FUNCTIONS; document
Jan's recent changes for 8.3 support


Index: RELEASE
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/RELEASE,v
retrieving revision 1.1.2.2
retrieving revision 1.1.2.3
diff -C2 -d -r1.1.2.2 -r1.1.2.3
*** RELEASE	5 Jun 2007 16:14:54 -0000	1.1.2.2
--- RELEASE	11 Jun 2007 17:59:37 -0000	1.1.2.3
***************
*** 39,42 ****
--- 39,52 ----
    of WAIT FOR EVENT
  
+ - Backpatch fixes for restricted text casts in 8.3
+ 
+   create_event() calls (notably, but they're not alone) need to be
+   augmented to cast data types expressly.
+ 
+ - PostgreSQL 8.3 is now a supported version for 1.2.10
+ 
+ - Discovered and documented a problem with UPDATE FUNCTIONS on
+   versions 8.1.[0-3].
+ 
  RELEASE 1.2.9
  

Index: INSTALL
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/INSTALL,v
retrieving revision 1.12
retrieving revision 1.12.2.1
diff -C2 -d -r1.12 -r1.12.2.1
*** INSTALL	17 Oct 2006 18:33:17 -0000	1.12
--- INSTALL	11 Jun 2007 17:59:37 -0000	1.12.2.1
***************
*** 4,10 ****
  $Id$
  
! Slony-I currently supports PostgreSQL 7.4.0 (and higher), 8.0.x, and
! 8.1.x.  There have also been changes made to support features expected
! in 8.2.
  
  Note that earlier versions supported versions in the 7.3.x series; as
--- 4,11 ----
  $Id$
  
! Slony-I currently supports PostgreSQL 7.4.0 (and higher), 8.0.x,
! 8.1.x, and 8.2.x.  There have also been changes made to support
! features expected in 8.3.  The "UPDATE FUNCTIONS" command has some
! problems on 8.1.0 thru 8.1.3; see the FAQ for how to cope with this.
  
  Note that earlier versions supported versions in the 7.3.x series; as

From cbbrowne at lists.slony.info  Tue Jun 12 11:14:34 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Jun 12 11:14:35 2007
Subject: [Slony1-commit] slony1-engine/tests/testmultiplemoves README
	generate_dml.sh init_subscribe_set.ik
Message-ID: <20070612181434.937512902B3@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/tests/testmultiplemoves
In directory main.slony.info:/tmp/cvs-serv4882

Modified Files:
      Tag: REL_1_2_STABLE
	README generate_dml.sh init_subscribe_set.ik 
Log Message:
test with multiple MOVE SET requests

- Cut down on amount of data generated to let the test run quicker
- Document properly that this involves 2 sets (not 10)


Index: README
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tests/testmultiplemoves/README,v
retrieving revision 1.2
retrieving revision 1.2.2.1
diff -C2 -d -r1.2 -r1.2.2.1
*** README	18 Aug 2006 18:59:40 -0000	1.2
--- README	12 Jun 2007 18:14:32 -0000	1.2.2.1
***************
*** 2,8 ****
  
  testmultiplemoves is a test that exercises MOVE SET on a 3 node
! cluster with 10 replication sets.
    
! The interesting bit is that it requests MOVE SET on all 10 sets...
  
  This may be expected to "stress" things such as...
--- 2,8 ----
  
  testmultiplemoves is a test that exercises MOVE SET on a 3 node
! cluster with 2 replication sets.
    
! The interesting bit is that it requests MOVE SET on all the sets...
  
  This may be expected to "stress" things such as...

Index: init_subscribe_set.ik
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tests/testmultiplemoves/init_subscribe_set.ik,v
retrieving revision 1.2.2.1
retrieving revision 1.2.2.2
diff -C2 -d -r1.2.2.1 -r1.2.2.2
*** init_subscribe_set.ik	27 Oct 2006 19:43:09 -0000	1.2.2.1
--- init_subscribe_set.ik	12 Jun 2007 18:14:32 -0000	1.2.2.2
***************
*** 1,2 ****
--- 1,4 ----
+ sleep (seconds=2);
+ 
  subscribe set (id=1, provider=1, receiver = 2, forward=yes);
  wait for event (origin=2, confirmed=1);

Index: generate_dml.sh
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tests/testmultiplemoves/generate_dml.sh,v
retrieving revision 1.3.2.2
retrieving revision 1.3.2.3
diff -C2 -d -r1.3.2.2 -r1.3.2.3
*** generate_dml.sh	2 Apr 2007 18:51:56 -0000	1.3.2.2
--- generate_dml.sh	12 Jun 2007 18:14:32 -0000	1.3.2.3
***************
*** 23,27 ****
  generate_initdata()
  {
!   numrows=$(random_number 50 1000)
    i=0;
    trippoint=`expr $numrows / 20`
--- 23,27 ----
  generate_initdata()
  {
!   numrows=$(random_number 150 200)
    i=0;
    trippoint=`expr $numrows / 20`

From cbbrowne at lists.slony.info  Tue Jun 12 11:18:53 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Jun 12 11:18:55 2007
Subject: [Slony1-commit] slony1-www/content news.txt
Message-ID: <20070612181853.D4088290013@main.slony.info>

Update of /home/cvsd/slony1/slony1-www/content
In directory main.slony.info:/tmp/cvs-serv4946

Modified Files:
	news.txt 
Log Message:
Status of 1.2.10


Index: news.txt
===================================================================
RCS file: /home/cvsd/slony1/slony1-www/content/news.txt,v
retrieving revision 1.20
retrieving revision 1.21
diff -C2 -d -r1.20 -r1.21
*** news.txt	11 Jun 2007 17:55:22 -0000	1.20
--- news.txt	12 Jun 2007 18:18:51 -0000	1.21
***************
*** 10,13 ****
--- 10,27 ----
  <!-- Please keep this item at the top of the news list -->
  ---
+ Version 1.2.10 - log shipping problem to solve
+ http://lists.slony.info/pipermail/slony1-bugs/2007-June/000017.html
+ 2007-06-12
+ Chris Browne
+ 
+ Alas, I found a problem with log shipping.  I wrote a test where I
+ surrounded a DDL_SCRIPT event with a series of STORE_TRIGGER events;
+ this led to a fairly wacky set of SYNC ID numbers getting generated.
+ (See the "testlogship" test in the tests area for details on the
+ test.)
+ 
+ Well, comprehensively breaking it hopefully leads to a comprehensive
+ fix...
+ ---
  Version 1.2.10 testing still under way
  http://main.slony.info/downloads/1.2

From cbbrowne at lists.slony.info  Tue Jun 12 11:21:12 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Jun 12 11:21:13 2007
Subject: [Slony1-commit] slony1-www/content news.txt
Message-ID: <20070612182112.9218C2903BF@main.slony.info>

Update of /home/cvsd/slony1/slony1-www/content
In directory main.slony.info:/tmp/cvs-serv5006/content

Modified Files:
	news.txt 
Log Message:
Add in some good news


Index: news.txt
===================================================================
RCS file: /home/cvsd/slony1/slony1-www/content/news.txt,v
retrieving revision 1.21
retrieving revision 1.22
diff -C2 -d -r1.21 -r1.22
*** news.txt	12 Jun 2007 18:18:51 -0000	1.21
--- news.txt	12 Jun 2007 18:21:10 -0000	1.22
***************
*** 21,26 ****
  test.)
  
! Well, comprehensively breaking it hopefully leads to a comprehensive
! fix...
  ---
  Version 1.2.10 testing still under way
--- 21,29 ----
  test.)
  
! <P> Well, comprehensively breaking it hopefully leads to a
! comprehensive fix...
! 
! <P> In more positive news, the test called "testmultiplemoves" seems
! to be working well, so there's more testing taking place than ever...
  ---
  Version 1.2.10 testing still under way

From cbbrowne at lists.slony.info  Tue Jun 12 11:28:23 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Jun 12 11:28:24 2007
Subject: [Slony1-commit] slony1-www/content frontpage.txt news.txt
Message-ID: <20070612182823.E9BB6290013@main.slony.info>

Update of /home/cvsd/slony1/slony1-www/content
In directory main.slony.info:/tmp/cvs-serv5071/content

Modified Files:
	frontpage.txt news.txt 
Log Message:
Move release notes for 1.2.10 into main page content on front page.


Index: frontpage.txt
===================================================================
RCS file: /home/cvsd/slony1/slony1-www/content/frontpage.txt,v
retrieving revision 1.8
retrieving revision 1.9
diff -C2 -d -r1.8 -r1.9
*** frontpage.txt	27 Mar 2007 12:25:59 -0000	1.8
--- frontpage.txt	12 Jun 2007 18:28:21 -0000	1.9
***************
*** 1,3 ****
--- 1,69 ----
  ---
+ Slony-I Release approaching readiness - 1.2.10
+ http://main.slony.info/downloads/1.2
+ 2007-06-05
+ Chris Browne
+ 
+ Here are the release notes as they stand now; there are some issues
+ still outstanding with respect to <a
+ href="http://main.slony.info/documentation/logshipping.html"> log
+ shipping.</a>
+ 
+ <h2>RELEASE 1.2.10</h2>
+ 
+ <ol>
+ <li>Fixed problem with EXECUTE SCRIPT (EXECUTE ONLY ON = [node])
+ 
+   <P> The script was being executed on too many nodes...
+ 
+ <li> Added a test script for log shipping
+ 
+   <P> ... And alter it to add invocation of a DDL script.  This
+   allows testing for an event-counting problem in log shipping.
+ 
+ <li> Changes to support PostgreSQL 8.3 as VARATT_SIZEP has been deprecated
+ 
+ <li> in xxid.c, changes to support PostgreSQL 8.3 as tuple compression has
+   more extensive support
+ 
+ <P>  <tt>VARDATA_ANY( PG_DETOAST_DATUM_PACKED( (PG_GETARG_DATUM(0))))</tt>
+   tends to replace
+   <tt>PG_GETARG_VARLENA(0)</tt>
+ 
+ <li> Slonik's SYNC command never recorded the new seqno in the admin
+   conninfo, with potential wacky results for WAIT FOR EVENT
+ 
+ <li> Fix rpm build problem when the system has pg_config in both under
+   /usr/local/pgsql/bin and /usr/bin
+ 
+ <li> Add init script for Red Hat / Fedora
+ 
+ <li> Fix archive log ship tracking. Slon now tracks the setsync status in
+   memory and generates a void archive with the correct old,new event
+   seqno for all events.
+ 
+ <li> EXECUTE SCRIPT wasn't setting sl_setsync, which broke WAIT FOR EVENT
+   on these events
+ 
+ <li> Ducttape test #5 (which performs DDL changes) augmented to test use
+   of WAIT FOR EVENT
+ 
+ <li> Backpatch fixes for restricted text casts in 8.3
+ 
+ <P>  create_event() calls (notably, but they're not alone) need to be
+   augmented to cast data types expressly.
+ 
+ <li> PostgreSQL 8.3 is now a supported version for 1.2.10
+ 
+ <P>  The hope/intent is that 1.2.10 will be the last version of Slony-I
+   in the "1.x" series, and will permit upgrades to PostgreSQL 8.3.
+   The subsequent Slony-I 2.x series will require PostgreSQL 8.3.
+ 
+ <li> Discovered and documented a problem with UPDATE FUNCTIONS on
+ versions 8.1.[0-3].  Unfortunately, this means that these versions of
+ PostgreSQL essentially do not support Slony-I upgrades.
+ 
+ </ol>
+ ---
  Slony-I Release - 1.2.9
  http://main.slony.info/downloads/1.2

Index: news.txt
===================================================================
RCS file: /home/cvsd/slony1/slony1-www/content/news.txt,v
retrieving revision 1.22
retrieving revision 1.23
diff -C2 -d -r1.22 -r1.23
*** news.txt	12 Jun 2007 18:21:10 -0000	1.22
--- news.txt	12 Jun 2007 18:28:21 -0000	1.23
***************
*** 51,114 ****
  Here are <a href="http://winpg.jp/~saito/Slony-I-sample/">sample configuration files</a> for the usage of Slony-I 1.2.9 on Windows.
  ---
- Slony-I Release approaching readiness - 1.2.10
- http://main.slony.info/downloads/1.2
- 2007-06-05
- Chris Browne
- 
- Here are the release notes as they stand now; with Jan's commits over
- the last day, it looks like we have everything committed to resolve
- issues with EXECUTE SCRIPT and log shipping.
- 
- <P> I'll be doing some testing on my "platforms of interest" over the next
- couple of days; if others can run tests they care about, that would be
- a great thing.
- 
- <P> I plan to tag and release 1.2.10 by the end of the week; the hope is
- that this will be the final version in the 1.2 branch, as work now
- progresses on an 8.3-oriented "2.0" branch on HEAD.
- 
- -- chris
- 
- <h2>RELEASE 1.2.10</h2>
- 
- <ol>
- <li>Fixed problem with EXECUTE SCRIPT (EXECUTE ONLY ON = <node>)
- 
-   <P> The script was being executed on too many nodes...
- 
- <li> Added a test script for log shipping
- 
-   <P> ... And alter it to add invocation of a DDL script.  This
-   allows testing for an event-counting problem in log shipping.
- 
- <li> Changes to support PostgreSQL 8.3 as VARATT_SIZEP has been deprecated
- 
- <li> in xxid.c, changes to support PostgreSQL 8.3 as tuple compression has
-   more extensive support
- 
- <P>  <tt>VARDATA_ANY( PG_DETOAST_DATUM_PACKED( (PG_GETARG_DATUM(0))))</tt>
-   tends to replace
-   <tt>PG_GETARG_VARLENA(0)</tt>
- 
- <li> Slonik's SYNC command never recorded the new seqno in the admin
-   conninfo, with potential wacky results for WAIT FOR EVENT
- 
- <li> Fix rpm build problem when the system has pg_config in both under
-   /usr/local/pgsql/bin and /usr/bin
- 
- <li> Add init script for Red Hat / Fedora
- 
- <li> Fix archive log ship tracking. Slon now tracks the setsync status in
-   memory and generates a void archive with the correct old,new event
-   seqno for all events.
- 
- <li> EXECUTE SCRIPT wasn't setting sl_setsync, which broke WAIT FOR EVENT
-   on these events
- 
- <li> Ducttape test #5 (which performs DDL changes) augmented to test use
-   of WAIT FOR EVENT
- 
- </ol>
- ---
  Slony-I Release - 1.2.9
  http://main.slony.info/downloads/1.2
--- 51,54 ----

From devrim at lists.slony.info  Tue Jun 12 14:44:07 2007
From: devrim at lists.slony.info (Devrim GUNDUZ)
Date: Tue Jun 12 14:44:09 2007
Subject: [Slony1-commit] slony1-engine postgresql-slony1-engine.spec.in
Message-ID: <20070612214407.8E4EA290013@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine
In directory main.slony.info:/tmp/cvs-serv6189

Modified Files:
      Tag: REL_1_2_STABLE
	postgresql-slony1-engine.spec.in 
Log Message:
- Update to 1.2.10
- Add BuildRequires for docs subpackage, per #199154 (Thanks Ruben).



Index: postgresql-slony1-engine.spec.in
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/postgresql-slony1-engine.spec.in,v
retrieving revision 1.31.2.15
retrieving revision 1.31.2.16
diff -C2 -d -r1.31.2.15 -r1.31.2.16
*** postgresql-slony1-engine.spec.in	10 Jun 2007 21:26:11 -0000	1.31.2.15
--- postgresql-slony1-engine.spec.in	12 Jun 2007 21:44:05 -0000	1.31.2.16
***************
*** 9,13 ****
  Name:		@PACKAGE_NAME@
  Version:	@PACKAGE_VERSION@
! Release:	2_PG%{pg_version}%{?dist}
  License:	BSD
  Group:		Applications/Databases
--- 9,13 ----
  Name:		@PACKAGE_NAME@
  Version:	@PACKAGE_VERSION@
! Release:	1_PG%{pg_version}%{?dist}
  License:	BSD
  Group:		Applications/Databases
***************
*** 73,77 ****
  CFLAGS=`echo $CFLAGS|xargs -n 1|grep -v ffast-math|xargs -n 100`
  export LIBNAME=%{_lib}
! ./configure --includedir %{_includedir}/pgsql --with-pgconfigdir=%{_bindir} --libdir=%{_libdir} \
  %if %perltools
  	--with-perltools=%{_bindir} --with-toolsbin=%{_bindir} \
--- 73,77 ----
  CFLAGS=`echo $CFLAGS|xargs -n 1|grep -v ffast-math|xargs -n 100`
  export LIBNAME=%{_lib}
! %configure --includedir %{_includedir}/pgsql --with-pgconfigdir=%{_bindir} --libdir=%{_libdir} \
  %if %perltools
  	--with-perltools=%{_bindir} --with-toolsbin=%{_bindir} \
***************
*** 80,84 ****
  	--with-docs --with-docdir=%{_docdir}/%{name}-%{version} \
  %endif
! 	--datadir %{_datadir}/pgsql --sysconfdir=%{_sysconfdir} --with-pglibdir=%{_libdir}/pgsql 
  
  autoconf
--- 80,84 ----
  	--with-docs --with-docdir=%{_docdir}/%{name}-%{version} \
  %endif
! 	--datadir %{_datadir}/pgsql --with-pglibdir=%{_libdir}/pgsql 
  
  autoconf
***************
*** 97,101 ****
  install -m 0755 src/backend/slony1_funcs.so %{buildroot}%{_libdir}/pgsql/slony1_funcs.so
  install -m 0755 src/xxid/xxid.so %{buildroot}%{_libdir}/pgsql/xxid.so
! install -m 0644 src/backend/*.sql %{buildroot}%{_datadir}/pgsql/
  install -m 0644 src/xxid/*.sql %{buildroot}%{_datadir}/pgsql/
  install -m 0755 tools/*.sh  %{buildroot}%{_bindir}/
--- 97,101 ----
  install -m 0755 src/backend/slony1_funcs.so %{buildroot}%{_libdir}/pgsql/slony1_funcs.so
  install -m 0755 src/xxid/xxid.so %{buildroot}%{_libdir}/pgsql/xxid.so
! 	install -m 0644 src/backend/*.sql %{buildroot}%{_datadir}/pgsql/
  install -m 0644 src/xxid/*.sql %{buildroot}%{_datadir}/pgsql/
  install -m 0755 tools/*.sh  %{buildroot}%{_bindir}/
***************
*** 167,170 ****
--- 167,176 ----
  
  %changelog
+ * Wed Jun 13 2007 Devrim Gunduz <devrim@CommandPrompt.com> 1.2.10-1
+ - Update to 1.2.10
+ 
+ * Mon Jun 11 2007 Devrim Gunduz <devrim@CommandPrompt.com> 1.2.9-3
+ - Add BuildRequires for docs subpackage, per #199154 (Thanks Ruben).
+ 
  * Sun Jun 3 2007 Devrim Gunduz <devrim@CommandPrompt.com> 1.2.9-2
  - Some more fixes for Fedora review.

From devrim at lists.slony.info  Tue Jun 12 14:49:17 2007
From: devrim at lists.slony.info (Devrim GUNDUZ)
Date: Tue Jun 12 14:49:18 2007
Subject: [Slony1-commit] slony1-engine postgresql-slony1-engine.spec.in
Message-ID: <20070612214917.AD3FE29028B@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine
In directory main.slony.info:/tmp/cvs-serv6243

Modified Files:
      Tag: REL_1_2_STABLE
	postgresql-slony1-engine.spec.in 
Log Message:
Remove tab


Index: postgresql-slony1-engine.spec.in
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/postgresql-slony1-engine.spec.in,v
retrieving revision 1.31.2.16
retrieving revision 1.31.2.17
diff -C2 -d -r1.31.2.16 -r1.31.2.17
*** postgresql-slony1-engine.spec.in	12 Jun 2007 21:44:05 -0000	1.31.2.16
--- postgresql-slony1-engine.spec.in	12 Jun 2007 21:49:15 -0000	1.31.2.17
***************
*** 97,101 ****
  install -m 0755 src/backend/slony1_funcs.so %{buildroot}%{_libdir}/pgsql/slony1_funcs.so
  install -m 0755 src/xxid/xxid.so %{buildroot}%{_libdir}/pgsql/xxid.so
! 	install -m 0644 src/backend/*.sql %{buildroot}%{_datadir}/pgsql/
  install -m 0644 src/xxid/*.sql %{buildroot}%{_datadir}/pgsql/
  install -m 0755 tools/*.sh  %{buildroot}%{_bindir}/
--- 97,101 ----
  install -m 0755 src/backend/slony1_funcs.so %{buildroot}%{_libdir}/pgsql/slony1_funcs.so
  install -m 0755 src/xxid/xxid.so %{buildroot}%{_libdir}/pgsql/xxid.so
! install -m 0644 src/backend/*.sql %{buildroot}%{_datadir}/pgsql/
  install -m 0644 src/xxid/*.sql %{buildroot}%{_datadir}/pgsql/
  install -m 0755 tools/*.sh  %{buildroot}%{_bindir}/

From cbbrowne at lists.slony.info  Wed Jun 13 08:56:15 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Wed Jun 13 08:56:16 2007
Subject: [Slony1-commit] slony1-engine/tools slony1_dump.sh
Message-ID: <20070613155615.35FDD2903B0@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/tools
In directory main.slony.info:/tmp/cvs-serv10219/tools

Modified Files:
      Tag: REL_1_2_STABLE
	slony1_dump.sh 
Log Message:
Patch to slony1_dump.sh per <stephane.schildknecht@postgresqlfr.org>

Put "E" into "select E'\\\\\\\\.';" for better encoding a set of "\\backslashes\\"



Index: slony1_dump.sh
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tools/slony1_dump.sh,v
retrieving revision 1.8
retrieving revision 1.8.2.1
diff -C2 -d -r1.8 -r1.8.2.1
*** slony1_dump.sh	20 Jun 2006 18:48:07 -0000	1.8
--- slony1_dump.sh	13 Jun 2007 15:56:13 -0000	1.8.2.1
***************
*** 188,192 ****
  echo "select 'copy $clname.sl_sequence_offline from stdin;';"
  echo "select seq_id::text || '	' || seq_relname  || '	' || seq_nspname from $clname.sl_sequence;"
! printf "select '\\\\\\\\.';"
  
  for seq in $sequences ; do
--- 188,192 ----
  echo "select 'copy $clname.sl_sequence_offline from stdin;';"
  echo "select seq_id::text || '	' || seq_relname  || '	' || seq_nspname from $clname.sl_sequence;"
! printf "select E'\\\\\\\\.';"
  
  for seq in $sequences ; do
***************
*** 211,220 ****
  for tab in $tables ; do
  	eval tabname=\$tabname_$tab
- 
  	# Get fieldnames...
   	fields=`psql -At -c "select $clname.copyfields($tab);" $dbname`
   	echo "select 'copy $tabname $fields from stdin;';"
  	echo "copy $tabname $fields to stdout;"
!  	printf "select '\\\\\\\\.';"
  done
  
--- 211,219 ----
  for tab in $tables ; do
  	eval tabname=\$tabname_$tab
  	# Get fieldnames...
   	fields=`psql -At -c "select $clname.copyfields($tab);" $dbname`
   	echo "select 'copy $tabname $fields from stdin;';"
  	echo "copy $tabname $fields to stdout;"
!  	printf "select E'\\\\\\\\.';"
  done
  

From cbbrowne at lists.slony.info  Wed Jun 13 08:56:46 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Wed Jun 13 08:56:48 2007
Subject: [Slony1-commit] slony1-engine/tests/testlogship generate_dml.sh
Message-ID: <20070613155646.E046629028B@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/tests/testlogship
In directory main.slony.info:/tmp/cvs-serv10247/tests/testlogship

Modified Files:
      Tag: REL_1_2_STABLE
	generate_dml.sh 
Log Message:
Need to load DB schema into the log shipped node


Index: generate_dml.sh
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tests/testlogship/generate_dml.sh,v
retrieving revision 1.1.2.2
retrieving revision 1.1.2.3
diff -C2 -d -r1.1.2.2 -r1.1.2.3
*** generate_dml.sh	20 Apr 2007 21:40:02 -0000	1.1.2.2
--- generate_dml.sh	13 Jun 2007 15:56:44 -0000	1.1.2.3
***************
*** 87,90 ****
--- 87,92 ----
    status "pull log shipping dump" 
    PGHOST=${HOST2} PGPORT=${PORT2} PGUSER=${USER2} ${SLTOOLDIR}/slony1_dump.sh ${DB2} ${CLUSTER1} > ${mktmp}/logship_dump.sql
+   status "load schema for replicated tables into node #3"
+   ${PGBINDIR3}/psql -h ${HOST3} -p ${PORT3} -U ${USER3} -d ${DB3} -f ${testname}/init_schema.sql
    status "load log shipping dump into node #3"
    ${PGBINDIR3}/psql -h ${HOST3} -p ${PORT3} -U ${USER3} -d ${DB3} -f ${mktmp}/logship_dump.sql

From cbbrowne at lists.slony.info  Wed Jun 13 08:58:34 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Wed Jun 13 08:58:35 2007
Subject: [Slony1-commit] slony1-engine/tests support_funcs.sh
Message-ID: <20070613155834.8CFC22903B0@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/tests
In directory main.slony.info:/tmp/cvs-serv10276/tests

Modified Files:
      Tag: REL_1_2_STABLE
	support_funcs.sh 
Log Message:
Use C binaries if they are executable, not merely if they seem to exist


Index: support_funcs.sh
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tests/support_funcs.sh,v
retrieving revision 1.4.2.2
retrieving revision 1.4.2.3
diff -C2 -d -r1.4.2.2 -r1.4.2.3
*** support_funcs.sh	6 Jun 2007 22:21:14 -0000	1.4.2.2
--- support_funcs.sh	13 Jun 2007 15:58:32 -0000	1.4.2.3
***************
*** 88,92 ****
    _upperbound=$2
  
!   if [ -e ./random_number ] ; then
      rannum=`./random_number ${_lowerbound} ${_upperbound}`
    else
--- 88,92 ----
    _upperbound=$2
  
!   if [ -x ./random_number ] ; then
      rannum=`./random_number ${_lowerbound} ${_upperbound}`
    else
***************
*** 127,131 ****
  
    _length=$1
!   if [ -e ./random_string ] ; then
      rannum=`./random_string ${_length}`
    else
--- 127,131 ----
  
    _length=$1
!   if [ -x ./random_string ] ; then
      rannum=`./random_string ${_length}`
    else

From cbbrowne at lists.slony.info  Wed Jun 13 09:01:08 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Wed Jun 13 09:01:09 2007
Subject: [Slony1-commit] slony1-www/content frontpage.txt
Message-ID: <20070613160108.C66072903C5@main.slony.info>

Update of /home/cvsd/slony1/slony1-www/content
In directory main.slony.info:/tmp/cvs-serv10320/content

Modified Files:
	frontpage.txt 
Log Message:
More in release notes


Index: frontpage.txt
===================================================================
RCS file: /home/cvsd/slony1/slony1-www/content/frontpage.txt,v
retrieving revision 1.9
retrieving revision 1.10
diff -C2 -d -r1.9 -r1.10
*** frontpage.txt	12 Jun 2007 18:28:21 -0000	1.9
--- frontpage.txt	13 Jun 2007 16:01:06 -0000	1.10
***************
*** 64,67 ****
--- 64,72 ----
  PostgreSQL essentially do not support Slony-I upgrades.
  
+ <li> Fixes to log shipping test
+ 
+ <li> Change to tools/slony1_dump.sh (used to generate log shipping dump);
+   change quoting of "\\\backslashes\\\" to get rid of warning
+ 
  </ol>
  ---

From cbbrowne at lists.slony.info  Wed Jun 13 09:01:51 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Wed Jun 13 09:01:52 2007
Subject: [Slony1-commit] slony1-engine RELEASE
Message-ID: <20070613160151.BDA5D290369@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine
In directory main.slony.info:/tmp/cvs-serv10372

Modified Files:
      Tag: REL_1_2_STABLE
	RELEASE 
Log Message:
Document more 1.2.10 changes in release notes


Index: RELEASE
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/RELEASE,v
retrieving revision 1.1.2.3
retrieving revision 1.1.2.4
diff -C2 -d -r1.1.2.3 -r1.1.2.4
*** RELEASE	11 Jun 2007 17:59:37 -0000	1.1.2.3
--- RELEASE	13 Jun 2007 16:01:49 -0000	1.1.2.4
***************
*** 46,52 ****
--- 46,61 ----
  - PostgreSQL 8.3 is now a supported version for 1.2.10
  
+   The hope/intent is that 1.2.10 will be the last version of Slony-I
+   in the "1.x" series, and will permit upgrades to PostgreSQL 8.3.
+   The subsequent Slony-I 2.x series will require PostgreSQL 8.3.
+ 
  - Discovered and documented a problem with UPDATE FUNCTIONS on
    versions 8.1.[0-3].
  
+ - Fixes to log shipping test
+ 
+ - Change to tools/slony1_dump.sh (used to generate log shipping dump);
+   change quoting of "\\\backslashes\\\" to get rid of warning
+ 
  RELEASE 1.2.9
  

From cbbrowne at lists.slony.info  Wed Jun 13 09:26:56 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Wed Jun 13 09:26:56 2007
Subject: [Slony1-commit] slony1-www/content frontpage.txt
Message-ID: <20070613162656.345242903CF@main.slony.info>

Update of /home/cvsd/slony1/slony1-www/content
In directory main.slony.info:/tmp/cvs-serv10743/content

Modified Files:
	frontpage.txt 
Log Message:
Note 1.2.10-pre tarball availability


Index: frontpage.txt
===================================================================
RCS file: /home/cvsd/slony1/slony1-www/content/frontpage.txt,v
retrieving revision 1.10
retrieving revision 1.11
diff -C2 -d -r1.10 -r1.11
*** frontpage.txt	13 Jun 2007 16:01:06 -0000	1.10
--- frontpage.txt	13 Jun 2007 16:26:54 -0000	1.11
***************
*** 1,3 ****
--- 1,20 ----
  ---
+ Slony-I 1.2.10 pre-release tarball uploaded
+ http://lists.slony.info/downloads/1.2/slony1-1.2.10-pre.tar.bz2
+ 2007-06-13
+ Chris Browne
+ 
+ I have uploaded a tarball for 1.2.10 as it stands now.  It still has a
+ <a href="http://main.slony.info/documentation/logshipping.html"> log
+ shipping</a> issue; that shouldn't prevent people from doing compile
+ testing on extra platforms or other verification not directly related
+ to log shipping.
+ 
+ <P> Please <i>do not</i> release binaries based on this tarball; that
+ could lead to the regrettable situation of people downloading
+ something that isn't the true final release of 1.2.10.  The license
+ permits such things, but please wait until the final release of 1.2.10
+ is tagged and available...
+ ---
  Slony-I Release approaching readiness - 1.2.10
  http://main.slony.info/downloads/1.2

From cbbrowne at lists.slony.info  Wed Jun 13 15:00:43 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Wed Jun 13 15:00:44 2007
Subject: [Slony1-commit] slony1-www/content frontpage.txt
Message-ID: <20070613220043.6ABCD2903C5@main.slony.info>

Update of /home/cvsd/slony1/slony1-www/content
In directory main.slony.info:/tmp/cvs-serv13365/content

Modified Files:
	frontpage.txt 
Log Message:
Fix URL for 1.2.10-pre download


Index: frontpage.txt
===================================================================
RCS file: /home/cvsd/slony1/slony1-www/content/frontpage.txt,v
retrieving revision 1.11
retrieving revision 1.12
diff -C2 -d -r1.11 -r1.12
*** frontpage.txt	13 Jun 2007 16:26:54 -0000	1.11
--- frontpage.txt	13 Jun 2007 22:00:41 -0000	1.12
***************
*** 1,5 ****
  ---
  Slony-I 1.2.10 pre-release tarball uploaded
! http://lists.slony.info/downloads/1.2/slony1-1.2.10-pre.tar.bz2
  2007-06-13
  Chris Browne
--- 1,5 ----
  ---
  Slony-I 1.2.10 pre-release tarball uploaded
! http://lists.slony.info/downloads/1.2/source/slony1-1.2.10-pre.tar.bz2
  2007-06-13
  Chris Browne

From cbbrowne at lists.slony.info  Thu Jun 14 07:56:24 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Thu Jun 14 07:56:25 2007
Subject: [Slony1-commit] slony1-engine/src/slon slon.c
Message-ID: <20070614145624.BD7E92903AC@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slon
In directory main.slony.info:/tmp/cvs-serv17461

Modified Files:
      Tag: REL_1_2_STABLE
	slon.c 
Log Message:
This is required for MinGW+gcc.

- patch per Hiroshi Saito


Index: slon.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/slon.c,v
retrieving revision 1.66.2.5
retrieving revision 1.66.2.6
diff -C2 -d -r1.66.2.5 -r1.66.2.6
*** slon.c	13 Dec 2006 14:39:16 -0000	1.66.2.5
--- slon.c	14 Jun 2007 14:56:22 -0000	1.66.2.6
***************
*** 28,31 ****
--- 28,32 ----
  #include <winsock2.h>
  #include "port/win32service.h"
+ #define sleep(x) Sleep(x*1000)
  #endif
  

From cbbrowne at lists.slony.info  Thu Jun 14 07:58:56 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Thu Jun 14 07:58:57 2007
Subject: [Slony1-commit] slony1-engine/src/slon slon.c
Message-ID: <20070614145856.1C4522903BE@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slon
In directory main.slony.info:/tmp/cvs-serv17501

Modified Files:
	slon.c 
Log Message:
This is required for MinGW+gcc.

- patch per Hiroshi Saito


Index: slon.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/slon.c,v
retrieving revision 1.72
retrieving revision 1.73
diff -C2 -d -r1.72 -r1.73
*** slon.c	20 Apr 2007 20:53:18 -0000	1.72
--- slon.c	14 Jun 2007 14:58:54 -0000	1.73
***************
*** 28,31 ****
--- 28,32 ----
  #include <winsock2.h>
  #include "port/win32service.h"
+ #define sleep(x) Sleep(x*1000)
  #endif
  

From devrim at lists.slony.info  Thu Jun 14 08:02:22 2007
From: devrim at lists.slony.info (Devrim GUNDUZ)
Date: Thu Jun 14 08:02:24 2007
Subject: [Slony1-commit] slony1-engine postgresql-slony1-engine.spec.in
Message-ID: <20070614150222.BE9162902B3@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine
In directory main.slony.info:/tmp/cvs-serv17644

Modified Files:
      Tag: REL_1_2_STABLE
	postgresql-slony1-engine.spec.in 
Log Message:
A few more fixes (and yes, AFAICS we are almost close to final release). Will remove the word "pre" in the spec file before we roll stable release.


Index: postgresql-slony1-engine.spec.in
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/postgresql-slony1-engine.spec.in,v
retrieving revision 1.31.2.17
retrieving revision 1.31.2.18
diff -C2 -d -r1.31.2.17 -r1.31.2.18
*** postgresql-slony1-engine.spec.in	12 Jun 2007 21:49:15 -0000	1.31.2.17
--- postgresql-slony1-engine.spec.in	14 Jun 2007 15:02:20 -0000	1.31.2.18
***************
*** 54,65 ****
  %build
  
! # Temporary measure for 1.2.9
  %if %docs
! chmod 644 doc/concept/*
! chmod 644 doc/adminguide/*
! chmod 644 doc/implementation/*
! chmod 644 doc/howto/*
! chmod 644 doc/concept/*
! chmod 644 doc/support/*
  %endif
  
--- 54,60 ----
  %build
  
! # Temporary measure for 1.2.10-pre
  %if %docs
! chmod -R 644 doc/*
  %endif
  
***************
*** 126,129 ****
--- 121,125 ----
  /bin/rm -f %{buildroot}%{_bindir}/slon-tools
  /bin/rm -f %{buildroot}%{_bindir}/pgsql/slon-tools
+ /bin/rm -f %{buildroot}%{_bindir}/old-apache-rotatelogs.patch
  %endif
  
***************
*** 161,167 ****
  %if %docs
  %files docs
- %defattr(644,root,root,-)
  %attr(755,root,root) %{_docdir}/%{name}-%{version}
! %doc doc/adminguide  doc/concept  doc/howto  doc/implementation  doc/support
  %endif
  
--- 157,162 ----
  %if %docs
  %files docs
  %attr(755,root,root) %{_docdir}/%{name}-%{version}
! %attr(644,root,root) %doc doc/adminguide  doc/concept  doc/howto  doc/implementation  doc/support
  %endif
  

From wieck at lists.slony.info  Thu Jun 14 08:17:47 2007
From: wieck at lists.slony.info (Jan Wieck)
Date: Thu Jun 14 08:17:49 2007
Subject: [Slony1-commit] slony1-engine/src/slon remote_worker.c
Message-ID: <20070614151747.923A42903B0@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slon
In directory main.slony.info:/tmp/cvs-serv17874

Modified Files:
      Tag: REL_1_2_STABLE
	remote_worker.c 
Log Message:
On copy_set() check that we have forwarded the confirmation of 
ENABLE_SUBSCRIPTIOND by the data provider only if the data provider 
is not the origin of the set.

Jan


Index: remote_worker.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/remote_worker.c,v
retrieving revision 1.124.2.14
retrieving revision 1.124.2.15
diff -C2 -d -r1.124.2.14 -r1.124.2.15
*** remote_worker.c	31 May 2007 13:29:48 -0000	1.124.2.14
--- remote_worker.c	14 Jun 2007 15:17:45 -0000	1.124.2.15
***************
*** 1195,1199 ****
  						 * synced up far enough.
  						 */
! 						if (event->event_provider != sub_provider)
  						{
  							int64		prov_seqno = get_last_forwarded_confirm(
--- 1195,1200 ----
  						 * synced up far enough.
  						 */
! 						if (event->ev_origin != sub_provider &&
! 							event->event_provider != sub_provider)
  						{
  							int64		prov_seqno = get_last_forwarded_confirm(

From wieck at lists.slony.info  Thu Jun 14 08:17:57 2007
From: wieck at lists.slony.info (Jan Wieck)
Date: Thu Jun 14 08:17:57 2007
Subject: [Slony1-commit] slony1-engine/src/slon remote_worker.c
Message-ID: <20070614151757.57A5A2903B0@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slon
In directory main.slony.info:/tmp/cvs-serv17889

Modified Files:
	remote_worker.c 
Log Message:
On copy_set() check that we have forwarded the confirmation of 
ENABLE_SUBSCRIPTIOND by the data provider only if the data provider 
is not the origin of the set.

Jan


Index: remote_worker.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/remote_worker.c,v
retrieving revision 1.143
retrieving revision 1.144
diff -C2 -d -r1.143 -r1.144
*** remote_worker.c	7 Jun 2007 13:01:10 -0000	1.143
--- remote_worker.c	14 Jun 2007 15:17:55 -0000	1.144
***************
*** 1194,1198 ****
  						 * synced up far enough.
  						 */
! 						if (event->event_provider != sub_provider)
  						{
  							int64		prov_seqno = get_last_forwarded_confirm(
--- 1194,1199 ----
  						 * synced up far enough.
  						 */
! 						if (event->ev_origin != sub_provider &&
! 							event->event_provider != sub_provider)
  						{
  							int64		prov_seqno = get_last_forwarded_confirm(

From cbbrowne at lists.slony.info  Mon Jun 18 10:25:25 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Mon Jun 18 10:25:28 2007
Subject: [Slony1-commit] slony1-engine GNUmakefile.in RELEASE
Message-ID: <20070618172525.BA9FA2903AC@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine
In directory main.slony.info:/tmp/cvs-serv12069

Modified Files:
      Tag: REL_1_2_STABLE
	GNUmakefile.in RELEASE 
Log Message:
Add additional cleanup (of .cvsignore files) to "make distclean"

Add documentation of recent changes to RELEASE notes


Index: RELEASE
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/RELEASE,v
retrieving revision 1.1.2.4
retrieving revision 1.1.2.5
diff -C2 -d -r1.1.2.4 -r1.1.2.5
*** RELEASE	13 Jun 2007 16:01:49 -0000	1.1.2.4
--- RELEASE	18 Jun 2007 17:25:23 -0000	1.1.2.5
***************
*** 58,61 ****
--- 58,69 ----
    change quoting of "\\\backslashes\\\" to get rid of warning
  
+ - Win32 fix for MinGW+gcc
+ 
+ - cvs distclean changed to clean the build up more...
+ 
+ - On copy_set() check that we have forwarded the confirmation of
+ ENABLE_SUBSCRIPTION by the data provider only if the data provider is
+ not the origin of the set.
+ 
  RELEASE 1.2.9
  

Index: GNUmakefile.in
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/GNUmakefile.in,v
retrieving revision 1.29
retrieving revision 1.29.2.1
diff -C2 -d -r1.29 -r1.29.2.1
*** GNUmakefile.in	2 Aug 2006 15:32:01 -0000	1.29
--- GNUmakefile.in	18 Jun 2007 17:25:23 -0000	1.29.2.1
***************
*** 38,41 ****
--- 38,45 ----
    $(wildcard makefiles/*)
  
+ CVSIGNORES = doc/implementation/.cvsignore doc/concept/.cvsignore \
+ 	src/ducttape/.cvsignore src/xxid/.cvsignore \
+ 	src/slon/.cvsignore src/slonik/.cvsignore src/backend/.cvsignore \
+ 	.cvsignore
  
  all:
***************
*** 65,68 ****
--- 69,74 ----
  	rm -f postgres.imp
  	rm -rf autom4te.cache
+ 	rm -f $(CVSIGNORES)
+ 	chmod 0644 tests/one-offs/bug1538/README tools/configure-replication.txt
  
  maintainer-clean: distclean

From cbbrowne at lists.slony.info  Mon Jun 18 10:25:49 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Mon Jun 18 10:25:50 2007
Subject: [Slony1-commit] slony1-www/content frontpage.txt
Message-ID: <20070618172549.059962903C8@main.slony.info>

Update of /home/cvsd/slony1/slony1-www/content
In directory main.slony.info:/tmp/cvs-serv12111/content

Modified Files:
	frontpage.txt 
Log Message:
Update front page with latest release notes


Index: frontpage.txt
===================================================================
RCS file: /home/cvsd/slony1/slony1-www/content/frontpage.txt,v
retrieving revision 1.12
retrieving revision 1.13
diff -C2 -d -r1.12 -r1.13
*** frontpage.txt	13 Jun 2007 22:00:41 -0000	1.12
--- frontpage.txt	18 Jun 2007 17:25:46 -0000	1.13
***************
*** 86,89 ****
--- 86,97 ----
    change quoting of "\\\backslashes\\\" to get rid of warning
  
+ <li> Win32 fix for MinGW+gcc
+ 
+ <li> cvs distclean changed to clean the build up more
+ 
+ <li> On copy_set() check that we have forwarded the confirmation of
+ ENABLE_SUBSCRIPTION by the data provider only if the data provider is
+ not the origin of the set.
+ 
  </ol>
  ---

From xfade at lists.slony.info  Mon Jun 18 12:20:44 2007
From: xfade at lists.slony.info (Niels Breet)
Date: Mon Jun 18 12:20:46 2007
Subject: [Slony1-commit] slony1-www style.css
Message-ID: <20070618192044.BF59A29039F@main.slony.info>

Update of /home/cvsd/slony1/slony1-www
In directory main.slony.info:/tmp/cvs-serv13957

Modified Files:
	style.css 
Log Message:
Fix broken layout in archives.

Index: style.css
===================================================================
RCS file: /home/cvsd/slony1/slony1-www/style.css,v
retrieving revision 1.16
retrieving revision 1.17
diff -C2 -d -r1.16 -r1.17
*** style.css	20 Feb 2007 12:48:38 -0000	1.16
--- style.css	18 Jun 2007 19:20:42 -0000	1.17
***************
*** 223,226 ****
--- 223,228 ----
    white-space: -o-pre-wrap;    /* Opera 7 */
    word-wrap: break-word;       /* Internet Explorer 5.5+ */
+   display: block;
+   overflow: auto;
  }
  

From wieck at lists.slony.info  Tue Jun 19 08:51:21 2007
From: wieck at lists.slony.info (Jan Wieck)
Date: Tue Jun 19 08:51:23 2007
Subject: [Slony1-commit] slony1-engine/src/slon remote_worker.c
Message-ID: <20070619155121.28E6829034F@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slon
In directory main.slony.info:/tmp/cvs-serv22879

Modified Files:
      Tag: REL_1_2_STABLE
	remote_worker.c 
Log Message:
For logshipping we need to use the internally tracked ssy_seqno for
SYNC events as well.

Jan


Index: remote_worker.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/remote_worker.c,v
retrieving revision 1.124.2.15
retrieving revision 1.124.2.16
diff -C2 -d -r1.124.2.15 -r1.124.2.16
*** remote_worker.c	14 Jun 2007 15:17:45 -0000	1.124.2.15
--- remote_worker.c	19 Jun 2007 15:51:18 -0000	1.124.2.16
***************
*** 269,273 ****
  static void compress_actionseq(const char *ssy_actionseq, SlonDString * action_subquery);
  
! static int process_ddl_script(SlonWorkMsg_event * event,SlonNode * node,
  							  PGconn * local_dbconn, char * seqbuf );
  static int check_set_subscriber(int set_id, int node_id,PGconn * local_dbconn);
--- 269,273 ----
  static void compress_actionseq(const char *ssy_actionseq, SlonDString * action_subquery);
  
! static void process_ddl_script(SlonWorkMsg_event * event,SlonNode * node,
  							  PGconn * local_dbconn, char * seqbuf );
  static int check_set_subscriber(int set_id, int node_id,PGconn * local_dbconn);
***************
*** 4210,4221 ****
  			if (archive_dir)
  			{
  				slon_log(SLON_DEBUG2, "writing archive log...\n");
  				fflush(stderr);
  				fflush(stdout);
  				rc = archive_tracking(node, rtcfg_namespace, sub_set,
! 										 PQgetvalue(res1, tupno1, 1), seqbuf,
  										 event->ev_timestamp_c);
  				if (rc < 0)
  					slon_retry();
  			}
  		}
--- 4210,4233 ----
  			if (archive_dir)
  			{
+ 				for (pset = provider->set_head; pset; pset = pset->next)
+ 					if (pset->set_id == sub_set) break;
+ 				if (pset == NULL)
+ 				{
+ 					slon_log(SLON_ERROR, "remoteWorkerThread_%d: "
+ 							"set %d not found in runtime config\n",
+ 							node->no_id, sub_set);
+ 					slon_retry();
+ 				}
+ 
  				slon_log(SLON_DEBUG2, "writing archive log...\n");
  				fflush(stderr);
  				fflush(stdout);
  				rc = archive_tracking(node, rtcfg_namespace, sub_set,
! 										 pset->ssy_seqno, seqbuf,
  										 event->ev_timestamp_c);
  				if (rc < 0)
  					slon_retry();
+ 
+ 				strcpy(pset->ssy_seqno, seqbuf);
  			}
  		}
***************
*** 5976,5980 ****
   * Process a ddl_script command.
   */
! static int process_ddl_script(SlonWorkMsg_event * event,SlonNode * node,
  							  PGconn * local_dbconn,
  							  char * seqbuf) 
--- 5988,5993 ----
   * Process a ddl_script command.
   */
! static void
! process_ddl_script(SlonWorkMsg_event * event,SlonNode * node,
  							  PGconn * local_dbconn,
  							  char * seqbuf) 

From wieck at lists.slony.info  Tue Jun 19 12:14:51 2007
From: wieck at lists.slony.info (Jan Wieck)
Date: Tue Jun 19 12:14:53 2007
Subject: [Slony1-commit] slony1-engine/src/ducttape test_8_logship.in
Message-ID: <20070619191451.AD1E629039F@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/ducttape
In directory main.slony.info:/tmp/cvs-serv24212/src/ducttape

Modified Files:
	test_8_logship.in 
Log Message:
Let SYNC use the internally tracked ssy_seqno also for archive
logging.

Jan


Index: test_8_logship.in
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/ducttape/test_8_logship.in,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** test_8_logship.in	6 Jun 2007 16:20:55 -0000	1.3
--- test_8_logship.in	19 Jun 2007 19:14:49 -0000	1.4
***************
*** 285,291 ****
  	include <$PREAMBLE_FILE>;
  
! 	echo '**** waiting for DB2 to catch up';
! 	sync (id = 1);
! 	wait for event (origin = 1, confirmed = 2, wait on = 1);
  _EOF_
  echo "**** you can terminate the replication engines."
--- 285,292 ----
  	include <$PREAMBLE_FILE>;
  
! 	echo '**** waiting for node @sub1 to catch up';
! 	sync (id = @origin);
! 	wait for event (origin = @origin, confirmed = @sub1, 
! 			wait on = @origin, timeout = 0);
  _EOF_
  echo "**** you can terminate the replication engines."

From wieck at lists.slony.info  Tue Jun 19 12:14:51 2007
From: wieck at lists.slony.info (Jan Wieck)
Date: Tue Jun 19 12:14:53 2007
Subject: [Slony1-commit] slony1-engine/src/slon remote_worker.c
Message-ID: <20070619191451.C47382903AC@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slon
In directory main.slony.info:/tmp/cvs-serv24212/src/slon

Modified Files:
	remote_worker.c 
Log Message:
Let SYNC use the internally tracked ssy_seqno also for archive
logging.

Jan


Index: remote_worker.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/remote_worker.c,v
retrieving revision 1.144
retrieving revision 1.145
diff -C2 -d -r1.144 -r1.145
*** remote_worker.c	14 Jun 2007 15:17:55 -0000	1.144
--- remote_worker.c	19 Jun 2007 19:14:49 -0000	1.145
***************
*** 3969,3980 ****
  			if (archive_dir)
  			{
  				slon_log(SLON_DEBUG2, "writing archive log...\n");
  				fflush(stderr);
  				fflush(stdout);
  				rc = archive_tracking(node, rtcfg_namespace, sub_set,
! 										 PQgetvalue(res1, tupno1, 1), seqbuf,
  										 event->ev_timestamp_c);
  				if (rc < 0)
  					slon_retry();
  			}
  		}
--- 3969,3992 ----
  			if (archive_dir)
  			{
+ 				for (pset = provider->set_head; pset; pset = pset->next)
+ 					if (pset->set_id == sub_set) break;
+ 				if (pset == NULL)
+ 				{
+ 					slon_log(SLON_ERROR, "remoteWorkerThread_%d: "
+ 							"set %d not found in runtime config\n",
+ 							node->no_id, sub_set);
+ 					slon_retry();
+ 				}
+ 
  				slon_log(SLON_DEBUG2, "writing archive log...\n");
  				fflush(stderr);
  				fflush(stdout);
  				rc = archive_tracking(node, rtcfg_namespace, sub_set,
! 										 pset->ssy_seqno, seqbuf,
  										 event->ev_timestamp_c);
  				if (rc < 0)
  					slon_retry();
+ 
+ 				strcpy(pset->ssy_seqno, seqbuf);
  			}
  		}

From darcyb at lists.slony.info  Wed Jun 20 06:49:18 2007
From: darcyb at lists.slony.info (Darcy Buskermolen)
Date: Wed Jun 20 06:49:20 2007
Subject: [Slony1-commit] slony1-engine/doc/adminguide slonik_ref.sgml
Message-ID: <20070620134918.898662903A4@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/doc/adminguide
In directory main.slony.info:/tmp/cvs-serv30814

Modified Files:
	slonik_ref.sgml 
Log Message:
Change the example to act on the newly created set 999, instead of an 
unknown set 9999.


Index: slonik_ref.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/slonik_ref.sgml,v
retrieving revision 1.69
retrieving revision 1.70
diff -C2 -d -r1.69 -r1.70
*** slonik_ref.sgml	24 Apr 2007 16:27:01 -0000	1.69
--- slonik_ref.sgml	20 Jun 2007 13:49:16 -0000	1.70
***************
*** 1283,1287 ****
       WAIT FOR EVENT (ORIGIN = 3, CONFIRMED = 1);
       SYNC (ID=1);
!      MERGE SET ( ID = 1, ADD ID = 9999, ORIGIN = 1 );
      </programlisting>
     </refsect1>
--- 1283,1287 ----
       WAIT FOR EVENT (ORIGIN = 3, CONFIRMED = 1);
       SYNC (ID=1);
!      MERGE SET ( ID = 1, ADD ID = 999, ORIGIN = 1 );
      </programlisting>
     </refsect1>

From darcyb at lists.slony.info  Wed Jun 20 07:05:30 2007
From: darcyb at lists.slony.info (Darcy Buskermolen)
Date: Wed Jun 20 07:05:32 2007
Subject: [Slony1-commit] slony1-engine/doc/adminguide slonik_ref.sgml
Message-ID: <20070620140530.D488829041B@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/doc/adminguide
In directory main.slony.info:/tmp/cvs-serv31117

Modified Files:
      Tag: REL_1_2_STABLE
	slonik_ref.sgml 
Log Message:
Change the example to act on the newly created set 999, instead of an
unknown set 9999.


Index: slonik_ref.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/slonik_ref.sgml,v
retrieving revision 1.61.2.6
retrieving revision 1.61.2.7
diff -C2 -d -r1.61.2.6 -r1.61.2.7
*** slonik_ref.sgml	3 Apr 2007 21:55:03 -0000	1.61.2.6
--- slonik_ref.sgml	20 Jun 2007 14:05:28 -0000	1.61.2.7
***************
*** 1265,1269 ****
       WAIT FOR EVENT (ORIGIN = 3, CONFIRMED = 1);
       SYNC (ID=1);
!      MERGE SET ( ID = 1, ADD ID = 9999, ORIGIN = 1 );
      </programlisting>
     </refsect1>
--- 1265,1269 ----
       WAIT FOR EVENT (ORIGIN = 3, CONFIRMED = 1);
       SYNC (ID=1);
!      MERGE SET ( ID = 1, ADD ID = 999, ORIGIN = 1 );
      </programlisting>
     </refsect1>

From cbbrowne at lists.slony.info  Thu Jun 21 13:29:15 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Thu Jun 21 13:29:16 2007
Subject: [Slony1-commit] slony1-engine/tools slony1_dump.sh
Message-ID: <20070621202915.1563329041C@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/tools
In directory main.slony.info:/tmp/cvs-serv8221/tools

Modified Files:
      Tag: REL_1_2_STABLE
	slony1_dump.sh 
Log Message:
Updates to release notes to revert quoting change, and reverted 
change to slony1_dump.sh that was incompatible with 7.4


Index: slony1_dump.sh
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tools/slony1_dump.sh,v
retrieving revision 1.8.2.1
retrieving revision 1.8.2.2
diff -C2 -d -r1.8.2.1 -r1.8.2.2
*** slony1_dump.sh	13 Jun 2007 15:56:13 -0000	1.8.2.1
--- slony1_dump.sh	21 Jun 2007 20:29:13 -0000	1.8.2.2
***************
*** 188,192 ****
  echo "select 'copy $clname.sl_sequence_offline from stdin;';"
  echo "select seq_id::text || '	' || seq_relname  || '	' || seq_nspname from $clname.sl_sequence;"
! printf "select E'\\\\\\\\.';"
  
  for seq in $sequences ; do
--- 188,192 ----
  echo "select 'copy $clname.sl_sequence_offline from stdin;';"
  echo "select seq_id::text || '	' || seq_relname  || '	' || seq_nspname from $clname.sl_sequence;"
! printf "select '\\\\\\\\.';"
  
  for seq in $sequences ; do
***************
*** 215,219 ****
   	echo "select 'copy $tabname $fields from stdin;';"
  	echo "copy $tabname $fields to stdout;"
!  	printf "select E'\\\\\\\\.';"
  done
  
--- 215,219 ----
   	echo "select 'copy $tabname $fields from stdin;';"
  	echo "copy $tabname $fields to stdout;"
!  	printf "select '\\\\\\\\.';"
  done
  

From cbbrowne at lists.slony.info  Thu Jun 21 13:29:15 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Thu Jun 21 13:29:17 2007
Subject: [Slony1-commit] slony1-engine RELEASE
Message-ID: <20070621202915.126192903DF@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine
In directory main.slony.info:/tmp/cvs-serv8221

Modified Files:
      Tag: REL_1_2_STABLE
	RELEASE 
Log Message:
Updates to release notes to revert quoting change, and reverted 
change to slony1_dump.sh that was incompatible with 7.4


Index: RELEASE
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/RELEASE,v
retrieving revision 1.1.2.5
retrieving revision 1.1.2.6
diff -C2 -d -r1.1.2.5 -r1.1.2.6
*** RELEASE	18 Jun 2007 17:25:23 -0000	1.1.2.5
--- RELEASE	21 Jun 2007 20:29:12 -0000	1.1.2.6
***************
*** 55,61 ****
  - Fixes to log shipping test
  
- - Change to tools/slony1_dump.sh (used to generate log shipping dump);
-   change quoting of "\\\backslashes\\\" to get rid of warning
- 
  - Win32 fix for MinGW+gcc
  
--- 55,58 ----
***************
*** 63,68 ****
  
  - On copy_set() check that we have forwarded the confirmation of
! ENABLE_SUBSCRIPTION by the data provider only if the data provider is
! not the origin of the set.
  
  RELEASE 1.2.9
--- 60,70 ----
  
  - On copy_set() check that we have forwarded the confirmation of
!   ENABLE_SUBSCRIPTION by the data provider only if the data provider
!   is not the origin of the set.
! 
! - For logshipping we need to use the internally tracked ssy_seqno for
!   SYNC events as well.  
! 
!   This allows "run_test.sh testlogship" to run successfully!
  
  RELEASE 1.2.9

From andrew.george.hammond at gmail.com  Thu Jun 21 14:31:11 2007
From: andrew.george.hammond at gmail.com (Andrew Hammond)
Date: Thu Jun 21 14:31:23 2007
Subject: [Slony1-commit] slony1-engine/tools slony1_dump.sh
In-Reply-To: <20070621202915.1563329041C@main.slony.info>
References: <20070621202915.1563329041C@main.slony.info>
Message-ID: <5a0a9d6f0706211431wdbc2ce9j90df06be31fbdda7@mail.gmail.com>

Is there some reason we're just reversing this patch instead of
following Jan's suggestion and detecting which version of Postgres
we're talking to and doing the Right Thing?

Andrew


On 6/21/07, Chris Browne <cbbrowne@lists.slony.info> wrote:
> Update of /home/cvsd/slony1/slony1-engine/tools
> In directory main.slony.info:/tmp/cvs-serv8221/tools
>
> Modified Files:
>       Tag: REL_1_2_STABLE
>         slony1_dump.sh
> Log Message:
> Updates to release notes to revert quoting change, and reverted
> change to slony1_dump.sh that was incompatible with 7.4
>
>
> Index: slony1_dump.sh
> ===================================================================
> RCS file: /home/cvsd/slony1/slony1-engine/tools/slony1_dump.sh,v
> retrieving revision 1.8.2.1
> retrieving revision 1.8.2.2
> diff -C2 -d -r1.8.2.1 -r1.8.2.2
> *** slony1_dump.sh      13 Jun 2007 15:56:13 -0000      1.8.2.1
> --- slony1_dump.sh      21 Jun 2007 20:29:13 -0000      1.8.2.2
> ***************
> *** 188,192 ****
>   echo "select 'copy $clname.sl_sequence_offline from stdin;';"
>   echo "select seq_id::text || '        ' || seq_relname  || '  ' || seq_nspname from $clname.sl_sequence;"
> ! printf "select E'\\\\\\\\.';"
>
>   for seq in $sequences ; do
> --- 188,192 ----
>   echo "select 'copy $clname.sl_sequence_offline from stdin;';"
>   echo "select seq_id::text || '        ' || seq_relname  || '  ' || seq_nspname from $clname.sl_sequence;"
> ! printf "select '\\\\\\\\.';"
>
>   for seq in $sequences ; do
> ***************
> *** 215,219 ****
>         echo "select 'copy $tabname $fields from stdin;';"
>         echo "copy $tabname $fields to stdout;"
> !       printf "select E'\\\\\\\\.';"
>   done
>
> --- 215,219 ----
>         echo "select 'copy $tabname $fields from stdin;';"
>         echo "copy $tabname $fields to stdout;"
> !       printf "select '\\\\\\\\.';"
>   done
>
>
> _______________________________________________
> Slony1-commit mailing list
> Slony1-commit@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-commit
>
From cbbrowne at lists.slony.info  Thu Jun 21 15:14:23 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Thu Jun 21 15:14:24 2007
Subject: [Slony1-commit] slony1-www/content frontpage.txt news.txt
Message-ID: <20070621221423.136FA2903CF@main.slony.info>

Update of /home/cvsd/slony1/slony1-www/content
In directory main.slony.info:/tmp/cvs-serv13607/content

Modified Files:
	frontpage.txt news.txt 
Log Message:
Released 1.2.10-pre2


Index: frontpage.txt
===================================================================
RCS file: /home/cvsd/slony1/slony1-www/content/frontpage.txt,v
retrieving revision 1.13
retrieving revision 1.14
diff -C2 -d -r1.13 -r1.14
*** frontpage.txt	18 Jun 2007 17:25:46 -0000	1.13
--- frontpage.txt	21 Jun 2007 22:14:21 -0000	1.14
***************
*** 1,19 ****
  ---
! Slony-I 1.2.10 pre-release tarball uploaded
! http://lists.slony.info/downloads/1.2/source/slony1-1.2.10-pre.tar.bz2
! 2007-06-13
  Chris Browne
  
! I have uploaded a tarball for 1.2.10 as it stands now.  It still has a
! <a href="http://main.slony.info/documentation/logshipping.html"> log
! shipping</a> issue; that shouldn't prevent people from doing compile
! testing on extra platforms or other verification not directly related
! to log shipping.
  
  <P> Please <i>do not</i> release binaries based on this tarball; that
  could lead to the regrettable situation of people downloading
  something that isn't the true final release of 1.2.10.  The license
! permits such things, but please wait until the final release of 1.2.10
! is tagged and available...
  ---
  Slony-I Release approaching readiness - 1.2.10
--- 1,21 ----
  ---
! Slony-I 1.2.10 pre-release tarball #2 uploaded
! http://lists.slony.info/downloads/1.2/source/slony1-1.2.10-pre2.tar.bz2
! 2007-06-21
  Chris Browne
  
! I have uploaded a tarball for 1.2.10 based on the fixes that have come
! in this week to <a href=
! "http://main.slony.info/documentation/logshipping.html"> log shipping
! </a>.
! 
! <P> I have run tests of this build on Debian/Unstable on the IA-32
! architecture against each of PostgreSQL 7.4, 8.0, 8.1, 8.2, and a
! recent copy of CVS HEAD (e.g. - 8.3).
  
  <P> Please <i>do not</i> release binaries based on this tarball; that
  could lead to the regrettable situation of people downloading
  something that isn't the true final release of 1.2.10.  The license
! permits such things, but <i>please</i> wait until we call this final...
  ---
  Slony-I Release approaching readiness - 1.2.10
***************
*** 83,89 ****
  <li> Fixes to log shipping test
  
- <li> Change to tools/slony1_dump.sh (used to generate log shipping dump);
-   change quoting of "\\\backslashes\\\" to get rid of warning
- 
  <li> Win32 fix for MinGW+gcc
  
--- 85,88 ----
***************
*** 94,97 ****
--- 93,101 ----
  not the origin of the set.
  
+ <li> For logshipping we need to use the internally tracked ssy_seqno for
+   SYNC events as well.
+ 
+   <P> This allows "run_test.sh testlogship" to run successfully!
+ 
  </ol>
  ---

Index: news.txt
===================================================================
RCS file: /home/cvsd/slony1/slony1-www/content/news.txt,v
retrieving revision 1.23
retrieving revision 1.24
diff -C2 -d -r1.23 -r1.24
*** news.txt	12 Jun 2007 18:28:21 -0000	1.23
--- news.txt	21 Jun 2007 22:14:21 -0000	1.24
***************
*** 10,13 ****
--- 10,32 ----
  <!-- Please keep this item at the top of the news list -->
  ---
+ Slony-I 1.2.10 pre-release tarball #2 uploaded
+ http://lists.slony.info/downloads/1.2/source/slony1-1.2.10-pre2.tar.bz2
+ 2007-06-21
+ Chris Browne
+ 
+ I have uploaded a tarball for 1.2.10 based on the fixes that have come
+ in this week to <a href=
+ "http://main.slony.info/documentation/logshipping.html"> log shipping
+ </a>.
+ 
+ <P> I have run tests of this build on Debian/Unstable on the IA-32
+ architecture against each of PostgreSQL 7.4, 8.0, 8.1, 8.2, and a
+ recent copy of CVS HEAD (e.g. - 8.3).
+ 
+ <P> Please <i>do not</i> release binaries based on this tarball; that
+ could lead to the regrettable situation of people downloading
+ something that isn't the true final release of 1.2.10.  The license
+ permits such things, but <i>please</i> wait until we call this final...
+ ---
  Version 1.2.10 - log shipping problem to solve
  http://lists.slony.info/pipermail/slony1-bugs/2007-June/000017.html

From cbbrowne at lists.slony.info  Thu Jun 21 15:15:47 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Thu Jun 21 15:15:48 2007
Subject: [Slony1-commit] slony1-www/content frontpage.txt
Message-ID: <20070621221547.AD6222903C6@main.slony.info>

Update of /home/cvsd/slony1/slony1-www/content
In directory main.slony.info:/tmp/cvs-serv13640/content

Modified Files:
	frontpage.txt 
Log Message:
More notes about 1.2.10-pre2


Index: frontpage.txt
===================================================================
RCS file: /home/cvsd/slony1/slony1-www/content/frontpage.txt,v
retrieving revision 1.14
retrieving revision 1.15
diff -C2 -d -r1.14 -r1.15
*** frontpage.txt	21 Jun 2007 22:14:21 -0000	1.14
--- frontpage.txt	21 Jun 2007 22:15:45 -0000	1.15
***************
*** 14,17 ****
--- 14,21 ----
  recent copy of CVS HEAD (e.g. - 8.3).
  
+ <P> If there are no negative reports about it, I anticipate that a
+ checkout insignificantly different from this will become the 1.2.10
+ release later this week.
+ 
  <P> Please <i>do not</i> release binaries based on this tarball; that
  could lead to the regrettable situation of people downloading

From cbbrowne at lists.slony.info  Fri Jun 22 08:29:09 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Fri Jun 22 08:29:11 2007
Subject: [Slony1-commit] slony1-engine SAMPLE
Message-ID: <20070622152909.92C762903AF@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine
In directory main.slony.info:/tmp/cvs-serv20839

Modified Files:
	SAMPLE 
Log Message:
Remove references to Slony-I-generated candidate PK as this functionality
has been dropped from version 2.


Index: SAMPLE
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/SAMPLE,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** SAMPLE	18 Apr 2007 15:03:51 -0000	1.3
--- SAMPLE	22 Jun 2007 15:29:07 -0000	1.4
***************
*** 44,53 ****
  As of this writing Slony-I does not attempt to automatically copy the
  table definitions when a node subscribes to a data set.  Because of this,
! we have to create one full and one schema-only pgbench database.
  
  createdb -O $PGBENCH_USER -h $HOST1 $DBNAME1
  createdb -O $PGBENCH_USER -h $HOST2 $DBNAME2
  pgbench -i -s 1 -U $PGBENCH_USER -h $HOST1 $DBNAME1
! pg_dump -s -U postgres -h $HOST1 $DBNAME1 | psql -U postgres -h $HOST2 $DBNAME2
  
  From this moment on, the pgbench test program can be started to
--- 44,58 ----
  As of this writing Slony-I does not attempt to automatically copy the
  table definitions when a node subscribes to a data set.  Because of this,
! we have to create one full and one schema-only pgbench database.  Note
! that we alter the pgbench table, "history", to give it a primary key.
! All tables must have a primary key (or a candidate thereof) defined
! for Slony-I to use.  The pgbench history table lacks this, so we add
! one in
  
  createdb -O $PGBENCH_USER -h $HOST1 $DBNAME1
  createdb -O $PGBENCH_USER -h $HOST2 $DBNAME2
  pgbench -i -s 1 -U $PGBENCH_USER -h $HOST1 $DBNAME1
! psql -U $PGBENCH_USER -h $HOST1 -d $DBNAME1 -c "begin; alter table history add column id serial; update history set id = nextval('history_id_seq'); alter table history add primary key(id); commit"
! pg_dump -s -U $SLONY_USER -h $HOST1 $DBNAME1 | psql -U $SLONY_USER -h $HOST2 $DBNAME2
  
  From this moment on, the pgbench test program can be started to
***************
*** 112,125 ****
  
      # ----
-     # The pgbench table history does not have a primary key or
-     # any other unique constraint that could be used to identify
-     # a row.  The following command adds a bigint column named
-     # "_Slony-I_test1_rowID" to the table.  It will have a default
-     # value of nextval('"_test1".sl_rowid_seq'), be unique and not
-     # null.  All existing rows will be initialized with a number.
-     # ----
-     table add key ( node id = 1, fully qualified name = 'public.history' );
- 
-     # ----
      # The Slony replication system organizes tables in sets.  The
      # smallest unit another node can subscribe is a set.  Usually the
--- 117,120 ----
***************
*** 141,145 ****
      set add table ( set id = 1, origin = 1,
          id = 4, fully qualified name = 'public.history',
-         key = serial,
          comment = 'Table history' );
  
--- 136,139 ----
***************
*** 266,271 ****
          from tellers order by tid;
      select 'history:'::text, tid, bid, aid, delta, mtime, filler,
!         "_Slony-I_${CLUSTER}_rowID"
!         from history order by "_Slony-I_${CLUSTER}_rowID";
  _EOF_
  psql -U $PGBENCH_USER -h $HOST2 $DBNAME2 >dump.tmp.2.$$ <<_EOF_
--- 260,265 ----
          from tellers order by tid;
      select 'history:'::text, tid, bid, aid, delta, mtime, filler,
!         id
!         from history order by id;
  _EOF_
  psql -U $PGBENCH_USER -h $HOST2 $DBNAME2 >dump.tmp.2.$$ <<_EOF_
***************
*** 277,282 ****
          from tellers order by tid;
      select 'history:'::text, tid, bid, aid, delta, mtime, filler,
!         "_Slony-I_${CLUSTER}_rowID"
!         from history order by "_Slony-I_${CLUSTER}_rowID";
  _EOF_
  
--- 271,276 ----
          from tellers order by tid;
      select 'history:'::text, tid, bid, aid, delta, mtime, filler,
!         id
!         from history order by id;
  _EOF_
  

From cbbrowne at lists.slony.info  Fri Jun 22 09:01:40 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Fri Jun 22 09:01:42 2007
Subject: [Slony1-commit] slony1-engine/doc/adminguide slonik_ref.sgml
Message-ID: <20070622160140.75D272903FE@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/doc/adminguide
In directory main.slony.info:/tmp/cvs-serv21064

Modified Files:
      Tag: REL_1_2_STABLE
	slonik_ref.sgml 
Log Message:
Cluster name does not need to be quoted.


Index: slonik_ref.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/slonik_ref.sgml,v
retrieving revision 1.61.2.7
retrieving revision 1.61.2.8
diff -C2 -d -r1.61.2.7 -r1.61.2.8
*** slonik_ref.sgml	20 Jun 2007 14:05:28 -0000	1.61.2.7
--- slonik_ref.sgml	22 Jun 2007 16:01:38 -0000	1.61.2.8
***************
*** 223,227 ****
      <cmdsynopsis>
       <command>CLUSTER NAME = </command>
!      <arg><replaceable class="parameter"> 'clustername';</replaceable></arg>
      </cmdsynopsis>
     </refsynopsisdiv>
--- 223,227 ----
      <cmdsynopsis>
       <command>CLUSTER NAME = </command>
!      <arg><replaceable class="parameter"> clustername;</replaceable></arg>
      </cmdsynopsis>
     </refsynopsisdiv>
***************
*** 251,255 ****
     <refsect1><title>Example</title>
      <programlisting>
!      CLUSTER NAME = 'testcluster';
      </programlisting>
     </refsect1>
--- 251,255 ----
     <refsect1><title>Example</title>
      <programlisting>
!      CLUSTER NAME = testcluster;
      </programlisting>
     </refsect1>

From cbbrowne at lists.slony.info  Fri Jun 22 09:11:10 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Fri Jun 22 09:11:11 2007
Subject: [Slony1-commit] slony1-engine/tools slony1_dump.sh
Message-ID: <20070622161110.A865D2903CE@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/tools
In directory main.slony.info:/tmp/cvs-serv21142/tools

Modified Files:
	slony1_dump.sh 
Log Message:
Change quoting of \\\\\backslashes\\\\\\ in slony1_dump.sh to suppress
warning messages


Index: slony1_dump.sh
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tools/slony1_dump.sh,v
retrieving revision 1.8
retrieving revision 1.9
diff -C2 -d -r1.8 -r1.9
*** slony1_dump.sh	20 Jun 2006 18:48:07 -0000	1.8
--- slony1_dump.sh	22 Jun 2007 16:11:08 -0000	1.9
***************
*** 188,192 ****
  echo "select 'copy $clname.sl_sequence_offline from stdin;';"
  echo "select seq_id::text || '	' || seq_relname  || '	' || seq_nspname from $clname.sl_sequence;"
! printf "select '\\\\\\\\.';"
  
  for seq in $sequences ; do
--- 188,192 ----
  echo "select 'copy $clname.sl_sequence_offline from stdin;';"
  echo "select seq_id::text || '	' || seq_relname  || '	' || seq_nspname from $clname.sl_sequence;"
! printf "select E'\\\\\\\\.';"
  
  for seq in $sequences ; do
***************
*** 216,220 ****
   	echo "select 'copy $tabname $fields from stdin;';"
  	echo "copy $tabname $fields to stdout;"
!  	printf "select '\\\\\\\\.';"
  done
  
--- 216,220 ----
   	echo "select 'copy $tabname $fields from stdin;';"
  	echo "copy $tabname $fields to stdout;"
!  	printf "select E'\\\\\\\\.';"
  done
  

From cbbrowne at lists.slony.info  Fri Jun 22 09:12:24 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Fri Jun 22 09:12:24 2007
Subject: [Slony1-commit] slony1-engine/tests settings.ik
Message-ID: <20070622161224.265AF2903D0@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/tests
In directory main.slony.info:/tmp/cvs-serv21178/tests

Modified Files:
	settings.ik 
Log Message:
Add in default identity (email address) of the tester; this will
eventually lead to automated collection of test results


Index: settings.ik
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tests/settings.ik,v
retrieving revision 1.6
retrieving revision 1.7
diff -C2 -d -r1.6 -r1.7
*** settings.ik	20 Apr 2007 21:43:14 -0000	1.6
--- settings.ik	22 Jun 2007 16:12:22 -0000	1.7
***************
*** 102,104 ****
  
  # Where to look for tools (e.g. - slony1_dump.sh)
! SLTOOLDIR=${SLTOOLDIR:-"../tools"}
\ No newline at end of file
--- 102,107 ----
  
  # Where to look for tools (e.g. - slony1_dump.sh)
! SLTOOLDIR=${SLTOOLDIR:-"../tools"}
! 
! # Email address of the tester
! SLONYTESTER=${SLONYTESTER:-"j.random.luser@example.net"}
\ No newline at end of file

From cbbrowne at lists.slony.info  Fri Jun 22 09:15:59 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Fri Jun 22 09:16:01 2007
Subject: [Slony1-commit] slony1-engine/doc/adminguide firstdb.sgml
	releasechecklist.sgml slonik_ref.sgml usingslonik.sgml
Message-ID: <20070622161559.849D52903CE@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/doc/adminguide
In directory main.slony.info:/tmp/cvs-serv21239

Modified Files:
	firstdb.sgml releasechecklist.sgml slonik_ref.sgml 
	usingslonik.sgml 
Log Message:
Eliminate various references to the now-not-supported TABLE ADD KEY
Slonik command.


Index: releasechecklist.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/releasechecklist.sgml,v
retrieving revision 1.9
retrieving revision 1.10
diff -C2 -d -r1.9 -r1.10
*** releasechecklist.sgml	16 Mar 2007 17:22:53 -0000	1.9
--- releasechecklist.sgml	22 Jun 2007 16:15:57 -0000	1.10
***************
*** 53,59 ****
  <filename>configure.ac</filename></para></listitem> 
  
! <listitem><para>Purge directory <filename>autom4te.cache</filename> so it is not included in the build  </para></listitem> 
  
! <listitem><para>Purge out .cvsignore files; this can be done with the command <command> find . -name .cvsignore | xargs rm </command>  </para></listitem> 
  <listitem><para> Run <filename>tools/release_checklist.sh</filename> </para>
  
--- 53,63 ----
  <filename>configure.ac</filename></para></listitem> 
  
! <listitem><para>Purge directory <filename>autom4te.cache</filename> so it is not included in the build  </para>
! <para> Does not need to be done by hand - the later <command> make distclean </command> step does this for you. </para>
! </listitem> 
  
! <listitem><para>Purge out .cvsignore files; this can be done with the command <command> find . -name .cvsignore | xargs rm </command>  </para>
! <para> Does not need to be done by hand - the later <command> make distclean </command> step does this for you. </para>
! </listitem> 
  <listitem><para> Run <filename>tools/release_checklist.sh</filename> </para>
  
***************
*** 96,99 ****
--- 100,106 ----
  make all && make clean</command> but that is a somewhat ugly approach.
  
+ <para> Slightly better may be <command> ./configure && make
+ src/slon/conf-file.c src/slonik/parser.c src/slonik/scan.c </command>
+ 
  </para></listitem> 
  
***************
*** 101,106 ****
  previous step(s) are removed.</para>
  
! <para> <command>make distclean</command> ought to do
! that... </para></listitem>
  
  <listitem><para>Generate HTML tarball, and RTF/PDF, if
--- 108,119 ----
  previous step(s) are removed.</para>
  
! <para> <command>make distclean</command> will do
! that... </para>
! 
! <para> Note that <command>make distclean</command> also clears out
! <filename>.cvsignore</filename> files and
! <filename>autom4te.cache</filename>, thus obsoleting some former steps
! that suggested that it was needful to delete them. </para>
! </listitem>
  
  <listitem><para>Generate HTML tarball, and RTF/PDF, if

Index: slonik_ref.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/slonik_ref.sgml,v
retrieving revision 1.70
retrieving revision 1.71
diff -C2 -d -r1.70 -r1.71
*** slonik_ref.sgml	20 Jun 2007 13:49:16 -0000	1.70
--- slonik_ref.sgml	22 Jun 2007 16:15:57 -0000	1.71
***************
*** 223,227 ****
      <cmdsynopsis>
       <command>CLUSTER NAME = </command>
!      <arg><replaceable class="parameter"> 'clustername';</replaceable></arg>
      </cmdsynopsis>
     </refsynopsisdiv>
--- 223,227 ----
      <cmdsynopsis>
       <command>CLUSTER NAME = </command>
!      <arg><replaceable class="parameter"> clustername;</replaceable></arg>
      </cmdsynopsis>
     </refsynopsisdiv>
***************
*** 251,255 ****
     <refsect1><title>Example</title>
      <programlisting>
!      CLUSTER NAME = 'testcluster';
      </programlisting>
     </refsect1>
--- 251,255 ----
     <refsect1><title>Example</title>
      <programlisting>
!      CLUSTER NAME = testcluster;
      </programlisting>
     </refsect1>
***************
*** 1090,1094 ****
      <para> This command was introduced in &slony1; 1.0 </para>
  
!     <para> This command is <emphasis> no longer supported </emphasis>
      as of &slony1; version 2.0.  In version 2, the various
      <quote>catalogue breakages</quote> done in &postgres; versions
--- 1090,1094 ----
      <para> This command was introduced in &slony1; 1.0 </para>
  
! <warning>    <para> This command is <emphasis> no longer supported </emphasis>
      as of &slony1; version 2.0.  In version 2, the various
      <quote>catalogue breakages</quote> done in &postgres; versions
***************
*** 1098,1102 ****
      thing that prevents <xref linkend="stmtuninstallnode"> from being
      comprised of the SQL statement <command>drop schema _ClusterName
!     cascade;</command>.</para>
  
     </refsect1>
--- 1098,1102 ----
      thing that prevents <xref linkend="stmtuninstallnode"> from being
      comprised of the SQL statement <command>drop schema _ClusterName
!     cascade;</command>.</para> </warning>
  
     </refsect1>

Index: usingslonik.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/usingslonik.sgml,v
retrieving revision 1.19
retrieving revision 1.20
diff -C2 -d -r1.19 -r1.20
*** usingslonik.sgml	11 Jun 2007 16:02:50 -0000	1.19
--- usingslonik.sgml	22 Jun 2007 16:15:57 -0000	1.20
***************
*** 112,123 ****
  
  	try {
- 		table add key (node id = 1, fully qualified name = 
-                                'public.history');
- 	}
- 	on error {
- 		exit 1;
- 	}
- 
- 	try {
  		create set (id = 1, origin = 1, comment = 
                              'Set 1 - pgbench tables');
--- 112,115 ----
***************
*** 133,137 ****
  		set add table (set id = 1, origin = 1,
  			id = 4, fully qualified name = 'public.history',
! 			key = serial, comment = 'Table accounts');
  	}
  	on error {
--- 125,129 ----
  		set add table (set id = 1, origin = 1,
  			id = 4, fully qualified name = 'public.history',
! 			comment = 'Table accounts');
  	}
  	on error {
***************
*** 173,182 ****
  $PREAMBLE
  try {
-     table add key (node id = $origin, fully qualified name = 
-                    'public.history');
- } on error {
-     exit 1;
- }
- try {
  	create set (id = $mainset, origin = $origin, 
                      comment = 'Set $mainset - pgbench tables');
--- 165,168 ----
***************
*** 192,196 ****
  	set add table (set id = $mainset, origin = $origin,
  		id = 4, fully qualified name = 'public.history',
! 		key = serial, comment = 'Table accounts');
  } on error {
  	exit 1;
--- 178,182 ----
  	set add table (set id = $mainset, origin = $origin,
  		id = 4, fully qualified name = 'public.history',
! 		comment = 'Table accounts');
  } on error {
  	exit 1;
***************
*** 222,231 ****
  $PREAMBLE
  try {
-     table add key (node id = $origin, fully qualified name = 
-                    'public.history');
- } on error {
-     exit 1;
- }
- try {
  	create set (id = $mainset, origin = $origin, 
                      comment = 'Set $mainset - pgbench tables');
--- 208,211 ----

Index: firstdb.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/firstdb.sgml,v
retrieving revision 1.24
retrieving revision 1.25
diff -C2 -d -r1.24 -r1.25
*** firstdb.sgml	11 Jun 2007 16:02:50 -0000	1.24
--- firstdb.sgml	22 Jun 2007 16:15:57 -0000	1.25
***************
*** 95,98 ****
--- 95,116 ----
  </programlisting>
  
+ <para> One of the tables created by
+ <application>pgbench</application>, <envar>history</envar>, does not
+ have a primary key.  In earlier versions of &slony1;, a &lslonik;
+ command called <xref linkend="stmttableaddkey"> could be used to
+ introduce one.  This caused a number of problems, and so this feature
+ has been removed in version 2 of &slony1;.  It now
+ <emphasis>requires</emphasis> that there is a suitable candidate
+ primary key. </para>
+ 
+ <para> The following SQL requests will establish a proper primary key on this table: </para>
+ 
+ <programlisting>
+ psql -U $PGBENCH_USER -h $HOST1 -d $DBNAME1 -c "begin; alter table
+ history add column id serial; update history set id =
+ nextval('history_id_seq'); alter table history add primary key(id);
+ commit"
+ </programlisting>
+ 
  <para>Because &slony1; depends on the databases having the pl/pgSQL
  procedural language installed, we better install it now.  It is
***************
*** 230,234 ****
  	set add table (set id=1, origin=1, id=2, fully qualified name = 'public.branches', comment='branches table');
  	set add table (set id=1, origin=1, id=3, fully qualified name = 'public.tellers', comment='tellers table');
! 	set add table (set id=1, origin=1, id=4, fully qualified name = 'public.history', comment='history table', key = serial);
  
  	#--
--- 248,252 ----
  	set add table (set id=1, origin=1, id=2, fully qualified name = 'public.branches', comment='branches table');
  	set add table (set id=1, origin=1, id=3, fully qualified name = 'public.tellers', comment='tellers table');
! 	set add table (set id=1, origin=1, id=4, fully qualified name = 'public.history', comment='history table');
  
  	#--

From cbbrowne at lists.slony.info  Mon Jun 25 07:50:50 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Mon Jun 25 07:50:52 2007
Subject: [Slony1-commit] slony1-www/content news.txt
Message-ID: <20070625145050.EFF4A2903DF@main.slony.info>

Update of /home/cvsd/slony1/slony1-www/content
In directory main.slony.info:/tmp/cvs-serv22412/content

Modified Files:
	news.txt 
Log Message:
Mention solving of logshipping problem


Index: news.txt
===================================================================
RCS file: /home/cvsd/slony1/slony1-www/content/news.txt,v
retrieving revision 1.24
retrieving revision 1.25
diff -C2 -d -r1.24 -r1.25
*** news.txt	21 Jun 2007 22:14:21 -0000	1.24
--- news.txt	25 Jun 2007 14:50:48 -0000	1.25
***************
*** 9,13 ****
  Slony-1 1.1.9 <a href="http://main.slony.info/downloads/1.1/source/slony1-1.1.9.tar.bz2">engine</a>
  <!-- Please keep this item at the top of the news list -->
- ---
  Slony-I 1.2.10 pre-release tarball #2 uploaded
  http://lists.slony.info/downloads/1.2/source/slony1-1.2.10-pre2.tar.bz2
--- 9,12 ----
***************
*** 29,32 ****
--- 28,41 ----
  permits such things, but <i>please</i> wait until we call this final...
  ---
+ Logshipping issue solved
+ http://lists.slony.info/pipermail/slony1-commit/2007-June/001827.html
+ 2007-06-19
+ Chris Browne
+ 
+ Jan's Patch of June 19th evidently resolves the log shipping problems
+ to the point that it survives the "torture test."
+ 
+ <P> Retesting ongoes...
+ ---
  Version 1.2.10 - log shipping problem to solve
  http://lists.slony.info/pipermail/slony1-bugs/2007-June/000017.html

From cbbrowne at lists.slony.info  Mon Jun 25 07:52:05 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Mon Jun 25 07:52:05 2007
Subject: [Slony1-commit] slony1-www/content news.txt
Message-ID: <20070625145205.2B5C62903CD@main.slony.info>

Update of /home/cvsd/slony1/slony1-www/content
In directory main.slony.info:/tmp/cvs-serv22486/content

Modified Files:
	news.txt 
Log Message:
Fix typo


Index: news.txt
===================================================================
RCS file: /home/cvsd/slony1/slony1-www/content/news.txt,v
retrieving revision 1.25
retrieving revision 1.26
diff -C2 -d -r1.25 -r1.26
*** news.txt	25 Jun 2007 14:50:48 -0000	1.25
--- news.txt	25 Jun 2007 14:52:03 -0000	1.26
***************
*** 9,12 ****
--- 9,13 ----
  Slony-1 1.1.9 <a href="http://main.slony.info/downloads/1.1/source/slony1-1.1.9.tar.bz2">engine</a>
  <!-- Please keep this item at the top of the news list -->
+ ---
  Slony-I 1.2.10 pre-release tarball #2 uploaded
  http://lists.slony.info/downloads/1.2/source/slony1-1.2.10-pre2.tar.bz2

From cbbrowne at lists.slony.info  Mon Jun 25 09:34:59 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Mon Jun 25 09:35:00 2007
Subject: [Slony1-commit] slony1-engine/src/slon dbutils.c
Message-ID: <20070625163459.297CA29041A@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slon
In directory main.slony.info:/tmp/cvs-serv25382

Modified Files:
	dbutils.c 
Log Message:
Slony-I CVS HEAD does not support versions < 8.3 anymore; express this
in dbutils.c


Index: dbutils.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/dbutils.c,v
retrieving revision 1.26
retrieving revision 1.27
diff -C2 -d -r1.26 -r1.27
*** dbutils.c	6 Dec 2006 09:48:19 -0000	1.26
--- dbutils.c	25 Jun 2007 16:34:57 -0000	1.27
***************
*** 115,119 ****
  	conn->dbconn = dbconn;
  	conn->pg_version = db_get_version(dbconn);
!         if (conn->pg_version < 70400)
          {
                  slon_log(SLON_ERROR,
--- 115,119 ----
  	conn->dbconn = dbconn;
  	conn->pg_version = db_get_version(dbconn);
!         if (conn->pg_version < 80300)
          {
                  slon_log(SLON_ERROR,

From cbbrowne at lists.slony.info  Tue Jun 26 11:39:43 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Jun 26 11:39:45 2007
Subject: [Slony1-commit] slony1-www/content frontpage.txt news.txt
Message-ID: <20070626183943.D6F482903CD@main.slony.info>

Update of /home/cvsd/slony1/slony1-www/content
In directory main.slony.info:/tmp/cvs-serv26383/content

Modified Files:
	frontpage.txt news.txt 
Log Message:
Yay!  1.2.10 is released!


Index: frontpage.txt
===================================================================
RCS file: /home/cvsd/slony1/slony1-www/content/frontpage.txt,v
retrieving revision 1.15
retrieving revision 1.16
diff -C2 -d -r1.15 -r1.16
*** frontpage.txt	21 Jun 2007 22:15:45 -0000	1.15
--- frontpage.txt	26 Jun 2007 18:39:41 -0000	1.16
***************
*** 1,35 ****
  ---
! Slony-I 1.2.10 pre-release tarball #2 uploaded
! http://lists.slony.info/downloads/1.2/source/slony1-1.2.10-pre2.tar.bz2
! 2007-06-21
  Chris Browne
  
! I have uploaded a tarball for 1.2.10 based on the fixes that have come
! in this week to <a href=
! "http://main.slony.info/documentation/logshipping.html"> log shipping
! </a>.
! 
! <P> I have run tests of this build on Debian/Unstable on the IA-32
! architecture against each of PostgreSQL 7.4, 8.0, 8.1, 8.2, and a
! recent copy of CVS HEAD (e.g. - 8.3).
! 
! <P> If there are no negative reports about it, I anticipate that a
! checkout insignificantly different from this will become the 1.2.10
! release later this week.
! 
! <P> Please <i>do not</i> release binaries based on this tarball; that
! could lead to the regrettable situation of people downloading
! something that isn't the true final release of 1.2.10.  The license
! permits such things, but <i>please</i> wait until we call this final...
! ---
! Slony-I Release approaching readiness - 1.2.10
! http://main.slony.info/downloads/1.2
! 2007-06-05
! Chris Browne
  
! Here are the release notes as they stand now; there are some issues
! still outstanding with respect to <a
! href="http://main.slony.info/documentation/logshipping.html"> log
! shipping.</a>
  
  <h2>RELEASE 1.2.10</h2>
--- 1,14 ----
  ---
! Slony-I 1.2.10 Released
! http://lists.slony.info/downloads/1.2/source/slony1-1.2.10.tar.bz2
! 2007-06-26
  Chris Browne
  
! We are pleased to announce the release of Slony-I version 1.2.10.
! Sources as well as pre-built documentation is available in the
! download area; users of RPM-based systems and Windows will likely see
! suitable packages soon.
  
! <P> The release notes describe the changes made since 1.2.9:
  
  <h2>RELEASE 1.2.10</h2>

Index: news.txt
===================================================================
RCS file: /home/cvsd/slony1/slony1-www/content/news.txt,v
retrieving revision 1.26
retrieving revision 1.27
diff -C2 -d -r1.26 -r1.27
*** news.txt	25 Jun 2007 14:52:03 -0000	1.26
--- news.txt	26 Jun 2007 18:39:41 -0000	1.27
***************
*** 2,13 ****
  Slony-I Quick downloads
  http://main.slony.info/downloads
! 2007-02-28
  Chris Browne
! Slony-1 1.2.9 <a href="http://main.slony.info/downloads/1.2/source/slony1-1.2.9.tar.bz2">engine</a>
! <a href="http://main.slony.info/downloads/1.2/source/slony1-1.2.9-docs.tar.bz2">documentation</a>
! <br />
  Slony-1 1.1.9 <a href="http://main.slony.info/downloads/1.1/source/slony1-1.1.9.tar.bz2">engine</a>
  <!-- Please keep this item at the top of the news list -->
  ---
  Slony-I 1.2.10 pre-release tarball #2 uploaded
  http://lists.slony.info/downloads/1.2/source/slony1-1.2.10-pre2.tar.bz2
--- 2,23 ----
  Slony-I Quick downloads
  http://main.slony.info/downloads
! 2007-06-26
  Chris Browne
! Slony-1 1.2.10 <a href="http://main.slony.info/downloads/1.2/source/slony1-1.2.10.tar.bz2">engine</a>
! <a href="http://main.slony.info/downloads/1.2/source/slony1-1.2.10-docs.tar.bz2">documentation</a>
! <br/>
  Slony-1 1.1.9 <a href="http://main.slony.info/downloads/1.1/source/slony1-1.1.9.tar.bz2">engine</a>
  <!-- Please keep this item at the top of the news list -->
  ---
+ Slony-I 1.2.10 Released
+ http://lists.slony.info/downloads/1.2/source/slony1-1.2.10.tar.bz2
+ 2007-06-26
+ Chris Browne
+ 
+ We are pleased to announce the release of Slony-I version 1.2.10.
+ Sources as well as pre-built documentation is available in the
+ download area; users of RPM-based systems and Windows will likely see
+ suitable packages soon.
+ ---
  Slony-I 1.2.10 pre-release tarball #2 uploaded
  http://lists.slony.info/downloads/1.2/source/slony1-1.2.10-pre2.tar.bz2

From cbbrowne at lists.slony.info  Wed Jun 27 07:41:05 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Wed Jun 27 07:41:07 2007
Subject: [Slony1-commit] slony1-www/content news.txt
Message-ID: <20070627144105.11230290BEA@main.slony.info>

Update of /home/cvsd/slony1/slony1-www/content
In directory main.slony.info:/tmp/cvs-serv8048/content

Modified Files:
	news.txt 
Log Message:
Added news items for Windows binaries for 1.2.10, as well as Turkish 
documentation


Index: news.txt
===================================================================
RCS file: /home/cvsd/slony1/slony1-www/content/news.txt,v
retrieving revision 1.27
retrieving revision 1.28
diff -C2 -d -r1.27 -r1.28
*** news.txt	26 Jun 2007 18:39:41 -0000	1.27
--- news.txt	27 Jun 2007 14:41:03 -0000	1.28
***************
*** 4,7 ****
--- 4,8 ----
  2007-06-26
  Chris Browne
+ 
  Slony-1 1.2.10 <a href="http://main.slony.info/downloads/1.2/source/slony1-1.2.10.tar.bz2">engine</a>
  <a href="http://main.slony.info/downloads/1.2/source/slony1-1.2.10-docs.tar.bz2">documentation</a>
***************
*** 10,13 ****
--- 11,34 ----
  <!-- Please keep this item at the top of the news list -->
  ---
+ Turkish Documentation for Slony-I
+ http://www.enderunix.org/docs/postgresql/
+ 2007-06-27
+ Ismail Yenigul
+ 
+ Ismail Yenigul has made available documentation written in Turkish in
+ <a href=
+ "http://www.enderunix.org/docs/postgresql/slony_replication.odt">
+ StarOffice Writer format </a> or <a href=
+ "http://www.enderunix.org/docs/postgresql/slony_replication.pdf"> PDF
+ </a>.
+ ---
+ Slony-I 1.2.10 Windows Binaries Available
+ http://developer.pgadmin.org/~hiroshi/Slony-I/
+ 2007-06-27
+ Hiroshi Saito
+ 
+ Slony-I 1.2.10 has been built for Windows; binaries are available <a
+ href="http://developer.pgadmin.org/~hiroshi/Slony-I/"> here. </a>
+ ---
  Slony-I 1.2.10 Released
  http://lists.slony.info/downloads/1.2/source/slony1-1.2.10.tar.bz2

From cbbrowne at lists.slony.info  Wed Jun 27 08:51:38 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Wed Jun 27 08:51:39 2007
Subject: [Slony1-commit] slony1-engine/src/slon cleanup_thread.c
Message-ID: <20070627155138.3C43D290C14@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slon
In directory main.slony.info:/tmp/cvs-serv9117/src/slon

Modified Files:
	cleanup_thread.c 
Log Message:
Major revision to cleanup thread:

- Use pair of SPs to calculate the list of tables to be vacuumed
- All logic for checking the list against autovac "lives" in SPs
- Result: significant simplification to C code in cleanup thread


Index: cleanup_thread.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/cleanup_thread.c,v
retrieving revision 1.37
retrieving revision 1.38
diff -C2 -d -r1.37 -r1.38
*** cleanup_thread.c	20 Apr 2007 20:53:18 -0000	1.37
--- cleanup_thread.c	27 Jun 2007 15:51:36 -0000	1.38
***************
*** 78,83 ****
  	int			vac_enable = SLON_VACUUM_FREQUENCY;
  	char	   *vacuum_action;
  
! 	slon_log(SLON_DEBUG1, "cleanupThread: thread starts\n");
  
  	/*
--- 78,84 ----
  	int			vac_enable = SLON_VACUUM_FREQUENCY;
  	char	   *vacuum_action;
+ 	int ntuples;
  
! 	slon_log(SLON_CONFIG, "cleanupThread: thread starts\n");
  
  	/*
***************
*** 89,93 ****
  		vac_bias = rand() % (SLON_CLEANUP_SLEEP * 166);
  	}
! 	slon_log(SLON_DEBUG4, "cleanupThread: bias = %d\n", vac_bias);
  
  	/*
--- 90,94 ----
  		vac_bias = rand() % (SLON_CLEANUP_SLEEP * 166);
  	}
! 	slon_log(SLON_CONFIG, "cleanupThread: bias = %d\n", vac_bias);
  
  	/*
***************
*** 139,143 ****
  		PQclear(res);
  		gettimeofday(&tv_end, NULL);
! 		slon_log(SLON_DEBUG1,
  				 "cleanupThread: %8.3f seconds for cleanupEvent()\n",
  				 TIMEVAL_DIFF(&tv_start, &tv_end));
--- 140,144 ----
  		PQclear(res);
  		gettimeofday(&tv_end, NULL);
! 		slon_log(SLON_INFO,
  				 "cleanupThread: %8.3f seconds for cleanupEvent()\n",
  				 TIMEVAL_DIFF(&tv_start, &tv_end));
***************
*** 219,223 ****
  		PQclear(res);
  		gettimeofday(&tv_end, NULL);
! 		slon_log(SLON_DEBUG1,
  				 "cleanupThread: %8.3f seconds for delete logs\n",
  				 TIMEVAL_DIFF(&tv_start, &tv_end));
--- 220,224 ----
  		PQclear(res);
  		gettimeofday(&tv_end, NULL);
! 		slon_log(SLON_INFO,
  				 "cleanupThread: %8.3f seconds for delete logs\n",
  				 TIMEVAL_DIFF(&tv_start, &tv_end));
***************
*** 233,274 ****
  		{
  			unsigned long latest_xid;
- 			int a_vac = 0;
- 
- 			vac_count = 0;
- 
- 			dstring_init(&query3);
  
- 			/* 
- 			 * if we are running a version >= 8.1, check to see 
- 			 * if autovacuum is enabled, if so we should only run
- 			 * analyze on the tables in table_list[], otherwise it
- 			 * is ok to vacuum analyze
- 			 */
- 
- 			if (conn->pg_version >=80100)
- 			{
- 				dstring_reset(&query3);
- 				slon_mkquery(&query3, "show autovacuum");
- 				res = PQexec(dbconn, dstring_data(&query3));
- 				if (PQresultStatus(res)  != PGRES_TUPLES_OK)
- 				{
- 					slon_log(SLON_ERROR,
-                                                          "cleanupThread: \"%s\" - %s",
-                                                    dstring_data(&query3), PQresultErrorMessage(res));
- 
-                                         /*
-                                          * slon_retry(); break;
-                                          */
-                                 }
- 				else if (strncmp(PQgetvalue(res, 0, 0), "on", 2) == 0)
- 				{
- 					/*
- 					 * autovacuum is on
- 					 */
- 					a_vac=1;
- 				}
-                                 PQclear(res);
- 				dstring_reset(&query3);
- 			}
  			latest_xid = get_earliest_xid(dbconn);
  			vacuum_action = "";
--- 234,238 ----
***************
*** 276,280 ****
  			{
  				
! 				slon_log(SLON_DEBUG4,
  					"cleanupThread: xid %d still active - analyze instead\n",
  					earliest_xid);
--- 240,244 ----
  			{
  				
! 				slon_log(SLON_INFO,
  					"cleanupThread: xid %d still active - analyze instead\n",
  					earliest_xid);
***************
*** 282,286 ****
  			else
  			{
! 				if ((vac_enable == vac_frequency) && (a_vac==0))
  				{
  					vacuum_action = "vacuum ";
--- 246,250 ----
  			else
  			{
! 				if (vac_enable == vac_frequency)
  				{
  					vacuum_action = "vacuum ";
***************
*** 294,360 ****
  			 */
  			gettimeofday(&tv_start, NULL);
- 			for (t = 0; table_list[t] != NULL ; t++)
- 			{
  
! 				sprintf(tstring, table_list[t], rtcfg_namespace);
! 				if (a_vac==1)
! 				{
! 					slon_mkquery(&query3,"select (case when pga.enabled ISNULL THEN true ELSE pga.enabled END) "
! 						"from \"pg_catalog\".pg_namespace PGN, \"pg_catalog\".pg_class PGC LEFT OUTER JOIN "
! 						"\"pg_catalog\".pg_autovacuum pga ON (PGC.oid = pga.vacrelid) where PGC.relnamespace = PGN.oid "
! 						"and %s.slon_quote_input('%s')=%s.slon_quote_brute(PGN.nspname) || '.' || %s.slon_quote_brute(PGC.relname);",
! 					 	rtcfg_namespace,tstring, rtcfg_namespace, rtcfg_namespace);
  
! 					res = PQexec(dbconn, dstring_data(&query3));
! 					if (PQresultStatus(res) != PGRES_TUPLES_OK)  /* query error */
! 					{
! 						slon_log(SLON_ERROR,
! 							 "cleanupThread: \"%s\" - %s",
! 							   dstring_data(&query3), PQresultErrorMessage(res));
! 						/*
! 						 * slon_retry(); break;
! 						 */
! 					}
! 					else	/* no errors */
! 					{
! 						if (PQntuples(res) == 1)	/* we want 1 and only 1 row, otherwise skip */
! 						{
! 							if (strncmp(PQgetvalue(res, 0, 0), "f", 1) == 0) 
! 							{
! 								/* 
! 								 * pg_avac is NOT enabled for this table
! 								 * so this means we need to handel it internaly
! 								 */
! 								if (vac_enable == vac_frequency)
! 								{
! 									vacuum_action = "vacuum ";
! 								}
! 							}
! 							else
! 							{
! 								vacuum_action = "";
! 							}
! 						}
! 					}
! 					PQclear(res);
! 				}
! 				dstring_reset(&query3);
  
! 				slon_mkquery(&query3,"%s analyze %s;",vacuum_action, tstring);
! 				res = PQexec(dbconn, dstring_data(&query3));
  				if (PQresultStatus(res) != PGRES_COMMAND_OK)  /* query error */
                                  {
                   	                slon_log(SLON_ERROR,
  	                                        "cleanupThread: \"%s\" - %s",
!                                                 dstring_data(&query3), PQresultErrorMessage(res));
                                                  /*
                                                   * slon_retry(); break;
                                                   */                  
                                  }
! 				PQclear(res);
  				dstring_reset(&query3);
  			}
  			gettimeofday(&tv_end, NULL);
! 			slon_log(SLON_DEBUG2,
  					 "cleanupThread: %8.3f seconds for vacuuming\n",
  					 TIMEVAL_DIFF(&tv_start, &tv_end));
--- 258,305 ----
  			 */
  			gettimeofday(&tv_start, NULL);
  
! 			slon_mkquery(&query2, "select nspname, relname from %s.TablesToVacuum();", rtcfg_namespace);
! 			res = PQexec(dbconn, dstring_data(&query2));
  
! 			/* for each table...  and we should set up the
! 			 * query to return not only the table name,
! 			 * but also a boolean to support what's in the
! 			 * SELECT below; that'll nicely simplify this
! 			 * process... */
! 			
! 			if (PQresultStatus(res) != PGRES_TUPLES_OK)  /* query error */
! 			{
! 				slon_log(SLON_ERROR,
! 					 "cleanupThread: \"%s\" - %s",
! 					 dstring_data(&query2), PQresultErrorMessage(res));
! 			}
! 			ntuples = PQntuples(res);
! 			slon_log(SLON_DEBUG1, "cleanupThread: number of tables to clean: %d\n", ntuples);
  
! 			for (t = 0; t < ntuples ; t++)
! 			{
! 				char *tab_nspname = PQgetvalue(res, t, 0);
! 				char *tab_relname = PQgetvalue(res, t, 1);
! 
! 				slon_log (SLON_DEBUG1, "cleanupThread: %s analyze \"%s\".%s;\n",
! 					      vacuum_action, tab_nspname, tab_relname);
! 				dstring_init(&query3);
! 				slon_mkquery (&query3, "%s analyze \"%s\".%s;",
! 					      vacuum_action, tab_nspname, tab_relname);
! 				res2 = PQexec(dbconn, dstring_data(&query3));
  				if (PQresultStatus(res) != PGRES_COMMAND_OK)  /* query error */
                                  {
                   	                slon_log(SLON_ERROR,
  	                                        "cleanupThread: \"%s\" - %s",
!                                                 dstring_data(&query3), PQresultErrorMessage(res2));
                                                  /*
                                                   * slon_retry(); break;
                                                   */                  
                                  }
! 				PQclear(res2);
  				dstring_reset(&query3);
  			}
  			gettimeofday(&tv_end, NULL);
! 			slon_log(SLON_INFO,
  					 "cleanupThread: %8.3f seconds for vacuuming\n",
  					 TIMEVAL_DIFF(&tv_start, &tv_end));
***************
*** 416,420 ****
  	}
  	xid = strtoll(PQgetvalue(res, 0, 0), NULL, 10);
! 	slon_log(SLON_DEBUG3, "cleanupThread: minxid: %d\n", xid);
  	PQclear(res);
  	dstring_free(&query1);
--- 361,365 ----
  	}
  	xid = strtoll(PQgetvalue(res, 0, 0), NULL, 10);
! 	slon_log(SLON_DEBUG1, "cleanupThread: minxid: %d\n", xid);
  	PQclear(res);
  	dstring_free(&query1);

From cbbrowne at lists.slony.info  Wed Jun 27 08:51:38 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Wed Jun 27 08:51:39 2007
Subject: [Slony1-commit] slony1-engine/src/backend slony1_base.sql
	slony1_funcs.sql
Message-ID: <20070627155138.37EE6290C0B@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/backend
In directory main.slony.info:/tmp/cvs-serv9117/src/backend

Modified Files:
	slony1_base.sql slony1_funcs.sql 
Log Message:
Major revision to cleanup thread:

- Use pair of SPs to calculate the list of tables to be vacuumed
- All logic for checking the list against autovac "lives" in SPs
- Result: significant simplification to C code in cleanup thread


Index: slony1_base.sql
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/backend/slony1_base.sql,v
retrieving revision 1.33
retrieving revision 1.34
diff -C2 -d -r1.33 -r1.34
*** slony1_base.sql	18 Apr 2007 15:03:51 -0000	1.33
--- slony1_base.sql	27 Jun 2007 15:51:35 -0000	1.34
***************
*** 563,566 ****
--- 563,570 ----
  ';
  
+ create type @NAMESPACE@.vactables as (nspname name, relname name);
+ 
+ comment on type @NAMESPACE@.vactables is 'used as return type for SRF function TablesToVacuum';
+ 
  -- ----------------------------------------------------------------------
  -- Last but not least grant USAGE to the replication schema objects.

Index: slony1_funcs.sql
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/backend/slony1_funcs.sql,v
retrieving revision 1.112
retrieving revision 1.113
diff -C2 -d -r1.112 -r1.113
*** slony1_funcs.sql	7 Jun 2007 22:40:23 -0000	1.112
--- slony1_funcs.sql	27 Jun 2007 15:51:35 -0000	1.113
***************
*** 1444,1455 ****
  	lock table @NAMESPACE@.sl_config_lock;
  
- 	-- ----
- 	-- This is us ... time for suicide! Restore all tables to
- 	-- their original status.
- 	-- ----
- 	for v_tab_row in select * from @NAMESPACE@.sl_table loop
- 		perform @NAMESPACE@.alterTableDropTriggers(v_tab_row.tab_id);
- 	end loop;
- 
  	raise notice ''Slony-I: Please drop schema "_@CLUSTERNAME@"'';
  	return 0;
--- 1444,1447 ----
***************
*** 5440,5443 ****
--- 5432,5441 ----
  			perform @NAMESPACE@.alterTableConfigureTriggers(v_tab_row.tab_id);
  		end loop;
+ 
+ 		-- ----
+ 		-- create new type - vactables - used by TablesToVacuum()
+ 		-- ----
+ 		execute ''create type @NAMESPACE@.vactables as (nspname name, relname name);'';
+ 
  	end if;
  
***************
*** 5616,5619 ****
--- 5614,5622 ----
  'Reenable index maintenance and reindex the table';
  
+ -- ----------------------------------------------------------------------
+ -- FUNCTION make_function_strict(function, parms)
+ --
+ --	Make function be STRICT
+ -- ----------------------------------------------------------------------
  create or replace function @NAMESPACE@.make_function_strict (text, text) returns void as
  '
***************
*** 5631,5632 ****
--- 5634,5745 ----
  comment on function @NAMESPACE@.make_function_strict (text, text) is
  'Equivalent to 8.1+ ALTER FUNCTION ... STRICT';
+ 
+ 
+ 
+ -- ----------------------------------------------------------------------
+ -- FUNCTION AutoVacExcludesTable (nspname, tabname)
+ --
+ --	Returns 't' if the table needs to be vacuumed by Slony-I
+ --      Returns 'f' if autovac handles the table, so Slony-I should not
+ -- ----------------------------------------------------------------------
+ create or replace function @NAMESPACE@.AutoVacExcludesTable (name, name) returns boolean as
+ $$
+ declare
+ 	i_nspname alias for $1;
+ 	i_tblname alias for $2;
+ 	c_table oid;
+ 	c_namespace oid;
+ 	c_enabled boolean;
+ 	v_dummy int4;
+ begin
+ 	select 1 into v_dummy from "pg_catalog".pg_settings where name = 'autovacuum' and setting = 'on';
+ 	if not found then
+ 		return 't'::boolean;       -- If autovac is turned off, then we gotta vacuum
+ 	end if;
+ 	
+ 	select into c_namespace oid from "pg_catalog".pg_namespace where nspname = i_nspname;
+ 	if not found then
+ 		raise exception 'Slony-I: namespace % does not exist', i_nspname;
+ 	end if;
+ 	select into c_table oid from "pg_catalog".pg_class where relname = i_tblname and relnamespace = c_namespace;
+ 	if not found then
+ 		raise exception 'Slony-I: table % does not exist in namespace %/%', tblname, c_namespace, i_nspname;
+ 	end if;
+ 	
+ 	-- So, the table is legit; try to look it up for autovacuum policy
+ 	select enabled into c_enabled from "pg_catalog".pg_autovacuum where vacrelid = c_table;
+ 
+ 	if not found then
+ 		return 'f'::boolean;   -- Autovac is turned on, and this table has no overriding handling
+ 	end if;
+ 
+ 	if c_enabled then
+ 		return 'f'::boolean;   -- Autovac is expressly turned on for this table
+ 	end if;
+ 
+ 	return 't'::boolean;
+ end;$$ language plpgsql;
+ 
+ comment on function @NAMESPACE@.AutoVacExcludesTable (name, name) is 
+ 'returns false if autovacuum handles vacuuming of the table; returns true if Slony-I should manage it';
+ 
+ 
+ -- ----------------------------------------------------------------------
+ -- FUNCTION TablesToVacuum()
+ --
+ --	Make function be STRICT
+ -- ----------------------------------------------------------------------
+ create or replace function @NAMESPACE@.TablesToVacuum () returns setof @NAMESPACE@.vactables as 
+ '
+ declare
+ 	prec @NAMESPACE@.vactables%rowtype;
+ begin
+ 	prec.nspname := ''_@CLUSTERNAME@'';
+ 	prec.relname := ''sl_event'';
+ 	if @NAMESPACE@.AutoVacExcludesTable(prec.nspname, prec.relname) then
+ 		return next prec;
+ 	end if;
+ 	prec.nspname := ''_@CLUSTERNAME@'';
+ 	prec.relname := ''sl_confirm'';
+ 	if @NAMESPACE@.AutoVacExcludesTable(prec.nspname, prec.relname) then
+ 		return next prec;
+ 	end if;
+ 	prec.nspname := ''_@CLUSTERNAME@'';
+ 	prec.relname := ''sl_setsync'';
+ 	if @NAMESPACE@.AutoVacExcludesTable(prec.nspname, prec.relname) then
+ 		return next prec;
+ 	end if;
+ 	prec.nspname := ''_@CLUSTERNAME@'';
+ 	prec.relname := ''sl_log_1'';
+ 	if @NAMESPACE@.AutoVacExcludesTable(prec.nspname, prec.relname) then
+ 		return next prec;
+ 	end if;
+ 	prec.nspname := ''_@CLUSTERNAME@'';
+ 	prec.relname := ''sl_log_2'';
+ 	if @NAMESPACE@.AutoVacExcludesTable(prec.nspname, prec.relname) then
+ 		return next prec;
+ 	end if;
+ 	prec.nspname := ''_@CLUSTERNAME@'';
+ 	prec.relname := ''sl_seqlog'';
+ 	if @NAMESPACE@.AutoVacExcludesTable(prec.nspname, prec.relname) then
+ 		return next prec;
+ 	end if;
+ 	prec.nspname := ''pg_catalog'';
+ 	prec.relname := ''pg_listener'';
+ 	if @NAMESPACE@.AutoVacExcludesTable(prec.nspname, prec.relname) then
+ 		return next prec;
+ 	end if;
+ 	prec.nspname := ''pg_catalog'';
+ 	prec.relname := ''pg_statistic'';
+ 	if @NAMESPACE@.AutoVacExcludesTable(prec.nspname, prec.relname) then
+ 		return next prec;
+ 	end if;
+ 
+    return;
+ end
+ ' language plpgsql;
+ 
+ comment on function @NAMESPACE@.TablesToVacuum () is 
+ 'Return a list of tables that require frequent vacuuming.  We use this
+ function so that we do not hardcode this into C code.';
+ 

From cbbrowne at lists.slony.info  Wed Jun 27 08:53:13 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Wed Jun 27 08:53:15 2007
Subject: [Slony1-commit] slony1-engine/src/xxid Makefile xxid.v83.sql
Message-ID: <20070627155313.A8A12290BE1@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/xxid
In directory main.slony.info:/tmp/cvs-serv9192

Modified Files:
	Makefile 
Added Files:
	xxid.v83.sql 
Log Message:
Introduce v83 changes - xxid.v83.sql becomes the "base" SQL script
version in Slony-I 2.0


--- NEW FILE: xxid.v83.sql ---
-- ----------
-- xxid.v74.sql.in
--
--	SQL script for loading the transaction ID compatible datatype 
--
--	Copyright (c) 2003-2004, PostgreSQL Global Development Group
--	Author: Jan Wieck, Afilias USA INC.
--
-- $Id: xxid.v83.sql,v 1.1 2007-06-27 15:53:11 cbbrowne Exp $
-- ----------

--
-- Type specific input and output functions
--
CREATE FUNCTION @NAMESPACE@."xxidin"(cstring) RETURNS @NAMESPACE@."xxid"
	AS '$libdir/xxid', '_Slony_I_xxidin'
	LANGUAGE C STRICT;
CREATE FUNCTION @NAMESPACE@."xxidout"(@NAMESPACE@."xxid") RETURNS cstring
	AS '$libdir/xxid', '_Slony_I_xxidout'
	LANGUAGE C STRICT;


--
-- The data type itself
--
CREATE TYPE @NAMESPACE@."xxid" (
	INPUT = @NAMESPACE@."xxidin",
	OUTPUT = @NAMESPACE@."xxidout",
	EXTERNALLENGTH = 12,
	INTERNALLENGTH = 4,
	PASSEDBYVALUE,
	ALIGNMENT = int4
);


--
-- Since our xxid type has special cases for values 0-3, it
-- in fact IS xid, so allow implicit type casting to and from.
--
CREATE CAST (xid AS @NAMESPACE@.xxid)
	WITHOUT FUNCTION AS IMPLICIT;
CREATE CAST (@NAMESPACE@.xxid AS xid)
	WITHOUT FUNCTION AS IMPLICIT;


--
-- Comparision functions for the new datatype
--
CREATE FUNCTION @NAMESPACE@."xxideq"(@NAMESPACE@."xxid", @NAMESPACE@."xxid") RETURNS boolean
	AS '$libdir/xxid', '_Slony_I_xxideq'
	LANGUAGE C;
CREATE FUNCTION @NAMESPACE@."xxidne"(@NAMESPACE@."xxid", @NAMESPACE@."xxid") RETURNS boolean
	AS '$libdir/xxid', '_Slony_I_xxidne'
	LANGUAGE C;
CREATE FUNCTION @NAMESPACE@."xxidlt"(@NAMESPACE@."xxid", @NAMESPACE@."xxid") RETURNS boolean
	AS '$libdir/xxid', '_Slony_I_xxidlt'
	LANGUAGE C;
CREATE FUNCTION @NAMESPACE@."xxidle"(@NAMESPACE@."xxid", @NAMESPACE@."xxid") RETURNS boolean
	AS '$libdir/xxid', '_Slony_I_xxidle'
	LANGUAGE C;
CREATE FUNCTION @NAMESPACE@."xxidgt"(@NAMESPACE@."xxid", @NAMESPACE@."xxid") RETURNS boolean
	AS '$libdir/xxid', '_Slony_I_xxidgt'
	LANGUAGE C;
CREATE FUNCTION @NAMESPACE@."xxidge"(@NAMESPACE@."xxid", @NAMESPACE@."xxid") RETURNS boolean
	AS '$libdir/xxid', '_Slony_I_xxidge'
	LANGUAGE C;
CREATE FUNCTION @NAMESPACE@."btxxidcmp"(@NAMESPACE@."xxid", @NAMESPACE@."xxid") RETURNS int4
	AS '$libdir/xxid', '_Slony_I_btxxidcmp'
	LANGUAGE C;
CREATE FUNCTION @NAMESPACE@.getCurrentXid() RETURNS @NAMESPACE@."xxid"
	AS '$libdir/xxid', '_Slony_I_getCurrentXid'
	LANGUAGE C;
CREATE FUNCTION @NAMESPACE@.getMinXid() RETURNS @NAMESPACE@."xxid"
	AS '$libdir/xxid', '_Slony_I_getMinXid'
	LANGUAGE C;
CREATE FUNCTION @NAMESPACE@.getMaxXid() RETURNS @NAMESPACE@."xxid"
	AS '$libdir/xxid', '_Slony_I_getMaxXid'
	LANGUAGE C;


--
-- Operators on these comparision functions
--
CREATE OPERATOR < (
	PROCEDURE = @NAMESPACE@."xxidlt",
	LEFTARG = @NAMESPACE@."xxid",
	RIGHTARG = @NAMESPACE@."xxid",
	COMMUTATOR = >, NEGATOR = >=,
	RESTRICT = scalarltsel, JOIN = scalarltjoinsel
);
CREATE OPERATOR = (
	PROCEDURE = @NAMESPACE@."xxideq",
	LEFTARG = @NAMESPACE@."xxid",
	RIGHTARG = @NAMESPACE@."xxid",
	COMMUTATOR = =, NEGATOR = <>,
	RESTRICT = eqsel, JOIN = eqjoinsel,
	SORT1 = <, SORT2 = <
);
CREATE OPERATOR <> (
	PROCEDURE = @NAMESPACE@."xxidne",
	LEFTARG = @NAMESPACE@."xxid",
	RIGHTARG = @NAMESPACE@."xxid",
	COMMUTATOR = <>, NEGATOR = =,
	RESTRICT = neqsel, JOIN = neqjoinsel
);
CREATE OPERATOR > (
	PROCEDURE = @NAMESPACE@."xxidgt",
	LEFTARG = @NAMESPACE@."xxid",
	RIGHTARG = @NAMESPACE@."xxid",
	COMMUTATOR = <, NEGATOR = <=,
	RESTRICT = scalargtsel, JOIN = scalargtjoinsel
);
CREATE OPERATOR <= (
	PROCEDURE = @NAMESPACE@."xxidle",
	LEFTARG = @NAMESPACE@."xxid",
	RIGHTARG = @NAMESPACE@."xxid",
	COMMUTATOR = >=, NEGATOR = >,
	RESTRICT = scalarltsel, JOIN = scalarltjoinsel
);
CREATE OPERATOR >= (
	PROCEDURE = @NAMESPACE@."xxidge",
	LEFTARG = @NAMESPACE@."xxid",
	RIGHTARG = @NAMESPACE@."xxid",
	COMMUTATOR = <=, NEGATOR = <,
	RESTRICT = scalargtsel, JOIN = scalargtjoinsel
);


--
-- Finally the default operator class so that we can use our
-- new data type in btree indexes.
--
CREATE OPERATOR CLASS @NAMESPACE@."xxid_ops"
	DEFAULT FOR TYPE @NAMESPACE@."xxid" USING btree AS
	OPERATOR 1 <  (@NAMESPACE@."xxid", @NAMESPACE@."xxid"),
	OPERATOR 2 <= (@NAMESPACE@."xxid", @NAMESPACE@."xxid"),
	OPERATOR 3 =  (@NAMESPACE@."xxid", @NAMESPACE@."xxid"),
	OPERATOR 4 >= (@NAMESPACE@."xxid", @NAMESPACE@."xxid"),
	OPERATOR 5 >  (@NAMESPACE@."xxid", @NAMESPACE@."xxid"),
	FUNCTION 1 @NAMESPACE@."btxxidcmp" (@NAMESPACE@."xxid", @NAMESPACE@."xxid");


--
-- A special transaction snapshot data type for faster visibility checks
--
CREATE FUNCTION @NAMESPACE@."xxid_snapshot_in"(cstring)
RETURNS @NAMESPACE@."xxid_snapshot"
	AS '$libdir/xxid', '_Slony_I_xxid_snapshot_in'
	LANGUAGE C STRICT;
CREATE FUNCTION @NAMESPACE@."xxid_snapshot_out"(@NAMESPACE@."xxid_snapshot")
RETURNS cstring
	AS '$libdir/xxid', '_Slony_I_xxid_snapshot_out'
	LANGUAGE C STRICT;


--
-- The data type itself
--
CREATE TYPE @NAMESPACE@."xxid_snapshot" (
	INPUT = @NAMESPACE@."xxid_snapshot_in",
	OUTPUT = @NAMESPACE@."xxid_snapshot_out",
	INTERNALLENGTH = variable,
	ALIGNMENT = int4
);


--
-- Special comparision functions used by the remote worker
-- for sync chunk selection
--
CREATE FUNCTION @NAMESPACE@."xxid_lt_snapshot"(
		@NAMESPACE@."xxid",
		@NAMESPACE@."xxid_snapshot")
RETURNS boolean
	AS '$libdir/xxid', '_Slony_I_xxid_lt_snapshot'
	LANGUAGE C;

CREATE FUNCTION @NAMESPACE@."xxid_ge_snapshot"(
		@NAMESPACE@."xxid",
		@NAMESPACE@."xxid_snapshot")
RETURNS boolean
	AS '$libdir/xxid', '_Slony_I_xxid_ge_snapshot'
	LANGUAGE C;



Index: Makefile
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/xxid/Makefile,v
retrieving revision 1.27
retrieving revision 1.28
diff -C2 -d -r1.27 -r1.28
*** Makefile	7 Feb 2007 19:17:50 -0000	1.27
--- Makefile	27 Jun 2007 15:53:11 -0000	1.28
***************
*** 18,26 ****
  NAME		= xxid
  
! SQL_NAME74	= $(NAME).v74.sql
! SQL_NAME80	= $(NAME).v80.sql
! SQL_NAME81	= $(NAME).v81.sql
! SQL_NAMES	= $(SQL_NAME74) $(SQL_NAME80) $(SQL_NAME81)
! GENSQLNAMES = $(filter-out $(SQL_NAME74), $(SQL_NAMES))
  
  SO_OBJS		= xxid.o $(WIN32RES)
--- 18,24 ----
  NAME		= xxid
  
! SQL_NAME83	= $(NAME).v83.sql
! SQL_NAMES	= $(SQL_NAME83)
! GENSQLNAMES = $(filter-out $(SQL_NAME83), $(SQL_NAMES))
  
  SO_OBJS		= xxid.o $(WIN32RES)
***************
*** 30,41 ****
  	$(SQL_NAMES)		\
  
! DISTFILES = Makefile xxid.c xxid.v74.sql
  
  all:	$(ALL)
  
! $(SQL_NAME80):	$(SQL_NAME74)
! 	cp $< $@
! 
! $(SQL_NAME81):	$(SQL_NAME80)
  	cp $< $@
  
--- 28,36 ----
  	$(SQL_NAMES)		\
  
! DISTFILES = Makefile xxid.c xxid.v83.sql
  
  all:	$(ALL)
  
! #$(SQL_NAME84):	$(SQL_NAME83)
  	cp $< $@
  

From cbbrowne at lists.slony.info  Wed Jun 27 08:54:39 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Wed Jun 27 08:54:41 2007
Subject: [Slony1-commit] slony1-engine RELEASE-2.0
Message-ID: <20070627155439.D123F290BEF@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine
In directory main.slony.info:/tmp/cvs-serv9218

Modified Files:
	RELEASE-2.0 
Log Message:
Add notes about changes to cleanup thread


Index: RELEASE-2.0
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/RELEASE-2.0,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** RELEASE-2.0	7 Jun 2007 16:06:35 -0000	1.2
--- RELEASE-2.0	27 Jun 2007 15:54:37 -0000	1.3
***************
*** 32,33 ****
--- 32,41 ----
  relatively inactive, they won't require entries in sl_seqlog very
  often.
+ 
+ - Change to tools/slony1_dump.sh (used to generate log shipping dump);
+   change quoting of "\\\backslashes\\\" to get rid of warning
+ 
+ - Cleanup thread revised to push most of the logic to evaluate which
+   tables are to be vacuumed into a pair of stored functions.
+ 
+   This fairly massively simplifies the C code.

From cbbrowne at lists.slony.info  Wed Jun 27 09:20:26 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Wed Jun 27 09:20:27 2007
Subject: [Slony1-commit] slony1-engine/src/slon confoptions.c dbutils.c
	local_listen.c remote_listen.c remote_worker.c slon.c sync_thread.c
Message-ID: <20070627162026.9A4FE290C01@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slon
In directory main.slony.info:/tmp/cvs-serv9493

Modified Files:
	confoptions.c dbutils.c local_listen.c remote_listen.c 
	remote_worker.c slon.c sync_thread.c 
Log Message:
Revisions to logging levels

- Changed config items to SLON_CONFIG
- Other interesting messages are at SLON_INFO
- Goal: Should usually be able to run with debugging level = 0 (= INFO)
  and still get all the interesting information


Index: dbutils.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/dbutils.c,v
retrieving revision 1.27
retrieving revision 1.28
diff -C2 -d -r1.27 -r1.28
*** dbutils.c	25 Jun 2007 16:34:57 -0000	1.27
--- dbutils.c	27 Jun 2007 16:20:24 -0000	1.28
***************
*** 124,128 ****
          }
  	
!         slon_log(SLON_DEBUG4,
                  "version for \"%s\" is %d\n", conninfo, conn->pg_version);
  
--- 124,128 ----
          }
  	
!         slon_log(SLON_CONFIG,
                  "version for \"%s\" is %d\n", conninfo, conn->pg_version);
  

Index: remote_listen.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/remote_listen.c,v
retrieving revision 1.35
retrieving revision 1.36
diff -C2 -d -r1.35 -r1.36
*** remote_listen.c	20 Apr 2007 20:53:18 -0000	1.35
--- remote_listen.c	27 Jun 2007 16:20:24 -0000	1.36
***************
*** 97,101 ****
  	PollState	oldpstate;
  
! 	slon_log(SLON_DEBUG1,
  			 "remoteListenThread_%d: thread starts\n",
  			 node->no_id);
--- 97,101 ----
  	PollState	oldpstate;
  
! 	slon_log(SLON_INFO,
  			 "remoteListenThread_%d: thread starts\n",
  			 node->no_id);
***************
*** 136,140 ****
  					strcmp(conn_conninfo, node->pa_conninfo) != 0)
  				{
! 					slon_log(SLON_DEBUG1,
  							 "remoteListenThread_%d: "
  							 "disconnecting from '%s'\n",
--- 136,140 ----
  					strcmp(conn_conninfo, node->pa_conninfo) != 0)
  				{
! 					slon_log(SLON_CONFIG,
  							 "remoteListenThread_%d: "
  							 "disconnecting from '%s'\n",

Index: local_listen.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/local_listen.c,v
retrieving revision 1.41
retrieving revision 1.42
diff -C2 -d -r1.41 -r1.42
*** local_listen.c	20 Apr 2007 20:53:18 -0000	1.41
--- local_listen.c	27 Jun 2007 16:20:24 -0000	1.42
***************
*** 49,53 ****
  	int poll_sleep = 0;
  
! 	slon_log(SLON_DEBUG1, "localListenThread: thread starts\n");
  
  	/*
--- 49,53 ----
  	int poll_sleep = 0;
  
! 	slon_log(SLON_INFO, "localListenThread: thread starts\n");
  
  	/*
***************
*** 626,630 ****
  				 * Nothing to do locally
  				 */
! 				slon_log(SLON_DEBUG2, "localListenThread: ACCEPT_SET");
  				rtcfg_reloadListen(dbconn);
  			}
--- 626,630 ----
  				 * Nothing to do locally
  				 */
! 				slon_log(SLON_DEBUG1, "localListenThread: ACCEPT_SET");
  				rtcfg_reloadListen(dbconn);
  			}
***************
*** 700,704 ****
  #endif
  
! 	slon_log(SLON_DEBUG1, "localListenThread: thread done\n");
  	pthread_exit(NULL);
  }
--- 700,704 ----
  #endif
  
! 	slon_log(SLON_INFO, "localListenThread: thread done\n");
  	pthread_exit(NULL);
  }

Index: sync_thread.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/sync_thread.c,v
retrieving revision 1.19
retrieving revision 1.20
diff -C2 -d -r1.19 -r1.20
*** sync_thread.c	14 Mar 2007 15:59:32 -0000	1.19
--- sync_thread.c	27 Jun 2007 16:20:24 -0000	1.20
***************
*** 53,57 ****
  	bool first_time = TRUE;
  
! 	slon_log(SLON_DEBUG1,
  			 "syncThread: thread starts\n");
  
--- 53,57 ----
  	bool first_time = TRUE;
  
! 	slon_log(SLON_INFO,
  			 "syncThread: thread starts\n");
  
***************
*** 195,199 ****
  	slon_disconnectdb(conn);
  
! 	slon_log(SLON_DEBUG1, "syncThread: thread done\n");
  	pthread_exit(NULL);
  }
--- 195,199 ----
  	slon_disconnectdb(conn);
  
! 	slon_log(SLON_INFO, "syncThread: thread done\n");
  	pthread_exit(NULL);
  }

Index: remote_worker.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/remote_worker.c,v
retrieving revision 1.145
retrieving revision 1.146
diff -C2 -d -r1.145 -r1.146
*** remote_worker.c	19 Jun 2007 19:14:49 -0000	1.145
--- remote_worker.c	27 Jun 2007 16:20:24 -0000	1.146
***************
*** 292,296 ****
  	bool			need_reloadListen = false;
  
! 	slon_log(SLON_DEBUG1,
  			 "remoteWorkerThread_%d: thread starts\n",
  			 node->no_id);
--- 292,296 ----
  	bool			need_reloadListen = false;
  
! 	slon_log(SLON_INFO,
  			 "remoteWorkerThread_%d: thread starts\n",
  			 node->no_id);
***************
*** 986,990 ****
  				PGresult   *res;
  
! 				slon_log(SLON_DEBUG2, "start processing ACCEPT_SET\n");
  				set_id = (int)strtol(event->ev_data1, NULL, 10);
  				slon_log(SLON_DEBUG2, "ACCEPT: set=%d\n", set_id);
--- 986,990 ----
  				PGresult   *res;
  
! 				slon_log(SLON_DEBUG1, "start processing ACCEPT_SET\n");
  				set_id = (int)strtol(event->ev_data1, NULL, 10);
  				slon_log(SLON_DEBUG2, "ACCEPT: set=%d\n", set_id);
***************
*** 1009,1013 ****
  				if ((rtcfg_nodeid != old_origin) && (rtcfg_nodeid != new_origin))
  				{
! 					slon_log(SLON_DEBUG2, "ACCEPT_SET - node not origin\n");
  					(void) slon_mkquery(&query2,
  								 "select 1 from %s.sl_event "
--- 1009,1013 ----
  				if ((rtcfg_nodeid != old_origin) && (rtcfg_nodeid != new_origin))
  				{
! 					slon_log(SLON_DEBUG1, "ACCEPT_SET - node not origin\n");
  					(void) slon_mkquery(&query2,
  								 "select 1 from %s.sl_event "
***************
*** 1034,1038 ****
  					while (PQntuples(res) == 0)
  					{
! 						slon_log(SLON_DEBUG2, "ACCEPT_SET - MOVE_SET or FAILOVER_SET not received yet - sleep\n");
  						if (sched_msleep(node, 10000) != SCHED_STATUS_OK)
  							slon_retry();
--- 1034,1038 ----
  					while (PQntuples(res) == 0)
  					{
! 						slon_log(SLON_DEBUG1, "ACCEPT_SET - MOVE_SET or FAILOVER_SET not received yet - sleep\n");
  						if (sched_msleep(node, 10000) != SCHED_STATUS_OK)
  							slon_retry();
***************
*** 1041,1045 ****
  					}
  					PQclear(res);
! 					slon_log(SLON_DEBUG2, "ACCEPT_SET - MOVE_SET or FAILOVER_SET exists - adjusting setsync status\n");
  
  					/*
--- 1041,1045 ----
  					}
  					PQclear(res);
! 					slon_log(SLON_DEBUG1, "ACCEPT_SET - MOVE_SET or FAILOVER_SET exists - adjusting setsync status\n");
  
  					/*
***************
*** 1073,1077 ****
  					slon_appendquery(&query1, "commit transaction;");
  					query_execute(node, local_dbconn, &query1);
! 					slon_log(SLON_DEBUG2, "ACCEPT_SET - done\n");
  					archive_close(node);
  					slon_retry();
--- 1073,1077 ----
  					slon_appendquery(&query1, "commit transaction;");
  					query_execute(node, local_dbconn, &query1);
! 					slon_log(SLON_DEBUG1, "ACCEPT_SET - done\n");
  					archive_close(node);
  					slon_retry();
***************
*** 1081,1085 ****
  				else
  				{
! 					slon_log(SLON_DEBUG2, "ACCEPT_SET - on origin node...\n");
  				}
  
--- 1081,1085 ----
  				else
  				{
! 					slon_log(SLON_DEBUG1, "ACCEPT_SET - on origin node...\n");
  				}
  
***************
*** 1471,1475 ****
  	free(wd);
  
! 	slon_log(SLON_DEBUG1,
  			 "remoteWorkerThread_%d: thread done\n",
  			 node->no_id);
--- 1471,1475 ----
  	free(wd);
  
! 	slon_log(SLON_INFO,
  			 "remoteWorkerThread_%d: thread done\n",
  			 node->no_id);
***************
*** 1492,1496 ****
  	int			i;
  
! 	slon_log(SLON_DEBUG4, "remoteWorkerThread_%d: "
  			 "update provider configuration\n",
  			 node->no_id);
--- 1492,1496 ----
  	int			i;
  
! 	slon_log(SLON_CONFIG, "remoteWorkerThread_%d: "
  			 "update provider configuration\n",
  			 node->no_id);
***************
*** 1585,1589 ****
  						slon_retry();
  					}
! 					slon_log(SLON_DEBUG1, "remoteWorkerThread_%d: "
  							 "helper thread for provider %d created\n",
  							 node->no_id, provider->no_id);
--- 1585,1589 ----
  						slon_retry();
  					}
! 					slon_log(SLON_CONFIG, "remoteWorkerThread_%d: "
  							 "helper thread for provider %d created\n",
  							 node->no_id, provider->no_id);
***************
*** 1637,1641 ****
  								provider->set_tail, pset);
  
! 				slon_log(SLON_DEBUG4, "remoteWorkerThread_%d: "
  						 "added active set %d to provider %d\n",
  						 node->no_id, pset->set_id, provider->no_id);
--- 1637,1641 ----
  								provider->set_tail, pset);
  
! 				slon_log(SLON_CONFIG, "remoteWorkerThread_%d: "
  						 "added active set %d to provider %d\n",
  						 node->no_id, pset->set_id, provider->no_id);
***************
*** 1672,1676 ****
  			pthread_mutex_destroy(&(provider->helper_lock));
  
! 			slon_log(SLON_DEBUG1, "remoteWorkerThread_%d: "
  					 "helper thread for provider %d terminated\n",
  					 node->no_id, provider->no_id);
--- 1672,1676 ----
  			pthread_mutex_destroy(&(provider->helper_lock));
  
! 			slon_log(SLON_CONFIG, "remoteWorkerThread_%d: "
  					 "helper thread for provider %d terminated\n",
  					 node->no_id, provider->no_id);
***************
*** 1700,1704 ****
  			if (provider->conn != NULL)
  			{
! 				slon_log(SLON_DEBUG1, "remoteWorkerThread_%d: "
  						 "disconnecting from data provider %d\n",
  						 node->no_id, provider->no_id);
--- 1700,1704 ----
  			if (provider->conn != NULL)
  			{
! 				slon_log(SLON_CONFIG, "remoteWorkerThread_%d: "
  						 "disconnecting from data provider %d\n",
  						 node->no_id, provider->no_id);
***************
*** 1733,1737 ****
  			if (provider->conn != NULL)
  			{
! 				slon_log(SLON_DEBUG1, "remoteWorkerThread_%d: "
  						 "disconnecting from data provider %d\n",
  						 node->no_id, provider->no_id);
--- 1733,1737 ----
  			if (provider->conn != NULL)
  			{
! 				slon_log(SLON_CONFIG, "remoteWorkerThread_%d: "
  						 "disconnecting from data provider %d\n",
  						 node->no_id, provider->no_id);
***************
*** 1796,1800 ****
  	if (sched_get_status() != SCHED_STATUS_OK)
  	{
! 		slon_log(SLON_DEBUG2,
  				 "remoteWorker_event: ignore new events due to shutdown\n");
  		return;
--- 1796,1800 ----
  	if (sched_get_status() != SCHED_STATUS_OK)
  	{
! 		slon_log(SLON_DEBUG1,
  				 "remoteWorker_event: ignore new events due to shutdown\n");
  		return;
***************
*** 1980,1984 ****
  	{
  		rtcfg_unlock();
! 		slon_log(SLON_DEBUG2,
  				 "remoteWorker_wakeup: unknown node %d\n",
  				 no_id);
--- 1980,1984 ----
  	{
  		rtcfg_unlock();
! 		slon_log(SLON_DEBUG1,
  				 "remoteWorker_wakeup: unknown node %d\n",
  				 no_id);
***************
*** 2378,2382 ****
  	struct timeval tv_now;
  
! 	slon_log(SLON_DEBUG1, "copy_set %d\n", set_id);
  	gettimeofday(&tv_start, NULL);
  
--- 2378,2382 ----
  	struct timeval tv_now;
  
! 	slon_log(SLON_INFO, "copy_set %d\n", set_id);
  	gettimeofday(&tv_start, NULL);
  
***************
*** 2435,2439 ****
  	free(conninfo);
  	conninfo = NULL;
! 	slon_log(SLON_DEBUG1, "remoteWorkerThread_%d: "
  			 "connected to provider DB\n",
  			 node->no_id);
--- 2435,2439 ----
  	free(conninfo);
  	conninfo = NULL;
! 	slon_log(SLON_CONFIG, "remoteWorkerThread_%d: "
  			 "connected to provider DB\n",
  			 node->no_id);
***************
*** 2590,2594 ****
  
  		gettimeofday(&tv_start2, NULL);
! 		slon_log(SLON_DEBUG2, "remoteWorkerThread_%d: "
  				 "prepare to copy table %s\n",
  				 node->no_id, tab_fqname);
--- 2590,2594 ----
  
  		gettimeofday(&tv_start2, NULL);
! 		slon_log(SLON_CONFIG, "remoteWorkerThread_%d: "
  				 "prepare to copy table %s\n",
  				 node->no_id, tab_fqname);
***************
*** 2634,2638 ****
  	PQclear(res1);
  
! 	slon_log(SLON_DEBUG2, "remoteWorkerThread_%d: "
  			 "all tables for set %d found on subscriber\n",
  			 node->no_id, set_id);
--- 2634,2638 ----
  	PQclear(res1);
  
! 	slon_log(SLON_CONFIG, "remoteWorkerThread_%d: "
  			 "all tables for set %d found on subscriber\n",
  			 node->no_id, set_id);
***************
*** 2679,2683 ****
  		char	   *seq_comment = PQgetvalue(res1, tupno1, 2);
  
! 		slon_log(SLON_DEBUG2, "remoteWorkerThread_%d: "
  				 "copy sequence %s\n",
  				 node->no_id, seq_fqname);
--- 2679,2683 ----
  		char	   *seq_comment = PQgetvalue(res1, tupno1, 2);
  
! 		slon_log(SLON_CONFIG, "remoteWorkerThread_%d: "
  				 "copy sequence %s\n",
  				 node->no_id, seq_fqname);
***************
*** 2752,2756 ****
  
  		gettimeofday(&tv_start2, NULL);
! 		slon_log(SLON_DEBUG2, "remoteWorkerThread_%d: "
  				 "copy table %s\n",
  				 node->no_id, tab_fqname);
--- 2752,2756 ----
  
  		gettimeofday(&tv_start2, NULL);
! 		slon_log(SLON_CONFIG, "remoteWorkerThread_%d: "
  				 "copy table %s\n",
  				 node->no_id, tab_fqname);
***************
*** 2828,2832 ****
  		 * Begin a COPY from stdin for the table on the local DB
  		 */
! 		slon_log(SLON_DEBUG2, "remoteWorkerThread_%d: "
  				 "Begin COPY of table %s\n",
  				 node->no_id, tab_fqname);
--- 2828,2832 ----
  		 * Begin a COPY from stdin for the table on the local DB
  		 */
! 		slon_log(SLON_CONFIG, "remoteWorkerThread_%d: "
  				 "Begin COPY of table %s\n",
  				 node->no_id, tab_fqname);
***************
*** 3084,3088 ****
  
  		PQclear(res2);
! 		slon_log(SLON_DEBUG2, "remoteWorkerThread_%d: "
  				 INT64_FORMAT " bytes copied for table %s\n",
  				 node->no_id, copysize, tab_fqname);
--- 3084,3088 ----
  
  		PQclear(res2);
! 		slon_log(SLON_CONFIG, "remoteWorkerThread_%d: "
  				 INT64_FORMAT " bytes copied for table %s\n",
  				 node->no_id, copysize, tab_fqname);
***************
*** 3116,3120 ****
  
  		gettimeofday(&tv_now, NULL);
! 		slon_log(SLON_DEBUG2, "remoteWorkerThread_%d: "
  				 "%.3f seconds to copy table %s\n",
  				 node->no_id,
--- 3116,3120 ----
  
  		gettimeofday(&tv_now, NULL);
! 		slon_log(SLON_CONFIG, "remoteWorkerThread_%d: "
  				 "%.3f seconds to copy table %s\n",
  				 node->no_id,
***************
*** 3170,3174 ****
  		char	   *seq_fqname = PQgetvalue(res1, tupno1, 2);
  
! 		slon_log(SLON_DEBUG2, "remoteWorkerThread_%d: "
  				 "set last_value of sequence %s (%s) to %s\n",
  				 node->no_id, seql_seqid, seq_fqname, seql_last_value);
--- 3170,3174 ----
  		char	   *seq_fqname = PQgetvalue(res1, tupno1, 2);
  
! 		slon_log(SLON_CONFIG, "remoteWorkerThread_%d: "
  				 "set last_value of sequence %s (%s) to %s\n",
  				 node->no_id, seql_seqid, seq_fqname, seql_last_value);
***************
*** 3221,3225 ****
  	{
  		gettimeofday(&tv_now, NULL);
! 		slon_log(SLON_DEBUG2, "remoteWorkerThread_%d: "
  				 "%.3f seconds to copy sequences\n",
  				 node->no_id,
--- 3221,3225 ----
  	{
  		gettimeofday(&tv_now, NULL);
! 		slon_log(SLON_INFO, "remoteWorkerThread_%d: "
  				 "%.3f seconds to copy sequences\n",
  				 node->no_id,
***************
*** 3289,3293 ****
  			ssy_xip = event->ev_xip;
  
! 			slon_log(SLON_DEBUG2, "remoteWorkerThread_%d: "
  					 "copy_set no previous SYNC found, use enable event.\n",
  					 node->no_id);
--- 3289,3293 ----
  			ssy_xip = event->ev_xip;
  
! 			slon_log(SLON_INFO, "remoteWorkerThread_%d: "
  					 "copy_set no previous SYNC found, use enable event.\n",
  					 node->no_id);
***************
*** 3357,3361 ****
  				slon_appendquery(&query2, ")");
  
! 			slon_log(SLON_DEBUG2, "remoteWorkerThread_%d: "
  					 "copy_set SYNC found, use event seqno %s.\n",
  					 node->no_id, ssy_seqno);
--- 3357,3361 ----
  				slon_appendquery(&query2, ")");
  
! 			slon_log(SLON_INFO, "remoteWorkerThread_%d: "
  					 "copy_set SYNC found, use event seqno %s.\n",
  					 node->no_id, ssy_seqno);
***************
*** 3511,3515 ****
  	PQclear(res1);
  	gettimeofday(&tv_now, NULL);
! 	slon_log(SLON_DEBUG2, "remoteWorkerThread_%d: "
  			 "%.3f seconds to build initial setsync status\n",
  			 node->no_id,
--- 3511,3515 ----
  	PQclear(res1);
  	gettimeofday(&tv_now, NULL);
! 	slon_log(SLON_INFO, "remoteWorkerThread_%d: "
  			 "%.3f seconds to build initial setsync status\n",
  			 node->no_id,
***************
*** 3544,3548 ****
  
  	gettimeofday(&tv_now, NULL);
! 	slon_log(SLON_DEBUG1, "copy_set %d done in %.3f seconds\n", set_id,
  			 TIMEVAL_DIFF(&tv_start, &tv_now));
  	return 0;
--- 3544,3548 ----
  
  	gettimeofday(&tv_now, NULL);
! 	slon_log(SLON_INFO, "copy_set %d done in %.3f seconds\n", set_id,
  			 TIMEVAL_DIFF(&tv_start, &tv_now));
  	return 0;
***************
*** 3714,3718 ****
  				return 10;
  			}
! 			slon_log(SLON_DEBUG2, "remoteWorkerThread_%d: "
  					 "data provider %d confirmed up to "
  					 "ev_seqno %s for ev_origin %d - OK\n",
--- 3714,3718 ----
  				return 10;
  			}
! 			slon_log(SLON_DEBUG1, "remoteWorkerThread_%d: "
  					 "data provider %d confirmed up to "
  					 "ev_seqno %s for ev_origin %d - OK\n",
***************
*** 3841,3845 ****
  			}
  			ntuples2 = PQntuples(res2);
! 			slon_log(SLON_DEBUG2, "remoteWorkerThread_%d: "
  					 "syncing set %d with %d table(s) from provider %d\n",
  					 node->no_id, sub_set, ntuples2,
--- 3841,3845 ----
  			}
  			ntuples2 = PQntuples(res2);
! 			slon_log(SLON_INFO, "remoteWorkerThread_%d: "
  					 "syncing set %d with %d table(s) from provider %d\n",
  					 node->no_id, sub_set, ntuples2,
***************
*** 4015,4019 ****
  	if (num_sets == 0)
  	{
! 		slon_log(SLON_DEBUG2, "remoteWorkerThread_%d: "
  				 "no sets need syncing for this event\n",
  				 node->no_id);
--- 4015,4019 ----
  	if (num_sets == 0)
  	{
! 		slon_log(SLON_DEBUG1, "remoteWorkerThread_%d: "
  				 "no sets need syncing for this event\n",
  				 node->no_id);
***************
*** 4259,4263 ****
  	}
  
! 	slon_log(SLON_DEBUG4, "remoteWorkerThread_%d: cleanup\n",
  			 node->no_id);
  
--- 4259,4263 ----
  	}
  
! 	slon_log(SLON_DEBUG2, "remoteWorkerThread_%d: cleanup\n",
  			 node->no_id);
  
***************
*** 4426,4430 ****
  			char command[512];
  			sprintf(command, "%s %s", command_on_logarchive, node->archive_name);
! 			slon_log(SLON_INFO, "remoteWorkerThread_%d: Run Archive Command %s\n",
  				 node->no_id, command);
  			system(command);
--- 4426,4430 ----
  			char command[512];
  			sprintf(command, "%s %s", command_on_logarchive, node->archive_name);
! 			slon_log(SLON_DEBUG1, "remoteWorkerThread_%d: Run Archive Command %s\n",
  				 node->no_id, command);
  			system(command);
***************
*** 4438,4442 ****
  	dstring_free(&lsquery);
  	gettimeofday(&tv_now, NULL);
! 	slon_log(SLON_DEBUG2, "remoteWorkerThread_%d: SYNC "
  			 INT64_FORMAT " done in %.3f seconds\n",
  			 node->no_id, event->ev_seqno,
--- 4438,4442 ----
  	dstring_free(&lsquery);
  	gettimeofday(&tv_now, NULL);
! 	slon_log(SLON_INFO, "remoteWorkerThread_%d: SYNC "
  			 INT64_FORMAT " done in %.3f seconds\n",
  			 node->no_id, event->ev_seqno,
***************
*** 4805,4809 ****
  					{
  						gettimeofday(&tv_now, NULL);
! 						slon_log(SLON_DEBUG2,
  								 "remoteHelperThread_%d_%d: %.3f seconds delay for first row\n",
  								 node->no_id, provider->no_id,
--- 4805,4809 ----
  					{
  						gettimeofday(&tv_now, NULL);
! 						slon_log(SLON_DEBUG1,
  								 "remoteHelperThread_%d_%d: %.3f seconds delay for first row\n",
  								 node->no_id, provider->no_id,
***************
*** 5052,5061 ****
  
  		gettimeofday(&tv_now, NULL);
! 		slon_log(SLON_DEBUG2,
  			   "remoteHelperThread_%d_%d: %.3f seconds until close cursor\n",
  				 node->no_id, provider->no_id,
  				 TIMEVAL_DIFF(&tv_start, &tv_now));
  
! 		slon_log(SLON_DEBUG2, "remoteHelperThread_%d_%d: inserts=%d updates=%d deletes=%d\n",
  			 node->no_id, provider->no_id, num_inserts, num_updates, num_deletes);
  
--- 5052,5061 ----
  
  		gettimeofday(&tv_now, NULL);
! 		slon_log(SLON_DEBUG1,
  			   "remoteHelperThread_%d_%d: %.3f seconds until close cursor\n",
  				 node->no_id, provider->no_id,
  				 TIMEVAL_DIFF(&tv_start, &tv_now));
  
! 		slon_log(SLON_INFO, "remoteHelperThread_%d_%d: inserts=%d updates=%d deletes=%d\n",
  			 node->no_id, provider->no_id, num_inserts, num_updates, num_deletes);
  

Index: slon.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/slon.c,v
retrieving revision 1.73
retrieving revision 1.74
diff -C2 -d -r1.73 -r1.74
*** slon.c	14 Jun 2007 14:58:54 -0000	1.73
--- slon.c	27 Jun 2007 16:20:24 -0000	1.74
***************
*** 456,460 ****
  #endif
  
! 	slon_log(SLON_DEBUG2, "main: main process started\n");
  
  	/*
--- 456,460 ----
  #endif
  
! 	slon_log(SLON_INFO, "main: main process started\n");
  
  	/*
***************
*** 784,788 ****
  	struct sigaction act;
  #endif
! 	slon_log(SLON_DEBUG2, "slon: watchdog process started\n");
  
  	/*
--- 784,788 ----
  	struct sigaction act;
  #endif
! 	slon_log(SLON_INFO, "slon: watchdog process started\n");
  
  	/*
***************
*** 834,838 ****
  	}
  
! 	slon_log(SLON_DEBUG2, "slon: watchdog ready - pid = %d\n", slon_watchdog_pid);
  
  	slon_worker_pid = fork();
--- 834,838 ----
  	}
  
! 	slon_log(SLON_CONFIG, "slon: watchdog ready - pid = %d\n", slon_watchdog_pid);
  
  	slon_worker_pid = fork();
***************
*** 843,847 ****
  	}
  
! 	slon_log(SLON_DEBUG2, "slon: worker process created - pid = %d\n",
  			 slon_worker_pid);
  	while ((pid = wait(&child_status)) != slon_worker_pid)
--- 843,847 ----
  	}
  
! 	slon_log(SLON_CONFIG, "slon: worker process created - pid = %d\n",
  			 slon_worker_pid);
  	while ((pid = wait(&child_status)) != slon_worker_pid)
***************
*** 978,986 ****
  	if (pid_file)
  	{
! 		slon_log(SLON_DEBUG2, "slon: remove pid file\n");
  		(void) unlink(pid_file);
  	}
  
! 	slon_log(SLON_DEBUG2, "slon: exit(%d)\n", code);
  
  	exit(code);
--- 978,986 ----
  	if (pid_file)
  	{
! 		slon_log(SLON_INFO, "slon: remove pid file\n");
  		(void) unlink(pid_file);
  	}
  
! 	slon_log(SLON_INFO, "slon: exit(%d)\n", code);
  
  	exit(code);

Index: confoptions.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/confoptions.c,v
retrieving revision 1.23
retrieving revision 1.24
diff -C2 -d -r1.23 -r1.24
*** confoptions.c	20 Apr 2007 20:53:18 -0000	1.23
--- confoptions.c	27 Jun 2007 16:20:24 -0000	1.24
***************
*** 451,455 ****
  				else
  				{
! 					slon_log(SLON_DEBUG2, "parameter \"%s\"\n", name);
  				}
  
--- 451,455 ----
  				else
  				{
! 					slon_log(SLON_CONFIG, "parameter \"%s\"\n", name);
  				}
  
***************
*** 479,483 ****
  				else
  				{
! 					slon_log(SLON_DEBUG2, "parameter \"%s\"\n", name);
  				}
  				*conf->variable = newval;
--- 479,483 ----
  				else
  				{
! 					slon_log(SLON_CONFIG, "parameter \"%s\"\n", name);
  				}
  				*conf->variable = newval;
***************
*** 507,511 ****
  				else
  				{
! 					slon_log(SLON_DEBUG2, "parameter \"%s\"\n", name);
  				}
  				*conf->variable = newval;
--- 507,511 ----
  				else
  				{
! 					slon_log(SLON_CONFIG, "parameter \"%s\"\n", name);
  				}
  				*conf->variable = newval;
***************
*** 527,531 ****
  				else
  				{
! 					slon_log(SLON_DEBUG2, "parameter \"%s\"\n", name);
  					free(newval);
  				}
--- 527,531 ----
  				else
  				{
! 					slon_log(SLON_CONFIG, "parameter \"%s\"\n", name);
  					free(newval);
  				}

From cbbrowne at lists.slony.info  Wed Jun 27 10:56:13 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Wed Jun 27 10:56:16 2007
Subject: [Slony1-commit] slony1-engine/doc/adminguide loganalysis.sgml
	slon.sgml slonconf.sgml slonik_ref.sgml
Message-ID: <20070627175614.07F072903C1@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/doc/adminguide
In directory main.slony.info:/tmp/cvs-serv11788

Modified Files:
	loganalysis.sgml slon.sgml slonconf.sgml slonik_ref.sgml 
Log Message:
Update admin guide docs to reflect changes in logging in Slony-I 2.0
in that "interesting" messages have gotten promoted to INFO/CONFIG
so that users could run slon at "-d 0" and get meaningful logs.


Index: slon.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/slon.sgml,v
retrieving revision 1.30
retrieving revision 1.31
diff -C2 -d -r1.30 -r1.31
*** slon.sgml	2 Jan 2007 20:16:58 -0000	1.30
--- slon.sgml	27 Jun 2007 17:56:11 -0000	1.31
***************
*** 64,71 ****
  
       <para> The first five non-debugging log levels (from Fatal to
!      Info) are <emphasis>always</emphasis> displayed in the logs.  If
!      <envar>log_level</envar> is set to 2 (a routine, and, seemingly,
!      preferable choice), then output at debugging levels 1 and 2 will
!      also be displayed.</para>
  
      </listitem>
--- 64,74 ----
  
       <para> The first five non-debugging log levels (from Fatal to
!      Info) are <emphasis>always</emphasis> displayed in the logs.  In
!      early versions of &slony1;, the <quote>suggested</quote>
!      <envar>log_level</envar> value was 2, which would list output at
!      all levels down to debugging level 2.  In &slony1; version 2, it
!      is recommended to set <envar>log_level</envar> to 0; most of the
!      consistently interesting log information is generated at levels
!      higher than that. </para>
  
      </listitem>

Index: slonconf.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/slonconf.sgml,v
retrieving revision 1.16
retrieving revision 1.17
diff -C2 -d -r1.16 -r1.17
*** slonconf.sgml	2 Feb 2007 20:24:16 -0000	1.16
--- slonconf.sgml	27 Jun 2007 17:56:11 -0000	1.17
***************
*** 87,96 ****
        </indexterm>
        <listitem>
!         <para>Debug log level (higher value ==> more output).  Range: [0,4], default 2</para>
  
  	<para> There are <link linkend="nineloglevels">nine log
! 	message types</link>; using this option, some or all of
! 	the <quote>debugging</quote> levels may be left out of the
! 	slon logs. </para>
  
        </listitem>
--- 87,101 ----
        </indexterm>
        <listitem>
!         <para>Debug log level (higher value ==> more output).  Range: [0,4], default 0</para>
  
  	<para> There are <link linkend="nineloglevels">nine log
! 	message types</link>; using this option, some or all of the
! 	<quote>debugging</quote> levels may be left out of the slon
! 	logs.  In &slony1; version 2, a lot of log message levels have
! 	been revised in an attempt to ensure the <quote>interesting
! 	stuff</quote> comes in at CONFIG/INFO levels, so that you
! 	could run at level 0, omitting all of the <quote>DEBUG</quote>
! 	messages, and still have meaningful contents in the
! 	logs. </para>
  
        </listitem>

Index: slonik_ref.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/slonik_ref.sgml,v
retrieving revision 1.71
retrieving revision 1.72
diff -C2 -d -r1.71 -r1.72
*** slonik_ref.sgml	22 Jun 2007 16:15:57 -0000	1.71
--- slonik_ref.sgml	27 Jun 2007 17:56:11 -0000	1.72
***************
*** 2396,2400 ****
       instead of <command>FAILOVER</command>, if at all possible, as
       <command>FAILOVER</command> winds up discarding the old origin
!      node as being corrupted.</para>
       
      <para> Note that this is a &rlocking; operation, which means that
--- 2396,2402 ----
       instead of <command>FAILOVER</command>, if at all possible, as
       <command>FAILOVER</command> winds up discarding the old origin
!      node as being corrupted. Before <commadand>MOVE SET</command> will
!      function a <command>LOCK SET</command> is needed.
! </para>
       
      <para> Note that this is a &rlocking; operation, which means that
***************
*** 2422,2425 ****
--- 2424,2431 ----
     <refsect1><title>Example</title>
      <programlisting>
+ LOCK SET (
+    ID = 1,
+    ORIGIN = 1
+ );
  MOVE SET (
     ID = 1,

Index: loganalysis.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/loganalysis.sgml,v
retrieving revision 1.9
retrieving revision 1.10
diff -C2 -d -r1.9 -r1.10
*** loganalysis.sgml	11 Jun 2007 16:02:50 -0000	1.9
--- loganalysis.sgml	27 Jun 2007 17:56:11 -0000	1.10
***************
*** 26,33 ****
  </screen></para></sect2>
  
  <sect2><title>DEBUG Notices</title>
  
! <para>Debug notices are always prefaced by the name of the thread that
! the notice originates from. You will see messages from the following
  threads:
  
--- 26,48 ----
  </screen></para></sect2>
  
+ <sect2><title>INFO notices</title>
+ 
+ <para> Events that take place that seem like they will generally be of
+ interest are recorded at the INFO level, and, just as with CONFIG
+ notices, are always listed. </para>
+ 
+ </sect2>
+ 
  <sect2><title>DEBUG Notices</title>
  
! <para>Debug notices are of less interest, and will quite likely only
! need to be shown if you are running into some problem with &slony1;.</para>
! 
! </sect2>
! 
! <sect2><title>Thread name </title>
! 
! <para> Notices are always prefaced by the name of the thread from
! which the notice originates. You will see messages from the following
  threads:
  
***************
*** 60,68 ****
  </para>
  
! <para> How much information they display is controlled by
! the <envar>log_level</envar> &lslon; parameter;
! ERROR/WARN/CONFIG/INFO messages will always be displayed, while
! choosing increasing values from 1 to 4 will lead to additional DEBUG
! level messages being displayed. </para>
  </sect2>
  
--- 75,83 ----
  </para>
  
! <para> How much information they display is controlled by the
! <envar>log_level</envar> &lslon; parameter; ERROR/WARN/CONFIG/INFO
! messages will always be displayed, while choosing increasing values
! from 1 to 4 will lead to additional DEBUG level messages being
! displayed. </para>
  </sect2>
  
***************
*** 177,185 ****
  <para> This section lists numerous of the error messages found in
  &slony1;, along with a brief explanation of implications.  It is a
! fairly well comprehensive list, leaving out mostly some of
! the <command>DEBUG4</command> messages that are generally
  uninteresting.</para>
  
! <sect3 id="logshiplog"><title> Log Messages Associated with Log Shipping </title>
  
  <para> Most of these represent errors that come up if
--- 192,201 ----
  <para> This section lists numerous of the error messages found in
  &slony1;, along with a brief explanation of implications.  It is a
! fairly comprehensive list, only leaving out some of the
! <command>DEBUG4</command> messages that are almost always
  uninteresting.</para>
  
! <sect3 id="logshiplog"><title> Log Messages Associated with Log
! Shipping </title>
  
  <para> Most of these represent errors that come up if

From wieck at lists.slony.info  Thu Jun 28 09:19:59 2007
From: wieck at lists.slony.info (Jan Wieck)
Date: Thu Jun 28 09:20:00 2007
Subject: [Slony1-commit] slony1-engine/src/xxid xxid.v74.sql
Message-ID: <20070628161959.0D89B290C15@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/xxid
In directory main.slony.info:/tmp/cvs-serv26938

Removed Files:
	xxid.v74.sql 
Log Message:
Remove traces of pre-8.3 support.

Jan


--- xxid.v74.sql DELETED ---

From cbbrowne at lists.slony.info  Thu Jun 28 12:49:26 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Thu Jun 28 12:49:27 2007
Subject: [Slony1-commit] slony1-www/content news.txt
Message-ID: <20070628194926.2B6D9290C09@main.slony.info>

Update of /home/cvsd/slony1/slony1-www/content
In directory main.slony.info:/tmp/cvs-serv30321/content

Modified Files:
	news.txt 
Log Message:
Add RPM build notes to news


Index: news.txt
===================================================================
RCS file: /home/cvsd/slony1/slony1-www/content/news.txt,v
retrieving revision 1.28
retrieving revision 1.29
diff -C2 -d -r1.28 -r1.29
*** news.txt	27 Jun 2007 14:41:03 -0000	1.28
--- news.txt	28 Jun 2007 19:49:24 -0000	1.29
***************
*** 11,14 ****
--- 11,30 ----
  <!-- Please keep this item at the top of the news list -->
  ---
+ Generating RPMS for Slony-I
+ http://slony.info/
+ 2007-06-28
+ Devrim Gunduz
+ 
+ RPM "spec" files are a part of the Slony-I build; if you require RPMs
+ for your flavour of RPM-based distribution, try building Slony-I thus:
+ 
+ <pre>
+ ./configure
+ make rpm
+ </pre>
+ 
+ For systems reasonably similar to Fedora and RHAS, this will generate
+ .rpm files that will be compatible with your system.
+ ---
  Turkish Documentation for Slony-I
  http://www.enderunix.org/docs/postgresql/

From cbbrowne at lists.slony.info  Fri Jun 29 07:48:33 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Fri Jun 29 07:48:34 2007
Subject: [Slony1-commit] slony1-engine/tests/test2 README gen_weak_user.sh
	generate_dml.sh init_add_tables.ik init_cluster.ik
	init_create_set.ik init_data.sql init_dropnode.sh
	init_failover.ik init_schema.sql init_subscribe_set.ik
	schema.diff settings.ik
Message-ID: <20070629144833.4A2C8290410@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/tests/test2
In directory main.slony.info:/tmp/cvs-serv10378/test2

Removed Files:
	README gen_weak_user.sh generate_dml.sh init_add_tables.ik 
	init_cluster.ik init_create_set.ik init_data.sql 
	init_dropnode.sh init_failover.ik init_schema.sql 
	init_subscribe_set.ik schema.diff settings.ik 
Log Message:
Remove useless test "test2"


--- settings.ik DELETED ---

--- init_cluster.ik DELETED ---

--- init_failover.ik DELETED ---

--- gen_weak_user.sh DELETED ---

--- generate_dml.sh DELETED ---

--- init_add_tables.ik DELETED ---

--- init_create_set.ik DELETED ---

--- init_data.sql DELETED ---

--- init_schema.sql DELETED ---

--- schema.diff DELETED ---

--- README DELETED ---

--- init_subscribe_set.ik DELETED ---

--- init_dropnode.sh DELETED ---

