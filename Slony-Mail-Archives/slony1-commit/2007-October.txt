From cbbrowne at lists.slony.info  Thu Oct  4 08:17:40 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Thu Oct  4 08:17:42 2007
Subject: [Slony1-commit] slony1-engine/tools launch_clusters.sh
Message-ID: <20071004151740.8BE0A290D12@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/tools
In directory main.slony.info:/tmp/cvs-serv8304

Modified Files:
      Tag: REL_1_2_STABLE
	launch_clusters.sh 
Log Message:
Cut quotes off of PID filename in slon.conf file


Index: launch_clusters.sh
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tools/launch_clusters.sh,v
retrieving revision 1.2.2.2
retrieving revision 1.2.2.3
diff -C2 -d -r1.2.2.2 -r1.2.2.3
*** launch_clusters.sh	15 Nov 2006 20:01:33 -0000	1.2.2.2
--- launch_clusters.sh	4 Oct 2007 15:17:38 -0000	1.2.2.3
***************
*** 63,67 ****
      if [[ -e $CONFIGPATH/conf/node${NODENUM}.conf ]] ; then
  	SLONCONF="$CONFIGPATH/conf/node${NODENUM}.conf"
! 	SLONPIDFILE=`grep "^ *pid_file=" $SLONCONF | cut -d "=" -f 2 | cut -d "#" -f 1 | cut -d " " -f 1`
  	CLUSTER=`grep "^ *cluster_name=" $SLONCONF | cut -d "=" -f 2 | cut -d "'" -f 2`
      else
--- 63,67 ----
      if [[ -e $CONFIGPATH/conf/node${NODENUM}.conf ]] ; then
  	SLONCONF="$CONFIGPATH/conf/node${NODENUM}.conf"
! 	SLONPIDFILE=`grep "^ *pid_file=" $SLONCONF | cut -d "=" -f 2 | cut -d "#" -f 1 | cut -d " " -f 1 | cut -d "'" -f 2`
  	CLUSTER=`grep "^ *cluster_name=" $SLONCONF | cut -d "=" -f 2 | cut -d "'" -f 2`
      else

From cbbrowne at lists.slony.info  Thu Oct  4 08:20:18 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Thu Oct  4 08:20:21 2007
Subject: [Slony1-commit] slony1-engine/src/slony_logshipper
	slony_logshipper.h
Message-ID: <20071004152018.90B83290D4E@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slony_logshipper
In directory main.slony.info:/tmp/cvs-serv8429

Modified Files:
      Tag: REL_1_2_STABLE
	slony_logshipper.h 
Log Message:
Remove errlog_messages from .h file - it is NOT an exported name


Index: slony_logshipper.h
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slony_logshipper/slony_logshipper.h,v
retrieving revision 1.1.2.2
retrieving revision 1.1.2.3
diff -C2 -d -r1.1.2.2 -r1.1.2.3
*** slony_logshipper.h	27 Sep 2007 18:03:02 -0000	1.1.2.2
--- slony_logshipper.h	4 Oct 2007 15:20:16 -0000	1.1.2.3
***************
*** 168,172 ****
  extern bool			shutdown_smart_requested;
  extern bool			shutdown_immed_requested;
! extern SlonDString	errlog_messages;
  
  extern char		   *archive_dir;
--- 168,172 ----
  extern bool			shutdown_smart_requested;
  extern bool			shutdown_immed_requested;
! /* extern SlonDString	errlog_messages; */
  
  extern char		   *archive_dir;

From cbbrowne at lists.slony.info  Thu Oct  4 08:21:16 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Thu Oct  4 08:21:17 2007
Subject: [Slony1-commit] slony1-engine/src/slon local_listen.c
Message-ID: <20071004152116.43B29290D1C@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slon
In directory main.slony.info:/tmp/cvs-serv8473/slon

Modified Files:
      Tag: REL_1_2_STABLE
	local_listen.c 
Log Message:
Add newlines to local_listen logging calls


Index: local_listen.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/local_listen.c,v
retrieving revision 1.38.2.2
retrieving revision 1.38.2.3
diff -C2 -d -r1.38.2.2 -r1.38.2.3
*** local_listen.c	27 Oct 2006 20:09:56 -0000	1.38.2.2
--- local_listen.c	4 Oct 2007 15:21:14 -0000	1.38.2.3
***************
*** 79,83 ****
  	{
  		slon_log(SLON_FATAL,
! 				 "localListenThread: \"%s\" - %s",
  				 dstring_data(&query1), PQresultErrorMessage(res));
  		PQclear(res);
--- 79,83 ----
  	{
  		slon_log(SLON_FATAL,
! 				 "localListenThread: \"%s\" - %s\n",
  				 dstring_data(&query1), PQresultErrorMessage(res));
  		PQclear(res);
***************
*** 139,143 ****
  		{
  			slon_log(SLON_FATAL,
! 					 "localListenThread: cannot start transaction - %s",
  					 PQresultErrorMessage(res));
  			PQclear(res);
--- 139,143 ----
  		{
  			slon_log(SLON_FATAL,
! 					 "localListenThread: cannot start transaction - %s\n",
  					 PQresultErrorMessage(res));
  			PQclear(res);
***************
*** 190,194 ****
  		{
  			slon_log(SLON_FATAL,
! 					 "localListenThread: \"%s\" - %s",
  					 dstring_data(&query1), PQresultErrorMessage(res));
  			PQclear(res);
--- 190,194 ----
  		{
  			slon_log(SLON_FATAL,
! 					 "localListenThread: \"%s\" - %s\n",
  					 dstring_data(&query1), PQresultErrorMessage(res));
  			PQclear(res);
***************
*** 279,283 ****
  				if (PQresultStatus(notify_res) != PGRES_COMMAND_OK)
  				{
! 					slon_log(SLON_FATAL, "localListenThread: \"%s\" %s",
  							 notify_query, PQresultErrorMessage(notify_res));
  					PQclear(notify_res);
--- 279,283 ----
  				if (PQresultStatus(notify_res) != PGRES_COMMAND_OK)
  				{
! 					slon_log(SLON_FATAL, "localListenThread: \"%s\" %s\n",
  							 notify_query, PQresultErrorMessage(notify_res));
  					PQclear(notify_res);
***************
*** 517,521 ****
  				if (PQresultStatus(res2) != PGRES_TUPLES_OK)
  				{
! 					slon_log(SLON_FATAL, "localListenThread: \"%s\" %s",
  							 dstring_data(&query2),
  							 PQresultErrorMessage(res2));
--- 517,521 ----
  				if (PQresultStatus(res2) != PGRES_TUPLES_OK)
  				{
! 					slon_log(SLON_FATAL, "localListenThread: \"%s\" %s\n",
  							 dstring_data(&query2),
  							 PQresultErrorMessage(res2));
***************
*** 629,633 ****
  				 * Nothing to do locally
  				 */
! 				slon_log(SLON_DEBUG2, "localListenThread: ACCEPT_SET");
  				rtcfg_reloadListen(dbconn);
  			}
--- 629,633 ----
  				 * Nothing to do locally
  				 */
! 				slon_log(SLON_DEBUG2, "localListenThread: ACCEPT_SET\n");
  				rtcfg_reloadListen(dbconn);
  			}
***************
*** 653,657 ****
  			{
  				slon_log(SLON_FATAL,
! 						 "localListenThread: \"%s\" - %s",
  						 dstring_data(&query1), PQresultErrorMessage(res));
  				PQclear(res);
--- 653,657 ----
  			{
  				slon_log(SLON_FATAL,
! 						 "localListenThread: \"%s\" - %s\n",
  						 dstring_data(&query1), PQresultErrorMessage(res));
  				PQclear(res);
***************
*** 677,681 ****
  			{
  				slon_log(SLON_FATAL,
! 						 "localListenThread: \"rollback transaction;\" - %s",
  						 PQresultErrorMessage(res));
  				PQclear(res);
--- 677,681 ----
  			{
  				slon_log(SLON_FATAL,
! 						 "localListenThread: \"rollback transaction;\" - %s\n",
  						 PQresultErrorMessage(res));
  				PQclear(res);

From cbbrowne at lists.slony.info  Thu Oct  4 08:22:42 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Thu Oct  4 08:22:43 2007
Subject: [Slony1-commit] slony1-engine RELEASE
Message-ID: <20071004152242.804BD290D4E@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine
In directory main.slony.info:/tmp/cvs-serv8519

Modified Files:
      Tag: REL_1_2_STABLE
	RELEASE 
Log Message:
Update release notes


Index: RELEASE
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/RELEASE,v
retrieving revision 1.1.2.17
retrieving revision 1.1.2.18
diff -C2 -d -r1.1.2.17 -r1.1.2.18
*** RELEASE	28 Sep 2007 21:17:12 -0000	1.1.2.17
--- RELEASE	4 Oct 2007 15:22:40 -0000	1.1.2.18
***************
*** 24,27 ****
--- 24,33 ----
    that the lock on the archive counter table serializes archive creation.
  
+ - Fixed logging done in local_listener.c - various places, there was
+   no '\n' in some cases, which would lead to entries being folded
+   together.
+ 
+ - Fix launch_slons.sh - was not stripping quotes from PID file name
+ 
  RELEASE 1.2.11
  

From cbbrowne at lists.slony.info  Thu Oct  4 08:28:01 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Thu Oct  4 08:28:04 2007
Subject: [Slony1-commit] slony1-engine configure
Message-ID: <20071004152802.1E226290D1C@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine
In directory main.slony.info:/tmp/cvs-serv8642

Modified Files:
      Tag: REL_1_2_STABLE
	configure 
Log Message:
Ran autoconf to generate fresh configure script


Index: configure
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/configure,v
retrieving revision 1.70.2.7
retrieving revision 1.70.2.8
diff -C2 -d -r1.70.2.7 -r1.70.2.8
*** configure	29 Aug 2007 05:44:57 -0000	1.70.2.7
--- configure	4 Oct 2007 15:27:59 -0000	1.70.2.8
***************
*** 1,5 ****
  #! /bin/sh
  # Guess values for system-dependent variables and create Makefiles.
! # Generated by GNU Autoconf 2.61 for postgresql-slony1 HEAD_20070509.
  #
  # Copyright (C) 1992, 1993, 1994, 1995, 1996, 1998, 1999, 2000, 2001,
--- 1,5 ----
  #! /bin/sh
  # Guess values for system-dependent variables and create Makefiles.
! # Generated by GNU Autoconf 2.61 for postgresql-slony1 1.2.STABLE.
  #
  # Copyright (C) 1992, 1993, 1994, 1995, 1996, 1998, 1999, 2000, 2001,
***************
*** 573,578 ****
  PACKAGE_NAME='postgresql-slony1'
  PACKAGE_TARNAME='postgresql-slony1'
! PACKAGE_VERSION='HEAD_20070509'
! PACKAGE_STRING='postgresql-slony1 HEAD_20070509'
  PACKAGE_BUGREPORT=''
  
--- 573,578 ----
  PACKAGE_NAME='postgresql-slony1'
  PACKAGE_TARNAME='postgresql-slony1'
! PACKAGE_VERSION='1.2.STABLE'
! PACKAGE_STRING='postgresql-slony1 1.2.STABLE'
  PACKAGE_BUGREPORT=''
  
***************
*** 676,680 ****
  YFLAGS
  LEXFLAGS
! HEAD_20070509
  with_gnu_ld
  enable_rpath
--- 676,680 ----
  YFLAGS
  LEXFLAGS
! 1.2.STABLE
  with_gnu_ld
  enable_rpath
***************
*** 1237,1241 ****
    # This message is too long to be a string in the A/UX 3.1 sh.
    cat <<_ACEOF
! \`configure' configures postgresql-slony1 HEAD_20070509 to adapt to many kinds of systems.
  
  Usage: $0 [OPTION]... [VAR=VALUE]...
--- 1237,1241 ----
    # This message is too long to be a string in the A/UX 3.1 sh.
    cat <<_ACEOF
! \`configure' configures postgresql-slony1 1.2.STABLE to adapt to many kinds of systems.
  
  Usage: $0 [OPTION]... [VAR=VALUE]...
***************
*** 1302,1306 ****
  if test -n "$ac_init_help"; then
    case $ac_init_help in
!      short | recursive ) echo "Configuration of postgresql-slony1 HEAD_20070509:";;
     esac
    cat <<\_ACEOF
--- 1302,1306 ----
  if test -n "$ac_init_help"; then
    case $ac_init_help in
!      short | recursive ) echo "Configuration of postgresql-slony1 1.2.STABLE:";;
     esac
    cat <<\_ACEOF
***************
*** 1407,1411 ****
  if $ac_init_version; then
    cat <<\_ACEOF
! postgresql-slony1 configure HEAD_20070509
  generated by GNU Autoconf 2.61
  
--- 1407,1411 ----
  if $ac_init_version; then
    cat <<\_ACEOF
! postgresql-slony1 configure 1.2.STABLE
  generated by GNU Autoconf 2.61
  
***************
*** 1421,1425 ****
  running configure, to aid debugging if configure makes a mistake.
  
! It was created by postgresql-slony1 $as_me HEAD_20070509, which was
  generated by GNU Autoconf 2.61.  Invocation command line was
  
--- 1421,1425 ----
  running configure, to aid debugging if configure makes a mistake.
  
! It was created by postgresql-slony1 $as_me 1.2.STABLE, which was
  generated by GNU Autoconf 2.61.  Invocation command line was
  
***************
*** 11139,11143 ****
  # values after options handling.
  ac_log="
! This file was extended by postgresql-slony1 $as_me HEAD_20070509, which was
  generated by GNU Autoconf 2.61.  Invocation command line was
  
--- 11139,11143 ----
  # values after options handling.
  ac_log="
! This file was extended by postgresql-slony1 $as_me 1.2.STABLE, which was
  generated by GNU Autoconf 2.61.  Invocation command line was
  
***************
*** 11188,11192 ****
  cat >>$CONFIG_STATUS <<_ACEOF
  ac_cs_version="\\
! postgresql-slony1 config.status HEAD_20070509
  configured by $0, generated by GNU Autoconf 2.61,
    with options \\"`echo "$ac_configure_args" | sed 's/^ //; s/[\\""\`\$]/\\\\&/g'`\\"
--- 11188,11192 ----
  cat >>$CONFIG_STATUS <<_ACEOF
  ac_cs_version="\\
! postgresql-slony1 config.status 1.2.STABLE
  configured by $0, generated by GNU Autoconf 2.61,
    with options \\"`echo "$ac_configure_args" | sed 's/^ //; s/[\\""\`\$]/\\\\&/g'`\\"
***************
*** 11423,11427 ****
  YFLAGS!$YFLAGS$ac_delim
  LEXFLAGS!$LEXFLAGS$ac_delim
! HEAD_20070509!$HEAD_20070509$ac_delim
  with_gnu_ld!$with_gnu_ld$ac_delim
  enable_rpath!$enable_rpath$ac_delim
--- 11423,11427 ----
  YFLAGS!$YFLAGS$ac_delim
  LEXFLAGS!$LEXFLAGS$ac_delim
! 1.2.STABLE!$1.2.STABLE$ac_delim
  with_gnu_ld!$with_gnu_ld$ac_delim
  enable_rpath!$enable_rpath$ac_delim

From cbbrowne at lists.slony.info  Thu Oct  4 08:29:43 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Thu Oct  4 08:29:45 2007
Subject: [Slony1-commit] slony1-engine configure
Message-ID: <20071004152944.0CE1E290D4E@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine
In directory main.slony.info:/tmp/cvs-serv8712

Modified Files:
	configure 
Log Message:
Ran autoconf to generate fresh configure


Index: configure
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/configure,v
retrieving revision 1.72
retrieving revision 1.73
diff -C2 -d -r1.72 -r1.73
*** configure	31 Oct 2006 22:09:39 -0000	1.72
--- configure	4 Oct 2007 15:29:41 -0000	1.73
***************
*** 1,5 ****
  #! /bin/sh
  # Guess values for system-dependent variables and create Makefiles.
! # Generated by GNU Autoconf 2.60a for postgresql-slony1-engine HEAD_20061031.
  #
  # Copyright (C) 1992, 1993, 1994, 1995, 1996, 1998, 1999, 2000, 2001,
--- 1,5 ----
  #! /bin/sh
  # Guess values for system-dependent variables and create Makefiles.
! # Generated by GNU Autoconf 2.61 for slony1 HEAD_20071004.
  #
[...4588 lines suppressed...]
    cat >conf$$subs.sed <<_ACEOF
+ PNMTOPS!$PNMTOPS$ac_delim
+ CONVERT!$CONVERT$ac_delim
+ PGAUTODOC!$PGAUTODOC$ac_delim
+ NSGMLS!$NSGMLS$ac_delim
  SGMLSPL!$SGMLSPL$ac_delim
  d2mdir!$d2mdir$ac_delim
***************
*** 12727,12731 ****
  _ACEOF
  
!   if test `sed -n "s/.*$ac_delim\$/X/p" conf$$subs.sed | grep -c X` = 9; then
      break
    elif $ac_last_try; then
--- 11441,11445 ----
  _ACEOF
  
!   if test `sed -n "s/.*$ac_delim\$/X/p" conf$$subs.sed | grep -c X` = 13; then
      break
    elif $ac_last_try; then

From cbbrowne at lists.slony.info  Thu Oct  4 08:30:36 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Thu Oct  4 08:30:38 2007
Subject: [Slony1-commit] slony1-engine/tools launch_clusters.sh
Message-ID: <20071004153036.C1A97290D62@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/tools
In directory main.slony.info:/tmp/cvs-serv8747/tools

Modified Files:
	launch_clusters.sh 
Log Message:
Strip quotes from PID file name in slon.conf file


Index: launch_clusters.sh
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tools/launch_clusters.sh,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** launch_clusters.sh	15 Nov 2006 20:01:11 -0000	1.4
--- launch_clusters.sh	4 Oct 2007 15:30:34 -0000	1.5
***************
*** 63,67 ****
      if [[ -e $CONFIGPATH/conf/node${NODENUM}.conf ]] ; then
  	SLONCONF="$CONFIGPATH/conf/node${NODENUM}.conf"
! 	SLONPIDFILE=`grep "^ *pid_file=" $SLONCONF | cut -d "=" -f 2 | cut -d "#" -f 1 | cut -d " " -f 1`
  	CLUSTER=`grep "^ *cluster_name=" $SLONCONF | cut -d "=" -f 2 | cut -d "'" -f 2`
      else
--- 63,67 ----
      if [[ -e $CONFIGPATH/conf/node${NODENUM}.conf ]] ; then
  	SLONCONF="$CONFIGPATH/conf/node${NODENUM}.conf"
! 	SLONPIDFILE=`grep "^ *pid_file=" $SLONCONF | cut -d "=" -f 2 | cut -d "#" -f 1 | cut -d " " -f 1 | cut -d "'" -f 2`
  	CLUSTER=`grep "^ *cluster_name=" $SLONCONF | cut -d "=" -f 2 | cut -d "'" -f 2`
      else

From cbbrowne at lists.slony.info  Thu Oct  4 08:31:46 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Thu Oct  4 08:31:46 2007
Subject: [Slony1-commit] slony1-engine/tests/testddl bad_ddl.sql exec_ddl.sh
Message-ID: <20071004153146.14B73290D4E@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/tests/testddl
In directory main.slony.info:/tmp/cvs-serv8781

Modified Files:
	exec_ddl.sh 
Added Files:
	bad_ddl.sql 
Log Message:
Add a negative test to DDL script test: try to run some wrong SQL


--- NEW FILE: bad_ddl.sql ---
-- There Is No table "snobol"
alter table snobol add column id integer not null unique;
Index: exec_ddl.sh
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tests/testddl/exec_ddl.sh,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** exec_ddl.sh	29 Mar 2006 17:10:31 -0000	1.2
--- exec_ddl.sh	4 Oct 2007 15:31:44 -0000	1.3
***************
*** 6,8 ****
--- 6,21 ----
         EVENT NODE = 1
      );
+ 
+   try {
+        execute script (
+             set id=1,
+             filename='${testname}/bad_ddl.sql',
+             event node=1
+        );
+   } on error {
+      echo 'a bad DDL script gets rolled back on the master';
+   } on success {
+      echo 'a bad DDL script did not get rolled back - ERROR!';
+      exit -1;
+   }
  "

From cbbrowne at lists.slony.info  Thu Oct  4 08:32:33 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Thu Oct  4 08:32:34 2007
Subject: [Slony1-commit] slony1-engine/tests support_funcs.sh
Message-ID: <20071004153233.8CA24290D62@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/tests
In directory main.slony.info:/tmp/cvs-serv8801

Modified Files:
	support_funcs.sh 
Log Message:
make "hostname" arguments more portable (after Mac OS-X testing)


Index: support_funcs.sh
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tests/support_funcs.sh,v
retrieving revision 1.6
retrieving revision 1.7
diff -C2 -d -r1.6 -r1.7
*** support_funcs.sh	11 Jul 2007 17:20:18 -0000	1.6
--- support_funcs.sh	4 Oct 2007 15:32:31 -0000	1.7
***************
*** 209,213 ****
      UNAMES=`uname -s`
      UNAMEV=`uname -v`
!     HOST=`hostname -f`
      USERNAME=`whoami`
      
--- 209,213 ----
      UNAMES=`uname -s`
      UNAMEV=`uname -v`
!     HOST=`hostname`
      USERNAME=`whoami`
      

From cbbrowne at lists.slony.info  Thu Oct  4 08:33:47 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Thu Oct  4 08:33:48 2007
Subject: [Slony1-commit] slony1-engine/src/slon local_listen.c
Message-ID: <20071004153347.A347D290D4E@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slon
In directory main.slony.info:/tmp/cvs-serv8854

Modified Files:
	local_listen.c 
Log Message:
Add newlines to logging statements that were getting combined
with the previous line


Index: local_listen.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/local_listen.c,v
retrieving revision 1.42
retrieving revision 1.43
diff -C2 -d -r1.42 -r1.43
*** local_listen.c	27 Jun 2007 16:20:24 -0000	1.42
--- local_listen.c	4 Oct 2007 15:33:45 -0000	1.43
***************
*** 76,80 ****
  	{
  		slon_log(SLON_FATAL,
! 				 "localListenThread: \"%s\" - %s",
  				 dstring_data(&query1), PQresultErrorMessage(res));
  		PQclear(res);
--- 76,80 ----
  	{
  		slon_log(SLON_FATAL,
! 				 "localListenThread: \"%s\" - %s\n",
  				 dstring_data(&query1), PQresultErrorMessage(res));
  		PQclear(res);
***************
*** 136,140 ****
  		{
  			slon_log(SLON_FATAL,
! 					 "localListenThread: cannot start transaction - %s",
  					 PQresultErrorMessage(res));
  			PQclear(res);
--- 136,140 ----
  		{
  			slon_log(SLON_FATAL,
! 					 "localListenThread: cannot start transaction - %s\n",
  					 PQresultErrorMessage(res));
  			PQclear(res);
***************
*** 187,191 ****
  		{
  			slon_log(SLON_FATAL,
! 					 "localListenThread: \"%s\" - %s",
  					 dstring_data(&query1), PQresultErrorMessage(res));
  			PQclear(res);
--- 187,191 ----
  		{
  			slon_log(SLON_FATAL,
! 					 "localListenThread: \"%s\" - %s\n",
  					 dstring_data(&query1), PQresultErrorMessage(res));
  			PQclear(res);
***************
*** 276,280 ****
  				if (PQresultStatus(notify_res) != PGRES_COMMAND_OK)
  				{
! 					slon_log(SLON_FATAL, "localListenThread: \"%s\" %s",
  							 notify_query, PQresultErrorMessage(notify_res));
  					PQclear(notify_res);
--- 276,280 ----
  				if (PQresultStatus(notify_res) != PGRES_COMMAND_OK)
  				{
! 					slon_log(SLON_FATAL, "localListenThread: \"%s\" %s\n",
  							 notify_query, PQresultErrorMessage(notify_res));
  					PQclear(notify_res);
***************
*** 514,518 ****
  				if (PQresultStatus(res2) != PGRES_TUPLES_OK)
  				{
! 					slon_log(SLON_FATAL, "localListenThread: \"%s\" %s",
  							 dstring_data(&query2),
  							 PQresultErrorMessage(res2));
--- 514,518 ----
  				if (PQresultStatus(res2) != PGRES_TUPLES_OK)
  				{
! 					slon_log(SLON_FATAL, "localListenThread: \"%s\" %s\n",
  							 dstring_data(&query2),
  							 PQresultErrorMessage(res2));
***************
*** 626,630 ****
  				 * Nothing to do locally
  				 */
! 				slon_log(SLON_DEBUG1, "localListenThread: ACCEPT_SET");
  				rtcfg_reloadListen(dbconn);
  			}
--- 626,630 ----
  				 * Nothing to do locally
  				 */
! 				slon_log(SLON_DEBUG1, "localListenThread: ACCEPT_SET\n");
  				rtcfg_reloadListen(dbconn);
  			}
***************
*** 650,654 ****
  			{
  				slon_log(SLON_FATAL,
! 						 "localListenThread: \"%s\" - %s",
  						 dstring_data(&query1), PQresultErrorMessage(res));
  				PQclear(res);
--- 650,654 ----
  			{
  				slon_log(SLON_FATAL,
! 						 "localListenThread: \"%s\" - %s\n",
  						 dstring_data(&query1), PQresultErrorMessage(res));
  				PQclear(res);
***************
*** 674,678 ****
  			{
  				slon_log(SLON_FATAL,
! 						 "localListenThread: \"rollback transaction;\" - %s",
  						 PQresultErrorMessage(res));
  				PQclear(res);
--- 674,678 ----
  			{
  				slon_log(SLON_FATAL,
! 						 "localListenThread: \"rollback transaction;\" - %s\n",
  						 PQresultErrorMessage(res));
  				PQclear(res);

From cbbrowne at lists.slony.info  Fri Oct 19 08:19:36 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Fri Oct 19 08:19:38 2007
Subject: [Slony1-commit] slony1-engine/tests/testinherit generate_dml.sh
Message-ID: <20071019151936.D518C290CFB@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/tests/testinherit
In directory main.slony.info:/tmp/cvs-serv6750

Modified Files:
	generate_dml.sh 
Log Message:
Inheritance test now does some subtransactions with rollback, with
some SLEEP statements to encourage potential for locking


Index: generate_dml.sh
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tests/testinherit/generate_dml.sh,v
retrieving revision 1.6
retrieving revision 1.7
diff -C2 -d -r1.6 -r1.7
*** generate_dml.sh	25 Sep 2007 21:36:29 -0000	1.6
--- generate_dml.sh	19 Oct 2007 15:19:34 -0000	1.7
***************
*** 65,102 ****
    status "done initial test"
  
!   SUBTRANSACTIONQUERY=<<EOF
    begin;
-   -- Get a random list of products/regions
    select product_id into temp table products_foo from products order by random() limit 10;
    select region_code into temp table regions_foo from regions order by random() limit 10;
    savepoint a;
-   -- Purchase some products...
    select purchase_product( region_code, product_id, (random()*5+random()*8+random()*7)::integer) from products_foo, regions_foo order by random() limit 10;
! \!sh -c 'sleep2'
    savepoint b;
-   -- Then purchase some more products
    select purchase_product( region_code, product_id, (random()*5+random()*8+random()*7)::integer) from products_foo, regions_foo order by random() limit 5;
-   -- but psyche!!!  rollback to the previous savepoint!
    rollback to savepoint b;
    savepoint c;
-   -- Get another random listing of products/regions
    select product_id into temp table products_bar from products order by random() limit 5;
    select region_code into temp table regions_bar from regions order by random() limit 5;
    savepoint d;
! \!sh -c 'sleep2'
!   -- Now, do a purchase
    select purchase_product( region_code, product_id, (random()*5+random()*8+random()*7)::integer) from products_bar, regions_bar order by random() limit 5;
-   -- psyche!!!
    rollback to savepoint d;
    savepoint e;
    select purchase_product( region_code, product_id, (random()*5+random()*8+random()*7)::integer) from products_bar, regions_bar order by random() limit 10;
! \!sh -c 'sleep2'
    commit;
! EOF
  
    status "run a series of transactions that use subtransactions"
    for i in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16; do
        status "subtransaction set ${i}"
!       (sleep 2; $pgbindir/psql -h $host -p $port -d $db -U $user -c "${QUERY}"; status "done subtransaction set ${i}") &
        sleep 1
    done
--- 65,97 ----
    status "done initial test"
  
!   SUBTRANSACTIONQUERY="
    begin;
    select product_id into temp table products_foo from products order by random() limit 10;
    select region_code into temp table regions_foo from regions order by random() limit 10;
    savepoint a;
    select purchase_product( region_code, product_id, (random()*5+random()*8+random()*7)::integer) from products_foo, regions_foo order by random() limit 10;
! \!sh -c 'sleep 2'
    savepoint b;
    select purchase_product( region_code, product_id, (random()*5+random()*8+random()*7)::integer) from products_foo, regions_foo order by random() limit 5;
    rollback to savepoint b;
    savepoint c;
    select product_id into temp table products_bar from products order by random() limit 5;
    select region_code into temp table regions_bar from regions order by random() limit 5;
    savepoint d;
! \!sh -c 'sleep 2'
    select purchase_product( region_code, product_id, (random()*5+random()*8+random()*7)::integer) from products_bar, regions_bar order by random() limit 5;
    rollback to savepoint d;
    savepoint e;
    select purchase_product( region_code, product_id, (random()*5+random()*8+random()*7)::integer) from products_bar, regions_bar order by random() limit 10;
! \!sh -c 'sleep 2'
    commit;
! "
! 
! echo $SUBTRANSACTIONQUERY
  
    status "run a series of transactions that use subtransactions"
    for i in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16; do
        status "subtransaction set ${i}"
!       (sleep 2; echo "${SUBTRANSACTIONQUERY}" | $pgbindir/psql -h $host -p $port -d $db -U $user; status "done subtransaction set ${i}") &
        sleep 1
    done

From cbbrowne at lists.slony.info  Fri Oct 19 08:20:07 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Fri Oct 19 08:20:09 2007
Subject: [Slony1-commit] slony1-engine/tests/testmultipaths README
Message-ID: <20071019152007.9DD3B290D4A@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/tests/testmultipaths
In directory main.slony.info:/tmp/cvs-serv6809

Modified Files:
	README 
Log Message:
Clean up formatting of README for test


Index: README
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tests/testmultipaths/README,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** README	24 Sep 2007 21:26:34 -0000	1.1
--- README	19 Oct 2007 15:20:05 -0000	1.2
***************
*** 21,23 ****
  
  See:
! <http://lists.slony.info/pipermail/slony1-general/2007-September/006642.html>
\ No newline at end of file
--- 21,24 ----
  
  See:
! <http://lists.slony.info/pipermail/slony1-general/2007-September/006642.html>
! 

From cbbrowne at lists.slony.info  Fri Oct 19 08:21:48 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Fri Oct 19 08:21:50 2007
Subject: [Slony1-commit] slony1-engine/tests run_test.sh
Message-ID: <20071019152148.A2416290D2B@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/tests
In directory main.slony.info:/tmp/cvs-serv6851

Modified Files:
	run_test.sh 
Log Message:
Changes to tests to support log shipping better


Index: run_test.sh
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tests/run_test.sh,v
retrieving revision 1.18
retrieving revision 1.19
diff -C2 -d -r1.18 -r1.19
*** run_test.sh	21 Sep 2007 21:53:40 -0000	1.18
--- run_test.sh	19 Oct 2007 15:21:46 -0000	1.19
***************
*** 183,195 ****
        eval user=\$USER${node}
        eval port=\$PORT${node}
-       eval logship=\$LOGSHIP${node}
  
        if [ -n "${db}" -a "${host}" -a "${user}" -a "${port}" ]; then
          if [ ${node} -ne ${originnode} ]; then
-           if [ "x${logship}" == "xtrue" ]; then    # Don't bother generating nodes used for log shipping
-             status "Node ${node} is a log shipping node - no need for STORE NODE"
-           else
              echo "STORE NODE (id=@node${node}, comment='node ${node}');" >> $mktmp/slonik.script
-          fi
          fi
          if [ ${node} -ge ${NUMNODES} ]; then
--- 183,190 ----
***************
*** 215,219 ****
      eval user=\$USER${i}
      eval port=\$PORT${i}
-     eval logship=\$LOGSHIP${i}
  
      if [ -n "${db}" -a "${host}" -a "${user}" -a "${port}" ]; then
--- 210,213 ----
***************
*** 225,236 ****
            eval buser=\$WEAKUSER${j}
            eval bport=\$PORT${j}
-           eval blogship=\$LOGSHIP${j}
            if [ -n "${bdb}" -a "${bhost}" -a "${buser}" -a "${bport}" ]; then
-              if [[ "x${logship}" == "xtrue" || "x${blogship}" == "xtrue" ]]; then
-                  # log shipping node - no paths need exist that involve this node
-                  status "log shipping between nodes(${i}/${j}) - ls(${logship}/${blogship}) - omit STORE PATH"
-              else
  	    echo "STORE PATH (SERVER=@node${i}, CLIENT=@node${j}, CONNINFO='dbname=${db} host=${host} user=${buser} port=${port}');" >> $mktmp/slonik.script
-              fi
            else
              err 3 "No conninfo"
--- 219,224 ----
***************
*** 498,523 ****
  }
  
- build_logshipconf ()
- {
-     destnode=$1
-     srcnode=$2
-     CONFFILE=${mktmp}/logship-${destnode}.conf
- 
-     eval ldb=\$DB${destnode}
-     eval lhost=\$HOST${destnode}
-     eval luser=\$USER${destnode}
-     eval lport=\$PORT${destnode}
- 
-     mkdir -p ${mktmp}/offline_logs
- 
-     echo "logfile='${mktmp}/offline_logs/logshipper.log';" > ${CONFFILE}
-     echo "cluster name = '${cluster}';" >> ${CONFFILE}
-     echo "destination database ='dbname=${ldb} port=${lport} user=${luser} host=${lhost}';" >> ${CONFFILE}
-     echo "archive dir = '${mktmp}/archive_logs_${srcnode}';" >> ${CONFFILE}
-     echo "### destination dir ='${mktmp}/offline_result';" >> ${CONFFILE}
-     echo "max archives = 3600;" >> ${CONFFILE}
- #    echo "post processing command = 'gzip -9 \$inarchive';" >> ${CONFFILE}
- }
- 
  build_slonconf()
  {
--- 486,489 ----
***************
*** 545,584 ****
      echo "lag_interval=\"0 minutes\"" >> ${CONFFILE}
      if [ "x${archive}" == "xtrue" ]; then
  	echo "archive_dir='${mktmp}/archive_logs_${node}'" >> ${CONFFILE}
  	eval pgbindir=\$PGBINDIR${node}
- 	echo "command_on_logarchive='${pgbindir}/slony_logshipper ${mktmp}/logship-${LOGSHIPNODE}.conf '" >> ${CONFFILE}
-     fi
- }
- 
- launch_logshipper()
- {
-   node=1
-   while : ; do
-     if [ ${node} -ne ${originnode} ]; then
- 
-       eval db=\$DB${node}
-       eval host=\$HOST${node}
-       eval user=\$USER${node}
-       eval pgbindir=\$PGBINDIR${node}
-       eval port=\$PORT${node}
-       eval cluster=\$CLUSTER1
-       eval archive=\$ARCHIVE${node}
-       eval logship=\$LOGSHIP${node}
-       eval slonconf=\$SLONCONF${node}
- 
-       if [ -n "${db}" -a "${host}" -a "${user}" -a "${port}" ]; then
-         if [ "x${logship}" == "xtrue" ]; then
-           status "launch logshipper for node ${node}"
- 	  build_logshipconf ${node} ${ARCHIVENODE}
- 	  $pgbindir/slony_logshipper ${mktmp}/logship-${node}.conf &
-         fi
-       fi
-     fi
-     if [ ${node} -ge ${NUMNODES} ]; then
-       break;
-     else
-       node=$((${node} + 1))
      fi
-   done
  }
  
--- 511,518 ----
      echo "lag_interval=\"0 minutes\"" >> ${CONFFILE}
      if [ "x${archive}" == "xtrue" ]; then
+ 	status "slonconf configures archive logging for node ${node}"
  	echo "archive_dir='${mktmp}/archive_logs_${node}'" >> ${CONFFILE}
  	eval pgbindir=\$PGBINDIR${node}
      fi
  }
  
***************
*** 620,631 ****
    node=1
    while : ; do
-       eval logship=\$LOGSHIP${node}
        eval archive=\$ARCHIVE${node}
        if [ "x${archive}" == "xtrue" ]; then
  	  ARCHIVENODE=${node}
        fi
-       if [ "x${logship}" == "xtrue" ]; then
- 	  LOGSHIPNODE=${node}
-       fi
        if [ ${node} -ge ${NUMNODES} ]; then
  	  break;
--- 554,561 ----
***************
*** 635,639 ****
    done
    status "Archive node: ${ARCHIVENODE}"
-   status "Log shipping node: ${LOGSHIPNODE}"
  
    node=1
--- 565,568 ----
***************
*** 648,652 ****
        eval cluster=\$CLUSTER1
        eval archive=\$ARCHIVE${node}
-       eval logship=\$LOGSHIP${node}
        eval slonconf=\$SLONCONF${node}
  
--- 577,580 ----
***************
*** 662,665 ****
--- 590,595 ----
            mkdir -p $mktmp/archive_logs_${node}
            archiveparm="-a ${mktmp}/archive_logs_${node}"
+ 	else
+ 	  archiveparm=""
          fi
          conninfo="dbname=${db} host=${host} user=${user} port=${port}"
***************
*** 667,692 ****
  	if [ "x${slonconf}" == "xtrue" ]; then
  	    build_slonconf ${node} "${conninfo}"
!         fi
!         if [ "x${logship}" == "xtrue" ]; then
!           status "logshipper node - no slon to launch"
!         else
! 	  if [ "x${slonconf}" == "xtrue" ]; then
! 	      status "launching: $pgbindir/slon -f ${CONFFILE}"
! 	      $pgbindir/slon -f ${CONFFILE} 1>> $mktmp/slon_log.${node} 2>&1 &
! 	  else
! 	      status "launching: $pgbindir/slon -s500 -g10 -d2 ${archiveparm} $cluster \"$conninfo\""
! 	      $pgbindir/slon -s500 -g10 -d2 ${archiveparm} $cluster "$conninfo" 1>> $mktmp/slon_log.${node} 2>&1 &
! 	  fi
!           tmppid=$!
!           tmpppid=$$
!           sleep 1
! 
!           foo=$(_check_pid slon ${tmppid} ${tmpppid})
! 
!           eval slon${node}_pid=${foo}
!           if [ -z "${foo}" -o "${tmppid}" != "${foo}" ]; then
              warn 3 "Failed to launch slon on node ${node} check $mktmp/slon_log.${node} for details"
!           fi
!         fi
        fi
      fi
--- 597,616 ----
  	if [ "x${slonconf}" == "xtrue" ]; then
  	    build_slonconf ${node} "${conninfo}"
! 	    status "launching: $pgbindir/slon -f ${CONFFILE}"
! 	    $pgbindir/slon -f ${CONFFILE} 1>> $mktmp/slon_log.${node} 2>&1 &
! 	else
! 	    status "launching: $pgbindir/slon -s500 -g10 -d2 ${archiveparm} $cluster \"$conninfo\""
! 	    $pgbindir/slon -s500 -g10 -d2 ${archiveparm} $cluster "$conninfo" 1>> $mktmp/slon_log.${node} 2>&1 &
! 	fi
! 	tmppid=$!
! 	tmpppid=$$
! 	sleep 1
! 	
! 	foo=$(_check_pid slon ${tmppid} ${tmpppid})
! 	
! 	eval slon${node}_pid=${foo}
! 	if [ -z "${foo}" -o "${tmppid}" != "${foo}" ]; then
              warn 3 "Failed to launch slon on node ${node} check $mktmp/slon_log.${node} for details"
! 	fi
        fi
      fi

From cbbrowne at lists.slony.info  Fri Oct 19 08:21:48 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Fri Oct 19 08:21:50 2007
Subject: [Slony1-commit] slony1-engine/tests/test1 init_subscribe_set.ik
Message-ID: <20071019152148.DD5F3290D5B@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/tests/test1
In directory main.slony.info:/tmp/cvs-serv6851/test1

Modified Files:
	init_subscribe_set.ik 
Log Message:
Changes to tests to support log shipping better


Index: init_subscribe_set.ik
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tests/test1/init_subscribe_set.ik,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** init_subscribe_set.ik	31 Oct 2006 22:09:40 -0000	1.4
--- init_subscribe_set.ik	19 Oct 2007 15:21:46 -0000	1.5
***************
*** 1,3 ****
! subscribe set (id = 1, provider = 1, receiver = 2, forward = no);
  echo 'sleep a couple of seconds...';
  sleep (seconds = 2);
--- 1,3 ----
! subscribe set (id = 1, provider = 1, receiver = 2, forward = yes);
  echo 'sleep a couple of seconds...';
  sleep (seconds = 2);

From cbbrowne at lists.slony.info  Fri Oct 19 08:22:37 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Fri Oct 19 08:22:39 2007
Subject: [Slony1-commit] slony1-engine/tests/testlogship README
	generate_dml.sh init_subscribe_set.ik moveset.sh settings.ik
Message-ID: <20071019152238.0308D290D2B@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/tests/testlogship
In directory main.slony.info:/tmp/cvs-serv6908

Modified Files:
	README generate_dml.sh init_subscribe_set.ik moveset.sh 
	settings.ik 
Log Message:
Lots of changes to log shipping test based on the changes introduced
in 1.2.12


Index: settings.ik
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tests/testlogship/settings.ik,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** settings.ik	27 Aug 2007 15:43:03 -0000	1.3
--- settings.ik	19 Oct 2007 15:22:35 -0000	1.4
***************
*** 1,6 ****
! NUMCLUSTERS=${NUMCLUSTERS:-"1"}
! NUMNODES=${NUMNODES:-"4"}
! ORIGINNODE=1
! WORKERS=${WORKERS:-"1"}
  ARCHIVE2=true   # Node #2 needs to run log archiving
! LOGSHIP3=true   # Node #3 receives data via log shipping
--- 1,8 ----
! NUMCLUSTERS=1
! NUMNODES=3    # These are the "regular" Slony-I nodes
!               # node #4 will also be populated as a log shipping node
! 
! ORIGINNODE=1  # at least initially - origin is later moved to node #3
! WORKERS=1
  ARCHIVE2=true   # Node #2 needs to run log archiving
! SLONCONF2=true

Index: init_subscribe_set.ik
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tests/testlogship/init_subscribe_set.ik,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** init_subscribe_set.ik	27 Aug 2007 15:43:03 -0000	1.3
--- init_subscribe_set.ik	19 Oct 2007 15:22:35 -0000	1.4
***************
*** 3,7 ****
  sleep (seconds = 2);
  echo 'done sleeping...';
! subscribe set (id = 1, provider = 1, receiver = 4, forward = yes);
  echo 'sleep a couple of seconds...';
  sleep (seconds = 2);
--- 3,7 ----
  sleep (seconds = 2);
  echo 'done sleeping...';
! subscribe set (id = 1, provider = 1, receiver = 3, forward = yes);
  echo 'sleep a couple of seconds...';
  sleep (seconds = 2);

Index: README
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tests/testlogship/README,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** README	20 Apr 2007 21:43:14 -0000	1.3
--- README	19 Oct 2007 15:22:35 -0000	1.4
***************
*** 28,30 ****
  table 4, adding two new columns, one to be populated via a default,
  for new tuples; the other has no default, but we assign the value 42
! to all tuples existing at the time that the DDL script runs.
\ No newline at end of file
--- 28,33 ----
  table 4, adding two new columns, one to be populated via a default,
  for new tuples; the other has no default, but we assign the value 42
! to all tuples existing at the time that the DDL script runs.
! 
! Note that node #2 (subscriber) has slon configuration managed via
! config file

Index: moveset.sh
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tests/testlogship/moveset.sh,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** moveset.sh	27 Aug 2007 15:43:03 -0000	1.2
--- moveset.sh	19 Oct 2007 15:22:35 -0000	1.3
***************
*** 2,5 ****
  echo "
    LOCK SET ( ID = 1, ORIGIN = 1 );
!   MOVE SET ( ID = 1, OLD ORIGIN = 1, NEW ORIGIN = 4 );
  "
--- 2,5 ----
  echo "
    LOCK SET ( ID = 1, ORIGIN = 1 );
!   MOVE SET ( ID = 1, OLD ORIGIN = 1, NEW ORIGIN = 3 );
  "

Index: generate_dml.sh
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tests/testlogship/generate_dml.sh,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** generate_dml.sh	27 Aug 2007 15:43:03 -0000	1.4
--- generate_dml.sh	19 Oct 2007 15:22:35 -0000	1.5
***************
*** 23,27 ****
  generate_initdata()
  {
!   numrows=$(random_number 50 1000)
    i=0;
    trippoint=`expr $numrows / 20`
--- 23,27 ----
  generate_initdata()
  {
!   numrows=$(random_number 125 150)
    i=0;
    trippoint=`expr $numrows / 20`
***************
*** 78,94 ****
    fi 
    status "data load complete - nodes are seeded reasonably"
- 
-   status "purge archive log files up to present in order to eliminate those that cannot be used"
-   for file in `/usr/bin/find ${mktmp}/archive_logs_2 -name "slony1_log_*.sql" -type f`; do
-     status "purge ${file}"
-     rm ${file}
-   done
-   sleep 5
    status "pull log shipping dump" 
    PGHOST=${HOST2} PGPORT=${PORT2} PGUSER=${USER2} ${SLTOOLDIR}/slony1_dump.sh ${DB2} ${CLUSTER1} > ${mktmp}/logship_dump.sql
-   status "load schema for replicated tables into node #3"
-   ${PGBINDIR3}/psql -h ${HOST3} -p ${PORT3} -U ${USER3} -d ${DB3} -f ${testname}/init_schema.sql
-   status "load log shipping dump into node #3"
-   ${PGBINDIR3}/psql -h ${HOST3} -p ${PORT3} -U ${USER3} -d ${DB3} -f ${mktmp}/logship_dump.sql
    
    status "generate more data to test log shipping"
--- 78,83 ----
***************
*** 116,120 ****
    wait_for_catchup
  
!   status "move set to node 4"
  
    init_preamble
--- 105,109 ----
    wait_for_catchup
  
!   status "move set to node 3"
  
    init_preamble
***************
*** 125,147 ****
  
    generate_initdata
!   eval db=\$DB4
!   status "loading extra data to node $db"
!   $pgbindir/psql -h $host -p $port -U $user -d $db < $mktmp/generate.data 1> ${mktmp}/even_more_data.log 2> ${mktmp}/even_more_data.log2
  
    wait_for_catchup
! 
  
    status "final data load complete - now load files into log shipped node"
!   firstseq=`(cd ${mktmp}/archive_logs_2; /usr/bin/find -name "*.sql") | cut -d "_" -f 4 | cut -d "." -f 1 | sort -n | head -1`
    lastseq=`(cd ${mktmp}/archive_logs_2; /usr/bin/find -name "*.sql") | cut -d "_" -f 4 | cut -d "." -f 1 | sort -n | tail -1`
    status "Logs numbered from ${firstseq} to ${lastseq}"
    currseq=${firstseq}
    while : ; do
- #      00000000000000000000
- #      12345678901234567890
      cs=`printf "%020d" ${currseq}`
      status "current sequence value: ${cs}"
      for logfile in `/usr/bin/find ${mktmp}/archive_logs_2 -name "slony1_log_*_${cs}.sql" -type f`; do
!       $pgbindir/psql -h ${HOST3} -p ${PORT3} -d ${DB3} -U ${USER3} -f ${logfile} >> $mktmp/logshipping_output.log 2>> $mktmp/logshipping_errors.log
        status "load file ${logfile} - ${?}"
      done
--- 114,145 ----
  
    generate_initdata
!   status "loading extra data to node 3"
!   $pgbindir/psql -h $HOST3 -p $PORT3 -U $USER3 -d $DB3 < $mktmp/generate.data 1> ${mktmp}/even_more_data.log 2> ${mktmp}/even_more_data.log2
  
    wait_for_catchup
!   status "done"
  
    status "final data load complete - now load files into log shipped node"
!   status "set up database for log shipped node"
!   ${PGBINDIR4}/createdb -p ${PORT4} -U ${USER4} ${DB4}
!   ${PGBINDIR4}/createlang plpgsql ${DB4}
! 
!   status "load schema for replicated tables into node #4"
!   ${PGBINDIR4}/psql -h ${HOST4} -p ${PORT4} -U ${USER4} -d ${DB4} -f ${testname}/init_schema.sql
!   status "load log shipping dump into node #4"
!   ${PGBINDIR4}/psql -h ${HOST4} -p ${PORT4} -U ${USER4} -d ${DB4} -f ${mktmp}/logship_dump.sql
!   
!   
!   firstseq=`psql -At -d ${DB4} -p ${PORT4} -c 'select at_counter from _slony_regress1.sl_archive_tracking ;'`
    lastseq=`(cd ${mktmp}/archive_logs_2; /usr/bin/find -name "*.sql") | cut -d "_" -f 4 | cut -d "." -f 1 | sort -n | tail -1`
    status "Logs numbered from ${firstseq} to ${lastseq}"
    currseq=${firstseq}
    while : ; do
      cs=`printf "%020d" ${currseq}`
      status "current sequence value: ${cs}"
+     firstseq=`psql -At -d ${DB4} -p ${PORT4} -c 'select at_counter from _slony_regress1.sl_archive_tracking ;'`
+     status "archive tracking ID: ${firstseq}"
      for logfile in `/usr/bin/find ${mktmp}/archive_logs_2 -name "slony1_log_*_${cs}.sql" -type f`; do
!       ${PGBINDIR4}/psql -h ${HOST4} -p ${PORT4} -d ${DB4} -U ${USER4} -f ${logfile} >> $mktmp/logshipping_output.log 2>> $mktmp/logshipping_errors.log
        status "load file ${logfile} - ${?}"
      done
***************
*** 152,155 ****
      fi
    done
!   status "done"
  }
--- 150,157 ----
      fi
    done
!   status "done loading data into log shipping node"
! 
!   NUMNODES=4
!   status "Changed number of nodes to 4 to reflect the log shipping node"
! 
  }

From wieck at lists.slony.info  Fri Oct 19 11:37:05 2007
From: wieck at lists.slony.info (Jan Wieck)
Date: Fri Oct 19 11:37:07 2007
Subject: [Slony1-commit] slony1-engine/src/slon remote_worker.c
Message-ID: <20071019183705.F33D2290D2B@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slon
In directory main.slony.info:/tmp/cvs-serv9021

Modified Files:
      Tag: REL_1_2_STABLE
	remote_worker.c 
Log Message:
Terminate the helper qualification in the log selection query if we
have multiple providers for one origin but one provider does at this
time have no sets needing syncing.

Jan


Index: remote_worker.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/remote_worker.c,v
retrieving revision 1.124.2.27
retrieving revision 1.124.2.28
diff -C2 -d -r1.124.2.27 -r1.124.2.28
*** remote_worker.c	28 Sep 2007 21:15:53 -0000	1.124.2.27
--- remote_worker.c	19 Oct 2007 18:37:03 -0000	1.124.2.28
***************
*** 4171,4174 ****
--- 4171,4175 ----
  		{
  			PQclear(res1);
+ 			slon_appendquery(provider_qual, " false ) ");
  			continue;
  		}

From wieck at lists.slony.info  Fri Oct 19 11:38:37 2007
From: wieck at lists.slony.info (Jan Wieck)
Date: Fri Oct 19 11:38:40 2007
Subject: [Slony1-commit] slony1-engine/src/slon cleanup_thread.c
	local_listen.c remote_listen.c remote_worker.c slon.h
Message-ID: <20071019183837.F1397290D93@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slon
In directory main.slony.info:/tmp/cvs-serv9076

Modified Files:
	cleanup_thread.c local_listen.c remote_listen.c 
	remote_worker.c slon.h 
Log Message:
Move slony to use the new txid contrib module instead of xxid.

Jan


Index: remote_worker.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/remote_worker.c,v
retrieving revision 1.156
retrieving revision 1.157
diff -C2 -d -r1.156 -r1.157
*** remote_worker.c	27 Sep 2007 14:22:59 -0000	1.156
--- remote_worker.c	19 Oct 2007 18:38:35 -0000	1.157
***************
*** 57,63 ****
  	int64		ev_seqno;
  	char	   *ev_timestamp_c;
! 	char	   *ev_minxid_c;
! 	char	   *ev_maxxid_c;
! 	char	   *ev_xip;
  	char	   *ev_type;
  	char	   *ev_data1;
--- 57,63 ----
  	int64		ev_seqno;
  	char	   *ev_timestamp_c;
! 	char	   *ev_snapshot_c;
! 	char	   *ev_mintxid_c;
! 	char	   *ev_maxtxid_c;
  	char	   *ev_type;
  	char	   *ev_data1;
***************
*** 1004,1010 ****
  								"    set ssy_origin = %d, "
  								"        ssy_seqno = '%s', "
! 								"        ssy_minxid = '%s', "
! 								"        ssy_maxxid = '%s', "
! 								"        ssy_xip = '%q', "
  								"        ssy_action_list = '' "
  								"    where ssy_setid = %d; ",
--- 1004,1008 ----
  								"    set ssy_origin = %d, "
  								"        ssy_seqno = '%s', "
! 								"        ssy_snapshot = '%s', "
  								"        ssy_action_list = '' "
  								"    where ssy_setid = %d; ",
***************
*** 1012,1018 ****
  								new_origin,
  								seqbuf,
! 								event->ev_minxid_c,
! 								event->ev_maxxid_c,
! 								event->ev_xip,
  								set_id);
  
--- 1010,1014 ----
  								new_origin,
  								seqbuf,
! 								event->ev_snapshot_c,
  								set_id);
  
***************
*** 1710,1714 ****
  				   int ev_origin, int64 ev_seqno,
  				   char *ev_timestamp,
! 				   char *ev_minxid, char *ev_maxxid, char *ev_xip,
  				   char *ev_type,
  				   char *ev_data1, char *ev_data2,
--- 1706,1710 ----
  				   int ev_origin, int64 ev_seqno,
  				   char *ev_timestamp,
! 				   char *ev_snapshot, char *ev_mintxid, char *ev_maxtxid,
  				   char *ev_type,
  				   char *ev_data1, char *ev_data2,
***************
*** 1722,1728 ****
  	char	   *cp;
  	int			len_timestamp;
! 	int			len_minxid;
! 	int			len_maxxid;
! 	int			len_xip;
  	int			len_type;
  	int			len_data1 = 0;
--- 1718,1724 ----
  	char	   *cp;
  	int			len_timestamp;
! 	int			len_snapshot;
! 	int			len_mintxid;
! 	int			len_maxtxid;
  	int			len_type;
  	int			len_data1 = 0;
***************
*** 1796,1802 ****
  	len = offsetof(SlonWorkMsg_event, raw_data)
  		+ (len_timestamp = strlen(ev_timestamp) + 1)
! 		+ (len_minxid = strlen(ev_minxid) + 1)
! 		+ (len_maxxid = strlen(ev_maxxid) + 1)
! 		+ (len_xip = strlen(ev_xip) + 1)
  		+ (len_type = strlen(ev_type) + 1)
  		+ ((ev_data1 == NULL) ? 0 : (len_data1 = strlen(ev_data1) + 1))
--- 1792,1798 ----
  	len = offsetof(SlonWorkMsg_event, raw_data)
  		+ (len_timestamp = strlen(ev_timestamp) + 1)
! 		+ (len_snapshot = strlen(ev_snapshot) + 1)
! 		+ (len_mintxid = strlen(ev_mintxid) + 1)
! 		+ (len_maxtxid = strlen(ev_maxtxid) + 1)
  		+ (len_type = strlen(ev_type) + 1)
  		+ ((ev_data1 == NULL) ? 0 : (len_data1 = strlen(ev_data1) + 1))
***************
*** 1827,1839 ****
  	strcpy(cp, ev_timestamp);
  	cp += len_timestamp;
! 	msg->ev_minxid_c = cp;
! 	strcpy(cp, ev_minxid);
! 	cp += len_minxid;
! 	msg->ev_maxxid_c = cp;
! 	strcpy(cp, ev_maxxid);
! 	cp += len_maxxid;
! 	msg->ev_xip = cp;
! 	strcpy(cp, ev_xip);
! 	cp += len_xip;
  	msg->ev_type = cp;
  	strcpy(cp, ev_type);
--- 1823,1835 ----
  	strcpy(cp, ev_timestamp);
  	cp += len_timestamp;
! 	msg->ev_snapshot_c = cp;
! 	strcpy(cp, ev_snapshot);
! 	cp += len_snapshot;
! 	msg->ev_mintxid_c = cp;
! 	strcpy(cp, ev_mintxid);
! 	cp += len_mintxid;
! 	msg->ev_maxtxid_c = cp;
! 	strcpy(cp, ev_maxtxid);
! 	cp += len_maxtxid;
  	msg->ev_type = cp;
  	strcpy(cp, ev_type);
***************
*** 2101,2105 ****
  					 "insert into %s.sl_event "
  					 "    (ev_origin, ev_seqno, ev_timestamp, "
! 					 "     ev_minxid, ev_maxxid, ev_xip, ev_type ",
  					 rtcfg_cluster_name, rtcfg_cluster_name,
  					 rtcfg_namespace);
--- 2097,2101 ----
  					 "insert into %s.sl_event "
  					 "    (ev_origin, ev_seqno, ev_timestamp, "
! 					 "     ev_snapshot, ev_type ",
  					 rtcfg_cluster_name, rtcfg_cluster_name,
  					 rtcfg_namespace);
***************
*** 2121,2127 ****
  		dstring_append(dsp, ", ev_data8");
  	slon_appendquery(dsp,
! 					 "    ) values ('%d', '%s', '%s', '%s', '%s', '%q', '%s'",
  					 event->ev_origin, seqbuf, event->ev_timestamp_c,
! 					 event->ev_minxid_c, event->ev_maxxid_c, event->ev_xip,
  					 event->ev_type);
  	if (event->ev_data1 != NULL)
--- 2117,2123 ----
  		dstring_append(dsp, ", ev_data8");
  	slon_appendquery(dsp,
! 					 "    ) values ('%d', '%s', '%s', '%s', '%s'",
  					 event->ev_origin, seqbuf, event->ev_timestamp_c,
! 					 event->ev_snapshot_c, 
  					 event->ev_type);
  	if (event->ev_data1 != NULL)
***************
*** 2310,2316 ****
  	int			sub_provider = 0;
  	char	   *ssy_seqno = NULL;
! 	char	   *ssy_minxid = NULL;
! 	char	   *ssy_maxxid = NULL;
! 	char	   *ssy_xip = NULL;
  	SlonDString ssy_action_list;
  	char		seqbuf[64];
--- 2306,2310 ----
  	int			sub_provider = 0;
  	char	   *ssy_seqno = NULL;
! 	char	   *ssy_snapshot = NULL;
  	SlonDString ssy_action_list;
  	char		seqbuf[64];
***************
*** 2423,2428 ****
  					 "start transaction; "
  					 "set transaction isolation level serializable; "
! 					 "select %s.getMinXid() <= '%s'::%s.xxid; ",
! 					 rtcfg_namespace, event->ev_maxxid_c, rtcfg_namespace);
  		res1 = PQexec(pro_dbconn, dstring_data(&query1));
  		if (PQresultStatus(res1) != PGRES_TUPLES_OK)
--- 2417,2422 ----
  					 "start transaction; "
  					 "set transaction isolation level serializable; "
! 					 "select \"public\".txid_snapshot_xmin(\"public\".txid_current_snapshot()) <= '%s'; ",
! 					 event->ev_maxtxid_c);
  		res1 = PQexec(pro_dbconn, dstring_data(&query1));
  		if (PQresultStatus(res1) != PGRES_TUPLES_OK)
***************
*** 2445,2449 ****
  			slon_log(SLON_WARN, "remoteWorkerThread_%d: "
  				  "transactions earlier than XID %s are still in progress\n",
! 					 node->no_id, event->ev_maxxid_c);
  			PQclear(res1);
  			slon_disconnectdb(pro_conn);
--- 2439,2443 ----
  			slon_log(SLON_WARN, "remoteWorkerThread_%d: "
  				  "transactions earlier than XID %s are still in progress\n",
! 					 node->no_id, event->ev_maxtxid_c);
  			PQclear(res1);
  			slon_disconnectdb(pro_conn);
***************
*** 3180,3186 ****
  			 */
  			ssy_seqno = seqbuf;
! 			ssy_minxid = event->ev_minxid_c;
! 			ssy_maxxid = event->ev_maxxid_c;
! 			ssy_xip = event->ev_xip;
  
  			slon_log(SLON_INFO, "remoteWorkerThread_%d: "
--- 3174,3178 ----
  			 */
  			ssy_seqno = seqbuf;
! 			ssy_snapshot = event->ev_snapshot_c;
  
  			slon_log(SLON_INFO, "remoteWorkerThread_%d: "
***************
*** 3203,3207 ****
  			 */
  			(void) slon_mkquery(&query1,
! 						 "select ev_seqno, ev_minxid, ev_maxxid, ev_xip "
  						 "from %s.sl_event "
  						 "where ev_origin = %d and ev_seqno = '%s'; ",
--- 3195,3199 ----
  			 */
  			(void) slon_mkquery(&query1,
! 						 "select ev_seqno, ev_snapshot "
  						 "from %s.sl_event "
  						 "where ev_origin = %d and ev_seqno = '%s'; ",
***************
*** 3240,3254 ****
  			}
  			ssy_seqno = PQgetvalue(res1, 0, 0);
! 			ssy_minxid = PQgetvalue(res1, 0, 1);
! 			ssy_maxxid = PQgetvalue(res1, 0, 2);
! 			ssy_xip = PQgetvalue(res1, 0, 3);
  
  			(void) slon_mkquery(&query2,
! 						 "log_xid >= '%s' or (log_xid >= '%s'",
! 						 ssy_maxxid, ssy_minxid);
! 			if (strlen(ssy_xip) != 0)
! 				slon_appendquery(&query2, " and log_xid in (%s))", ssy_xip);
! 			else
! 				slon_appendquery(&query2, ")");
  
  			slon_log(SLON_INFO, "remoteWorkerThread_%d: "
--- 3232,3242 ----
  			}
  			ssy_seqno = PQgetvalue(res1, 0, 0);
! 			ssy_snapshot = PQgetvalue(res1, 0, 1);
  
  			(void) slon_mkquery(&query2,
! 						 "log_txid >= \"public\".txid_snapshot_xmax('%s') "
! 						 "or (log_txid >= \"public\".txid_snapshot_xmin('%s')",
! 						 ssy_snapshot, ssy_snapshot);
! 			slon_appendquery(&query2, " and log_txid in (select * from \"public\".txid_snapshot_xip('%s')))", ssy_snapshot);
  
  			slon_log(SLON_INFO, "remoteWorkerThread_%d: "
***************
*** 3311,3316 ****
  		 */
  		(void) slon_mkquery(&query1,
! 					 "select ssy_seqno, ssy_minxid, ssy_maxxid, "
! 					 "    ssy_xip, ssy_action_list "
  					 "from %s.sl_setsync where ssy_setid = %d; ",
  					 rtcfg_namespace, set_id);
--- 3299,3304 ----
  		 */
  		(void) slon_mkquery(&query1,
! 					 "select ssy_seqno, ssy_snapshot, "
! 					 "    ssy_action_list "
  					 "from %s.sl_setsync where ssy_setid = %d; ",
  					 rtcfg_namespace, set_id);
***************
*** 3348,3354 ****
  		dstring_init(&ssy_action_list);
  		ssy_seqno = PQgetvalue(res1, 0, 0);
! 		ssy_minxid = PQgetvalue(res1, 0, 1);
! 		ssy_maxxid = PQgetvalue(res1, 0, 2);
! 		ssy_xip = PQgetvalue(res1, 0, 3);
  		dstring_append(&ssy_action_list, PQgetvalue(res1, 0, 4));
  		dstring_terminate(&ssy_action_list);
--- 3336,3340 ----
  		dstring_init(&ssy_action_list);
  		ssy_seqno = PQgetvalue(res1, 0, 0);
! 		ssy_snapshot = PQgetvalue(res1, 0, 1);
  		dstring_append(&ssy_action_list, PQgetvalue(res1, 0, 4));
  		dstring_terminate(&ssy_action_list);
***************
*** 3362,3370 ****
  		     "insert into %s.sl_setsync "
  		     "    (ssy_setid, ssy_origin, ssy_seqno, "
! 		     "     ssy_minxid, ssy_maxxid, ssy_xip, ssy_action_list) "
! 		     "    values ('%d', '%d', '%s', '%s', '%s', '%q', '%q'); ",
  		     rtcfg_namespace, set_id,
  		     rtcfg_namespace,
! 		     set_id, node->no_id, ssy_seqno, ssy_minxid, ssy_maxxid, ssy_xip,
  		     dstring_data(&ssy_action_list));
  	dstring_free(&ssy_action_list);
--- 3348,3356 ----
  		     "insert into %s.sl_setsync "
  		     "    (ssy_setid, ssy_origin, ssy_seqno, "
! 		     "     ssy_snapshot, ssy_action_list) "
! 		     "    values ('%d', '%d', '%s', '%q', '%q'); ",
  		     rtcfg_namespace, set_id,
  		     rtcfg_namespace,
! 		     set_id, node->no_id, ssy_seqno, ssy_snapshot,
  		     dstring_data(&ssy_action_list));
  	dstring_free(&ssy_action_list);
***************
*** 3596,3610 ****
  	dstring_init(&new_qual);
  
! 	if (strlen(event->ev_xip) != 0)
! 		(void) slon_mkquery(&new_qual,
! 					 "(log_xid < '%s' and "
! 					 "%s.xxid_lt_snapshot(log_xid, '%s:%s:%q'))",
! 					 event->ev_maxxid_c,
! 					 rtcfg_namespace,
! 					 event->ev_minxid_c, event->ev_maxxid_c, event->ev_xip);
! 	else
! 		(void) slon_mkquery(&new_qual,
! 					 "(log_xid < '%s')",
! 					 event->ev_maxxid_c);
  
  	min_ssy_seqno = -1;
--- 3582,3589 ----
  	dstring_init(&new_qual);
  
! 	(void) slon_mkquery(&new_qual,
! 				 "(log_txid < '%s' and "
! 				 "\"public\".txid_visible_in_snapshot(log_txid, '%s'))",
! 				 event->ev_maxtxid_c, event->ev_snapshot_c);
  
  	min_ssy_seqno = -1;
***************
*** 3631,3635 ****
  		(void) slon_mkquery(&query,
  					 "select SSY.ssy_setid, SSY.ssy_seqno, "
! 					 "    SSY.ssy_minxid, SSY.ssy_maxxid, SSY.ssy_xip, "
  					 "    SSY.ssy_action_list "
  					 "from %s.sl_setsync SSY "
--- 3610,3615 ----
  		(void) slon_mkquery(&query,
  					 "select SSY.ssy_setid, SSY.ssy_seqno, "
! 					 "    \"public\".txid_snapshot_xmax(SSY.ssy_snapshot), "
! 					 "    SSY.ssy_snapshot, "
  					 "    SSY.ssy_action_list "
  					 "from %s.sl_setsync SSY "
***************
*** 3664,3667 ****
--- 3644,3648 ----
  		{
  			PQclear(res1);
+ 			slon_appendquery(provider_qual, " false ) ");
  			continue;
  		}
***************
*** 3671,3677 ****
  		{
  			int			sub_set = strtol(PQgetvalue(res1, tupno1, 0), NULL, 10);
! 			char	   *ssy_maxxid = PQgetvalue(res1, tupno1, 3);
! 			char	   *ssy_xip = PQgetvalue(res1, tupno1, 4);
! 			char	   *ssy_action_list = PQgetvalue(res1, tupno1, 5);
  			int64		ssy_seqno;
  
--- 3652,3658 ----
  		{
  			int			sub_set = strtol(PQgetvalue(res1, tupno1, 0), NULL, 10);
! 			char	   *ssy_maxxid = PQgetvalue(res1, tupno1, 2);
! 			char	   *ssy_snapshot = PQgetvalue(res1, tupno1, 3);
! 			char	   *ssy_action_list = PQgetvalue(res1, tupno1, 4);
  			int64		ssy_seqno;
  
***************
*** 3801,3813 ****
  
  			/* add the <snapshot_qual_of_setsync> */
! 			if (strlen(ssy_xip) != 0)
! 				slon_appendquery(provider_qual,
! 								 "(log_xid >= '%s' or "
! 								 "log_xid IN (%s))",
! 								 ssy_maxxid, ssy_xip);
! 			else
! 				slon_appendquery(provider_qual,
! 								 "(log_xid >= '%s')",
! 								 ssy_maxxid);
  			actionlist_len = strlen(ssy_action_list);
  			slon_log(SLON_DEBUG4, " ssy_action_list value: %s\n",
--- 3782,3789 ----
  
  			/* add the <snapshot_qual_of_setsync> */
! 			slon_appendquery(provider_qual,
! 							 "(log_txid >= '%s' or "
! 							 "log_txid IN (select * from \"public\".txid_snapshot_xip('%s')))",
! 							 ssy_maxxid, ssy_snapshot);
  			actionlist_len = strlen(ssy_action_list);
  			slon_log(SLON_DEBUG4, " ssy_action_list value: %s\n",
***************
*** 4213,4222 ****
  	(void) slon_mkquery(&query,
  				 "update %s.sl_setsync set "
! 			   "    ssy_seqno = '%s', ssy_minxid = '%s', ssy_maxxid = '%s', "
! 				 "    ssy_xip = '%q', ssy_action_list = '' "
  				 "where ssy_setid in (",
  				 rtcfg_namespace,
! 				 seqbuf, event->ev_minxid_c, event->ev_maxxid_c,
! 				 event->ev_xip);
  	i = 0;
  	for (provider = wd->provider_head; provider; provider = provider->next)
--- 4189,4197 ----
  	(void) slon_mkquery(&query,
  				 "update %s.sl_setsync set "
! 			   "    ssy_seqno = '%s', ssy_snapshot = '%s', "
! 				 "    ssy_action_list = '' "
  				 "where ssy_setid in (",
  				 rtcfg_namespace,
! 				 seqbuf, event->ev_snapshot_c);
  	i = 0;
  	for (provider = wd->provider_head; provider; provider = provider->next)
***************
*** 4417,4421 ****
  					(void) slon_mkquery(&query,
  						 "declare LOG cursor for select "
! 						 "    log_origin, log_xid, log_tableid, "
  						 "    log_actionseq, log_cmdtype, "
  						 "    octet_length(log_cmddata), "
--- 4392,4396 ----
  					(void) slon_mkquery(&query,
  						 "declare LOG cursor for select "
! 						 "    log_origin, log_txid, log_tableid, "
  						 "    log_actionseq, log_cmdtype, "
  						 "    octet_length(log_cmddata), "
***************
*** 4432,4436 ****
  					(void) slon_mkquery(&query,
  						 "declare LOG cursor for select "
! 						 "    log_origin, log_xid, log_tableid, "
  						 "    log_actionseq, log_cmdtype, "
  						 "    octet_length(log_cmddata), "
--- 4407,4411 ----
  					(void) slon_mkquery(&query,
  						 "declare LOG cursor for select "
! 						 "    log_origin, log_txid, log_tableid, "
  						 "    log_actionseq, log_cmdtype, "
  						 "    octet_length(log_cmddata), "
***************
*** 4448,4452 ****
  					(void) slon_mkquery(&query,
  						 "declare LOG cursor for select * from ("
! 						 "  select log_origin, log_xid, log_tableid, "
  						 "    log_actionseq, log_cmdtype, "
  						 "    octet_length(log_cmddata), "
--- 4423,4427 ----
  					(void) slon_mkquery(&query,
  						 "declare LOG cursor for select * from ("
! 						 "  select log_origin, log_txid, log_tableid, "
  						 "    log_actionseq, log_cmdtype, "
  						 "    octet_length(log_cmddata), "
***************
*** 4456,4460 ****
  						 "  from %s.sl_log_1 %s "
  						 "  union all "
! 						 "  select log_origin, log_xid, log_tableid, "
  						 "    log_actionseq, log_cmdtype, "
  						 "    octet_length(log_cmddata), "
--- 4431,4435 ----
  						 "  from %s.sl_log_1 %s "
  						 "  union all "
! 						 "  select log_origin, log_txid, log_tableid, "
  						 "    log_actionseq, log_cmdtype, "
  						 "    octet_length(log_cmddata), "
***************
*** 4675,4679 ****
  				{
  					char	   *log_origin = PQgetvalue(res, tupno, 0);
! 					char	   *log_xid = PQgetvalue(res, tupno, 1);
  					int			log_tableid = strtol(PQgetvalue(res, tupno, 2),
  													 NULL, 10);
--- 4650,4654 ----
  				{
  					char	   *log_origin = PQgetvalue(res, tupno, 0);
! 					char	   *log_txid = PQgetvalue(res, tupno, 1);
  					int			log_tableid = strtol(PQgetvalue(res, tupno, 2),
  													 NULL, 10);
***************
*** 4693,4697 ****
  							     "from %s.sl_log_1 "
  							     "where log_origin = '%s' "
! 							     "  and log_xid = '%s' "
  							     "  and log_actionseq = '%s' "
  							     "UNION ALL "
--- 4668,4672 ----
  							     "from %s.sl_log_1 "
  							     "where log_origin = '%s' "
! 							     "  and log_txid = '%s' "
  							     "  and log_actionseq = '%s' "
  							     "UNION ALL "
***************
*** 4699,4708 ****
  							     "from %s.sl_log_2 "
  							     "where log_origin = '%s' "
! 							     "  and log_xid = '%s' "
  							     "  and log_actionseq = '%s'",
  							     rtcfg_namespace,
! 							     log_origin, log_xid, log_actionseq,
  							     rtcfg_namespace,
! 							     log_origin, log_xid, log_actionseq);
  						res2 = PQexec(dbconn, dstring_data(&query2));
  						if (PQresultStatus(res2) != PGRES_TUPLES_OK)
--- 4674,4683 ----
  							     "from %s.sl_log_2 "
  							     "where log_origin = '%s' "
! 							     "  and log_txid = '%s' "
  							     "  and log_actionseq = '%s'",
  							     rtcfg_namespace,
! 							     log_origin, log_txid, log_actionseq,
  							     rtcfg_namespace,
! 							     log_origin, log_txid, log_actionseq);
  						res2 = PQexec(dbconn, dstring_data(&query2));
  						if (PQresultStatus(res2) != PGRES_TUPLES_OK)
***************
*** 4748,4757 ****
  						slon_appendquery(&(line->log),
  									"insert into %s.sl_log_%d "
! 									"    (log_origin, log_xid, log_tableid, "
  									"     log_actionseq, log_cmdtype, "
  									"     log_cmddata) values "
  									"    ('%s', '%s', '%d', '%s', '%q', '%q');\n",
  									rtcfg_namespace, wd->active_log_table,
! 									log_origin, log_xid, log_tableid,
  									log_actionseq, log_cmdtype, log_cmddata);
  						largemem *= 2;
--- 4723,4732 ----
  						slon_appendquery(&(line->log),
  									"insert into %s.sl_log_%d "
! 									"    (log_origin, log_txid, log_tableid, "
  									"     log_actionseq, log_cmdtype, "
  									"     log_cmddata) values "
  									"    ('%s', '%s', '%d', '%s', '%q', '%q');\n",
  									rtcfg_namespace, wd->active_log_table,
! 									log_origin, log_txid, log_tableid,
  									log_actionseq, log_cmdtype, log_cmddata);
  						largemem *= 2;

Index: slon.h
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/slon.h,v
retrieving revision 1.64
retrieving revision 1.65
diff -C2 -d -r1.64 -r1.65
*** slon.h	23 Aug 2007 18:12:59 -0000	1.64
--- slon.h	19 Oct 2007 18:38:35 -0000	1.65
***************
*** 532,536 ****
  				   int ev_origin, int64 ev_seqno,
  				   char *ev_timestamp,
! 				   char *ev_minxid, char *ev_maxxid, char *ev_xip,
  				   char *ev_type,
  				   char *ev_data1, char *ev_data2,
--- 532,536 ----
  				   int ev_origin, int64 ev_seqno,
  				   char *ev_timestamp,
! 				   char *ev_snapshot, char *ev_mintxid, char *ev_maxtxid,
  				   char *ev_type,
  				   char *ev_data1, char *ev_data2,

Index: cleanup_thread.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/cleanup_thread.c,v
retrieving revision 1.39
retrieving revision 1.40
diff -C2 -d -r1.39 -r1.40
*** cleanup_thread.c	5 Jul 2007 18:19:04 -0000	1.39
--- cleanup_thread.c	19 Oct 2007 18:38:35 -0000	1.40
***************
*** 131,135 ****
  		gettimeofday(&tv_start, NULL);
  		slon_mkquery(&query2,
! 					 "select ev_origin, ev_seqno, ev_minxid "
  					 "from %s.sl_event "
  					 "where (ev_origin, ev_seqno) in "
--- 131,136 ----
  		gettimeofday(&tv_start, NULL);
  		slon_mkquery(&query2,
! 					 "select ev_origin, ev_seqno, "
! 					 "  \"public\".txid_snapshot_xmin(ev_snapshot) "
  					 "from %s.sl_event "
  					 "where (ev_origin, ev_seqno) in "
***************
*** 155,162 ****
  						 "delete from %s.sl_log_1 "
  						 "where log_origin = '%s' "
! 						 "and log_xid < '%s'; "
  						 "delete from %s.sl_log_2 "
  						 "where log_origin = '%s' "
! 						 "and log_xid < '%s'; "
  						 "delete from %s.sl_seqlog "
  						 "where seql_origin = '%s' "
--- 156,163 ----
  						 "delete from %s.sl_log_1 "
  						 "where log_origin = '%s' "
! 						 "and log_txid < '%s'; "
  						 "delete from %s.sl_log_2 "
  						 "where log_origin = '%s' "
! 						 "and log_txid < '%s'; "
  						 "delete from %s.sl_seqlog "
  						 "where seql_origin = '%s' "

Index: remote_listen.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/remote_listen.c,v
retrieving revision 1.36
retrieving revision 1.37
diff -C2 -d -r1.36 -r1.37
*** remote_listen.c	27 Jun 2007 16:20:24 -0000	1.36
--- remote_listen.c	19 Oct 2007 18:38:35 -0000	1.37
***************
*** 677,681 ****
  	(void) slon_mkquery(&query,
  				 "select ev_origin, ev_seqno, ev_timestamp, "
! 				 "       ev_minxid, ev_maxxid, ev_xip, "
  				 "       ev_type, "
  				 "       ev_data1, ev_data2, "
--- 677,683 ----
  	(void) slon_mkquery(&query,
  				 "select ev_origin, ev_seqno, ev_timestamp, "
! 				 "       ev_snapshot, "
! 				 "       \"public\".txid_snapshot_xmin(ev_snapshot), "
! 				 "       \"public\".txid_snapshot_xmax(ev_snapshot), "
  				 "       ev_type, "
  				 "       ev_data1, ev_data2, "
***************
*** 791,797 ****
  						   ev_origin, ev_seqno,
  						   PQgetvalue(res, tupno, 2),	/* ev_timestamp */
! 						   PQgetvalue(res, tupno, 3),	/* ev_minxid */
! 						   PQgetvalue(res, tupno, 4),	/* ev_maxxid */
! 						   PQgetvalue(res, tupno, 5),	/* ev_xip */
  						   PQgetvalue(res, tupno, 6),	/* ev_type */
  			 (PQgetisnull(res, tupno, 7)) ? NULL : PQgetvalue(res, tupno, 7),
--- 793,799 ----
  						   ev_origin, ev_seqno,
  						   PQgetvalue(res, tupno, 2),	/* ev_timestamp */
! 						   PQgetvalue(res, tupno, 3),	/* ev_snapshot */
! 						   PQgetvalue(res, tupno, 4),	/* mintxid */
! 						   PQgetvalue(res, tupno, 5),	/* maxtxid */
  						   PQgetvalue(res, tupno, 6),	/* ev_type */
  			 (PQgetisnull(res, tupno, 7)) ? NULL : PQgetvalue(res, tupno, 7),

Index: local_listen.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/local_listen.c,v
retrieving revision 1.43
retrieving revision 1.44
diff -C2 -d -r1.43 -r1.44
*** local_listen.c	4 Oct 2007 15:33:45 -0000	1.43
--- local_listen.c	19 Oct 2007 18:38:35 -0000	1.44
***************
*** 174,178 ****
  		(void) slon_mkquery(&query1,
  					 "select ev_seqno, ev_timestamp, "
! 					 "       ev_minxid, ev_maxxid, ev_xip, "
  					 "       ev_type, "
  					 "       ev_data1, ev_data2, ev_data3, ev_data4, "
--- 174,178 ----
  		(void) slon_mkquery(&query1,
  					 "select ev_seqno, ev_timestamp, "
! 					 "       'dummy', 'dummy', 'dummy', "
  					 "       ev_type, "
  					 "       ev_data1, ev_data2, ev_data3, ev_data4, "

From cbbrowne at lists.slony.info  Fri Oct 19 14:31:37 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Fri Oct 19 14:31:39 2007
Subject: [Slony1-commit] slony1-engine/tests/testmultipaths
	init_subscribe_set.ik
Message-ID: <20071019213137.71F9B290D9A@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/tests/testmultipaths
In directory main.slony.info:/tmp/cvs-serv11327

Modified Files:
	init_subscribe_set.ik 
Log Message:
Fix up subscription WAIT FOR EVENT requests so that they use SYNCs in
between and _properly_ wait for subscriptions to complete.


Index: init_subscribe_set.ik
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tests/testmultipaths/init_subscribe_set.ik,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** init_subscribe_set.ik	24 Sep 2007 21:26:34 -0000	1.1
--- init_subscribe_set.ik	19 Oct 2007 21:31:35 -0000	1.2
***************
*** 1,10 ****
  subscribe set (id = 1, provider = 1, receiver = 2, forward = yes);
  WAIT FOR EVENT (ORIGIN = ALL, CONFIRMED = ALL, WAIT ON = 2);
  subscribe set (id = 1, provider = 1, receiver = 3, forward = yes);
  WAIT FOR EVENT (ORIGIN = ALL, CONFIRMED = ALL, WAIT ON = 3);
! 
  subscribe set (id = 2, provider = 1, receiver = 2, forward = yes);
  WAIT FOR EVENT (ORIGIN = ALL, CONFIRMED = ALL, WAIT ON = 2);
  subscribe set (id = 2, provider = 2, receiver = 3, forward = yes);
  WAIT FOR EVENT (ORIGIN = ALL, CONFIRMED = ALL, WAIT ON = 3);
!     
\ No newline at end of file
--- 1,17 ----
  subscribe set (id = 1, provider = 1, receiver = 2, forward = yes);
  WAIT FOR EVENT (ORIGIN = ALL, CONFIRMED = ALL, WAIT ON = 2);
+ sync (id=1);
+ WAIT FOR EVENT (ORIGIN = ALL, CONFIRMED = 2, WAIT ON = 2);
  subscribe set (id = 1, provider = 1, receiver = 3, forward = yes);
  WAIT FOR EVENT (ORIGIN = ALL, CONFIRMED = ALL, WAIT ON = 3);
! sync (id=1);
! WAIT FOR EVENT (ORIGIN = ALL, CONFIRMED = 3, WAIT ON = 3);
  subscribe set (id = 2, provider = 1, receiver = 2, forward = yes);
  WAIT FOR EVENT (ORIGIN = ALL, CONFIRMED = ALL, WAIT ON = 2);
+ sync (id=1);
+ WAIT FOR EVENT (ORIGIN = ALL, CONFIRMED = 2, WAIT ON = 2);
  subscribe set (id = 2, provider = 2, receiver = 3, forward = yes);
  WAIT FOR EVENT (ORIGIN = ALL, CONFIRMED = ALL, WAIT ON = 3);
! sync (id=1);
! WAIT FOR EVENT (ORIGIN = ALL, CONFIRMED = 3, WAIT ON = 3);
!     

From cbbrowne at lists.slony.info  Mon Oct 22 08:19:52 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Mon Oct 22 08:19:54 2007
Subject: [Slony1-commit] slony1-engine/src/backend slony1_funcs.sql
Message-ID: <20071022151952.89F00290C1B@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/backend
In directory main.slony.info:/tmp/cvs-serv15358

Modified Files:
      Tag: REL_1_2_STABLE
	slony1_funcs.sql 
Log Message:
Take out "continue" statements from back-ported listen generation code
as "continue" is not supported by v7.4


Index: slony1_funcs.sql
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/backend/slony1_funcs.sql,v
retrieving revision 1.98.2.24
retrieving revision 1.98.2.25
diff -C2 -d -r1.98.2.24 -r1.98.2.25
*** slony1_funcs.sql	25 Sep 2007 18:33:38 -0000	1.98.2.24
--- slony1_funcs.sql	22 Oct 2007 15:19:50 -0000	1.98.2.25
***************
*** 5139,5142 ****
--- 5139,5143 ----
  declare
  	v_row	record;
+ 	skip    boolean;
  begin
  	-- First remove the entire configuration
***************
*** 5173,5176 ****
--- 5174,5178 ----
  			where N1.no_id <> N2.no_id
  	loop
+ 		skip := ''f'';
  		-- 1st choice:
  		-- If we use the event origin as a data provider for any
***************
*** 5189,5195 ****
  			insert into @NAMESPACE@.sl_listen (li_origin, li_provider, li_receiver)
  				values (v_row.origin, v_row.origin, v_row.receiver);
! 			continue;
  		end if;
  
  		-- 2nd choice:
  		-- If we are subscribed to any set originating on this
--- 5191,5200 ----
  			insert into @NAMESPACE@.sl_listen (li_origin, li_provider, li_receiver)
  				values (v_row.origin, v_row.origin, v_row.receiver);
! 			skip := ''t'';
  		end if;
  
+ 		if skip then
+ 			skip := ''f'';
+ 		else
  		-- 2nd choice:
  		-- If we are subscribed to any set originating on this
***************
*** 5197,5210 ****
  		-- we use for this origin. We are a cascaded subscriber
  		-- for sets from this node.
! 		if exists (select true from @NAMESPACE@.sl_set, @NAMESPACE@.sl_subscribe
  						where set_origin = v_row.origin
  						  and sub_set = set_id
  						  and sub_receiver = v_row.receiver
  						  and sub_active)
! 		then
! 			delete from @NAMESPACE@.sl_listen
  					where li_origin = v_row.origin
  					  and li_receiver = v_row.receiver;
! 			insert into @NAMESPACE@.sl_listen (li_origin, li_provider, li_receiver)
  					select distinct set_origin, sub_provider, v_row.receiver
  						from @NAMESPACE@.sl_set, @NAMESPACE@.sl_subscribe
--- 5202,5215 ----
  		-- we use for this origin. We are a cascaded subscriber
  		-- for sets from this node.
! 			if exists (select true from @NAMESPACE@.sl_set, @NAMESPACE@.sl_subscribe
  						where set_origin = v_row.origin
  						  and sub_set = set_id
  						  and sub_receiver = v_row.receiver
  						  and sub_active)
! 			then
! 				delete from @NAMESPACE@.sl_listen
  					where li_origin = v_row.origin
  					  and li_receiver = v_row.receiver;
! 				insert into @NAMESPACE@.sl_listen (li_origin, li_provider, li_receiver)
  					select distinct set_origin, sub_provider, v_row.receiver
  						from @NAMESPACE@.sl_set, @NAMESPACE@.sl_subscribe
***************
*** 5213,5217 ****
  						  and sub_receiver = v_row.receiver
  						  and sub_active;
! 			continue;
  		end if;
  
--- 5218,5222 ----
  						  and sub_receiver = v_row.receiver
  						  and sub_active;
! 			end if;
  		end if;
  

From cbbrowne at lists.slony.info  Mon Oct 22 11:06:40 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Mon Oct 22 11:06:42 2007
Subject: [Slony1-commit] slony1-engine/tests/testpartition gen_weak_user.sh
Message-ID: <20071022180640.59BD2290D5B@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/tests/testpartition
In directory main.slony.info:/tmp/cvs-serv17845

Added Files:
	gen_weak_user.sh 
Log Message:
Add (to partitioning test) script for generating the "weak user" schema.


--- NEW FILE: gen_weak_user.sh ---
weakuser=$1;

for i in 1 2 1a 2a; do
   echo "grant select on table public.table${i} to ${weakuser};"
   echo "grant select on table public.table${i}_id_seq to ${weakuser};"
done
From cbbrowne at lists.slony.info  Mon Oct 22 11:45:04 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Mon Oct 22 11:45:05 2007
Subject: [Slony1-commit] slony1-engine/tests/testmergeset gen_ddl_slonik.sh
	init_subscribe_set.ik schema.diff
Message-ID: <20071022184504.199A2290D5B@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/tests/testmergeset
In directory main.slony.info:/tmp/cvs-serv18245

Modified Files:
	gen_ddl_slonik.sh init_subscribe_set.ik schema.diff 
Log Message:
Fixes to "merge set" test


Index: init_subscribe_set.ik
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tests/testmergeset/init_subscribe_set.ik,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** init_subscribe_set.ik	25 Sep 2007 18:25:11 -0000	1.1
--- init_subscribe_set.ik	22 Oct 2007 18:45:02 -0000	1.2
***************
*** 1,6 ****
  subscribe set (id = 1, provider = 1, receiver = 2, forward = yes);
! wait for event(origin = all, confirmed = 2, wait on=1);
  subscribe set (id = 1, provider = 1, receiver = 3, forward = no);
! wait for event(origin = all, confirmed = 3, wait on=1);
  subscribe set (id = 1, provider = 2, receiver = 4, forward = no);
! wait for event(origin = all, confirmed = 4, wait on=1);
--- 1,9 ----
  subscribe set (id = 1, provider = 1, receiver = 2, forward = yes);
! sync (id=1);
! wait for event (origin = all, confirmed = 2, wait on = 1);
  subscribe set (id = 1, provider = 1, receiver = 3, forward = no);
! sync (id=1);
! wait for event (origin = all, confirmed = 3, wait on = 1);
  subscribe set (id = 1, provider = 2, receiver = 4, forward = no);
! sync (id=1);
! wait for event (origin = all, confirmed = 4, wait on = 1);

Index: gen_ddl_slonik.sh
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tests/testmergeset/gen_ddl_slonik.sh,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** gen_ddl_slonik.sh	25 Sep 2007 18:25:11 -0000	1.1
--- gen_ddl_slonik.sh	22 Oct 2007 18:45:02 -0000	1.2
***************
*** 15,30 ****
    subscribe set (id=999, provider=1, receiver=2, forward = yes);
    sync (id=1);
!   wait for event (origin=1, confirmed=all, wait on=2);
    subscribe set (id=999, provider=1, receiver=3, forward = no);
    sync (id=1);
!   wait for event (origin=1, confirmed=all, wait on=3);
    subscribe set (id=999, provider=2, receiver=4, forward = no);
!   sync (id=1);
!   wait for event (origin=1, confirmed=all, wait on=4);
!   sync (id=1);
!   sleep (seconds = 5);
!   wait for event (origin=1, confirmed=all, wait on=4);
!   sync (id=1);
!   wait for event (origin=1, confirmed=all, wait on=4);
    merge set (ID = 1, ADD ID = 999, ORIGIN = 1 );
  
--- 15,26 ----
    subscribe set (id=999, provider=1, receiver=2, forward = yes);
    sync (id=1);
!   wait for event (origin=1, confirmed=2, wait on=1);
    subscribe set (id=999, provider=1, receiver=3, forward = no);
    sync (id=1);
!   wait for event (origin=1, confirmed=3, wait on=1);
    subscribe set (id=999, provider=2, receiver=4, forward = no);
!   sync (id=2);
!   wait for event (origin=2, confirmed=4, wait on=2);
!   sleep(seconds=5);
    merge set (ID = 1, ADD ID = 999, ORIGIN = 1 );
  

Index: schema.diff
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tests/testmergeset/schema.diff,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** schema.diff	25 Sep 2007 18:25:11 -0000	1.1
--- schema.diff	22 Oct 2007 18:45:02 -0000	1.2
***************
*** 4,6 ****
  select '2006_2', * from sales_txns_2006_2 order by id
  select '2006_3', * from sales_txns_2006_3 order by id
- select '2006_4', * from sales_txns_2006_4 order by id
--- 4,5 ----

From cbbrowne at lists.slony.info  Mon Oct 22 13:44:26 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Mon Oct 22 13:44:27 2007
Subject: [Slony1-commit] slony1-engine RELEASE
Message-ID: <20071022204426.57EEA290D5B@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine
In directory main.slony.info:/tmp/cvs-serv19826

Modified Files:
      Tag: REL_1_2_STABLE
	RELEASE 
Log Message:
- Error handling for "ERROR: could not serialize access due to
  concurrent update"

If this error is encountered when starting processing of
sl_archive_counter, then two threads are fighting over access to this
counter, and at least one has just failed.

Rather than waiting, we ask to restart the node immediately.


Index: RELEASE
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/RELEASE,v
retrieving revision 1.1.2.18
retrieving revision 1.1.2.19
diff -C2 -d -r1.1.2.18 -r1.1.2.19
*** RELEASE	4 Oct 2007 15:22:40 -0000	1.1.2.18
--- RELEASE	22 Oct 2007 20:44:24 -0000	1.1.2.19
***************
*** 9,12 ****
--- 9,17 ----
    do no work when not specifically requested.
  
+   CAVEAT:  This functionality may not work as expected on versions
+   of PostgreSQL earlier than 8.1.  Mind you, partitioning tends
+   to function pretty poorly in earlier versions of PostgreSQL as
+   there were substantial enhancements in 8.1 and following versions.
+ 
  - Added a fairly substantial partitioning test to exercise the
    new stored functions above.
***************
*** 20,26 ****
    SERIALIZABLE;" query that needs to be the first thing run...
  
! - Fixing the archive sequence generations. All non-SYNC events must
!   start the local transaction before creating the archive as well, so
!   that the lock on the archive counter table serializes archive creation.
  
  - Fixed logging done in local_listener.c - various places, there was
--- 25,32 ----
    SERIALIZABLE;" query that needs to be the first thing run...
  
! - Fixing the archive sequence generations (in log shipping).  All
!   non-SYNC events must start the local transaction before creating the
!   archive as well, so that the lock on the archive counter table
!   serializes archive creation.
  
  - Fixed logging done in local_listener.c - various places, there was
***************
*** 30,33 ****
--- 36,48 ----
  - Fix launch_slons.sh - was not stripping quotes from PID file name
  
+ - Error handling for "ERROR: could not serialize access due to
+   concurrent update"
+ 
+   If this error is encountered when starting processing of
+   sl_archive_counter, then two threads are fighting over access to
+   this counter, and at least one has just failed.
+ 
+   Rather than waiting, we ask to restart the node immediately.
+ 
  RELEASE 1.2.11
  

From cbbrowne at lists.slony.info  Mon Oct 22 13:44:26 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Mon Oct 22 13:44:28 2007
Subject: [Slony1-commit] slony1-engine/src/slon remote_worker.c
Message-ID: <20071022204426.9CA9B290D90@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slon
In directory main.slony.info:/tmp/cvs-serv19826/src/slon

Modified Files:
      Tag: REL_1_2_STABLE
	remote_worker.c 
Log Message:
- Error handling for "ERROR: could not serialize access due to
  concurrent update"

If this error is encountered when starting processing of
sl_archive_counter, then two threads are fighting over access to this
counter, and at least one has just failed.

Rather than waiting, we ask to restart the node immediately.


Index: remote_worker.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/remote_worker.c,v
retrieving revision 1.124.2.28
retrieving revision 1.124.2.29
diff -C2 -d -r1.124.2.28 -r1.124.2.29
*** remote_worker.c	19 Oct 2007 18:37:03 -0000	1.124.2.28
--- remote_worker.c	22 Oct 2007 20:44:24 -0000	1.124.2.29
***************
*** 5563,5571 ****
  	if ((rc = PQresultStatus(res)) != PGRES_TUPLES_OK)
  	{
! 		slon_log(SLON_ERROR,
! 				 "remoteWorkerThread_%d: \"%s\" %s %s\n",
  				 node->no_id, dstring_data(&query),
  				 PQresStatus(rc),
! 				 PQresultErrorMessage(res));
  		PQclear(res);
  		dstring_free(&query);
--- 5563,5583 ----
  	if ((rc = PQresultStatus(res)) != PGRES_TUPLES_OK)
  	{
! 		/* see what kind of error it is... */
! #define CONCUPDATEMSG "ERROR:  could not serialize access due to concurrent update"
! 		if (strncmp(CONCUPDATEMSG, PQresultErrorMessage(res), strlen(CONCUPDATEMSG)) == 0) {
! 			slon_log(SLON_WARN, "serialization problem updating sl_archive_counter: restarting slon\n");
! 			slon_mkquery(&query,
! 				     "notify \"_%s_Restart\"; ",
! 				     rtcfg_cluster_name);
! 			PQexec(dbconn, dstring_data(&query));
! 		} else {
! 
! 			slon_log(SLON_WARN, "error message was [%s]\n", PQresultErrorMessage(res));
! 			slon_log(SLON_ERROR,
! 					 "remoteWorkerThread_%d: \"%s\" %s %s\n",
  				 node->no_id, dstring_data(&query),
  				 PQresStatus(rc),
! 					 PQresultErrorMessage(res));
! 		}
  		PQclear(res);
  		dstring_free(&query);

From cbbrowne at lists.slony.info  Mon Oct 22 13:47:50 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Mon Oct 22 13:47:51 2007
Subject: [Slony1-commit] slony1-engine/doc/adminguide loganalysis.sgml
Message-ID: <20071022204750.2674E290D78@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/doc/adminguide
In directory main.slony.info:/tmp/cvs-serv19930

Modified Files:
      Tag: REL_1_2_STABLE
	loganalysis.sgml 
Log Message:
Document new case that comes up with log shipping where fighting
over access to log numbering can lead to a serialization error.


Index: loganalysis.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/loganalysis.sgml,v
retrieving revision 1.4.2.4
retrieving revision 1.4.2.5
diff -C2 -d -r1.4.2.4 -r1.4.2.5
*** loganalysis.sgml	6 Jun 2007 22:17:10 -0000	1.4.2.4
--- loganalysis.sgml	22 Oct 2007 20:47:48 -0000	1.4.2.5
***************
*** 213,216 ****
--- 213,226 ----
  
  <para> Probably means that we just filled up a filesystem... </para></listitem>
+ 
+ <listitem><para> <command>ERROR  remoteWorkerThread_%d: "update "_slony_regress1".sl_archive_counter     set ac_num = ac_num + 1,         ac_timestamp = CURRENT_TIMESTAMP; select ac_num, ac_timestamp from "_slony_regress1".sl_archive_counter; " PGRES_FATAL_ERROR ERROR:  could not serialize access due to concurrent update</command> </para>
+ 
+ <para> This may occasionally occur when using logshipping; this will
+ typically happen if there are 3 or more nodes, and there is an attempt
+ to concurrently process events sourced from different nodes.  This
+ does not represent any serious problem; &slony1; will retry the event
+ which failed without the need for administrative intervention. </para>
+ </listitem>
+ 
  </itemizedlist>
  </sect3>

From cbbrowne at lists.slony.info  Mon Oct 22 13:48:19 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Mon Oct 22 13:48:20 2007
Subject: [Slony1-commit] slony1-engine/doc/adminguide slonik_ref.sgml
Message-ID: <20071022204819.A82E4290D90@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/doc/adminguide
In directory main.slony.info:/tmp/cvs-serv19962

Modified Files:
      Tag: REL_1_2_STABLE
	slonik_ref.sgml 
Log Message:
Improvement to WAIT FOR EVENT documentation


Index: slonik_ref.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/slonik_ref.sgml,v
retrieving revision 1.61.2.10
retrieving revision 1.61.2.11
diff -C2 -d -r1.61.2.10 -r1.61.2.11
*** slonik_ref.sgml	6 Aug 2007 06:48:04 -0000	1.61.2.10
--- slonik_ref.sgml	22 Oct 2007 20:48:17 -0000	1.61.2.11
***************
*** 1260,1268 ****
       # Assuming that set 1 has direct subscribers 2 and 3
       SUBSCRIBE SET (ID = 999, PROVIDER = 1, RECEIVER = 2);
-      WAIT FOR EVENT (ORIGIN = 2, CONFIRMED = 1);
       SYNC (ID=1);
       SUBSCRIBE SET (ID = 999, PROVIDER = 1, RECEIVER = 3);
-      WAIT FOR EVENT (ORIGIN = 3, CONFIRMED = 1);
       SYNC (ID=1);
       MERGE SET ( ID = 1, ADD ID = 999, ORIGIN = 1 );
      </programlisting>
--- 1260,1268 ----
       # Assuming that set 1 has direct subscribers 2 and 3
       SUBSCRIBE SET (ID = 999, PROVIDER = 1, RECEIVER = 2);
       SYNC (ID=1);
+      WAIT FOR EVENT (ORIGIN = 1, CONFIRMED = 2, WAIT FOR=1);
       SUBSCRIBE SET (ID = 999, PROVIDER = 1, RECEIVER = 3);
       SYNC (ID=1);
+      WAIT FOR EVENT (ORIGIN = 1, CONFIRMED = 3, WAIT FOR=1);
       MERGE SET ( ID = 1, ADD ID = 999, ORIGIN = 1 );
      </programlisting>
***************
*** 2795,2803 ****
     linkend="stmtsubscribeset"> request will return the event
     confirmation almost immediately, even though there might be several
!    hours of work to do before the subscription is ready. </para>
  
!    <para> There is no reliable way, at present, to monitor from within
!    a <xref linkend="slonik"> script that <xref
!    linkend="stmtsubscribeset"> is complete.</para>
     </refsect1>
     
--- 2795,2819 ----
     linkend="stmtsubscribeset"> request will return the event
     confirmation almost immediately, even though there might be several
!    hours of work to do before the subscription is ready.  The trouble
!    with <xref linkend="stmtsubscribeset"> is that it is processed as
!    <emphasis>two</emphasis> events, one on the origin node, with a
!    second event, to enable the subscription, on the subscriber.
!    </para>
  
!    <para> In order to more reliably monitor from within a <xref
!    linkend="slonik"> script that <xref linkend="stmtsubscribeset"> is
!    complete, you may submit a <xref linkend="stmtsync"> event after
!    the subscription, and have the WAIT request wait on that
!    <command>SYNC</command> event, as follows. </para>
!     <programlisting>
!      # Assuming that set 1 has direct subscribers 2 and 3
!      SUBSCRIBE SET (ID = 999, PROVIDER = 1, RECEIVER = 2);
!      SYNC (ID=1);
!      WAIT FOR EVENT (ORIGIN = 1, CONFIRMED = 2, WAIT FOR=1);
!      SUBSCRIBE SET (ID = 999, PROVIDER = 1, RECEIVER = 3);
!      SYNC (ID=1);
!      WAIT FOR EVENT (ORIGIN = 1, CONFIRMED = 3, WAIT FOR=1);
!      MERGE SET ( ID = 1, ADD ID = 999, ORIGIN = 1 );
!     </programlisting>
     </refsect1>
     

From cbbrowne at lists.slony.info  Mon Oct 22 13:49:29 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Mon Oct 22 13:49:30 2007
Subject: [Slony1-commit] slony1-engine/doc/adminguide loganalysis.sgml
	slonik_ref.sgml
Message-ID: <20071022204929.08965290D78@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/doc/adminguide
In directory main.slony.info:/tmp/cvs-serv19986

Modified Files:
	loganalysis.sgml slonik_ref.sgml 
Log Message:
Changes made in 1.2 branch - new log message, WAIT ON EVENT revisions


Index: slonik_ref.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/slonik_ref.sgml,v
retrieving revision 1.73
retrieving revision 1.74
diff -C2 -d -r1.73 -r1.74
*** slonik_ref.sgml	9 Jul 2007 15:20:36 -0000	1.73
--- slonik_ref.sgml	22 Oct 2007 20:49:26 -0000	1.74
***************
*** 1278,1286 ****
       # Assuming that set 1 has direct subscribers 2 and 3
       SUBSCRIBE SET (ID = 999, PROVIDER = 1, RECEIVER = 2);
-      WAIT FOR EVENT (ORIGIN = 2, CONFIRMED = 1);
       SYNC (ID=1);
       SUBSCRIBE SET (ID = 999, PROVIDER = 1, RECEIVER = 3);
-      WAIT FOR EVENT (ORIGIN = 3, CONFIRMED = 1);
       SYNC (ID=1);
       MERGE SET ( ID = 1, ADD ID = 999, ORIGIN = 1 );
      </programlisting>
--- 1278,1286 ----
       # Assuming that set 1 has direct subscribers 2 and 3
       SUBSCRIBE SET (ID = 999, PROVIDER = 1, RECEIVER = 2);
       SYNC (ID=1);
+      WAIT FOR EVENT (ORIGIN = 1, CONFIRMED = 2, WAIT FOR=1);
       SUBSCRIBE SET (ID = 999, PROVIDER = 1, RECEIVER = 3);
       SYNC (ID=1);
+      WAIT FOR EVENT (ORIGIN = 1, CONFIRMED = 3, WAIT FOR=1);
       MERGE SET ( ID = 1, ADD ID = 999, ORIGIN = 1 );
      </programlisting>
***************
*** 2834,2842 ****
     linkend="stmtsubscribeset"> request will return the event
     confirmation almost immediately, even though there might be several
!    hours of work to do before the subscription is ready. </para>
  
!    <para> There is no reliable way, at present, to monitor from within
!    a <xref linkend="slonik"> script that <xref
!    linkend="stmtsubscribeset"> is complete.</para>
     </refsect1>
     
--- 2834,2858 ----
     linkend="stmtsubscribeset"> request will return the event
     confirmation almost immediately, even though there might be several
!    hours of work to do before the subscription is ready.  The trouble
!    with <xref linkend="stmtsubscribeset"> is that it is processed as
!    <emphasis>two</emphasis> events, one on the origin node, with a
!    second event, to enable the subscription, on the subscriber.
!    </para>
  
!    <para> In order to more reliably monitor from within a <xref
!    linkend="slonik"> script that <xref linkend="stmtsubscribeset"> is
!    complete, you may submit a <xref linkend="stmtsync"> event after
!    the subscription, and have the WAIT request wait on that
!    <command>SYNC</command> event, as follows. </para>
!     <programlisting>
!      # Assuming that set 1 has direct subscribers 2 and 3
!      SUBSCRIBE SET (ID = 999, PROVIDER = 1, RECEIVER = 2);
!      SYNC (ID=1);
!      WAIT FOR EVENT (ORIGIN = 1, CONFIRMED = 2, WAIT FOR=1);
!      SUBSCRIBE SET (ID = 999, PROVIDER = 1, RECEIVER = 3);
!      SYNC (ID=1);
!      WAIT FOR EVENT (ORIGIN = 1, CONFIRMED = 3, WAIT FOR=1);
!      MERGE SET ( ID = 1, ADD ID = 999, ORIGIN = 1 );
!     </programlisting>
     </refsect1>
     

Index: loganalysis.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/loganalysis.sgml,v
retrieving revision 1.10
retrieving revision 1.11
diff -C2 -d -r1.10 -r1.11
*** loganalysis.sgml	27 Jun 2007 17:56:11 -0000	1.10
--- loganalysis.sgml	22 Oct 2007 20:49:26 -0000	1.11
***************
*** 229,232 ****
--- 229,242 ----
  
  <para> Probably means that we just filled up a filesystem... </para></listitem>
+ 
+ <listitem><para> <command>ERROR  remoteWorkerThread_%d: "update "_slony_regress1".sl_archive_counter     set ac_num = ac_num + 1,         ac_timestamp = CURRENT_TIMESTAMP; select ac_num, ac_timestamp from "_slony_regress1".sl_archive_counter; " PGRES_FATAL_ERROR ERROR:  could not serialize access due to concurrent update</command> </para>
+ 
+ <para> This may occasionally occur when using logshipping; this will
+ typically happen if there are 3 or more nodes, and there is an attempt
+ to concurrently process events sourced from different nodes.  This
+ does not represent any serious problem; &slony1; will retry the event
+ which failed without the need for administrative intervention. </para>
+ </listitem>
+ 
  </itemizedlist>
  </sect3>

From cbbrowne at lists.slony.info  Mon Oct 22 13:50:37 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Mon Oct 22 13:50:39 2007
Subject: [Slony1-commit] slony1-engine/doc/adminguide reshape.sgml
Message-ID: <20071022205037.43B62290D78@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/doc/adminguide
In directory main.slony.info:/tmp/cvs-serv20018

Modified Files:
	reshape.sgml 
Log Message:
Fix per David Rees


Index: reshape.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/reshape.sgml,v
retrieving revision 1.20
retrieving revision 1.21
diff -C2 -d -r1.20 -r1.21
*** reshape.sgml	21 Sep 2006 16:17:58 -0000	1.20
--- reshape.sgml	22 Oct 2007 20:50:35 -0000	1.21
***************
*** 37,41 ****
  entries is entirely automated, so that they are regenerated when
  changes are made to <xref linkend="table.sl-path"> or <xref
! linkend="table.sl-path">, thereby making it unnecessary to even think
  about <xref linkend="stmtstorelisten">.</para></listitem>
  
--- 37,41 ----
  entries is entirely automated, so that they are regenerated when
  changes are made to <xref linkend="table.sl-path"> or <xref
! linkend="table.sl-subscribe">, thereby making it unnecessary to even think
  about <xref linkend="stmtstorelisten">.</para></listitem>
  

From cbbrowne at lists.slony.info  Mon Oct 22 13:50:57 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Mon Oct 22 13:50:58 2007
Subject: [Slony1-commit] slony1-engine/doc/adminguide reshape.sgml
Message-ID: <20071022205057.59D50290D90@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/doc/adminguide
In directory main.slony.info:/tmp/cvs-serv20031

Modified Files:
      Tag: REL_1_2_STABLE
	reshape.sgml 
Log Message:
Fix per David Rees


Index: reshape.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/reshape.sgml,v
retrieving revision 1.20
retrieving revision 1.20.2.1
diff -C2 -d -r1.20 -r1.20.2.1
*** reshape.sgml	21 Sep 2006 16:17:58 -0000	1.20
--- reshape.sgml	22 Oct 2007 20:50:55 -0000	1.20.2.1
***************
*** 37,41 ****
  entries is entirely automated, so that they are regenerated when
  changes are made to <xref linkend="table.sl-path"> or <xref
! linkend="table.sl-path">, thereby making it unnecessary to even think
  about <xref linkend="stmtstorelisten">.</para></listitem>
  
--- 37,41 ----
  entries is entirely automated, so that they are regenerated when
  changes are made to <xref linkend="table.sl-path"> or <xref
! linkend="table.sl-subscribe">, thereby making it unnecessary to even think
  about <xref linkend="stmtstorelisten">.</para></listitem>
  

From cbbrowne at lists.slony.info  Tue Oct 23 07:49:46 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Oct 23 07:49:48 2007
Subject: [Slony1-commit] slony1-engine/src/parsestatements
	cstylecomments.expected.win32 test_sql.expected.win32
Message-ID: <20071023144946.884AD290D89@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/parsestatements
In directory main.slony.info:/tmp/cvs-serv9538

Modified Files:
      Tag: REL_1_2_STABLE
	test_sql.expected.win32 
Added Files:
      Tag: REL_1_2_STABLE
	cstylecomments.expected.win32 
Log Message:
Per Hiroshi Saito, 2007-10-23.


--- NEW FILE: cstylecomments.expected.win32 ---
Input: -- Have two statements separated by a C-style string
select * from a;
/*
select count(distinct person_id)
from
    person
    join dictionary on dic_category_id=11
    left join person_settings on ps_person_id=person_id and ps_did=dic_id
where
    ps_person_id is null
-- only 9000!
*/
select * from b;
/************ *foooo*   /- *
/   here is a tremendously ugly C-style comment
* * * * * /
-- **{***(***[****/
select * from c;

/* lets have a comment and a  /* nested comment */ */
-- Force a query to be at the end...

create table foo;

statement 0
-------------------------------------------
-- Have two statements separated by a C-style string
select * from a;
statement 1
-------------------------------------------

/*
select count(distinct person_id)
from
    person
    join dictionary on dic_category_id=11
    left join person_settings on ps_person_id=person_id and ps_did=dic_id
where
    ps_person_id is null
-- only 9000!
*/
select * from b;
statement 2
-------------------------------------------

/************ *foooo*   /- *
/   here is a tremendously ugly C-style comment
* * * * * /
-- **{***(***[****/
select * from c;
statement 3
-------------------------------------------


/* lets have a comment and a  /* nested comment */ */
-- Force a query to be at the end...

create table foo; 
Index: test_sql.expected.win32
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/parsestatements/test_sql.expected.win32,v
retrieving revision 1.3.2.1
retrieving revision 1.3.2.2
diff -C2 -d -r1.3.2.1 -r1.3.2.2
*** test_sql.expected.win32	29 Aug 2007 15:14:31 -0000	1.3.2.1
--- test_sql.expected.win32	23 Oct 2007 14:49:44 -0000	1.3.2.2
***************
*** 60,65 ****
  
  -- Some more torturing per Weslee Bilodeau
! 
! -- I figure the $_$, $$, etc edge-casees would be another fun one to roll
  -- into a custom parser.
  
--- 60,64 ----
  
  -- Some more torturing per Weslee Bilodeau
! -- I figure the $_$, $$, etc edge-cases would be another fun one to roll
  -- into a custom parser.
  
***************
*** 194,199 ****
  
  -- Some more torturing per Weslee Bilodeau
! 
! -- I figure the $_$, $$, etc edge-casees would be another fun one to roll
  -- into a custom parser.
  
--- 193,197 ----
  
  -- Some more torturing per Weslee Bilodeau
! -- I figure the $_$, $$, etc edge-cases would be another fun one to roll
  -- into a custom parser.
  

From cbbrowne at lists.slony.info  Tue Oct 23 08:01:11 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Oct 23 08:01:13 2007
Subject: [Slony1-commit] slony1-engine/src/parsestatements
	cstylecomments.expected.win32 test_sql.expected.win32
Message-ID: <20071023150111.78858290CE3@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/parsestatements
In directory main.slony.info:/tmp/cvs-serv9830

Modified Files:
	test_sql.expected.win32 
Added Files:
	cstylecomments.expected.win32 
Log Message:
Win32 test files per Hiroshi Saito


--- NEW FILE: cstylecomments.expected.win32 ---
Input: -- Have two statements separated by a C-style string
select * from a;
/*
select count(distinct person_id)
from
    person
    join dictionary on dic_category_id=11
    left join person_settings on ps_person_id=person_id and ps_did=dic_id
where
    ps_person_id is null
-- only 9000!
*/
select * from b;
/************ *foooo*   /- *
/   here is a tremendously ugly C-style comment
* * * * * /
-- **{***(***[****/
select * from c;

/* lets have a comment and a  /* nested comment */ */
-- Force a query to be at the end...

create table foo;

statement 0
-------------------------------------------
-- Have two statements separated by a C-style string
select * from a;
statement 1
-------------------------------------------

/*
select count(distinct person_id)
from
    person
    join dictionary on dic_category_id=11
    left join person_settings on ps_person_id=person_id and ps_did=dic_id
where
    ps_person_id is null
-- only 9000!
*/
select * from b;
statement 2
-------------------------------------------

/************ *foooo*   /- *
/   here is a tremendously ugly C-style comment
* * * * * /
-- **{***(***[****/
select * from c;
statement 3
-------------------------------------------


/* lets have a comment and a  /* nested comment */ */
-- Force a query to be at the end...

create table foo; 
Index: test_sql.expected.win32
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/parsestatements/test_sql.expected.win32,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** test_sql.expected.win32	29 Aug 2007 15:14:08 -0000	1.4
--- test_sql.expected.win32	23 Oct 2007 15:01:09 -0000	1.5
***************
*** 60,65 ****
  
  -- Some more torturing per Weslee Bilodeau
! 
! -- I figure the $_$, $$, etc edge-casees would be another fun one to roll
  -- into a custom parser.
  
--- 60,64 ----
  
  -- Some more torturing per Weslee Bilodeau
! -- I figure the $_$, $$, etc edge-cases would be another fun one to roll
  -- into a custom parser.
  
***************
*** 194,199 ****
  
  -- Some more torturing per Weslee Bilodeau
! 
! -- I figure the $_$, $$, etc edge-casees would be another fun one to roll
  -- into a custom parser.
  
--- 193,197 ----
  
  -- Some more torturing per Weslee Bilodeau
! -- I figure the $_$, $$, etc edge-cases would be another fun one to roll
  -- into a custom parser.
  

From cbbrowne at lists.slony.info  Tue Oct 23 09:52:58 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Oct 23 09:53:00 2007
Subject: [Slony1-commit] slony1-engine/src/backend slony1_funcs.sql
Message-ID: <20071023165258.E78B3290D3E@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/backend
In directory main.slony.info:/tmp/cvs-serv11947

Modified Files:
	slony1_funcs.sql 
Log Message:
Impose "order by tab_id" in several places where tables are being
altered to turn replication on/off.

Seems preferable to order this way; that way we're actually using
the table ordering that the docs claim we use.


Index: slony1_funcs.sql
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/backend/slony1_funcs.sql,v
retrieving revision 1.121
retrieving revision 1.122
diff -C2 -d -r1.121 -r1.122
*** slony1_funcs.sql	13 Sep 2007 14:19:58 -0000	1.121
--- slony1_funcs.sql	23 Oct 2007 16:52:56 -0000	1.122
***************
*** 1201,1204 ****
--- 1201,1205 ----
  				for v_row2 in select * from @NAMESPACE@.sl_table
  						where tab_set = v_row.set_id
+ 						order by tab_id
  				loop
  					perform @NAMESPACE@.alterTableConfigureTriggers(v_row2.tab_id);
***************
*** 1359,1362 ****
--- 1360,1364 ----
  		for v_row in select * from @NAMESPACE@.sl_table
  				where tab_set = p_set_id
+ 				order by tab_id
  		loop
  			perform @NAMESPACE@.alterTableConfigureTriggers(v_row.tab_id);
***************
*** 5282,5286 ****
  		-- Upgrading from a pre-2.0 ... repair the system catalog
  		-- ----
! 		for v_tab_row in select * from @NAMESPACE@.sl_table loop
  			perform @NAMESPACE@.alterTableRestore(v_tab_row.tab_id);
  		end loop;
--- 5284,5288 ----
  		-- Upgrading from a pre-2.0 ... repair the system catalog
  		-- ----
! 		for v_tab_row in select * from @NAMESPACE@.sl_table order by tab_id loop
  			perform @NAMESPACE@.alterTableRestore(v_tab_row.tab_id);
  		end loop;
***************
*** 5295,5299 ****
  		-- and create the new versions of the log and deny access triggers.
  		-- ----
! 		for v_tab_row in select * from @NAMESPACE@.sl_table loop
  			perform @NAMESPACE@.alterTableAddTriggers(v_tab_row.tab_id);
  			perform @NAMESPACE@.alterTableConfigureTriggers(v_tab_row.tab_id);
--- 5297,5301 ----
  		-- and create the new versions of the log and deny access triggers.
  		-- ----
! 		for v_tab_row in select * from @NAMESPACE@.sl_table order by tab_id loop
  			perform @NAMESPACE@.alterTableAddTriggers(v_tab_row.tab_id);
  			perform @NAMESPACE@.alterTableConfigureTriggers(v_tab_row.tab_id);

From cbbrowne at lists.slony.info  Tue Oct 23 09:55:51 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Oct 23 09:55:52 2007
Subject: [Slony1-commit] slony1-engine/src/slon remote_worker.c
Message-ID: <20071023165551.D0837290CE3@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slon
In directory main.slony.info:/tmp/cvs-serv12039

Modified Files:
	remote_worker.c 
Log Message:
- log shipping check - do a Restart Node if the request to update
  the shared archive file number fails due to serialization

- reshaping of DDL handling code to get the changes recently made
  to fix v1.2


Index: remote_worker.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/remote_worker.c,v
retrieving revision 1.157
retrieving revision 1.158
diff -C2 -d -r1.157 -r1.158
*** remote_worker.c	19 Oct 2007 18:38:35 -0000	1.157
--- remote_worker.c	23 Oct 2007 16:55:49 -0000	1.158
***************
*** 1250,1341 ****
  				int			ddl_only_on_node = (int)strtol(event->ev_data3, NULL, 10);
  				int num_statements = -1, stmtno;
  
  				PGresult *res;
  				ExecStatusType rstat;
  
  
! 				slon_appendquery(&query1,
! 						 "set session_replication_role to local; "
! 						 "select %s.ddlScript_prepare_int(%d, %d); ",
! 						 rtcfg_namespace,
! 						 ddl_setid, ddl_only_on_node);
  
! 				if (query_execute(node, local_dbconn, &query1) < 0) {
  						slon_log(SLON_ERROR, "remoteWorkerThread_%d: DDL preparation failed - set %d - only on node %d\n",
  							 node->no_id, ddl_setid, ddl_only_on_node);
  						slon_retry();
! 				}
  
! 				num_statements = scan_for_statements (ddl_script);
! 				slon_log(SLON_CONFIG, "remoteWorkerThread_%d: DDL request with %d statements\n",
! 					 node->no_id, num_statements);
! 				if ((num_statements < 0) || (num_statements >= MAXSTATEMENTS)) {
! 					slon_log(SLON_ERROR, "remoteWorkerThread_%d: DDL had invalid number of statements - %d\n", 
  						 node->no_id, num_statements);
! 					slon_retry();
! 				}
! 				
! 				for (stmtno=0; stmtno < num_statements;  stmtno++) {
! 					int startpos, endpos;
! 					char *dest;
! 					if (stmtno == 0)
! 						startpos = 0;
! 					else
! 						startpos = STMTS[stmtno-1];
! 
! 					endpos = STMTS[stmtno];
! 					dest = (char *) malloc (endpos - startpos + 1);
! 					if (dest == 0) {
! 						slon_log(SLON_ERROR, "remoteWorkerThread_%d: malloc() failure in DDL_SCRIPT - could not allocate %d bytes of memory\n", 
! 							 node->no_id, endpos - startpos + 1);
  						slon_retry();
  					}
! 					strncpy(dest, ddl_script + startpos, endpos-startpos);
! 					dest[STMTS[stmtno]-startpos] = 0;
! 					(void) slon_mkquery(&query1, "%s", dest);
! 					slon_log(SLON_CONFIG, "remoteWorkerThread_%d: DDL Statement %d: [%s]\n", 
! 						 node->no_id, stmtno, dest);						 
! 					free(dest);
  
! 					res = PQexec(local_dbconn, dstring_data(&query1));
  
! 					if (PQresultStatus(res) != PGRES_COMMAND_OK && 
! 					    PQresultStatus(res) != PGRES_TUPLES_OK &&
! 					    PQresultStatus(res) != PGRES_EMPTY_QUERY)
! 					{
  						rstat = PQresultStatus(res);
! 						slon_log(SLON_ERROR, "DDL Statement failed - %s\n", PQresStatus(rstat));
! 						dstring_free(&query1);
! 						slon_retry();
  					}
- 					rstat = PQresultStatus(res);
- 					slon_log (SLON_CONFIG, "DDL success - %s\n", PQresStatus(rstat));
- 				}
  	
! 				(void) slon_mkquery(&query1,
! 						"select %s.ddlScript_complete_int(%d, %d); " 
! 						"set session_replication_role to replica; ",
! 					     rtcfg_namespace,
! 					     ddl_setid,
! 					     ddl_only_on_node);
  
! 				/* DDL_SCRIPT needs to be turned into a log shipping script */
! 				/* Note that the issue about parsing that mandates breaking 
! 				   up compound statements into
! 				   individually-processed statements does not apply to log
! 				   shipping as psql parses and processes each statement
! 				   individually */
  
! 				if (archive_dir)
! 				{
! 					if ((ddl_only_on_node < 1) || (ddl_only_on_node == rtcfg_nodeid))
  					{
  
! 						if (archive_append_str(node, "set session_replication_role to local;\n") < 0)
! 							slon_retry();
! 						if (archive_append_str(node, ddl_script) < 0)
! 							slon_retry();
! 						if (archive_append_str(node, "set session_replication_role to replica;\n") < 0)
! 							slon_retry();
  					}
  				}
--- 1250,1362 ----
  				int			ddl_only_on_node = (int)strtol(event->ev_data3, NULL, 10);
  				int num_statements = -1, stmtno;
+ 				int  node_in_set;
  
  				PGresult *res;
  				ExecStatusType rstat;
  
+ 				/**
+ 				 * Check to make sure this node is part of the set
+ 				 */
+ 				slon_log(SLON_INFO, "Checking local node id\n");
+ 				localNodeId = db_getLocalNodeId(local_dbconn);
+ 				slon_log(SLON_INFO,"Found local node id\n");
+ 				node_in_set = check_set_subscriber(ddl_setid,localNodeId,local_dbconn);
+ 				
+ 				if(!node_in_set) {
+ 					/**
+ 					 *
+ 					 * Node is not part of the set.  
+ 					 * Do not forward the DDL to the node,
+ 					 * nor should it be included in the log for log-shipping.
+ 					 */
+ 					slon_log(SLON_INFO,"Not forwarding DDL to node %d for set %d\n",
+ 						 node->no_id,ddl_setid);
+ 					
+ 				} else {
  
! 					slon_appendquery(&query1,
! 							 "set session_replication_role to local; "
! 							 "select %s.ddlScript_prepare_int(%d, %d); ",
! 							 rtcfg_namespace,
! 							 ddl_setid, ddl_only_on_node);
  
! 					if (query_execute(node, local_dbconn, &query1) < 0) {
  						slon_log(SLON_ERROR, "remoteWorkerThread_%d: DDL preparation failed - set %d - only on node %d\n",
  							 node->no_id, ddl_setid, ddl_only_on_node);
  						slon_retry();
! 					}
  
! 					num_statements = scan_for_statements (ddl_script);
! 					slon_log(SLON_CONFIG, "remoteWorkerThread_%d: DDL request with %d statements\n",
  						 node->no_id, num_statements);
! 					if ((num_statements < 0) || (num_statements >= MAXSTATEMENTS)) {
! 						slon_log(SLON_ERROR, "remoteWorkerThread_%d: DDL had invalid number of statements - %d\n", 
! 							 node->no_id, num_statements);
  						slon_retry();
  					}
! 				
! 					for (stmtno=0; stmtno < num_statements;  stmtno++) {
! 						int startpos, endpos;
! 						char *dest;
! 						if (stmtno == 0)
! 							startpos = 0;
! 						else
! 							startpos = STMTS[stmtno-1];
  
! 						endpos = STMTS[stmtno];
! 						dest = (char *) malloc (endpos - startpos + 1);
! 						if (dest == 0) {
! 							slon_log(SLON_ERROR, "remoteWorkerThread_%d: malloc() failure in DDL_SCRIPT - could not allocate %d bytes of memory\n", 
! 								 node->no_id, endpos - startpos + 1);
! 							slon_retry();
! 						}
! 						strncpy(dest, ddl_script + startpos, endpos-startpos);
! 						dest[STMTS[stmtno]-startpos] = 0;
! 						(void) slon_mkquery(&query1, "%s", dest);
! 						slon_log(SLON_CONFIG, "remoteWorkerThread_%d: DDL Statement %d: [%s]\n", 
! 							 node->no_id, stmtno, dest);						 
! 						free(dest);
  
! 						res = PQexec(local_dbconn, dstring_data(&query1));
! 
! 						if (PQresultStatus(res) != PGRES_COMMAND_OK && 
! 						    PQresultStatus(res) != PGRES_TUPLES_OK &&
! 						    PQresultStatus(res) != PGRES_EMPTY_QUERY)
! 						{
! 							rstat = PQresultStatus(res);
! 							slon_log(SLON_ERROR, "DDL Statement failed - %s\n", PQresStatus(rstat));
! 							dstring_free(&query1);
! 							slon_retry();
! 						}
  						rstat = PQresultStatus(res);
! 						slon_log (SLON_CONFIG, "DDL success - %s\n", PQresStatus(rstat));
  					}
  	
! 					(void) slon_mkquery(&query1,
! 							    "select %s.ddlScript_complete_int(%d, %d); " 
! 							    "set session_replication_role to replica; ",
! 							    rtcfg_namespace,
! 							    ddl_setid,
! 							    ddl_only_on_node);
  
! 					/* DDL_SCRIPT needs to be turned into a log shipping script */
! 					/* Note that the issue about parsing that mandates breaking 
! 					   up compound statements into
! 					   individually-processed statements does not apply to log
! 					   shipping as psql parses and processes each statement
! 					   individually */
  
! 					if (archive_dir)
  					{
+ 						if ((ddl_only_on_node < 1) || (ddl_only_on_node == rtcfg_nodeid))
+ 						{
  
! 							if (archive_append_str(node, "set session_replication_role to local;\n") < 0)
! 								slon_retry();
! 							if (archive_append_str(node, ddl_script) < 0)
! 								slon_retry();
! 							if (archive_append_str(node, "set session_replication_role to replica;\n") < 0)
! 								slon_retry();
! 						}
  					}
  				}
***************
*** 4992,5000 ****
  	if ((rc = PQresultStatus(res)) != PGRES_TUPLES_OK)
  	{
! 		slon_log(SLON_ERROR,
! 				 "remoteWorkerThread_%d: \"%s\" %s %s\n",
  				 node->no_id, dstring_data(&query),
  				 PQresStatus(rc),
! 				 PQresultErrorMessage(res));
  		PQclear(res);
  		dstring_free(&query);
--- 5013,5033 ----
  	if ((rc = PQresultStatus(res)) != PGRES_TUPLES_OK)
  	{
! 		/* see what kind of error it is... */
! #define CONCUPDATEMSG "ERROR:  could not serialize access due to concurrent update"
! 		if (strncmp(CONCUPDATEMSG, PQresultErrorMessage(res), strlen(CONCUPDATEMSG)) == 0) {
! 			slon_log(SLON_WARN, "serialization problem updating sl_archive_counter: restarting slon\n");
! 			slon_mkquery(&query,
! 				     "notify \"_%s_Restart\"; ",
! 				     rtcfg_cluster_name);
! 			PQexec(dbconn, dstring_data(&query));
! 		} else {
! 
! 			slon_log(SLON_WARN, "error message was [%s]\n", PQresultErrorMessage(res));
! 			slon_log(SLON_ERROR,
! 					 "remoteWorkerThread_%d: \"%s\" %s %s\n",
  				 node->no_id, dstring_data(&query),
  				 PQresStatus(rc),
! 					 PQresultErrorMessage(res));
! 		}
  		PQclear(res);
  		dstring_free(&query);

From cbbrowne at lists.slony.info  Tue Oct 23 10:00:29 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Oct 23 10:00:31 2007
Subject: [Slony1-commit] slony1-engine/src/backend slony1_funcs.sql
Message-ID: <20071023170029.4142D290D5B@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/backend
In directory main.slony.info:/tmp/cvs-serv12151

Modified Files:
	slony1_funcs.sql 
Log Message:
Add versions 1.2.11, 1.2.12 to HEAD's "update functions" set of versions
that it recognizes.


Index: slony1_funcs.sql
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/backend/slony1_funcs.sql,v
retrieving revision 1.122
retrieving revision 1.123
diff -C2 -d -r1.122 -r1.123
*** slony1_funcs.sql	23 Oct 2007 16:52:56 -0000	1.122
--- slony1_funcs.sql	23 Oct 2007 17:00:27 -0000	1.123
***************
*** 5280,5284 ****
  	end if;
  
! 	if p_old IN (''1.2.0'', ''1.2.1'', ''1.2.2'', ''1.2.3'', ''1.2.4'', ''1.2.5'', ''1.2.6'', ''1.2.7'', ''1.2.8'', ''1.2.9'', ''1.2.10'') then
  		-- ---- 
  		-- Upgrading from a pre-2.0 ... repair the system catalog
--- 5280,5284 ----
  	end if;
  
! 	if p_old IN (''1.2.0'', ''1.2.1'', ''1.2.2'', ''1.2.3'', ''1.2.4'', ''1.2.5'', ''1.2.6'', ''1.2.7'', ''1.2.8'', ''1.2.9'', ''1.2.10'', ''1.2.11'', ''1.2.12'') then
  		-- ---- 
  		-- Upgrading from a pre-2.0 ... repair the system catalog

From cbbrowne at lists.slony.info  Tue Oct 23 13:40:20 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Oct 23 13:40:21 2007
Subject: [Slony1-commit] slony1-engine/src/slony_logshipper/offline_result -
	New directory
Message-ID: <20071023204020.2CE04290D5B@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slony_logshipper/offline_result
In directory main.slony.info:/tmp/cvs-serv15034/offline_result

Log Message:
Directory /home/cvsd/slony1/slony1-engine/src/slony_logshipper/offline_result added to the repository
--> Using per-directory sticky tag `REL_1_2_STABLE'


From cbbrowne at lists.slony.info  Tue Oct 23 13:40:20 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Oct 23 13:40:22 2007
Subject: [Slony1-commit] slony1-engine/src/slony_logshipper/old - New
	directory
Message-ID: <20071023204020.3983814806D@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slony_logshipper/old
In directory main.slony.info:/tmp/cvs-serv15034/old

Log Message:
Directory /home/cvsd/slony1/slony1-engine/src/slony_logshipper/old added to the repository
--> Using per-directory sticky tag `REL_1_2_STABLE'


From cbbrowne at lists.slony.info  Tue Oct 23 13:54:37 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Oct 23 13:54:38 2007
Subject: [Slony1-commit] slony1-www/content frontpage.txt news.txt
Message-ID: <20071023205437.7C6F0290D79@main.slony.info>

Update of /home/cvsd/slony1/slony1-www/content
In directory main.slony.info:/tmp/cvs-serv15321/content

Modified Files:
	frontpage.txt news.txt 
Log Message:
Indicate availability of 1.2.12 pre1 version


Index: frontpage.txt
===================================================================
RCS file: /home/cvsd/slony1/slony1-www/content/frontpage.txt,v
retrieving revision 1.20
retrieving revision 1.21
diff -C2 -d -r1.20 -r1.21
*** frontpage.txt	28 Aug 2007 19:44:57 -0000	1.20
--- frontpage.txt	23 Oct 2007 20:54:35 -0000	1.21
***************
*** 1,60 ****
  ---
! Slony-I 1.2.11 pre-release #2 available
! http://slony.info/downloads/1.2/source/slony1-1.2.11.tar.bz2
! 2007-08-28
! Chris Browne
  
! We are pleased to announce general availability of Slony-I 1.2.11.
! Note that both <a href=
! "http://slony.info/downloads/1.2/source/slony1-1.2.11.tar.bz2">
! sources </a> and <a href=
! "http://slony.info/downloads/1.2/source/slony1-1.2.11-docs.tar.bz2">
! documentation</a> are available.
  
- <P> Fixes are the following:
  <ul>
! <li> Add in tools/mkservice scripts previously added to CVS HEAD
! 
! <li> During subscription, do UPDATE to pg_class.relhasindex *after* the
!   TRUNCATE because, in 8.2+, TRUNCATE resets this attribute
  
! <li> Fixed a problem with the setsync tracking with Log Shipping in cases
!   where slon does an internal restart (thereby rereading the
!   pset.ssy_seqno) and ignoring non-SYNC events because those don't
!   change the sl_setsync table.
  
! <li> More explicit type casting of text objects for compatibility with
!   PostgreSQL 8.3
  
! <li> Fixed problem with DDL SCRIPT statement parser: it wasn't 'quoting'
!   semicolons inside parentheses (this notably occurs in CREATE RULE).
  
! <li> Fixed problem with DDL SCRIPT statement submission; it was
!   interpreting the statement as a format string, which would have
!   ill effects in the presence of things that are interpreted such
!   as format strings (%d, %f, %s) and \backslashed things like \\, \n.
  
! <li> Further DDL Script issue: non-terminated statement at the end
!   (e.g. - without trailing semicolon ";") would get omitted.
  
! <li> Typo fix: when trying to disable a node, the logs would report
!   "enableNode" rather than "disableNode".  Fixed.
  
! <li> Add usage/version options to help output in slon.
  
! <li> Fix archive logging for replicated sequences.
  
! <li> Fix to log shipping - added another table, sl_archive_counter where
!   the log writing slon simply tracks when it wrote the last offline
!   archive file and maintains a counter. This counter is now tracked in
!   the offline replica and must increment gap free.
  
! <li> Change the filenames of archive logs to be based on internal archive
!   tracking number.  This makes it easy for the mechanism applying
!   archives to figure out what needs to be applied next - just look in
!   sl_archive_tracking.
  
! <li> Fix log shipping test to accomodate the new tracking scheme, and
!   update documentation to describe this better.  
  </ul>
  
--- 1,52 ----
  ---
! Slony-I 1.2.12 pre-1 available
  
! <P> Version 1.2.12 now has a <a
! href="http://slony.info/downloads/1.2/source/slony1-1.2.12-pre1.tar.bz2">
! release candidate.</a>
  
  <ul>
! <li>Fixed problem with DDL SCRIPT parser where C-style comments were
!   not being processed properly
  
! <li>Added stored functions and documentation for adding empty tables
!   (notably *partitions*) to replication.  Note these functions
!   do no work when not specifically requested.
  
!   CAVEAT:  This functionality may not work as expected on versions
!   of PostgreSQL earlier than 8.1.  Mind you, partitioning tends
!   to function pretty poorly in earlier versions of PostgreSQL as
!   there were substantial enhancements in 8.1 and following versions.
  
! <li>Added a fairly substantial partitioning test to exercise the
!   new stored functions above.
  
! <li>Backport "listen path" generator function from CVS HEAD (2.0) to
!   1.2 branch.
  
! <li>Fixed a problem with "EXECUTE SCRIPT" (introduced in remote_worker.c
!   version 1.124.2.13) where moving the relevant code into a subroutine
!   at the end led to losing the "BEGIN; SET TRANSACTION ISOLATION LEVEL
!   SERIALIZABLE;" query that needs to be the first thing run...
  
! <li>Fixing the archive sequence generations (in log shipping).  All
!   non-SYNC events must start the local transaction before creating the
!   archive as well, so that the lock on the archive counter table
!   serializes archive creation.
  
! <li>Fixed logging done in local_listener.c - various places, there was
!   no '\n' in some cases, which would lead to entries being folded
!   together.
  
! <li>Fix launch_slons.sh - was not stripping quotes from PID file name
  
! <li>Error handling for "ERROR: could not serialize access due to
!   concurrent update"
  
!   <P> If this error is encountered when starting processing of
!   sl_archive_counter, then two threads are fighting over access to
!   this counter, and at least one has just failed.
  
!   <P> Rather than waiting, we ask to restart the node immediately.
  </ul>
  

Index: news.txt
===================================================================
RCS file: /home/cvsd/slony1/slony1-www/content/news.txt,v
retrieving revision 1.34
retrieving revision 1.35
diff -C2 -d -r1.34 -r1.35
*** news.txt	28 Aug 2007 19:48:45 -0000	1.34
--- news.txt	23 Oct 2007 20:54:35 -0000	1.35
***************
*** 11,14 ****
--- 11,65 ----
  <!-- Please keep this item at the top of the news list -->
  ---
+ Slony-I 1.2.12 pre-1 available
+ http://slony.info/downloads/1.2/source/slony1-1.2.12-pre1.tar.bz2
+ 2007-10-23
+ Christopher Browne
+ 
+ <P> Version 1.2.12 now has a release candidate.
+ <ul>
+ <li>Fixed problem with DDL SCRIPT parser where C-style comments were
+   not being processed properly
+ 
+ <li>Added stored functions and documentation for adding empty tables
+   (notably *partitions*) to replication.  Note these functions
+   do no work when not specifically requested.
+ 
+   CAVEAT:  This functionality may not work as expected on versions
+   of PostgreSQL earlier than 8.1.  Mind you, partitioning tends
+   to function pretty poorly in earlier versions of PostgreSQL as
+   there were substantial enhancements in 8.1 and following versions.
+ 
+ <li>Added a fairly substantial partitioning test to exercise the
+   new stored functions above.
+ 
+ <li>Backport "listen path" generator function from CVS HEAD (2.0) to
+   1.2 branch.
+ 
+ <li>Fixed a problem with "EXECUTE SCRIPT" (introduced in remote_worker.c
+   version 1.124.2.13) where moving the relevant code into a subroutine
+   at the end led to losing the "BEGIN; SET TRANSACTION ISOLATION LEVEL
+   SERIALIZABLE;" query that needs to be the first thing run...
+ 
+ <li>Fixing the archive sequence generations (in log shipping).  All
+   non-SYNC events must start the local transaction before creating the
+   archive as well, so that the lock on the archive counter table
+   serializes archive creation.
+ 
+ <li>Fixed logging done in local_listener.c - various places, there was
+   no '\n' in some cases, which would lead to entries being folded
+   together.
+ 
+ <li>Fix launch_slons.sh - was not stripping quotes from PID file name
+ 
+ <li>Error handling for "ERROR: could not serialize access due to
+   concurrent update"
+ 
+   <P> If this error is encountered when starting processing of
+   sl_archive_counter, then two threads are fighting over access to
+   this counter, and at least one has just failed.
+ 
+   <P> Rather than waiting, we ask to restart the node immediately.
+ </ul>
+ ---
  Slony-I 1.2.11 released
  http://slony.info/downloads/1.2/source/slony1-1.2.11.tar.bz2

From cbbrowne at lists.slony.info  Tue Oct 23 13:55:54 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Oct 23 13:55:56 2007
Subject: [Slony1-commit] slony1-www/content frontpage.txt
Message-ID: <20071023205554.EF20A290D79@main.slony.info>

Update of /home/cvsd/slony1/slony1-www/content
In directory main.slony.info:/tmp/cvs-serv15367/content

Modified Files:
	frontpage.txt 
Log Message:
typographical fixes, remove test that was done in 1.2.11


Index: frontpage.txt
===================================================================
RCS file: /home/cvsd/slony1/slony1-www/content/frontpage.txt,v
retrieving revision 1.21
retrieving revision 1.22
diff -C2 -d -r1.21 -r1.22
*** frontpage.txt	23 Oct 2007 20:54:35 -0000	1.21
--- frontpage.txt	23 Oct 2007 20:55:52 -0000	1.22
***************
*** 53,60 ****
  The testing regimen included running all the tests in the test bed
  against instances of Slony-I running against PostgreSQL versions 7.4,
! 8.0, 8.1, 8.2, as well as CVS HEAD (forthcoming as 8.3).  There was
! also (against 7.4) a test done to verify that UPGRADE FUNCTIONS would
! bring version 1.1.x to 1.2.11.
! ---
  ---
  Slony-I and PostgreSQL 8.1
--- 53,57 ----
  The testing regimen included running all the tests in the test bed
  against instances of Slony-I running against PostgreSQL versions 7.4,
! 8.0, 8.1, 8.2, as well as CVS HEAD (forthcoming as 8.3).a
  ---
  Slony-I and PostgreSQL 8.1

From devrim at lists.slony.info  Wed Oct 24 10:03:42 2007
From: devrim at lists.slony.info (Devrim GUNDUZ)
Date: Wed Oct 24 10:03:43 2007
Subject: [Slony1-commit] slony1-engine GNUmakefile.in
Message-ID: <20071024170342.30600290D2B@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine
In directory main.slony.info:/tmp/cvs-serv12842

Modified Files:
      Tag: REL_1_2_STABLE
	GNUmakefile.in 
Log Message:
Use bzip2 instead of gzip while creating the tarball for the RPM stuff -- the official tarball is already a bzip2 file -- and spec file would be broken without this.


Index: GNUmakefile.in
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/GNUmakefile.in,v
retrieving revision 1.29.2.1
retrieving revision 1.29.2.2
diff -C2 -d -r1.29.2.1 -r1.29.2.2
*** GNUmakefile.in	18 Jun 2007 17:25:23 -0000	1.29.2.1
--- GNUmakefile.in	24 Oct 2007 17:03:40 -0000	1.29.2.2
***************
*** 10,14 ****
  top_builddir = .
  include $(top_builddir)/Makefile.global
! GZIP = gzip --best
  
  DEFAULTBUILDS=src tools
--- 10,14 ----
  top_builddir = .
  include $(top_builddir)/Makefile.global
! BZIP = bzip2 --best
  
  DEFAULTBUILDS=src tools
***************
*** 97,101 ****
  dist:	distdir
  	$(TAR) cf @PACKAGE_NAME@-@PACKAGE_VERSION@.tar $(distdir)
! 	$(GZIP) @PACKAGE_NAME@-@PACKAGE_VERSION@.tar
  	-rm -rf $(distdir)
  
--- 97,101 ----
  dist:	distdir
  	$(TAR) cf @PACKAGE_NAME@-@PACKAGE_VERSION@.tar $(distdir)
! 	$(BZIP) @PACKAGE_NAME@-@PACKAGE_VERSION@.tar
  	-rm -rf $(distdir)
  

From devrim at lists.slony.info  Wed Oct 24 10:08:25 2007
From: devrim at lists.slony.info (Devrim GUNDUZ)
Date: Wed Oct 24 10:08:26 2007
Subject: [Slony1-commit] slony1-engine GNUmakefile.in
Message-ID: <20071024170825.3470A290D5C@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine
In directory main.slony.info:/tmp/cvs-serv12992

Modified Files:
      Tag: REL_1_2_STABLE
	GNUmakefile.in 
Log Message:
Change the references from .gz to .bz2


Index: GNUmakefile.in
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/GNUmakefile.in,v
retrieving revision 1.29.2.2
retrieving revision 1.29.2.3
diff -C2 -d -r1.29.2.2 -r1.29.2.3
*** GNUmakefile.in	24 Oct 2007 17:03:40 -0000	1.29.2.2
--- GNUmakefile.in	24 Oct 2007 17:08:23 -0000	1.29.2.3
***************
*** 66,70 ****
  	rm -f config.log config.status config.h
  	rm -f @PACKAGE_NAME@.spec
! 	rm -f @PACKAGE_NAME@-@PACKAGE_VERSION@.tar.gz
  	rm -f postgres.imp
  	rm -rf autom4te.cache
--- 66,70 ----
  	rm -f config.log config.status config.h
  	rm -f @PACKAGE_NAME@.spec
! 	rm -f @PACKAGE_NAME@-@PACKAGE_VERSION@.tar.bz2
  	rm -f postgres.imp
  	rm -rf autom4te.cache
***************
*** 81,85 ****
  garbage := =*  "#"*  ."#"*  *~*  *.orig  *.rej  core  @PACKAGE_NAME@-*
  
! dist 	:= $(distdir).tar.gz
  
  distdir:
--- 81,85 ----
  garbage := =*  "#"*  ."#"*  *~*  *.orig  *.rej  core  @PACKAGE_NAME@-*
  
! dist 	:= $(distdir).tar.bz2
  
  distdir:
***************
*** 102,106 ****
  rpm: dist
  
! 	rpmbuild -ta @PACKAGE_NAME@-@PACKAGE_VERSION@.tar.gz
  
  .PHONY: install
--- 102,106 ----
  rpm: dist
  
! 	rpmbuild -ta @PACKAGE_NAME@-@PACKAGE_VERSION@.tar.bz2
  
  .PHONY: install

From devrim at lists.slony.info  Wed Oct 24 10:08:25 2007
From: devrim at lists.slony.info (Devrim GUNDUZ)
Date: Wed Oct 24 10:08:26 2007
Subject: [Slony1-commit] slony1-engine/doc/adminguide logshipping.sgml
Message-ID: <20071024170825.459E1290D97@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/doc/adminguide
In directory main.slony.info:/tmp/cvs-serv12992/doc/adminguide

Modified Files:
      Tag: REL_1_2_STABLE
	logshipping.sgml 
Log Message:
Change the references from .gz to .bz2


Index: logshipping.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/logshipping.sgml,v
retrieving revision 1.16.2.3
retrieving revision 1.16.2.4
diff -C2 -d -r1.16.2.3 -r1.16.2.4
*** logshipping.sgml	10 Sep 2007 22:23:32 -0000	1.16.2.3
--- logshipping.sgml	24 Oct 2007 17:08:23 -0000	1.16.2.4
***************
*** 381,385 ****
  <listitem><para> <command>rename namespace "public" to "site_001";</command></para> <para> One may rename entire namespaces.</para> </listitem>
  <listitem><para> <command>post processing command = 'gzip -9 $inarchive';</command></para> <para> Pre- and post-processign commands are executed via <function>system(3)</function>. </para> 
! 
  <para> An <quote>@</quote> as the first character causes the exit code to be ignored.  Otherwise, a nonzero exit code is treated as an error and causes processing to abort. </para>
  
--- 381,385 ----
  <listitem><para> <command>rename namespace "public" to "site_001";</command></para> <para> One may rename entire namespaces.</para> </listitem>
  <listitem><para> <command>post processing command = 'gzip -9 $inarchive';</command></para> <para> Pre- and post-processign commands are executed via <function>system(3)</function>. </para> 
! </itemizedlist>
  <para> An <quote>@</quote> as the first character causes the exit code to be ignored.  Otherwise, a nonzero exit code is treated as an error and causes processing to abort. </para>
  

From devrim at lists.slony.info  Wed Oct 24 10:31:19 2007
From: devrim at lists.slony.info (Devrim GUNDUZ)
Date: Wed Oct 24 10:31:20 2007
Subject: [Slony1-commit] slony1-engine/doc/adminguide partitioning.sgml
Message-ID: <20071024173119.10741290D5C@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/doc/adminguide
In directory main.slony.info:/tmp/cvs-serv13678

Modified Files:
      Tag: REL_1_2_STABLE
	partitioning.sgml 
Log Message:
Fix sgml error


Index: partitioning.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/partitioning.sgml,v
retrieving revision 1.1.2.1
retrieving revision 1.1.2.2
diff -C2 -d -r1.1.2.1 -r1.1.2.2
*** partitioning.sgml	5 Sep 2007 21:36:31 -0000	1.1.2.1
--- partitioning.sgml	24 Oct 2007 17:31:17 -0000	1.1.2.2
***************
*** 106,109 ****
--- 106,110 ----
  with confidence to add any table to replication that is known to be
  empty. </para> </note>
+ </sect2>
  
  </sect1>

From devrim at lists.slony.info  Wed Oct 24 10:49:37 2007
From: devrim at lists.slony.info (Devrim GUNDUZ)
Date: Wed Oct 24 10:49:38 2007
Subject: [Slony1-commit] slony1-engine/doc/adminguide logshipping.sgml
Message-ID: <20071024174937.4D16D290D2B@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/doc/adminguide
In directory main.slony.info:/tmp/cvs-serv13847

Modified Files:
      Tag: REL_1_2_STABLE
	logshipping.sgml 
Log Message:
Fix SGML errors


Index: logshipping.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/logshipping.sgml,v
retrieving revision 1.16.2.4
retrieving revision 1.16.2.5
diff -C2 -d -r1.16.2.4 -r1.16.2.5
*** logshipping.sgml	24 Oct 2007 17:08:23 -0000	1.16.2.4
--- logshipping.sgml	24 Oct 2007 17:49:35 -0000	1.16.2.5
***************
*** 380,384 ****
  <listitem><para> <command>rename namespace "public"."history" to "site_001"."history";</command></para> <para> One may rename specific tables.</para> </listitem>
  <listitem><para> <command>rename namespace "public" to "site_001";</command></para> <para> One may rename entire namespaces.</para> </listitem>
! <listitem><para> <command>post processing command = 'gzip -9 $inarchive';</command></para> <para> Pre- and post-processign commands are executed via <function>system(3)</function>. </para> 
  </itemizedlist>
  <para> An <quote>@</quote> as the first character causes the exit code to be ignored.  Otherwise, a nonzero exit code is treated as an error and causes processing to abort. </para>
--- 380,384 ----
  <listitem><para> <command>rename namespace "public"."history" to "site_001"."history";</command></para> <para> One may rename specific tables.</para> </listitem>
  <listitem><para> <command>rename namespace "public" to "site_001";</command></para> <para> One may rename entire namespaces.</para> </listitem>
! <listitem><para> <command>post processing command = 'gzip -9 $inarchive';</command></para> <para> Pre- and post-processign commands are executed via <function>system(3)</function>. </para> </listitem>
  </itemizedlist>
  <para> An <quote>@</quote> as the first character causes the exit code to be ignored.  Otherwise, a nonzero exit code is treated as an error and causes processing to abort. </para>
***************
*** 401,404 ****
--- 401,405 ----
  </itemizedlist>
  
+ <itemizedlist>
  <listitem><para> Archive File Names</para>
  

From cbbrowne at lists.slony.info  Thu Oct 25 11:32:02 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Thu Oct 25 11:32:04 2007
Subject: [Slony1-commit] slony1-engine/src/slon remote_worker.c
Message-ID: <20071025183202.B42F9290D93@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slon
In directory main.slony.info:/tmp/cvs-serv11971

Modified Files:
	remote_worker.c 
Log Message:
Oops - add in missing function that was added to 1.2 branch


Index: remote_worker.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/remote_worker.c,v
retrieving revision 1.158
retrieving revision 1.159
diff -C2 -d -r1.158 -r1.159
*** remote_worker.c	23 Oct 2007 16:55:49 -0000	1.158
--- remote_worker.c	25 Oct 2007 18:32:00 -0000	1.159
***************
*** 264,267 ****
--- 264,268 ----
  static void compress_actionseq(const char *ssy_actionseq, SlonDString * action_subquery);
  
+ static int check_set_subscriber(int set_id, int node_id,PGconn * local_dbconn);
  
  /* ----------
***************
*** 1251,1254 ****
--- 1252,1256 ----
  				int num_statements = -1, stmtno;
  				int  node_in_set;
+ 				int localNodeId;
  
  				PGresult *res;
***************
*** 5561,5562 ****
--- 5563,5596 ----
  	slon_log(SLON_DEBUG4, " compressed actionseq subquery... %s\n", dstring_data(action_subquery));
  }
+ 
+ /**
+  * Checks to see if the node specified is a member of the set.
+  *
+  */
+ static int check_set_subscriber(int set_id, int node_id,PGconn * local_dbconn) 
+ {
+   
+   
+   SlonDString query1;
+   PGresult* res;
+   dstring_init(&query1);
+ 
+   slon_appendquery(&query1,"select 1 from %s.sl_subscribe WHERE sub_set=%d AND sub_receiver=%d for update"
+ 	       ,rtcfg_namespace,set_id,node_id);
+   res = PQexec(local_dbconn,dstring_data(&query1));
+   if(PQresultStatus(res)!=PGRES_TUPLES_OK) {
+     slon_log(SLON_ERROR,"remoteWorkerThread_%d: DDL preparation can not check set membership"
+ 	     ,node_id);
+ 	dstring_free(&query1);
+     slon_retry();
+   }
+   dstring_free(&query1);
+   if(PQntuples(res)==0) {
+     PQclear(res);
+     return 0;
+   }
+   PQclear(res);
+   return 1;
+ 
+ 
+ }

From cbbrowne at lists.slony.info  Fri Oct 26 07:47:26 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Fri Oct 26 07:47:28 2007
Subject: [Slony1-commit] slony1-engine/tests/testmergeset README
	gen_ddl_slonik.sh generate_dml.sh
Message-ID: <20071026144726.2FDF52903D7@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/tests/testmergeset
In directory main.slony.info:/tmp/cvs-serv24014

Modified Files:
	README gen_ddl_slonik.sh generate_dml.sh 
Log Message:
Improvements to test for MERGE SET - better use of WAIT FOR EVENT,
notably.


Index: README
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tests/testmergeset/README,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** README	25 Sep 2007 18:25:11 -0000	1.1
--- README	26 Oct 2007 14:47:24 -0000	1.2
***************
*** 8,9 ****
--- 8,16 ----
  a set (a temporary set #999), and then merging that set back into the
  main set.
+ 
+ This test also takes a fairly aggressive tack on usage of WAIT FOR
+ EVENT; when it gets into the "merge phase," it submits a SYNC followed
+ by waiting for that SYNC to be confirmed on all relevant nodes before
+ submitting a MERGE SET request to eliminate the extra set.  It does
+ not use any SLEEP requests; concurrency control is expected to be
+ controlled by WAIT FOR EVENT.

Index: generate_dml.sh
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tests/testmergeset/generate_dml.sh,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** generate_dml.sh	25 Sep 2007 18:25:11 -0000	1.1
--- generate_dml.sh	26 Oct 2007 14:47:24 -0000	1.2
***************
*** 59,62 ****
--- 59,63 ----
        done
    done
+   wait_for_catchup
    status "done"
  }

Index: gen_ddl_slonik.sh
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tests/testmergeset/gen_ddl_slonik.sh,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** gen_ddl_slonik.sh	22 Oct 2007 18:45:02 -0000	1.2
--- gen_ddl_slonik.sh	26 Oct 2007 14:47:24 -0000	1.3
***************
*** 20,26 ****
    wait for event (origin=1, confirmed=3, wait on=1);
    subscribe set (id=999, provider=2, receiver=4, forward = no);
!   sync (id=2);
!   wait for event (origin=2, confirmed=4, wait on=2);
!   sleep(seconds=5);
    merge set (ID = 1, ADD ID = 999, ORIGIN = 1 );
  
--- 20,25 ----
    wait for event (origin=1, confirmed=3, wait on=1);
    subscribe set (id=999, provider=2, receiver=4, forward = no);
!   sync (id=1);
!   wait for event (origin=1, confirmed=ALL, wait on=1);
    merge set (ID = 1, ADD ID = 999, ORIGIN = 1 );
  

From cbbrowne at lists.slony.info  Fri Oct 26 11:22:28 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Fri Oct 26 11:22:29 2007
Subject: [Slony1-commit] slony1-engine/tools/altperl slonik_build_env.pl
Message-ID: <20071026182228.231C92903A1@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/tools/altperl
In directory main.slony.info:/tmp/cvs-serv28350

Modified Files:
      Tag: REL_1_2_STABLE
	slonik_build_env.pl 
Log Message:
From: Bernd Helmle <mailings@oopsware.de>

--On Donnerstag, Oktober 25, 2007 13:11:49 -0700 slony@estrider.com wrote:
>    There is a flaw in the slonik_build_env.pl script. The print test
> should be >=1 and not > 1. It currently will not print databases where
> there are only single tables or sequences.
>

You're right. I've created a patch with your changes plus a fix to
repair the -schema option, which was broken, too, and cc'ed
slony1-patches so someone can review and apply it.

Note that slonik_build_environment is called slonik_build_env only,
the former was removed.

-- 
 Thanks

                    Bernd
-------------------------------------------------
Looks good to me - applied to 1.2 branch...


Index: slonik_build_env.pl
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tools/altperl/slonik_build_env.pl,v
retrieving revision 1.1.4.1
retrieving revision 1.1.4.2
diff -C2 -d -r1.1.4.1 -r1.1.4.2
*** slonik_build_env.pl	13 Dec 2006 22:18:50 -0000	1.1.4.1
--- slonik_build_env.pl	26 Oct 2007 18:22:25 -0000	1.1.4.2
***************
*** 25,29 ****
  Default schema is \"public\"\n";
  
! &usage if(!GetOptions('node=s@'=>\@nodes));
  
  die "At least one node is required" if ( scalar(@nodes) < 1 );
--- 25,29 ----
  Default schema is \"public\"\n";
  
! &usage if(!GetOptions('node=s@'=>\@nodes, 'schema=s' => \$schema));
  
  die "At least one node is required" if ( scalar(@nodes) < 1 );
***************
*** 69,72 ****
--- 69,73 ----
  die "prepare(tableQuery): $DBI::errstr" if ( !defined($tableQuery) || $DBI::err );
  die "execute(tableQuery): $DBI::errstr" if ( !$tableQuery->execute() );
+ die "No objects to replicate found in schema \"$schema\"\n" if ($tableQuery->rows <= 0);
  
  my @tablesWithIndexes;
***************
*** 84,88 ****
  $dbh->disconnect();
  
! if ( scalar(@tablesWithIndexes) > 1 ) {
    print '@KEYEDTABLES=(' . "\n";
    foreach my $table (sort @tablesWithIndexes) {
--- 85,89 ----
  $dbh->disconnect();
  
! if ( scalar(@tablesWithIndexes) >= 1 ) {
    print '@KEYEDTABLES=(' . "\n";
    foreach my $table (sort @tablesWithIndexes) {
***************
*** 91,95 ****
    print ");\n";
  }
! if ( scalar(@tablesWithoutIndexes) > 1 ) {
    print '@SERIALTABLES=(' . "\n";
    foreach my $table (sort @tablesWithoutIndexes) {
--- 92,96 ----
    print ");\n";
  }
! if ( scalar(@tablesWithoutIndexes) >= 1 ) {
    print '@SERIALTABLES=(' . "\n";
    foreach my $table (sort @tablesWithoutIndexes) {
***************
*** 98,102 ****
    print ");\n";
  }
! if ( scalar(@sequences) > 1 ) {
    print '@SEQUENCES=(' . "\n";
    foreach my $table (sort @sequences) {
--- 99,103 ----
    print ");\n";
  }
! if ( scalar(@sequences) >= 1 ) {
    print '@SEQUENCES=(' . "\n";
    foreach my $table (sort @sequences) {

From cbbrowne at lists.slony.info  Fri Oct 26 11:23:07 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Fri Oct 26 11:23:08 2007
Subject: [Slony1-commit] slony1-engine/tools/altperl slonik_build_env.pl
Message-ID: <20071026182307.0724A29003C@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/tools/altperl
In directory main.slony.info:/tmp/cvs-serv28401

Modified Files:
	slonik_build_env.pl 
Log Message:
From: Bernd Helmle <mailings@oopsware.de>

--On Donnerstag, Oktober 25, 2007 13:11:49 -0700 slony@estrider.com wrote:
>    There is a flaw in the slonik_build_env.pl script. The print test
> should be >=1 and not > 1. It currently will not print databases where
> there are only single tables or sequences.
>

You're right. I've created a patch with your changes plus a fix to
repair the -schema option, which was broken, too, and cc'ed
slony1-patches so someone can review and apply it.

Note that slonik_build_environment is called slonik_build_env only,
the former was removed.

-- 
 Thanks

                    Bernd
-------------------------------------------------
Looks good to me - applied to HEAD branch...


Index: slonik_build_env.pl
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tools/altperl/slonik_build_env.pl,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** slonik_build_env.pl	13 Dec 2006 22:19:55 -0000	1.2
--- slonik_build_env.pl	26 Oct 2007 18:23:04 -0000	1.3
***************
*** 25,29 ****
  Default schema is \"public\"\n";
  
! &usage if(!GetOptions('node=s@'=>\@nodes));
  
  die "At least one node is required" if ( scalar(@nodes) < 1 );
--- 25,29 ----
  Default schema is \"public\"\n";
  
! &usage if(!GetOptions('node=s@'=>\@nodes, 'schema=s' => \$schema));
  
  die "At least one node is required" if ( scalar(@nodes) < 1 );
***************
*** 69,72 ****
--- 69,73 ----
  die "prepare(tableQuery): $DBI::errstr" if ( !defined($tableQuery) || $DBI::err );
  die "execute(tableQuery): $DBI::errstr" if ( !$tableQuery->execute() );
+ die "No objects to replicate found in schema \"$schema\"\n" if ($tableQuery->rows <= 0);
  
  my @tablesWithIndexes;
***************
*** 84,88 ****
  $dbh->disconnect();
  
! if ( scalar(@tablesWithIndexes) > 1 ) {
    print '@KEYEDTABLES=(' . "\n";
    foreach my $table (sort @tablesWithIndexes) {
--- 85,89 ----
  $dbh->disconnect();
  
! if ( scalar(@tablesWithIndexes) >= 1 ) {
    print '@KEYEDTABLES=(' . "\n";
    foreach my $table (sort @tablesWithIndexes) {
***************
*** 91,95 ****
    print ");\n";
  }
! if ( scalar(@tablesWithoutIndexes) > 1 ) {
    print '@SERIALTABLES=(' . "\n";
    foreach my $table (sort @tablesWithoutIndexes) {
--- 92,96 ----
    print ");\n";
  }
! if ( scalar(@tablesWithoutIndexes) >= 1 ) {
    print '@SERIALTABLES=(' . "\n";
    foreach my $table (sort @tablesWithoutIndexes) {
***************
*** 98,102 ****
    print ");\n";
  }
! if ( scalar(@sequences) > 1 ) {
    print '@SEQUENCES=(' . "\n";
    foreach my $table (sort @sequences) {
--- 99,103 ----
    print ");\n";
  }
! if ( scalar(@sequences) >= 1 ) {
    print '@SEQUENCES=(' . "\n";
    foreach my $table (sort @sequences) {

From cbbrowne at lists.slony.info  Fri Oct 26 11:29:09 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Fri Oct 26 11:29:11 2007
Subject: [Slony1-commit] slony1-engine RELEASE
Message-ID: <20071026182909.EC1D0290BFF@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine
In directory main.slony.info:/tmp/cvs-serv28521

Modified Files:
      Tag: REL_1_2_STABLE
	RELEASE 
Log Message:
Committed altperl change


Index: RELEASE
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/RELEASE,v
retrieving revision 1.1.2.19
retrieving revision 1.1.2.20
diff -C2 -d -r1.1.2.19 -r1.1.2.20
*** RELEASE	22 Oct 2007 20:44:24 -0000	1.1.2.19
--- RELEASE	26 Oct 2007 18:29:07 -0000	1.1.2.20
***************
*** 45,48 ****
--- 45,52 ----
    Rather than waiting, we ask to restart the node immediately.
  
+ - Fixes to slonik_build_env script - it wasn't properly handling
+   cases where there was just 1 table or 1 sequence, and had a
+   problem with the -schema option - thanks, Bernd Helmle
+ 
  RELEASE 1.2.11
  

From cbbrowne at lists.slony.info  Fri Oct 26 11:35:24 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Fri Oct 26 11:35:24 2007
Subject: [Slony1-commit] slony1-engine/src Makefile
Message-ID: <20071026183524.136CF290420@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src
In directory main.slony.info:/tmp/cvs-serv28695

Modified Files:
      Tag: REL_1_2_STABLE
	Makefile 
Log Message:
Per Hiroshi Saito...

- Don't bother building slony_logshipper on Windows


Index: Makefile
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/Makefile,v
retrieving revision 1.13.2.1
retrieving revision 1.13.2.2
diff -C2 -d -r1.13.2.1 -r1.13.2.2
*** Makefile	8 Sep 2007 14:21:40 -0000	1.13.2.1
--- Makefile	26 Oct 2007 18:35:22 -0000	1.13.2.2
***************
*** 13,19 ****
  
  DISTFILES = Makefile
! SUBDIRS = xxid parsestatements slon slonik slony_logshipper backend ducttape
  ifeq ($(PORTNAME),win32)
  SUBDIRS += slevent
  endif
  
--- 13,21 ----
  
  DISTFILES = Makefile
! SUBDIRS = xxid parsestatements slon slonik backend ducttape
  ifeq ($(PORTNAME),win32)
  SUBDIRS += slevent
+ else
+ SUBDIRS += slony_logshipper
  endif
  

From cbbrowne at lists.slony.info  Fri Oct 26 11:36:07 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Fri Oct 26 11:36:08 2007
Subject: [Slony1-commit] slony1-engine/src Makefile
Message-ID: <20071026183607.45BCE290C16@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src
In directory main.slony.info:/tmp/cvs-serv28731

Modified Files:
	Makefile 
Log Message:
Don't bother building slony_logshipper on Win32
- Per Hiroshi Saito


Index: Makefile
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/Makefile,v
retrieving revision 1.14
retrieving revision 1.15
diff -C2 -d -r1.14 -r1.15
*** Makefile	9 Sep 2007 02:37:04 -0000	1.14
--- Makefile	26 Oct 2007 18:36:05 -0000	1.15
***************
*** 13,19 ****
  
  DISTFILES = Makefile
! SUBDIRS = xxid parsestatements slon slonik slony_logshipper backend ducttape
  ifeq ($(PORTNAME),win32)
  SUBDIRS += slevent
  endif
  
--- 13,21 ----
  
  DISTFILES = Makefile
! SUBDIRS = xxid parsestatements slon slonik backend ducttape
  ifeq ($(PORTNAME),win32)
  SUBDIRS += slevent
+ else
+ SUBDIRS += slony_logshipper
  endif
  

From darcyb at lists.slony.info  Fri Oct 26 13:57:49 2007
From: darcyb at lists.slony.info (Darcy Buskermolen)
Date: Fri Oct 26 13:57:51 2007
Subject: [Slony1-commit] slony1-engine/src/slonik dbutil.c
Message-ID: <20071026205749.CDB63290BD7@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slonik
In directory main.slony.info:/tmp/cvs-serv31696

Modified Files:
      Tag: REL_1_2_STABLE
	dbutil.c 
Log Message:
Check to make sure we are a superuser and if not error indicationg which node we are not a 
superuser on.


Index: dbutil.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slonik/dbutil.c,v
retrieving revision 1.12.2.1
retrieving revision 1.12.2.2
diff -C2 -d -r1.12.2.1 -r1.12.2.2
*** dbutil.c	18 Apr 2007 19:28:27 -0000	1.12.2.1
--- dbutil.c	26 Oct 2007 20:57:47 -0000	1.12.2.2
***************
*** 139,146 ****
  #endif   /* !HAVE_PQSETNOTICERECEIVER */
  
  	dstring_init(&query);
  	slon_mkquery(&query,"SET datestyle to 'ISO'");
  
- 	adminfo->dbconn = dbconn;
  	if (db_exec_command(stmt, adminfo, &query) < 0)
  	{
--- 139,157 ----
  #endif   /* !HAVE_PQSETNOTICERECEIVER */
  
+ 	adminfo->dbconn = dbconn;
+ 
+ 	dstring_init(&query);
+ 	slon_mkquery(&query,"SELECT 1 FROM pg_catalog.pg_shadow WHERE usename = user "
+ 				"AND usesuper");
+ 	if (PQntuples(db_exec_select(stmt, adminfo, &query)) != 1)
+ 	{
+ 		printf("Error: You are not a superuser on node %d\n",adminfo->no_id);
+ 		dstring_free(&query);
+ 		return -1;
+ 	}
+ 		 
  	dstring_init(&query);
  	slon_mkquery(&query,"SET datestyle to 'ISO'");
  
  	if (db_exec_command(stmt, adminfo, &query) < 0)
  	{

From cbbrowne at lists.slony.info  Tue Oct 30 12:30:07 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Oct 30 12:30:08 2007
Subject: [Slony1-commit] slony1-engine RELEASE
Message-ID: <20071030193007.342C72901D4@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine
In directory main.slony.info:/tmp/cvs-serv26674

Modified Files:
      Tag: REL_1_2_STABLE
	RELEASE 
Log Message:
Note revisions made since "pre1" version was tagged


Index: RELEASE
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/RELEASE,v
retrieving revision 1.1.2.20
retrieving revision 1.1.2.21
diff -C2 -d -r1.1.2.20 -r1.1.2.21
*** RELEASE	26 Oct 2007 18:29:07 -0000	1.1.2.20
--- RELEASE	30 Oct 2007 19:30:05 -0000	1.1.2.21
***************
*** 49,52 ****
--- 49,58 ----
    problem with the -schema option - thanks, Bernd Helmle
  
+ - Don't bother building slony_logshipper on Win32 as it doesn't work
+   there at this point.
+ 
+ - If slonik connects as other than a superuser, then generate error
+   message indicating this to the user.
+ 
  RELEASE 1.2.11
  

From cbbrowne at lists.slony.info  Tue Oct 30 12:40:47 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Oct 30 12:40:49 2007
Subject: [Slony1-commit] slony1-www/content frontpage.txt news.txt
Message-ID: <20071030194047.406CC2901D8@main.slony.info>

Update of /home/cvsd/slony1/slony1-www/content
In directory main.slony.info:/tmp/cvs-serv27116/content

Modified Files:
	frontpage.txt news.txt 
Log Message:
Record 1.2.12 rc2


Index: frontpage.txt
===================================================================
RCS file: /home/cvsd/slony1/slony1-www/content/frontpage.txt,v
retrieving revision 1.22
retrieving revision 1.23
diff -C2 -d -r1.22 -r1.23
*** frontpage.txt	23 Oct 2007 20:55:52 -0000	1.22
--- frontpage.txt	30 Oct 2007 19:40:45 -0000	1.23
***************
*** 1,57 ****
  ---
! Slony-I 1.2.12 pre-1 available
  
  <P> Version 1.2.12 now has a <a
! href="http://slony.info/downloads/1.2/source/slony1-1.2.12-pre1.tar.bz2">
! release candidate.</a>
! 
! <ul>
! <li>Fixed problem with DDL SCRIPT parser where C-style comments were
!   not being processed properly
! 
! <li>Added stored functions and documentation for adding empty tables
!   (notably *partitions*) to replication.  Note these functions
!   do no work when not specifically requested.
! 
!   CAVEAT:  This functionality may not work as expected on versions
!   of PostgreSQL earlier than 8.1.  Mind you, partitioning tends
!   to function pretty poorly in earlier versions of PostgreSQL as
!   there were substantial enhancements in 8.1 and following versions.
! 
! <li>Added a fairly substantial partitioning test to exercise the
!   new stored functions above.
! 
! <li>Backport "listen path" generator function from CVS HEAD (2.0) to
!   1.2 branch.
! 
! <li>Fixed a problem with "EXECUTE SCRIPT" (introduced in remote_worker.c
!   version 1.124.2.13) where moving the relevant code into a subroutine
!   at the end led to losing the "BEGIN; SET TRANSACTION ISOLATION LEVEL
!   SERIALIZABLE;" query that needs to be the first thing run...
! 
! <li>Fixing the archive sequence generations (in log shipping).  All
!   non-SYNC events must start the local transaction before creating the
!   archive as well, so that the lock on the archive counter table
!   serializes archive creation.
! 
! <li>Fixed logging done in local_listener.c - various places, there was
!   no '\n' in some cases, which would lead to entries being folded
!   together.
! 
! <li>Fix launch_slons.sh - was not stripping quotes from PID file name
! 
! <li>Error handling for "ERROR: could not serialize access due to
!   concurrent update"
! 
!   <P> If this error is encountered when starting processing of
!   sl_archive_counter, then two threads are fighting over access to
!   this counter, and at least one has just failed.
! 
!   <P> Rather than waiting, we ask to restart the node immediately.
! </ul>
  
! The testing regimen included running all the tests in the test bed
! against instances of Slony-I running against PostgreSQL versions 7.4,
! 8.0, 8.1, 8.2, as well as CVS HEAD (forthcoming as 8.3).a
  ---
  Slony-I and PostgreSQL 8.1
--- 1,11 ----
  ---
! Slony-I 1.2.12 pre-2 available
  
  <P> Version 1.2.12 now has a <a
! href="http://slony.info/downloads/1.2/source/slony1-1.2.12-pre2.tar.bz2">
! second release candidate.</a>
  
! See the "news" area for more details, including a copy of the release
! notes.
  ---
  Slony-I and PostgreSQL 8.1

Index: news.txt
===================================================================
RCS file: /home/cvsd/slony1/slony1-www/content/news.txt,v
retrieving revision 1.35
retrieving revision 1.36
diff -C2 -d -r1.35 -r1.36
*** news.txt	23 Oct 2007 20:54:35 -0000	1.35
--- news.txt	30 Oct 2007 19:40:45 -0000	1.36
***************
*** 12,20 ****
  ---
  Slony-I 1.2.12 pre-1 available
! http://slony.info/downloads/1.2/source/slony1-1.2.12-pre1.tar.bz2
! 2007-10-23
  Christopher Browne
  
! <P> Version 1.2.12 now has a release candidate.
  <ul>
  <li>Fixed problem with DDL SCRIPT parser where C-style comments were
--- 12,20 ----
  ---
  Slony-I 1.2.12 pre-1 available
! http://slony.info/downloads/1.2/source/slony1-1.2.12-pre2.tar.bz2
! 2007-10-30
  Christopher Browne
  
! <P> Version 1.2.12 has a second release candidate.
  <ul>
  <li>Fixed problem with DDL SCRIPT parser where C-style comments were
***************
*** 60,63 ****
--- 60,73 ----
  
    <P> Rather than waiting, we ask to restart the node immediately.
+ 
+ <li> Fixes to slonik_build_env script - it wasn't properly handling
+   cases where there was just 1 table or 1 sequence, and had a
+   problem with the -schema option - thanks, Bernd Helmle
+ 
+ <li> Don't bother building slony_logshipper on Win32 as it doesn't work
+   there at this point.
+ 
+ <li> If slonik connects as other than a superuser, then generate error
+   message indicating this to the user.
  </ul>
  ---

