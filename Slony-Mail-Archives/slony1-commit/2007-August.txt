From cbbrowne at lists.slony.info  Fri Aug  3 09:09:13 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Fri Aug  3 09:09:15 2007
Subject: [Slony1-commit] slony1-engine RELEASE
Message-ID: <20070803160914.02728290C28@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine
In directory main.slony.info:/tmp/cvs-serv6501

Modified Files:
      Tag: REL_1_2_STABLE
	RELEASE 
Log Message:
Update release notes to indicate all changes since 1.2.10


Index: RELEASE
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/RELEASE,v
retrieving revision 1.1.2.9
retrieving revision 1.1.2.10
diff -C2 -d -r1.1.2.9 -r1.1.2.10
*** RELEASE	30 Jul 2007 22:33:15 -0000	1.1.2.9
--- RELEASE	3 Aug 2007 16:09:11 -0000	1.1.2.10
***************
*** 16,19 ****
--- 16,35 ----
    PostgreSQL 8.3
  
+ - Fixed problem with DDL SCRIPT statement parser: it wasn't 'quoting'
+   semicolons inside parentheses (this notably occurs in CREATE RULE).
+ 
+ - Fixed problem with DDL SCRIPT statement submission; it was
+   interpreting the statement as a format string, which would have
+   ill effects in the presence of things that are interpreted such
+   as format strings (%d, %f, %s) and \backslashed things like \\, \n.
+ 
+ - Further DDL Script issue: non-terminated statement at the end
+   (e.g. - without trailing semicolon ";") would get omitted.
+ 
+ - Typo fix: when trying to disable a node, the logs would report
+   "enableNode" rather than "disableNode".  Fixed.
+ 
+ - Add usage/version options to help output in slon.
+ 
  RELEASE 1.2.10
  

From cbbrowne at lists.slony.info  Fri Aug  3 09:16:10 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Fri Aug  3 09:16:11 2007
Subject: [Slony1-commit] slony1-engine config.h.in
Message-ID: <20070803161610.9FD14290C1C@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine
In directory main.slony.info:/tmp/cvs-serv6685

Modified Files:
      Tag: REL_1_2_STABLE
	config.h.in 
Log Message:
Update version numbers to 1.2.11


Index: config.h.in
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/config.h.in,v
retrieving revision 1.17.2.7
retrieving revision 1.17.2.8
diff -C2 -d -r1.17.2.7 -r1.17.2.8
*** config.h.in	6 Jun 2007 22:23:17 -0000	1.17.2.7
--- config.h.in	3 Aug 2007 16:16:08 -0000	1.17.2.8
***************
*** 13,18 ****
  #define SLONY_I_CONFIG_H
  
! #define SLONY_I_VERSION_STRING	"1.2.10"
! #define SLONY_I_VERSION_STRING_DEC 1,2,10
  
  #ifndef PG_VERSION_MAJOR
--- 13,18 ----
  #define SLONY_I_CONFIG_H
  
! #define SLONY_I_VERSION_STRING	"1.2.11"
! #define SLONY_I_VERSION_STRING_DEC 1,2,11
  
  #ifndef PG_VERSION_MAJOR

From cbbrowne at lists.slony.info  Fri Aug  3 09:16:10 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Fri Aug  3 09:16:12 2007
Subject: [Slony1-commit] slony1-engine/src/backend slony1_funcs.sql
Message-ID: <20070803161610.C5FAD290C1E@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/backend
In directory main.slony.info:/tmp/cvs-serv6685/src/backend

Modified Files:
      Tag: REL_1_2_STABLE
	slony1_funcs.sql 
Log Message:
Update version numbers to 1.2.11


Index: slony1_funcs.sql
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/backend/slony1_funcs.sql,v
retrieving revision 1.98.2.18
retrieving revision 1.98.2.19
diff -C2 -d -r1.98.2.18 -r1.98.2.19
*** slony1_funcs.sql	29 Jul 2007 17:27:33 -0000	1.98.2.18
--- slony1_funcs.sql	3 Aug 2007 16:16:08 -0000	1.98.2.19
***************
*** 431,435 ****
  as '
  begin
! 	return 10;
  end;
  ' language plpgsql;
--- 431,435 ----
  as '
  begin
! 	return 11;
  end;
  ' language plpgsql;

From cbbrowne at lists.slony.info  Fri Aug  3 09:24:45 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Fri Aug  3 09:24:46 2007
Subject: [Slony1-commit] slony1-www/content frontpage.txt news.txt
Message-ID: <20070803162445.6C588290C31@main.slony.info>

Update of /home/cvsd/slony1/slony1-www/content
In directory main.slony.info:/tmp/cvs-serv6950/content

Modified Files:
	frontpage.txt news.txt 
Log Message:
1.2.11 pre-release now available...


Index: frontpage.txt
===================================================================
RCS file: /home/cvsd/slony1/slony1-www/content/frontpage.txt,v
retrieving revision 1.16
retrieving revision 1.17
diff -C2 -d -r1.16 -r1.17
*** frontpage.txt	26 Jun 2007 18:39:41 -0000	1.16
--- frontpage.txt	3 Aug 2007 16:24:43 -0000	1.17
***************
*** 1,3 ****
--- 1,42 ----
  ---
+ Slony-I 1.2.11 pre-release available
+ http://slony.info/downloads/1.2/source/slony1-1.2.11-pre1.tar.bz2
+ 2007-08-03
+ Chris Browne
+ 
+ A tarball of Slony-I 1.2.11 is available for testing.
+ 
+ <P> Fixes are the following:
+ <ul>
+ <li> Add in tools/mkservice scripts previously added to CVS HEAD
+ 
+ <li> During subscription, do UPDATE to pg_class.relhasindex *after* the
+   TRUNCATE because, in 8.2+, TRUNCATE resets this attribute
+ 
+ <li> Fixed a problem with the setsync tracking with Log Shipping in cases
+   where slon does an internal restart (thereby rereading the
+   pset.ssy_seqno) and ignoring non-SYNC events because those don't
+   change the sl_setsync table.
+ 
+ <li> More explicit type casting of text objects for compatibility with
+   PostgreSQL 8.3
+ 
+ <li> Fixed problem with DDL SCRIPT statement parser: it wasn't 'quoting'
+   semicolons inside parentheses (this notably occurs in CREATE RULE).
+ 
+ <li> Fixed problem with DDL SCRIPT statement submission; it was
+   interpreting the statement as a format string, which would have
+   ill effects in the presence of things that are interpreted such
+   as format strings (%d, %f, %s) and \backslashed things like \\, \n.
+ 
+ <li> Further DDL Script issue: non-terminated statement at the end
+   (e.g. - without trailing semicolon ";") would get omitted.
+ 
+ <li> Typo fix: when trying to disable a node, the logs would report
+   "enableNode" rather than "disableNode".  Fixed.
+ 
+ <li> Add usage/version options to help output in slon.
+ </ul>
+ ---
  Slony-I 1.2.10 Released
  http://lists.slony.info/downloads/1.2/source/slony1-1.2.10.tar.bz2

Index: news.txt
===================================================================
RCS file: /home/cvsd/slony1/slony1-www/content/news.txt,v
retrieving revision 1.29
retrieving revision 1.30
diff -C2 -d -r1.29 -r1.30
*** news.txt	28 Jun 2007 19:49:24 -0000	1.29
--- news.txt	3 Aug 2007 16:24:43 -0000	1.30
***************
*** 11,14 ****
--- 11,53 ----
  <!-- Please keep this item at the top of the news list -->
  ---
+ Slony-I 1.2.11 pre-release available
+ http://slony.info/downloads/1.2/source/slony1-1.2.11-pre1.tar.bz2
+ 2007-08-03
+ Chris Browne
+ 
+ A tarball of Slony-I 1.2.11 is available for testing.
+ 
+ <P> Fixes are the following:
+ <ul>
+ <li> Add in tools/mkservice scripts previously added to CVS HEAD
+ 
+ <li> During subscription, do UPDATE to pg_class.relhasindex *after* the
+   TRUNCATE because, in 8.2+, TRUNCATE resets this attribute
+ 
+ <li> Fixed a problem with the setsync tracking with Log Shipping in cases
+   where slon does an internal restart (thereby rereading the
+   pset.ssy_seqno) and ignoring non-SYNC events because those don't
+   change the sl_setsync table.
+ 
+ <li> More explicit type casting of text objects for compatibility with
+   PostgreSQL 8.3
+ 
+ <li> Fixed problem with DDL SCRIPT statement parser: it wasn't 'quoting'
+   semicolons inside parentheses (this notably occurs in CREATE RULE).
+ 
+ <li> Fixed problem with DDL SCRIPT statement submission; it was
+   interpreting the statement as a format string, which would have
+   ill effects in the presence of things that are interpreted such
+   as format strings (%d, %f, %s) and \backslashed things like \\, \n.
+ 
+ <li> Further DDL Script issue: non-terminated statement at the end
+   (e.g. - without trailing semicolon ";") would get omitted.
+ 
+ <li> Typo fix: when trying to disable a node, the logs would report
+   "enableNode" rather than "disableNode".  Fixed.
+ 
+ <li> Add usage/version options to help output in slon.
+ </ul>
+ ---
  Generating RPMS for Slony-I
  http://slony.info/

From devrim at lists.slony.info  Sun Aug  5 23:48:06 2007
From: devrim at lists.slony.info (Devrim GUNDUZ)
Date: Sun Aug  5 23:48:08 2007
Subject: [Slony1-commit] slony1-engine/doc/adminguide slonik_ref.sgml
Message-ID: <20070806064806.6EC16290C25@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/doc/adminguide
In directory main.slony.info:/tmp/cvs-serv1350

Modified Files:
      Tag: REL_1_2_STABLE
	slonik_ref.sgml 
Log Message:
Fix SGML error


Index: slonik_ref.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/slonik_ref.sgml,v
retrieving revision 1.61.2.9
retrieving revision 1.61.2.10
diff -C2 -d -r1.61.2.9 -r1.61.2.10
*** slonik_ref.sgml	9 Jul 2007 19:07:01 -0000	1.61.2.9
--- slonik_ref.sgml	6 Aug 2007 06:48:04 -0000	1.61.2.10
***************
*** 2365,2369 ****
       instead of <command>FAILOVER</command>, if at all possible, as
       <command>FAILOVER</command> winds up discarding the old origin
!      node as being corrupted. Before <commadand>MOVE SET</command> will
       function a <command>LOCK SET</command> is needed.
  </para>
--- 2365,2369 ----
       instead of <command>FAILOVER</command>, if at all possible, as
       <command>FAILOVER</command> winds up discarding the old origin
!      node as being corrupted. Before <command>MOVE SET</command> will
       function a <command>LOCK SET</command> is needed.
  </para>

From devrim at lists.slony.info  Mon Aug  6 00:12:57 2007
From: devrim at lists.slony.info (Devrim GUNDUZ)
Date: Mon Aug  6 00:12:59 2007
Subject: [Slony1-commit] slony1-engine postgresql-slony1-engine.spec.in
Message-ID: <20070806071257.C5C58290472@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine
In directory main.slony.info:/tmp/cvs-serv1853

Modified Files:
      Tag: REL_1_2_STABLE
	postgresql-slony1-engine.spec.in 
Log Message:
- Fix Source0
- Spec file cleanup (removed macro for perltools)
- Added initscripts as BR.
- Fix doc package installation path (and ownership issue)



Index: postgresql-slony1-engine.spec.in
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/postgresql-slony1-engine.spec.in,v
retrieving revision 1.31.2.18
retrieving revision 1.31.2.19
diff -C2 -d -r1.31.2.18 -r1.31.2.19
*** postgresql-slony1-engine.spec.in	14 Jun 2007 15:02:20 -0000	1.31.2.18
--- postgresql-slony1-engine.spec.in	6 Aug 2007 07:12:55 -0000	1.31.2.19
***************
*** 1,20 ****
- %{!?perltools:%define perltools 1}
  %{!?docs:%define docs 1}
  %{?buildrhel3:%define kerbdir /usr/kerberos}
  %{!?kerbdir:%define kerbdir "/usr"}
  
- %define pg_version	%(rpm -qv postgresql-devel|head -n 1|awk -F '-' '{print $3}')
- 
  Summary:	A "master to multiple slaves" replication system with cascading and failover
  Name:		@PACKAGE_NAME@
  Version:	@PACKAGE_VERSION@
! Release:	1_PG%{pg_version}%{?dist}
  License:	BSD
  Group:		Applications/Databases
  URL:		http://main.slony.info/
! Source0:	http://main.slony.info/downloads/1.2/source/@PACKAGE_NAME@-%{version}.tar.gz
  BuildRoot:	%{_tmppath}/%{name}-%{version}-%{release}-root-%(%{__id_u} -n)
! BuildRequires:	postgresql-devel, postgresql-server, autoconf
! Requires:	postgresql-server = %{pg_version}
  
  %if %docs
--- 1,17 ----
  %{!?docs:%define docs 1}
  %{?buildrhel3:%define kerbdir /usr/kerberos}
  %{!?kerbdir:%define kerbdir "/usr"}
  
  Summary:	A "master to multiple slaves" replication system with cascading and failover
  Name:		@PACKAGE_NAME@
  Version:	@PACKAGE_VERSION@
! Release:	1%{?dist}
  License:	BSD
  Group:		Applications/Databases
  URL:		http://main.slony.info/
! Source0:	http://main.slony.info/downloads/1.2/source/@PACKAGE_NAME@-%{version}.tar.bz2
  BuildRoot:	%{_tmppath}/%{name}-%{version}-%{release}-root-%(%{__id_u} -n)
! BuildRequires:	postgresql-devel, postgresql-server, initscripts
! Requires:	postgresql-server 
  
  %if %docs
***************
*** 22,27 ****
  %endif
  
- %define prefix /usr
- 
  %description
  Slony-I is a "master to multiple slaves" replication 
--- 19,22 ----
***************
*** 54,60 ****
  %build
  
! # Temporary measure for 1.2.10-pre
  %if %docs
! chmod -R 644 doc/*
  %endif
  
--- 49,55 ----
  %build
  
! # Temporary measure for 1.2.10
  %if %docs
! find doc/ -type f -exec chmod 600 {} \;
  %endif
  
***************
*** 64,75 ****
  CFLAGS="${CFLAGS} -I%{_includedir}/et -I%{kerbdir}/include" ; export CFLAGS
  
- # Strip out -ffast-math from CFLAGS....
- 
- CFLAGS=`echo $CFLAGS|xargs -n 1|grep -v ffast-math|xargs -n 100`
  export LIBNAME=%{_lib}
  %configure --includedir %{_includedir}/pgsql --with-pgconfigdir=%{_bindir} --libdir=%{_libdir} \
- %if %perltools
  	--with-perltools=%{_bindir} --with-toolsbin=%{_bindir} \
- %endif
  %if %docs
  	--with-docs --with-docdir=%{_docdir}/%{name}-%{version} \
--- 59,65 ----
***************
*** 77,86 ****
  	--datadir %{_datadir}/pgsql --with-pglibdir=%{_libdir}/pgsql 
  
- autoconf
- 
  make %{?_smp_mflags}
! %if %perltools
! 	make %{?_smp_mflags} -C tools
! %endif
  
  %install
--- 67,72 ----
  	--datadir %{_datadir}/pgsql --with-pglibdir=%{_libdir}/pgsql 
  
  make %{?_smp_mflags}
! make %{?_smp_mflags} -C tools
  
  %install
***************
*** 96,107 ****
  install -m 0755 tools/*.sh  %{buildroot}%{_bindir}/
  install -m 0644 share/slon.conf-sample %{buildroot}%{_sysconfdir}/slon.conf
  
! if [ -d /etc/rc.d/init.d ]
! then
! 	install -d %{buildroot}/etc/rc.d/init.d
! 	install -m 755 redhat/@PACKAGE_NAME@.init %{buildroot}/etc/rc.d/init.d/@PACKAGE_NAME@
! fi
  
! # Temporary measure for 1.2.9
  %if %docs
  	rm -f doc/implementation/.cvsignore
--- 82,91 ----
  install -m 0755 tools/*.sh  %{buildroot}%{_bindir}/
  install -m 0644 share/slon.conf-sample %{buildroot}%{_sysconfdir}/slon.conf
+ /bin/chmod 644 COPYRIGHT UPGRADING SAMPLE HISTORY-1.1 RELEASE
  
! install -d %{buildroot}%{_initrddir}
! install -m 755 redhat/postgresql-slony1-engine.init %{buildroot}%{_initrddir}/postgresql-slony1-engine
  
! # Temporary measure for 1.2.10
  %if %docs
  	rm -f doc/implementation/.cvsignore
***************
*** 109,113 ****
  %endif
  
- %if %perltools
  cd tools
  make %{?_smp_mflags} DESTDIR=%{buildroot} install
--- 93,96 ----
***************
*** 122,126 ****
  /bin/rm -f %{buildroot}%{_bindir}/pgsql/slon-tools
  /bin/rm -f %{buildroot}%{_bindir}/old-apache-rotatelogs.patch
- %endif
  
  %clean
--- 105,108 ----
***************
*** 149,165 ****
  %{_datadir}/pgsql/*.sql
  %config(noreplace) %{_sysconfdir}/slon.conf
- %if %perltools
  %{_libdir}/pgsql/slon-tools.pm
  %config(noreplace) %{_sysconfdir}/slon_tools.conf
  %attr(755,root,root) %{_sysconfdir}/rc.d/init.d/@PACKAGE_NAME@
- %endif
  
  %if %docs
  %files docs
- %attr(755,root,root) %{_docdir}/%{name}-%{version}
  %attr(644,root,root) %doc doc/adminguide  doc/concept  doc/howto  doc/implementation  doc/support
  %endif
  
  %changelog
  * Wed Jun 13 2007 Devrim Gunduz <devrim@CommandPrompt.com> 1.2.10-1
  - Update to 1.2.10
--- 131,150 ----
  %{_datadir}/pgsql/*.sql
  %config(noreplace) %{_sysconfdir}/slon.conf
  %{_libdir}/pgsql/slon-tools.pm
  %config(noreplace) %{_sysconfdir}/slon_tools.conf
  %attr(755,root,root) %{_sysconfdir}/rc.d/init.d/@PACKAGE_NAME@
  
  %if %docs
  %files docs
  %attr(644,root,root) %doc doc/adminguide  doc/concept  doc/howto  doc/implementation  doc/support
  %endif
  
  %changelog
+ * Mon Aug 6 2007 Devrim Gunduz <devrim@CommandPrompt.com> 1.2.10-2
+ - Fix Source0
+ - Spec file cleanup (removed macro for perltools)
+ - Added initscripts as BR.
+ - Fix doc package installation path (and ownership issue)
+ 
  * Wed Jun 13 2007 Devrim Gunduz <devrim@CommandPrompt.com> 1.2.10-1
  - Update to 1.2.10

From cbbrowne at lists.slony.info  Wed Aug  8 08:23:32 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Wed Aug  8 08:23:34 2007
Subject: [Slony1-commit] slony1-engine/share slon.conf-sample
Message-ID: <20070808152332.3CD572902D3@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/share
In directory main.slony.info:/tmp/cvs-serv30242/share

Modified Files:
      Tag: REL_1_2_STABLE
	slon.conf-sample 
Log Message:
Per David Rees, made slon configuration documentation consistent with
defaults, and improved descriptions of sync_interval/sync_interval_timeout


Index: slon.conf-sample
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/share/slon.conf-sample,v
retrieving revision 1.6.2.1
retrieving revision 1.6.2.2
diff -C2 -d -r1.6.2.1 -r1.6.2.2
*** slon.conf-sample	12 Dec 2006 19:50:36 -0000	1.6.2.1
--- slon.conf-sample	8 Aug 2007 15:23:30 -0000	1.6.2.2
***************
*** 9,14 ****
  
  # Check for updates at least this often in milliseconds.
! # Range: [10-60000], default 100
! #sync_interval=100
  
  # Maximum amount of time in milliseconds before issuing a SYNC event, 
--- 9,14 ----
  
  # Check for updates at least this often in milliseconds.
! # Range: [10-60000], default 2000
! #sync_interval=2000
  
  # Maximum amount of time in milliseconds before issuing a SYNC event, 
***************
*** 22,27 ****
  # there will be no more sequence bumps, so the high frequent -s check 
  # won't detect that.  Thus, the need for sync_interval_timeout.
! # Range: [0-120000], default 1000
! #sync_interval_timeout=1000
  
  # Maximum number of SYNC events to group together when/if a subscriber
--- 22,27 ----
  # there will be no more sequence bumps, so the high frequent -s check 
  # won't detect that.  Thus, the need for sync_interval_timeout.
! # Range: [0-120000], default 10000
! #sync_interval_timeout=10000
  
  # Maximum number of SYNC events to group together when/if a subscriber

From cbbrowne at lists.slony.info  Wed Aug  8 08:23:32 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Wed Aug  8 08:23:34 2007
Subject: [Slony1-commit] slony1-engine/doc/adminguide slon.sgml
Message-ID: <20070808152332.3A26E29003F@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/doc/adminguide
In directory main.slony.info:/tmp/cvs-serv30242/doc/adminguide

Modified Files:
      Tag: REL_1_2_STABLE
	slon.sgml 
Log Message:
Per David Rees, made slon configuration documentation consistent with
defaults, and improved descriptions of sync_interval/sync_interval_timeout


Index: slon.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/slon.sgml,v
retrieving revision 1.29.2.1
retrieving revision 1.29.2.2
diff -C2 -d -r1.29.2.1 -r1.29.2.2
*** slon.sgml	16 Mar 2007 19:01:26 -0000	1.29.2.1
--- slon.sgml	8 Aug 2007 15:23:30 -0000	1.29.2.2
***************
*** 80,84 ****
        indicates how often <application>slon</application> should check
        to see if a <command>SYNC</command> should be introduced.
!       Default is 10000 ms.  The main loop in
        <function>sync_Thread_main()</function> sleeps for intervals of
        <envar>sync_interval</envar> milliseconds between iterations.
--- 80,84 ----
        indicates how often <application>slon</application> should check
        to see if a <command>SYNC</command> should be introduced.
!       Default is 2000 ms.  The main loop in
        <function>sync_Thread_main()</function> sleeps for intervals of
        <envar>sync_interval</envar> milliseconds between iterations.
***************
*** 112,123 ****
        At the end of each <envar>sync_interval_timeout</envar> timeout
        period, a <command>SYNC</command> will be generated on the
!       <quote>local</quote> node even if there has been no replicatable
!       data updated that would have pushed out a
!       <command>SYNC</command>.
       </para>
       <para>
!       Default, and maximum, is 60000 ms, so that you can expect each
!       node to <quote>report in</quote> with a <command>SYNC</command>
!       once each minute.
       </para>
       <para>
--- 112,157 ----
        At the end of each <envar>sync_interval_timeout</envar> timeout
        period, a <command>SYNC</command> will be generated on the
!       <quote>local</quote> node even if there has been no replicable
!       data updated that would have caused a
!       <command>SYNC</command> to be generated. </para>
! 
!      <para> If application activity ceases, whether because the
!      application is shut down, or because human users have gone home
!      and stopped introducing updates, the &lslon; will iterate away,
!      waking up every <envar>sync_interval</envar> milliseconds, and,
!      as no updates are being made, no <command>SYNC</command> events
!      would be generated.  Without this timeout parameter,
!      <emphasis>no</emphasis> <command>SYNC</command> events would be
!      generated, and it would appear that replication was falling
!      behind. </para>
! 
!      <para> The <envar>sync_interval_timeout</envar> value will lead
!      to eventually generating a <command>SYNC</command>, even though
!      there was no real replication work to be done.  The lower that
!      this parameter is set, the more frequently &lslon; will generate
!      <command>SYNC</command> events when the application is not
!      generating replicable activity; this will have two effects:</para>
!       <itemizedlist>
! 
!       <listitem><para> The system will do more replication work.</para> 
! 
!       <para> (Of course, since there is no application load on the
!       database, and no data to replicate, this load will be very easy
!       to handle.  </para></listitem>
! 
!       <listitem><para> Replication will appear to be kept more
!       <quote>up to date.</quote></para>
! 
!       <para> (Of course, since there is no replicable activity going
!       on, being <quote>more up to date</quote> is something of a
!       mirage.) </para></listitem>
! 
!       </itemizedlist>
! 
       </para>
       <para>
!       Default is 10000 ms and maximum is 120000 ms. By default, you
!       can expect each node to <quote>report in</quote> with a
!       <command>SYNC</command> every 10 seconds.
       </para>
       <para>

From cbbrowne at lists.slony.info  Wed Aug  8 08:24:25 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Wed Aug  8 08:24:25 2007
Subject: [Slony1-commit] slony1-engine/share slon.conf-sample
Message-ID: <20070808152425.0678D290037@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/share
In directory main.slony.info:/tmp/cvs-serv30304/share

Modified Files:
	slon.conf-sample 
Log Message:
Per David Rees, made slon configuration documentation consistent with
defaults, and improved descriptions of sync_interval/sync_interval_timeout


Index: slon.conf-sample
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/share/slon.conf-sample,v
retrieving revision 1.6
retrieving revision 1.7
diff -C2 -d -r1.6 -r1.7
*** slon.conf-sample	15 Aug 2006 15:55:36 -0000	1.6
--- slon.conf-sample	8 Aug 2007 15:24:22 -0000	1.7
***************
*** 9,14 ****
  
  # Check for updates at least this often in milliseconds.
! # Range: [10-60000], default 100
! #sync_interval=100
  
  # Maximum amount of time in milliseconds before issuing a SYNC event, 
--- 9,14 ----
  
  # Check for updates at least this often in milliseconds.
! # Range: [10-60000], default 2000
! #sync_interval=2000
  
  # Maximum amount of time in milliseconds before issuing a SYNC event, 
***************
*** 22,27 ****
  # there will be no more sequence bumps, so the high frequent -s check 
  # won't detect that.  Thus, the need for sync_interval_timeout.
! # Range: [0-120000], default 1000
! #sync_interval_timeout=1000
  
  # Maximum number of SYNC events to group together when/if a subscriber
--- 22,27 ----
  # there will be no more sequence bumps, so the high frequent -s check 
  # won't detect that.  Thus, the need for sync_interval_timeout.
! # Range: [0-120000], default 10000
! #sync_interval_timeout=10000
  
  # Maximum number of SYNC events to group together when/if a subscriber

From cbbrowne at lists.slony.info  Wed Aug  8 08:24:25 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Wed Aug  8 08:24:25 2007
Subject: [Slony1-commit] slony1-engine/doc/adminguide slon.sgml
Message-ID: <20070808152425.153EF2902D3@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/doc/adminguide
In directory main.slony.info:/tmp/cvs-serv30304/doc/adminguide

Modified Files:
	slon.sgml 
Log Message:
Per David Rees, made slon configuration documentation consistent with
defaults, and improved descriptions of sync_interval/sync_interval_timeout


Index: slon.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/slon.sgml,v
retrieving revision 1.31
retrieving revision 1.32
diff -C2 -d -r1.31 -r1.32
*** slon.sgml	27 Jun 2007 17:56:11 -0000	1.31
--- slon.sgml	8 Aug 2007 15:24:23 -0000	1.32
***************
*** 83,87 ****
        indicates how often <application>slon</application> should check
        to see if a <command>SYNC</command> should be introduced.
!       Default is 10000 ms.  The main loop in
        <function>sync_Thread_main()</function> sleeps for intervals of
        <envar>sync_interval</envar> milliseconds between iterations.
--- 83,87 ----
        indicates how often <application>slon</application> should check
        to see if a <command>SYNC</command> should be introduced.
!       Default is 2000 ms.  The main loop in
        <function>sync_Thread_main()</function> sleeps for intervals of
        <envar>sync_interval</envar> milliseconds between iterations.
***************
*** 115,126 ****
        At the end of each <envar>sync_interval_timeout</envar> timeout
        period, a <command>SYNC</command> will be generated on the
!       <quote>local</quote> node even if there has been no replicatable
!       data updated that would have pushed out a
!       <command>SYNC</command>.
       </para>
       <para>
!       Default, and maximum, is 60000 ms, so that you can expect each
!       node to <quote>report in</quote> with a <command>SYNC</command>
!       once each minute.
       </para>
       <para>
--- 115,160 ----
        At the end of each <envar>sync_interval_timeout</envar> timeout
        period, a <command>SYNC</command> will be generated on the
!       <quote>local</quote> node even if there has been no replicable
!       data updated that would have caused a
!       <command>SYNC</command> to be generated. </para>
! 
!      <para> If application activity ceases, whether because the
!      application is shut down, or because human users have gone home
!      and stopped introducing updates, the &lslon; will iterate away,
!      waking up every <envar>sync_interval</envar> milliseconds, and,
!      as no updates are being made, no <command>SYNC</command> events
!      would be generated.  Without this timeout parameter,
!      <emphasis>no</emphasis> <command>SYNC</command> events would be
!      generated, and it would appear that replication was falling
!      behind. </para>
! 
!      <para> The <envar>sync_interval_timeout</envar> value will lead
!      to eventually generating a <command>SYNC</command>, even though
!      there was no real replication work to be done.  The lower that
!      this parameter is set, the more frequently &lslon; will generate
!      <command>SYNC</command> events when the application is not
!      generating replicable activity; this will have two effects:</para>
!       <itemizedlist>
! 
!       <listitem><para> The system will do more replication work.</para> 
! 
!       <para> (Of course, since there is no application load on the
!       database, and no data to replicate, this load will be very easy
!       to handle.  </para></listitem>
! 
!       <listitem><para> Replication will appear to be kept more
!       <quote>up to date.</quote></para>
! 
!       <para> (Of course, since there is no replicable activity going
!       on, being <quote>more up to date</quote> is something of a
!       mirage.) </para></listitem>
! 
!       </itemizedlist>
! 
       </para>
       <para>
!       Default is 10000 ms and maximum is 120000 ms. By default, you
!       can expect each node to <quote>report in</quote> with a
!       <command>SYNC</command> every 10 seconds.
       </para>
       <para>

From wieck at lists.slony.info  Fri Aug 10 11:32:23 2007
From: wieck at lists.slony.info (Jan Wieck)
Date: Fri Aug 10 11:32:25 2007
Subject: [Slony1-commit] slony1-engine/src/slon remote_worker.c
Message-ID: <20070810183223.6E4CD290292@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slon
In directory main.slony.info:/tmp/cvs-serv23862/src/slon

Modified Files:
      Tag: REL_1_2_STABLE
	remote_worker.c 
Log Message:
Fix archive logging for replicated sequences.

Jan


Index: remote_worker.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/remote_worker.c,v
retrieving revision 1.124.2.18
retrieving revision 1.124.2.19
diff -C2 -d -r1.124.2.18 -r1.124.2.19
*** remote_worker.c	29 Jul 2007 17:29:18 -0000	1.124.2.18
--- remote_worker.c	10 Aug 2007 18:32:21 -0000	1.124.2.19
***************
*** 3741,3744 ****
--- 3741,3745 ----
  		return -1;
  	}
+ 	PQclear(res1);
  	if (archive_dir)
  	{
***************
*** 3751,3755 ****
  		{
  			slon_log(SLON_ERROR, "remoteWorkerThread_%d: "
! 					 " could not insert to sl_setsync_offline",
  					 node->no_id);
  			PQclear(res1);
--- 3752,3798 ----
  		{
  			slon_log(SLON_ERROR, "remoteWorkerThread_%d: "
! 					 " could not add data to archive",
! 					 node->no_id);
! 			slon_disconnectdb(pro_conn);
! 			dstring_free(&query1);
! 			dstring_free(&query2);
! 			dstring_free(&query3);
! 			dstring_free(&lsquery);
! 			dstring_free(&indexregenquery);
! 			archive_terminate(node);
! 			return -1;
! 		}
! 
! 		/*
! 		 * Refresh the sl_sequence_offline table
! 		 */
! 		slon_mkquery(&lsquery,
! 				"delete from %s.sl_sequence_offline;\n",
! 				rtcfg_namespace);
! 		rc = archive_append_ds(node, &lsquery);
! 		if (rc < 0)
! 		{
! 			slon_log(SLON_ERROR, "remoteWorkerThread_%d: "
! 					 " could not add data to archive",
! 					 node->no_id);
! 			slon_disconnectdb(pro_conn);
! 			dstring_free(&query1);
! 			dstring_free(&query2);
! 			dstring_free(&query3);
! 			dstring_free(&lsquery);
! 			dstring_free(&indexregenquery);
! 			archive_terminate(node);
! 			return -1;
! 		}
! 
! 		slon_mkquery(&query1,
! 				"select seq_id, seq_relname, seq_nspname "
! 				"from %s.sl_sequence; ",
! 				rtcfg_namespace);
! 		res1 = PQexec(pro_dbconn, dstring_data(&query1));
! 		if (PQresultStatus(res1) != PGRES_TUPLES_OK)
! 		{
! 			slon_log(SLON_ERROR, "remoteWorkerThread_%d: "
! 					 " could not select from sl_sequence",
  					 node->no_id);
  			PQclear(res1);
***************
*** 3763,3768 ****
  			return -1;
  		}
  	}
- 	PQclear(res1);
  	gettimeofday(&tv_now, NULL);
  	slon_log(SLON_DEBUG2, "remoteWorkerThread_%d: "
--- 3806,3841 ----
  			return -1;
  		}
+ 
+ 		ntuples1 = PQntuples(res1);
+ 		for (tupno1 = 0; tupno1 < ntuples1; tupno1++)
+ 		{
+ 			slon_mkquery(&lsquery,
+ 					"insert into %s.sl_sequence_offline "
+ 					"(seq_id, seq_relname, seq_nspname) "
+ 					"values ('%q', '%q', '%q'); ",
+ 					rtcfg_namespace,
+ 					PQgetvalue(res1, tupno1, 0),
+ 					PQgetvalue(res1, tupno1, 1),
+ 					PQgetvalue(res1, tupno1, 2));
+ 			
+ 			rc = archive_append_ds(node, &lsquery);
+ 			if (rc < 0)
+ 			{
+ 				slon_log(SLON_ERROR, "remoteWorkerThread_%d: "
+ 						 " could not add data to archive",
+ 						 node->no_id);
+ 				PQclear(res1);
+ 				slon_disconnectdb(pro_conn);
+ 				dstring_free(&query1);
+ 				dstring_free(&query2);
+ 				dstring_free(&query3);
+ 				dstring_free(&lsquery);
+ 				dstring_free(&indexregenquery);
+ 				archive_terminate(node);
+ 				return -1;
+ 			}
+ 		}
+ 		PQclear(res1);
  	}
  	gettimeofday(&tv_now, NULL);
  	slon_log(SLON_DEBUG2, "remoteWorkerThread_%d: "

From wieck at lists.slony.info  Mon Aug 20 10:02:30 2007
From: wieck at lists.slony.info (Jan Wieck)
Date: Mon Aug 20 10:02:32 2007
Subject: [Slony1-commit] slony1-engine/src/backend slony1_base.sql
	slony1_funcs.sql
Message-ID: <20070820170230.52C46290037@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/backend
In directory main.slony.info:/tmp/cvs-serv9726/src/backend

Modified Files:
      Tag: REL_1_2_STABLE
	slony1_base.sql slony1_funcs.sql 
Log Message:
I've had it now with the setsync tracking in offline archives.

The whole idea to track the setsync status is bogus to begin with, since
the real online replica doesn't update the sl_setsync table on every
event.

I added another table, sl_archive_counter where the log writing slon
simply tracks when it wrote the last offline archive file and maintains
a counter. This counter is now tracked in the offline replica and must
increment gap free.

Jan


Index: slony1_base.sql
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/backend/slony1_base.sql,v
retrieving revision 1.32
retrieving revision 1.32.2.1
diff -C2 -d -r1.32 -r1.32.2.1
*** slony1_base.sql	18 Jul 2006 17:59:59 -0000	1.32
--- slony1_base.sql	20 Aug 2007 17:02:28 -0000	1.32.2.1
***************
*** 575,578 ****
--- 575,593 ----
  
  -- ----------------------------------------------------------------------
+ -- TABLE sl_archive_counter
+ --
+ --	This table is used to generate the archive number for logshipping.
+ -- ----------------------------------------------------------------------
+ create table @NAMESPACE@.sl_archive_counter (
+ 	ac_num			bigint,
+ 	ac_timestamp	timestamp
+ ) without oids;
+ comment on table @NAMESPACE@.sl_archive_counter is 'Table used to generate the log shipping archive number.
+ ';
+ 
+ insert into @NAMESPACE@.sl_archive_counter (ac_num, ac_timestamp)
+ 	values (0, 'epoch'::timestamp);
+ 
+ -- ----------------------------------------------------------------------
  -- Last but not least grant USAGE to the replication schema objects.
  -- ----------------------------------------------------------------------

Index: slony1_funcs.sql
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/backend/slony1_funcs.sql,v
retrieving revision 1.98.2.19
retrieving revision 1.98.2.20
diff -C2 -d -r1.98.2.19 -r1.98.2.20
*** slony1_funcs.sql	3 Aug 2007 16:16:08 -0000	1.98.2.19
--- slony1_funcs.sql	20 Aug 2007 17:02:28 -0000	1.98.2.20
***************
*** 5851,5854 ****
--- 5851,5867 ----
  	end if;
  
+ 	-- ----
+ 	-- Changes for 1.2.11
+ 	-- ----
+ 	if p_old IN (''1.0.2'', ''1.0.5'', ''1.0.6'', ''1.1.0'', ''1.1.1'', ''1.1.2'', ''1.1.3'',''1.1.5'', ''1.1.6'', ''1.1.7'', ''1.1.8'', ''1.1.9'', ''1.2.0'', ''1.2.1'', ''1.2.2'', ''1.2.3'', ''1.2.4'', ''1.2.5'', ''1.2.6'', ''1.2.7'', ''1.2.8'', ''1.2.9'', ''1.2.10'') then
+ 		-- Add new table sl_archive_counter
+ 		execute ''create table @NAMESPACE@.sl_archive_counter (
+ 						ac_num			bigint,
+ 						ac_timestamp	timestamp
+ 					) without oids'';
+ 		execute ''insert into @NAMESPACE@.sl_archive_counter
+ 					(ac_num, ac_timestamp) values (0, ''''epoch''''::timestamp)'';
+ 	end if;
+ 
  	-- In any version, make sure that the xxidin() functions are defined STRICT
  	perform @NAMESPACE@.make_function_strict (''xxidin'', ''(cstring)'');

From wieck at lists.slony.info  Mon Aug 20 10:02:30 2007
From: wieck at lists.slony.info (Jan Wieck)
Date: Mon Aug 20 10:02:32 2007
Subject: [Slony1-commit] slony1-engine/tools slony1_dump.sh
Message-ID: <20070820170230.6DFF52903D6@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/tools
In directory main.slony.info:/tmp/cvs-serv9726/tools

Modified Files:
      Tag: REL_1_2_STABLE
	slony1_dump.sh 
Log Message:
I've had it now with the setsync tracking in offline archives.

The whole idea to track the setsync status is bogus to begin with, since
the real online replica doesn't update the sl_setsync table on every
event.

I added another table, sl_archive_counter where the log writing slon
simply tracks when it wrote the last offline archive file and maintains
a counter. This counter is now tracked in the offline replica and must
increment gap free.

Jan


Index: slony1_dump.sh
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tools/slony1_dump.sh,v
retrieving revision 1.8.2.2
retrieving revision 1.8.2.3
diff -C2 -d -r1.8.2.2 -r1.8.2.3
*** slony1_dump.sh	21 Jun 2007 20:29:13 -0000	1.8.2.2
--- slony1_dump.sh	20 Aug 2007 17:02:28 -0000	1.8.2.3
***************
*** 89,101 ****
  
  -- ----------------------------------------------------------------------
! -- TABLE sl_setsync_offline
  -- ----------------------------------------------------------------------
! create table $clname.sl_setsync_offline (
! 	ssy_setid			int4,
! 	ssy_seqno			int8,
! 	ssy_synctime                    timestamptz,
! 
! 	CONSTRAINT "sl_setsync-pkey"
! 		PRIMARY KEY (ssy_setid)
  );
  
--- 89,98 ----
  
  -- ----------------------------------------------------------------------
! -- TABLE sl_archive_tracking
  -- ----------------------------------------------------------------------
! create table $clname.sl_archive_tracking (
! 	at_counter			bigint,
! 	at_created			timestamp,
! 	at_applied			timestamp
  );
  
***************
*** 139,167 ****
  
  -- ---------------------------------------------------------------------------------------
! -- FUNCTION setsyncTracking_offline (seq_id, seq_origin, ev_seqno, sync_time)
  -- ---------------------------------------------------------------------------------------
! create or replace function $clname.setsyncTracking_offline(int4, int8, int8, timestamptz) returns int8
  as '
  declare
! 	p_set_id	alias for \$1;
! 	p_old_seq	alias for \$2;
! 	p_new_seq	alias for \$3;
! 	p_sync_time	alias for \$4;
! 	v_row		record;
  begin
! 	select ssy_seqno into v_row from $clname.sl_setsync_offline
! 		where ssy_setid = p_set_id for update;
  	if not found then
! 		raise exception ''Slony-I: set % not found'', p_set_id;
  	end if;
  
! 	if v_row.ssy_seqno <> p_old_seq then
! 		raise exception ''Slony-I: set % is on sync %, this archive log expects %'', 
! 			p_set_id, v_row.ssy_seqno, p_old_seq;
  	end if;
! 	raise notice ''Slony-I: Process set % sync % time %'', p_set_id, p_new_seq, p_sync_time;
  
! 	update $clname.sl_setsync_offline set ssy_seqno = p_new_seq, ssy_synctime = p_sync_time
! 		where ssy_setid = p_set_id;
  	return p_new_seq;
  end;
--- 136,165 ----
  
  -- ---------------------------------------------------------------------------------------
! -- FUNCTION archiveTracking_offline (new_counter, created_timestamp)
  -- ---------------------------------------------------------------------------------------
! create or replace function $clname.archiveTracking_offline(int8, timestamp) returns int8
  as '
  declare
! 	p_new_seq	alias for \$1;
! 	p_created	alias for \$2;
! 	v_exp_seq	int8;
! 	v_old_seq	int8;
  begin
! 	select at_counter into v_old_seq from $clname.sl_archive_tracking;
  	if not found then
! 		raise exception ''Slony-I: current archive tracking status not found'';
  	end if;
  
! 	v_exp_seq := p_new_seq - 1;
! 	if v_old_seq <> v_exp_seq then
! 		raise exception ''Slony-I: node is on archive counter %, this archive log expects %'', 
! 			v_old_seq, v_exp_seq;
  	end if;
! 	raise notice ''Slony-I: Process archive with counter % created %'', p_new_seq, p_created;
  
! 	update $clname.sl_archive_tracking
! 		set at_counter = p_new_seq,
! 			at_created = p_created,
! 			at_applied = CURRENT_TIMESTAMP;
  	return p_new_seq;
  end;
***************
*** 198,207 ****
  # Fill the setsync tracking table with the current status
  # ----
! echo "select 'insert into $clname.sl_setsync_offline values (' ||
! 			ssy_setid::text || ', ''' || ssy_seqno || ''');'
! 			from $clname.sl_setsync where exists (select 1
! 						from $clname.sl_subscribe
! 						where ssy_setid = sub_set
! 							and sub_receiver = $nodeid);"
  
  # ----
--- 196,203 ----
  # Fill the setsync tracking table with the current status
  # ----
! echo "select 'insert into $clname.sl_archive_tracking values (' ||
! 			ac_num::text || ', ''' || ac_timestamp::text || 
! 			''', CURRENT_TIMESTAMP);'
! 			from $clname.sl_archive_counter";
  
  # ----

From wieck at lists.slony.info  Mon Aug 20 10:02:30 2007
From: wieck at lists.slony.info (Jan Wieck)
Date: Mon Aug 20 10:02:33 2007
Subject: [Slony1-commit] slony1-engine/src/slon remote_worker.c
Message-ID: <20070820170230.8AEC12903DB@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slon
In directory main.slony.info:/tmp/cvs-serv9726/src/slon

Modified Files:
      Tag: REL_1_2_STABLE
	remote_worker.c 
Log Message:
I've had it now with the setsync tracking in offline archives.

The whole idea to track the setsync status is bogus to begin with, since
the real online replica doesn't update the sl_setsync table on every
event.

I added another table, sl_archive_counter where the log writing slon
simply tracks when it wrote the last offline archive file and maintains
a counter. This counter is now tracked in the offline replica and must
increment gap free.

Jan


Index: remote_worker.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/remote_worker.c,v
retrieving revision 1.124.2.19
retrieving revision 1.124.2.20
diff -C2 -d -r1.124.2.19 -r1.124.2.20
*** remote_worker.c	10 Aug 2007 18:32:21 -0000	1.124.2.19
--- remote_worker.c	20 Aug 2007 17:02:28 -0000	1.124.2.20
***************
*** 263,268 ****
  static int	archive_append_data(SlonNode *node, const char *s, int len);
  static int archive_tracking(SlonNode *node, const char *namespace, 
! 					int sub_set, const char *firstseq,
! 					const char *seqbuf, const char *timestamp);
  
  
--- 263,267 ----
  static int	archive_append_data(SlonNode *node, const char *s, int len);
  static int archive_tracking(SlonNode *node, const char *namespace, 
! 					PGconn *local_dbconn);
  
  
***************
*** 692,706 ****
  					slon_retry();
  
! 				for (pinfo=wd->provider_head; pinfo != NULL; pinfo = pinfo->next)
! 				{
! 					for(pset = pinfo->set_head; pset != NULL; pset = pset->next)
! 					{
! 						if (archive_tracking(node, rtcfg_namespace, 
! 								pset->set_id, pset->ssy_seqno, seqbuf, 
! 								event->ev_timestamp_c) < 0)
! 							slon_retry();
! 						strcpy(pset->ssy_seqno, seqbuf);
! 					}
! 				}
  
  				/*
--- 691,697 ----
  					slon_retry();
  
! 				if (archive_tracking(node, rtcfg_namespace, 
! 						local_dbconn) < 0)
! 					slon_retry();
  
  				/*
***************
*** 876,892 ****
  								 "select %s.dropSet_int(%d); ",
  								 rtcfg_namespace, set_id);
- 
- 				/*
- 				 * The table deleted needs to be dropped from log shipping too
- 				 */
- 				if (archive_dir)
- 				{
- 					slon_mkquery(&lsquery,
- 								 "delete from %s.sl_setsync_offline "
- 								 "  where ssy_setid= %d;",
- 								 rtcfg_namespace, set_id);
- 					if (archive_append_ds(node, &lsquery) < 0)
- 						slon_retry();
- 				}
  			}
  			else if (strcmp(event->ev_type, "MERGE_SET") == 0)
--- 867,870 ----
***************
*** 902,918 ****
  								 set_id, add_id);
  
- 				/*
- 				 * Log shipping gets the change here that we need to delete
- 				 * the table being merged from the set being maintained.
- 				 */
- 				if (archive_dir)
- 				{
- 					slon_mkquery(&lsquery,
- 							  "delete from %s.sl_setsync_offline "
- 							  "  where ssy_setid= %d;",
- 							  rtcfg_namespace, add_id);
- 					if (archive_append_ds(node, &lsquery) < 0)
- 						slon_retry();
- 				}
  			}
  			else if (strcmp(event->ev_type, "SET_ADD_TABLE") == 0)
--- 880,883 ----
***************
*** 1302,1314 ****
  
  				need_reloadListen = true;
- 				if (archive_dir)
- 				{
- 					slon_mkquery(&lsquery,
- 								 "delete from %s.sl_setsync_offline "
- 								 "  where ssy_setid= %d;",
- 								 rtcfg_namespace, sub_set);
- 					if (archive_append_ds(node, &lsquery) < 0)
- 						slon_retry();
- 				}
  			}
  			else if (strcmp(event->ev_type, "DDL_SCRIPT") == 0)
--- 1267,1270 ----
***************
*** 3744,3767 ****
  	if (archive_dir)
  	{
- 		slon_mkquery(&lsquery,
- 			     "insert into %s.sl_setsync_offline (ssy_setid, ssy_seqno) "
- 			     "values ('%d', '%s');",
- 			     rtcfg_namespace, set_id, ssy_seqno);
- 		rc = archive_append_ds(node, &lsquery);
- 		if (rc < 0)
- 		{
- 			slon_log(SLON_ERROR, "remoteWorkerThread_%d: "
- 					 " could not add data to archive",
- 					 node->no_id);
- 			slon_disconnectdb(pro_conn);
- 			dstring_free(&query1);
- 			dstring_free(&query2);
- 			dstring_free(&query3);
- 			dstring_free(&lsquery);
- 			dstring_free(&indexregenquery);
- 			archive_terminate(node);
- 			return -1;
- 		}
- 
  		/*
  		 * Refresh the sl_sequence_offline table
--- 3700,3703 ----
***************
*** 4282,4318 ****
  
  			PQclear(res2);
- 
- 			/*
- 			 * Add a call to the setsync tracking function to the archive log.
- 			 * This function ensures that all archive log files are applied in
- 			 * the right order.
- 			 */
- 			if (archive_dir)
- 			{
- 				for (pset = provider->set_head; pset; pset = pset->next)
- 					if (pset->set_id == sub_set) break;
- 				if (pset == NULL)
- 				{
- 					slon_log(SLON_ERROR, "remoteWorkerThread_%d: "
- 							"set %d not found in runtime config\n",
- 							node->no_id, sub_set);
- 					slon_retry();
- 				}
- 
- 				slon_log(SLON_DEBUG2, "writing archive log...\n");
- 				fflush(stderr);
- 				fflush(stdout);
- 				rc = archive_tracking(node, rtcfg_namespace, sub_set,
- 										 pset->ssy_seqno, seqbuf,
- 										 event->ev_timestamp_c);
- 				if (rc < 0)
- 					slon_retry();
- 
- 				strcpy(pset->ssy_seqno, seqbuf);
- 			}
  		}
  		PQclear(res1);
  
  		/*
  		 * We didn't add anything good in the provider clause. That shouldn't
  		 * be!
--- 4218,4237 ----
  
  			PQclear(res2);
  		}
  		PQclear(res1);
  
  		/*
+ 		 * Add a call to the archive tracking function to the archive log.
+ 		 * This function ensures that all archive log files are applied in
+ 		 * the right order.
+ 		 */
+ 		if (archive_dir)
+ 		{
+ 			rc = archive_tracking(node, rtcfg_namespace, local_dbconn);
+ 			if (rc < 0)
+ 				slon_retry();
+ 		}
+ 
+ 		/*
  		 * We didn't add anything good in the provider clause. That shouldn't
  		 * be!
***************
*** 5592,5596 ****
  		"------------------------------------------------------------------\n"
  		"commit;\n"
! 		"vacuum analyze %s.sl_setsync_offline;\n",
  		rtcfg_namespace);
  	if (rc < 0)
--- 5511,5515 ----
  		"------------------------------------------------------------------\n"
  		"commit;\n"
! 		"vacuum analyze %s.sl_archive_tracking;\n",
  		rtcfg_namespace);
  	if (rc < 0)
***************
*** 5645,5657 ****
   */
  static int
! archive_tracking(SlonNode *node, const char *namespace, int sub_set, 
! 					const char *firstseq, const char *seqbuf, 
! 					const char *timestamp)
  {
! 	int		rc;
  
  	if (!archive_dir)
  		return 0;
  
  	if (node->archive_fp == NULL)
  	{
--- 5564,5606 ----
   */
  static int
! archive_tracking(SlonNode *node, const char *namespace, 
! 					PGconn *local_dbconn)
  {
! 	SlonDString query;
! 	PGresult	*res;
! 	int			rc;
  
  	if (!archive_dir)
  		return 0;
  
+ 	dstring_init(&query);
+ 	slon_mkquery(&query,
+ 			"update %s.sl_archive_counter "
+ 			"    set ac_num = ac_num + 1, "
+ 			"        ac_timestamp = CURRENT_TIMESTAMP; "
+ 			"select ac_num, ac_timestamp from %s.sl_archive_counter; ",
+ 			namespace, namespace);
+ 	res = PQexec(local_dbconn, dstring_data(&query));
+ 	if ((rc = PQresultStatus(res)) != PGRES_TUPLES_OK)
+ 	{
+ 		slon_log(SLON_ERROR,
+ 				 "remoteWorkerThread_%d: \"%s\" %s %s\n",
+ 				 node->no_id, dstring_data(&query),
+ 				 PQresStatus(rc),
+ 				 PQresultErrorMessage(res));
+ 		PQclear(res);
+ 		dstring_free(&query);
+ 		return -1;
+ 	}
+ 	if ((rc = PQntuples(res)) != 1)
+ 	{
+ 		slon_log(SLON_ERROR,
+ 				 "remoteWorkerThread_%d: expected 1 row in sl_archive_counter - found %d",
+ 				 node->no_id, rc);
+ 		PQclear(res);
+ 		dstring_free(&query);
+ 		return -1;
+ 	}
+ 
  	if (node->archive_fp == NULL)
  	{
***************
*** 5659,5672 ****
  				"Cannot write to archive file %s - not open\n",
  				node->no_id, node->archive_temp);
  		return -1;
  	}
  
  	rc = fprintf(node->archive_fp, 
! 		"\nselect %s.setsyncTracking_offline(%d, '%s', '%s', '%s');\n"
  		"-- end of log archiving header\n"
  		"------------------------------------------------------------------\n"
  		"-- start of Slony-I data\n"
  		"------------------------------------------------------------------\n",
! 		namespace, sub_set, firstseq, seqbuf, timestamp);
  	if (rc < 0)
  	{
--- 5608,5625 ----
  				"Cannot write to archive file %s - not open\n",
  				node->no_id, node->archive_temp);
+ 		PQclear(res);
+ 		dstring_free(&query);
  		return -1;
  	}
  
  	rc = fprintf(node->archive_fp, 
! 		"\nselect %s.archiveTracking_offline('%s', '%s');\n"
  		"-- end of log archiving header\n"
  		"------------------------------------------------------------------\n"
  		"-- start of Slony-I data\n"
  		"------------------------------------------------------------------\n",
! 		namespace, PQgetvalue(res, 0, 0), PQgetvalue(res, 0, 1));
! 	PQclear(res);
! 	dstring_free(&query);
  	if (rc < 0)
  	{

From wieck at lists.slony.info  Mon Aug 20 11:22:28 2007
From: wieck at lists.slony.info (Jan Wieck)
Date: Mon Aug 20 11:22:30 2007
Subject: [Slony1-commit] slony1-engine/tools slony1_dump.sh
Message-ID: <20070820182228.36BE92903DB@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/tools
In directory main.slony.info:/tmp/cvs-serv10238/tools

Modified Files:
	slony1_dump.sh 
Log Message:
Forward patching the new archive tracking into HEAD


Jan


Index: slony1_dump.sh
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tools/slony1_dump.sh,v
retrieving revision 1.9
retrieving revision 1.10
diff -C2 -d -r1.9 -r1.10
*** slony1_dump.sh	22 Jun 2007 16:11:08 -0000	1.9
--- slony1_dump.sh	20 Aug 2007 18:22:26 -0000	1.10
***************
*** 89,101 ****
  
  -- ----------------------------------------------------------------------
! -- TABLE sl_setsync_offline
  -- ----------------------------------------------------------------------
! create table $clname.sl_setsync_offline (
! 	ssy_setid			int4,
! 	ssy_seqno			int8,
! 	ssy_synctime                    timestamptz,
! 
! 	CONSTRAINT "sl_setsync-pkey"
! 		PRIMARY KEY (ssy_setid)
  );
  
--- 89,98 ----
  
  -- ----------------------------------------------------------------------
! -- TABLE sl_archive_tracking
  -- ----------------------------------------------------------------------
! create table $clname.sl_archive_tracking (
! 	at_counter			bigint,
! 	at_created			timestamp,
! 	at_applied			timestamp
  );
  
***************
*** 139,167 ****
  
  -- ---------------------------------------------------------------------------------------
! -- FUNCTION setsyncTracking_offline (seq_id, seq_origin, ev_seqno, sync_time)
  -- ---------------------------------------------------------------------------------------
! create or replace function $clname.setsyncTracking_offline(int4, int8, int8, timestamptz) returns int8
  as '
  declare
! 	p_set_id	alias for \$1;
! 	p_old_seq	alias for \$2;
! 	p_new_seq	alias for \$3;
! 	p_sync_time	alias for \$4;
! 	v_row		record;
  begin
! 	select ssy_seqno into v_row from $clname.sl_setsync_offline
! 		where ssy_setid = p_set_id for update;
  	if not found then
! 		raise exception ''Slony-I: set % not found'', p_set_id;
  	end if;
  
! 	if v_row.ssy_seqno <> p_old_seq then
! 		raise exception ''Slony-I: set % is on sync %, this archive log expects %'', 
! 			p_set_id, v_row.ssy_seqno, p_old_seq;
  	end if;
! 	raise notice ''Slony-I: Process set % sync % time %'', p_set_id, p_new_seq, p_sync_time;
  
! 	update $clname.sl_setsync_offline set ssy_seqno = p_new_seq, ssy_synctime = p_sync_time
! 		where ssy_setid = p_set_id;
  	return p_new_seq;
  end;
--- 136,165 ----
  
  -- ---------------------------------------------------------------------------------------
! -- FUNCTION archiveTracking_offline (new_counter, created_timestamp)
  -- ---------------------------------------------------------------------------------------
! create or replace function $clname.archiveTracking_offline(int8, timestamp) returns int8
  as '
  declare
! 	p_new_seq	alias for \$1;
! 	p_created	alias for \$2;
! 	v_exp_seq	int8;
! 	v_old_seq	int8;
  begin
! 	select at_counter into v_old_seq from $clname.sl_archive_tracking;
  	if not found then
! 		raise exception ''Slony-I: current archive tracking status not found'';
  	end if;
  
! 	v_exp_seq := p_new_seq - 1;
! 	if v_old_seq <> v_exp_seq then
! 		raise exception ''Slony-I: node is on archive counter %, this archive log expects %'', 
! 			v_old_seq, v_exp_seq;
  	end if;
! 	raise notice ''Slony-I: Process archive with counter % created %'', p_new_seq, p_created;
  
! 	update $clname.sl_archive_tracking
! 		set at_counter = p_new_seq,
! 			at_created = p_created,
! 			at_applied = CURRENT_TIMESTAMP;
  	return p_new_seq;
  end;
***************
*** 198,207 ****
  # Fill the setsync tracking table with the current status
  # ----
! echo "select 'insert into $clname.sl_setsync_offline values (' ||
! 			ssy_setid::text || ', ''' || ssy_seqno || ''');'
! 			from $clname.sl_setsync where exists (select 1
! 						from $clname.sl_subscribe
! 						where ssy_setid = sub_set
! 							and sub_receiver = $nodeid);"
  
  # ----
--- 196,203 ----
  # Fill the setsync tracking table with the current status
  # ----
! echo "select 'insert into $clname.sl_archive_tracking values (' ||
! 			ac_num::text || ', ''' || ac_timestamp::text || 
! 			''', CURRENT_TIMESTAMP);'
! 			from $clname.sl_archive_counter";
  
  # ----

From wieck at lists.slony.info  Mon Aug 20 11:22:28 2007
From: wieck at lists.slony.info (Jan Wieck)
Date: Mon Aug 20 11:22:30 2007
Subject: [Slony1-commit] slony1-engine/src/slon remote_worker.c
Message-ID: <20070820182228.41634290420@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slon
In directory main.slony.info:/tmp/cvs-serv10238/src/slon

Modified Files:
	remote_worker.c 
Log Message:
Forward patching the new archive tracking into HEAD


Jan


Index: remote_worker.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/remote_worker.c,v
retrieving revision 1.150
retrieving revision 1.151
diff -C2 -d -r1.150 -r1.151
*** remote_worker.c	29 Jul 2007 17:38:23 -0000	1.150
--- remote_worker.c	20 Aug 2007 18:22:26 -0000	1.151
***************
*** 260,265 ****
  static int	archive_append_data(SlonNode *node, const char *s, int len);
  static int archive_tracking(SlonNode *node, const char *namespace, 
! 					int sub_set, const char *firstseq,
! 					const char *seqbuf, const char *timestamp);
  
  
--- 260,264 ----
  static int	archive_append_data(SlonNode *node, const char *s, int len);
  static int archive_tracking(SlonNode *node, const char *namespace, 
! 					PGconn *local_dbconn);
  
  
***************
*** 691,705 ****
  					slon_retry();
  
! 				for (pinfo=wd->provider_head; pinfo != NULL; pinfo = pinfo->next)
! 				{
! 					for(pset = pinfo->set_head; pset != NULL; pset = pset->next)
! 					{
! 						if (archive_tracking(node, rtcfg_namespace, 
! 								pset->set_id, pset->ssy_seqno, seqbuf, 
! 								event->ev_timestamp_c) < 0)
! 							slon_retry();
! 						strcpy(pset->ssy_seqno, seqbuf);
! 					}
! 				}
  
  				/*
--- 690,696 ----
  					slon_retry();
  
! 				if (archive_tracking(node, rtcfg_namespace, 
! 						local_dbconn) < 0)
! 					slon_retry();
  
  				/*
***************
*** 875,891 ****
  								 "select %s.dropSet_int(%d); ",
  								 rtcfg_namespace, set_id);
- 
- 				/*
- 				 * The table deleted needs to be dropped from log shipping too
- 				 */
- 				if (archive_dir)
- 				{
- 					slon_mkquery(&lsquery,
- 								 "delete from %s.sl_setsync_offline "
- 								 "  where ssy_setid= %d;",
- 								 rtcfg_namespace, set_id);
- 					if (archive_append_ds(node, &lsquery) < 0)
- 						slon_retry();
- 				}
  			}
  			else if (strcmp(event->ev_type, "MERGE_SET") == 0)
--- 866,869 ----
***************
*** 901,917 ****
  								 set_id, add_id);
  
- 				/*
- 				 * Log shipping gets the change here that we need to delete
- 				 * the table being merged from the set being maintained.
- 				 */
- 				if (archive_dir)
- 				{
- 					slon_mkquery(&lsquery,
- 							  "delete from %s.sl_setsync_offline "
- 							  "  where ssy_setid= %d;",
- 							  rtcfg_namespace, add_id);
- 					if (archive_append_ds(node, &lsquery) < 0)
- 						slon_retry();
- 				}
  			}
  			else if (strcmp(event->ev_type, "SET_ADD_TABLE") == 0)
--- 879,882 ----
***************
*** 1281,1293 ****
  
  				need_reloadListen = true;
- 				if (archive_dir)
- 				{
- 					(void) slon_mkquery(&lsquery,
- 								 "delete from %s.sl_setsync_offline "
- 								 "  where ssy_setid= %d;",
- 								 rtcfg_namespace, sub_set);
- 					if (archive_append_ds(node, &lsquery) < 0)
- 						slon_retry();
- 				}
  			}
  			else if (strcmp(event->ev_type, "DDL_SCRIPT") == 0)
--- 1246,1249 ----
***************
*** 3424,3450 ****
  		return -1;
  	}
- 	if (archive_dir)
- 	{
- 		(void) slon_mkquery(&lsquery,
- 			     "insert into %s.sl_setsync_offline (ssy_setid, ssy_seqno) "
- 			     "values ('%d', '%s');",
- 			     rtcfg_namespace, set_id, ssy_seqno);
- 		rc = archive_append_ds(node, &lsquery);
- 		if (rc < 0)
- 		{
- 			slon_log(SLON_ERROR, "remoteWorkerThread_%d: "
- 					 " could not insert to sl_setsync_offline",
- 					 node->no_id);
- 			PQclear(res1);
- 			slon_disconnectdb(pro_conn);
- 			dstring_free(&query1);
- 			dstring_free(&query2);
- 			dstring_free(&query3);
- 			dstring_free(&lsquery);
- 			dstring_free(&indexregenquery);
- 			archive_terminate(node);
- 			return -1;
- 		}
- 	}
  	PQclear(res1);
  	gettimeofday(&tv_now, NULL);
--- 3380,3383 ----
***************
*** 3896,3932 ****
  
  			PQclear(res2);
- 
- 			/*
- 			 * Add a call to the setsync tracking function to the archive log.
- 			 * This function ensures that all archive log files are applied in
- 			 * the right order.
- 			 */
- 			if (archive_dir)
- 			{
- 				for (pset = provider->set_head; pset; pset = pset->next)
- 					if (pset->set_id == sub_set) break;
- 				if (pset == NULL)
- 				{
- 					slon_log(SLON_ERROR, "remoteWorkerThread_%d: "
- 							"set %d not found in runtime config\n",
- 							node->no_id, sub_set);
- 					slon_retry();
- 				}
- 
- 				slon_log(SLON_DEBUG2, "writing archive log...\n");
- 				fflush(stderr);
- 				fflush(stdout);
- 				rc = archive_tracking(node, rtcfg_namespace, sub_set,
- 										 pset->ssy_seqno, seqbuf,
- 										 event->ev_timestamp_c);
- 				if (rc < 0)
- 					slon_retry();
- 
- 				strcpy(pset->ssy_seqno, seqbuf);
- 			}
  		}
  		PQclear(res1);
  
  		/*
  		 * We didn't add anything good in the provider clause. That shouldn't
  		 * be!
--- 3829,3848 ----
  
  			PQclear(res2);
  		}
  		PQclear(res1);
  
  		/*
+ 		 * Add a call to the archive tracking function to the archive log.
+ 		 * This function ensures that all archive log files are applied in
+ 		 * the right order.
+ 		 */
+ 		if (archive_dir)
+ 		{
+ 			rc = archive_tracking(node, rtcfg_namespace, local_dbconn);
+ 			if (rc < 0)
+ 				slon_retry();
+ 		}
+ 
+ 		/*
  		 * We didn't add anything good in the provider clause. That shouldn't
  		 * be!
***************
*** 5167,5171 ****
  		"------------------------------------------------------------------\n"
  		"commit;\n"
! 		"vacuum analyze %s.sl_setsync_offline;\n",
  		rtcfg_namespace);
  	if (rc < 0)
--- 5083,5087 ----
  		"------------------------------------------------------------------\n"
  		"commit;\n"
! 		"vacuum analyze %s.sl_archive_tracking;\n",
  		rtcfg_namespace);
  	if (rc < 0)
***************
*** 5220,5232 ****
   */
  static int
! archive_tracking(SlonNode *node, const char *namespace, int sub_set, 
! 					const char *firstseq, const char *seqbuf, 
! 					const char *timestamp)
  {
! 	int		rc;
  
  	if (!archive_dir)
  		return 0;
  
  	if (node->archive_fp == NULL)
  	{
--- 5136,5178 ----
   */
  static int
! archive_tracking(SlonNode *node, const char *namespace, 
! 					PGconn *local_dbconn)
  {
! 	SlonDString query;
! 	PGresult	*res;
! 	int			rc;
  
  	if (!archive_dir)
  		return 0;
  
+ 	dstring_init(&query);
+ 	slon_mkquery(&query,
+ 			"update %s.sl_archive_counter "
+ 			"    set ac_num = ac_num + 1, "
+ 			"        ac_timestamp = CURRENT_TIMESTAMP; "
+ 			"select ac_num, ac_timestamp from %s.sl_archive_counter; ",
+ 			namespace, namespace);
+ 	res = PQexec(local_dbconn, dstring_data(&query));
+ 	if ((rc = PQresultStatus(res)) != PGRES_TUPLES_OK)
+ 	{
+ 		slon_log(SLON_ERROR,
+ 				 "remoteWorkerThread_%d: \"%s\" %s %s\n",
+ 				 node->no_id, dstring_data(&query),
+ 				 PQresStatus(rc),
+ 				 PQresultErrorMessage(res));
+ 		PQclear(res);
+ 		dstring_free(&query);
+ 		return -1;
+ 	}
+ 	if ((rc = PQntuples(res)) != 1)
+ 	{
+ 		slon_log(SLON_ERROR,
+ 				 "remoteWorkerThread_%d: expected 1 row in sl_archive_counter - found %d",
+ 				 node->no_id, rc);
+ 		PQclear(res);
+ 		dstring_free(&query);
+ 		return -1;
+ 	}
+ 
  	if (node->archive_fp == NULL)
  	{
***************
*** 5234,5247 ****
  				"Cannot write to archive file %s - not open\n",
  				node->no_id, node->archive_temp);
  		return -1;
  	}
  
  	rc = fprintf(node->archive_fp, 
! 		"\nselect %s.setsyncTracking_offline(%d, '%s', '%s', '%s');\n"
  		"-- end of log archiving header\n"
  		"------------------------------------------------------------------\n"
  		"-- start of Slony-I data\n"
  		"------------------------------------------------------------------\n",
! 		namespace, sub_set, firstseq, seqbuf, timestamp);
  	if (rc < 0)
  	{
--- 5180,5197 ----
  				"Cannot write to archive file %s - not open\n",
  				node->no_id, node->archive_temp);
+ 		PQclear(res);
+ 		dstring_free(&query);
  		return -1;
  	}
  
  	rc = fprintf(node->archive_fp, 
! 		"\nselect %s.archiveTracking_offline('%s', '%s');\n"
  		"-- end of log archiving header\n"
  		"------------------------------------------------------------------\n"
  		"-- start of Slony-I data\n"
  		"------------------------------------------------------------------\n",
! 		namespace, PQgetvalue(res, 0, 0), PQgetvalue(res, 0, 1));
! 	PQclear(res);
! 	dstring_free(&query);
  	if (rc < 0)
  	{

From wieck at lists.slony.info  Mon Aug 20 11:22:28 2007
From: wieck at lists.slony.info (Jan Wieck)
Date: Mon Aug 20 11:22:30 2007
Subject: [Slony1-commit] slony1-engine/src/backend slony1_base.sql
	slony1_funcs.sql
Message-ID: <20070820182228.18EEA290037@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/backend
In directory main.slony.info:/tmp/cvs-serv10238/src/backend

Modified Files:
	slony1_base.sql slony1_funcs.sql 
Log Message:
Forward patching the new archive tracking into HEAD


Jan


Index: slony1_base.sql
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/backend/slony1_base.sql,v
retrieving revision 1.35
retrieving revision 1.36
diff -C2 -d -r1.35 -r1.36
*** slony1_base.sql	5 Jul 2007 18:19:04 -0000	1.35
--- slony1_base.sql	20 Aug 2007 18:22:25 -0000	1.36
***************
*** 549,552 ****
--- 549,567 ----
  
  -- ----------------------------------------------------------------------
+ -- TABLE sl_archive_counter
+ --
+ --	This table is used to generate the archive number for logshipping.
+ -- ----------------------------------------------------------------------
+ create table @NAMESPACE@.sl_archive_counter (
+ 	ac_num			bigint,
+ 	ac_timestamp	timestamp
+ ) without oids;
+ comment on table @NAMESPACE@.sl_archive_counter is 'Table used to generate the log shipping archive number.
+ ';
+ 
+ insert into @NAMESPACE@.sl_archive_counter (ac_num, ac_timestamp)
+ 	values (0, 'epoch'::timestamp);
+ 
+ -- ----------------------------------------------------------------------
  -- Last but not least grant USAGE to the replication schema objects.
  -- ----------------------------------------------------------------------

Index: slony1_funcs.sql
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/backend/slony1_funcs.sql,v
retrieving revision 1.117
retrieving revision 1.118
diff -C2 -d -r1.117 -r1.118
*** slony1_funcs.sql	29 Jul 2007 20:15:41 -0000	1.117
--- slony1_funcs.sql	20 Aug 2007 18:22:25 -0000	1.118
***************
*** 5304,5307 ****
--- 5304,5323 ----
  		-- ----
  		execute ''create type @NAMESPACE@.vactables as (nspname name, relname name);'';
+ 	end if;
+ 
+ 	-- ----
+ 	-- The following is already in 1.2.11, do not add any future
+ 	-- 1.2 version numbers.
+ 	-- ----
+ 	if p_old IN (''1.2.0'', ''1.2.1'', ''1.2.2'', ''1.2.3'', ''1.2.4'', ''1.2.5'', ''1.2.6'', ''1.2.7'', ''1.2.8'', ''1.2.9'', ''1.2.10'') then
+ 		-- ----
+ 		-- Add new table sl_archive_counter
+ 		-- ----
+ 		execute ''create table @NAMESPACE@.sl_archive_counter (
+ 					ac_num			bigint,
+ 					ac_timestamp	timestamp
+ 				) without oids'';
+ 		execute ''insert into @NAMESPACE@.sl_archive_counter
+ 				(ac_num, ac_timestamp) values (0, ''''epoch''''::timestamp)'';
  
  	end if;

From cbbrowne at lists.slony.info  Mon Aug 20 15:33:44 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Mon Aug 20 15:33:45 2007
Subject: [Slony1-commit] slony1-engine/tests/testlogship ddl_updates.sql
	generate_dml.sh init_data.sql
Message-ID: <20070820223344.36A9C290044@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/tests/testlogship
In directory main.slony.info:/tmp/cvs-serv17163/testlogship

Modified Files:
      Tag: REL_1_2_STABLE
	ddl_updates.sql generate_dml.sh init_data.sql 
Log Message:
Add in some Very Evil C-like format strings to logshipping test to ensure
that any cases where code interprets them will lead to Gory Crashes.


Index: generate_dml.sh
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tests/testlogship/generate_dml.sh,v
retrieving revision 1.1.2.4
retrieving revision 1.1.2.5
diff -C2 -d -r1.1.2.4 -r1.1.2.5
*** generate_dml.sh	30 Jul 2007 22:33:15 -0000	1.1.2.4
--- generate_dml.sh	20 Aug 2007 22:33:42 -0000	1.1.2.5
***************
*** 43,50 ****
      rb=$(random_number 1 9)
      rc=$(random_number 1 9)
!     echo "INSERT INTO table1(data) VALUES ('${txta}');" >> $GENDATA
!     echo "INSERT INTO table2(table1_id,data) SELECT id, '${txtb}' FROM table1 WHERE data='${txta}';" >> $GENDATA
!     echo "INSERT INTO table3(table2_id) SELECT id FROM table2 WHERE data ='${txtb}';" >> $GENDATA
!     echo "INSERT INTO table5(numcol,realcol,ptcol,pathcol,polycol,circcol,ipcol,maccol,bitcol) values ('${ra}${rb}.${rc}','${ra}.${rb}${rc}','(${ra},${rb})','((${ra},${ra}),(${rb},${rb}),(${rc},${rc}),(${ra},${rc}))','((${ra},${rb}),(${rc},${ra}),(${rb},${rc}),(${rc},${rb}))','<(${ra},${rb}),${rc}>','192.168.${ra}.${rb}${rc}','08:00:2d:0${ra}:0${rb}:0${rc}',X'${ra}${rb}${rc}');" >> $GENDATA
      if [ ${i} -ge ${numrows} ]; then
        break;
--- 43,50 ----
      rb=$(random_number 1 9)
      rc=$(random_number 1 9)
!     echo "INSERT INTO table1(data) VALUES ('${txta} - Gross C format string: %d%05d%s%s%f%l%-72.52LG');" >> ${GENDATA}
!     echo "INSERT INTO table2(table1_id,data) SELECT id, '${txtb}' FROM table1 WHERE data='${txta}';" >> ${GENDATA}
!     echo "INSERT INTO table3(table2_id) SELECT id FROM table2 WHERE data ='${txtb}';" >> ${GENDATA}
!     echo "INSERT INTO table4(numcol,realcol,ptcol,pathcol,polycol,circcol,ipcol,maccol,bitcol) values ('${ra}${rb}.${rc}','${ra}.${rb}${rc}','(${ra},${rb})','((${ra},${ra}),(${rb},${rb}),(${rc},${rc}),(${ra},${rc}))','((${ra},${rb}),(${rc},${ra}),(${rb},${rc}),(${rc},${rb}))','<(${ra},${rb}),${rc}>','192.168.${ra}.${rb}${rc}','08:00:2d:0${ra}:0${rb}:0${rc}',X'${ra}${rb}${rc}');" >> ${GENDATA}
      if [ ${i} -ge ${numrows} ]; then
        break;

Index: init_data.sql
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tests/testlogship/init_data.sql,v
retrieving revision 1.1.2.1
retrieving revision 1.1.2.2
diff -C2 -d -r1.1.2.1 -r1.1.2.2
*** init_data.sql	20 Apr 2007 20:51:09 -0000	1.1.2.1
--- init_data.sql	20 Aug 2007 22:33:42 -0000	1.1.2.2
***************
*** 6,8 ****
  INSERT INTO table4(numcol,realcol,ptcol,pathcol,polycol,circcol,ipcol,maccol,bitcol) values ('74.0','7.40','(7,4)','((7,7),(4,4),(0,0),(7,0))','((7,4),(0,7),(4,0),(0,4))','<(7,4),0>','192.168.7.40','08:00:2d:07:04:00',X'740');
  
! INSERT INTO table4(numcol,realcol,ptcol,pathcol,polycol,circcol,ipcol,maccol,bitcol) values ('93.1','9.31','(9,3)','((9,9),(3,3),(1,1),(9,1))','((9,3),(1,9),(3,1),(1,3))','<(9,3),1>','192.168.9.31','08:00:2d:09:03:01',X'931');
\ No newline at end of file
--- 6,10 ----
  INSERT INTO table4(numcol,realcol,ptcol,pathcol,polycol,circcol,ipcol,maccol,bitcol) values ('74.0','7.40','(7,4)','((7,7),(4,4),(0,0),(7,0))','((7,4),(0,7),(4,0),(0,4))','<(7,4),0>','192.168.7.40','08:00:2d:07:04:00',X'740');
  
! INSERT INTO table4(numcol,realcol,ptcol,pathcol,polycol,circcol,ipcol,maccol,bitcol) values ('93.1','9.31','(9,3)','((9,9),(3,3),(1,1),(9,1))','((9,3),(1,9),(3,1),(1,3))','<(9,3),1>','192.168.9.31','08:00:2d:09:03:01',X'931');
! 
! insert into table1 (data) values ('Evil C Format String: %d%05d%s%f%G%p%n%ld');
\ No newline at end of file

Index: ddl_updates.sql
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tests/testlogship/ddl_updates.sql,v
retrieving revision 1.1.2.1
retrieving revision 1.1.2.2
diff -C2 -d -r1.1.2.1 -r1.1.2.2
*** ddl_updates.sql	20 Apr 2007 21:40:02 -0000	1.1.2.1
--- ddl_updates.sql	20 Aug 2007 22:33:42 -0000	1.1.2.2
***************
*** 3,4 ****
--- 3,6 ----
  alter table table4 add column newint integer;
  update table4 set newint = 42;
+ -- The following tries to exercise any cases where DDL statements might be evaluated by printf()
+ update table1 set data = data || '%d%s%s%s%s%f%l%d%s%f%p%d%f' where id in (select id from table1 order by id desc limit 150);
\ No newline at end of file

From cbbrowne at lists.slony.info  Mon Aug 20 15:35:34 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Mon Aug 20 15:35:35 2007
Subject: [Slony1-commit] slony1-engine RELEASE
Message-ID: <20070820223534.B44992903BF@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine
In directory main.slony.info:/tmp/cvs-serv17247

Modified Files:
      Tag: REL_1_2_STABLE
	RELEASE 
Log Message:
Updates to release notes for work by Jan and I


Index: RELEASE
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/RELEASE,v
retrieving revision 1.1.2.10
retrieving revision 1.1.2.11
diff -C2 -d -r1.1.2.10 -r1.1.2.11
*** RELEASE	3 Aug 2007 16:09:11 -0000	1.1.2.10
--- RELEASE	20 Aug 2007 22:35:32 -0000	1.1.2.11
***************
*** 27,30 ****
--- 27,35 ----
    (e.g. - without trailing semicolon ";") would get omitted.
  
+ - Added tests to the log shipping case to check for
+   invalidly-evaluated printf() format strings; added data that
+   contains such data, and prepared a DDL script that contained gory
+   format strings.
+ 
  - Typo fix: when trying to disable a node, the logs would report
    "enableNode" rather than "disableNode".  Fixed.
***************
*** 32,35 ****
--- 37,47 ----
  - Add usage/version options to help output in slon.
  
+ - Fix archive logging for replicated sequences.
+ 
+ - Fix to log shipping - added another table, sl_archive_counter where
+   the log writing slon simply tracks when it wrote the last offline
+   archive file and maintains a counter. This counter is now tracked in
+   the offline replica and must increment gap free.
+ 
  RELEASE 1.2.10
  

From cbbrowne at lists.slony.info  Mon Aug 20 15:36:01 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Mon Aug 20 15:36:02 2007
Subject: [Slony1-commit] slony1-engine/tools slony1_dump.sh
Message-ID: <20070820223601.F0EBC2903D4@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/tools
In directory main.slony.info:/tmp/cvs-serv17276

Modified Files:
      Tag: REL_1_2_STABLE
	slony1_dump.sh 
Log Message:
Add missing semicolon to slony1_dump.sh


Index: slony1_dump.sh
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tools/slony1_dump.sh,v
retrieving revision 1.8.2.3
retrieving revision 1.8.2.4
diff -C2 -d -r1.8.2.3 -r1.8.2.4
*** slony1_dump.sh	20 Aug 2007 17:02:28 -0000	1.8.2.3
--- slony1_dump.sh	20 Aug 2007 22:35:59 -0000	1.8.2.4
***************
*** 199,203 ****
  			ac_num::text || ', ''' || ac_timestamp::text || 
  			''', CURRENT_TIMESTAMP);'
! 			from $clname.sl_archive_counter";
  
  # ----
--- 199,203 ----
  			ac_num::text || ', ''' || ac_timestamp::text || 
  			''', CURRENT_TIMESTAMP);'
! 			from $clname.sl_archive_counter;";
  
  # ----

From cbbrowne at lists.slony.info  Mon Aug 20 15:36:27 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Mon Aug 20 15:36:28 2007
Subject: [Slony1-commit] slony1-engine/tools slony1_dump.sh
Message-ID: <20070820223627.0B8262903BF@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/tools
In directory main.slony.info:/tmp/cvs-serv17294

Modified Files:
	slony1_dump.sh 
Log Message:
Add missing semicolon to slony1_dump.sh


Index: slony1_dump.sh
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tools/slony1_dump.sh,v
retrieving revision 1.10
retrieving revision 1.11
diff -C2 -d -r1.10 -r1.11
*** slony1_dump.sh	20 Aug 2007 18:22:26 -0000	1.10
--- slony1_dump.sh	20 Aug 2007 22:36:24 -0000	1.11
***************
*** 199,203 ****
  			ac_num::text || ', ''' || ac_timestamp::text || 
  			''', CURRENT_TIMESTAMP);'
! 			from $clname.sl_archive_counter";
  
  # ----
--- 199,203 ----
  			ac_num::text || ', ''' || ac_timestamp::text || 
  			''', CURRENT_TIMESTAMP);'
! 			from $clname.sl_archive_counter;";
  
  # ----

From cbbrowne at lists.slony.info  Tue Aug 21 15:13:24 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Aug 21 15:13:25 2007
Subject: [Slony1-commit] slony1-engine/src/backend slony1_base.sql
Message-ID: <20070821221324.289BA290037@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/backend
In directory main.slony.info:/tmp/cvs-serv6234/src/backend

Modified Files:
      Tag: REL_1_2_STABLE
	slony1_base.sql 
Log Message:
Add comments for recently-added tables


Index: slony1_base.sql
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/backend/slony1_base.sql,v
retrieving revision 1.32.2.1
retrieving revision 1.32.2.2
diff -C2 -d -r1.32.2.1 -r1.32.2.2
*** slony1_base.sql	20 Aug 2007 17:02:28 -0000	1.32.2.1
--- slony1_base.sql	21 Aug 2007 22:13:22 -0000	1.32.2.2
***************
*** 573,576 ****
--- 573,577 ----
  comment on table @NAMESPACE@.sl_config_lock is 'This table exists solely to prevent overlapping execution of configuration change procedures and the resulting possible deadlocks.
  ';
+ comment on column @NAMESPACE@.sl_config_lock.dummy is 'No data ever goes in this table so the contents never matter.  Indeed, this column does not really need to exist.';
  
  -- ----------------------------------------------------------------------
***************
*** 585,588 ****
--- 586,591 ----
  comment on table @NAMESPACE@.sl_archive_counter is 'Table used to generate the log shipping archive number.
  ';
+ comment on column @NAMESPACE@.sl_archive_counter.ac_num is 'Counter of SYNC ID used in log shipping as the archive number';
+ comment on column @NAMESPACE@.sl_archive_counter.ac_timestamp is 'Time at which the archive log was generated on the subscriber';
  
  insert into @NAMESPACE@.sl_archive_counter (ac_num, ac_timestamp)

From cbbrowne at lists.slony.info  Tue Aug 21 15:15:46 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Aug 21 15:15:46 2007
Subject: [Slony1-commit] slony1-engine/src/backend slony1_base.sql
Message-ID: <20070821221546.73A14290044@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/backend
In directory main.slony.info:/tmp/cvs-serv6324

Modified Files:
	slony1_base.sql 
Log Message:
Add comments on new tables


Index: slony1_base.sql
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/backend/slony1_base.sql,v
retrieving revision 1.36
retrieving revision 1.37
diff -C2 -d -r1.36 -r1.37
*** slony1_base.sql	20 Aug 2007 18:22:25 -0000	1.36
--- slony1_base.sql	21 Aug 2007 22:15:44 -0000	1.37
***************
*** 543,546 ****
--- 543,547 ----
  comment on table @NAMESPACE@.sl_config_lock is 'This table exists solely to prevent overlapping execution of configuration change procedures and the resulting possible deadlocks.
  ';
+ comment on column @NAMESPACE@.sl_config_lock.dummy is 'No data ever goes in this table so the contents never matter.  Indeed, this column does not really need to exist.';
  
  create type @NAMESPACE@.vactables as (nspname name, relname name);
***************
*** 559,562 ****
--- 560,565 ----
  comment on table @NAMESPACE@.sl_archive_counter is 'Table used to generate the log shipping archive number.
  ';
+ comment on column @NAMESPACE@.sl_archive_counter.ac_num is 'Counter of SYNC ID used in log shipping as the archive number';
+ comment on column @NAMESPACE@.sl_archive_counter.ac_timestamp is 'Time at which the archive log was generated on the subscriber';
  
  insert into @NAMESPACE@.sl_archive_counter (ac_num, ac_timestamp)

From cbbrowne at lists.slony.info  Tue Aug 21 15:17:57 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Aug 21 15:17:59 2007
Subject: [Slony1-commit] slony1-engine/src/parsestatements
	emptytestresult.expected scanner.c test_sql.expected test_sql.sql
Message-ID: <20070821221757.CB8D72903AC@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/parsestatements
In directory main.slony.info:/tmp/cvs-serv6390

Modified Files:
	emptytestresult.expected scanner.c test_sql.expected 
	test_sql.sql 
Log Message:
Apply updates to scanner previously applied to 1.2 branch


Index: scanner.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/parsestatements/scanner.c,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** scanner.c	4 Aug 2006 20:40:19 -0000	1.3
--- scanner.c	21 Aug 2007 22:17:55 -0000	1.4
***************
*** 12,15 ****
--- 12,18 ----
    int d1start, d1end, d2start, d2end, d1stemp;
    int statements;
+   int nparens;
+   int nbrokets;
+   int nsquigb;
    
    /* Initialize */
***************
*** 22,25 ****
--- 25,31 ----
    d1end = 0;
    state = Q_NORMAL_STATE;
+   nparens = 0;
+   nbrokets = 0;
+   nsquigb = 0;
    
    while (state != Q_DONE) {
***************
*** 27,32 ****
--- 33,71 ----
      switch (cchar) {
      case '\0':
+       STMTS[statements++] = ++cpos;
        state = Q_DONE;
        break;
+ 
+     case '(':
+       if (state == Q_NORMAL_STATE) {
+ 	nparens ++;
+ 	break;
+       }
+     case ')':
+       if (state == Q_NORMAL_STATE) {
+ 	nparens --;
+ 	break;
+       }
+     case '[':
+       if (state == Q_NORMAL_STATE) {
+ 	nbrokets ++;
+ 	break;
+       }
+     case ']':
+       if (state == Q_NORMAL_STATE) {
+ 	nbrokets --;
+ 	break;
+       }
+     case '{':
+       if (state == Q_NORMAL_STATE) {
+ 	nsquigb ++;
+ 	break;
+       }
+     case '}':
+       if (state == Q_NORMAL_STATE) {
+ 	nsquigb --;
+ 	break;
+       }
+ 
      case '/':
        if (state == Q_NORMAL_STATE) {
***************
*** 52,57 ****
  	  break;
  	}
!       } 
! 
        break;
      case '$':
--- 91,95 ----
  	  break;
  	}
!       }
        break;
      case '$':
***************
*** 124,128 ****
        break;
      case '-':
!       if (state == Q_NORMAL_STATE) {
  	state = Q_HOPE_TO_DASH;
  	break;
--- 162,166 ----
        break;
      case '-':
!       if (state == Q_NORMAL_STATE && extended_statement[cpos+1] == '-') {
  	state = Q_HOPE_TO_DASH;
  	break;
***************
*** 152,156 ****
        break;
      case ';':
!       if (state == Q_NORMAL_STATE) {
  	STMTS[statements++] = ++cpos;
  	if (statements >= MAXSTATEMENTS) {
--- 190,194 ----
        break;
      case ';':
!       if ((state == Q_NORMAL_STATE) && (nparens == 0) && (nbrokets == 0) && (nsquigb == 0)) {
  	STMTS[statements++] = ++cpos;
  	if (statements >= MAXSTATEMENTS) {

Index: test_sql.expected
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/parsestatements/test_sql.expected,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** test_sql.expected	24 Feb 2006 18:48:12 -0000	1.2
--- test_sql.expected	21 Aug 2007 22:17:55 -0000	1.3
***************
*** 38,41 ****
--- 38,80 ----
  
  
+ -- Here is a rule creation with an embedded semicolon
+ -- "Dmitry Koterov" <dmitry@koterov.ru>
+ 
+ create table "public"."position";
+ 
+ CREATE RULE "position_get_last_id_on_insert2"
+ AS ON INSERT TO "public"."position" DO (SELECT
+ currval('position_position_id_seq'::regclass) AS id;);
+ 
+ -- Added to verify handling of queries tried by
+ -- "Dmitry Koterov" <dmitry@koterov.ru>
+ 
+ CREATE INDEX aaa ON public.bbb USING btree ((-ccc), ddd);
+ 
+ --  Apparently a pair of backslashes fold down into one?
+ -- "Dmitry Koterov" <dmitry@koterov.ru>
+ 
+ CREATE UNIQUE INDEX "i_dictionary_uni_abbr" ON "static"."dictionary"
+ USING btree ((substring(dic_russian, E'^([^(]*[^( ]) *\\('::text)))
+ WHERE (dic_category_id = 26);
+ 
+ -- Some more torturing per Weslee Bilodeau
+ 
+ -- I figure the $_$, $$, etc edge-casees would be another fun one to roll
+ -- into a custom parser.
+ 
+ CREATE FUNCTION test( ) RETURNS text AS $_$ SELECT ';', E'\';\'',
+ '"";""', E'"\';' ; SELECT 'OK'::text ; $_$ LANGUAGE SQL ;
+ 
+ SELECT $_$ hello; this ; - is '\" a '''' test $_$ ;
+ 
+ SELECT $$ $ test ; $ ;  $$ ;
+ 
+ -- All really funky, but perfectly valid.
+ 
+ -- Force a query to be at the end...
+ 
+ create table foo;
+ 
  statement 0
  -------------------------------------------
***************
*** 115,117 ****
      return NULL;
    end;
! $$ language plpgsql;
\ No newline at end of file
--- 154,223 ----
      return NULL;
    end;
! $$ language plpgsql;
! statement 14
! -------------------------------------------
! 
! 
! 
! -- Here is a rule creation with an embedded semicolon
! -- "Dmitry Koterov" <dmitry@koterov.ru>
! 
! create table "public"."position";
! statement 15
! -------------------------------------------
! 
! 
! CREATE RULE "position_get_last_id_on_insert2"
! AS ON INSERT TO "public"."position" DO (SELECT
! currval('position_position_id_seq'::regclass) AS id;);
! statement 16
! -------------------------------------------
! 
! 
! -- Added to verify handling of queries tried by
! -- "Dmitry Koterov" <dmitry@koterov.ru>
! 
! CREATE INDEX aaa ON public.bbb USING btree ((-ccc), ddd);
! statement 17
! -------------------------------------------
! 
! 
! --  Apparently a pair of backslashes fold down into one?
! -- "Dmitry Koterov" <dmitry@koterov.ru>
! 
! CREATE UNIQUE INDEX "i_dictionary_uni_abbr" ON "static"."dictionary"
! USING btree ((substring(dic_russian, E'^([^(]*[^( ]) *\\('::text)))
! WHERE (dic_category_id = 26);
! statement 18
! -------------------------------------------
! 
! 
! -- Some more torturing per Weslee Bilodeau
! 
! -- I figure the $_$, $$, etc edge-casees would be another fun one to roll
! -- into a custom parser.
! 
! CREATE FUNCTION test( ) RETURNS text AS $_$ SELECT ';', E'\';\'',
! '"";""', E'"\';' ; SELECT 'OK'::text ; $_$ LANGUAGE SQL ;
! statement 19
! -------------------------------------------
! 
! 
! SELECT $_$ hello; this ; - is '\" a '''' test $_$ ;
! statement 20
! -------------------------------------------
! 
! 
! SELECT $$ $ test ; $ ;  $$ ;
! statement 21
! -------------------------------------------
! 
! 
! -- All really funky, but perfectly valid.
! 
! -- Force a query to be at the end...
! 
! create table foo;
! statement 22
! -------------------------------------------
!   
\ No newline at end of file

Index: emptytestresult.expected
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/parsestatements/emptytestresult.expected,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
Binary files /tmp/cvsdqaIoX and /tmp/cvsbTSZoP differ

Index: test_sql.sql
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/parsestatements/test_sql.sql,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** test_sql.sql	24 Feb 2006 18:33:02 -0000	1.1
--- test_sql.sql	21 Aug 2007 22:17:55 -0000	1.2
***************
*** 36,37 ****
--- 36,77 ----
    end;
  $$ language plpgsql;
+ 
+ 
+ -- Here is a rule creation with an embedded semicolon
+ -- "Dmitry Koterov" <dmitry@koterov.ru>
+ 
+ create table "public"."position";
+ 
+ CREATE RULE "position_get_last_id_on_insert2"
+ AS ON INSERT TO "public"."position" DO (SELECT
+ currval('position_position_id_seq'::regclass) AS id;);
+ 
+ -- Added to verify handling of queries tried by
+ -- "Dmitry Koterov" <dmitry@koterov.ru>
+ 
+ CREATE INDEX aaa ON public.bbb USING btree ((-ccc), ddd);
+ 
+ --  Apparently a pair of backslashes fold down into one?
+ -- "Dmitry Koterov" <dmitry@koterov.ru>
+ 
+ CREATE UNIQUE INDEX "i_dictionary_uni_abbr" ON "static"."dictionary"
+ USING btree ((substring(dic_russian, E'^([^(]*[^( ]) *\\('::text)))
+ WHERE (dic_category_id = 26);
+ 
+ -- Some more torturing per Weslee Bilodeau
+ 
+ -- I figure the $_$, $$, etc edge-casees would be another fun one to roll
+ -- into a custom parser.
+ 
+ CREATE FUNCTION test( ) RETURNS text AS $_$ SELECT ';', E'\';\'',
+ '"";""', E'"\';' ; SELECT 'OK'::text ; $_$ LANGUAGE SQL ;
+ 
+ SELECT $_$ hello; this ; - is '\" a '''' test $_$ ;
+ 
+ SELECT $$ $ test ; $ ;  $$ ;
+ 
+ -- All really funky, but perfectly valid.
+ 
+ -- Force a query to be at the end...
+ 
+ create table foo;
\ No newline at end of file

From cbbrowne at lists.slony.info  Tue Aug 21 15:32:03 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Aug 21 15:32:04 2007
Subject: [Slony1-commit] slony1-www/content frontpage.txt news.txt
Message-ID: <20070821223203.3D5AA2903D1@main.slony.info>

Update of /home/cvsd/slony1/slony1-www/content
In directory main.slony.info:/tmp/cvs-serv6805/content

Modified Files:
	frontpage.txt news.txt 
Log Message:
Add notes on 1.2.11 pre2


Index: frontpage.txt
===================================================================
RCS file: /home/cvsd/slony1/slony1-www/content/frontpage.txt,v
retrieving revision 1.17
retrieving revision 1.18
diff -C2 -d -r1.17 -r1.18
*** frontpage.txt	3 Aug 2007 16:24:43 -0000	1.17
--- frontpage.txt	21 Aug 2007 22:32:01 -0000	1.18
***************
*** 1,9 ****
  ---
! Slony-I 1.2.11 pre-release available
! http://slony.info/downloads/1.2/source/slony1-1.2.11-pre1.tar.bz2
! 2007-08-03
  Chris Browne
  
! A tarball of Slony-I 1.2.11 is available for testing.
  
  <P> Fixes are the following:
--- 1,10 ----
  ---
! --
! Slony-I 1.2.11 pre-release #2 available
! http://slony.info/downloads/1.2/source/slony1-1.2.11-pre2.tar.bz2
! 2007-08-21
  Chris Browne
  
! A second tarball of Slony-I 1.2.11 is available for testing.
  
  <P> Fixes are the following:
***************
*** 37,40 ****
--- 38,49 ----
  
  <li> Add usage/version options to help output in slon.
+ 
+ <li> Fix archive logging for replicated sequences.
+ 
+ <li> Fix to log shipping - added another table, sl_archive_counter where
+   the log writing slon simply tracks when it wrote the last offline
+   archive file and maintains a counter. This counter is now tracked in
+   the offline replica and must increment gap free.
+ 
  </ul>
  ---

Index: news.txt
===================================================================
RCS file: /home/cvsd/slony1/slony1-www/content/news.txt,v
retrieving revision 1.30
retrieving revision 1.31
diff -C2 -d -r1.30 -r1.31
*** news.txt	3 Aug 2007 16:24:43 -0000	1.30
--- news.txt	21 Aug 2007 22:32:01 -0000	1.31
***************
*** 10,13 ****
--- 10,60 ----
  Slony-1 1.1.9 <a href="http://main.slony.info/downloads/1.1/source/slony1-1.1.9.tar.bz2">engine</a>
  <!-- Please keep this item at the top of the news list -->
+ --
+ Slony-I 1.2.11 pre-release #2 available
+ http://slony.info/downloads/1.2/source/slony1-1.2.11-pre2.tar.bz2
+ 2007-08-21
+ Chris Browne
+ 
+ A second tarball of Slony-I 1.2.11 is available for testing.
+ 
+ <P> Fixes are the following:
+ <ul>
+ <li> Add in tools/mkservice scripts previously added to CVS HEAD
+ 
+ <li> During subscription, do UPDATE to pg_class.relhasindex *after* the
+   TRUNCATE because, in 8.2+, TRUNCATE resets this attribute
+ 
+ <li> Fixed a problem with the setsync tracking with Log Shipping in cases
+   where slon does an internal restart (thereby rereading the
+   pset.ssy_seqno) and ignoring non-SYNC events because those don't
+   change the sl_setsync table.
+ 
+ <li> More explicit type casting of text objects for compatibility with
+   PostgreSQL 8.3
+ 
+ <li> Fixed problem with DDL SCRIPT statement parser: it wasn't 'quoting'
+   semicolons inside parentheses (this notably occurs in CREATE RULE).
+ 
+ <li> Fixed problem with DDL SCRIPT statement submission; it was
+   interpreting the statement as a format string, which would have
+   ill effects in the presence of things that are interpreted such
+   as format strings (%d, %f, %s) and \backslashed things like \\, \n.
+ 
+ <li> Further DDL Script issue: non-terminated statement at the end
+   (e.g. - without trailing semicolon ";") would get omitted.
+ 
+ <li> Typo fix: when trying to disable a node, the logs would report
+   "enableNode" rather than "disableNode".  Fixed.
+ 
+ <li> Add usage/version options to help output in slon.
+ 
+ <li> Fix archive logging for replicated sequences.
+ 
+ <li> Fix to log shipping - added another table, sl_archive_counter where
+   the log writing slon simply tracks when it wrote the last offline
+   archive file and maintains a counter. This counter is now tracked in
+   the offline replica and must increment gap free.
+ 
+ </ul>
  ---
  Slony-I 1.2.11 pre-release available

From cbbrowne at lists.slony.info  Tue Aug 21 15:35:16 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Aug 21 15:35:17 2007
Subject: [Slony1-commit] slony1-www/content frontpage.txt
Message-ID: <20070821223516.B796C290044@main.slony.info>

Update of /home/cvsd/slony1/slony1-www/content
In directory main.slony.info:/home/community/slony/htdocs/content

Modified Files:
	frontpage.txt 
Log Message:
Fix up front page Z
CVSs: ----------------------------------------------------------------------


Index: frontpage.txt
===================================================================
RCS file: /home/cvsd/slony1/slony1-www/content/frontpage.txt,v
retrieving revision 1.18
retrieving revision 1.19
diff -C2 -d -r1.18 -r1.19
*** frontpage.txt	21 Aug 2007 22:32:01 -0000	1.18
--- frontpage.txt	21 Aug 2007 22:35:14 -0000	1.19
***************
*** 1,4 ****
  ---
- --
  Slony-I 1.2.11 pre-release #2 available
  http://slony.info/downloads/1.2/source/slony1-1.2.11-pre2.tar.bz2
--- 1,3 ----

From cbbrowne at lists.slony.info  Wed Aug 22 10:50:10 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Wed Aug 22 10:50:12 2007
Subject: [Slony1-commit] slony1-engine/tools check_slony_cluster.sh
Message-ID: <20070822175010.88E8429002F@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/tools
In directory main.slony.info:/tmp/cvs-serv28988

Modified Files:
      Tag: REL_1_2_STABLE
	check_slony_cluster.sh 
Log Message:
Improvement to Nagios check - checks to see that there are nodes in the
listing.

 -- Michael Best <mbest@pendragon.org>


Index: check_slony_cluster.sh
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tools/check_slony_cluster.sh,v
retrieving revision 1.3
retrieving revision 1.3.4.1
diff -C2 -d -r1.3 -r1.3.4.1
*** check_slony_cluster.sh	22 Mar 2005 17:30:10 -0000	1.3
--- check_slony_cluster.sh	22 Aug 2007 17:50:08 -0000	1.3.4.1
***************
*** 70,74 ****
  # and check the return status
  STATUS=`echo $CHECK | awk '{print $1}'`
! if [ $STATUS = "OK" ]
  then
     exit 0
--- 70,75 ----
  # and check the return status
  STATUS=`echo $CHECK | awk '{print $1}'`
! NODESOK=`echo $CHECK | awk '{print $3}'`
! if [[ $STATUS = "OK"  && $NODESOK != "0" ]]
  then
     exit 0

From cbbrowne at lists.slony.info  Wed Aug 22 10:50:25 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Wed Aug 22 10:50:26 2007
Subject: [Slony1-commit] slony1-engine/tools check_slony_cluster.sh
Message-ID: <20070822175025.748FA29002F@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/tools
In directory main.slony.info:/tmp/cvs-serv29021

Modified Files:
	check_slony_cluster.sh 
Log Message:
Improvement to Nagios check - checks to see that there are nodes in the
listing.

 -- Michael Best <mbest@pendragon.org>


Index: check_slony_cluster.sh
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tools/check_slony_cluster.sh,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** check_slony_cluster.sh	22 Mar 2005 17:30:10 -0000	1.3
--- check_slony_cluster.sh	22 Aug 2007 17:50:23 -0000	1.4
***************
*** 70,74 ****
  # and check the return status
  STATUS=`echo $CHECK | awk '{print $1}'`
! if [ $STATUS = "OK" ]
  then
     exit 0
--- 70,75 ----
  # and check the return status
  STATUS=`echo $CHECK | awk '{print $1}'`
! NODESOK=`echo $CHECK | awk '{print $3}'`
! if [[ $STATUS = "OK"  && $NODESOK != "0" ]]
  then
     exit 0

From cbbrowne at lists.slony.info  Wed Aug 22 14:20:25 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Wed Aug 22 14:20:28 2007
Subject: [Slony1-commit] slony1-engine/src/slon cleanup_thread.c
Message-ID: <20070822212025.BB8F429002F@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slon
In directory main.slony.info:/tmp/cvs-serv1361/src/slon

Modified Files:
      Tag: REL_1_2_STABLE
	cleanup_thread.c 
Log Message:
Add new table, sl_archive_counter, to vacuum regimen


Index: cleanup_thread.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/cleanup_thread.c,v
retrieving revision 1.33.2.3
retrieving revision 1.33.2.4
diff -C2 -d -r1.33.2.3 -r1.33.2.4
*** cleanup_thread.c	6 Dec 2006 09:37:29 -0000	1.33.2.3
--- cleanup_thread.c	22 Aug 2007 21:20:23 -0000	1.33.2.4
***************
*** 39,43 ****
  
  /* The list of tables that need to be vacuumed by Slony-I */
! static char *table_list[] = {"%s.sl_event",
  	"%s.sl_confirm",
  	"%s.sl_setsync",
--- 39,44 ----
  
  /* The list of tables that need to be vacuumed by Slony-I */
! static char *table_list[] = {
! 	"%s.sl_event",
  	"%s.sl_confirm",
  	"%s.sl_setsync",
***************
*** 45,48 ****
--- 46,50 ----
  	"%s.sl_log_2",
  	"%s.sl_seqlog",
+         "%s.sl_archive_counter",
  	"pg_catalog.pg_listener",
  	"pg_catalog.pg_statistic",

From cbbrowne at lists.slony.info  Wed Aug 22 14:21:05 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Wed Aug 22 14:21:06 2007
Subject: [Slony1-commit] slony1-engine/src/backend slony1_funcs.sql
Message-ID: <20070822212105.2F2692903AC@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/backend
In directory main.slony.info:/tmp/cvs-serv1409/src/backend

Modified Files:
	slony1_funcs.sql 
Log Message:
Add new table, sl_archive_counter, to vacuum regimen


Index: slony1_funcs.sql
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/backend/slony1_funcs.sql,v
retrieving revision 1.118
retrieving revision 1.119
diff -C2 -d -r1.118 -r1.119
*** slony1_funcs.sql	20 Aug 2007 18:22:25 -0000	1.118
--- slony1_funcs.sql	22 Aug 2007 21:21:03 -0000	1.119
***************
*** 5608,5611 ****
--- 5608,5616 ----
  		return next prec;
  	end if;
+ 	prec.nspname := ''_@CLUSTERNAME@'';
+ 	prec.relname := ''sl_archive_counter'';
+ 	if @NAMESPACE@.AutoVacExcludesTable(prec.nspname, prec.relname) then
+ 		return next prec;
+ 	end if;
  	prec.nspname := ''pg_catalog'';
  	prec.relname := ''pg_listener'';

From cbbrowne at lists.slony.info  Wed Aug 22 15:05:02 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Wed Aug 22 15:05:04 2007
Subject: [Slony1-commit] slony1-engine/doc/adminguide monitoring.sgml
	slon.sgml
Message-ID: <20070822220502.C1789290037@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/doc/adminguide
In directory main.slony.info:/tmp/cvs-serv2310

Modified Files:
	monitoring.sgml slon.sgml 
Log Message:
Minor changes to SGML tagging to clear up little problems.


Index: monitoring.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/monitoring.sgml,v
retrieving revision 1.39
retrieving revision 1.40
diff -C2 -d -r1.39 -r1.40
*** monitoring.sgml	9 Jul 2007 15:21:28 -0000	1.39
--- monitoring.sgml	22 Aug 2007 22:05:00 -0000	1.40
***************
*** 233,237 ****
  (comma-delimited) categories with which to associate the output.  If
  you have a series of &slony1; clusters, passing in the option
! <option>--categories=&slony1;</option> leads to the MediaWiki instance
  generating a category page listing all &slony1; clusters so
  categorized on the wiki.  </para>
--- 233,237 ----
  (comma-delimited) categories with which to associate the output.  If
  you have a series of &slony1; clusters, passing in the option
! <option>--categories=slony1</option> leads to the MediaWiki instance
  generating a category page listing all &slony1; clusters so
  categorized on the wiki.  </para>

Index: slon.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/slon.sgml,v
retrieving revision 1.32
retrieving revision 1.33
diff -C2 -d -r1.32 -r1.33
*** slon.sgml	8 Aug 2007 15:24:23 -0000	1.32
--- slon.sgml	22 Aug 2007 22:05:00 -0000	1.33
***************
*** 152,157 ****
        </itemizedlist>
  
!      </para>
!      <para>
        Default is 10000 ms and maximum is 120000 ms. By default, you
        can expect each node to <quote>report in</quote> with a
--- 152,156 ----
        </itemizedlist>
  
!       <para>
        Default is 10000 ms and maximum is 120000 ms. By default, you
        can expect each node to <quote>report in</quote> with a

From cbbrowne at lists.slony.info  Wed Aug 22 15:05:50 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Wed Aug 22 15:05:50 2007
Subject: [Slony1-commit] slony1-engine/doc/adminguide slonyupgrade.sgml
Message-ID: <20070822220550.482F82903AC@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/doc/adminguide
In directory main.slony.info:/tmp/cvs-serv2367

Modified Files:
	slonyupgrade.sgml 
Log Message:
Beginnings of discussion of trigger handling changes in Slony-I 2.0


Index: slonyupgrade.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/slonyupgrade.sgml,v
retrieving revision 1.7
retrieving revision 1.8
diff -C2 -d -r1.7 -r1.8
*** slonyupgrade.sgml	9 Jul 2007 15:19:49 -0000	1.7
--- slonyupgrade.sgml	22 Aug 2007 22:05:48 -0000	1.8
***************
*** 238,241 ****
--- 238,254 ----
  
  </sect2>
+ 
+ <sect2> <title> New Trigger Handling in &slony1; Version 2 </title>
+ 
+ <para> One of the major changes to &slony1; is that enabling/disabling
+ of triggers and rules now takes place as plain SQL, supported by
+ &postgres; 8.3+, rather than via <quote>hacking</quote> on the system
+ catalog. </para>
+ 
+ <para> As a result, &slony1; users should be aware of the &postgres;
+ syntax for <command>ALTER TABLE</command>, as that is how they can
+ accomplish what was formerly accomplished via <xref
+ linkend="stmtstoretrigger"> and <xref linkend="stmtdroptrigger">. </para>
+ 
  </sect1>
  <!-- Keep this comment at the end of the file

From cbbrowne at lists.slony.info  Wed Aug 22 15:06:50 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Wed Aug 22 15:06:51 2007
Subject: [Slony1-commit] slony1-engine/doc/adminguide filelist.sgml
	raceconditions.sgml slony.sgml
Message-ID: <20070822220650.159A0290037@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/doc/adminguide
In directory main.slony.info:/tmp/cvs-serv2395

Modified Files:
	filelist.sgml slony.sgml 
Added Files:
	raceconditions.sgml 
Log Message:
Add new page on race conditions, along with various references into other
SGML files.


Index: slony.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/slony.sgml,v
retrieving revision 1.36
retrieving revision 1.37
diff -C2 -d -r1.36 -r1.37
*** slony.sgml	4 Oct 2006 15:52:13 -0000	1.36
--- slony.sgml	22 Aug 2007 22:06:48 -0000	1.37
***************
*** 95,98 ****
--- 95,99 ----
   &plainpaths;
   &locking;
+  &raceconditions;
   &addthings;
   &dropthings;
***************
*** 106,110 ****
   &loganalysis;
   &help;
! </article>
  
  <article id="faq">
--- 107,112 ----
   &loganalysis;
   &help;
!  &supportedplatforms;
!  &releasechecklist;
  
  <article id="faq">
***************
*** 133,138 ****
  </part>
  
- &supportedplatforms;
- &releasechecklist;
  &schemadoc;
  &bookindex;
--- 135,138 ----

Index: filelist.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/filelist.sgml,v
retrieving revision 1.18
retrieving revision 1.19
diff -C2 -d -r1.18 -r1.19
*** filelist.sgml	4 Oct 2006 15:52:13 -0000	1.18
--- filelist.sgml	22 Aug 2007 22:06:47 -0000	1.19
***************
*** 45,48 ****
--- 45,49 ----
  <!entity slonyupgrade       SYSTEM "slonyupgrade.sgml">
  <!entity releasechecklist   SYSTEM "releasechecklist.sgml">
+ <!entity raceconditions     SYSTEM "raceconditions.sgml">
  
  <!-- back matter -->

--- NEW FILE: raceconditions.sgml ---
<!-- $Id: raceconditions.sgml,v 1.1 2007-08-22 22:06:48 cbbrowne Exp $ -->
<sect1 id="raceconditions"><title>Race Conditions and &slony1;</title>

<indexterm><primary>race conditions</primary></indexterm>

<para> No, this has nothing to do with racial harmony or lack thereof;
the <ulink url="http://www.wikipedia.org/"> Wikipedia </ulink>
describes it thus: <quote>A race condition or race hazard is a flaw in
a system or process whereby the output of the process is unexpectedly
and critically dependent on the sequence or timing of other
events. </quote> In computing applications, race conditions arise most
frequently in distributed or threaded applications when multiple parts
of the application depend on some piece of shared state, and, if this
state is not properly managed, confusion (error!) arises. More
particularly, this usually involves situations where the state can
change between the time it was checked and the time of use of the
state. </para>

<para> &slony1; has run into a number of race conditions during its history:

<itemizedlist>

<listitem><para> <xref linkend="stmtmoveset"> had, during the 1.0 and
1.1 branches, the problem that nodes did not have any way to prevent
them from processing <command>SYNC</command> events from the new
origin node (which their state would cause them to consider a mere
provider, and therefore <emphasis>not</emphasis> a source of
replicable data) before recognizing the role change from subscriber to
provider. </para>

<para> This was fixed by introducing a new <command>ACCEPT
SET</command> event that would be submitted by the new origin; this
allowed subscribers to be aware of their need to wait for the
<command> MOVE SET </command> event.</para> </listitem>

<listitem><para>In a number of places, &slony1; has the SQL
<command>lock table sl_config_lock;</command> in order to prevent race
conditions while changing the sl_log_status sequence value. </para>
</listitem>

<listitem><para> The &lslon; option <xref
linkend="slon-config-sync-interval-timeout"> is used to prevent a
possible race condition in which the action sequence is bumped by the
trigger while inserting the log row, which makes this bump is
immediately visible to the sync thread, but where the resulting log
rows are not visible yet.  </para> </listitem>

<listitem><para> The <quote>snapshot visibility</quote> approach used
by &slony1; to determine what replicated data is to be associated with
a specific <command>SYNC</command> avoids race conditions that would
be associated with trying to purely use timestamps or ID ranges to
determine what data is to be replicated.  </para> </listitem>

<listitem><para> In the 1.2 branch, up to version 1.2.11, which fixed
this, <link linkend="logshipping"> log shipping </link> had a race
condition where any time configuration is reloaded by the &lslon; (as
takes place with a number of events, notably <xref
linkend="stmtsubscribeset">), there was a risk of the
<command>SYNC</command> IDs used to ensure proper ordering and
application of log shipping archive log files being off by one.
</para>

<para> This was resolved in 1.2.11 by moving the ID number from an
in-memory variable (susceptible to all sorts of troubles) to being
managed, transaction-safe, in the subscriber database. </para>

<para> The problem was never exposed by the <link linkend="testbed">
test bed framework, </link> nicely demonstrating the common finding
that race conditions are frequently highly dependent on patterns of
data input or of application timing. </para>
</listitem>

</itemizedlist>

</para>

</sect1>

<!-- Keep this comment at the end of the file
Local variables:
mode:sgml
sgml-omittag:nil
sgml-shorttag:t
sgml-minimize-attributes:nil
sgml-always-quote-attributes:t
sgml-indent-step:1
sgml-indent-data:t
sgml-parent-document:"slony.sgml"
sgml-exposed-tags:nil
sgml-local-catalogs:("/usr/lib/sgml/catalog")
sgml-local-ecat-files:nil
End:
-->

From wieck at lists.slony.info  Thu Aug 23 11:04:37 2007
From: wieck at lists.slony.info (Jan Wieck)
Date: Thu Aug 23 11:04:39 2007
Subject: [Slony1-commit] slony1-engine/src/slon remote_worker.c slon.h
Message-ID: <20070823180437.C62DD2903DA@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slon
In directory main.slony.info:/tmp/cvs-serv29999

Modified Files:
      Tag: REL_1_2_STABLE
	remote_worker.c slon.h 
Log Message:
Changing the file name of the archive logs to be based on the
internal archive tracking counter. That way a mechanism that applies
the archives to the offline replica can easily figure out which file
needs to be applied next by looking at sl_archive_tracking.

Jan


Index: remote_worker.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/remote_worker.c,v
retrieving revision 1.124.2.20
retrieving revision 1.124.2.21
diff -C2 -d -r1.124.2.20 -r1.124.2.21
*** remote_worker.c	20 Aug 2007 17:02:28 -0000	1.124.2.20
--- remote_worker.c	23 Aug 2007 18:04:35 -0000	1.124.2.21
***************
*** 256,260 ****
  
  
! static int	archive_open(SlonNode *node, char *seqbuf);
  static int	archive_close(SlonNode *node);
  static void archive_terminate(SlonNode *node);
--- 256,261 ----
  
  
! static int	archive_open(SlonNode *node, char *seqbuf, 
! 					PGconn *dbconn);
  static int	archive_close(SlonNode *node);
  static void archive_terminate(SlonNode *node);
***************
*** 262,267 ****
  static int	archive_append_str(SlonNode *node, const char *s);
  static int	archive_append_data(SlonNode *node, const char *s, int len);
- static int archive_tracking(SlonNode *node, const char *namespace, 
- 					PGconn *local_dbconn);
  
  
--- 263,266 ----
***************
*** 681,689 ****
  			if (archive_dir)
  			{
- 				ProviderInfo   *pinfo;
- 				ProviderSet	   *pset;
  				char			buf[256];
  
! 				if (archive_open(node, seqbuf) < 0)
  					slon_retry();
  				sprintf(buf, "-- %s", event->ev_type);
--- 680,686 ----
  			if (archive_dir)
  			{
  				char			buf[256];
  
! 				if (archive_open(node, seqbuf, local_dbconn) < 0)
  					slon_retry();
  				sprintf(buf, "-- %s", event->ev_type);
***************
*** 691,698 ****
  					slon_retry();
  
- 				if (archive_tracking(node, rtcfg_namespace, 
- 						local_dbconn) < 0)
- 					slon_retry();
- 
  				/*
  				 * Leave the archive open for event specific actions.
--- 688,691 ----
***************
*** 3863,3867 ****
  	if (archive_dir)
  	{
! 		rc = archive_open(node, seqbuf);
  		if (rc < 0)
  		{
--- 3856,3860 ----
  	if (archive_dir)
  	{
! 		rc = archive_open(node, seqbuf, local_dbconn);
  		if (rc < 0)
  		{
***************
*** 4222,4237 ****
  
  		/*
- 		 * Add a call to the archive tracking function to the archive log.
- 		 * This function ensures that all archive log files are applied in
- 		 * the right order.
- 		 */
- 		if (archive_dir)
- 		{
- 			rc = archive_tracking(node, rtcfg_namespace, local_dbconn);
- 			if (rc < 0)
- 				slon_retry();
- 		}
- 
- 		/*
  		 * We didn't add anything good in the provider clause. That shouldn't
  		 * be!
--- 4215,4218 ----
***************
*** 5398,5404 ****
   * - Second, you generate the header using generate_archive_header()
   *
-  * - Third, you need to set up the sync tracking function in the log
-  *	 using logarchive_tracking()
-  *
   * ========  Here Ends The Header of the Log Shipping Archive ========
   *
--- 5379,5382 ----
***************
*** 5424,5429 ****
   */
  static int
! archive_open(SlonNode *node, char *seqbuf)
  {
  	int		i;
  	int		rc;
--- 5402,5409 ----
   */
  static int
! archive_open(SlonNode *node, char *seqbuf, PGconn *dbconn)
  {
+ 	SlonDString query;
+ 	PGresult	*res;
  	int		i;
  	int		rc;
***************
*** 5436,5440 ****
  		node->archive_name = malloc(SLON_MAX_PATH);
  		node->archive_temp = malloc(SLON_MAX_PATH);
! 		if (node->archive_name == NULL || node->archive_temp == NULL)
  		{
  			slon_log(SLON_ERROR, "remoteWorkerThread_%d: "
--- 5416,5423 ----
  		node->archive_name = malloc(SLON_MAX_PATH);
  		node->archive_temp = malloc(SLON_MAX_PATH);
! 		node->archive_counter = malloc(64);
! 		node->archive_timestamp = malloc(256);
! 		if (node->archive_name == NULL || node->archive_temp == NULL || 
! 			node->archive_counter == NULL || node->archive_timestamp == NULL)
  		{
  			slon_log(SLON_ERROR, "remoteWorkerThread_%d: "
***************
*** 5453,5461 ****
  	}
  
  	sprintf(node->archive_name, "%s/slony1_log_%d_", archive_dir, 
  			node->no_id);
! 	for (i = strlen(seqbuf); i < 20; i++)
  		strcat(node->archive_name, "0");
! 	strcat(node->archive_name, seqbuf);
  	strcat(node->archive_name, ".sql");
  	strcpy(node->archive_temp, node->archive_name);
--- 5436,5484 ----
  	}
  
+ 	dstring_init(&query);
+ 	slon_mkquery(&query,
+ 			"update %s.sl_archive_counter "
+ 			"    set ac_num = ac_num + 1, "
+ 			"        ac_timestamp = CURRENT_TIMESTAMP; "
+ 			"select ac_num, ac_timestamp from %s.sl_archive_counter; ",
+ 			rtcfg_namespace, rtcfg_namespace);
+ 	res = PQexec(dbconn, dstring_data(&query));
+ 	if ((rc = PQresultStatus(res)) != PGRES_TUPLES_OK)
+ 	{
+ 		slon_log(SLON_ERROR,
+ 				 "remoteWorkerThread_%d: \"%s\" %s %s\n",
+ 				 node->no_id, dstring_data(&query),
+ 				 PQresStatus(rc),
+ 				 PQresultErrorMessage(res));
+ 		PQclear(res);
+ 		dstring_free(&query);
+ 		return -1;
+ 	}
+ 	if ((rc = PQntuples(res)) != 1)
+ 	{
+ 		slon_log(SLON_ERROR,
+ 				 "remoteWorkerThread_%d: expected 1 row in sl_archive_counter - found %d",
+ 				 node->no_id, rc);
+ 		PQclear(res);
+ 		dstring_free(&query);
+ 		return -1;
+ 	}
+ 	strcpy(node->archive_counter, PQgetvalue(res, 0, 0));
+ 	strcpy(node->archive_timestamp, PQgetvalue(res, 0, 1));
+ 
+ 	PQclear(res);
+ 	dstring_free(&query);
+ 	if (rc < 0)
+ 	{
+ 		slon_log(SLON_ERROR, "remoteWorkerThread_%d: "
+ 				"Cannot write to archive file %s - %s\n",
+ 				node->no_id, node->archive_temp, strerror(errno));
+ 		return -1;
+ 	}
  	sprintf(node->archive_name, "%s/slony1_log_%d_", archive_dir, 
  			node->no_id);
! 	for (i = strlen(node->archive_counter); i < 20; i++)
  		strcat(node->archive_name, "0");
! 	strcat(node->archive_name, node->archive_counter);
  	strcat(node->archive_name, ".sql");
  	strcpy(node->archive_temp, node->archive_name);
***************
*** 5471,5478 ****
  
  	rc = fprintf(node->archive_fp,
! 				   "-- Slony-I log shipping archive\n"
! 				   "-- Node %d, Event %s\n"
! 				   "start transaction;\n",
! 				   node->no_id, seqbuf);
  	if (rc < 0)
  	{
--- 5494,5517 ----
  
  	rc = fprintf(node->archive_fp,
! 		"------------------------------------------------------------------\n"
! 		"-- Slony-I log shipping archive\n"
! 		"-- Node %d, Event %s\n"
! 		"------------------------------------------------------------------\n"
! 		"start transaction;\n",
! 		node->no_id, seqbuf);
! 	if (rc < 0)
! 	{
! 		slon_log(SLON_ERROR, "remoteWorkerThread_%d: "
! 				"Cannot write to archive file %s - %s\n",
! 				node->no_id, node->archive_temp, strerror(errno));
! 		return -1;
! 	}
! 	rc = fprintf(node->archive_fp, 
! 		"select %s.archiveTracking_offline('%s', '%s');\n"
! 		"-- end of log archiving header\n"
! 		"------------------------------------------------------------------\n"
! 		"-- start of Slony-I data\n"
! 		"------------------------------------------------------------------\n",
! 		rtcfg_namespace, node->archive_counter, node->archive_timestamp);
  	if (rc < 0)
  	{
***************
*** 5560,5637 ****
  
  /* ----------
-  * archive_tracking
-  * ----------
-  */
- static int
- archive_tracking(SlonNode *node, const char *namespace, 
- 					PGconn *local_dbconn)
- {
- 	SlonDString query;
- 	PGresult	*res;
- 	int			rc;
- 
- 	if (!archive_dir)
- 		return 0;
- 
- 	dstring_init(&query);
- 	slon_mkquery(&query,
- 			"update %s.sl_archive_counter "
- 			"    set ac_num = ac_num + 1, "
- 			"        ac_timestamp = CURRENT_TIMESTAMP; "
- 			"select ac_num, ac_timestamp from %s.sl_archive_counter; ",
- 			namespace, namespace);
- 	res = PQexec(local_dbconn, dstring_data(&query));
- 	if ((rc = PQresultStatus(res)) != PGRES_TUPLES_OK)
- 	{
- 		slon_log(SLON_ERROR,
- 				 "remoteWorkerThread_%d: \"%s\" %s %s\n",
- 				 node->no_id, dstring_data(&query),
- 				 PQresStatus(rc),
- 				 PQresultErrorMessage(res));
- 		PQclear(res);
- 		dstring_free(&query);
- 		return -1;
- 	}
- 	if ((rc = PQntuples(res)) != 1)
- 	{
- 		slon_log(SLON_ERROR,
- 				 "remoteWorkerThread_%d: expected 1 row in sl_archive_counter - found %d",
- 				 node->no_id, rc);
- 		PQclear(res);
- 		dstring_free(&query);
- 		return -1;
- 	}
- 
- 	if (node->archive_fp == NULL)
- 	{
- 		slon_log(SLON_ERROR, "remoteWorkerThread_%d: "
- 				"Cannot write to archive file %s - not open\n",
- 				node->no_id, node->archive_temp);
- 		PQclear(res);
- 		dstring_free(&query);
- 		return -1;
- 	}
- 
- 	rc = fprintf(node->archive_fp, 
- 		"\nselect %s.archiveTracking_offline('%s', '%s');\n"
- 		"-- end of log archiving header\n"
- 		"------------------------------------------------------------------\n"
- 		"-- start of Slony-I data\n"
- 		"------------------------------------------------------------------\n",
- 		namespace, PQgetvalue(res, 0, 0), PQgetvalue(res, 0, 1));
- 	PQclear(res);
- 	dstring_free(&query);
- 	if (rc < 0)
- 	{
- 		slon_log(SLON_ERROR, "remoteWorkerThread_%d: "
- 				"Cannot write to archive file %s - %s\n",
- 				node->no_id, node->archive_temp, strerror(errno));
- 		return -1;
- 	}
- 
- 	return 0;
- }
- 
- /* ----------
   * archive_append_ds
   * ----------
--- 5599,5602 ----

Index: slon.h
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/slon.h,v
retrieving revision 1.59.2.3
retrieving revision 1.59.2.4
diff -C2 -d -r1.59.2.3 -r1.59.2.4
*** slon.h	27 Oct 2006 20:09:56 -0000	1.59.2.3
--- slon.h	23 Aug 2007 18:04:35 -0000	1.59.2.4
***************
*** 108,111 ****
--- 108,113 ----
  	char	   *archive_name;
  	char	   *archive_temp;
+ 	char	   *archive_counter;
+ 	char	   *archive_timestamp;
  	FILE	   *archive_fp;
  

From wieck at lists.slony.info  Thu Aug 23 11:08:55 2007
From: wieck at lists.slony.info (Jan Wieck)
Date: Thu Aug 23 11:08:56 2007
Subject: [Slony1-commit] slony1-engine/src/slon remote_worker.c
Message-ID: <20070823180855.DD1F9290037@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slon
In directory main.slony.info:/tmp/cvs-serv30153

Modified Files:
      Tag: REL_1_2_STABLE
	remote_worker.c 
Log Message:
little ooops

Jan


Index: remote_worker.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/remote_worker.c,v
retrieving revision 1.124.2.21
retrieving revision 1.124.2.22
diff -C2 -d -r1.124.2.21 -r1.124.2.22
*** remote_worker.c	23 Aug 2007 18:04:35 -0000	1.124.2.21
--- remote_worker.c	23 Aug 2007 18:08:53 -0000	1.124.2.22
***************
*** 5466,5479 ****
  	strcpy(node->archive_counter, PQgetvalue(res, 0, 0));
  	strcpy(node->archive_timestamp, PQgetvalue(res, 0, 1));
- 
  	PQclear(res);
  	dstring_free(&query);
! 	if (rc < 0)
! 	{
! 		slon_log(SLON_ERROR, "remoteWorkerThread_%d: "
! 				"Cannot write to archive file %s - %s\n",
! 				node->no_id, node->archive_temp, strerror(errno));
! 		return -1;
! 	}
  	sprintf(node->archive_name, "%s/slony1_log_%d_", archive_dir, 
  			node->no_id);
--- 5466,5472 ----
  	strcpy(node->archive_counter, PQgetvalue(res, 0, 0));
  	strcpy(node->archive_timestamp, PQgetvalue(res, 0, 1));
  	PQclear(res);
  	dstring_free(&query);
! 
  	sprintf(node->archive_name, "%s/slony1_log_%d_", archive_dir, 
  			node->no_id);

From wieck at lists.slony.info  Thu Aug 23 11:13:01 2007
From: wieck at lists.slony.info (Jan Wieck)
Date: Thu Aug 23 11:13:02 2007
Subject: [Slony1-commit] slony1-engine/src/slon remote_worker.c slon.h
Message-ID: <20070823181301.4515D29002F@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slon
In directory main.slony.info:/tmp/cvs-serv30310

Modified Files:
	remote_worker.c slon.h 
Log Message:
Changing the file name of the archive logs to be based on the
internal archive tracking counter. That way a mechanism that applies
the archives to the offline replica can easily figure out which file
needs to be applied next by looking at sl_archive_tracking.

Jan


Index: remote_worker.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/remote_worker.c,v
retrieving revision 1.151
retrieving revision 1.152
diff -C2 -d -r1.151 -r1.152
*** remote_worker.c	20 Aug 2007 18:22:26 -0000	1.151
--- remote_worker.c	23 Aug 2007 18:12:59 -0000	1.152
***************
*** 253,257 ****
  
  
! static int	archive_open(SlonNode *node, char *seqbuf);
  static int	archive_close(SlonNode *node);
  static void archive_terminate(SlonNode *node);
--- 253,258 ----
  
  
! static int	archive_open(SlonNode *node, char *seqbuf, 
! 					PGconn *dbconn);
  static int	archive_close(SlonNode *node);
  static void archive_terminate(SlonNode *node);
***************
*** 259,264 ****
  static int	archive_append_str(SlonNode *node, const char *s);
  static int	archive_append_data(SlonNode *node, const char *s, int len);
- static int archive_tracking(SlonNode *node, const char *namespace, 
- 					PGconn *local_dbconn);
  
  
--- 260,263 ----
***************
*** 680,688 ****
  			if (archive_dir)
  			{
- 				ProviderInfo   *pinfo;
- 				ProviderSet	   *pset;
  				char			buf[256];
  
! 				if (archive_open(node, seqbuf) < 0)
  					slon_retry();
  				sprintf(buf, "-- %s", event->ev_type);
--- 679,685 ----
  			if (archive_dir)
  			{
  				char			buf[256];
  
! 				if (archive_open(node, seqbuf, local_dbconn) < 0)
  					slon_retry();
  				sprintf(buf, "-- %s", event->ev_type);
***************
*** 690,697 ****
  					slon_retry();
  
- 				if (archive_tracking(node, rtcfg_namespace, 
- 						local_dbconn) < 0)
- 					slon_retry();
- 
  				/*
  				 * Leave the archive open for event specific actions.
--- 687,690 ----
***************
*** 3471,3475 ****
  	if (archive_dir)
  	{
! 		rc = archive_open(node, seqbuf);
  		if (rc < 0)
  		{
--- 3464,3468 ----
  	if (archive_dir)
  	{
! 		rc = archive_open(node, seqbuf, local_dbconn);
  		if (rc < 0)
  		{
***************
*** 3833,3848 ****
  
  		/*
- 		 * Add a call to the archive tracking function to the archive log.
- 		 * This function ensures that all archive log files are applied in
- 		 * the right order.
- 		 */
- 		if (archive_dir)
- 		{
- 			rc = archive_tracking(node, rtcfg_namespace, local_dbconn);
- 			if (rc < 0)
- 				slon_retry();
- 		}
- 
- 		/*
  		 * We didn't add anything good in the provider clause. That shouldn't
  		 * be!
--- 3826,3829 ----
***************
*** 4969,4975 ****
   * - Second, you generate the header using generate_archive_header()
   *
-  * - Third, you need to set up the sync tracking function in the log
-  *	 using logarchive_tracking()
-  *
   * ========  Here Ends The Header of the Log Shipping Archive ========
   *
--- 4950,4953 ----
***************
*** 4995,5000 ****
   */
  static int
! archive_open(SlonNode *node, char *seqbuf)
  {
  	int		i;
  	int		rc;
--- 4973,4980 ----
   */
  static int
! archive_open(SlonNode *node, char *seqbuf, PGconn *dbconn)
  {
+ 	SlonDString query;
+ 	PGresult	*res;
  	int		i;
  	int		rc;
***************
*** 5007,5011 ****
  		node->archive_name = malloc(SLON_MAX_PATH);
  		node->archive_temp = malloc(SLON_MAX_PATH);
! 		if (node->archive_name == NULL || node->archive_temp == NULL)
  		{
  			slon_log(SLON_ERROR, "remoteWorkerThread_%d: "
--- 4987,4994 ----
  		node->archive_name = malloc(SLON_MAX_PATH);
  		node->archive_temp = malloc(SLON_MAX_PATH);
! 		node->archive_counter = malloc(64);
! 		node->archive_timestamp = malloc(256);
! 		if (node->archive_name == NULL || node->archive_temp == NULL || 
! 			node->archive_counter == NULL || node->archive_timestamp == NULL)
  		{
  			slon_log(SLON_ERROR, "remoteWorkerThread_%d: "
***************
*** 5024,5032 ****
  	}
  
  	sprintf(node->archive_name, "%s/slony1_log_%d_", archive_dir, 
  			node->no_id);
! 	for (i = strlen(seqbuf); i < 20; i++)
  		strcat(node->archive_name, "0");
! 	strcat(node->archive_name, seqbuf);
  	strcat(node->archive_name, ".sql");
  	strcpy(node->archive_temp, node->archive_name);
--- 5007,5048 ----
  	}
  
+ 	dstring_init(&query);
+ 	slon_mkquery(&query,
+ 			"update %s.sl_archive_counter "
+ 			"    set ac_num = ac_num + 1, "
+ 			"        ac_timestamp = CURRENT_TIMESTAMP; "
+ 			"select ac_num, ac_timestamp from %s.sl_archive_counter; ",
+ 			rtcfg_namespace, rtcfg_namespace);
+ 	res = PQexec(dbconn, dstring_data(&query));
+ 	if ((rc = PQresultStatus(res)) != PGRES_TUPLES_OK)
+ 	{
+ 		slon_log(SLON_ERROR,
+ 				 "remoteWorkerThread_%d: \"%s\" %s %s\n",
+ 				 node->no_id, dstring_data(&query),
+ 				 PQresStatus(rc),
+ 				 PQresultErrorMessage(res));
+ 		PQclear(res);
+ 		dstring_free(&query);
+ 		return -1;
+ 	}
+ 	if ((rc = PQntuples(res)) != 1)
+ 	{
+ 		slon_log(SLON_ERROR,
+ 				 "remoteWorkerThread_%d: expected 1 row in sl_archive_counter - found %d",
+ 				 node->no_id, rc);
+ 		PQclear(res);
+ 		dstring_free(&query);
+ 		return -1;
+ 	}
+ 	strcpy(node->archive_counter, PQgetvalue(res, 0, 0));
+ 	strcpy(node->archive_timestamp, PQgetvalue(res, 0, 1));
+ 	PQclear(res);
+ 	dstring_free(&query);
+ 	
  	sprintf(node->archive_name, "%s/slony1_log_%d_", archive_dir, 
  			node->no_id);
! 	for (i = strlen(node->archive_counter); i < 20; i++)
  		strcat(node->archive_name, "0");
! 	strcat(node->archive_name, node->archive_counter);
  	strcat(node->archive_name, ".sql");
  	strcpy(node->archive_temp, node->archive_name);
***************
*** 5042,5050 ****
  
  	rc = fprintf(node->archive_fp,
! 				   "-- Slony-I log shipping archive\n"
! 				   "-- Node %d, Event %s\n"
! 				   "set session_replication_role to replica;\n"
! 				   "start transaction;\n",
! 				   node->no_id, seqbuf);
  	if (rc < 0)
  	{
--- 5058,5082 ----
  
  	rc = fprintf(node->archive_fp,
! 		"------------------------------------------------------------------\n"
! 		"-- Slony-I log shipping archive\n"
! 		"-- Node %d, Event %s\n"
! 		"------------------------------------------------------------------\n"
! 		"set session_replication_role to replica;\n"
! 		"start transaction;\n",
! 		node->no_id, seqbuf);
! 	if (rc < 0)
! 	{
! 		slon_log(SLON_ERROR, "remoteWorkerThread_%d: "
! 				"Cannot write to archive file %s - %s\n",
! 				node->no_id, node->archive_temp, strerror(errno));
! 		return -1;
! 	}
! 	rc = fprintf(node->archive_fp,
! 		"select %s.archiveTrackingOffline('%s', '%s');\n"
! 		"-- end of log archiving header\n"
! 		"------------------------------------------------------------------\n"
! 		"-- start of Slony-I data\n"
! 		"------------------------------------------------------------------\n",
! 		rtcfg_namespace, node->archive_counter, node->archive_timestamp);
  	if (rc < 0)
  	{
***************
*** 5132,5209 ****
  
  /* ----------
-  * archive_tracking
-  * ----------
-  */
- static int
- archive_tracking(SlonNode *node, const char *namespace, 
- 					PGconn *local_dbconn)
- {
- 	SlonDString query;
- 	PGresult	*res;
- 	int			rc;
- 
- 	if (!archive_dir)
- 		return 0;
- 
- 	dstring_init(&query);
- 	slon_mkquery(&query,
- 			"update %s.sl_archive_counter "
- 			"    set ac_num = ac_num + 1, "
- 			"        ac_timestamp = CURRENT_TIMESTAMP; "
- 			"select ac_num, ac_timestamp from %s.sl_archive_counter; ",
- 			namespace, namespace);
- 	res = PQexec(local_dbconn, dstring_data(&query));
- 	if ((rc = PQresultStatus(res)) != PGRES_TUPLES_OK)
- 	{
- 		slon_log(SLON_ERROR,
- 				 "remoteWorkerThread_%d: \"%s\" %s %s\n",
- 				 node->no_id, dstring_data(&query),
- 				 PQresStatus(rc),
- 				 PQresultErrorMessage(res));
- 		PQclear(res);
- 		dstring_free(&query);
- 		return -1;
- 	}
- 	if ((rc = PQntuples(res)) != 1)
- 	{
- 		slon_log(SLON_ERROR,
- 				 "remoteWorkerThread_%d: expected 1 row in sl_archive_counter - found %d",
- 				 node->no_id, rc);
- 		PQclear(res);
- 		dstring_free(&query);
- 		return -1;
- 	}
- 
- 	if (node->archive_fp == NULL)
- 	{
- 		slon_log(SLON_ERROR, "remoteWorkerThread_%d: "
- 				"Cannot write to archive file %s - not open\n",
- 				node->no_id, node->archive_temp);
- 		PQclear(res);
- 		dstring_free(&query);
- 		return -1;
- 	}
- 
- 	rc = fprintf(node->archive_fp, 
- 		"\nselect %s.archiveTracking_offline('%s', '%s');\n"
- 		"-- end of log archiving header\n"
- 		"------------------------------------------------------------------\n"
- 		"-- start of Slony-I data\n"
- 		"------------------------------------------------------------------\n",
- 		namespace, PQgetvalue(res, 0, 0), PQgetvalue(res, 0, 1));
- 	PQclear(res);
- 	dstring_free(&query);
- 	if (rc < 0)
- 	{
- 		slon_log(SLON_ERROR, "remoteWorkerThread_%d: "
- 				"Cannot write to archive file %s - %s\n",
- 				node->no_id, node->archive_temp, strerror(errno));
- 		return -1;
- 	}
- 
- 	return 0;
- }
- 
- /* ----------
   * archive_append_ds
   * ----------
--- 5164,5167 ----

Index: slon.h
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/slon.h,v
retrieving revision 1.63
retrieving revision 1.64
diff -C2 -d -r1.63 -r1.64
*** slon.h	20 Apr 2007 20:53:18 -0000	1.63
--- slon.h	23 Aug 2007 18:12:59 -0000	1.64
***************
*** 111,114 ****
--- 111,116 ----
  	char	   *archive_name;
  	char	   *archive_temp;
+ 	char	   *archive_counter;
+ 	char	   *archive_timestamp;
  	FILE	   *archive_fp;
  

From cbbrowne at lists.slony.info  Thu Aug 23 15:10:38 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Thu Aug 23 15:10:39 2007
Subject: [Slony1-commit] slony1-engine RELEASE
Message-ID: <20070823221038.197AD29002F@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine
In directory main.slony.info:/tmp/cvs-serv1069

Modified Files:
      Tag: REL_1_2_STABLE
	RELEASE 
Log Message:
Note change recently committed


Index: RELEASE
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/RELEASE,v
retrieving revision 1.1.2.11
retrieving revision 1.1.2.12
diff -C2 -d -r1.1.2.11 -r1.1.2.12
*** RELEASE	20 Aug 2007 22:35:32 -0000	1.1.2.11
--- RELEASE	23 Aug 2007 22:10:36 -0000	1.1.2.12
***************
*** 44,47 ****
--- 44,52 ----
    the offline replica and must increment gap free.
  
+ - Change the filenames of archive logs to be based on internal archive
+   tracking number.  This makes it easy for the mechanism applying
+   archives to figure out what needs to be applied next - just look in
+   sl_archive_tracking.
+ 
  RELEASE 1.2.10
  

From cbbrowne at lists.slony.info  Mon Aug 27 08:40:47 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Mon Aug 27 08:40:49 2007
Subject: [Slony1-commit] slony1-engine/tests/testlogship generate_dml.sh
Message-ID: <20070827154047.6A9DD290030@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/tests/testlogship
In directory main.slony.info:/tmp/cvs-serv5927/testlogship

Modified Files:
      Tag: REL_1_2_STABLE
	generate_dml.sh 
Log Message:
Update log shipping test to search for log files in the fashion now
supported by the new file naming convention.


Index: generate_dml.sh
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tests/testlogship/generate_dml.sh,v
retrieving revision 1.1.2.5
retrieving revision 1.1.2.6
diff -C2 -d -r1.1.2.5 -r1.1.2.6
*** generate_dml.sh	20 Aug 2007 22:33:42 -0000	1.1.2.5
--- generate_dml.sh	27 Aug 2007 15:40:45 -0000	1.1.2.6
***************
*** 133,139 ****
  
    status "final data load complete - now load files into log shipped node"
!   for logfile in `/usr/bin/find ${mktmp}/archive_logs_2 -name "slony1_log_*.sql" -type f | sort`; do
!     $pgbindir/psql -h ${HOST3} -p ${PORT3} -d ${DB3} -U ${USER3} -f ${logfile} >> $mktmp/logshipping_output.log 2>> $mktmp/logshipping_errors.log
!     status "load file ${logfile} - ${?}"
    done
    status "done"
--- 133,154 ----
  
    status "final data load complete - now load files into log shipped node"
!   firstseq=`(cd ${mktmp}/archive_logs_2; /usr/bin/find -name "*.sql") | cut -d "_" -f 4 | cut -d "." -f 1 | sort -n | head -1`
!   lastseq=`(cd ${mktmp}/archive_logs_2; /usr/bin/find -name "*.sql") | cut -d "_" -f 4 | cut -d "." -f 1 | sort -n | tail -1`
!   status "Logs numbered from ${firstseq} to ${lastseq}"
!   currseq=${firstseq}
!   while : ; do
! #      00000000000000000000
! #      12345678901234567890
!     cs=`printf "%020d" ${currseq}`
!     status "current sequence value: ${cs}"
!     for logfile in `/usr/bin/find ${mktmp}/archive_logs_2 -name "slony1_log_*_${cs}.sql" -type f`; do
!       $pgbindir/psql -h ${HOST3} -p ${PORT3} -d ${DB3} -U ${USER3} -f ${logfile} >> $mktmp/logshipping_output.log 2>> $mktmp/logshipping_errors.log
!       status "load file ${logfile} - ${?}"
!     done
!     if [ ${currseq} -gt ${lastseq} ]; then
!       break;
!     else
!       currseq=`expr ${currseq} + 1`
!     fi
    done
    status "done"

From cbbrowne at lists.slony.info  Mon Aug 27 08:43:05 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Mon Aug 27 08:43:06 2007
Subject: [Slony1-commit] slony1-engine/tests/testlogship ddl_updates.sql
	generate_dml.sh init_data.sql init_subscribe_set.ik
	moveset.sh settings.ik
Message-ID: <20070827154305.DEA38290036@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/tests/testlogship
In directory main.slony.info:/tmp/cvs-serv6028

Modified Files:
	ddl_updates.sql generate_dml.sh init_data.sql 
	init_subscribe_set.ik settings.ik 
Added Files:
	moveset.sh 
Log Message:
Commit a host of changes made in 1.2 branch to log shipping tests to HEAD


Index: settings.ik
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tests/testlogship/settings.ik,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** settings.ik	20 Apr 2007 20:54:55 -0000	1.2
--- settings.ik	27 Aug 2007 15:43:03 -0000	1.3
***************
*** 1,6 ****
  NUMCLUSTERS=${NUMCLUSTERS:-"1"}
! NUMNODES=${NUMNODES:-"3"}
  ORIGINNODE=1
  WORKERS=${WORKERS:-"1"}
  ARCHIVE2=true   # Node #2 needs to run log archiving
! LOGSHIP3=true   # Node #3 receives data via log shipping
\ No newline at end of file
--- 1,6 ----
  NUMCLUSTERS=${NUMCLUSTERS:-"1"}
! NUMNODES=${NUMNODES:-"4"}
  ORIGINNODE=1
  WORKERS=${WORKERS:-"1"}
  ARCHIVE2=true   # Node #2 needs to run log archiving
! LOGSHIP3=true   # Node #3 receives data via log shipping

--- NEW FILE: moveset.sh ---
testname=$1
echo "
  LOCK SET ( ID = 1, ORIGIN = 1 );
  MOVE SET ( ID = 1, OLD ORIGIN = 1, NEW ORIGIN = 4 );
"

Index: generate_dml.sh
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tests/testlogship/generate_dml.sh,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** generate_dml.sh	20 Apr 2007 21:43:14 -0000	1.3
--- generate_dml.sh	27 Aug 2007 15:43:03 -0000	1.4
***************
*** 43,50 ****
      rb=$(random_number 1 9)
      rc=$(random_number 1 9)
!     echo "INSERT INTO table1(data) VALUES ('${txta}');" >> $GENDATA
!     echo "INSERT INTO table2(table1_id,data) SELECT id, '${txtb}' FROM table1 WHERE data='${txta}';" >> $GENDATA
!     echo "INSERT INTO table3(table2_id) SELECT id FROM table2 WHERE data ='${txtb}';" >> $GENDATA
!     echo "INSERT INTO table5(numcol,realcol,ptcol,pathcol,polycol,circcol,ipcol,maccol,bitcol) values ('${ra}${rb}.${rc}','${ra}.${rb}${rc}','(${ra},${rb})','((${ra},${ra}),(${rb},${rb}),(${rc},${rc}),(${ra},${rc}))','((${ra},${rb}),(${rc},${ra}),(${rb},${rc}),(${rc},${rb}))','<(${ra},${rb}),${rc}>','192.168.${ra}.${rb}${rc}','08:00:2d:0${ra}:0${rb}:0${rc}',X'${ra}${rb}${rc}');" >> $GENDATA
      if [ ${i} -ge ${numrows} ]; then
        break;
--- 43,50 ----
      rb=$(random_number 1 9)
      rc=$(random_number 1 9)
!     echo "INSERT INTO table1(data) VALUES ('${txta} - Gross C format string: %d%05d%s%s%f%l%-72.52LG');" >> ${GENDATA}
!     echo "INSERT INTO table2(table1_id,data) SELECT id, '${txtb}' FROM table1 WHERE data='${txta}';" >> ${GENDATA}
!     echo "INSERT INTO table3(table2_id) SELECT id FROM table2 WHERE data ='${txtb}';" >> ${GENDATA}
!     echo "INSERT INTO table4(numcol,realcol,ptcol,pathcol,polycol,circcol,ipcol,maccol,bitcol) values ('${ra}${rb}.${rc}','${ra}.${rb}${rc}','(${ra},${rb})','((${ra},${ra}),(${rb},${rb}),(${rc},${rc}),(${ra},${rc}))','((${ra},${rb}),(${rc},${ra}),(${rb},${rc}),(${rc},${rb}))','<(${ra},${rb}),${rc}>','192.168.${ra}.${rb}${rc}','08:00:2d:0${ra}:0${rb}:0${rc}',X'${ra}${rb}${rc}');" >> ${GENDATA}
      if [ ${i} -ge ${numrows} ]; then
        break;
***************
*** 87,90 ****
--- 87,92 ----
    status "pull log shipping dump" 
    PGHOST=${HOST2} PGPORT=${PORT2} PGUSER=${USER2} ${SLTOOLDIR}/slony1_dump.sh ${DB2} ${CLUSTER1} > ${mktmp}/logship_dump.sql
+   status "load schema for replicated tables into node #3"
+   ${PGBINDIR3}/psql -h ${HOST3} -p ${PORT3} -U ${USER3} -d ${DB3} -f ${testname}/init_schema.sql
    status "load log shipping dump into node #3"
    ${PGBINDIR3}/psql -h ${HOST3} -p ${PORT3} -U ${USER3} -d ${DB3} -f ${mktmp}/logship_dump.sql
***************
*** 113,120 ****
  
    wait_for_catchup
!   status "second data load complete - now load files into log shipped node"
!   for logfile in `/usr/bin/find ${mktmp}/archive_logs_2 -name "slony1_log_*.sql" -type f | sort`; do
!     $pgbindir/psql -h ${HOST3} -p ${PORT3} -d ${DB3} -U ${USER3} -f ${logfile} >> $mktmp/logshipping_output.log 2>> $mktmp/logshipping_errors.log
!     status "load file ${logfile} - ${?}"
    done
    status "done"
--- 115,154 ----
  
    wait_for_catchup
! 
!   status "move set to node 4"
! 
!   init_preamble
!   sh ${testname}/moveset.sh ${testname} >> $SCRIPT
!   do_ik
! 
!   status "origin moved"
! 
!   generate_initdata
!   eval db=\$DB4
!   status "loading extra data to node $db"
!   $pgbindir/psql -h $host -p $port -U $user -d $db < $mktmp/generate.data 1> ${mktmp}/even_more_data.log 2> ${mktmp}/even_more_data.log2
! 
!   wait_for_catchup
! 
! 
!   status "final data load complete - now load files into log shipped node"
!   firstseq=`(cd ${mktmp}/archive_logs_2; /usr/bin/find -name "*.sql") | cut -d "_" -f 4 | cut -d "." -f 1 | sort -n | head -1`
!   lastseq=`(cd ${mktmp}/archive_logs_2; /usr/bin/find -name "*.sql") | cut -d "_" -f 4 | cut -d "." -f 1 | sort -n | tail -1`
!   status "Logs numbered from ${firstseq} to ${lastseq}"
!   currseq=${firstseq}
!   while : ; do
! #      00000000000000000000
! #      12345678901234567890
!     cs=`printf "%020d" ${currseq}`
!     status "current sequence value: ${cs}"
!     for logfile in `/usr/bin/find ${mktmp}/archive_logs_2 -name "slony1_log_*_${cs}.sql" -type f`; do
!       $pgbindir/psql -h ${HOST3} -p ${PORT3} -d ${DB3} -U ${USER3} -f ${logfile} >> $mktmp/logshipping_output.log 2>> $mktmp/logshipping_errors.log
!       status "load file ${logfile} - ${?}"
!     done
!     if [ ${currseq} -gt ${lastseq} ]; then
!       break;
!     else
!       currseq=`expr ${currseq} + 1`
!     fi
    done
    status "done"

Index: ddl_updates.sql
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tests/testlogship/ddl_updates.sql,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** ddl_updates.sql	20 Apr 2007 21:43:14 -0000	1.2
--- ddl_updates.sql	27 Aug 2007 15:43:03 -0000	1.3
***************
*** 3,4 ****
--- 3,6 ----
  alter table table4 add column newint integer;
  update table4 set newint = 42;
+ -- The following tries to exercise any cases where DDL statements might be evaluated by printf()
+ update table1 set data = data || '%d%s%s%s%s%f%l%d%s%f%p%d%f' where id in (select id from table1 order by id desc limit 150);
\ No newline at end of file

Index: init_data.sql
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tests/testlogship/init_data.sql,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** init_data.sql	20 Apr 2007 20:54:55 -0000	1.2
--- init_data.sql	27 Aug 2007 15:43:03 -0000	1.3
***************
*** 6,8 ****
  INSERT INTO table4(numcol,realcol,ptcol,pathcol,polycol,circcol,ipcol,maccol,bitcol) values ('74.0','7.40','(7,4)','((7,7),(4,4),(0,0),(7,0))','((7,4),(0,7),(4,0),(0,4))','<(7,4),0>','192.168.7.40','08:00:2d:07:04:00',X'740');
  
! INSERT INTO table4(numcol,realcol,ptcol,pathcol,polycol,circcol,ipcol,maccol,bitcol) values ('93.1','9.31','(9,3)','((9,9),(3,3),(1,1),(9,1))','((9,3),(1,9),(3,1),(1,3))','<(9,3),1>','192.168.9.31','08:00:2d:09:03:01',X'931');
\ No newline at end of file
--- 6,10 ----
  INSERT INTO table4(numcol,realcol,ptcol,pathcol,polycol,circcol,ipcol,maccol,bitcol) values ('74.0','7.40','(7,4)','((7,7),(4,4),(0,0),(7,0))','((7,4),(0,7),(4,0),(0,4))','<(7,4),0>','192.168.7.40','08:00:2d:07:04:00',X'740');
  
! INSERT INTO table4(numcol,realcol,ptcol,pathcol,polycol,circcol,ipcol,maccol,bitcol) values ('93.1','9.31','(9,3)','((9,9),(3,3),(1,1),(9,1))','((9,3),(1,9),(3,1),(1,3))','<(9,3),1>','192.168.9.31','08:00:2d:09:03:01',X'931');
! 
! insert into table1 (data) values ('Evil C Format String: %d%05d%s%f%G%p%n%ld');
\ No newline at end of file

Index: init_subscribe_set.ik
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tests/testlogship/init_subscribe_set.ik,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** init_subscribe_set.ik	20 Apr 2007 20:54:55 -0000	1.2
--- init_subscribe_set.ik	27 Aug 2007 15:43:03 -0000	1.3
***************
*** 3,4 ****
--- 3,8 ----
  sleep (seconds = 2);
  echo 'done sleeping...';
+ subscribe set (id = 1, provider = 1, receiver = 4, forward = yes);
+ echo 'sleep a couple of seconds...';
+ sleep (seconds = 2);
+ echo 'done sleeping...';

From cbbrowne at lists.slony.info  Mon Aug 27 15:23:31 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Mon Aug 27 15:23:32 2007
Subject: [Slony1-commit] slony1-engine/doc/adminguide slonconf.sgml
Message-ID: <20070827222331.8D24D290C4C@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/doc/adminguide
In directory main.slony.info:/tmp/cvs-serv21981/doc/adminguide

Modified Files:
	slonconf.sgml 
Log Message:
Fix consistency of documentation against slon defaults per David Rees


Index: slonconf.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/slonconf.sgml,v
retrieving revision 1.17
retrieving revision 1.18
diff -C2 -d -r1.17 -r1.18
*** slonconf.sgml	27 Jun 2007 17:56:11 -0000	1.17
--- slonconf.sgml	27 Aug 2007 22:23:29 -0000	1.18
***************
*** 317,321 ****
            subscriber catches up, it will apply every single
            <command>SYNC</command> by itself.  Range: [0,10000], default:
!           6
          </para>
        </listitem>
--- 317,321 ----
            subscriber catches up, it will apply every single
            <command>SYNC</command> by itself.  Range: [0,10000], default:
!           20
          </para>
        </listitem>

From cbbrowne at lists.slony.info  Mon Aug 27 15:23:35 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Mon Aug 27 15:23:36 2007
Subject: [Slony1-commit] slony1-engine/doc/adminguide slonconf.sgml
Message-ID: <20070827222335.93ABB290C52@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/doc/adminguide
In directory main.slony.info:/tmp/cvs-serv21994/doc/adminguide

Modified Files:
      Tag: REL_1_2_STABLE
	slonconf.sgml 
Log Message:
Fix consistency of documentation against slon defaults per David Rees


Index: slonconf.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/slonconf.sgml,v
retrieving revision 1.14.2.2
retrieving revision 1.14.2.3
diff -C2 -d -r1.14.2.2 -r1.14.2.3
*** slonconf.sgml	16 Mar 2007 19:01:26 -0000	1.14.2.2
--- slonconf.sgml	27 Aug 2007 22:23:33 -0000	1.14.2.3
***************
*** 312,316 ****
            subscriber catches up, it will apply every single
            <command>SYNC</command> by itself.  Range: [0,10000], default:
!           6
          </para>
        </listitem>
--- 312,316 ----
            subscriber catches up, it will apply every single
            <command>SYNC</command> by itself.  Range: [0,10000], default:
!           20
          </para>
        </listitem>

From cbbrowne at lists.slony.info  Tue Aug 28 11:17:51 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Aug 28 11:17:53 2007
Subject: [Slony1-commit] slony1-engine TODO
Message-ID: <20070828181751.D1B5C290C4A@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine
In directory main.slony.info:/tmp/cvs-serv20067

Modified Files:
	TODO 
Log Message:
Add in new TODO items that Chris plans to work on Real Soon Now


Index: TODO
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/TODO,v
retrieving revision 1.10
retrieving revision 1.11
diff -C2 -d -r1.10 -r1.11
*** TODO	13 Jul 2007 22:08:23 -0000	1.10
--- TODO	28 Aug 2007 18:17:49 -0000	1.11
***************
*** 27,30 ****
--- 27,53 ----
    Jan working on this
  
+ - UPDATE FUNCTIONS needs to be able to reload version-specific
+   functions in v2.0, so that if we do an upgrade via:
+     "pg_dump -p $OLDVPORT dbname | psql -p $NEWVERPORT -d dbname"
+   we may then run "UPDATE FUNCTIONS" to tell the instance to know
+   about the new PostgreSQL version.
+ 
+   This probably involves refactoring the code that loads the
+   version-specific SQL into a function that is called by both STORE
+   NODE and UPDATE FUNCTIONS.
+ 
+ - Script to "duplicate node"; create a new node that looks just like
+   an existing node, that is, with the same replication sets.
+ 
+   Overview:
+    - Run slony1_extract_schema.sh against the origin node for the sets
+      subscribed to; this gives an SQL script.
+ 
+    - Generate slonik script to do:
+      * STORE NODE for new node
+      * STORE PATH to get the new node to communicate with the node it's
+        duplicating
+      * SUBSCRIBE SET for all the relevant sets
+ 
  Longer Term Items
  ---------------------------
***************
*** 43,46 ****
--- 66,75 ----
    problems.
  
+ - Partitioning Support
+ 
+   Add stored procedures to support adding in subscriptions to empty
+   tables; verify emptiness on origin, TRUNCATE on subscribers.  The
+   stored proc(s) would be run as part of EXECUTE SCRIPT...
+ 
  - Use PGXS
  
***************
*** 116,117 ****
--- 145,150 ----
      - Omit columns on a subscriber
      - Omit tuples
+ 
+ SL-Set
+ 
+ - Could it have some policy in it as to preferred failover targets?
\ No newline at end of file

From cbbrowne at lists.slony.info  Tue Aug 28 12:18:14 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Aug 28 12:18:16 2007
Subject: [Slony1-commit] slony1-engine/doc/adminguide schemadoc.xml
Message-ID: <20070828191814.E8412290C17@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/doc/adminguide
In directory main.slony.info:/tmp/cvs-serv21213

Modified Files:
      Tag: REL_1_2_STABLE
	schemadoc.xml 
Log Message:
Commit latest version of schema docs


Index: schemadoc.xml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/schemadoc.xml,v
retrieving revision 1.7
retrieving revision 1.7.2.1
diff -C2 -d -r1.7 -r1.7.2.1
*** schemadoc.xml	31 Jul 2006 18:56:24 -0000	1.7
--- schemadoc.xml	28 Aug 2007 19:18:12 -0000	1.7.2.1
***************
*** 1,2 ****
--- 1,3 ----
+ <?xml version="1.0" encoding="UTF-8" ?>
  <!-- $Header$ -->
  
***************
*** 12,15 ****
--- 13,92 ----
  
  
+       <section id="table.sl-archive-counter"
+                xreflabel="sl_archive_counter">
+         <title id="table.sl-archive-counter-title">
+          Table:
+          
+          <structname>sl_archive_counter</structname>
+         </title>
+  
+ 
+         <para>
+           Table used to generate the log shipping archive number.
+ 
+         </para>
+ 
+ 
+         <para>
+           <variablelist>
+             <title>
+               Structure of <structname>sl_archive_counter</structname>
+             </title>
+ 
+ 
+             <varlistentry>
+               <term><structfield>ac_num</structfield></term>
+               <listitem><para>
+                 <type>bigint</type>
+ 
+ 
+ 
+ 
+ 
+ 
+ 
+               </para>
+ 
+               <para>
+                 Counter of SYNC ID used in log shipping as the archive number
+               </para>
+ 
+             </listitem>
+           </varlistentry>
+ 
+             <varlistentry>
+               <term><structfield>ac_timestamp</structfield></term>
+               <listitem><para>
+                 <type>timestamp without time zone</type>
+ 
+ 
+ 
+ 
+ 
+ 
+ 
+               </para>
+ 
+               <para>
+                 Time at which the archive log was generated on the subscriber
+               </para>
+ 
+             </listitem>
+           </varlistentry>
+ 
+         </variablelist>
+ 
+ 
+ 
+ 
+ 
+ 
+ 
+ 
+ 
+ 
+       </para>
+     </section>
+ 
        <section id="table.sl-config-lock"
                 xreflabel="sl_config_lock">
***************
*** 47,50 ****
--- 124,131 ----
                </para>
  
+               <para>
+                 No data ever goes in this table so the contents never matter.  Indeed, this column does not really need to exist.
+               </para>
+ 
              </listitem>
            </varlistentry>
***************
*** 3037,3042 ****
--- 3118,3125 ----
  	v_log			int4;
  	v_dummy		record;
+ 	v_dummy2	record;
  	idef 		text;
  	v_count		int4;
+         v_iname         text;
  BEGIN
  	v_count := 0;
***************
*** 3053,3076 ****
  		v_log := 1;
  	end if;
! 
  	-- Add missing indices...
! 	for v_dummy in select distinct set_origin from sl_set
! 		where not exists 
!                      (select * from pg_catalog.pg_indexes where schemaname = &#39;schemadoc&#39;
!                       and tablename = &#39;sl_log_&#39; || v_log and 
!                       indexname = &#39;PartInd_schemadoc_sl_log_&#39; || v_log || &#39;-node-&#39; || set_origin) loop	   
  		idef := &#39;create index &quot;PartInd_schemadoc_sl_log_&#39; || v_log || &#39;-node-&#39; || v_dummy.set_origin ||
                          &#39;&quot; on sl_log_&#39; || v_log || &#39; USING btree(log_xid xxid_ops) where (log_origin = &#39; || v_dummy.set_origin || &#39;);&#39;;
  		execute idef;
  		v_count := v_count + 1;
  	end loop;
  
  	-- Remove unneeded indices...
! 	for v_dummy in select indexname from pg_catalog.pg_indexes i where i.schemaname = &#39;@NAMESPACE&#39;
!                        and i.tablename = &#39;sl_log_&#39; || v_log and
                         not exists (select 1 from sl_set where
  				i.indexname = &#39;PartInd_schemadoc_sl_log_&#39; || v_log || &#39;-node-&#39; || set_origin)
  	loop
! 		idef := &#39;drop index &quot;schemadoc&quot;.&quot;&#39; || v_dummy.indexname || &#39;&quot;;&#39;;
  		execute idef;
  		v_count := v_count - 1;
--- 3136,3165 ----
  		v_log := 1;
  	end if;
! --                                       PartInd_test_db_sl_log_2-node-1
  	-- Add missing indices...
! 	for v_dummy in select distinct set_origin from sl_set loop
!             v_iname := &#39;PartInd_schemadoc_sl_log_&#39; || v_log || &#39;-node-&#39; || v_dummy.set_origin;
! 	    -- raise notice &#39;Consider adding partial index % on sl_log_%&#39;, v_iname, v_log;
! 	    -- raise notice &#39;schema: [_schemadoc] tablename:[sl_log_%]&#39;, v_log;
!             select * into v_dummy2 from pg_catalog.pg_indexes where tablename = &#39;sl_log_&#39; || v_log and  indexname = v_iname;
!             if not found then
! 		-- raise notice &#39;index was not found - add it!&#39;;
  		idef := &#39;create index &quot;PartInd_schemadoc_sl_log_&#39; || v_log || &#39;-node-&#39; || v_dummy.set_origin ||
                          &#39;&quot; on sl_log_&#39; || v_log || &#39; USING btree(log_xid xxid_ops) where (log_origin = &#39; || v_dummy.set_origin || &#39;);&#39;;
  		execute idef;
  		v_count := v_count + 1;
+             else
+                 -- raise notice &#39;Index % already present - skipping&#39;, v_iname;
+             end if;
  	end loop;
  
  	-- Remove unneeded indices...
! 	for v_dummy in select indexname from pg_catalog.pg_indexes i where i.tablename = &#39;sl_log_&#39; || v_log and
!                        i.indexname like (&#39;PartInd_schemadoc_sl_log_&#39; || v_log || &#39;-node-%&#39;) and
                         not exists (select 1 from sl_set where
  				i.indexname = &#39;PartInd_schemadoc_sl_log_&#39; || v_log || &#39;-node-&#39; || set_origin)
  	loop
! 		-- raise notice &#39;Dropping obsolete index %d&#39;, v_dummy.indexname;
! 		idef := &#39;drop index &quot;&#39; || v_dummy.indexname || &#39;&quot;;&#39;;
  		execute idef;
  		v_count := v_count - 1;
***************
*** 3538,3541 ****
--- 3627,3633 ----
          end if;
  
+ 	if exists (select * from &quot;pg_catalog&quot;.pg_class c, &quot;pg_catalog&quot;.pg_namespace n, &quot;pg_catalog&quot;.pg_attribute a where c.relname = &#39;sl_seqlog&#39; and n.oid = c.relnamespace and a.attrelid = c.oid and a.attname = &#39;oid&#39;) then
+                 execute &#39;alter table sl_seqlog set without oids;&#39;;
+ 	end if;		
  	-- ----
  	-- Also remove stale entries from the nodelock table.
***************
*** 3938,3943 ****
  begin
  	perform updateRelname(p_set_id, p_only_on_node);
! 	return  createEvent(&#39;_schemadoc&#39;, &#39;DDL_SCRIPT&#39;, 
! 			p_set_id, p_script, p_only_on_node);
  end;
  </programlisting>
--- 4030,4042 ----
  begin
  	perform updateRelname(p_set_id, p_only_on_node);
! 	if p_only_on_node = -1 then
! 		perform alterTableForReplication(tab_id) from sl_table where tab_set in (select set_id from sl_set where set_origin = getLocalNodeId(&#39;_schemadoc&#39;));
! 
! 		return  createEvent(&#39;_schemadoc&#39;, &#39;DDL_SCRIPT&#39;, 
! 			p_set_id::text, p_script::text, p_only_on_node::text);
! 	else
! 		perform alterTableForReplication(tab_id) from sl_table;
! 	end if;
! 	return NULL;
  end;
  </programlisting>
***************
*** 4025,4030 ****
--- 4124,4132 ----
  	lock table sl_config_lock;
  
+ 	
  	-- ----
  	-- Check that the set exists and originates here
+ 	-- unless only_on_node was specified (then it can be applied to
+ 	-- that node because that is what the user wanted)
  	-- ----
  	select set_origin into v_set_origin
***************
*** 4035,4047 ****
  		raise exception &#39;Slony-I: set % not found&#39;, p_set_id;
  	end if;
! 	if v_set_origin &lt;&gt; getLocalNodeId(&#39;_schemadoc&#39;) then
! 		raise exception &#39;Slony-I: set % does not originate on local node&#39;,
  				p_set_id;
  	end if;
- 
- 	-- ----
- 	-- Create a SYNC event, run the script and generate the DDL_SCRIPT event
- 	-- ----
- 	perform createEvent(&#39;_schemadoc&#39;, &#39;SYNC&#39;, NULL);
  	return 1;
  end;
--- 4137,4157 ----
  		raise exception &#39;Slony-I: set % not found&#39;, p_set_id;
  	end if;
! 
! 	if p_only_on_node = -1 then
! 		if v_set_origin &lt;&gt; getLocalNodeId(&#39;_schemadoc&#39;) then
! 			raise exception &#39;Slony-I: set % does not originate on local node&#39;,
  				p_set_id;
+ 		end if;
+ 		-- ----
+ 		-- Create a SYNC event, run the script and generate the DDL_SCRIPT event
+ 		-- ----
+ 		perform createEvent(&#39;_schemadoc&#39;, &#39;SYNC&#39;, NULL);
+ 		perform alterTableRestore(tab_id) from sl_table where tab_set in (select set_id from sl_set where set_origin = getLocalNodeId(&#39;_schemadoc&#39;));
+ 	else
+ 		-- ----
+ 		-- If doing &quot;only on one node&quot; - restore ALL tables irrespective of set
+ 		-- ----
+ 		perform alterTableRestore(tab_id) from sl_table;
  	end if;
  	return 1;
  end;
***************
*** 4148,4152 ****
          <seglistitem>
           <seg>C</seg>
!          <seg>&quot;trigger&quot;</seg>
          </seglistitem>
         </segmentedlist>
--- 4258,4262 ----
          <seglistitem>
           <seg>C</seg>
!          <seg>trigger</seg>
          </seglistitem>
         </segmentedlist>
***************
*** 4639,4643 ****
  	
  	return  createEvent (&#39;_schemadoc&#39;, &#39;DROP_LISTEN&#39;,
! 			p_li_origin, p_li_provider, p_li_receiver);
  end;
  </programlisting>
--- 4749,4753 ----
  	
  	return  createEvent (&#39;_schemadoc&#39;, &#39;DROP_LISTEN&#39;,
! 			p_li_origin::text, p_li_provider::text, p_li_receiver::text);
  end;
  </programlisting>
***************
*** 4768,4772 ****
  	perform dropNode_int(p_no_id);
  	return  createEvent(&#39;_schemadoc&#39;, &#39;DROP_NODE&#39;,
! 									p_no_id);
  end;
  </programlisting>
--- 4878,4882 ----
  	perform dropNode_int(p_no_id);
  	return  createEvent(&#39;_schemadoc&#39;, &#39;DROP_NODE&#39;,
! 									p_no_id::text);
  end;
  </programlisting>
***************
*** 4918,4922 ****
  
  	return  createEvent (&#39;_schemadoc&#39;, &#39;DROP_PATH&#39;,
! 			p_pa_server, p_pa_client);
  end;
  </programlisting>
--- 5028,5032 ----
  
  	return  createEvent (&#39;_schemadoc&#39;, &#39;DROP_PATH&#39;,
! 			p_pa_server::text, p_pa_client::text);
  end;
  </programlisting>
***************
*** 5039,5043 ****
  	perform dropSet_int(p_set_id);
  	return  createEvent(&#39;_schemadoc&#39;, &#39;DROP_SET&#39;, 
! 			p_set_id);
  end;
  </programlisting>
--- 5149,5153 ----
  	perform dropSet_int(p_set_id);
  	return  createEvent(&#39;_schemadoc&#39;, &#39;DROP_SET&#39;, 
! 			p_set_id::text);
  end;
  </programlisting>
***************
*** 5149,5153 ****
  	perform dropTrigger_int(p_trig_tabid, p_trig_tgname);
  	return  createEvent(&#39;_schemadoc&#39;, &#39;DROP_TRIGGER&#39;,
! 			p_trig_tabid, p_trig_tgname);
  end;
  </programlisting>
--- 5259,5263 ----
  	perform dropTrigger_int(p_trig_tabid, p_trig_tgname);
  	return  createEvent(&#39;_schemadoc&#39;, &#39;DROP_TRIGGER&#39;,
! 			p_trig_tabid::text, p_trig_tgname::text);
  end;
  </programlisting>
***************
*** 5289,5293 ****
  	perform enableNode_int (p_no_id);
  	return  createEvent(&#39;_schemadoc&#39;, &#39;ENABLE_NODE&#39;,
! 									p_no_id);
  end;
  </programlisting>
--- 5399,5403 ----
  	perform enableNode_int (p_no_id);
  	return  createEvent(&#39;_schemadoc&#39;, &#39;ENABLE_NODE&#39;,
! 									p_no_id::text);
  end;
  </programlisting>
***************
*** 5776,5780 ****
  
  	perform failoverSet_int(p_failed_node,
! 			p_backup_node, p_set_id);
  
  	return p_ev_seqfake;
--- 5886,5890 ----
  
  	perform failoverSet_int(p_failed_node,
! 			p_backup_node, p_set_id, p_ev_seqfake);
  
  	return p_ev_seqfake;
***************
*** 5784,5795 ****
      </section>
  
! <!-- Function failoverset_int( integer, integer, integer ) -->
!     <section id="function.failoverset-int-integer-integer-integer"
!              xreflabel="schemadocfailoverset_int( integer, integer, integer )">
!       <title id="function.failoverset-int-integer-integer-integer-title">
!        failoverset_int( integer, integer, integer )
        </title>
!       <titleabbrev id="function.failoverset-int-integer-integer-integer-titleabbrev">
!        failoverset_int( integer, integer, integer )
        </titleabbrev>
  
--- 5894,5905 ----
      </section>
  
! <!-- Function failoverset_int( integer, integer, integer, bigint ) -->
!     <section id="function.failoverset-int-integer-integer-integer-bigint"
!              xreflabel="schemadocfailoverset_int( integer, integer, integer, bigint )">
!       <title id="function.failoverset-int-integer-integer-integer-bigint-title">
!        failoverset_int( integer, integer, integer, bigint )
        </title>
!       <titleabbrev id="function.failoverset-int-integer-integer-integer-bigint-titleabbrev">
!        failoverset_int( integer, integer, integer, bigint )
        </titleabbrev>
  
***************
*** 5806,5810 ****
         </segmentedlist>
   
!        FUNCTION failoverSet_int (failed_node, backup_node, set_id)
  
  Finish failover for one set.
--- 5916,5920 ----
         </segmentedlist>
   
!        FUNCTION failoverSet_int (failed_node, backup_node, set_id, wait_seqno)
  
  Finish failover for one set.
***************
*** 5814,5817 ****
--- 5924,5928 ----
  	p_backup_node		alias for $2;
  	p_set_id			alias for $3;
+ 	p_wait_seqno		alias for $4;
  	v_row				record;
  	v_last_sync			int8;
***************
*** 5851,5860 ****
  				(ev_origin, ev_seqno, ev_timestamp,
  				ev_minxid, ev_maxxid, ev_xip,
! 				ev_type, ev_data1, ev_data2, ev_data3)
  				values
  				(p_backup_node, &quot;pg_catalog&quot;.nextval(&#39;sl_event_seq&#39;), CURRENT_TIMESTAMP,
  				&#39;0&#39;, &#39;0&#39;, &#39;&#39;,
  				&#39;ACCEPT_SET&#39;, p_set_id::text,
! 				p_failed_node::text, p_backup_node::text);
  	else
  		delete from sl_subscribe
--- 5962,5972 ----
  				(ev_origin, ev_seqno, ev_timestamp,
  				ev_minxid, ev_maxxid, ev_xip,
! 				ev_type, ev_data1, ev_data2, ev_data3, ev_data4)
  				values
  				(p_backup_node, &quot;pg_catalog&quot;.nextval(&#39;sl_event_seq&#39;), CURRENT_TIMESTAMP,
  				&#39;0&#39;, &#39;0&#39;, &#39;&#39;,
  				&#39;ACCEPT_SET&#39;, p_set_id::text,
! 				p_failed_node::text, p_backup_node::text,
! 				p_wait_seqno::text);
  	else
  		delete from sl_subscribe
***************
*** 5994,6002 ****
  BEGIN
  	select 1 into v_node_row from sl_event 
!        	  where ev_type = &#39;SYNC&#39; and ev_origin = getLocalNodeId(&#39;schemadoc&#39;)
            and ev_timestamp &gt; now() - p_interval limit 1;
  	if not found then
  		-- If there has been no SYNC in the last interval, then push one
! 		perform createEvent(&#39;schemadoc&#39;, &#39;SYNC&#39;, NULL);
  		return 1;
  	else
--- 6106,6114 ----
  BEGIN
  	select 1 into v_node_row from sl_event 
!        	  where ev_type = &#39;SYNC&#39; and ev_origin = getLocalNodeId(&#39;_schemadoc&#39;)
            and ev_timestamp &gt; now() - p_interval limit 1;
  	if not found then
  		-- If there has been no SYNC in the last interval, then push one
! 		perform createEvent(&#39;_schemadoc&#39;, &#39;SYNC&#39;, NULL);
  		return 1;
  	else
***************
*** 6196,6200 ****
          <seglistitem>
           <seg>C</seg>
!          <seg>&quot;trigger&quot;</seg>
          </seglistitem>
         </segmentedlist>
--- 6308,6312 ----
          <seglistitem>
           <seg>C</seg>
!          <seg>trigger</seg>
          </seglistitem>
         </segmentedlist>
***************
*** 6362,6365 ****
--- 6474,6480 ----
  		raise notice &#39;Slony-I: log switch to sl_log_1 complete - truncate sl_log_2&#39;;
  		truncate sl_log_2;
+ 		if exists (select * from &quot;pg_catalog&quot;.pg_class c, &quot;pg_catalog&quot;.pg_namespace n, &quot;pg_catalog&quot;.pg_attribute a where c.relname = &#39;sl_log_2&#39; and n.oid = c.relnamespace and a.attrelid = c.oid and a.attname = &#39;oid&#39;) then
+ 	                execute &#39;alter table sl_log_2 set without oids;&#39;;
+ 		end if;		
  		perform &quot;pg_catalog&quot;.setval(&#39;sl_log_status&#39;, 0);
  		-- Run addPartialLogIndices() to try to add indices to unused sl_log_? table
***************
*** 6388,6391 ****
--- 6503,6509 ----
  		raise notice &#39;Slony-I: log switch to sl_log_2 complete - truncate sl_log_1&#39;;
  		truncate sl_log_1;
+ 		if exists (select * from &quot;pg_catalog&quot;.pg_class c, &quot;pg_catalog&quot;.pg_namespace n, &quot;pg_catalog&quot;.pg_attribute a where c.relname = &#39;sl_log_1&#39; and n.oid = c.relnamespace and a.attrelid = c.oid and a.attname = &#39;oid&#39;) then
+ 	                execute &#39;alter table sl_log_1 set without oids;&#39;;
+ 		end if;		
  		perform &quot;pg_catalog&quot;.setval(&#39;sl_log_status&#39;, 1);
  		-- Run addPartialLogIndices() to try to add indices to unused sl_log_? table
***************
*** 6575,6579 ****
          <seglistitem>
           <seg>C</seg>
!          <seg>&quot;trigger&quot;</seg>
          </seglistitem>
         </segmentedlist>
--- 6693,6697 ----
          <seglistitem>
           <seg>C</seg>
!          <seg>trigger</seg>
          </seglistitem>
         </segmentedlist>
***************
*** 6672,6675 ****
--- 6790,6808 ----
  
  	-- ----
+ 	-- Check that all ENABLE_SUBSCRIPTION events for the set are confirmed
+ 	-- ----
+ 	if exists (select true from sl_event
+ 			where ev_type = &#39;ENABLE_SUBSCRIPTION&#39;
+ 			and ev_data1 = p_add_id::text
+ 			and ev_seqno &gt; (select max(con_seqno) from sl_confirm
+ 					where con_origin = ev_origin
+ 					and con_received::text = ev_data3))
+ 	then
+ 		raise exception &#39;Slony-I: set % has subscriptions in progress - cannot merge&#39;,
+ 				p_add_id;
+ 	end if;
+ 			  
+ 
+ 	-- ----
  	-- Create a SYNC event, merge the sets, create a MERGE_SET event
  	-- ----
***************
*** 6677,6681 ****
  	perform mergeSet_int(p_set_id, p_add_id);
  	return  createEvent(&#39;_schemadoc&#39;, &#39;MERGE_SET&#39;, 
! 			p_set_id, p_add_id);
  end;
  </programlisting>
--- 6810,6814 ----
  	perform mergeSet_int(p_set_id, p_add_id);
  	return  createEvent(&#39;_schemadoc&#39;, &#39;MERGE_SET&#39;, 
! 			p_set_id::text, p_add_id::text);
  end;
  </programlisting>
***************
*** 6823,6827 ****
  	-- ----
  	perform moveSet_int(p_set_id, v_local_node_id,
! 			p_new_origin);
  
  	perform RebuildListenEntries();
--- 6956,6960 ----
  	-- ----
  	perform moveSet_int(p_set_id, v_local_node_id,
! 			p_new_origin, 0);
  
  	perform RebuildListenEntries();
***************
*** 6843,6847 ****
  	-- ----
  	return createEvent(&#39;_schemadoc&#39;, &#39;MOVE_SET&#39;, 
! 			p_set_id, v_local_node_id, p_new_origin);
  end;
  </programlisting>
--- 6976,6980 ----
  	-- ----
  	return createEvent(&#39;_schemadoc&#39;, &#39;MOVE_SET&#39;, 
! 			p_set_id::text, v_local_node_id::text, p_new_origin::text);
  end;
  </programlisting>
***************
*** 6849,6860 ****
      </section>
  
! <!-- Function moveset_int( integer, integer, integer ) -->
!     <section id="function.moveset-int-integer-integer-integer"
!              xreflabel="schemadocmoveset_int( integer, integer, integer )">
!       <title id="function.moveset-int-integer-integer-integer-title">
!        moveset_int( integer, integer, integer )
        </title>
!       <titleabbrev id="function.moveset-int-integer-integer-integer-titleabbrev">
!        moveset_int( integer, integer, integer )
        </titleabbrev>
  
--- 6982,6993 ----
      </section>
  
! <!-- Function moveset_int( integer, integer, integer, bigint ) -->
!     <section id="function.moveset-int-integer-integer-integer-bigint"
!              xreflabel="schemadocmoveset_int( integer, integer, integer, bigint )">
!       <title id="function.moveset-int-integer-integer-integer-bigint-title">
!        moveset_int( integer, integer, integer, bigint )
        </title>
!       <titleabbrev id="function.moveset-int-integer-integer-integer-bigint-titleabbrev">
!        moveset_int( integer, integer, integer, bigint )
        </titleabbrev>
  
***************
*** 6871,6875 ****
         </segmentedlist>
   
!        moveSet(set_id, old_origin, new_origin)
  
  Process MOVE_SET event to request that the origin for set set_id be
--- 7004,7008 ----
         </segmentedlist>
   
!        moveSet(set_id, old_origin, new_origin, wait_seqno)
  
  Process MOVE_SET event to request that the origin for set set_id be
***************
*** 6880,6883 ****
--- 7013,7017 ----
  	p_old_origin		alias for $2;
  	p_new_origin		alias for $3;
+ 	p_wait_seqno		alias for $4;
  	v_local_node_id		int4;
  	v_tab_row			record;
***************
*** 6913,6919 ****
  	-- On the new origin, raise an event - ACCEPT_SET
  	if v_local_node_id = p_new_origin then
! 		
  		perform createEvent(&#39;_schemadoc&#39;, &#39;ACCEPT_SET&#39;, 
! 			p_set_id, p_old_origin, p_new_origin);
  	end if;
  
--- 7047,7058 ----
  	-- On the new origin, raise an event - ACCEPT_SET
  	if v_local_node_id = p_new_origin then
! 		-- Create a SYNC event as well so that the ACCEPT_SET has
! 		-- the same snapshot as the last SYNC generated by the new
! 		-- origin. This snapshot will be used by other nodes to
! 		-- finalize the setsync status.
! 		perform createEvent(&#39;_schemadoc&#39;, &#39;SYNC&#39;, NULL);
  		perform createEvent(&#39;_schemadoc&#39;, &#39;ACCEPT_SET&#39;, 
! 			p_set_id::text, p_old_origin::text, 
! 			p_new_origin::text, p_wait_seqno::text);
  	end if;
  
***************
*** 7693,7697 ****
  			p_seq_comment);
  	return  createEvent(&#39;_schemadoc&#39;, &#39;SET_ADD_SEQUENCE&#39;,
! 			p_set_id, p_seq_id, p_fqname, p_seq_comment);
  end;
  </programlisting>
--- 7832,7837 ----
  			p_seq_comment);
  	return  createEvent(&#39;_schemadoc&#39;, &#39;SET_ADD_SEQUENCE&#39;,
! 						p_set_id::text, p_seq_id::text, 
! 						p_fqname::text, p_seq_comment::text);
  end;
  </programlisting>
***************
*** 7892,7897 ****
  			p_tab_idxname, p_tab_comment);
  	return  createEvent(&#39;_schemadoc&#39;, &#39;SET_ADD_TABLE&#39;,
! 			p_set_id, p_tab_id, p_fqname,
! 			p_tab_idxname, p_tab_comment);
  end;
  </programlisting>
--- 8032,8037 ----
  			p_tab_idxname, p_tab_comment);
  	return  createEvent(&#39;_schemadoc&#39;, &#39;SET_ADD_TABLE&#39;,
! 			p_set_id::text, p_tab_id::text, p_fqname::text,
! 			p_tab_idxname::text, p_tab_comment::text);
  end;
  </programlisting>
***************
*** 8112,8116 ****
  	perform setDropSequence_int(p_seq_id);
  	return  createEvent(&#39;_schemadoc&#39;, &#39;SET_DROP_SEQUENCE&#39;,
! 			p_seq_id);
  end;
  </programlisting>
--- 8252,8256 ----
  	perform setDropSequence_int(p_seq_id);
  	return  createEvent(&#39;_schemadoc&#39;, &#39;SET_DROP_SEQUENCE&#39;,
! 					p_seq_id::text);
  end;
  </programlisting>
***************
*** 8274,8278 ****
  	-- ----
  	perform setDropTable_int(p_tab_id);
! 	return  createEvent(&#39;_schemadoc&#39;, &#39;SET_DROP_TABLE&#39;, p_tab_id);
  end;
  </programlisting>
--- 8414,8419 ----
  	-- ----
  	perform setDropTable_int(p_tab_id);
! 	return  createEvent(&#39;_schemadoc&#39;, &#39;SET_DROP_TABLE&#39;, 
! 				p_tab_id::text);
  end;
  </programlisting>
***************
*** 8468,8472 ****
  	perform setMoveSequence_int(p_seq_id, p_new_set_id);
  	return  createEvent(&#39;_schemadoc&#39;, &#39;SET_MOVE_SEQUENCE&#39;, 
! 			p_seq_id, p_new_set_id);
  end;
  </programlisting>
--- 8609,8613 ----
  	perform setMoveSequence_int(p_seq_id, p_new_set_id);
  	return  createEvent(&#39;_schemadoc&#39;, &#39;SET_MOVE_SEQUENCE&#39;, 
! 			p_seq_id::text, p_new_set_id::text);
  end;
  </programlisting>
***************
*** 8622,8626 ****
  	perform setMoveTable_int(p_tab_id, p_new_set_id);
  	return  createEvent(&#39;_schemadoc&#39;, &#39;SET_MOVE_TABLE&#39;, 
! 			p_tab_id, p_new_set_id);
  end;
  </programlisting>
--- 8763,8767 ----
  	perform setMoveTable_int(p_tab_id, p_new_set_id);
  	return  createEvent(&#39;_schemadoc&#39;, &#39;SET_MOVE_TABLE&#39;, 
! 			p_tab_id::text, p_new_set_id::text);
  end;
  </programlisting>
***************
*** 8951,8955 ****
          <programlisting>
  begin
! 	return 0;
  end;
  </programlisting>
--- 9092,9096 ----
          <programlisting>
  begin
! 	return 11;
  end;
  </programlisting>
***************
*** 8992,8996 ****
  	perform storeListen_int (p_origin, p_provider, p_receiver);
  	return  createEvent (&#39;_schemadoc&#39;, &#39;STORE_LISTEN&#39;,
! 			p_origin, p_provider, p_receiver);
  end;
  </programlisting>
--- 9133,9137 ----
  	perform storeListen_int (p_origin, p_provider, p_receiver);
  	return  createEvent (&#39;_schemadoc&#39;, &#39;STORE_LISTEN&#39;,
! 			p_origin::text, p_provider::text, p_receiver::text);
  end;
  </programlisting>
***************
*** 9113,9117 ****
  	perform storeNode_int (p_no_id, p_no_comment, p_no_spool);
  	return  createEvent(&#39;_schemadoc&#39;, &#39;STORE_NODE&#39;,
! 									p_no_id, p_no_comment, v_no_spool_txt);
  end;
  </programlisting>
--- 9254,9259 ----
  	perform storeNode_int (p_no_id, p_no_comment, p_no_spool);
  	return  createEvent(&#39;_schemadoc&#39;, &#39;STORE_NODE&#39;,
! 									p_no_id::text, p_no_comment::text, 
! 									v_no_spool_txt::text);
  end;
  </programlisting>
***************
*** 9224,9228 ****
  			p_pa_conninfo, p_pa_connretry);
  	return  createEvent(&#39;_schemadoc&#39;, &#39;STORE_PATH&#39;, 
! 			p_pa_server, p_pa_client, p_pa_conninfo, p_pa_connretry);
  end;
  </programlisting>
--- 9366,9371 ----
  			p_pa_conninfo, p_pa_connretry);
  	return  createEvent(&#39;_schemadoc&#39;, &#39;STORE_PATH&#39;, 
! 			p_pa_server::text, p_pa_client::text, 
! 			p_pa_conninfo::text, p_pa_connretry::text);
  end;
  </programlisting>
***************
*** 9357,9361 ****
  
  	return createEvent(&#39;_schemadoc&#39;, &#39;STORE_SET&#39;, 
! 			p_set_id, v_local_node_id, p_set_comment);
  end;
  </programlisting>
--- 9500,9504 ----
  
  	return createEvent(&#39;_schemadoc&#39;, &#39;STORE_SET&#39;, 
! 			p_set_id::text, v_local_node_id::text, p_set_comment::text);
  end;
  </programlisting>
***************
*** 9461,9465 ****
  	perform storeTrigger_int(p_trig_tabid, p_trig_tgname);
  	return  createEvent(&#39;_schemadoc&#39;, &#39;STORE_TRIGGER&#39;,
! 			p_trig_tabid, p_trig_tgname);
  end;
  </programlisting>
--- 9604,9608 ----
  	perform storeTrigger_int(p_trig_tabid, p_trig_tgname);
  	return  createEvent(&#39;_schemadoc&#39;, &#39;STORE_TRIGGER&#39;,
! 			p_trig_tabid::text, p_trig_tgname::text);
  end;
  </programlisting>
***************
*** 9632,9636 ****
  	-- ----
  	v_ev_seqno :=  createEvent(&#39;_schemadoc&#39;, &#39;SUBSCRIBE_SET&#39;, 
! 			p_sub_set, p_sub_provider, p_sub_receiver, 
  			case p_sub_forward when true then &#39;t&#39; else &#39;f&#39; end);
  
--- 9775,9779 ----
  	-- ----
  	v_ev_seqno :=  createEvent(&#39;_schemadoc&#39;, &#39;SUBSCRIBE_SET&#39;, 
! 			p_sub_set::text, p_sub_provider::text, p_sub_receiver::text, 
  			case p_sub_forward when true then &#39;t&#39; else &#39;f&#39; end);
  
***************
*** 9749,9753 ****
  	if v_set_origin = getLocalNodeId(&#39;_schemadoc&#39;) then
  		perform createEvent(&#39;_schemadoc&#39;, &#39;ENABLE_SUBSCRIPTION&#39;, 
! 				p_sub_set, p_sub_provider, p_sub_receiver, 
  				case p_sub_forward when true then &#39;t&#39; else &#39;f&#39; end);
  		perform enableSubscription(p_sub_set, 
--- 9892,9896 ----
  	if v_set_origin = getLocalNodeId(&#39;_schemadoc&#39;) then
  		perform createEvent(&#39;_schemadoc&#39;, &#39;ENABLE_SUBSCRIPTION&#39;, 
! 				p_sub_set::text, p_sub_provider::text, p_sub_receiver::text, 
  				case p_sub_forward when true then &#39;t&#39; else &#39;f&#39; end);
  		perform enableSubscription(p_sub_set, 
***************
*** 10260,10264 ****
  	-- ----
  	return  createEvent(&#39;_schemadoc&#39;, &#39;UNSUBSCRIBE_SET&#39;, 
! 			p_sub_set, p_sub_receiver);
  end;
  </programlisting>
--- 10403,10407 ----
  	-- ----
  	return  createEvent(&#39;_schemadoc&#39;, &#39;UNSUBSCRIBE_SET&#39;, 
! 			p_sub_set::text, p_sub_receiver::text);
  end;
  </programlisting>
***************
*** 10478,10482 ****
  
          return  createEvent(&#39;_schemadoc&#39;, &#39;RESET_CONFIG&#39;,
!                         p_set_id, p_only_on_node);
  end;
  </programlisting>
--- 10621,10625 ----
  
          return  createEvent(&#39;_schemadoc&#39;, &#39;RESET_CONFIG&#39;,
!                         p_set_id::text, p_only_on_node::text);
  end;
  </programlisting>
***************
*** 10580,10584 ****
  	-- Changes for 1.2
  	-- ----
! 	if p_old IN (&#39;1.0.2&#39;, &#39;1.0.5&#39;, &#39;1.0.6&#39;, &#39;1.1.0&#39;, &#39;1.1.1&#39;, &#39;1.1.2&#39;, &#39;1.1.3&#39;) then
  		-- Add new table sl_registry
  		execute &#39;create table sl_registry (
--- 10723,10727 ----
  	-- Changes for 1.2
  	-- ----
! 	if p_old IN (&#39;1.0.2&#39;, &#39;1.0.5&#39;, &#39;1.0.6&#39;, &#39;1.1.0&#39;, &#39;1.1.1&#39;, &#39;1.1.2&#39;, &#39;1.1.3&#39;,&#39;1.1.5&#39;, &#39;1.1.6&#39;, &#39;1.1.7&#39;, &#39;1.1.8&#39;, &#39;1.1.9&#39;) then
  		-- Add new table sl_registry
  		execute &#39;create table sl_registry (
***************
*** 10592,10601 ****
                  execute &#39;alter table sl_event set without oids;&#39;;
                  execute &#39;alter table sl_listen set without oids;&#39;;
-                 execute &#39;alter table sl_log_1 set without oids;&#39;;
-                 execute &#39;alter table sl_log_2 set without oids;&#39;;
                  execute &#39;alter table sl_node set without oids;&#39;;
                  execute &#39;alter table sl_nodelock set without oids;&#39;;
                  execute &#39;alter table sl_path set without oids;&#39;;
-                 execute &#39;alter table sl_seqlog set without oids;&#39;;
                  execute &#39;alter table sl_sequence set without oids;&#39;;
                  execute &#39;alter table sl_set set without oids;&#39;;
--- 10735,10741 ----
***************
*** 10606,10609 ****
--- 10746,10764 ----
  	end if;
  
+ 	-- ----
+ 	-- Changes for 1.2.11
+ 	-- ----
+ 	if p_old IN (&#39;1.0.2&#39;, &#39;1.0.5&#39;, &#39;1.0.6&#39;, &#39;1.1.0&#39;, &#39;1.1.1&#39;, &#39;1.1.2&#39;, &#39;1.1.3&#39;,&#39;1.1.5&#39;, &#39;1.1.6&#39;, &#39;1.1.7&#39;, &#39;1.1.8&#39;, &#39;1.1.9&#39;, &#39;1.2.0&#39;, &#39;1.2.1&#39;, &#39;1.2.2&#39;, &#39;1.2.3&#39;, &#39;1.2.4&#39;, &#39;1.2.5&#39;, &#39;1.2.6&#39;, &#39;1.2.7&#39;, &#39;1.2.8&#39;, &#39;1.2.9&#39;, &#39;1.2.10&#39;) then
+ 		-- Add new table sl_archive_counter
+ 		execute &#39;create table sl_archive_counter (
+ 						ac_num			bigint,
+ 						ac_timestamp	timestamp
+ 					) without oids&#39;;
+ 		execute &#39;insert into sl_archive_counter
+ 					(ac_num, ac_timestamp) values (0, &#39;&#39;epoch&#39;&#39;::timestamp)&#39;;
+ 	end if;
+ 
+ 	-- In any version, make sure that the xxidin() functions are defined STRICT
+ 	perform make_function_strict (&#39;xxidin&#39;, &#39;(cstring)&#39;);
  	return p_old;
  end;

From cbbrowne at lists.slony.info  Tue Aug 28 12:19:24 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Aug 28 12:19:26 2007
Subject: [Slony1-commit] slony1-engine/doc/adminguide logshipping.sgml
Message-ID: <20070828191924.EB734290C17@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/doc/adminguide
In directory main.slony.info:/tmp/cvs-serv21311

Modified Files:
      Tag: REL_1_2_STABLE
	logshipping.sgml 
Log Message:
Update docs for log shipping to reflect Jan's recent changes


Index: logshipping.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/logshipping.sgml,v
retrieving revision 1.16
retrieving revision 1.16.2.1
diff -C2 -d -r1.16 -r1.16.2.1
*** logshipping.sgml	2 Aug 2006 18:34:59 -0000	1.16
--- logshipping.sgml	28 Aug 2007 19:19:22 -0000	1.16.2.1
***************
*** 4,10 ****
  <indexterm><primary>log shipping</primary></indexterm>
  
! <para> One of the new features for 1.1 is the ability to serialize the
! updates to go out into log files that can be kept in a spool
! directory.</para>
  
  <para> The spool files could then be transferred via whatever means
--- 4,10 ----
  <indexterm><primary>log shipping</primary></indexterm>
  
! <para> One of the new features for 1.1, that only really stabilized as
! of 1.2.11, is the ability to serialize the updates to go out into log
! files that can be kept in a spool directory.</para>
  
  <para> The spool files could then be transferred via whatever means
***************
*** 33,37 ****
  
    <para> This makes log shipping potentially useful even though you
!   might not intend to actually create a log-shipped node.</para></listitem>
  
    <listitem><para> This is a really slick scheme for building load for
--- 33,38 ----
  
    <para> This makes log shipping potentially useful even though you
!   might not intend to actually create a log-shipped
!   node.</para></listitem>
  
    <listitem><para> This is a really slick scheme for building load for
***************
*** 75,78 ****
--- 76,83 ----
  <answer><para> Nothing special.  So long as the archiving node remains
  a subscriber, it will continue to generate logs.</para></answer>
+ 
+ <answer><para> <warning> If the archiving node becomes the
+ <emphasis>origin,</emphasis> on the other hand, it will
+ <emphasis>continue</emphasis> to generate logs.</para> </answer>
  </qandaentry>
  
***************
*** 167,175 ****
  coming from other nodes (notably the data provider). </para>
  
! <para> Unfortunately, the upshot of this is that when a node newly
! subscribes to a set, the log that actually contains the data is in a
! separate sequencing from the sequencing of the normal
! <command>SYNC</command> logs.  Blindly loading these logs will throw
! things off :-(. </para>
  
  </listitem> 
--- 172,177 ----
  coming from other nodes (notably the data provider). </para>
  
! <para> With revisions in sequencing of logs that took place in 1.2.11,
! this now presents no problem for the user.</para>
  
  </listitem> 
***************
*** 300,303 ****
--- 302,347 ----
  
  </itemizedlist>
+ 
+ <para> As of 1.2.11, there is an <emphasis>even better idea</emphasis>
+ for application of logs, as the sequencing of their names becomes more
+ predictable.</para>
+ 
+ <itemizedlist>
+ 
+ <listitem><para> The table, on the log shipped node, tracks which log
+ it most recently applied in table
+ <envar>sl_archive_tracking</envar>. </para>
+ 
+ <para> Thus, you may predict the ID number of the next file by taking
+ the latest counter from this table and adding 1.</para>
+ </listitem>
+ 
+ <listitem><para> There is still variation as to the filename,
+ depending on what the overall set of nodes in the cluster are.  All
+ nodes periodically generate <command>SYNC</command> events, even if
+ they are not an origin node, and the log shipping system does generate
+ logs for such events. </para>
+ 
+ <para> As a result, when searching for the next file, it is necessary
+ to search for files in a manner similar to the following:
+ 
+ <programlisting>
+ ARCHIVEDIR=/var/spool/slony/archivelogs/node4
+ SLONYCLUSTER=mycluster
+ PGDATABASE=logshipdb
+ PGHOST=logshiphost
+ NEXTQUERY="select at_counter+1 from \"_${SLONYCLUSTER}\".sl_archive_tracking;"
+ nextseq=`psql -d ${PGDATABASE} -h ${PGHOST} -A -t -c "${NEXTQUERY}"
+ filespec=`printf "slony1_log_*_%20d.sql"
+ for file in `find $ARCHIVEDIR -name "${filespec}"; do
+    psql -d ${PGDATABASE} -h ${PGHOST} -f ${file}
+ done
+ </programlisting>
+ </para>
+ </listitem>
+ 
+ <listitem><para> </para> </listitem>
+ </itemizedlist>
+ 
  </sect2>
  </sect1>

From cbbrowne at lists.slony.info  Tue Aug 28 12:27:31 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Aug 28 12:27:32 2007
Subject: [Slony1-commit] slony1-engine/doc/adminguide logshipping.sgml
	slon.sgml
Message-ID: <20070828192731.898FE290C4A@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/doc/adminguide
In directory main.slony.info:/tmp/cvs-serv21493

Modified Files:
      Tag: REL_1_2_STABLE
	logshipping.sgml slon.sgml 
Log Message:
Fixes to SGML tagging


Index: slon.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/slon.sgml,v
retrieving revision 1.29.2.2
retrieving revision 1.29.2.3
diff -C2 -d -r1.29.2.2 -r1.29.2.3
*** slon.sgml	8 Aug 2007 15:23:30 -0000	1.29.2.2
--- slon.sgml	28 Aug 2007 19:27:29 -0000	1.29.2.3
***************
*** 149,153 ****
        </itemizedlist>
  
-      </para>
       <para>
        Default is 10000 ms and maximum is 120000 ms. By default, you
--- 149,152 ----

Index: logshipping.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/logshipping.sgml,v
retrieving revision 1.16.2.1
retrieving revision 1.16.2.2
diff -C2 -d -r1.16.2.1 -r1.16.2.2
*** logshipping.sgml	28 Aug 2007 19:19:22 -0000	1.16.2.1
--- logshipping.sgml	28 Aug 2007 19:27:29 -0000	1.16.2.2
***************
*** 77,83 ****
  a subscriber, it will continue to generate logs.</para></answer>
  
! <answer><para> <warning> If the archiving node becomes the
! <emphasis>origin,</emphasis> on the other hand, it will
! <emphasis>continue</emphasis> to generate logs.</para> </answer>
  </qandaentry>
  
--- 77,82 ----
  a subscriber, it will continue to generate logs.</para></answer>
  
! <answer> <warning> <para>If the archiving node becomes the origin, on
! the other hand, it will continue to generate logs.</para> </warning></answer>
  </qandaentry>
  

From cbbrowne at lists.slony.info  Tue Aug 28 12:28:19 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Aug 28 12:28:20 2007
Subject: [Slony1-commit] slony1-engine RELEASE
Message-ID: <20070828192819.23DC7290C1B@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine
In directory main.slony.info:/tmp/cvs-serv21536

Modified Files:
      Tag: REL_1_2_STABLE
	RELEASE 
Log Message:
More updates to release notes for 1.2.11


Index: RELEASE
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/RELEASE,v
retrieving revision 1.1.2.12
retrieving revision 1.1.2.13
diff -C2 -d -r1.1.2.12 -r1.1.2.13
*** RELEASE	23 Aug 2007 22:10:36 -0000	1.1.2.12
--- RELEASE	28 Aug 2007 19:28:17 -0000	1.1.2.13
***************
*** 49,52 ****
--- 49,55 ----
    sl_archive_tracking.
  
+ - Fix log shipping test to accomodate the new tracking scheme, and
+   update documentation to describe this better.  
+ 
  RELEASE 1.2.10
  

From cbbrowne at lists.slony.info  Tue Aug 28 12:44:59 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Aug 28 12:45:01 2007
Subject: [Slony1-commit] slony1-www/content frontpage.txt news.txt
Message-ID: <20070828194459.43211290C4A@main.slony.info>

Update of /home/cvsd/slony1/slony1-www/content
In directory main.slony.info:/tmp/cvs-serv21961/content

Modified Files:
	frontpage.txt news.txt 
Log Message:
Update for 1.2.11 release


Index: frontpage.txt
===================================================================
RCS file: /home/cvsd/slony1/slony1-www/content/frontpage.txt,v
retrieving revision 1.19
retrieving revision 1.20
diff -C2 -d -r1.19 -r1.20
*** frontpage.txt	21 Aug 2007 22:35:14 -0000	1.19
--- frontpage.txt	28 Aug 2007 19:44:57 -0000	1.20
***************
*** 1,9 ****
  ---
  Slony-I 1.2.11 pre-release #2 available
! http://slony.info/downloads/1.2/source/slony1-1.2.11-pre2.tar.bz2
! 2007-08-21
  Chris Browne
  
! A second tarball of Slony-I 1.2.11 is available for testing.
  
  <P> Fixes are the following:
--- 1,14 ----
  ---
  Slony-I 1.2.11 pre-release #2 available
! http://slony.info/downloads/1.2/source/slony1-1.2.11.tar.bz2
! 2007-08-28
  Chris Browne
  
! We are pleased to announce general availability of Slony-I 1.2.11.
! Note that both <a href=
! "http://slony.info/downloads/1.2/source/slony1-1.2.11.tar.bz2">
! sources </a> and <a href=
! "http://slony.info/downloads/1.2/source/slony1-1.2.11-docs.tar.bz2">
! documentation</a> are available.
  
  <P> Fixes are the following:
***************
*** 45,324 ****
    the offline replica and must increment gap free.
  
! </ul>
! ---
! Slony-I 1.2.10 Released
! http://lists.slony.info/downloads/1.2/source/slony1-1.2.10.tar.bz2
! 2007-06-26
! Chris Browne
! 
! We are pleased to announce the release of Slony-I version 1.2.10.
! Sources as well as pre-built documentation is available in the
! download area; users of RPM-based systems and Windows will likely see
! suitable packages soon.
! 
! <P> The release notes describe the changes made since 1.2.9:
! 
! <h2>RELEASE 1.2.10</h2>
! 
! <ol>
! <li>Fixed problem with EXECUTE SCRIPT (EXECUTE ONLY ON = [node])
! 
!   <P> The script was being executed on too many nodes...
! 
! <li> Added a test script for log shipping
! 
!   <P> ... And alter it to add invocation of a DDL script.  This
!   allows testing for an event-counting problem in log shipping.
! 
! <li> Changes to support PostgreSQL 8.3 as VARATT_SIZEP has been deprecated
! 
! <li> in xxid.c, changes to support PostgreSQL 8.3 as tuple compression has
!   more extensive support
! 
! <P>  <tt>VARDATA_ANY( PG_DETOAST_DATUM_PACKED( (PG_GETARG_DATUM(0))))</tt>
!   tends to replace
!   <tt>PG_GETARG_VARLENA(0)</tt>
! 
! <li> Slonik's SYNC command never recorded the new seqno in the admin
!   conninfo, with potential wacky results for WAIT FOR EVENT
! 
! <li> Fix rpm build problem when the system has pg_config in both under
!   /usr/local/pgsql/bin and /usr/bin
! 
! <li> Add init script for Red Hat / Fedora
! 
! <li> Fix archive log ship tracking. Slon now tracks the setsync status in
!   memory and generates a void archive with the correct old,new event
!   seqno for all events.
! 
! <li> EXECUTE SCRIPT wasn't setting sl_setsync, which broke WAIT FOR EVENT
!   on these events
! 
! <li> Ducttape test #5 (which performs DDL changes) augmented to test use
!   of WAIT FOR EVENT
! 
! <li> Backpatch fixes for restricted text casts in 8.3
! 
! <P>  create_event() calls (notably, but they're not alone) need to be
!   augmented to cast data types expressly.
! 
! <li> PostgreSQL 8.3 is now a supported version for 1.2.10
! 
! <P>  The hope/intent is that 1.2.10 will be the last version of Slony-I
!   in the "1.x" series, and will permit upgrades to PostgreSQL 8.3.
!   The subsequent Slony-I 2.x series will require PostgreSQL 8.3.
! 
! <li> Discovered and documented a problem with UPDATE FUNCTIONS on
! versions 8.1.[0-3].  Unfortunately, this means that these versions of
! PostgreSQL essentially do not support Slony-I upgrades.
! 
! <li> Fixes to log shipping test
! 
! <li> Win32 fix for MinGW+gcc
! 
! <li> cvs distclean changed to clean the build up more
! 
! <li> On copy_set() check that we have forwarded the confirmation of
! ENABLE_SUBSCRIPTION by the data provider only if the data provider is
! not the origin of the set.
! 
! <li> For logshipping we need to use the internally tracked ssy_seqno for
!   SYNC events as well.
! 
!   <P> This allows "run_test.sh testlogship" to run successfully!
! 
! </ol>
! ---
! Slony-I Release - 1.2.9
! http://main.slony.info/downloads/1.2
! 2007-03-22
! Chris Browne
! We are pleased to announce the release of version 1.2.9, which may be
! found <a href="http://main.slony.info/downloads/1.2/source/slony1-1.2.9.tar.bz2">here</a>.  
! There is also a <a href="http://main.slony.info/downloads/1.2/source/slony1-1.2.9-docs.tar.bz2">Documentation tarball </a>.
! 
! <P> This release fixes several problems that were found in the 1.2 stream:
! <ul>
! <li> Reverted change that tried to support elderly apache rotatelogs
! 
! <li> Added a patch file to apply if you need to support elderly apache rotatelogs (tools/altperl/old-apache-rotatelogs.patch)
! 
! <li> Bug in UPDATE FUNCTIONS - wrong quoting in plpgsql function
! 
! <li> Add a regression test that runs UPDATE FUNCTIONS to ensure that it at least has no syntax errors
! </ul>
! ---
! Slony-I Release - 1.1.9
! http://main.slony.info/downloads/1.1
! 2007-03-22
! Chris Browne
! We are pleased to announce the release of version 1.1.9, which may be
! found <a href="http://main.slony.info/downloads/1.1/source/slony1-1.1.9.tar.bz2">here</a>.  
! 
! <P> This release fixes several problems that were found in the 1.1 stream:
! <ul>
! <li> Missed adding v81 SQL base files to CVS
! 
! <li> Reverted change that tried to support elderly apache rotatelogs
! 
! <li> Added a patch file to apply if you need to support elderly apache rotatelogs (tools/altperl/old-apache-rotatelogs.patch)
! </ul>
! ---
! Slony-I Release - 1.2.8
! http://main.slony.info/downloads/1.2
! 2007-03-16
! Chris Browne
! We are pleased to announce the release of version 1.2.8, which may be
! found <a href="http://main.slony.info/downloads/1.2/source/slony1-1.2.8.tar.bz2">here</a>.  
! There is also a <a href="http://main.slony.info/downloads/1.2/source/slony1-1.2.8-docs.tar.bz2">Documentation tarball </a>.
! 
! <P> This release fixes several problems that were found in the 1.2 stream:
! <ul>
! <li> Change to rotatelogs configuration to support older versions of Apache
! log rotator
! 
! <li> Fix to altperl "execute script" script to pass the filename properly
! 
! <li> Fix to <tt>src/backend/slony1_funcs.v80.sql</tt> - comment on the right function in v8.0
! 
! <li> Fix to <tt>src/slonik/slonik.c</tt> - it wasn't pulling in the right version of slony1_funcs.?.sql in some cases (notably with versions 8.1 and 8.2)
! 
! <li> Updated docs on creating releases to describe the version mismatch problem found above in <tt>slonik.c</tt>
! </ul>
! ---
! Slony-I Release - 1.1.8
! http://main.slony.info/downloads/1.1
! 2007-03-16
! Chris Browne
! We are pleased to announce the release of version 1.1.8, which may be
! found <a href="http://main.slony.info/downloads/1.1/source/slony1-1.1.8.tar.bz2">here</a>.  
! 
! <P> This release fixes several problems that were found in the 1.1 stream:
! <ul>
! <li> Change to rotatelogs configuration to support older versions of Apache
! log rotator
! 
! <li> Fix to altperl "execute script" script to pass the filename properly
! 
! <li> Fix to xxid Makefile: in the 1.1 branch, xxid.v73.sql is still in
! use, and should be copied to generate the other versions.
! 
! <li> Fix to <tt>src/backend/slony1_funcs.v80.sql</tt> - comment on the right function in v8.0
! 
! <li> Fix to <tt>src/slonik/slonik.c</tt> - it wasn't pulling in the right version of slony1_funcs.?.sql in some cases (notably with versions 8.1 and 8.2)
  
  </ul>
- ---
- Slony-I Release - 1.2.7
- http://main.slony.info/downloads/1.2
- 2007-03-07
- Chris Browne
- We are pleased to announce the release of version 1.2.7, which may be
- found <a href="http://main.slony.info/downloads/1.2/source/slony1-1.2.7.tar.bz2">here</a>.  
- There is also a <a href="http://main.slony.info/downloads/1.2/source/slony1-1.2.7-docs.tar.bz2">Documentation tarball </a>.
- 
- <P> This release fixes several problems that were found in the 1.2 stream:
- <ul>
- <li> Add remote_listen_timeout parameter to slon.conf
- 
- <p> This addresses the problem where a slon times out when accessing
- sl_event if a node has been out of commission for a long time (several
- days)
- 
- <li> Resolve bug #1623
- 
- <p> In this bug, big "action lists" that need to get compressed could cause
- a logging printf to blow up.  Changed the logging level so that detail
- is only shown at level 4, which won't bite people by default.
- 
- <li> UNINSTALL NODE failures now show node # in slonik error messages
- 
- <P> If a user ran several UNINSTALL NODE requests in a single slonik
- script, and one of them broke, you'd have no ready way to tell which
- node this failed on.  Added code to report the node # where it failed.
- 
- <li> Added test to test1 for function generate_sync_event() and make_function_strict
- 
- <li> Added "v81" files (for slony1_base.v81.sql, slony1_funcs.v81.sql,
- xxid.v81.sql), necessary to support 8.1 "ALTER FUNCTION ... STRICT";
- 
- <li> Fixed quoting problem in generate_sync_event()
- 
- <li> Added functionality to UPDATE FUNCTIONS to make xxidin() function
- STRICT; the absence of this caused postmaster to fall over when
- processing MOVE SET event in PG v8.2
- 
- <li> Added documentation of an issue surrounding NULLABLE columns to the
- log analysis chapter of the admin guide and to the UPGRADING docs.
  
! <li> When you run MOVE SET, this populates sl_setsync for the moved set
!   even on nodes that are not subscribed.  If, subsequent to doing this, 
!   you attempt a SUBSCRIBE SET for a formerly-unsubscribed node, the
!   subscription will fail right at the end when the slon tries to insert a
!   new value to sl_setsync.
! 
! <P>   The fix: DELETE from sl_setsync immediately before the INSERT.  This
!   will silently blow away any 'offending' sl_setsync row.
! 
! <p>  (As observed by Afilias staff...)
! 
! <li> Log shipping fix - storage of sl_setsync_offline call had a wrong
!   printf type; change from %d to %s
! </ul>
  ---
- Slony-I Release - 1.1.7
- http://main.slony.info/downloads/1.1
- 2007-03-07
- Chris Browne
- We are pleased to announce the release of version 1.1.7, which may be
- found <a href="http://main.slony.info/downloads/1.1/source/slony1-1.1.7.tar.bz2">here</a>.  
- It fixes several problems that were found in the 1.2 stream that were readily back-ported to 1.1:
- <ul>
- <li>Add remote_listen_timeout parameter to <tt>slon.conf</tt>
- 
- <p> This addresses the problem where a slon times out when accessing
- sl_event if a node has been out of commission for a long time (several
- days)
- 
- <li> Add node numbers to error reports in slonik
- 
- <p> If portions of UNINSTALL NODE break, report in the error message which node
- it was working on.  That way the gentle user gets an indication as to 
- which node 'broke' if the slonik script contained multiple such
- requests.
- 
- <li> Applied bug fix for #1538
- 
- <p> If cluster has only one node, then remove all events up to the last
- SYNC.  That allows the cleanup loop to clear out sl_log_{1/2}.
- Otherwise, the log tables will forever bloat until you add a second
- node...
- 
- <li> Added test to test1 for function generate_sync_event() and make_function_strict
- 
- <li> Added "v81" files (for slony1_base.v81.sql, slony1_funcs.v81.sql,
- xxid.v81.sql), necessary to support 8.1 "ALTER FUNCTION ... STRICT";
- 
- <li> Fixed quoting problem in generate_sync_event()
- 
- <li> Added functionality to UPDATE FUNCTIONS to make xxidin() function
- STRICT; the absence of this caused postmaster to fall over when
- processing MOVE SET event in PG v8.2 (not to say that Slony-I 1.1 now
- *supports* 8.2; it does not)
- 
- <li> When you run MOVE SET, this populates sl_setsync for the moved set
-   even on nodes that are not subscribed.  If, subsequent to doing this, 
-   you attempt a SUBSCRIBE SET for a formerly-unsubscribed node, the
-   subscription will fail right at the end when the slon tries to insert a
-   new value to sl_setsync.
- 
- <p>  The fix: DELETE from sl_setsync immediately before the INSERT.  This
-   will silently blow away any 'offending' sl_setsync row.
- 
- <P>  (As observed by Afilias staff...)
- 
- <li> Log shipping fix - storage of sl_setsync_offline call had a wrong
-   printf type; change from %d to %s
- </ul>
  ---
  Slony-I and PostgreSQL 8.1
--- 50,68 ----
    the offline replica and must increment gap free.
  
! <li> Change the filenames of archive logs to be based on internal archive
!   tracking number.  This makes it easy for the mechanism applying
!   archives to figure out what needs to be applied next - just look in
!   sl_archive_tracking.
  
+ <li> Fix log shipping test to accomodate the new tracking scheme, and
+   update documentation to describe this better.  
  </ul>
  
! The testing regimen included running all the tests in the test bed
! against instances of Slony-I running against PostgreSQL versions 7.4,
! 8.0, 8.1, 8.2, as well as CVS HEAD (forthcoming as 8.3).  There was
! also (against 7.4) a test done to verify that UPGRADE FUNCTIONS would
! bring version 1.1.x to 1.2.11.
  ---
  ---
  Slony-I and PostgreSQL 8.1

Index: news.txt
===================================================================
RCS file: /home/cvsd/slony1/slony1-www/content/news.txt,v
retrieving revision 1.31
retrieving revision 1.32
diff -C2 -d -r1.31 -r1.32
*** news.txt	21 Aug 2007 22:32:01 -0000	1.31
--- news.txt	28 Aug 2007 19:44:57 -0000	1.32
***************
*** 5,20 ****
  Chris Browne
  
! Slony-1 1.2.10 <a href="http://main.slony.info/downloads/1.2/source/slony1-1.2.10.tar.bz2">engine</a>
! <a href="http://main.slony.info/downloads/1.2/source/slony1-1.2.10-docs.tar.bz2">documentation</a>
  <br/>
  Slony-1 1.1.9 <a href="http://main.slony.info/downloads/1.1/source/slony1-1.1.9.tar.bz2">engine</a>
  <!-- Please keep this item at the top of the news list -->
  --
! Slony-I 1.2.11 pre-release #2 available
! http://slony.info/downloads/1.2/source/slony1-1.2.11-pre2.tar.bz2
! 2007-08-21
! Chris Browne
  
! A second tarball of Slony-I 1.2.11 is available for testing.
  
  <P> Fixes are the following:
--- 5,20 ----
  Chris Browne
  
! Slony-1 1.2.11 <a href="http://main.slony.info/downloads/1.2/source/slony1-1.2.11.tar.bz2">engine</a>
! <a href="http://main.slony.info/downloads/1.2/source/slony1-1.2.11-docs.tar.bz2">documentation</a>
  <br/>
  Slony-1 1.1.9 <a href="http://main.slony.info/downloads/1.1/source/slony1-1.1.9.tar.bz2">engine</a>
  <!-- Please keep this item at the top of the news list -->
  --
! Slony-I 1.2.11 released
! http://slony.info/downloads/1.2/source/slony1-1.2.11.tar.bz2
! 2007-08-28
! Christopher Browne
  
! We are pleased to announce general availability of Slony-I 1.2.11.
  
  <P> Fixes are the following:
***************
*** 56,59 ****
--- 56,66 ----
    the offline replica and must increment gap free.
  
+ <li> Change the filenames of archive logs to be based on internal archive
+   tracking number.  This makes it easy for the mechanism applying
+   archives to figure out what needs to be applied next - just look in
+   sl_archive_tracking.
+ 
+ <li> Fix log shipping test to accomodate the new tracking scheme, and
+   update documentation to describe this better.  
  </ul>
  ---

From cbbrowne at lists.slony.info  Tue Aug 28 12:46:56 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Aug 28 12:46:57 2007
Subject: [Slony1-commit] slony1-www/content news.txt
Message-ID: <20070828194656.60CDA290C4A@main.slony.info>

Update of /home/cvsd/slony1/slony1-www/content
In directory main.slony.info:/tmp/cvs-serv22025/content

Modified Files:
	news.txt 
Log Message:
Fixes to news


Index: news.txt
===================================================================
RCS file: /home/cvsd/slony1/slony1-www/content/news.txt,v
retrieving revision 1.32
retrieving revision 1.33
diff -C2 -d -r1.32 -r1.33
*** news.txt	28 Aug 2007 19:44:57 -0000	1.32
--- news.txt	28 Aug 2007 19:46:54 -0000	1.33
***************
*** 65,107 ****
  </ul>
  ---
- Slony-I 1.2.11 pre-release available
- http://slony.info/downloads/1.2/source/slony1-1.2.11-pre1.tar.bz2
- 2007-08-03
- Chris Browne
- 
- A tarball of Slony-I 1.2.11 is available for testing.
- 
- <P> Fixes are the following:
- <ul>
- <li> Add in tools/mkservice scripts previously added to CVS HEAD
- 
- <li> During subscription, do UPDATE to pg_class.relhasindex *after* the
-   TRUNCATE because, in 8.2+, TRUNCATE resets this attribute
- 
- <li> Fixed a problem with the setsync tracking with Log Shipping in cases
-   where slon does an internal restart (thereby rereading the
-   pset.ssy_seqno) and ignoring non-SYNC events because those don't
-   change the sl_setsync table.
- 
- <li> More explicit type casting of text objects for compatibility with
-   PostgreSQL 8.3
- 
- <li> Fixed problem with DDL SCRIPT statement parser: it wasn't 'quoting'
-   semicolons inside parentheses (this notably occurs in CREATE RULE).
- 
- <li> Fixed problem with DDL SCRIPT statement submission; it was
-   interpreting the statement as a format string, which would have
-   ill effects in the presence of things that are interpreted such
-   as format strings (%d, %f, %s) and \backslashed things like \\, \n.
- 
- <li> Further DDL Script issue: non-terminated statement at the end
-   (e.g. - without trailing semicolon ";") would get omitted.
- 
- <li> Typo fix: when trying to disable a node, the logs would report
-   "enableNode" rather than "disableNode".  Fixed.
- 
- <li> Add usage/version options to help output in slon.
- </ul>
- ---
  Generating RPMS for Slony-I
  http://slony.info/
--- 65,68 ----

From cbbrowne at lists.slony.info  Tue Aug 28 12:48:47 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Aug 28 12:48:48 2007
Subject: [Slony1-commit] slony1-www/content news.txt
Message-ID: <20070828194847.897DF290C17@main.slony.info>

Update of /home/cvsd/slony1/slony1-www/content
In directory main.slony.info:/home/community/slony/htdocs/content

Modified Files:
	news.txt 
Log Message:
Fix --- used as section separator


Index: news.txt
===================================================================
RCS file: /home/cvsd/slony1/slony1-www/content/news.txt,v
retrieving revision 1.33
retrieving revision 1.34
diff -C2 -d -r1.33 -r1.34
*** news.txt	28 Aug 2007 19:46:54 -0000	1.33
--- news.txt	28 Aug 2007 19:48:45 -0000	1.34
***************
*** 10,14 ****
  Slony-1 1.1.9 <a href="http://main.slony.info/downloads/1.1/source/slony1-1.1.9.tar.bz2">engine</a>
  <!-- Please keep this item at the top of the news list -->
! --
  Slony-I 1.2.11 released
  http://slony.info/downloads/1.2/source/slony1-1.2.11.tar.bz2
--- 10,14 ----
  Slony-1 1.1.9 <a href="http://main.slony.info/downloads/1.1/source/slony1-1.1.9.tar.bz2">engine</a>
  <!-- Please keep this item at the top of the news list -->
! ---
  Slony-I 1.2.11 released
  http://slony.info/downloads/1.2/source/slony1-1.2.11.tar.bz2

From devrim at lists.slony.info  Tue Aug 28 22:45:00 2007
From: devrim at lists.slony.info (Devrim GUNDUZ)
Date: Tue Aug 28 22:45:02 2007
Subject: [Slony1-commit] slony1-engine/redhat postgresql-slony1-engine.init
	postgresql-slony1-engine.specfile
Message-ID: <20070829054500.6A767290BFF@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/redhat
In directory main.slony.info:/tmp/cvs-serv418/redhat

Removed Files:
      Tag: REL_1_2_STABLE
	postgresql-slony1-engine.init 
	postgresql-slony1-engine.specfile 
Log Message:
Remove -engine from spec file name
Fix configure and configure.ac accordingly
Update docs for the file name change
Update release_checklist.sh


--- postgresql-slony1-engine.specfile DELETED ---

--- postgresql-slony1-engine.init DELETED ---

From devrim at lists.slony.info  Tue Aug 28 22:45:00 2007
From: devrim at lists.slony.info (Devrim GUNDUZ)
Date: Tue Aug 28 22:45:03 2007
Subject: [Slony1-commit] slony1-engine/tools release_checklist.sh
Message-ID: <20070829054500.75CAE290C4F@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/tools
In directory main.slony.info:/tmp/cvs-serv418/tools

Modified Files:
      Tag: REL_1_2_STABLE
	release_checklist.sh 
Log Message:
Remove -engine from spec file name
Fix configure and configure.ac accordingly
Update docs for the file name change
Update release_checklist.sh


Index: release_checklist.sh
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tools/release_checklist.sh,v
retrieving revision 1.1.2.4
retrieving revision 1.1.2.5
diff -C2 -d -r1.1.2.4 -r1.1.2.5
*** release_checklist.sh	8 Jan 2007 17:41:56 -0000	1.1.2.4
--- release_checklist.sh	29 Aug 2007 05:44:58 -0000	1.1.2.5
***************
*** 33,37 ****
  fi
  
! if [[ `egrep "^PACKAGE_STRING='postgresql-slony1-engine ${VERDOTTED}'\$" configure` ]]; then
     echo "PACKAGE_STRING in configure matches ${VERDOTTED}"
  else
--- 33,37 ----
  fi
  
! if [[ `egrep "^PACKAGE_STRING='postgresql-slony1 ${VERDOTTED}'\$" configure` ]]; then
     echo "PACKAGE_STRING in configure matches ${VERDOTTED}"
  else

From devrim at lists.slony.info  Tue Aug 28 22:45:00 2007
From: devrim at lists.slony.info (Devrim GUNDUZ)
Date: Tue Aug 28 22:45:03 2007
Subject: [Slony1-commit] slony1-engine/doc/adminguide installation.sgml
	releasechecklist.sgml
Message-ID: <20070829054500.72356290C02@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/doc/adminguide
In directory main.slony.info:/tmp/cvs-serv418/doc/adminguide

Modified Files:
      Tag: REL_1_2_STABLE
	installation.sgml releasechecklist.sgml 
Log Message:
Remove -engine from spec file name
Fix configure and configure.ac accordingly
Update docs for the file name change
Update release_checklist.sh


Index: releasechecklist.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/releasechecklist.sgml,v
retrieving revision 1.3.2.5
retrieving revision 1.3.2.6
diff -C2 -d -r1.3.2.5 -r1.3.2.6
*** releasechecklist.sgml	16 Mar 2007 19:01:26 -0000	1.3.2.5
--- releasechecklist.sgml	29 Aug 2007 05:44:58 -0000	1.3.2.6
***************
*** 66,70 ****
  <listitem><para>PACKAGE_VERSION=REL_1_1_2</para></listitem>
  
! <listitem><para>PACKAGE_STRING=postgresql-slony1-engine REL_1_1_2</para></listitem>
  
  </itemizedlist>
--- 66,70 ----
  <listitem><para>PACKAGE_VERSION=REL_1_1_2</para></listitem>
  
! <listitem><para>PACKAGE_STRING=postgresql-slony1 REL_1_1_2</para></listitem>
  
  </itemizedlist>

Index: installation.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/installation.sgml,v
retrieving revision 1.28.2.2
retrieving revision 1.28.2.3
diff -C2 -d -r1.28.2.2 -r1.28.2.3
*** installation.sgml	11 Jun 2007 16:01:33 -0000	1.28.2.2
--- installation.sgml	29 Aug 2007 05:44:58 -0000	1.28.2.3
***************
*** 267,271 ****
  installing any RPM.</para>
  
! <screen>rpm -ivh postgresql-slony1-engine-....rpm</screen>
  
  <para>If you want to upgrade the previous version, just use 
--- 267,271 ----
  installing any RPM.</para>
  
! <screen>rpm -ivh postgresql-slony1-....rpm</screen>
  
  <para>If you want to upgrade the previous version, just use 
***************
*** 278,282 ****
  are installed in <filename>/usr/lib/pgsql</filename>, and finally the
  docs are installed in
! <filename>/usr/share/doc/postgresql-slony1-engine</filename>.</para>
  
  </sect2>
--- 278,282 ----
  are installed in <filename>/usr/lib/pgsql</filename>, and finally the
  docs are installed in
! <filename>/usr/share/doc/postgresql-slony1</filename>.</para>
  
  </sect2>

From devrim at lists.slony.info  Tue Aug 28 22:45:00 2007
From: devrim at lists.slony.info (Devrim GUNDUZ)
Date: Tue Aug 28 22:45:03 2007
Subject: [Slony1-commit] slony1-engine INSTALL configure configure.ac
	postgresql-slony1-engine.spec.in postgresql-slony1.spec.in
Message-ID: <20070829054501.79284290C02@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine
In directory main.slony.info:/tmp/cvs-serv418

Modified Files:
      Tag: REL_1_2_STABLE
	INSTALL configure configure.ac 
Added Files:
      Tag: REL_1_2_STABLE
	postgresql-slony1.spec.in 
Removed Files:
      Tag: REL_1_2_STABLE
	postgresql-slony1-engine.spec.in 
Log Message:
Remove -engine from spec file name
Fix configure and configure.ac accordingly
Update docs for the file name change
Update release_checklist.sh


--- NEW FILE: postgresql-slony1.spec.in ---
%{!?docs:%define docs 1}
%{?buildrhel3:%define kerbdir /usr/kerberos}
%{!?kerbdir:%define kerbdir "/usr"}

Summary:	A "master to multiple slaves" replication system with cascading and failover
Name:		@PACKAGE_NAME@
Version:	@PACKAGE_VERSION@
Release:	1%{?dist}
License:	BSD
Group:		Applications/Databases
URL:		http://main.slony.info/
Source0:	http://main.slony.info/downloads/1.2/source/@PACKAGE_NAME@-%{version}.tar.bz2
BuildRoot:	%{_tmppath}/%{name}-%{version}-%{release}-root-%(%{__id_u} -n)
BuildRequires:	postgresql-devel, postgresql-server, initscripts
Requires:	postgresql-server 

%if %docs
BuildRequires:	docbook-style-dsssl
%endif

%description
Slony-I is a "master to multiple slaves" replication 
system for PostgreSQL with cascading and failover.

The big picture for the development of Slony-I is to build
a master-slave system that includes all features and
capabilities needed to replicate large databases to a
reasonably limited number of slave systems.

Slony-I is a system for data centers and backup
sites, where the normal mode of operation is that all nodes
are available

%if %docs
%package docs
Summary:	Documentation for Slony-I
Group:		Applications/Databases
Requires:	@PACKAGE_NAME@-@PACKAGE_VERSION@-%{release}
BuildRequires:	libjpeg, netpbm-progs, groff, docbook-style-dsssl, ghostscript

%description docs
The @PACKAGE_NAME@-docs package includes some 
documentation for Slony-I.
%endif

%prep
%setup -q -n @PACKAGE_NAME@-%{version}

%build

# Temporary measure for 1.2.10
%if %docs
find doc/ -type f -exec chmod 600 {} \;
%endif

CFLAGS="${CFLAGS:-%optflags}" ; export CFLAGS
CXXFLAGS="${CXXFLAGS:-%optflags}" ; export CXXFLAGS
CPPFLAGS="${CPPFLAGS} -I%{_includedir}/et -I%{kerbdir}/include" ; export CPPFLAGS
CFLAGS="${CFLAGS} -I%{_includedir}/et -I%{kerbdir}/include" ; export CFLAGS

export LIBNAME=%{_lib}
%configure --includedir %{_includedir}/pgsql --with-pgconfigdir=%{_bindir} --libdir=%{_libdir} \
	--with-perltools=%{_bindir} --with-toolsbin=%{_bindir} \
%if %docs
	--with-docs --with-docdir=%{_docdir}/%{name}-%{version} \
%endif
	--datadir %{_datadir}/pgsql --with-pglibdir=%{_libdir}/pgsql 

make %{?_smp_mflags}
make %{?_smp_mflags} -C tools

%install
rm -rf %{buildroot}
install -d %{buildroot}%{_sysconfdir}
install -d %{buildroot}%{_datadir}/pgsql/
install -d %{buildroot}%{_libdir}/pgsql/
make %{?_smp_mflags} DESTDIR=%{buildroot} install
install -m 0755 src/backend/slony1_funcs.so %{buildroot}%{_libdir}/pgsql/slony1_funcs.so
install -m 0755 src/xxid/xxid.so %{buildroot}%{_libdir}/pgsql/xxid.so
install -m 0644 src/backend/*.sql %{buildroot}%{_datadir}/pgsql/
install -m 0644 src/xxid/*.sql %{buildroot}%{_datadir}/pgsql/
install -m 0755 tools/*.sh  %{buildroot}%{_bindir}/
install -m 0644 share/slon.conf-sample %{buildroot}%{_sysconfdir}/slon.conf
/bin/chmod 644 COPYRIGHT UPGRADING SAMPLE HISTORY-1.1 RELEASE

install -d %{buildroot}%{_initrddir}
install -m 755 redhat/postgresql-slony1.init %{buildroot}%{_initrddir}/postgresql-slony1

# Temporary measure for 1.2.10
%if %docs
	rm -f doc/implementation/.cvsignore
	rm -f doc/concept/.cvsignore
%endif

cd tools
make %{?_smp_mflags} DESTDIR=%{buildroot} install
/bin/rm -rf altperl/*.pl altperl/ToDo altperl/README altperl/Makefile altperl/CVS
install -m 0644 altperl/slon_tools.conf-sample  %{buildroot}%{_sysconfdir}/slon_tools.conf
install -m 0755 altperl/* %{buildroot}%{_bindir}/
install -m 0644 altperl/slon-tools  %{buildroot}%{_libdir}/pgsql/slon-tools.pm
/bin/rm -f %{buildroot}%{_sysconfdir}/slon_tools.conf-sample
/bin/rm -f %{buildroot}%{_bindir}/slon_tools.conf-sample
/bin/rm -f %{buildroot}%{_bindir}/slon-tools.pm
/bin/rm -f %{buildroot}%{_bindir}/slon-tools
/bin/rm -f %{buildroot}%{_bindir}/pgsql/slon-tools
/bin/rm -f %{buildroot}%{_bindir}/old-apache-rotatelogs.patch

%clean
rm -rf %{buildroot}

%post
chkconfig --add @PACKAGE_NAME@

%preun
if [ $1 = 0 ] ; then
	/sbin/service @PACKAGE_NAME@ condstop >/dev/null 2>&1
	chkconfig --del @PACKAGE_NAME@
fi

%postun
if [ $1 -ge 1 ]; then
	/sbin/service @PACKAGE_NAME@ condrestart >/dev/null 2>&1
fi

%files
%defattr(-,root,root,-)
%attr(644,root,root) %doc COPYRIGHT UPGRADING HISTORY-1.1 INSTALL SAMPLE RELEASE
%{_bindir}/*
%{_libdir}/pgsql/slony1_funcs.so
%{_libdir}/pgsql/xxid.so
%{_datadir}/pgsql/*.sql
%config(noreplace) %{_sysconfdir}/slon.conf
%{_libdir}/pgsql/slon-tools.pm
%config(noreplace) %{_sysconfdir}/slon_tools.conf
%attr(755,root,root) %{_sysconfdir}/rc.d/init.d/@PACKAGE_NAME@

%if %docs
%files docs
%attr(644,root,root) %doc doc/adminguide  doc/concept  doc/howto  doc/implementation  doc/support
%endif

%changelog
* Wed Aug 29 2007 Devrim Gunduz <devrim@CommandPrompt.com> 1.2.11-1
- Update to 1.2.11
- Remove the word "engine" from init script name.

* Mon Aug 6 2007 Devrim Gunduz <devrim@CommandPrompt.com> 1.2.10-2
- Fix Source0
- Spec file cleanup (removed macro for perltools)
- Added initscripts as BR.
- Fix doc package installation path (and ownership issue)

* Wed Jun 13 2007 Devrim Gunduz <devrim@CommandPrompt.com> 1.2.10-1
- Update to 1.2.10

* Mon Jun 11 2007 Devrim Gunduz <devrim@CommandPrompt.com> 1.2.9-3
- Add BuildRequires for docs subpackage, per #199154 (Thanks Ruben).

* Sun Jun 3 2007 Devrim Gunduz <devrim@CommandPrompt.com> 1.2.9-2
- Some more fixes for Fedora review.
- Remove executable bits from docs.

* Thu May 17 2007 Devrim Gunduz <devrim@CommandPrompt.com>
- Install init script with rpm.
- Fix --with-pgconfigdir parameter.
- Fix rpm build problem when the system has pg_config in both under
  /usr/local/pgsql/bin and /usr/bin

* Wed Mar 22 2007 Christopher Browne <cbbrowne@ca.afilias.info>
- Added more recent release notes

* Wed Mar 7 2007 Christopher Browne <cbbrowne@ca.afilias.info>
- Added more recent release notes

* Thu Jan 4 2007 Devrim Gunduz <devrim@CommandPrompt.com>
- Add docs package (It should be added before but...)

* Wed Nov 8 2006 Devrim Gunduz <devrim@CommandPrompt.com>
- On 64-bit boxes, both 32 and 64 bit -devel packages may be installed. 
  Fix version check script
- Revert tar name patch
- Macros cannot be used in various parts of the spec file. Revert that commit
- Spec file cleanup

* Tue Oct 31 2006 Trevor Astrope <astrope@sitesell.com>
- Fixup tar name and install slon-tools as slon-tools.pm

* Mon Jul 17 2006 Devrim Gunduz <devrim@CommandPrompt.com> postgresql-slony1-engine
- Updated spec and cleaned up rpmlint errors and warnings

* Wed Dec 21 2005 Devrim Gunduz <devrim@commandprompt.com> postgresql-slony1-engine
- Added a buildrhel3 macro to fix RHEL 3 RPM builds
- Added a kerbdir macro

* Wed Dec 14 2005 Devrim Gunduz <devrim@commandprompt.com> postgresql-slony1-engine
- Fixed the spec file so that during upgrade, conf files will not be replaced, and a .rpmnew will be created.

* Thu Nov 24 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Created bindir

* Wed Oct 26 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Modify CPPFLAGS and CFLAGS to fix builds on RHEL -- Per Philip Yarra

* Tue Oct 18 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Created a new package : -docs and moved all the docs there.

* Tue Oct 18 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Fixed the problem in http://gborg.postgresql.org/pipermail/slony1-general/2005-October/003105.html

* Sat Oct 01 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Upgrade to 1.1.1

* Tue Jul 12 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Added a line to check postgresql RPM version and tag SlonyI RPM with it.
- Updated Requires files so that it checks correct PostgreSQL version
- Moved autoconf line into correct place.

* Thu Jun 08 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Added UPGRADING, HISTORY-1.1, INSTALL, SAMPLE among installed files, reflecting the change in GNUMakefile.in

* Thu Jun 02 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Apply a new %docs macro and disable building of docs by default.
- Remove slon-tools.conf-sample from bindir.
- Removed --bindir and --libdir, since they are not needed.

* Mon Apr 10 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- More fixes on RPM builds

* Thu Apr 07 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- More fixes on RPM builds

* Tue Apr 04 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Fix RPM build errors, regarding to tools/ .

* Thu Apr 02 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Added docs to installed files list.
- Added perltools, so that tools/altperl may be compiled.
- Updated the spec file

* Thu Mar 17 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Update to 1.1.0beta1
- Remove PostgreSQL source dependency

* Thu Mar 17 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Fix RPM builds

* Thu Mar 18 2004 Daniel Berrange <berrange@redhat.com> postgresql-slony1-engine
- Initial RPM packaging


--- postgresql-slony1-engine.spec.in DELETED ---

Index: configure.ac
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/configure.ac,v
retrieving revision 1.57.2.3
retrieving revision 1.57.2.4
diff -C2 -d -r1.57.2.3 -r1.57.2.4
*** configure.ac	2 May 2007 21:37:06 -0000	1.57.2.3
--- configure.ac	29 Aug 2007 05:44:58 -0000	1.57.2.4
***************
*** 16,20 ****
      -e 's/\ //g' -e s/\:/`date +HEAD_%Y%m%d`/ | tr -d '\n']))
  
! AC_INIT(postgresql-slony1-engine,[SLONREL_VERSION])
  AC_CONFIG_HEADERS(config.h)
  AC_CONFIG_AUX_DIR(config)
--- 16,20 ----
      -e 's/\ //g' -e s/\:/`date +HEAD_%Y%m%d`/ | tr -d '\n']))
  
! AC_INIT(postgresql-slony1,[SLONREL_VERSION])
  AC_CONFIG_HEADERS(config.h)
  AC_CONFIG_AUX_DIR(config)
***************
*** 244,248 ****
  
  AC_OUTPUT([
!     postgresql-slony1-engine.spec
      Makefile.port:makefiles/Makefile.${template}
  ])
--- 244,248 ----
  
  AC_OUTPUT([
!     postgresql-slony1.spec
      Makefile.port:makefiles/Makefile.${template}
  ])

Index: configure
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/configure,v
retrieving revision 1.70.2.6
retrieving revision 1.70.2.7
diff -C2 -d -r1.70.2.6 -r1.70.2.7
*** configure	5 Jun 2007 16:14:54 -0000	1.70.2.6
--- configure	29 Aug 2007 05:44:57 -0000	1.70.2.7
***************
*** 1,5 ****
  #! /bin/sh
  # Guess values for system-dependent variables and create Makefiles.
! # Generated by GNU Autoconf 2.61 for postgresql-slony1-engine HEAD_20070509.
  #
  # Copyright (C) 1992, 1993, 1994, 1995, 1996, 1998, 1999, 2000, 2001,
--- 1,5 ----
  #! /bin/sh
  # Guess values for system-dependent variables and create Makefiles.
! # Generated by GNU Autoconf 2.61 for postgresql-slony1 HEAD_20070509.
  #
  # Copyright (C) 1992, 1993, 1994, 1995, 1996, 1998, 1999, 2000, 2001,
***************
*** 571,578 ****
  
  # Identity of this package.
! PACKAGE_NAME='postgresql-slony1-engine'
! PACKAGE_TARNAME='postgresql-slony1-engine'
  PACKAGE_VERSION='HEAD_20070509'
! PACKAGE_STRING='postgresql-slony1-engine HEAD_20070509'
  PACKAGE_BUGREPORT=''
  
--- 571,578 ----
  
  # Identity of this package.
! PACKAGE_NAME='postgresql-slony1'
! PACKAGE_TARNAME='postgresql-slony1'
  PACKAGE_VERSION='HEAD_20070509'
! PACKAGE_STRING='postgresql-slony1 HEAD_20070509'
  PACKAGE_BUGREPORT=''
  
***************
*** 1237,1241 ****
    # This message is too long to be a string in the A/UX 3.1 sh.
    cat <<_ACEOF
! \`configure' configures postgresql-slony1-engine HEAD_20070509 to adapt to many kinds of systems.
  
  Usage: $0 [OPTION]... [VAR=VALUE]...
--- 1237,1241 ----
    # This message is too long to be a string in the A/UX 3.1 sh.
    cat <<_ACEOF
! \`configure' configures postgresql-slony1 HEAD_20070509 to adapt to many kinds of systems.
  
  Usage: $0 [OPTION]... [VAR=VALUE]...
***************
*** 1285,1289 ****
    --localedir=DIR        locale-dependent data [DATAROOTDIR/locale]
    --mandir=DIR           man documentation [DATAROOTDIR/man]
!   --docdir=DIR           documentation root [DATAROOTDIR/doc/postgresql-slony1-engine]
    --htmldir=DIR          html documentation [DOCDIR]
    --dvidir=DIR           dvi documentation [DOCDIR]
--- 1285,1289 ----
    --localedir=DIR        locale-dependent data [DATAROOTDIR/locale]
    --mandir=DIR           man documentation [DATAROOTDIR/man]
!   --docdir=DIR           documentation root [DATAROOTDIR/doc/postgresql-slony1]
    --htmldir=DIR          html documentation [DOCDIR]
    --dvidir=DIR           dvi documentation [DOCDIR]
***************
*** 1302,1306 ****
  if test -n "$ac_init_help"; then
    case $ac_init_help in
!      short | recursive ) echo "Configuration of postgresql-slony1-engine HEAD_20070509:";;
     esac
    cat <<\_ACEOF
--- 1302,1306 ----
  if test -n "$ac_init_help"; then
    case $ac_init_help in
!      short | recursive ) echo "Configuration of postgresql-slony1 HEAD_20070509:";;
     esac
    cat <<\_ACEOF
***************
*** 1407,1411 ****
  if $ac_init_version; then
    cat <<\_ACEOF
! postgresql-slony1-engine configure HEAD_20070509
  generated by GNU Autoconf 2.61
  
--- 1407,1411 ----
  if $ac_init_version; then
    cat <<\_ACEOF
! postgresql-slony1 configure HEAD_20070509
  generated by GNU Autoconf 2.61
  
***************
*** 1421,1425 ****
  running configure, to aid debugging if configure makes a mistake.
  
! It was created by postgresql-slony1-engine $as_me HEAD_20070509, which was
  generated by GNU Autoconf 2.61.  Invocation command line was
  
--- 1421,1425 ----
  running configure, to aid debugging if configure makes a mistake.
  
! It was created by postgresql-slony1 $as_me HEAD_20070509, which was
  generated by GNU Autoconf 2.61.  Invocation command line was
  
***************
*** 10741,10745 ****
  
  
! ac_config_files="$ac_config_files postgresql-slony1-engine.spec Makefile.port:makefiles/Makefile.${template}"
  
  cat >confcache <<\_ACEOF
--- 10741,10745 ----
  
  
! ac_config_files="$ac_config_files postgresql-slony1.spec Makefile.port:makefiles/Makefile.${template}"
  
  cat >confcache <<\_ACEOF
***************
*** 11139,11143 ****
  # values after options handling.
  ac_log="
! This file was extended by postgresql-slony1-engine $as_me HEAD_20070509, which was
  generated by GNU Autoconf 2.61.  Invocation command line was
  
--- 11139,11143 ----
  # values after options handling.
  ac_log="
! This file was extended by postgresql-slony1 $as_me HEAD_20070509, which was
  generated by GNU Autoconf 2.61.  Invocation command line was
  
***************
*** 11188,11192 ****
  cat >>$CONFIG_STATUS <<_ACEOF
  ac_cs_version="\\
! postgresql-slony1-engine config.status HEAD_20070509
  configured by $0, generated by GNU Autoconf 2.61,
    with options \\"`echo "$ac_configure_args" | sed 's/^ //; s/[\\""\`\$]/\\\\&/g'`\\"
--- 11188,11192 ----
  cat >>$CONFIG_STATUS <<_ACEOF
  ac_cs_version="\\
! postgresql-slony1 config.status HEAD_20070509
  configured by $0, generated by GNU Autoconf 2.61,
    with options \\"`echo "$ac_configure_args" | sed 's/^ //; s/[\\""\`\$]/\\\\&/g'`\\"
***************
*** 11298,11302 ****
      "Makefile.global") CONFIG_FILES="$CONFIG_FILES Makefile.global" ;;
      "GNUmakefile") CONFIG_FILES="$CONFIG_FILES GNUmakefile" ;;
!     "postgresql-slony1-engine.spec") CONFIG_FILES="$CONFIG_FILES postgresql-slony1-engine.spec" ;;
      "Makefile.port") CONFIG_FILES="$CONFIG_FILES Makefile.port:makefiles/Makefile.${template}" ;;
  
--- 11298,11302 ----
      "Makefile.global") CONFIG_FILES="$CONFIG_FILES Makefile.global" ;;
      "GNUmakefile") CONFIG_FILES="$CONFIG_FILES GNUmakefile" ;;
!     "postgresql-slony1.spec") CONFIG_FILES="$CONFIG_FILES postgresql-slony1.spec" ;;
      "Makefile.port") CONFIG_FILES="$CONFIG_FILES Makefile.port:makefiles/Makefile.${template}" ;;
  

Index: INSTALL
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/INSTALL,v
retrieving revision 1.12.2.1
retrieving revision 1.12.2.2
diff -C2 -d -r1.12.2.1 -r1.12.2.2
*** INSTALL	11 Jun 2007 17:59:37 -0000	1.12.2.1
--- INSTALL	29 Aug 2007 05:44:57 -0000	1.12.2.2
***************
*** 148,152 ****
  authentication draws in a dependancy on Kerberos that isn't
  automatically detected.  You may need to add an -I path for
! /usr/kerberos/include; see postgresql-slony1-engine.spec for more
  details.
  
--- 148,152 ----
  authentication draws in a dependancy on Kerberos that isn't
  automatically detected.  You may need to add an -I path for
! /usr/kerberos/include; see postgresql-slony1.spec for more
  details.
  

From devrim at lists.slony.info  Tue Aug 28 22:47:30 2007
From: devrim at lists.slony.info (Devrim GUNDUZ)
Date: Tue Aug 28 22:47:31 2007
Subject: [Slony1-commit] slony1-engine/redhat postgresql-slony1.init
	postgresql-slony1.specfile
Message-ID: <20070829054730.15DD5290BFF@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/redhat
In directory main.slony.info:/tmp/cvs-serv534

Added Files:
      Tag: REL_1_2_STABLE
	postgresql-slony1.init postgresql-slony1.specfile 
Log Message:
Update RH spec file and init script, per the recent commit


--- NEW FILE: postgresql-slony1.init ---
#!/bin/sh
# postgresql    This is the init script for starting up the Slony-I
#
# chkconfig: - 64 36
# description: Starts and stops the Slon daemon that handles
#              Slony-I replication.
# processname: postgresql-slony1
# pidfile:	/var/run/postgresql-slony1.pid
#
# v1.0.0 Devrim GUNDUZ <devrim@CommandPrompt.com>
# - Initial version of Red Hat / Fedora init script, based on Ubuntu one.
# v1.0.1 Devrim GUNDUZ <devrim@CommandPrompt.com>
# - Added reload()
# v1.0.2 Devrim GUNDUZ <devrim@CommandPrompt.com>
# - Removed -engine from package name

if [ -r /etc/sysconfig/slony1 ]; then
    . /etc/sysconfig/slony1
fi

# Source function library.
INITD=/etc/rc.d/init.d
. $INITD/functions

# Get function listing for cross-distribution logic.
TYPESET=`typeset -f|grep "declare"`

# Get config.
. /etc/sysconfig/network

# For SELinux we need to use 'runuser' not 'su'
if [ -x /sbin/runuser ]
then
	SU=runuser
else
	SU=su
fi

# Check that networking is up.
# We need it for postgresql-slony1
[ "${NETWORKING}" = "no" ] && exit 0

# Find the name of the script
NAME=postgresql-slony1

# Set defaults for configuration variables
SLONENGINE=/usr/bin
SLONDAEMON=$SLONENGINE/slon
SLONCONF=/etc/slon.conf
SLONPID=/var/run/slon.pid
SLONLOG=/var/log/slony1
test -x $SLONDAEMON || exit 5


script_result=0

start(){
	SLON_START=$"Starting ${NAME} service: "

	echo -n "$SLON_START"
	$SU -l postgres -c "$SLONDAEMON -f $SLONCONF &" >> "$SLONLOG" 2>&1 < /dev/null
	sleep 2

	pid=`pidof -s "$SLONDAEMON"`
	if [ $pid ] 
	then
		success "$SLON_START"
		touch /var/lock/subsys/${NAME}
		echo
	else
		failure "$PSQL_START"
		echo
		script_result=1
	fi
}

stop(){
	echo -n $"Stopping ${NAME} service: "
        if [ $UID -ne 0 ]; then
                RETVAL=1
                failure
        else
                killproc /usr/bin/slon
                RETVAL=$?
                [ $RETVAL -eq 0 ] && rm -f /var/lock/subsys/${NAME}
        fi;
        echo
        return $RETVAL
}

restart(){
    stop
    start
}

reload(){
echo -n $"Reloading ${NAME}: "
   if [ -n "`pidfileofproc $SLONDAEMON`" ] ; then
      killproc $SLONDAEMON -HUP
   else
      failure $"Reloading ${NAME}"
   fi
   RETVAL=$?
   echo
}

condrestart(){
    [ -e /var/lock/subsys/${NAME} ] && restart
}

condstop(){
    [ -e /var/lock/subsys/${NAME} ] && stop
}

# See how we were called.
case "$1" in
  start)
        start
        ;;
  stop)
        stop
        ;;
  status)
        status slon
        script_result=$?
        ;;
  restart)
        restart
        ;;
  reload|force-reload)
        reload
        ;;
  condrestart)
        condrestart
        ;;
  condstop)
        condstop
        ;;
  *)
        echo $"Usage: $0 {start|stop|status|restart|condrestart|condstop|reload|force-reload}"
        exit 1
esac

exit $script_result

--- NEW FILE: postgresql-slony1.specfile ---
%{!?docs:%define docs 1}
%{?buildrhel3:%define kerbdir /usr/kerberos}
%{!?kerbdir:%define kerbdir "/usr"}

Summary:	A "master to multiple slaves" replication system with cascading and failover
Name:		postgresql-slony1
Version:	1.2.11
Release:	1%{?dist}
License:	BSD
Group:		Applications/Databases
URL:		http://main.slony.info/
Source0:	http://main.slony.info/downloads/1.2/source/postgresql-slony1-%{version}.tar.bz2
BuildRoot:	%{_tmppath}/%{name}-%{version}-%{release}-root-%(%{__id_u} -n)
BuildRequires:	postgresql-devel, postgresql-server, initscripts
Requires:	postgresql-server 

%if %docs
BuildRequires:	docbook-style-dsssl
%endif

%description
Slony-I is a "master to multiple slaves" replication 
system for PostgreSQL with cascading and failover.

The big picture for the development of Slony-I is to build
a master-slave system that includes all features and
capabilities needed to replicate large databases to a
reasonably limited number of slave systems.

Slony-I is a system for data centers and backup
sites, where the normal mode of operation is that all nodes
are available

%if %docs
%package docs
Summary:	Documentation for Slony-I
Group:		Applications/Databases
Requires:	postgresql-slony1-1.2.11-%{release}
BuildRequires:	libjpeg, netpbm-progs, groff, docbook-style-dsssl, ghostscript

%description docs
The postgresql-slony1-docs package includes some 
documentation for Slony-I.
%endif

%prep
%setup -q -n postgresql-slony1-%{version}

%build

# Temporary measure for 1.2.10
%if %docs
find doc/ -type f -exec chmod 600 {} \;
%endif

CFLAGS="${CFLAGS:-%optflags}" ; export CFLAGS
CXXFLAGS="${CXXFLAGS:-%optflags}" ; export CXXFLAGS
CPPFLAGS="${CPPFLAGS} -I%{_includedir}/et -I%{kerbdir}/include" ; export CPPFLAGS
CFLAGS="${CFLAGS} -I%{_includedir}/et -I%{kerbdir}/include" ; export CFLAGS

export LIBNAME=%{_lib}
%configure --includedir %{_includedir}/pgsql --with-pgconfigdir=%{_bindir} --libdir=%{_libdir} \
	--with-perltools=%{_bindir} --with-toolsbin=%{_bindir} \
%if %docs
	--with-docs --with-docdir=%{_docdir}/%{name}-%{version} \
%endif
	--datadir %{_datadir}/pgsql --with-pglibdir=%{_libdir}/pgsql 

make %{?_smp_mflags}
make %{?_smp_mflags} -C tools

%install
rm -rf %{buildroot}
install -d %{buildroot}%{_sysconfdir}
install -d %{buildroot}%{_datadir}/pgsql/
install -d %{buildroot}%{_libdir}/pgsql/
make %{?_smp_mflags} DESTDIR=%{buildroot} install
install -m 0755 src/backend/slony1_funcs.so %{buildroot}%{_libdir}/pgsql/slony1_funcs.so
install -m 0755 src/xxid/xxid.so %{buildroot}%{_libdir}/pgsql/xxid.so
install -m 0644 src/backend/*.sql %{buildroot}%{_datadir}/pgsql/
install -m 0644 src/xxid/*.sql %{buildroot}%{_datadir}/pgsql/
install -m 0755 tools/*.sh  %{buildroot}%{_bindir}/
install -m 0644 share/slon.conf-sample %{buildroot}%{_sysconfdir}/slon.conf
/bin/chmod 644 COPYRIGHT UPGRADING SAMPLE HISTORY-1.1 RELEASE

install -d %{buildroot}%{_initrddir}
install -m 755 redhat/postgresql-slony1.init %{buildroot}%{_initrddir}/postgresql-slony1

# Temporary measure for 1.2.10
%if %docs
	rm -f doc/implementation/.cvsignore
	rm -f doc/concept/.cvsignore
%endif

cd tools
make %{?_smp_mflags} DESTDIR=%{buildroot} install
/bin/rm -rf altperl/*.pl altperl/ToDo altperl/README altperl/Makefile altperl/CVS
install -m 0644 altperl/slon_tools.conf-sample  %{buildroot}%{_sysconfdir}/slon_tools.conf
install -m 0755 altperl/* %{buildroot}%{_bindir}/
install -m 0644 altperl/slon-tools  %{buildroot}%{_libdir}/pgsql/slon-tools.pm
/bin/rm -f %{buildroot}%{_sysconfdir}/slon_tools.conf-sample
/bin/rm -f %{buildroot}%{_bindir}/slon_tools.conf-sample
/bin/rm -f %{buildroot}%{_bindir}/slon-tools.pm
/bin/rm -f %{buildroot}%{_bindir}/slon-tools
/bin/rm -f %{buildroot}%{_bindir}/pgsql/slon-tools
/bin/rm -f %{buildroot}%{_bindir}/old-apache-rotatelogs.patch

%clean
rm -rf %{buildroot}

%post
chkconfig --add postgresql-slony1

%preun
if [ $1 = 0 ] ; then
	/sbin/service postgresql-slony1 condstop >/dev/null 2>&1
	chkconfig --del postgresql-slony1
fi

%postun
if [ $1 -ge 1 ]; then
	/sbin/service postgresql-slony1 condrestart >/dev/null 2>&1
fi

%files
%defattr(-,root,root,-)
%attr(644,root,root) %doc COPYRIGHT UPGRADING HISTORY-1.1 INSTALL SAMPLE RELEASE
%{_bindir}/*
%{_libdir}/pgsql/slony1_funcs.so
%{_libdir}/pgsql/xxid.so
%{_datadir}/pgsql/*.sql
%config(noreplace) %{_sysconfdir}/slon.conf
%{_libdir}/pgsql/slon-tools.pm
%config(noreplace) %{_sysconfdir}/slon_tools.conf
%attr(755,root,root) %{_sysconfdir}/rc.d/init.d/postgresql-slony1

%if %docs
%files docs
%attr(644,root,root) %doc doc/adminguide  doc/concept  doc/howto  doc/implementation  doc/support
%endif

%changelog
* Wed Aug 29 2007 Devrim Gunduz <devrim@CommandPrompt.com> 1.2.11-1
- Update to 1.2.11
- Remove the word "engine" from init script name.

* Mon Aug 6 2007 Devrim Gunduz <devrim@CommandPrompt.com> 1.2.10-2
- Fix Source0
- Spec file cleanup (removed macro for perltools)
- Added initscripts as BR.
- Fix doc package installation path (and ownership issue)

* Wed Jun 13 2007 Devrim Gunduz <devrim@CommandPrompt.com> 1.2.10-1
- Update to 1.2.10

* Mon Jun 11 2007 Devrim Gunduz <devrim@CommandPrompt.com> 1.2.9-3
- Add BuildRequires for docs subpackage, per #199154 (Thanks Ruben).

* Sun Jun 3 2007 Devrim Gunduz <devrim@CommandPrompt.com> 1.2.9-2
- Some more fixes for Fedora review.
- Remove executable bits from docs.

* Thu May 17 2007 Devrim Gunduz <devrim@CommandPrompt.com>
- Install init script with rpm.
- Fix --with-pgconfigdir parameter.
- Fix rpm build problem when the system has pg_config in both under
  /usr/local/pgsql/bin and /usr/bin

* Wed Mar 22 2007 Christopher Browne <cbbrowne@ca.afilias.info>
- Added more recent release notes

* Wed Mar 7 2007 Christopher Browne <cbbrowne@ca.afilias.info>
- Added more recent release notes

* Thu Jan 4 2007 Devrim Gunduz <devrim@CommandPrompt.com>
- Add docs package (It should be added before but...)

* Wed Nov 8 2006 Devrim Gunduz <devrim@CommandPrompt.com>
- On 64-bit boxes, both 32 and 64 bit -devel packages may be installed. 
  Fix version check script
- Revert tar name patch
- Macros cannot be used in various parts of the spec file. Revert that commit
- Spec file cleanup

* Tue Oct 31 2006 Trevor Astrope <astrope@sitesell.com>
- Fixup tar name and install slon-tools as slon-tools.pm

* Mon Jul 17 2006 Devrim Gunduz <devrim@CommandPrompt.com> postgresql-slony1-engine
- Updated spec and cleaned up rpmlint errors and warnings

* Wed Dec 21 2005 Devrim Gunduz <devrim@commandprompt.com> postgresql-slony1-engine
- Added a buildrhel3 macro to fix RHEL 3 RPM builds
- Added a kerbdir macro

* Wed Dec 14 2005 Devrim Gunduz <devrim@commandprompt.com> postgresql-slony1-engine
- Fixed the spec file so that during upgrade, conf files will not be replaced, and a .rpmnew will be created.

* Thu Nov 24 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Created bindir

* Wed Oct 26 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Modify CPPFLAGS and CFLAGS to fix builds on RHEL -- Per Philip Yarra

* Tue Oct 18 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Created a new package : -docs and moved all the docs there.

* Tue Oct 18 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Fixed the problem in http://gborg.postgresql.org/pipermail/slony1-general/2005-October/003105.html

* Sat Oct 01 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Upgrade to 1.1.1

* Tue Jul 12 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Added a line to check postgresql RPM version and tag SlonyI RPM with it.
- Updated Requires files so that it checks correct PostgreSQL version
- Moved autoconf line into correct place.

* Thu Jun 08 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Added UPGRADING, HISTORY-1.1, INSTALL, SAMPLE among installed files, reflecting the change in GNUMakefile.in

* Thu Jun 02 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Apply a new %docs macro and disable building of docs by default.
- Remove slon-tools.conf-sample from bindir.
- Removed --bindir and --libdir, since they are not needed.

* Mon Apr 10 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- More fixes on RPM builds

* Thu Apr 07 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- More fixes on RPM builds

* Tue Apr 04 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Fix RPM build errors, regarding to tools/ .

* Thu Apr 02 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Added docs to installed files list.
- Added perltools, so that tools/altperl may be compiled.
- Updated the spec file

* Thu Mar 17 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Update to 1.1.0beta1
- Remove PostgreSQL source dependency

* Thu Mar 17 2005 Devrim Gunduz <devrim@PostgreSQL.org> postgresql-slony1-engine
- Fix RPM builds

* Thu Mar 18 2004 Daniel Berrange <berrange@redhat.com> postgresql-slony1-engine
- Initial RPM packaging


From cbbrowne at lists.slony.info  Wed Aug 29 08:14:10 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Wed Aug 29 08:14:11 2007
Subject: [Slony1-commit] slony1-engine/src/parsestatements
	emptytestresult.expected.win32 test_sql.expected.win32
Message-ID: <20070829151410.D28EC290C59@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/parsestatements
In directory main.slony.info:/tmp/cvs-serv4729

Modified Files:
	emptytestresult.expected.win32 test_sql.expected.win32 
Log Message:
Revised expected parsing test results - per Hiroshi Saito


Index: emptytestresult.expected.win32
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/parsestatements/emptytestresult.expected.win32,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
Binary files /tmp/cvsIryMwb and /tmp/cvs11G7hg differ

Index: test_sql.expected.win32
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/parsestatements/test_sql.expected.win32,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** test_sql.expected.win32	22 Jun 2006 15:40:12 -0000	1.3
--- test_sql.expected.win32	29 Aug 2007 15:14:08 -0000	1.4
***************
*** 38,41 ****
--- 38,80 ----
  
  
+ -- Here is a rule creation with an embedded semicolon
+ -- "Dmitry Koterov" <dmitry@koterov.ru>
+ 
+ create table "public"."position";
+ 
+ CREATE RULE "position_get_last_id_on_insert2"
+ AS ON INSERT TO "public"."position" DO (SELECT
+ currval('position_position_id_seq'::regclass) AS id;);
+ 
+ -- Added to verify handling of queries tried by
+ -- "Dmitry Koterov" <dmitry@koterov.ru>
+ 
+ CREATE INDEX aaa ON public.bbb USING btree ((-ccc), ddd);
+ 
+ --  Apparently a pair of backslashes fold down into one?
+ -- "Dmitry Koterov" <dmitry@koterov.ru>
+ 
+ CREATE UNIQUE INDEX "i_dictionary_uni_abbr" ON "static"."dictionary"
+ USING btree ((substring(dic_russian, E'^([^(]*[^( ]) *\\('::text)))
+ WHERE (dic_category_id = 26);
+ 
+ -- Some more torturing per Weslee Bilodeau
+ 
+ -- I figure the $_$, $$, etc edge-casees would be another fun one to roll
+ -- into a custom parser.
+ 
+ CREATE FUNCTION test( ) RETURNS text AS $_$ SELECT ';', E'\';\'',
+ '"";""', E'"\';' ; SELECT 'OK'::text ; $_$ LANGUAGE SQL ;
+ 
+ SELECT $_$ hello; this ; - is '\" a '''' test $_$ ;
+ 
+ SELECT $$ $ test ; $ ;  $$ ;
+ 
+ -- All really funky, but perfectly valid.
+ 
+ -- Force a query to be at the end...
+ 
+ create table foo;
+ 
  statement 0
  -------------------------------------------
***************
*** 115,117 ****
      return NULL;
    end;
! $$ language plpgsql;
\ No newline at end of file
--- 154,223 ----
      return NULL;
    end;
! $$ language plpgsql;
! statement 14
! -------------------------------------------
! 
! 
! 
! -- Here is a rule creation with an embedded semicolon
! -- "Dmitry Koterov" <dmitry@koterov.ru>
! 
! create table "public"."position";
! statement 15
! -------------------------------------------
! 
! 
! CREATE RULE "position_get_last_id_on_insert2"
! AS ON INSERT TO "public"."position" DO (SELECT
! currval('position_position_id_seq'::regclass) AS id;);
! statement 16
! -------------------------------------------
! 
! 
! -- Added to verify handling of queries tried by
! -- "Dmitry Koterov" <dmitry@koterov.ru>
! 
! CREATE INDEX aaa ON public.bbb USING btree ((-ccc), ddd);
! statement 17
! -------------------------------------------
! 
! 
! --  Apparently a pair of backslashes fold down into one?
! -- "Dmitry Koterov" <dmitry@koterov.ru>
! 
! CREATE UNIQUE INDEX "i_dictionary_uni_abbr" ON "static"."dictionary"
! USING btree ((substring(dic_russian, E'^([^(]*[^( ]) *\\('::text)))
! WHERE (dic_category_id = 26);
! statement 18
! -------------------------------------------
! 
! 
! -- Some more torturing per Weslee Bilodeau
! 
! -- I figure the $_$, $$, etc edge-casees would be another fun one to roll
! -- into a custom parser.
! 
! CREATE FUNCTION test( ) RETURNS text AS $_$ SELECT ';', E'\';\'',
! '"";""', E'"\';' ; SELECT 'OK'::text ; $_$ LANGUAGE SQL ;
! statement 19
! -------------------------------------------
! 
! 
! SELECT $_$ hello; this ; - is '\" a '''' test $_$ ;
! statement 20
! -------------------------------------------
! 
! 
! SELECT $$ $ test ; $ ;  $$ ;
! statement 21
! -------------------------------------------
! 
! 
! -- All really funky, but perfectly valid.
! 
! -- Force a query to be at the end...
! 
! create table foo;
! statement 22
! -------------------------------------------
!   
\ No newline at end of file

From cbbrowne at lists.slony.info  Wed Aug 29 08:14:33 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Wed Aug 29 08:14:35 2007
Subject: [Slony1-commit] slony1-engine/src/parsestatements
	emptytestresult.expected.win32 test_sql.expected.win32
Message-ID: <20070829151433.C81E0290C5C@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/parsestatements
In directory main.slony.info:/tmp/cvs-serv4776

Modified Files:
      Tag: REL_1_2_STABLE
	emptytestresult.expected.win32 test_sql.expected.win32 
Log Message:
Revised expected parsing test results - per Hiroshi Saito


Index: emptytestresult.expected.win32
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/parsestatements/emptytestresult.expected.win32,v
retrieving revision 1.3
retrieving revision 1.3.2.1
diff -C2 -d -r1.3 -r1.3.2.1
Binary files /tmp/cvsAW52qT and /tmp/cvscAo13H differ

Index: test_sql.expected.win32
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/parsestatements/test_sql.expected.win32,v
retrieving revision 1.3
retrieving revision 1.3.2.1
diff -C2 -d -r1.3 -r1.3.2.1
*** test_sql.expected.win32	22 Jun 2006 15:40:12 -0000	1.3
--- test_sql.expected.win32	29 Aug 2007 15:14:31 -0000	1.3.2.1
***************
*** 38,41 ****
--- 38,80 ----
  
  
+ -- Here is a rule creation with an embedded semicolon
+ -- "Dmitry Koterov" <dmitry@koterov.ru>
+ 
+ create table "public"."position";
+ 
+ CREATE RULE "position_get_last_id_on_insert2"
+ AS ON INSERT TO "public"."position" DO (SELECT
+ currval('position_position_id_seq'::regclass) AS id;);
+ 
+ -- Added to verify handling of queries tried by
+ -- "Dmitry Koterov" <dmitry@koterov.ru>
+ 
+ CREATE INDEX aaa ON public.bbb USING btree ((-ccc), ddd);
+ 
+ --  Apparently a pair of backslashes fold down into one?
+ -- "Dmitry Koterov" <dmitry@koterov.ru>
+ 
+ CREATE UNIQUE INDEX "i_dictionary_uni_abbr" ON "static"."dictionary"
+ USING btree ((substring(dic_russian, E'^([^(]*[^( ]) *\\('::text)))
+ WHERE (dic_category_id = 26);
+ 
+ -- Some more torturing per Weslee Bilodeau
+ 
+ -- I figure the $_$, $$, etc edge-casees would be another fun one to roll
+ -- into a custom parser.
+ 
+ CREATE FUNCTION test( ) RETURNS text AS $_$ SELECT ';', E'\';\'',
+ '"";""', E'"\';' ; SELECT 'OK'::text ; $_$ LANGUAGE SQL ;
+ 
+ SELECT $_$ hello; this ; - is '\" a '''' test $_$ ;
+ 
+ SELECT $$ $ test ; $ ;  $$ ;
+ 
+ -- All really funky, but perfectly valid.
+ 
+ -- Force a query to be at the end...
+ 
+ create table foo;
+ 
  statement 0
  -------------------------------------------
***************
*** 115,117 ****
      return NULL;
    end;
! $$ language plpgsql;
\ No newline at end of file
--- 154,223 ----
      return NULL;
    end;
! $$ language plpgsql;
! statement 14
! -------------------------------------------
! 
! 
! 
! -- Here is a rule creation with an embedded semicolon
! -- "Dmitry Koterov" <dmitry@koterov.ru>
! 
! create table "public"."position";
! statement 15
! -------------------------------------------
! 
! 
! CREATE RULE "position_get_last_id_on_insert2"
! AS ON INSERT TO "public"."position" DO (SELECT
! currval('position_position_id_seq'::regclass) AS id;);
! statement 16
! -------------------------------------------
! 
! 
! -- Added to verify handling of queries tried by
! -- "Dmitry Koterov" <dmitry@koterov.ru>
! 
! CREATE INDEX aaa ON public.bbb USING btree ((-ccc), ddd);
! statement 17
! -------------------------------------------
! 
! 
! --  Apparently a pair of backslashes fold down into one?
! -- "Dmitry Koterov" <dmitry@koterov.ru>
! 
! CREATE UNIQUE INDEX "i_dictionary_uni_abbr" ON "static"."dictionary"
! USING btree ((substring(dic_russian, E'^([^(]*[^( ]) *\\('::text)))
! WHERE (dic_category_id = 26);
! statement 18
! -------------------------------------------
! 
! 
! -- Some more torturing per Weslee Bilodeau
! 
! -- I figure the $_$, $$, etc edge-casees would be another fun one to roll
! -- into a custom parser.
! 
! CREATE FUNCTION test( ) RETURNS text AS $_$ SELECT ';', E'\';\'',
! '"";""', E'"\';' ; SELECT 'OK'::text ; $_$ LANGUAGE SQL ;
! statement 19
! -------------------------------------------
! 
! 
! SELECT $_$ hello; this ; - is '\" a '''' test $_$ ;
! statement 20
! -------------------------------------------
! 
! 
! SELECT $$ $ test ; $ ;  $$ ;
! statement 21
! -------------------------------------------
! 
! 
! -- All really funky, but perfectly valid.
! 
! -- Force a query to be at the end...
! 
! create table foo;
! statement 22
! -------------------------------------------
!   
\ No newline at end of file

From cbbrowne at lists.slony.info  Wed Aug 29 13:02:58 2007
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Wed Aug 29 13:02:59 2007
Subject: [Slony1-commit] slony1-engine/src/slon remote_worker.c
Message-ID: <20070829200258.1D1D7290BFF@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slon
In directory main.slony.info:/tmp/cvs-serv8557

Modified Files:
      Tag: REL_1_2_STABLE
	remote_worker.c 
Log Message:
Fix format string typo - per dmitry@koterov.ru


Index: remote_worker.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/remote_worker.c,v
retrieving revision 1.124.2.22
retrieving revision 1.124.2.23
diff -C2 -d -r1.124.2.22 -r1.124.2.23
*** remote_worker.c	23 Aug 2007 18:08:53 -0000	1.124.2.22
--- remote_worker.c	29 Aug 2007 20:02:55 -0000	1.124.2.23
***************
*** 6024,6028 ****
  		
  		if (query_execute(node, local_dbconn, &query1) < 0) {
! 			slon_log(SLON_ERROR, "remoteWorkerThread_%d: DDL preparation failed - set %d - only on node %\n",
  					 node->no_id, ddl_setid, ddl_only_on_node);			
  			slon_retry();
--- 6024,6028 ----
  		
  		if (query_execute(node, local_dbconn, &query1) < 0) {
! 			slon_log(SLON_ERROR, "remoteWorkerThread_%d: DDL preparation failed - set %d - only on node %d\n",
  					 node->no_id, ddl_setid, ddl_only_on_node);			
  			slon_retry();

