From cbbrowne at lists.slony.info  Tue Jul  7 07:59:49 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Jul  7 07:59:50 2009
Subject: [Slony1-commit] slony1-engine/src/slony_logshipper scan.l
Message-ID: <20090707145949.3B6FD2903D9@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slony_logshipper
In directory main.slony.info:/tmp/cvs-serv9966

Modified Files:
	scan.l 
Log Message:
Need extra "*cp++ = c;" in 4 places in logshipping scanner.

Per Richard Yen, on mailing list


Index: scan.l
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slony_logshipper/scan.l,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** scan.l	13 May 2008 21:41:59 -0000	1.3
--- scan.l	7 Jul 2009 14:59:47 -0000	1.4
***************
*** 176,179 ****
--- 176,180 ----
  							}
  							*cp++ = c;
+ 							*cp++ = c;
  							len+=2;
  							continue;
***************
*** 192,195 ****
--- 193,197 ----
  							{
  								*cp++ = c;
+ 								*cp++ = c;
  								len+=2;
  								continue;
***************
*** 245,248 ****
--- 247,251 ----
  							}
  							*cp++ = c;
+ 							*cp++ = c;
  							len+=2;
  							continue;
***************
*** 261,264 ****
--- 264,268 ----
  							{
  								*cp++ = c;
+ 								*cp++ = c;
  								len+=2;
  								continue;

From cbbrowne at lists.slony.info  Tue Jul  7 08:00:05 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Jul  7 08:00:06 2009
Subject: [Slony1-commit] slony1-engine/src/slony_logshipper scan.l
Message-ID: <20090707150005.0620F2900F9@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slony_logshipper
In directory main.slony.info:/tmp/cvs-serv10023

Modified Files:
      Tag: REL_2_0_STABLE
	scan.l 
Log Message:
Need extra "*cp++ = c;" in 4 places in logshipping scanner.

Per Richard Yen, on mailing list



Index: scan.l
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slony_logshipper/scan.l,v
retrieving revision 1.3
retrieving revision 1.3.2.1
diff -C2 -d -r1.3 -r1.3.2.1
*** scan.l	13 May 2008 21:41:59 -0000	1.3
--- scan.l	7 Jul 2009 15:00:02 -0000	1.3.2.1
***************
*** 176,179 ****
--- 176,180 ----
  							}
  							*cp++ = c;
+ 							*cp++ = c;
  							len+=2;
  							continue;
***************
*** 192,195 ****
--- 193,197 ----
  							{
  								*cp++ = c;
+ 								*cp++ = c;
  								len+=2;
  								continue;
***************
*** 245,248 ****
--- 247,251 ----
  							}
  							*cp++ = c;
+ 							*cp++ = c;
  							len+=2;
  							continue;
***************
*** 261,264 ****
--- 264,268 ----
  							{
  								*cp++ = c;
+ 								*cp++ = c;
  								len+=2;
  								continue;

From cbbrowne at lists.slony.info  Tue Jul  7 08:00:18 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Jul  7 08:00:19 2009
Subject: [Slony1-commit] slony1-engine/src/slony_logshipper scan.l
Message-ID: <20090707150018.4E003290058@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slony_logshipper
In directory main.slony.info:/tmp/cvs-serv10333

Modified Files:
      Tag: REL_1_2_STABLE
	scan.l 
Log Message:
Need extra "*cp++ = c;" in 4 places in logshipping scanner.

Per Richard Yen, on mailing list



Index: scan.l
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slony_logshipper/scan.l,v
retrieving revision 1.1.2.2
retrieving revision 1.1.2.3
diff -C2 -d -r1.1.2.2 -r1.1.2.3
*** scan.l	13 May 2008 21:40:28 -0000	1.1.2.2
--- scan.l	7 Jul 2009 15:00:16 -0000	1.1.2.3
***************
*** 174,177 ****
--- 174,178 ----
  							}
  							*cp++ = c;
+ 							*cp++ = c;
  							len+=2;
  							continue;
***************
*** 190,193 ****
--- 191,195 ----
  							{
  								*cp++ = c;
+ 								*cp++ = c;
  								len+=2;
  								continue;
***************
*** 243,246 ****
--- 245,249 ----
  							}
  							*cp++ = c;
+ 							*cp++ = c;
  							len+=2;
  							continue;
***************
*** 259,262 ****
--- 262,266 ----
  							{
  								*cp++ = c;
+ 								*cp++ = c;
  								len+=2;
  								continue;

From cbbrowne at lists.slony.info  Wed Jul  8 13:37:41 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Wed Jul  8 13:37:43 2009
Subject: [Slony1-commit] slony1-engine/src/slony_logshipper
	slony_logshipper.c
Message-ID: <20090708203741.A665F29032B@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slony_logshipper
In directory main.slony.info:/tmp/cvs-serv17840

Modified Files:
      Tag: REL_1_2_STABLE
	slony_logshipper.c 
Log Message:
Apply change made in -r1.3 to the 1.2 branch as well


Index: slony_logshipper.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slony_logshipper/slony_logshipper.c,v
retrieving revision 1.1.2.1
retrieving revision 1.1.2.2
diff -C2 -d -r1.1.2.1 -r1.1.2.2
*** slony_logshipper.c	8 Sep 2007 14:21:40 -0000	1.1.2.1
--- slony_logshipper.c	8 Jul 2009 20:37:39 -0000	1.1.2.2
***************
*** 48,51 ****
--- 48,52 ----
   * Global data
   */
+ int         rescan_interval = 0;
  int			parse_errors = 0;
  int			opt_quiet = 0;
***************
*** 135,139 ****
  	 *
  	 */
! 	while ((opt = getopt(argc, (char **)argv, "hvqcflrtTw")) != EOF)
  	{
  		switch (opt)
--- 136,140 ----
  	 *
  	 */
! 	while ((opt = getopt(argc, (char **)argv, "hvqcflrtTws:")) != EOF)
  	{
  		switch (opt)
***************
*** 179,182 ****
--- 180,187 ----
  				opt_nowait = 1;
  				break;
+             
+             case 's':
+                 rescan_interval = atoi(optarg);
+                 break;
  
  			default:
***************
*** 312,316 ****
  
  			default:	if (!opt_quiet)
! 							printf("logshipper deamon created - pid = %d\n",
  									pid);
  						return 0;
--- 317,321 ----
  
  			default:	if (!opt_quiet)
! 							printf("logshipper daemon created - pid = %d\n",
  									pid);
  						return 0;
***************
*** 366,369 ****
--- 371,387 ----
  			break;
  
+ 		if (rc == -2)
+ 		{
+ 			archscan_sort = NULL;
+             errlog(LOG_INFO, "Queue is empty.  Going to rescan in %d seconds\n", rescan_interval);
+             sleep(rescan_interval);
+ 			if (archscan(optind, argc, (char **)argv) < 0)
+ 			{
+ 				return -1;
+ 			}
+             errlog(LOG_INFO, "Archive dir scanned\n");
+ 			continue;
+                }
+ 		
  		if (rc < 0)
  		{
***************
*** 1173,1176 ****
--- 1191,1195 ----
  		"      -f    stay in foreground (don't daemonize)\n"
  		"      -w    enter smart shutdown mode immediately\n"
+ 		"      -s    indicate (integer value) rescan interval\n"
  		"\n");
  	exit(1);

From cbbrowne at lists.slony.info  Wed Jul  8 13:46:04 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Wed Jul  8 13:46:06 2009
Subject: [Slony1-commit] slony1-engine RELEASE
Message-ID: <20090708204604.728A0290BE7@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine
In directory main.slony.info:/tmp/cvs-serv18909

Modified Files:
      Tag: REL_1_2_STABLE
	RELEASE 
Log Message:
Change version from 1.2.16 to 1.2.17, add notes to RELEASE


Index: RELEASE
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/RELEASE,v
retrieving revision 1.1.2.34
retrieving revision 1.1.2.35
diff -C2 -d -r1.1.2.34 -r1.1.2.35
*** RELEASE	30 Apr 2009 16:39:29 -0000	1.1.2.34
--- RELEASE	8 Jul 2009 20:46:02 -0000	1.1.2.35
***************
*** 1,3 ****
--- 1,8 ----
  $Id$
+ Release 1.2.17
+ 
+ - Apply changes to logshipper that went into the 2.0 branch but not
+   1.2
+ 
  Release 1.2.16
  

From cbbrowne at lists.slony.info  Wed Jul  8 13:46:04 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Wed Jul  8 13:46:06 2009
Subject: [Slony1-commit] slony1-engine/src/backend slony1_funcs.sql
Message-ID: <20090708204604.A3E31290BE9@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/backend
In directory main.slony.info:/tmp/cvs-serv18909/src/backend

Modified Files:
      Tag: REL_1_2_STABLE
	slony1_funcs.sql 
Log Message:
Change version from 1.2.16 to 1.2.17, add notes to RELEASE


Index: slony1_funcs.sql
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/backend/slony1_funcs.sql,v
retrieving revision 1.98.2.34
retrieving revision 1.98.2.35
diff -C2 -d -r1.98.2.34 -r1.98.2.35
*** slony1_funcs.sql	30 Apr 2009 16:20:27 -0000	1.98.2.34
--- slony1_funcs.sql	8 Jul 2009 20:46:02 -0000	1.98.2.35
***************
*** 431,435 ****
  as '
  begin
! 	return 16;
  end;
  ' language plpgsql;
--- 431,435 ----
  as '
  begin
! 	return 17;
  end;
  ' language plpgsql;

From cbbrowne at lists.slony.info  Tue Jul 14 12:09:02 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Jul 14 12:09:04 2009
Subject: [Slony1-commit] slony1-engine RELEASE config.h.in
Message-ID: <20090714190902.6D388290257@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine
In directory main.slony.info:/tmp/cvs-serv2542

Modified Files:
      Tag: REL_2_0_STABLE
	RELEASE config.h.in 
Log Message:
1.  Mark 2.0.3 version, preparatory to release

2.  Update release notes to include changes (to date) to 2.0.3

3.  slonik.c now recognizes PostgreSQL 8.4 properly


Index: RELEASE
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/RELEASE,v
retrieving revision 1.3.2.11
retrieving revision 1.3.2.12
diff -C2 -d -r1.3.2.11 -r1.3.2.12
*** RELEASE	1 May 2009 15:29:25 -0000	1.3.2.11
--- RELEASE	14 Jul 2009 19:09:00 -0000	1.3.2.12
***************
*** 90,91 ****
--- 90,112 ----
    misinterpreting PG return codes.  Rectified this, and added a
    test in to make sure we're exercising the logic
+ 
+ 
+ RELEASE 2.0.3
+ 
+ - PostgreSQL 8.4 has been released; slonik needs to explicitly recognize it
+ 
+ - Add in slonikconfdump.sh tool, which generates a slonik script to duplicate
+   the configuration of a Slony-I cluster
+ 
+ - Significant fixes to documentation to reflect 2.0 changes
+ 
+ - Add "OMIT COPY" option to the Slonik "SUBSCRIBE SET" command
+ 
+ - Document process for Slony-I 2.0 upgrade using OMIT COPY option
+ 
+ - Fix to race condition where file descriptor copies were being made at
+   the wrong time in the scheduler
+ 
+ - Modify "testseqnames" regression test to create a whole bunch of
+   sequences to validate that things don't break down with either lots of
+   them, or where IDs are large numbers

Index: config.h.in
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/config.h.in,v
retrieving revision 1.21.2.2
retrieving revision 1.21.2.3
diff -C2 -d -r1.21.2.2 -r1.21.2.3
*** config.h.in	1 Apr 2009 17:13:38 -0000	1.21.2.2
--- config.h.in	14 Jul 2009 19:09:00 -0000	1.21.2.3
***************
*** 13,18 ****
  #define SLONY_I_CONFIG_H
  
! #define SLONY_I_VERSION_STRING	"2.0.2"
! #define SLONY_I_VERSION_STRING_DEC 2,0,2
  
  #ifndef PG_VERSION_MAJOR
--- 13,18 ----
  #define SLONY_I_CONFIG_H
  
! #define SLONY_I_VERSION_STRING	"2.0.3"
! #define SLONY_I_VERSION_STRING_DEC 2,0,3
  
  #ifndef PG_VERSION_MAJOR

From cbbrowne at lists.slony.info  Tue Jul 14 12:09:02 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Jul 14 12:09:05 2009
Subject: [Slony1-commit] slony1-engine/src/backend slony1_funcs.sql
Message-ID: <20090714190902.A1E4429042C@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/backend
In directory main.slony.info:/tmp/cvs-serv2542/src/backend

Modified Files:
      Tag: REL_2_0_STABLE
	slony1_funcs.sql 
Log Message:
1.  Mark 2.0.3 version, preparatory to release

2.  Update release notes to include changes (to date) to 2.0.3

3.  slonik.c now recognizes PostgreSQL 8.4 properly


Index: slony1_funcs.sql
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/backend/slony1_funcs.sql,v
retrieving revision 1.145.2.11
retrieving revision 1.145.2.12
diff -C2 -d -r1.145.2.11 -r1.145.2.12
*** slony1_funcs.sql	17 Jun 2009 21:37:38 -0000	1.145.2.11
--- slony1_funcs.sql	14 Jul 2009 19:09:00 -0000	1.145.2.12
***************
*** 434,438 ****
  as $$
  begin
! 	return 2;
  end;
  $$ language plpgsql;
--- 434,438 ----
  as $$
  begin
! 	return 3;
  end;
  $$ language plpgsql;

From cbbrowne at lists.slony.info  Tue Jul 14 12:09:02 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Jul 14 12:09:05 2009
Subject: [Slony1-commit] slony1-engine/src/slonik slonik.c
Message-ID: <20090714190902.BB354290456@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slonik
In directory main.slony.info:/tmp/cvs-serv2542/src/slonik

Modified Files:
      Tag: REL_2_0_STABLE
	slonik.c 
Log Message:
1.  Mark 2.0.3 version, preparatory to release

2.  Update release notes to include changes (to date) to 2.0.3

3.  slonik.c now recognizes PostgreSQL 8.4 properly


Index: slonik.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slonik/slonik.c,v
retrieving revision 1.91.2.2
retrieving revision 1.91.2.3
diff -C2 -d -r1.91.2.2 -r1.91.2.3
*** slonik.c	17 Jun 2009 21:37:38 -0000	1.91.2.2
--- slonik.c	14 Jul 2009 19:09:00 -0000	1.91.2.3
***************
*** 1800,1804 ****
  		use_minor = 3;
  	}
! 	else	/* above 8.3 ??? */
  	{
  		use_major = 8;
--- 1800,1809 ----
  		use_minor = 3;
  	}
! 	else if ((adminfo->pg_version >= 80400) && (adminfo->pg_version < 80500)) /* 8.4 */
! 	{
! 		use_major = 8;
! 		use_minor = 3;   /* at this point, there's nothing specifically different in 8.4 from 8.3 */
! 	}
! 	else	/* above 8.4 ??? */
  	{
  		use_major = 8;

From cbbrowne at lists.slony.info  Tue Jul 14 12:13:35 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Jul 14 12:13:36 2009
Subject: [Slony1-commit] slony1-engine/doc/adminguide adminscripts.sgml
	dropthings.sgml
Message-ID: <20090714191335.3C463290C55@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/doc/adminguide
In directory main.slony.info:/tmp/cvs-serv3163/doc/adminguide

Modified Files:
      Tag: REL_2_0_STABLE
	adminscripts.sgml dropthings.sgml 
Log Message:
Per Mark Stosberg, need to have some docs for altperl script "slonik_drop_sequence"


Index: adminscripts.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/adminscripts.sgml,v
retrieving revision 1.52.2.5
retrieving revision 1.52.2.6
diff -C2 -d -r1.52.2.5 -r1.52.2.6
*** adminscripts.sgml	17 Jun 2009 21:37:38 -0000	1.52.2.5
--- adminscripts.sgml	14 Jul 2009 19:13:33 -0000	1.52.2.6
***************
*** 168,171 ****
--- 168,179 ----
  </sect3>
  
+ <sect3 id="slonik-drop-sequence"><title>slonik_drop_sequence</title>
+ 
+ <para>Generates Slonik script to drop a sequence from replication.
+ Requires, as input, the ID number of the table (available from table
+ <envar>sl_table</envar>) that is to be dropped, and the ID of the set
+ to which it is attached. </para>
+ </sect3>
+ 
  <sect3><title>slonik_execute_script</title>
  

Index: dropthings.sgml
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/doc/adminguide/dropthings.sgml,v
retrieving revision 1.18
retrieving revision 1.18.2.1
diff -C2 -d -r1.18 -r1.18.2.1
*** dropthings.sgml	24 Mar 2008 15:57:34 -0000	1.18
--- dropthings.sgml	14 Jul 2009 19:13:33 -0000	1.18.2.1
***************
*** 90,98 ****
  If the <link linkend="altperl"> altperl </link> utilities are
  installed, you can use the <link linkend="slonik-drop-table">
! slonik_drop_table </link> helper script to drop a table from
! replication. Simply run <command>slonik_drop_table</command> with no
! arguments to review the correct usage of the script. After dropping
! the table, you should also remove it from
! <filename>slon_tools.conf</filename>.
  </para>
  
--- 90,100 ----
  If the <link linkend="altperl"> altperl </link> utilities are
  installed, you can use the <link linkend="slonik-drop-table">
! slonik_drop_table </link> and <link linkend="slonik-drop-sequence">
! slonik_drop_sequence </link> helper scripts to drop a table or
! sequence from replication. Simply run
! <command>slonik_drop_table</command> (or
! <command>slonik_drop_sequence</command>) with no arguments to review
! the correct usage of the script. After dropping the table, you should
! also remove it from <filename>slon_tools.conf</filename>.
  </para>
  

From cbbrowne at lists.slony.info  Mon Jul 20 09:40:37 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Mon Jul 20 09:40:38 2009
Subject: [Slony1-commit] slony1-engine/src/slon confoptions.c
Message-ID: <20090720164037.3740F29042C@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slon
In directory main.slony.info:/tmp/cvs-serv20959

Modified Files:
      Tag: REL_2_0_STABLE
	confoptions.c 
Log Message:
Change minimum logging level to -1, as requested


Index: confoptions.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/confoptions.c,v
retrieving revision 1.29.2.2
retrieving revision 1.29.2.3
diff -C2 -d -r1.29.2.2 -r1.29.2.3
*** confoptions.c	1 Apr 2009 21:04:11 -0000	1.29.2.2
--- confoptions.c	20 Jul 2009 16:40:35 -0000	1.29.2.3
***************
*** 590,594 ****
  		&slon_log_level,
  		0,
! 		0,
  		4
  	},
--- 590,594 ----
  		&slon_log_level,
  		0,
! 		-1,
  		4
  	},

From cbbrowne at lists.slony.info  Mon Jul 20 09:40:59 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Mon Jul 20 09:41:00 2009
Subject: [Slony1-commit] slony1-engine/src/slon confoptions.c
Message-ID: <20090720164059.5D5DE290BDF@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slon
In directory main.slony.info:/tmp/cvs-serv20999

Modified Files:
	confoptions.c 
Log Message:
Change minimum logging level to -1 to allow suppressing all logging


Index: confoptions.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/confoptions.c,v
retrieving revision 1.31
retrieving revision 1.32
diff -C2 -d -r1.31 -r1.32
*** confoptions.c	11 Jun 2009 19:03:45 -0000	1.31
--- confoptions.c	20 Jul 2009 16:40:57 -0000	1.32
***************
*** 590,594 ****
  		&slon_log_level,
  		0,
! 		0,
  		4
  	},
--- 590,594 ----
  		&slon_log_level,
  		0,
! 		-1,
  		4
  	},

From cbbrowne at lists.slony.info  Mon Jul 20 09:41:57 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Mon Jul 20 09:41:59 2009
Subject: [Slony1-commit] slony1-engine/src/slon remote_worker.c
Message-ID: <20090720164157.C1E4E290C07@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slon
In directory main.slony.info:/tmp/cvs-serv21022

Modified Files:
	remote_worker.c 
Log Message:
Change actionseq values from "int" to "long long" to accomodate large
sequence values - per bug #92


Index: remote_worker.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/remote_worker.c,v
retrieving revision 1.176
retrieving revision 1.177
diff -C2 -d -r1.176 -r1.177
*** remote_worker.c	29 Aug 2008 21:06:45 -0000	1.176
--- remote_worker.c	20 Jul 2009 16:41:55 -0000	1.177
***************
*** 3783,3787 ****
  		monitor_subscriber_query(&pm);
  
! 		slon_log(SLON_INFO, "about to monitor_subscriber_query - pulling big actionid list %d\n", provider);
  
  		if (PQresultStatus(res1) != PGRES_TUPLES_OK)
--- 3783,3787 ----
  		monitor_subscriber_query(&pm);
  
! 		slon_log(SLON_INFO, "about to monitor_subscriber_query - pulling big actionid list for %d\n", provider->no_id);
  
  		if (PQresultStatus(res1) != PGRES_TUPLES_OK)
***************
*** 5514,5518 ****
  {
  	CompressState			state;
! 	int			curr_number,
  				curr_min,
  				curr_max;
--- 5514,5518 ----
  {
  	CompressState			state;
! 	long long			curr_number,
  				curr_min,
  				curr_max;
***************
*** 5662,5666 ****
  				{
  					/* Finished another number... Fold it into the ranges... */
! 					slon_log(SLON_DEBUG4, "Finished number: %d\n", curr_number);
  
  					/*
--- 5662,5666 ----
  				{
  					/* Finished another number... Fold it into the ranges... */
! 					slon_log(SLON_DEBUG4, "Finished number: %lld\n", curr_number);
  
  					/*
***************
*** 5713,5726 ****
  						if (curr_max == curr_min)
  						{
! 							slon_log(SLON_DEBUG4, "simple entry - %d\n", curr_max);
  							slon_appendquery(action_subquery,
! 										" log_actionseq <> '%d' ", curr_max);
  						}
  						else
  						{
! 							slon_log(SLON_DEBUG4, "between entry - %d %d\n",
  									 curr_min, curr_max);
  							slon_appendquery(action_subquery,
! 								 " log_actionseq not between '%d' and '%d' ",
  											 curr_min, curr_max);
  						}
--- 5713,5726 ----
  						if (curr_max == curr_min)
  						{
! 							slon_log(SLON_DEBUG4, "simple entry - %lld\n", curr_max);
  							slon_appendquery(action_subquery,
! 										" log_actionseq <> '%lld' ", curr_max);
  						}
  						else
  						{
! 							slon_log(SLON_DEBUG4, "between entry - %lld %lld\n",
  									 curr_min, curr_max);
  							slon_appendquery(action_subquery,
! 								 " log_actionseq not between '%lld' and '%lld' ",
  											 curr_min, curr_max);
  						}
***************
*** 5748,5761 ****
  		if (curr_max == curr_min)
  		{
! 			slon_log(SLON_DEBUG4, "simple entry - %d\n", curr_max);
  			slon_appendquery(action_subquery,
! 							 " log_actionseq <> '%d' ", curr_max);
  		}
  		else
  		{
! 			slon_log(SLON_DEBUG4, "between entry - %d %d\n",
  					 curr_min, curr_max);
  			slon_appendquery(action_subquery,
! 							 " log_actionseq not between '%d' and '%d' ",
  							 curr_min, curr_max);
  		}
--- 5748,5761 ----
  		if (curr_max == curr_min)
  		{
! 			slon_log(SLON_DEBUG4, "simple entry - %lld\n", curr_max);
  			slon_appendquery(action_subquery,
! 							 " log_actionseq <> '%lld' ", curr_max);
  		}
  		else
  		{
! 			slon_log(SLON_DEBUG4, "between entry - %lld %lld\n",
  					 curr_min, curr_max);
  			slon_appendquery(action_subquery,
! 							 " log_actionseq not between '%lld' and '%lld' ",
  							 curr_min, curr_max);
  		}

From cbbrowne at lists.slony.info  Mon Jul 20 09:42:40 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Mon Jul 20 09:42:41 2009
Subject: [Slony1-commit] slony1-engine/src/slon remote_worker.c
Message-ID: <20090720164240.8C5A1290BDF@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slon
In directory main.slony.info:/tmp/cvs-serv21093

Modified Files:
      Tag: REL_2_0_STABLE
	remote_worker.c 
Log Message:
Change actionseq values from "int" to "long long" to accomodate large
sequence values - per bug #92



Index: remote_worker.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/remote_worker.c,v
retrieving revision 1.176.2.1
retrieving revision 1.176.2.2
diff -C2 -d -r1.176.2.1 -r1.176.2.2
*** remote_worker.c	17 Jun 2009 21:37:38 -0000	1.176.2.1
--- remote_worker.c	20 Jul 2009 16:42:38 -0000	1.176.2.2
***************
*** 3807,3811 ****
  		monitor_subscriber_query(&pm);
  
! 		slon_log(SLON_INFO, "about to monitor_subscriber_query - pulling big actionid list %d\n", provider);
  
  		if (PQresultStatus(res1) != PGRES_TUPLES_OK)
--- 3807,3811 ----
  		monitor_subscriber_query(&pm);
  
! 		slon_log(SLON_INFO, "about to monitor_subscriber_query - pulling big actionid list for %d\n", provider->no_id);
  
  		if (PQresultStatus(res1) != PGRES_TUPLES_OK)
***************
*** 5538,5542 ****
  {
  	CompressState			state;
! 	int			curr_number,
  				curr_min,
  				curr_max;
--- 5538,5542 ----
  {
  	CompressState			state;
! 	long long			curr_number,
  				curr_min,
  				curr_max;
***************
*** 5686,5690 ****
  				{
  					/* Finished another number... Fold it into the ranges... */
! 					slon_log(SLON_DEBUG4, "Finished number: %d\n", curr_number);
  
  					/*
--- 5686,5690 ----
  				{
  					/* Finished another number... Fold it into the ranges... */
! 					slon_log(SLON_DEBUG4, "Finished number: %lld\n", curr_number);
  
  					/*
***************
*** 5737,5750 ****
  						if (curr_max == curr_min)
  						{
! 							slon_log(SLON_DEBUG4, "simple entry - %d\n", curr_max);
  							slon_appendquery(action_subquery,
! 										" log_actionseq <> '%d' ", curr_max);
  						}
  						else
  						{
! 							slon_log(SLON_DEBUG4, "between entry - %d %d\n",
  									 curr_min, curr_max);
  							slon_appendquery(action_subquery,
! 								 " log_actionseq not between '%d' and '%d' ",
  											 curr_min, curr_max);
  						}
--- 5737,5750 ----
  						if (curr_max == curr_min)
  						{
! 							slon_log(SLON_DEBUG4, "simple entry - %lld\n", curr_max);
  							slon_appendquery(action_subquery,
! 										" log_actionseq <> '%lld' ", curr_max);
  						}
  						else
  						{
! 							slon_log(SLON_DEBUG4, "between entry - %lld %lld\n",
  									 curr_min, curr_max);
  							slon_appendquery(action_subquery,
! 								 " log_actionseq not between '%lld' and '%lld' ",
  											 curr_min, curr_max);
  						}
***************
*** 5772,5785 ****
  		if (curr_max == curr_min)
  		{
! 			slon_log(SLON_DEBUG4, "simple entry - %d\n", curr_max);
  			slon_appendquery(action_subquery,
! 							 " log_actionseq <> '%d' ", curr_max);
  		}
  		else
  		{
! 			slon_log(SLON_DEBUG4, "between entry - %d %d\n",
  					 curr_min, curr_max);
  			slon_appendquery(action_subquery,
! 							 " log_actionseq not between '%d' and '%d' ",
  							 curr_min, curr_max);
  		}
--- 5772,5785 ----
  		if (curr_max == curr_min)
  		{
! 			slon_log(SLON_DEBUG4, "simple entry - %lld\n", curr_max);
  			slon_appendquery(action_subquery,
! 							 " log_actionseq <> '%lld' ", curr_max);
  		}
  		else
  		{
! 			slon_log(SLON_DEBUG4, "between entry - %lld %lld\n",
  					 curr_min, curr_max);
  			slon_appendquery(action_subquery,
! 							 " log_actionseq not between '%lld' and '%lld' ",
  							 curr_min, curr_max);
  		}

From cbbrowne at lists.slony.info  Mon Jul 20 09:43:15 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Mon Jul 20 09:43:16 2009
Subject: [Slony1-commit] slony1-engine/src/slon remote_worker.c
Message-ID: <20090720164315.8B9EA290C07@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slon
In directory main.slony.info:/tmp/cvs-serv21119

Modified Files:
      Tag: REL_1_2_STABLE
	remote_worker.c 
Log Message:
Change actionseq values from "int" to "long long" to accomodate large
sequence values - per bug #92


Index: remote_worker.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/remote_worker.c,v
retrieving revision 1.124.2.35
retrieving revision 1.124.2.36
diff -C2 -d -r1.124.2.35 -r1.124.2.36
*** remote_worker.c	9 Sep 2008 21:30:25 -0000	1.124.2.35
--- remote_worker.c	20 Jul 2009 16:43:13 -0000	1.124.2.36
***************
*** 5874,5878 ****
  {
  	int			state;
! 	int			curr_number,
  				curr_min,
  				curr_max;
--- 5874,5878 ----
  {
  	int			state;
! 	long long			curr_number,
  				curr_min,
  				curr_max;
***************
*** 6022,6026 ****
  				{
  					/* Finished another number... Fold it into the ranges... */
! 					slon_log(SLON_DEBUG4, "Finished number: %d\n", curr_number);
  
  					/*
--- 6022,6026 ----
  				{
  					/* Finished another number... Fold it into the ranges... */
! 					slon_log(SLON_DEBUG4, "Finished number: %lld\n", curr_number);
  
  					/*
***************
*** 6073,6086 ****
  						if (curr_max == curr_min)
  						{
! 							slon_log(SLON_DEBUG4, "simple entry - %d\n", curr_max);
  							slon_appendquery(action_subquery,
! 										" log_actionseq <> '%d' ", curr_max);
  						}
  						else
  						{
! 							slon_log(SLON_DEBUG4, "between entry - %d %d\n",
  									 curr_min, curr_max);
  							slon_appendquery(action_subquery,
! 								 " log_actionseq not between '%d' and '%d' ",
  											 curr_min, curr_max);
  						}
--- 6073,6086 ----
  						if (curr_max == curr_min)
  						{
! 							slon_log(SLON_DEBUG4, "simple entry - %lld\n", curr_max);
  							slon_appendquery(action_subquery,
! 										" log_actionseq <> '%lld' ", curr_max);
  						}
  						else
  						{
! 							slon_log(SLON_DEBUG4, "between entry - %lld %lld\n",
  									 curr_min, curr_max);
  							slon_appendquery(action_subquery,
! 								 " log_actionseq not between '%lld' and '%lld' ",
  											 curr_min, curr_max);
  						}
***************
*** 6108,6121 ****
  		if (curr_max == curr_min)
  		{
! 			slon_log(SLON_DEBUG4, "simple entry - %d\n", curr_max);
  			slon_appendquery(action_subquery,
! 							 " log_actionseq <> '%d' ", curr_max);
  		}
  		else
  		{
! 			slon_log(SLON_DEBUG4, "between entry - %d %d\n",
  					 curr_min, curr_max);
  			slon_appendquery(action_subquery,
! 							 " log_actionseq not between '%d' and '%d' ",
  							 curr_min, curr_max);
  		}
--- 6108,6121 ----
  		if (curr_max == curr_min)
  		{
! 			slon_log(SLON_DEBUG4, "simple entry - %lld\n", curr_max);
  			slon_appendquery(action_subquery,
! 							 " log_actionseq <> '%lld' ", curr_max);
  		}
  		else
  		{
! 			slon_log(SLON_DEBUG4, "between entry - %lld %lld\n",
  					 curr_min, curr_max);
  			slon_appendquery(action_subquery,
! 							 " log_actionseq not between '%lld' and '%lld' ",
  							 curr_min, curr_max);
  		}

From cbbrowne at lists.slony.info  Mon Jul 20 09:43:42 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Mon Jul 20 09:43:43 2009
Subject: [Slony1-commit] slony1-engine/src/slon confoptions.c
Message-ID: <20090720164342.16287290BDF@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slon
In directory main.slony.info:/tmp/cvs-serv21141

Modified Files:
      Tag: REL_1_2_STABLE
	confoptions.c 
Log Message:
Change minimum logging level to -1 to allow suppressing all logging


Index: confoptions.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/confoptions.c,v
retrieving revision 1.17.2.4
retrieving revision 1.17.2.5
diff -C2 -d -r1.17.2.4 -r1.17.2.5
*** confoptions.c	2 Feb 2007 20:23:46 -0000	1.17.2.4
--- confoptions.c	20 Jul 2009 16:43:40 -0000	1.17.2.5
***************
*** 561,565 ****
  		&slon_log_level,
  		4,
! 		0,
  		4
  	},
--- 561,565 ----
  		&slon_log_level,
  		4,
! 		-1,
  		4
  	},

From cbbrowne at lists.slony.info  Mon Jul 20 09:47:24 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Mon Jul 20 09:47:25 2009
Subject: [Slony1-commit] slony1-engine RELEASE config.h.in
Message-ID: <20090720164724.DC9BA290C07@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine
In directory main.slony.info:/tmp/cvs-serv21500

Modified Files:
      Tag: REL_1_2_STABLE
	RELEASE config.h.in 
Log Message:
Bump version numbers (prep for 1.2.17) and update release notes


Index: RELEASE
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/RELEASE,v
retrieving revision 1.1.2.35
retrieving revision 1.1.2.36
diff -C2 -d -r1.1.2.35 -r1.1.2.36
*** RELEASE	8 Jul 2009 20:46:02 -0000	1.1.2.35
--- RELEASE	20 Jul 2009 16:47:22 -0000	1.1.2.36
***************
*** 5,8 ****
--- 5,13 ----
    1.2
  
+ - Change minimum debugging level to -1 to allow suppressing logging
+ 
+ - Bug #92 - compression of event numbers had a bug where events >
+   2^31-1 would overflow the "int" value
+ 
  Release 1.2.16
  

Index: config.h.in
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/config.h.in,v
retrieving revision 1.17.2.16
retrieving revision 1.17.2.17
diff -C2 -d -r1.17.2.16 -r1.17.2.17
*** config.h.in	30 Apr 2009 16:20:52 -0000	1.17.2.16
--- config.h.in	20 Jul 2009 16:47:22 -0000	1.17.2.17
***************
*** 13,18 ****
  #define SLONY_I_CONFIG_H
  
! #define SLONY_I_VERSION_STRING	"1.2.16"
! #define SLONY_I_VERSION_STRING_DEC 1,2,16
  
  #ifndef PG_VERSION_MAJOR
--- 13,18 ----
  #define SLONY_I_CONFIG_H
  
! #define SLONY_I_VERSION_STRING	"1.2.17"
! #define SLONY_I_VERSION_STRING_DEC 1,2,17
  
  #ifndef PG_VERSION_MAJOR

From cbbrowne at lists.slony.info  Mon Jul 20 09:47:55 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Mon Jul 20 09:47:56 2009
Subject: [Slony1-commit] slony1-engine RELEASE
Message-ID: <20090720164755.59F2E290BDF@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine
In directory main.slony.info:/tmp/cvs-serv21550

Modified Files:
      Tag: REL_2_0_STABLE
	RELEASE 
Log Message:
Add release notes for recent changes


Index: RELEASE
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/RELEASE,v
retrieving revision 1.3.2.12
retrieving revision 1.3.2.13
diff -C2 -d -r1.3.2.12 -r1.3.2.13
*** RELEASE	14 Jul 2009 19:09:00 -0000	1.3.2.12
--- RELEASE	20 Jul 2009 16:47:53 -0000	1.3.2.13
***************
*** 111,112 ****
--- 111,117 ----
    sequences to validate that things don't break down with either lots of
    them, or where IDs are large numbers
+ 
+ - Change minimum debugging level to -1 to allow suppressing logging
+ 
+ - Bug #92 - compression of event numbers had a bug where events >
+   2^31-1 would overflow the "int" value

From cbbrowne at lists.slony.info  Mon Jul 20 15:30:13 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Mon Jul 20 15:30:15 2009
Subject: [Slony1-commit] slony1-engine/src/slon dbutils.c remote_worker.c
Message-ID: <20090720223013.25356290BDF@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slon
In directory main.slony.info:/tmp/cvs-serv17489

Modified Files:
      Tag: REL_2_0_STABLE
	dbutils.c remote_worker.c 
Log Message:
Introduce "%L" which is interpreted as "%lld" - bug #92


Index: remote_worker.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/remote_worker.c,v
retrieving revision 1.176.2.2
retrieving revision 1.176.2.3
diff -C2 -d -r1.176.2.2 -r1.176.2.3
*** remote_worker.c	20 Jul 2009 16:42:38 -0000	1.176.2.2
--- remote_worker.c	20 Jul 2009 22:30:10 -0000	1.176.2.3
***************
*** 5739,5743 ****
  							slon_log(SLON_DEBUG4, "simple entry - %lld\n", curr_max);
  							slon_appendquery(action_subquery,
! 										" log_actionseq <> '%lld' ", curr_max);
  						}
  						else
--- 5739,5743 ----
  							slon_log(SLON_DEBUG4, "simple entry - %lld\n", curr_max);
  							slon_appendquery(action_subquery,
! 										" log_actionseq <> '%L' ", curr_max);
  						}
  						else
***************
*** 5746,5750 ****
  									 curr_min, curr_max);
  							slon_appendquery(action_subquery,
! 								 " log_actionseq not between '%lld' and '%lld' ",
  											 curr_min, curr_max);
  						}
--- 5746,5750 ----
  									 curr_min, curr_max);
  							slon_appendquery(action_subquery,
! 								 " log_actionseq not between '%L' and '%L' ",
  											 curr_min, curr_max);
  						}
***************
*** 5774,5778 ****
  			slon_log(SLON_DEBUG4, "simple entry - %lld\n", curr_max);
  			slon_appendquery(action_subquery,
! 							 " log_actionseq <> '%lld' ", curr_max);
  		}
  		else
--- 5774,5778 ----
  			slon_log(SLON_DEBUG4, "simple entry - %lld\n", curr_max);
  			slon_appendquery(action_subquery,
! 							 " log_actionseq <> '%L' ", curr_max);
  		}
  		else
***************
*** 5781,5785 ****
  					 curr_min, curr_max);
  			slon_appendquery(action_subquery,
! 							 " log_actionseq not between '%lld' and '%lld' ",
  							 curr_min, curr_max);
  		}
--- 5781,5785 ----
  					 curr_min, curr_max);
  			slon_appendquery(action_subquery,
! 							 " log_actionseq not between '%L' and '%L' ",
  							 curr_min, curr_max);
  		}

Index: dbutils.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/dbutils.c,v
retrieving revision 1.30
retrieving revision 1.30.2.1
diff -C2 -d -r1.30 -r1.30.2.1
*** dbutils.c	28 May 2008 19:46:46 -0000	1.30
--- dbutils.c	20 Jul 2009 22:30:10 -0000	1.30.2.1
***************
*** 495,498 ****
--- 495,504 ----
  						break;
  
+ 					case 'L':
+ 						sprintf(buf, "%lld", va_arg(ap, int));
+ 						dstring_append(dsp, buf);
+ 						fmt++;
+ 						break;
+ 
  					default:
  						dstring_addchar(dsp, '%');

From cbbrowne at lists.slony.info  Mon Jul 20 15:30:33 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Mon Jul 20 15:30:34 2009
Subject: [Slony1-commit] slony1-engine/src/slon dbutils.c remote_worker.c
Message-ID: <20090720223033.AC26D290C07@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slon
In directory main.slony.info:/tmp/cvs-serv17839

Modified Files:
	dbutils.c remote_worker.c 
Log Message:
Introduce "%L" which is interpreted as "%lld" - bug #92


Index: remote_worker.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/remote_worker.c,v
retrieving revision 1.177
retrieving revision 1.178
diff -C2 -d -r1.177 -r1.178
*** remote_worker.c	20 Jul 2009 16:41:55 -0000	1.177
--- remote_worker.c	20 Jul 2009 22:30:31 -0000	1.178
***************
*** 5715,5719 ****
  							slon_log(SLON_DEBUG4, "simple entry - %lld\n", curr_max);
  							slon_appendquery(action_subquery,
! 										" log_actionseq <> '%lld' ", curr_max);
  						}
  						else
--- 5715,5719 ----
  							slon_log(SLON_DEBUG4, "simple entry - %lld\n", curr_max);
  							slon_appendquery(action_subquery,
! 										" log_actionseq <> '%L' ", curr_max);
  						}
  						else
***************
*** 5722,5726 ****
  									 curr_min, curr_max);
  							slon_appendquery(action_subquery,
! 								 " log_actionseq not between '%lld' and '%lld' ",
  											 curr_min, curr_max);
  						}
--- 5722,5726 ----
  									 curr_min, curr_max);
  							slon_appendquery(action_subquery,
! 								 " log_actionseq not between '%L' and '%L' ",
  											 curr_min, curr_max);
  						}
***************
*** 5750,5754 ****
  			slon_log(SLON_DEBUG4, "simple entry - %lld\n", curr_max);
  			slon_appendquery(action_subquery,
! 							 " log_actionseq <> '%lld' ", curr_max);
  		}
  		else
--- 5750,5754 ----
  			slon_log(SLON_DEBUG4, "simple entry - %lld\n", curr_max);
  			slon_appendquery(action_subquery,
! 							 " log_actionseq <> '%L' ", curr_max);
  		}
  		else
***************
*** 5757,5761 ****
  					 curr_min, curr_max);
  			slon_appendquery(action_subquery,
! 							 " log_actionseq not between '%lld' and '%lld' ",
  							 curr_min, curr_max);
  		}
--- 5757,5761 ----
  					 curr_min, curr_max);
  			slon_appendquery(action_subquery,
! 							 " log_actionseq not between '%L' and '%L' ",
  							 curr_min, curr_max);
  		}

Index: dbutils.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/dbutils.c,v
retrieving revision 1.30
retrieving revision 1.31
diff -C2 -d -r1.30 -r1.31
*** dbutils.c	28 May 2008 19:46:46 -0000	1.30
--- dbutils.c	20 Jul 2009 22:30:31 -0000	1.31
***************
*** 495,498 ****
--- 495,504 ----
  						break;
  
+ 					case 'L':
+ 						sprintf(buf, "%lld", va_arg(ap, int));
+ 						dstring_append(dsp, buf);
+ 						fmt++;
+ 						break;
+ 
  					default:
  						dstring_addchar(dsp, '%');

From cbbrowne at lists.slony.info  Mon Jul 20 15:30:49 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Mon Jul 20 15:30:51 2009
Subject: [Slony1-commit] slony1-engine/src/slon dbutils.c remote_worker.c
Message-ID: <20090720223050.07C9C290C07@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slon
In directory main.slony.info:/tmp/cvs-serv17862

Modified Files:
      Tag: REL_1_2_STABLE
	dbutils.c remote_worker.c 
Log Message:
Introduce "%L" which is interpreted as "%lld" - bug #92


Index: remote_worker.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/remote_worker.c,v
retrieving revision 1.124.2.36
retrieving revision 1.124.2.37
diff -C2 -d -r1.124.2.36 -r1.124.2.37
*** remote_worker.c	20 Jul 2009 16:43:13 -0000	1.124.2.36
--- remote_worker.c	20 Jul 2009 22:30:47 -0000	1.124.2.37
***************
*** 6075,6079 ****
  							slon_log(SLON_DEBUG4, "simple entry - %lld\n", curr_max);
  							slon_appendquery(action_subquery,
! 										" log_actionseq <> '%lld' ", curr_max);
  						}
  						else
--- 6075,6079 ----
  							slon_log(SLON_DEBUG4, "simple entry - %lld\n", curr_max);
  							slon_appendquery(action_subquery,
! 										" log_actionseq <> '%L' ", curr_max);
  						}
  						else
***************
*** 6082,6086 ****
  									 curr_min, curr_max);
  							slon_appendquery(action_subquery,
! 								 " log_actionseq not between '%lld' and '%lld' ",
  											 curr_min, curr_max);
  						}
--- 6082,6086 ----
  									 curr_min, curr_max);
  							slon_appendquery(action_subquery,
! 								 " log_actionseq not between '%L' and '%L' ",
  											 curr_min, curr_max);
  						}
***************
*** 6110,6114 ****
  			slon_log(SLON_DEBUG4, "simple entry - %lld\n", curr_max);
  			slon_appendquery(action_subquery,
! 							 " log_actionseq <> '%lld' ", curr_max);
  		}
  		else
--- 6110,6114 ----
  			slon_log(SLON_DEBUG4, "simple entry - %lld\n", curr_max);
  			slon_appendquery(action_subquery,
! 							 " log_actionseq <> '%L' ", curr_max);
  		}
  		else
***************
*** 6117,6121 ****
  					 curr_min, curr_max);
  			slon_appendquery(action_subquery,
! 							 " log_actionseq not between '%lld' and '%lld' ",
  							 curr_min, curr_max);
  		}
--- 6117,6121 ----
  					 curr_min, curr_max);
  			slon_appendquery(action_subquery,
! 							 " log_actionseq not between '%L' and '%L' ",
  							 curr_min, curr_max);
  		}

Index: dbutils.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/dbutils.c,v
retrieving revision 1.23.2.4
retrieving revision 1.23.2.5
diff -C2 -d -r1.23.2.4 -r1.23.2.5
*** dbutils.c	6 Dec 2006 09:46:09 -0000	1.23.2.4
--- dbutils.c	20 Jul 2009 22:30:47 -0000	1.23.2.5
***************
*** 480,483 ****
--- 480,489 ----
  						break;
  
+ 					case 'L':
+ 						sprintf(buf, "%lld", va_arg(ap, int));
+ 						dstring_append(dsp, buf);
+ 						fmt++;
+ 						break;
+ 
  					default:
  						dstring_addchar(dsp, '%');

From cbbrowne at lists.slony.info  Tue Jul 21 14:15:54 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Jul 21 14:15:55 2009
Subject: [Slony1-commit] slony1-engine/src/slonik slonik.c
Message-ID: <20090721211554.0A15A290C4E@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slonik
In directory main.slony.info:/tmp/cvs-serv8262/slonik

Modified Files:
      Tag: REL_2_0_STABLE
	slonik.c 
Log Message:
Addressing autovacuum change in PostgreSQL 8.4

1.  Need to have v84.sql files

2.  Need for slonik to install v84.sql files, when apropos

3.  v84.sql functions file implements alternative implementation
    which pulls the attribute from pg_class rather than the former
    pg_autovacuum table


Index: slonik.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slonik/slonik.c,v
retrieving revision 1.91.2.3
retrieving revision 1.91.2.4
diff -C2 -d -r1.91.2.3 -r1.91.2.4
*** slonik.c	14 Jul 2009 19:09:00 -0000	1.91.2.3
--- slonik.c	21 Jul 2009 21:15:51 -0000	1.91.2.4
***************
*** 1803,1814 ****
  	{
  		use_major = 8;
! 		use_minor = 3;   /* at this point, there's nothing specifically different in 8.4 from 8.3 */
  	}
  	else	/* above 8.4 ??? */
  	{
  		use_major = 8;
! 		use_minor = 3;
  		printf("%s:%d: Possible unsupported PostgreSQL "
! 			"version (%d) %d.%d, defaulting to 8.3 support\n",
                          stmt->stmt_filename, stmt->stmt_lno, adminfo->pg_version,
  			(adminfo->pg_version/10000), ((adminfo->pg_version%10000)/100));
--- 1803,1814 ----
  	{
  		use_major = 8;
! 		use_minor = 4;   /* at this point, there's nothing specifically different in 8.4 from 8.3 */
  	}
  	else	/* above 8.4 ??? */
  	{
  		use_major = 8;
! 		use_minor = 4;
  		printf("%s:%d: Possible unsupported PostgreSQL "
! 			"version (%d) %d.%d, defaulting to 8.4 support\n",
                          stmt->stmt_filename, stmt->stmt_lno, adminfo->pg_version,
  			(adminfo->pg_version/10000), ((adminfo->pg_version%10000)/100));

From cbbrowne at lists.slony.info  Tue Jul 21 14:15:53 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Jul 21 14:15:56 2009
Subject: [Slony1-commit] slony1-engine/src/slon dbutils.c
Message-ID: <20090721211553.ED6C629045B@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slon
In directory main.slony.info:/tmp/cvs-serv8262/slon

Modified Files:
      Tag: REL_2_0_STABLE
	dbutils.c 
Log Message:
Addressing autovacuum change in PostgreSQL 8.4

1.  Need to have v84.sql files

2.  Need for slonik to install v84.sql files, when apropos

3.  v84.sql functions file implements alternative implementation
    which pulls the attribute from pg_class rather than the former
    pg_autovacuum table


Index: dbutils.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/dbutils.c,v
retrieving revision 1.30.2.1
retrieving revision 1.30.2.2
diff -C2 -d -r1.30.2.1 -r1.30.2.2
*** dbutils.c	20 Jul 2009 22:30:10 -0000	1.30.2.1
--- dbutils.c	21 Jul 2009 21:15:51 -0000	1.30.2.2
***************
*** 127,131 ****
  			 "version for \"%s\" is %d\n", conninfo, conn->pg_version);
  
! 	if (conn->pg_version >= 80100)
  	{
  		slon_mkquery(&query, "set escape_string_warning to 'off'");
--- 127,131 ----
  			 "version for \"%s\" is %d\n", conninfo, conn->pg_version);
  
! 	if (conn->pg_version >= 80300)
  	{
  		slon_mkquery(&query, "set escape_string_warning to 'off'");
***************
*** 136,142 ****
  		}
  		PQclear(res);
! 	}
! 	if (conn->pg_version >= 80200)
! 	{
  		slon_mkquery(&query, "set standard_conforming_strings to 'off'");
  		res = PQexec(dbconn, dstring_data(&query));
--- 136,140 ----
  		}
  		PQclear(res);
! 
  		slon_mkquery(&query, "set standard_conforming_strings to 'off'");
  		res = PQexec(dbconn, dstring_data(&query));

From cbbrowne at lists.slony.info  Tue Jul 21 14:15:53 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Jul 21 14:15:56 2009
Subject: [Slony1-commit] slony1-engine/src/backend Makefile slony1_base.sql
	slony1_base.v83.sql slony1_base.v84.sql slony1_funcs.sql
	slony1_funcs.v84.sql
Message-ID: <20090721211554.4FAC8290C50@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/backend
In directory main.slony.info:/tmp/cvs-serv8262/backend

Modified Files:
      Tag: REL_2_0_STABLE
	Makefile slony1_base.sql slony1_base.v83.sql slony1_funcs.sql 
Added Files:
      Tag: REL_2_0_STABLE
	slony1_base.v84.sql slony1_funcs.v84.sql 
Log Message:
Addressing autovacuum change in PostgreSQL 8.4

1.  Need to have v84.sql files

2.  Need for slonik to install v84.sql files, when apropos

3.  v84.sql functions file implements alternative implementation
    which pulls the attribute from pg_class rather than the former
    pg_autovacuum table


Index: slony1_base.sql
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/backend/slony1_base.sql,v
retrieving revision 1.40.2.1
retrieving revision 1.40.2.2
diff -C2 -d -r1.40.2.1 -r1.40.2.2
*** slony1_base.sql	23 Feb 2009 17:23:55 -0000	1.40.2.1
--- slony1_base.sql	21 Jul 2009 21:15:51 -0000	1.40.2.2
***************
*** 470,473 ****
--- 470,474 ----
  create sequence @NAMESPACE@.sl_event_seq;
  comment on sequence @NAMESPACE@.sl_event_seq is 'The sequence for numbering events originating from this node.';
+ select setval('@NAMESPACE@.sl_event_seq', 5000000000);
  
  -- ----------------------------------------------------------------------
***************
*** 534,541 ****
  comment on column @NAMESPACE@.sl_config_lock.dummy is 'No data ever goes in this table so the contents never matter.  Indeed, this column does not really need to exist.';
  
- create type @NAMESPACE@.vactables as (nspname name, relname name);
- 
- comment on type @NAMESPACE@.vactables is 'used as return type for SRF function TablesToVacuum';
- 
  -- ----------------------------------------------------------------------
  -- TABLE sl_archive_counter
--- 535,538 ----

Index: slony1_funcs.sql
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/backend/slony1_funcs.sql,v
retrieving revision 1.145.2.12
retrieving revision 1.145.2.13
diff -C2 -d -r1.145.2.12 -r1.145.2.13
*** slony1_funcs.sql	14 Jul 2009 19:09:00 -0000	1.145.2.12
--- slony1_funcs.sql	21 Jul 2009 21:15:51 -0000	1.145.2.13
***************
*** 5620,5673 ****
  'Reenable index maintenance and reindex the table';
  
- 
- -- ----------------------------------------------------------------------
- -- FUNCTION ShouldSlonyVacuumTable (nspname, tabname)
- --
- --	Returns 't' if the table needs to be vacuumed by Slony-I
- --      Returns 'f' if autovac handles the table, so Slony-I should not
- --                  or if the table is not needful altogether
- -- ----------------------------------------------------------------------
- create or replace function @NAMESPACE@.ShouldSlonyVacuumTable (name, name) returns boolean as
- $$
- declare
- 	i_nspname alias for $1;
- 	i_tblname alias for $2;
- 	c_table oid;
- 	c_namespace oid;
- 	c_enabled boolean;
- 	v_dummy int4;
- begin
- 	select 1 into v_dummy from "pg_catalog".pg_settings where name = 'autovacuum' and setting = 'on';
- 	if not found then
- 		return 't'::boolean;       -- If autovac is turned off, then we gotta vacuum
- 	end if;
- 	
- 	select into c_namespace oid from "pg_catalog".pg_namespace where nspname = i_nspname;
- 	if not found then
- 		raise exception 'Slony-I: namespace % does not exist', i_nspname;
- 	end if;
- 	select into c_table oid from "pg_catalog".pg_class where relname = i_tblname and relnamespace = c_namespace;
- 	if not found then
- 		raise warning 'Slony-I: table % does not exist in namespace %/%', tblname, c_namespace, i_nspname;
- 		return 'f'::boolean;
- 	end if;
- 	
- 	-- So, the table is legit; try to look it up for autovacuum policy
- 	select enabled into c_enabled from "pg_catalog".pg_autovacuum where vacrelid = c_table;
- 
- 	if not found then
- 		return 'f'::boolean;   -- Autovac is turned on, and this table has no overriding handling
- 	end if;
- 
- 	if c_enabled then
- 		return 'f'::boolean;   -- Autovac is expressly turned on for this table
- 	end if;
- 
- 	return 't'::boolean;
- end;$$ language plpgsql;
- 
- comment on function @NAMESPACE@.ShouldSlonyVacuumTable (name, name) is 
- 'returns false if autovacuum handles vacuuming of the table, or if the table does not exist; returns true if Slony-I should manage it';
- 
  create or replace function @NAMESPACE@.setup_vactables_type () returns integer as $$
  begin
--- 5620,5623 ----

--- NEW FILE: slony1_base.v84.sql ---
-- ----------------------------------------------------------------------
-- slony1_base.v83.sql
--
--    Version 8.3 specific parts of the basic replication schema.
--
--	Copyright (c) 2007, PostgreSQL Global Development Group
--	Author: Jan Wieck, Afilias USA INC.
--
-- $Id: slony1_base.v84.sql,v 1.1.2.1 2009-07-21 21:15:51 cbbrowne Exp $
-- ----------------------------------------------------------------------

create type @NAMESPACE@.vactables as (nspname name, relname name);

comment on type @NAMESPACE@.vactables is 'used as return type for SRF function TablesToVacuum';



--- NEW FILE: slony1_funcs.v84.sql ---
-- ----------------------------------------------------------------------
-- slony1_funcs.v83.sql
--
--    Version 8.3 specific part of the replication support functions.
--
--	Copyright (c) 2007, PostgreSQL Global Development Group
--	Author: Jan Wieck, Afilias USA INC.
--
-- $Id: slony1_funcs.v84.sql,v 1.1.2.1 2009-07-21 21:15:51 cbbrowne Exp $
-- ----------------------------------------------------------------------

-- ----------------------------------------------------------------------
-- FUNCTION ShouldSlonyVacuumTable (nspname, tabname)
--
--	Returns 't' if the table needs to be vacuumed by Slony-I
--      Returns 'f' if autovac handles the table, so Slony-I should not
--                  or if the table is not needful altogether
-- ----------------------------------------------------------------------
create or replace function @NAMESPACE@.ShouldSlonyVacuumTable (name, name) returns boolean as
$$
declare
	i_nspname alias for $1;
	i_tblname alias for $2;
	c_table oid;
	c_namespace oid;
	c_enabled boolean;
	v_dummy int4;
begin
	select 1 into v_dummy from "pg_catalog".pg_settings where name = 'autovacuum' and setting = 'on';
	if not found then
		return 't'::boolean;       -- If autovac is turned off, then we gotta vacuum
	end if;
	
	select into c_namespace oid from "pg_catalog".pg_namespace where nspname = i_nspname;
	if not found then
		raise exception 'Slony-I: namespace % does not exist', i_nspname;
	end if;
	select into c_table oid from "pg_catalog".pg_class where relname = i_tblname and relnamespace = c_namespace;
	if not found then
		raise warning 'Slony-I: table % does not exist in namespace %/%', tblname, c_namespace, i_nspname;
		return 'f'::boolean;
	end if;
	
	-- So, the table is legit; try to look it up for autovacuum policy
	if exists (select 1 from pg_class where 'autovacuum_enabled=off' = any (reloptions) and oid = c_table) then
		return 't'::boolean;   -- Autovac is turned on, but this table is disabled
	end if;

	return 'f'::boolean;

end;$$ language plpgsql;

comment on function @NAMESPACE@.ShouldSlonyVacuumTable (name, name) is 
'returns false if autovacuum handles vacuuming of the table, or if the table does not exist; returns true if Slony-I should manage it';


Index: Makefile
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/backend/Makefile,v
retrieving revision 1.26
retrieving revision 1.26.2.1
diff -C2 -d -r1.26 -r1.26.2.1
*** Makefile	7 Jun 2007 13:01:10 -0000	1.26
--- Makefile	21 Jul 2009 21:15:51 -0000	1.26.2.1
***************
*** 25,28 ****
--- 25,30 ----
  BASE_83			= slony1_base.v83.sql
  FUNCS_83		= slony1_funcs.v83.sql
+ BASE_84			= slony1_base.v84.sql
+ FUNCS_84		= slony1_funcs.v84.sql
  
  SQL_NAMES =				\
***************
*** 30,34 ****
  	$(FUNCS_COMMON)		\
  	$(BASE_83)			\
! 	$(FUNCS_83)
  
  DISTFILES = Makefile README README.events $(wildcard *.sql) $(wildcard *.in) $(wildcard *.c)
--- 32,38 ----
  	$(FUNCS_COMMON)		\
  	$(BASE_83)			\
! 	$(BASE_84)			\
! 	$(FUNCS_83)			\
! 	$(FUNCS_84)
  
  DISTFILES = Makefile README README.events $(wildcard *.sql) $(wildcard *.in) $(wildcard *.c)

Index: slony1_base.v83.sql
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/backend/slony1_base.v83.sql,v
retrieving revision 1.1
retrieving revision 1.1.2.1
diff -C2 -d -r1.1 -r1.1.2.1
*** slony1_base.v83.sql	31 May 2007 18:55:28 -0000	1.1
--- slony1_base.v83.sql	21 Jul 2009 21:15:51 -0000	1.1.2.1
***************
*** 10,12 ****
--- 10,16 ----
  -- ----------------------------------------------------------------------
  
+ create type @NAMESPACE@.vactables as (nspname name, relname name);
+ 
+ comment on type @NAMESPACE@.vactables is 'used as return type for SRF function TablesToVacuum';
+ 
  

From cbbrowne at lists.slony.info  Tue Jul 21 14:17:46 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Jul 21 14:17:47 2009
Subject: [Slony1-commit] slony1-engine/tests run_test.sh
Message-ID: <20090721211746.C139029045B@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/tests
In directory main.slony.info:/tmp/cvs-serv8724

Modified Files:
      Tag: REL_2_0_STABLE
	run_test.sh 
Log Message:
Oops, a widespread typo in the testbed which was hidden because the
defaults "happened to work" (until I started 8.4-based testing!)


Index: run_test.sh
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tests/run_test.sh,v
retrieving revision 1.26.2.3
retrieving revision 1.26.2.4
diff -C2 -d -r1.26.2.3 -r1.26.2.4
*** run_test.sh	17 Jun 2009 21:37:38 -0000	1.26.2.3
--- run_test.sh	21 Jul 2009 21:17:44 -0000	1.26.2.4
***************
*** 113,117 ****
  	node=1
          while : ; do
! 	  SLON_BIN_PATH=$PGBINDIR1 SLON_CONF=${mktmp}/slon-conf.${node} $SLTOOLDIR/start_slon.sh stop
            if [ ${node} -ge ${NUMNODES} ]; then
              break;
--- 113,117 ----
  	node=1
          while : ; do
! 	  SLON_BUILD=$PGBINDIR SLON_CONF=${mktmp}/slon-conf.${node} $SLTOOLDIR/start_slon.sh stop
            if [ ${node} -ge ${NUMNODES} ]; then
              break;
***************
*** 250,256 ****
  	if [ -n "${db}" -a "${host}" -a "${user}" ]; then
  	  status "creating origin DB: $user -h $host -U $user -p $port $db"
!   	  $pgbindir/createdb -O $user -h $host -U $user -p $port --encoding $ENCODING $db 1> ${mktmp}/createdb.${originnode} 2> ${mktmp}/createdb.${originnode}
  	  if [ $? -ne 0 ]; then	   
! 	    err 3 "An error occurred trying to $pgbindir/createdb -O $user -h $host -U $user -p $port --encoding $ENCODING $db, ${mktmp}/createdb.${originnode} for details"
  	  fi
  	else
--- 250,256 ----
  	if [ -n "${db}" -a "${host}" -a "${user}" ]; then
  	  status "creating origin DB: $user -h $host -U $user -p $port $db"
!   	  $pgbindir/createdb -O $user -h $host -U $user -p $port --encoding $ENCODING -T template0 $db 1> ${mktmp}/createdb.${originnode} 2> ${mktmp}/createdb.${originnode}
  	  if [ $? -ne 0 ]; then	   
! 	    err 3 "An error occurred trying to $pgbindir/createdb -O $user -h $host -U $user -p $port --encoding $ENCODING -T template0 $db, ${mktmp}/createdb.${originnode} for details"
  	  fi
  	else
***************
*** 290,294 ****
                if [ ${node} -ne ${originnode} ]; then
  		status "creating subscriber ${node} DB: $user -h $host -U $user -p $port $db"
! 	        $pgbindir/createdb -O $user -h $host -U $user -p $port --encoding $ENCODING $db 1> ${mktmp}/createdb.${node} 2> ${mktmp}/createdb.${node}
  		status "add plpgsql to subscriber"
  		$pgbindir/createlang -h $host -U $user -p $port plpgsql $db
--- 290,294 ----
                if [ ${node} -ne ${originnode} ]; then
  		status "creating subscriber ${node} DB: $user -h $host -U $user -p $port $db"
! 	        $pgbindir/createdb -O $user -h $host -U $user -p $port --encoding $ENCODING -T template0 $db 1> ${mktmp}/createdb.${node} 2> ${mktmp}/createdb.${node}
  		status "add plpgsql to subscriber"
  		$pgbindir/createlang -h $host -U $user -p $port plpgsql $db
***************
*** 528,536 ****
    build_slonconf ${originnode} "${conninfo}"
    slonparms=" -f ${mktmp}/slon-conf.${originnode} "
!   status "launching originnode"
!   SLON_BIN_PATH=${opgbindir} SLON_CONF=${mktmp}/slon-conf.${originnode}  SLON_LOG=$mktmp/slon_log.${originnode} $SLTOOLDIR/start_slon.sh start
  
    sleep 1
!   SLPID=`SLON_BIN_PATH=${opgbindir} SLON_CONF=${mktmp}/slon-conf.${originnode} $SLTOOLDIR/start_slon.sh status | grep "Slon running as PID:"`
    if [ -z "${SLPID}" ]; then
        echo "SLPID: ${SLPID}"
--- 528,536 ----
    build_slonconf ${originnode} "${conninfo}"
    slonparms=" -f ${mktmp}/slon-conf.${originnode} "
!   status "launching originnode - PGBINDIR=${PGBINDIR}"
!   SLON_BUILD=${PGBINDIR} SLON_CONF=${mktmp}/slon-conf.${originnode} SLON_LOG=$mktmp/slon_log.${originnode} $SLTOOLDIR/start_slon.sh start
  
    sleep 1
!   SLPID=`SLON_BUILD=$PGBINDIR SLON_CONF=${mktmp}/slon-conf.${originnode} $SLTOOLDIR/start_slon.sh status | grep "Slon running as PID:"`
    if [ -z "${SLPID}" ]; then
        echo "SLPID: ${SLPID}"
***************
*** 584,591 ****
  	build_slonconf ${node} "${conninfo}"
  	status "launching slon"
! 	SLON_BIN_PATH=$pgbindir SLON_CONF=${CONFFILE} SLON_LOG=$mktmp/slon_log.${node} $SLTOOLDIR/start_slon.sh start
  	sleep 1
  	
! 	SLPID=`SLON_BIN_PATH=${pgbindir} SLON_CONF=${mktmp}/slon-conf.${node} $SLTOOLDIR/start_slon.sh status | grep "Slon running as PID:"`
  	if [ -z "${SLPID}" ]; then
  	    echo "SLPID: ${SLPID}"
--- 584,591 ----
  	build_slonconf ${node} "${conninfo}"
  	status "launching slon"
! 	SLON_BUILD=$PGBINDIR SLON_CONF=${CONFFILE} SLON_LOG=$mktmp/slon_log.${node} $SLTOOLDIR/start_slon.sh start
  	sleep 1
  	
! 	SLPID=`SLON_BUILD=${PGBINDIR} SLON_CONF=${mktmp}/slon-conf.${node} $SLTOOLDIR/start_slon.sh status | grep "Slon running as PID:"`
  	if [ -z "${SLPID}" ]; then
  	    echo "SLPID: ${SLPID}"

From cbbrowne at lists.slony.info  Tue Jul 21 14:18:45 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Jul 21 14:18:48 2009
Subject: [Slony1-commit] slony1-engine/src/slon cleanup_thread.c dbutils.c
	misc.c remote_worker.c scheduler.c
Message-ID: <20090721211845.A121F290C13@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slon
In directory main.slony.info:/tmp/cvs-serv8788/src/slon

Modified Files:
	cleanup_thread.c dbutils.c misc.c remote_worker.c scheduler.c 
Log Message:
Autovacuum changes recently made to 2.0 branch
test tool changes recently made to 2.0 branch


Index: dbutils.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/dbutils.c,v
retrieving revision 1.31
retrieving revision 1.32
diff -C2 -d -r1.31 -r1.32
*** dbutils.c	20 Jul 2009 22:30:31 -0000	1.31
--- dbutils.c	21 Jul 2009 21:18:43 -0000	1.32
***************
*** 127,131 ****
  			 "version for \"%s\" is %d\n", conninfo, conn->pg_version);
  
! 	if (conn->pg_version >= 80100)
  	{
  		slon_mkquery(&query, "set escape_string_warning to 'off'");
--- 127,131 ----
  			 "version for \"%s\" is %d\n", conninfo, conn->pg_version);
  
! 	if (conn->pg_version >= 80300)
  	{
  		slon_mkquery(&query, "set escape_string_warning to 'off'");
***************
*** 136,142 ****
  		}
  		PQclear(res);
! 	}
! 	if (conn->pg_version >= 80200)
! 	{
  		slon_mkquery(&query, "set standard_conforming_strings to 'off'");
  		res = PQexec(dbconn, dstring_data(&query));
--- 136,140 ----
  		}
  		PQclear(res);
! 
  		slon_mkquery(&query, "set standard_conforming_strings to 'off'");
  		res = PQexec(dbconn, dstring_data(&query));

Index: remote_worker.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/remote_worker.c,v
retrieving revision 1.178
retrieving revision 1.179
diff -C2 -d -r1.178 -r1.179
*** remote_worker.c	20 Jul 2009 22:30:31 -0000	1.178
--- remote_worker.c	21 Jul 2009 21:18:43 -0000	1.179
***************
*** 1181,1184 ****
--- 1181,1185 ----
  				int			sub_receiver = (int) strtol(event->ev_data3, NULL, 10);
  				char	   *sub_forward = event->ev_data4;
+ 				char	   *omit_copy = event->ev_data5;
  
  				if (sub_receiver == rtcfg_nodeid)
***************
*** 1186,1192 ****
  
  				slon_appendquery(&query1,
! 							"select %s.subscribeSet_int(%d, %d, %d, '%q'); ",
  								 rtcfg_namespace,
! 						   sub_set, sub_provider, sub_receiver, sub_forward);
  				need_reloadListen = true;
  			}
--- 1187,1193 ----
  
  				slon_appendquery(&query1,
! 								 "select %s.subscribeSet_int(%d, %d, %d, '%q', '%q'); ",
  								 rtcfg_namespace,
! 								 sub_set, sub_provider, sub_receiver, sub_forward, omit_copy);
  				need_reloadListen = true;
  			}
***************
*** 2430,2440 ****
  	char		seqbuf[64];
  	char	   *copydata = NULL;
  	struct timeval tv_start;
  	struct timeval tv_start2;
  	struct timeval tv_now;
  
- 	slon_log(SLON_INFO, "copy_set %d\n", set_id);
  	gettimeofday(&tv_start, NULL);
  
  	/*
  	 * Lookup the provider nodes conninfo
--- 2431,2459 ----
  	char		seqbuf[64];
  	char	   *copydata = NULL;
+ 	bool omit_copy = false;
+ 	char *v_omit_copy = event->ev_data5;
  	struct timeval tv_start;
  	struct timeval tv_start2;
  	struct timeval tv_now;
  
  	gettimeofday(&tv_start, NULL);
  
+ 	if (strcmp(v_omit_copy, "f") == 0) {
+ 		omit_copy = false;
+ 	} else {
+ 		if (strcmp(v_omit_copy, "t") == 0) {
+ 			omit_copy = true;
+ 		} else {
+ 			slon_log(SLON_ERROR, "copy_set %d - omit_copy not in (t,f)- [%s]\n", set_id, v_omit_copy);
+ 		}
+ 	}
+ 	slon_log(SLON_INFO, "copy_set %d - omit=%s - bool=%d\n", set_id, v_omit_copy, omit_copy);
+ 
+ 	if (omit_copy) {
+ 		slon_log(SLON_INFO, "omit is TRUE\n");
+ 	} else {
+ 		slon_log(SLON_INFO, "omit is FALSE\n");
+ 	}
+ 
  	/*
  	 * Lookup the provider nodes conninfo
***************
*** 2859,2862 ****
--- 2878,2886 ----
  		 * Begin a COPY from stdin for the table on the local DB
  		 */
+ 		if (omit_copy) {
+ 			slon_log(SLON_CONFIG, "remoteWorkerThread_%d: "
+ 					 "COPY of table %s suppressed due to OMIT COPY option\n",
+ 					 node->no_id, tab_fqname);
+ 		} else {
  		slon_log(SLON_CONFIG, "remoteWorkerThread_%d: "
  				 "Begin COPY of table %s\n",
***************
*** 3148,3152 ****
  			}
  		}
! 
  		gettimeofday(&tv_now, NULL);
  		slon_log(SLON_CONFIG, "remoteWorkerThread_%d: "
--- 3172,3176 ----
  			}
  		}
! 		}
  		gettimeofday(&tv_now, NULL);
  		slon_log(SLON_CONFIG, "remoteWorkerThread_%d: "




From cbbrowne at lists.slony.info  Tue Jul 21 14:18:45 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Jul 21 14:18:48 2009
Subject: [Slony1-commit] slony1-engine/src/slonik slonik.c slonik.h
Message-ID: <20090721211845.AD6FD290C50@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slonik
In directory main.slony.info:/tmp/cvs-serv8788/src/slonik

Modified Files:
	slonik.c slonik.h 
Log Message:
Autovacuum changes recently made to 2.0 branch
test tool changes recently made to 2.0 branch


Index: slonik.h
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slonik/slonik.h,v
retrieving revision 1.34
retrieving revision 1.35
diff -C2 -d -r1.34 -r1.35
*** slonik.h	14 Feb 2008 22:21:42 -0000	1.34
--- slonik.h	21 Jul 2009 21:18:43 -0000	1.35
***************
*** 352,355 ****
--- 352,356 ----
  	int			sub_receiver;
  	int			sub_forward;
+ 	int			omit_copy;
  };
  

Index: slonik.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slonik/slonik.c,v
retrieving revision 1.92
retrieving revision 1.93
diff -C2 -d -r1.92 -r1.93
*** slonik.c	11 Jun 2009 19:03:45 -0000	1.92
--- slonik.c	21 Jul 2009 21:18:43 -0000	1.93
***************
*** 1800,1809 ****
  		use_minor = 3;
  	}
! 	else	/* above 8.3 ??? */
  	{
  		use_major = 8;
! 		use_minor = 3;
  		printf("%s:%d: Possible unsupported PostgreSQL "
! 			"version (%d) %d.%d, defaulting to 8.3 support\n",
                          stmt->stmt_filename, stmt->stmt_lno, adminfo->pg_version,
  			(adminfo->pg_version/10000), ((adminfo->pg_version%10000)/100));
--- 1800,1814 ----
  		use_minor = 3;
  	}
! 	else if ((adminfo->pg_version >= 80400) && (adminfo->pg_version < 80500)) /* 8.4 */
  	{
  		use_major = 8;
! 		use_minor = 4;   /* at this point, there's nothing specifically different in 8.4 from 8.3 */
! 	}
! 	else	/* above 8.4 ??? */
! 	{
! 		use_major = 8;
! 		use_minor = 4;
  		printf("%s:%d: Possible unsupported PostgreSQL "
! 			"version (%d) %d.%d, defaulting to 8.4 support\n",
                          stmt->stmt_filename, stmt->stmt_lno, adminfo->pg_version,
  			(adminfo->pg_version/10000), ((adminfo->pg_version%10000)/100));
***************
*** 3426,3434 ****
  
  	slon_mkquery(&query,
! 				 "select \"_%s\".subscribeSet(%d, %d, %d, '%s'); ",
  				 stmt->hdr.script->clustername,
  				 stmt->sub_setid, stmt->sub_provider,
  				 stmt->sub_receiver,
! 				 (stmt->sub_forward) ? "t" : "f");
  	if (db_exec_evcommand((SlonikStmt *) stmt, adminfo1, &query) < 0)
  	{
--- 3431,3440 ----
  
  	slon_mkquery(&query,
! 				 "select \"_%s\".subscribeSet(%d, %d, %d, '%s', '%s'); ",
  				 stmt->hdr.script->clustername,
  				 stmt->sub_setid, stmt->sub_provider,
  				 stmt->sub_receiver,
! 				 (stmt->sub_forward) ? "t" : "f",
! 				 (stmt->omit_copy) ? "t" : "f");
  	if (db_exec_evcommand((SlonikStmt *) stmt, adminfo1, &query) < 0)
  	{

From cbbrowne at lists.slony.info  Tue Jul 21 14:18:45 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Jul 21 14:18:49 2009
Subject: [Slony1-commit] slony1-engine/tests run_test.sh
Message-ID: <20090721211845.B8DA4290C55@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/tests
In directory main.slony.info:/tmp/cvs-serv8788/tests

Modified Files:
	run_test.sh 
Log Message:
Autovacuum changes recently made to 2.0 branch
test tool changes recently made to 2.0 branch


Index: run_test.sh
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tests/run_test.sh,v
retrieving revision 1.28
retrieving revision 1.29
diff -C2 -d -r1.28 -r1.29
*** run_test.sh	11 Jun 2009 19:03:45 -0000	1.28
--- run_test.sh	21 Jul 2009 21:18:43 -0000	1.29
***************
*** 113,117 ****
  	node=1
          while : ; do
! 	  SLON_BIN_PATH=$PGBINDIR1 SLON_CONF=${mktmp}/slon-conf.${node} $SLTOOLDIR/start_slon.sh stop
            if [ ${node} -ge ${NUMNODES} ]; then
              break;
--- 113,117 ----
  	node=1
          while : ; do
! 	  SLON_BUILD=$PGBINDIR SLON_CONF=${mktmp}/slon-conf.${node} $SLTOOLDIR/start_slon.sh stop
            if [ ${node} -ge ${NUMNODES} ]; then
              break;
***************
*** 250,256 ****
  	if [ -n "${db}" -a "${host}" -a "${user}" ]; then
  	  status "creating origin DB: $user -h $host -U $user -p $port $db"
!   	  $pgbindir/createdb -O $user -h $host -U $user -p $port --encoding $ENCODING $db 1> ${mktmp}/createdb.${originnode} 2> ${mktmp}/createdb.${originnode}
  	  if [ $? -ne 0 ]; then	   
! 	    err 3 "An error occurred trying to $pgbindir/createdb -O $user -h $host -U $user -p $port --encoding $ENCODING $db, ${mktmp}/createdb.${originnode} for details"
  	  fi
  	else
--- 250,256 ----
  	if [ -n "${db}" -a "${host}" -a "${user}" ]; then
  	  status "creating origin DB: $user -h $host -U $user -p $port $db"
!   	  $pgbindir/createdb -O $user -h $host -U $user -p $port --encoding $ENCODING -T template0 $db 1> ${mktmp}/createdb.${originnode} 2> ${mktmp}/createdb.${originnode}
  	  if [ $? -ne 0 ]; then	   
! 	    err 3 "An error occurred trying to $pgbindir/createdb -O $user -h $host -U $user -p $port --encoding $ENCODING -T template0 $db, ${mktmp}/createdb.${originnode} for details"
  	  fi
  	else
***************
*** 290,298 ****
                if [ ${node} -ne ${originnode} ]; then
  		status "creating subscriber ${node} DB: $user -h $host -U $user -p $port $db"
! 	        $pgbindir/createdb -O $user -h $host -U $user -p $port --encoding $ENCODING $db 1> ${mktmp}/createdb.${node} 2> ${mktmp}/createdb.${node}
  		status "add plpgsql to subscriber"
  		$pgbindir/createlang -h $host -U $user -p $port plpgsql $db
  		status "loading subscriber ${node} DB from $odb"
! 	        $opgbindir/pg_dump -s  -h $ohost -U $ouser -p $oport $odb | $pgbindir/psql -h $host -p $port $db $user 1> ${mktmp}/init_schema.sql.${node} 2> ${mktmp}/init_schema.sql.${node}
  		status "done"
                fi
--- 290,298 ----
                if [ ${node} -ne ${originnode} ]; then
  		status "creating subscriber ${node} DB: $user -h $host -U $user -p $port $db"
! 	        $pgbindir/createdb -O $user -h $host -U $user -p $port --encoding $ENCODING -T template0 $db 1> ${mktmp}/createdb.${node} 2> ${mktmp}/createdb.${node}
  		status "add plpgsql to subscriber"
  		$pgbindir/createlang -h $host -U $user -p $port plpgsql $db
  		status "loading subscriber ${node} DB from $odb"
! 	        $opgbindir/pg_dump -h $ohost -U $ouser -p $oport $odb | $pgbindir/psql -h $host -p $port $db $user 1> ${mktmp}/init_schema.sql.${node} 2> ${mktmp}/init_schema.sql.${node}
  		status "done"
                fi
***************
*** 528,536 ****
    build_slonconf ${originnode} "${conninfo}"
    slonparms=" -f ${mktmp}/slon-conf.${originnode} "
!   status "launching originnode"
!   SLON_BIN_PATH=${opgbindir} SLON_CONF=${mktmp}/slon-conf.${originnode}  SLON_LOG=$mktmp/slon_log.${originnode} $SLTOOLDIR/start_slon.sh start
  
    sleep 1
!   SLPID=`SLON_BIN_PATH=${opgbindir} SLON_CONF=${mktmp}/slon-conf.${originnode} $SLTOOLDIR/start_slon.sh status | grep "Slon running as PID:"`
    if [ -z "${SLPID}" ]; then
        echo "SLPID: ${SLPID}"
--- 528,536 ----
    build_slonconf ${originnode} "${conninfo}"
    slonparms=" -f ${mktmp}/slon-conf.${originnode} "
!   status "launching originnode - PGBINDIR=${PGBINDIR}"
!   SLON_BUILD=${PGBINDIR} SLON_CONF=${mktmp}/slon-conf.${originnode} SLON_LOG=$mktmp/slon_log.${originnode} $SLTOOLDIR/start_slon.sh start
  
    sleep 1
!   SLPID=`SLON_BUILD=$PGBINDIR SLON_CONF=${mktmp}/slon-conf.${originnode} $SLTOOLDIR/start_slon.sh status | grep "Slon running as PID:"`
    if [ -z "${SLPID}" ]; then
        echo "SLPID: ${SLPID}"
***************
*** 584,591 ****
  	build_slonconf ${node} "${conninfo}"
  	status "launching slon"
! 	SLON_BIN_PATH=$pgbindir SLON_CONF=${CONFFILE} SLON_LOG=$mktmp/slon_log.${node} $SLTOOLDIR/start_slon.sh start
  	sleep 1
  	
! 	SLPID=`SLON_BIN_PATH=${pgbindir} SLON_CONF=${mktmp}/slon-conf.${node} $SLTOOLDIR/start_slon.sh status | grep "Slon running as PID:"`
  	if [ -z "${SLPID}" ]; then
  	    echo "SLPID: ${SLPID}"
--- 584,591 ----
  	build_slonconf ${node} "${conninfo}"
  	status "launching slon"
! 	SLON_BUILD=$PGBINDIR SLON_CONF=${CONFFILE} SLON_LOG=$mktmp/slon_log.${node} $SLTOOLDIR/start_slon.sh start
  	sleep 1
  	
! 	SLPID=`SLON_BUILD=${PGBINDIR} SLON_CONF=${mktmp}/slon-conf.${node} $SLTOOLDIR/start_slon.sh status | grep "Slon running as PID:"`
  	if [ -z "${SLPID}" ]; then
  	    echo "SLPID: ${SLPID}"

From cbbrowne at lists.slony.info  Tue Jul 21 14:18:45 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Jul 21 14:18:49 2009
Subject: [Slony1-commit] slony1-engine/src/backend Makefile slony1_base.sql
	slony1_base.v83.sql slony1_funcs.sql
Message-ID: <20090721211846.6BB84290C50@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/backend
In directory main.slony.info:/tmp/cvs-serv8788/src/backend

Modified Files:
	Makefile slony1_base.sql slony1_base.v83.sql slony1_funcs.sql 
Log Message:
Autovacuum changes recently made to 2.0 branch
test tool changes recently made to 2.0 branch


Index: slony1_base.sql
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/backend/slony1_base.sql,v
retrieving revision 1.41
retrieving revision 1.42
diff -C2 -d -r1.41 -r1.42
*** slony1_base.sql	11 Jun 2009 19:03:44 -0000	1.41
--- slony1_base.sql	21 Jul 2009 21:18:43 -0000	1.42
***************
*** 470,473 ****
--- 470,474 ----
  create sequence @NAMESPACE@.sl_event_seq;
  comment on sequence @NAMESPACE@.sl_event_seq is 'The sequence for numbering events originating from this node.';
+ select setval('@NAMESPACE@.sl_event_seq', 5000000000);
  
  -- ----------------------------------------------------------------------
***************
*** 534,541 ****
  comment on column @NAMESPACE@.sl_config_lock.dummy is 'No data ever goes in this table so the contents never matter.  Indeed, this column does not really need to exist.';
  
- create type @NAMESPACE@.vactables as (nspname name, relname name);
- 
- comment on type @NAMESPACE@.vactables is 'used as return type for SRF function TablesToVacuum';
- 
  -- ----------------------------------------------------------------------
  -- TABLE sl_archive_counter
--- 535,538 ----

Index: slony1_funcs.sql
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/backend/slony1_funcs.sql,v
retrieving revision 1.149
retrieving revision 1.150
diff -C2 -d -r1.149 -r1.150
*** slony1_funcs.sql	11 Jun 2009 19:03:44 -0000	1.149
--- slony1_funcs.sql	21 Jul 2009 21:18:43 -0000	1.150
***************
*** 434,438 ****
  as $$
  begin
! 	return 2;
  end;
  $$ language plpgsql;
--- 434,438 ----
  as $$
  begin
! 	return 3;
  end;
  $$ language plpgsql;
***************
*** 4100,4106 ****
  
  -- ----------------------------------------------------------------------
! -- FUNCTION subscribeSet (sub_set, sub_provider, sub_receiver, sub_forward)
  -- ----------------------------------------------------------------------
! create or replace function @NAMESPACE@.subscribeSet (int4, int4, int4, bool)
  returns bigint
  as $$
--- 4100,4106 ----
  
  -- ----------------------------------------------------------------------
! -- FUNCTION subscribeSet (sub_set, sub_provider, sub_receiver, sub_forward, omit_copy)
  -- ----------------------------------------------------------------------
! create or replace function @NAMESPACE@.subscribeSet (int4, int4, int4, bool, bool)
  returns bigint
  as $$
***************
*** 4110,4113 ****
--- 4110,4114 ----
  	p_sub_receiver		alias for $3;
  	p_sub_forward		alias for $4;
+ 	p_omit_copy		alias for $5;
  	v_set_origin		int4;
  	v_ev_seqno			int8;
***************
*** 4119,4122 ****
--- 4120,4125 ----
  	lock table @NAMESPACE@.sl_config_lock;
  
+ 	raise notice 'subscribe set: omit_copy=%', p_omit_copy;
+ 
  	-- ----
  	-- Check that this is called on the provider node
***************
*** 4162,4166 ****
  	v_ev_seqno :=  @NAMESPACE@.createEvent('_@CLUSTERNAME@', 'SUBSCRIBE_SET', 
  			p_sub_set::text, p_sub_provider::text, p_sub_receiver::text, 
! 			case p_sub_forward when true then 't' else 'f' end);
  
  	-- ----
--- 4165,4171 ----
  	v_ev_seqno :=  @NAMESPACE@.createEvent('_@CLUSTERNAME@', 'SUBSCRIBE_SET', 
  			p_sub_set::text, p_sub_provider::text, p_sub_receiver::text, 
! 			case p_sub_forward when true then 't' else 'f' end,
! 			case p_omit_copy when true then 't' else 'f' end
!                         );
  
  	-- ----
***************
*** 4168,4186 ****
  	-- ----
  	perform @NAMESPACE@.subscribeSet_int(p_sub_set, p_sub_provider,
! 			p_sub_receiver, p_sub_forward);
  
  	return v_ev_seqno;
  end;
  $$ language plpgsql;
! comment on function @NAMESPACE@.subscribeSet (int4, int4, int4, bool) is
! 'subscribeSet (sub_set, sub_provider, sub_receiver, sub_forward)
  
  Makes sure that the receiver is not the provider, then stores the
! subscription, and publishes the SUBSCRIBE_SET event to other nodes.';
  
! -- ----------------------------------------------------------------------
! -- FUNCTION subscribeSet_int (sub_set, sub_provider, sub_receiver, sub_forward)
! -- ----------------------------------------------------------------------
! create or replace function @NAMESPACE@.subscribeSet_int (int4, int4, int4, bool)
  returns int4
  as $$
--- 4173,4194 ----
  	-- ----
  	perform @NAMESPACE@.subscribeSet_int(p_sub_set, p_sub_provider,
! 			p_sub_receiver, p_sub_forward, p_omit_copy);
  
  	return v_ev_seqno;
  end;
  $$ language plpgsql;
! comment on function @NAMESPACE@.subscribeSet (int4, int4, int4, bool, bool) is
! 'subscribeSet (sub_set, sub_provider, sub_receiver, sub_forward, omit_copy)
  
  Makes sure that the receiver is not the provider, then stores the
! subscription, and publishes the SUBSCRIBE_SET event to other nodes.
  
! If omit_copy is true, then no data copy will be done.
! ';
! 
! -- -------------------------------------------------------------------------------------------
! -- FUNCTION subscribeSet_int (sub_set, sub_provider, sub_receiver, sub_forward, omit_copy)
! -- -------------------------------------------------------------------------------------------
! create or replace function @NAMESPACE@.subscribeSet_int (int4, int4, int4, bool, bool)
  returns int4
  as $$
***************
*** 4190,4193 ****
--- 4198,4202 ----
  	p_sub_receiver		alias for $3;
  	p_sub_forward		alias for $4;
+ 	p_omit_copy		alias for $5;
  	v_set_origin		int4;
  	v_sub_row			record;
***************
*** 4198,4201 ****
--- 4207,4212 ----
  	lock table @NAMESPACE@.sl_config_lock;
  
+ 	raise notice 'subscribe set: omit_copy=%', p_omit_copy;
+ 
  	-- ----
  	-- Provider change is only allowed for active sets
***************
*** 4261,4265 ****
  		perform @NAMESPACE@.createEvent('_@CLUSTERNAME@', 'ENABLE_SUBSCRIPTION', 
  				p_sub_set::text, p_sub_provider::text, p_sub_receiver::text, 
! 				case p_sub_forward when true then 't' else 'f' end);
  		perform @NAMESPACE@.enableSubscription(p_sub_set, 
  				p_sub_provider, p_sub_receiver);
--- 4272,4278 ----
  		perform @NAMESPACE@.createEvent('_@CLUSTERNAME@', 'ENABLE_SUBSCRIPTION', 
  				p_sub_set::text, p_sub_provider::text, p_sub_receiver::text, 
! 				case p_sub_forward when true then 't' else 'f' end,
! 				case p_omit_copy when true then 't' else 'f' end
! 				);
  		perform @NAMESPACE@.enableSubscription(p_sub_set, 
  				p_sub_provider, p_sub_receiver);
***************
*** 4275,4280 ****
  $$ language plpgsql;
  
! comment on function @NAMESPACE@.subscribeSet_int (int4, int4, int4, bool) is
! 'subscribeSet_int (sub_set, sub_provider, sub_receiver, sub_forward)
  
  Internal actions for subscribing receiver sub_receiver to subscription
--- 4288,4293 ----
  $$ language plpgsql;
  
! comment on function @NAMESPACE@.subscribeSet_int (int4, int4, int4, bool, bool) is
! 'subscribeSet_int (sub_set, sub_provider, sub_receiver, sub_forward, omit_copy)
  
  Internal actions for subscribing receiver sub_receiver to subscription
***************
*** 4405,4409 ****
  
  -- ----------------------------------------------------------------------
! -- FUNCTION enableSubscription (sub_set, sub_provider, sub_receiver)
  -- ----------------------------------------------------------------------
  create or replace function @NAMESPACE@.enableSubscription (int4, int4, int4)
--- 4418,4422 ----
  
  -- ----------------------------------------------------------------------
! -- FUNCTION enableSubscription (sub_set, sub_provider, sub_receiver, omit_copy)
  -- ----------------------------------------------------------------------
  create or replace function @NAMESPACE@.enableSubscription (int4, int4, int4)
***************
*** 4427,4433 ****
  enableSubscription_int (sub_set, sub_provider, sub_receiver).';
  
! -- ----------------------------------------------------------------------
  -- FUNCTION enableSubscription_int (sub_set, sub_provider, sub_receiver)
! -- ----------------------------------------------------------------------
  create or replace function @NAMESPACE@.enableSubscription_int (int4, int4, int4)
  returns int4
--- 4440,4446 ----
  enableSubscription_int (sub_set, sub_provider, sub_receiver).';
  
! -- -----------------------------------------------------------------------------------
  -- FUNCTION enableSubscription_int (sub_set, sub_provider, sub_receiver)
! -- -----------------------------------------------------------------------------------
  create or replace function @NAMESPACE@.enableSubscription_int (int4, int4, int4)
  returns int4
***************
*** 5607,5660 ****
  'Reenable index maintenance and reindex the table';
  
- 
- -- ----------------------------------------------------------------------
- -- FUNCTION ShouldSlonyVacuumTable (nspname, tabname)
- --
- --	Returns 't' if the table needs to be vacuumed by Slony-I
- --      Returns 'f' if autovac handles the table, so Slony-I should not
- --                  or if the table is not needful altogether
- -- ----------------------------------------------------------------------
- create or replace function @NAMESPACE@.ShouldSlonyVacuumTable (name, name) returns boolean as
- $$
- declare
- 	i_nspname alias for $1;
- 	i_tblname alias for $2;
- 	c_table oid;
- 	c_namespace oid;
- 	c_enabled boolean;
- 	v_dummy int4;
- begin
- 	select 1 into v_dummy from "pg_catalog".pg_settings where name = 'autovacuum' and setting = 'on';
- 	if not found then
- 		return 't'::boolean;       -- If autovac is turned off, then we gotta vacuum
- 	end if;
- 	
- 	select into c_namespace oid from "pg_catalog".pg_namespace where nspname = i_nspname;
- 	if not found then
- 		raise exception 'Slony-I: namespace % does not exist', i_nspname;
- 	end if;
- 	select into c_table oid from "pg_catalog".pg_class where relname = i_tblname and relnamespace = c_namespace;
- 	if not found then
- 		raise warning 'Slony-I: table % does not exist in namespace %/%', tblname, c_namespace, i_nspname;
- 		return 'f'::boolean;
- 	end if;
- 	
- 	-- So, the table is legit; try to look it up for autovacuum policy
- 	select enabled into c_enabled from "pg_catalog".pg_autovacuum where vacrelid = c_table;
- 
- 	if not found then
- 		return 'f'::boolean;   -- Autovac is turned on, and this table has no overriding handling
- 	end if;
- 
- 	if c_enabled then
- 		return 'f'::boolean;   -- Autovac is expressly turned on for this table
- 	end if;
- 
- 	return 't'::boolean;
- end;$$ language plpgsql;
- 
- comment on function @NAMESPACE@.ShouldSlonyVacuumTable (name, name) is 
- 'returns false if autovacuum handles vacuuming of the table, or if the table does not exist; returns true if Slony-I should manage it';
- 
  create or replace function @NAMESPACE@.setup_vactables_type () returns integer as $$
  begin
--- 5620,5623 ----

Index: Makefile
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/backend/Makefile,v
retrieving revision 1.26
retrieving revision 1.27
diff -C2 -d -r1.26 -r1.27
*** Makefile	7 Jun 2007 13:01:10 -0000	1.26
--- Makefile	21 Jul 2009 21:18:43 -0000	1.27
***************
*** 25,28 ****
--- 25,30 ----
  BASE_83			= slony1_base.v83.sql
  FUNCS_83		= slony1_funcs.v83.sql
+ BASE_84			= slony1_base.v84.sql
+ FUNCS_84		= slony1_funcs.v84.sql
  
  SQL_NAMES =				\
***************
*** 30,34 ****
  	$(FUNCS_COMMON)		\
  	$(BASE_83)			\
! 	$(FUNCS_83)
  
  DISTFILES = Makefile README README.events $(wildcard *.sql) $(wildcard *.in) $(wildcard *.c)
--- 32,38 ----
  	$(FUNCS_COMMON)		\
  	$(BASE_83)			\
! 	$(BASE_84)			\
! 	$(FUNCS_83)			\
! 	$(FUNCS_84)
  
  DISTFILES = Makefile README README.events $(wildcard *.sql) $(wildcard *.in) $(wildcard *.c)

Index: slony1_base.v83.sql
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/backend/slony1_base.v83.sql,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** slony1_base.v83.sql	31 May 2007 18:55:28 -0000	1.1
--- slony1_base.v83.sql	21 Jul 2009 21:18:43 -0000	1.2
***************
*** 10,12 ****
--- 10,16 ----
  -- ----------------------------------------------------------------------
  
+ create type @NAMESPACE@.vactables as (nspname name, relname name);
+ 
+ comment on type @NAMESPACE@.vactables is 'used as return type for SRF function TablesToVacuum';
+ 
  

From cbbrowne at lists.slony.info  Tue Jul 21 14:27:57 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Jul 21 14:27:58 2009
Subject: [Slony1-commit] slony1-engine RELEASE
Message-ID: <20090721212757.AFAE1290C20@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine
In directory main.slony.info:/tmp/cvs-serv9991

Modified Files:
      Tag: REL_2_0_STABLE
	RELEASE 
Log Message:
Revise release notes for autovac changes


Index: RELEASE
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/RELEASE,v
retrieving revision 1.3.2.13
retrieving revision 1.3.2.14
diff -C2 -d -r1.3.2.13 -r1.3.2.14
*** RELEASE	20 Jul 2009 16:47:53 -0000	1.3.2.13
--- RELEASE	21 Jul 2009 21:27:55 -0000	1.3.2.14
***************
*** 116,117 ****
--- 116,120 ----
  - Bug #92 - compression of event numbers had a bug where events >
    2^31-1 would overflow the "int" value
+ 
+ - Autovacuum handling changes in PostgreSQL 8.4 - we pull metadata
+   from pg_class.reloptions, instead of pg_autovacuum
\ No newline at end of file

From wieck at lists.slony.info  Thu Jul 23 11:30:06 2009
From: wieck at lists.slony.info (Jan Wieck)
Date: Thu Jul 23 11:30:08 2009
Subject: [Slony1-commit] slony1-engine/config acx_libpq.m4
Message-ID: <20090723183006.D74AE290446@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/config
In directory main.slony.info:/tmp/cvs-serv10904/config

Modified Files:
      Tag: REL_1_2_STABLE
	acx_libpq.m4 
Log Message:
Changes to make 1.2 compile (and work) with PostgreSQL 8.4.

8.4 also breaks the ducttape tests, which use pgbench as a test
application. 8.4's pgbench prefixes all tables with pgbench_.
For now we can use 8.3's pgbench.


Jan


Index: acx_libpq.m4
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/config/acx_libpq.m4,v
retrieving revision 1.24.2.4
retrieving revision 1.24.2.5
diff -C2 -d -r1.24.2.4 -r1.24.2.5
*** acx_libpq.m4	22 Nov 2007 22:51:04 -0000	1.24.2.4
--- acx_libpq.m4	23 Jul 2009 18:30:04 -0000	1.24.2.5
***************
*** 388,391 ****
--- 388,400 ----
  fi
  
+ AC_MSG_CHECKING(for GetActiveSnapshot)
+ AC_EGREP_HEADER(GetActiveSnapshot,
+ 	utils/snapmgr.h,
+ 	[AC_MSG_RESULT(yes)
+ 	AC_DEFINE(HAVE_GETACTIVESNAPSHOT)],
+ 	AC_MSG_RESULT(no)
+ )
+ 
+ 
  AC_MSG_CHECKING(for standard_conforming_strings)
  if test -z "$ac_cv_standard_conforming_strings"; then

From wieck at lists.slony.info  Thu Jul 23 11:30:06 2009
From: wieck at lists.slony.info (Jan Wieck)
Date: Thu Jul 23 11:30:09 2009
Subject: [Slony1-commit] slony1-engine/src/backend slony1_funcs.c
Message-ID: <20090723183006.D9DF829045B@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/backend
In directory main.slony.info:/tmp/cvs-serv10904/src/backend

Modified Files:
      Tag: REL_1_2_STABLE
	slony1_funcs.c 
Log Message:
Changes to make 1.2 compile (and work) with PostgreSQL 8.4.

8.4 also breaks the ducttape tests, which use pgbench as a test
application. 8.4's pgbench prefixes all tables with pgbench_.
For now we can use 8.3's pgbench.


Jan


Index: slony1_funcs.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/backend/slony1_funcs.c,v
retrieving revision 1.53.2.3
retrieving revision 1.53.2.4
diff -C2 -d -r1.53.2.3 -r1.53.2.4
*** slony1_funcs.c	22 Nov 2007 22:51:04 -0000	1.53.2.3
--- slony1_funcs.c	23 Jul 2009 18:30:04 -0000	1.53.2.4
***************
*** 22,25 ****
--- 22,26 ----
  #include "commands/async.h"
  #include "catalog/pg_operator.h"
+ #include "catalog/pg_type.h"
  #include "access/xact.h"
  #include "access/transam.h"
***************
*** 27,30 ****
--- 28,34 ----
  #include "utils/elog.h"
  #include "utils/guc.h"
+ #ifdef HAVE_GETACTIVESNAPSHOT
+ #include "utils/snapmgr.h"
+ #endif
  #ifdef HAVE_TYPCACHE
  #include "utils/typcache.h"
***************
*** 148,151 ****
--- 152,158 ----
  	int64		retval;
  	bool		isnull;
+ #ifdef HAVE_GETACTIVESNAPSHOT
+ 	Snapshot	SerializableSnapshot = GetActiveSnapshot();
+ #endif
  
  	if (SerializableSnapshot == NULL)

From wieck at lists.slony.info  Thu Jul 23 11:30:06 2009
From: wieck at lists.slony.info (Jan Wieck)
Date: Thu Jul 23 11:30:10 2009
Subject: [Slony1-commit] slony1-engine/src/xxid xxid.c
Message-ID: <20090723183006.E12FD290C2E@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/xxid
In directory main.slony.info:/tmp/cvs-serv10904/src/xxid

Modified Files:
      Tag: REL_1_2_STABLE
	xxid.c 
Log Message:
Changes to make 1.2 compile (and work) with PostgreSQL 8.4.

8.4 also breaks the ducttape tests, which use pgbench as a test
application. 8.4's pgbench prefixes all tables with pgbench_.
For now we can use 8.3's pgbench.


Jan


Index: xxid.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/xxid/Attic/xxid.c,v
retrieving revision 1.12.2.3
retrieving revision 1.12.2.4
diff -C2 -d -r1.12.2.3 -r1.12.2.4
*** xxid.c	14 May 2007 22:04:49 -0000	1.12.2.3
--- xxid.c	23 Jul 2009 18:30:04 -0000	1.12.2.4
***************
*** 19,22 ****
--- 19,25 ----
  #include "access/transam.h"
  #include "executor/spi.h"
+ #ifdef HAVE_GETACTIVESNAPSHOT
+ #include "utils/snapmgr.h"
+ #endif
  
  #ifdef PG_MODULE_MAGIC
***************
*** 234,237 ****
--- 237,244 ----
  _Slony_I_getMinXid(PG_FUNCTION_ARGS)
  {
+ #ifdef HAVE_GETACTIVESNAPSHOT
+ 	Snapshot	SerializableSnapshot = GetActiveSnapshot();
+ #endif
+ 
  	if (SerializableSnapshot == NULL)
  		elog(ERROR, "Slony-I: SerializableSnapshot is NULL in getMinXid()");
***************
*** 247,250 ****
--- 254,260 ----
  _Slony_I_getMaxXid(PG_FUNCTION_ARGS)
  {
+ #ifdef HAVE_GETACTIVESNAPSHOT
+ 	Snapshot	SerializableSnapshot = GetActiveSnapshot();
+ #endif
  	if (SerializableSnapshot == NULL)
  		elog(ERROR, "Slony-I: SerializableSnapshot is NULL in getMaxXid()");

From wieck at lists.slony.info  Thu Jul 23 11:30:06 2009
From: wieck at lists.slony.info (Jan Wieck)
Date: Thu Jul 23 11:30:10 2009
Subject: [Slony1-commit] slony1-engine config.h.in configure
Message-ID: <20090723183008.C8D17290C1C@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine
In directory main.slony.info:/tmp/cvs-serv10904

Modified Files:
      Tag: REL_1_2_STABLE
	config.h.in configure 
Log Message:
Changes to make 1.2 compile (and work) with PostgreSQL 8.4.

8.4 also breaks the ducttape tests, which use pgbench as a test
application. 8.4's pgbench prefixes all tables with pgbench_.
For now we can use 8.3's pgbench.


Jan


Index: config.h.in
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/config.h.in,v
retrieving revision 1.17.2.17
retrieving revision 1.17.2.18
diff -C2 -d -r1.17.2.17 -r1.17.2.18
*** config.h.in	20 Jul 2009 16:47:22 -0000	1.17.2.17
--- config.h.in	23 Jul 2009 18:30:04 -0000	1.17.2.18
***************
*** 100,103 ****
--- 100,105 ----
  #endif
  
+ /* For PostgreSQL 8.4 and up we need to use GetActiveSnapshot() */
+ #undef HAVE_GETACTIVESNAPSHOT
  
  /* Set to 1 if we have POSIX signals */

Index: configure
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/configure,v
retrieving revision 1.70.2.10
retrieving revision 1.70.2.11
diff -C2 -d -r1.70.2.10 -r1.70.2.11
*** configure	30 Apr 2009 16:19:31 -0000	1.70.2.10
--- configure	23 Jul 2009 18:30:04 -0000	1.70.2.11
***************
*** 1,5 ****
  #! /bin/sh
  # Guess values for system-dependent variables and create Makefiles.
! # Generated by GNU Autoconf 2.63 for postgresql-slony1 1.2.STABLE.
  #
  # Copyright (C) 1992, 1993, 1994, 1995, 1996, 1998, 1999, 2000, 2001,
--- 1,5 ----
  #! /bin/sh
  # Guess values for system-dependent variables and create Makefiles.
! # Generated by GNU Autoconf 2.62 for postgresql-slony1 1.2.STABLE.
  #
[...1352 lines suppressed...]
    :[FHL]*:*);;
!   :L* | :C*:*) { { $as_echo "$as_me:$LINENO: error: Invalid tag $ac_tag." >&5
! $as_echo "$as_me: error: Invalid tag $ac_tag." >&2;}
     { (exit 1); exit 1; }; };;
    :[FH]-) ac_tag=-:-;;
***************
*** 12402,12407 ****
  fi
  if test -n "$ac_unrecognized_opts" && test "$enable_option_checking" != no; then
!   { $as_echo "$as_me:$LINENO: WARNING: unrecognized options: $ac_unrecognized_opts" >&5
! $as_echo "$as_me: WARNING: unrecognized options: $ac_unrecognized_opts" >&2;}
  fi
  
--- 12378,12383 ----
  fi
  if test -n "$ac_unrecognized_opts" && test "$enable_option_checking" != no; then
!   { $as_echo "$as_me:$LINENO: WARNING: Unrecognized options: $ac_unrecognized_opts" >&5
! $as_echo "$as_me: WARNING: Unrecognized options: $ac_unrecognized_opts" >&2;}
  fi
  

From cbbrowne at lists.slony.info  Tue Jul 28 08:23:35 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Jul 28 08:23:36 2009
Subject: [Slony1-commit] slony1-engine/tools/altperl slon-tools.pm
	slon_tools.conf-sample
Message-ID: <20090728152335.546ED290257@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/tools/altperl
In directory main.slony.info:/tmp/cvs-serv28720

Modified Files:
      Tag: REL_2_0_STABLE
	slon-tools.pm slon_tools.conf-sample 
Log Message:
Per Devrim Gunduz...

Add a "LOG_NAME_SUFFIX" variable to slon-tools to allow centrally
configurating the filename for log files


Index: slon-tools.pm
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tools/altperl/slon-tools.pm,v
retrieving revision 1.32.2.3
retrieving revision 1.32.2.4
diff -C2 -d -r1.32.2.3 -r1.32.2.4
*** slon-tools.pm	22 Apr 2009 16:44:58 -0000	1.32.2.3
--- slon-tools.pm	28 Jul 2009 15:23:33 -0000	1.32.2.4
***************
*** 136,145 ****
    system("mkdir -p $LOGDIR/slony1/node$nodenum");
    my $cmd = "@@SLONBINDIR@@/slon -s $SYNC_CHECK_INTERVAL -d$DEBUGLEVEL $CLUSTER_NAME '$dsn' ";
    if ($APACHE_ROTATOR) {
!     $cmd .= "2>&1 | $APACHE_ROTATOR \"$LOGDIR/slony1/node$nodenum/" .  $dbname . "_%Y-%m-%d_%H:%M:%S.log\" 10M &";
    } else {
!     my $now=`date '+%Y-%m-%d_%H:%M:%S'`;
!     chomp $now;
!     $cmd .= "> $LOGDIR/slony1/node$nodenum/$dbname-$now.log 2>&1 &";
    }
    print "Invoke slon for node $nodenum - $cmd\n";
--- 136,146 ----
    system("mkdir -p $LOGDIR/slony1/node$nodenum");
    my $cmd = "@@SLONBINDIR@@/slon -s $SYNC_CHECK_INTERVAL -d$DEBUGLEVEL $CLUSTER_NAME '$dsn' ";
+   my $logfilesuffix=`date '$LOG_NAME_SUFFIX'`;
+   chomp $logfilesuffix;
+ 
    if ($APACHE_ROTATOR) {
!     $cmd .= "2>&1 | $APACHE_ROTATOR \"$LOGDIR/slony1/node$nodenum/" .  $dbname . "_$logfilesuffix.log\" 10M &";
    } else {
!     $cmd .= "> $LOGDIR/slony1/node$nodenum/$dbname-$logfilesuffix.log 2>&1 &";
    }
    print "Invoke slon for node $nodenum - $cmd\n";

Index: slon_tools.conf-sample
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tools/altperl/slon_tools.conf-sample,v
retrieving revision 1.8
retrieving revision 1.8.2.1
diff -C2 -d -r1.8 -r1.8.2.1
*** slon_tools.conf-sample	2 Jan 2007 20:16:58 -0000	1.8
--- slon_tools.conf-sample	28 Jul 2009 15:23:33 -0000	1.8.2.1
***************
*** 32,35 ****
--- 32,40 ----
      # $APACHE_ROTATOR = '/usr/local/apache/bin/rotatelogs';
  
+     # Log line suffix for Slony-I log. For options, look at date(1) 
+     # man page.
+     #
+     # LOG_NAME_SUFFIX = '%a'
+ 
      # SYNC check interval (slon -s option)
      # $SYNC_CHECK_INTERVAL = 1000;

From cbbrowne at lists.slony.info  Tue Jul 28 08:24:29 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Jul 28 08:24:30 2009
Subject: [Slony1-commit] slony1-engine/tools/altperl slon-tools.pm
	slon_tools.conf-sample
Message-ID: <20090728152429.5D31C29035D@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/tools/altperl
In directory main.slony.info:/tmp/cvs-serv28811

Modified Files:
	slon-tools.pm slon_tools.conf-sample 
Log Message:
Per Devrim Gunduz...

Add a "LOG_NAME_SUFFIX" variable to slon-tools to allow centrally
configurating the filename for log files


Index: slon-tools.pm
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tools/altperl/slon-tools.pm,v
retrieving revision 1.35
retrieving revision 1.36
diff -C2 -d -r1.35 -r1.36
*** slon-tools.pm	11 Jun 2009 19:03:45 -0000	1.35
--- slon-tools.pm	28 Jul 2009 15:24:27 -0000	1.36
***************
*** 136,145 ****
    system("mkdir -p $LOGDIR/slony1/node$nodenum");
    my $cmd = "@@SLONBINDIR@@/slon -s $SYNC_CHECK_INTERVAL -d$DEBUGLEVEL $CLUSTER_NAME '$dsn' ";
    if ($APACHE_ROTATOR) {
!     $cmd .= "2>&1 | $APACHE_ROTATOR \"$LOGDIR/slony1/node$nodenum/" .  $dbname . "_%Y-%m-%d_%H:%M:%S.log\" 10M &";
    } else {
!     my $now=`date '+%Y-%m-%d_%H:%M:%S'`;
!     chomp $now;
!     $cmd .= "> $LOGDIR/slony1/node$nodenum/$dbname-$now.log 2>&1 &";
    }
    print "Invoke slon for node $nodenum - $cmd\n";
--- 136,146 ----
    system("mkdir -p $LOGDIR/slony1/node$nodenum");
    my $cmd = "@@SLONBINDIR@@/slon -s $SYNC_CHECK_INTERVAL -d$DEBUGLEVEL $CLUSTER_NAME '$dsn' ";
+   my $logfilesuffix=`date '$LOG_NAME_SUFFIX'`;
+   chomp $logfilesuffix;
+ 
    if ($APACHE_ROTATOR) {
!     $cmd .= "2>&1 | $APACHE_ROTATOR \"$LOGDIR/slony1/node$nodenum/" .  $dbname . "_$logfilesuffix.log\" 10M &";
    } else {
!     $cmd .= "> $LOGDIR/slony1/node$nodenum/$dbname-$logfilesuffix.log 2>&1 &";
    }
    print "Invoke slon for node $nodenum - $cmd\n";

Index: slon_tools.conf-sample
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tools/altperl/slon_tools.conf-sample,v
retrieving revision 1.8
retrieving revision 1.9
diff -C2 -d -r1.8 -r1.9
*** slon_tools.conf-sample	2 Jan 2007 20:16:58 -0000	1.8
--- slon_tools.conf-sample	28 Jul 2009 15:24:27 -0000	1.9
***************
*** 32,35 ****
--- 32,40 ----
      # $APACHE_ROTATOR = '/usr/local/apache/bin/rotatelogs';
  
+     # Log line suffix for Slony-I log. For options, look at date(1) 
+     # man page.
+     #
+     # LOG_NAME_SUFFIX = '%a'
+ 
      # SYNC check interval (slon -s option)
      # $SYNC_CHECK_INTERVAL = 1000;

From cbbrowne at lists.slony.info  Tue Jul 28 09:03:51 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Jul 28 09:03:53 2009
Subject: [Slony1-commit] slony1-engine/src/backend slony1_funcs.sql
Message-ID: <20090728160352.3B5B32903F9@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/backend
In directory main.slony.info:/tmp/cvs-serv32546

Modified Files:
      Tag: REL_2_0_STABLE
	slony1_funcs.sql 
Log Message:
Aleksander Kmetec submitted this patch which addresses a race condition
potentially effecting long time locking or data loss on TRUNCATE.

Dataloss bug, described here:
http://lists.slony.info/pipermail/slony1-general/2009-July/009663.html

Statement blocking bug, described here:
http://lists.slony.info/pipermail/slony1-general/2009-July/009664.html

Patch is to preface TRUNCATE logic with an attempt (in an exception
block) to acquire an exclusive lock on the apropos sl_log_* table.
The NOWAIT option raises a (caught!) exception if there are any other
processes holding onto the table.


Index: slony1_funcs.sql
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/backend/slony1_funcs.sql,v
retrieving revision 1.145.2.13
retrieving revision 1.145.2.14
diff -C2 -d -r1.145.2.13 -r1.145.2.14
*** slony1_funcs.sql	21 Jul 2009 21:15:51 -0000	1.145.2.13
--- slony1_funcs.sql	28 Jul 2009 16:03:49 -0000	1.145.2.14
***************
*** 5236,5239 ****
--- 5236,5255 ----
  	if v_current_status = 2 then
  		v_purgeable := 'true';
+ 		
+ 		-- ----
+ 		-- Attempt to lock sl_log_2 in order to make sure there are no other transactions 
+ 		-- currently writing to it. Exit if it is still in use. This prevents TRUNCATE from 
+ 		-- blocking writers to sl_log_2 while it is waiting for a lock. It also prevents it 
+ 		-- immediately truncating log data generated inside the transaction which was active 
+ 		-- when logswitch_finish() was called (and was blocking TRUNCATE) as soon as that 
+ 		-- transaction is committed.
+ 		-- ----
+ 		begin
+ 			lock table @NAMESPACE@.sl_log_2 in exclusive mode nowait;
+ 		exception when lock_not_available then
+ 			raise notice 'Slony-I: could not lock sl_log_2 - sl_log_2 not truncated';
+ 			return -1;
+ 		end;
+ 
  		-- ----
  		-- The cleanup thread calls us after it did the delete and
***************
*** 5241,5245 ****
  		-- can truncate it and the log switch is done.
  		-- ----
- 		
  	        for v_origin, v_seqno, v_xmin in
  		  select ev_origin, ev_seqno, "pg_catalog".txid_snapshot_xmin(ev_snapshot) from @NAMESPACE@.sl_event
--- 5257,5260 ----
***************
*** 5275,5278 ****
--- 5290,5309 ----
  	if v_current_status = 3 then
  		v_purgeable := 'true';
+ 
+ 		-- ----
+ 		-- Attempt to lock sl_log_1 in order to make sure there are no other transactions 
+ 		-- currently writing to it. Exit if it is still in use. This prevents TRUNCATE from 
+ 		-- blocking writes to sl_log_1 while it is waiting for a lock. It also prevents it 
+ 		-- immediately truncating log data generated inside the transaction which was active 
+ 		-- when logswitch_finish() was called (and was blocking TRUNCATE) as soon as that 
+ 		-- transaction is committed.
+ 		-- ----
+ 		begin
+ 			lock table @NAMESPACE@.sl_log_1 in exclusive mode nowait;
+ 		exception when lock_not_available then
+ 			raise notice 'Slony-I: could not lock sl_log_1 - sl_log_1 not truncated';
+ 			return -1;
+ 		end;
+ 
  		-- ----
  		-- The cleanup thread calls us after it did the delete and

From cbbrowne at lists.slony.info  Tue Jul 28 09:05:50 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Jul 28 09:05:53 2009
Subject: [Slony1-commit] slony1-engine/src/backend slony1_funcs.sql
Message-ID: <20090728160550.B548E290400@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/backend
In directory main.slony.info:/tmp/cvs-serv569

Modified Files:
	slony1_funcs.sql 
Log Message:
Aleksander Kmetec submitted this patch which addresses a race condition
potentially effecting long time locking or data loss on TRUNCATE.

Dataloss bug, described here:
http://lists.slony.info/pipermail/slony1-general/2009-July/009663.html

Statement blocking bug, described here:
http://lists.slony.info/pipermail/slony1-general/2009-July/009664.html

Patch is to preface TRUNCATE logic with an attempt (in an exception
block) to acquire an exclusive lock on the apropos sl_log_* table.
The NOWAIT option raises a (caught!) exception if there are any other
processes holding onto the table.



Index: slony1_funcs.sql
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/backend/slony1_funcs.sql,v
retrieving revision 1.150
retrieving revision 1.151
diff -C2 -d -r1.150 -r1.151
*** slony1_funcs.sql	21 Jul 2009 21:18:43 -0000	1.150
--- slony1_funcs.sql	28 Jul 2009 16:05:48 -0000	1.151
***************
*** 5236,5239 ****
--- 5236,5255 ----
  	if v_current_status = 2 then
  		v_purgeable := 'true';
+ 		
+ 		-- ----
+ 		-- Attempt to lock sl_log_2 in order to make sure there are no other transactions 
+ 		-- currently writing to it. Exit if it is still in use. This prevents TRUNCATE from 
+ 		-- blocking writers to sl_log_2 while it is waiting for a lock. It also prevents it 
+ 		-- immediately truncating log data generated inside the transaction which was active 
+ 		-- when logswitch_finish() was called (and was blocking TRUNCATE) as soon as that 
+ 		-- transaction is committed.
+ 		-- ----
+ 		begin
+ 			lock table @NAMESPACE@.sl_log_2 in exclusive mode nowait;
+ 		exception when lock_not_available then
+ 			raise notice 'Slony-I: could not lock sl_log_2 - sl_log_2 not truncated';
+ 			return -1;
+ 		end;
+ 
  		-- ----
  		-- The cleanup thread calls us after it did the delete and
***************
*** 5241,5245 ****
  		-- can truncate it and the log switch is done.
  		-- ----
- 		
  	        for v_origin, v_seqno, v_xmin in
  		  select ev_origin, ev_seqno, "pg_catalog".txid_snapshot_xmin(ev_snapshot) from @NAMESPACE@.sl_event
--- 5257,5260 ----
***************
*** 5275,5278 ****
--- 5290,5309 ----
  	if v_current_status = 3 then
  		v_purgeable := 'true';
+ 
+ 		-- ----
+ 		-- Attempt to lock sl_log_1 in order to make sure there are no other transactions 
+ 		-- currently writing to it. Exit if it is still in use. This prevents TRUNCATE from 
+ 		-- blocking writes to sl_log_1 while it is waiting for a lock. It also prevents it 
+ 		-- immediately truncating log data generated inside the transaction which was active 
+ 		-- when logswitch_finish() was called (and was blocking TRUNCATE) as soon as that 
+ 		-- transaction is committed.
+ 		-- ----
+ 		begin
+ 			lock table @NAMESPACE@.sl_log_1 in exclusive mode nowait;
+ 		exception when lock_not_available then
+ 			raise notice 'Slony-I: could not lock sl_log_1 - sl_log_1 not truncated';
+ 			return -1;
+ 		end;
+ 
  		-- ----
  		-- The cleanup thread calls us after it did the delete and

From cbbrowne at lists.slony.info  Tue Jul 28 09:07:21 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Jul 28 09:07:22 2009
Subject: [Slony1-commit] slony1-engine/src/backend slony1_base.v84.sql
	slony1_funcs.v84.sql
Message-ID: <20090728160721.282732903F9@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/backend
In directory main.slony.info:/tmp/cvs-serv655

Added Files:
	slony1_base.v84.sql slony1_funcs.v84.sql 
Log Message:
Add 8.4-specific files


--- NEW FILE: slony1_funcs.v84.sql ---
-- ----------------------------------------------------------------------
-- slony1_funcs.v83.sql
--
--    Version 8.3 specific part of the replication support functions.
--
--	Copyright (c) 2007, PostgreSQL Global Development Group
--	Author: Jan Wieck, Afilias USA INC.
--
-- $Id: slony1_funcs.v84.sql,v 1.2 2009-07-28 16:07:19 cbbrowne Exp $
-- ----------------------------------------------------------------------

-- ----------------------------------------------------------------------
-- FUNCTION ShouldSlonyVacuumTable (nspname, tabname)
--
--	Returns 't' if the table needs to be vacuumed by Slony-I
--      Returns 'f' if autovac handles the table, so Slony-I should not
--                  or if the table is not needful altogether
-- ----------------------------------------------------------------------
create or replace function @NAMESPACE@.ShouldSlonyVacuumTable (name, name) returns boolean as
$$
declare
	i_nspname alias for $1;
	i_tblname alias for $2;
	c_table oid;
	c_namespace oid;
	c_enabled boolean;
	v_dummy int4;
begin
	select 1 into v_dummy from "pg_catalog".pg_settings where name = 'autovacuum' and setting = 'on';
	if not found then
		return 't'::boolean;       -- If autovac is turned off, then we gotta vacuum
	end if;
	
	select into c_namespace oid from "pg_catalog".pg_namespace where nspname = i_nspname;
	if not found then
		raise exception 'Slony-I: namespace % does not exist', i_nspname;
	end if;
	select into c_table oid from "pg_catalog".pg_class where relname = i_tblname and relnamespace = c_namespace;
	if not found then
		raise warning 'Slony-I: table % does not exist in namespace %/%', tblname, c_namespace, i_nspname;
		return 'f'::boolean;
	end if;
	
	-- So, the table is legit; try to look it up for autovacuum policy
	if exists (select 1 from pg_class where 'autovacuum_enabled=off' = any (reloptions) and oid = c_table) then
		return 't'::boolean;   -- Autovac is turned on, but this table is disabled
	end if;

	return 'f'::boolean;

end;$$ language plpgsql;

comment on function @NAMESPACE@.ShouldSlonyVacuumTable (name, name) is 
'returns false if autovacuum handles vacuuming of the table, or if the table does not exist; returns true if Slony-I should manage it';


--- NEW FILE: slony1_base.v84.sql ---
-- ----------------------------------------------------------------------
-- slony1_base.v83.sql
--
--    Version 8.3 specific parts of the basic replication schema.
--
--	Copyright (c) 2007, PostgreSQL Global Development Group
--	Author: Jan Wieck, Afilias USA INC.
--
-- $Id: slony1_base.v84.sql,v 1.2 2009-07-28 16:07:19 cbbrowne Exp $
-- ----------------------------------------------------------------------

create type @NAMESPACE@.vactables as (nspname name, relname name);

comment on type @NAMESPACE@.vactables is 'used as return type for SRF function TablesToVacuum';



From cbbrowne at lists.slony.info  Tue Jul 28 09:10:16 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Jul 28 09:10:17 2009
Subject: [Slony1-commit] slony1-engine RELEASE
Message-ID: <20090728161016.64C3A2903F9@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine
In directory main.slony.info:/tmp/cvs-serv1051

Modified Files:
      Tag: REL_2_0_STABLE
	RELEASE 
Log Message:
Update release notes for recent changes


Index: RELEASE
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/RELEASE,v
retrieving revision 1.3.2.14
retrieving revision 1.3.2.15
diff -C2 -d -r1.3.2.14 -r1.3.2.15
*** RELEASE	21 Jul 2009 21:27:55 -0000	1.3.2.14
--- RELEASE	28 Jul 2009 16:10:14 -0000	1.3.2.15
***************
*** 118,120 ****
  
  - Autovacuum handling changes in PostgreSQL 8.4 - we pull metadata
!   from pg_class.reloptions, instead of pg_autovacuum
\ No newline at end of file
--- 118,129 ----
  
  - Autovacuum handling changes in PostgreSQL 8.4 - we pull metadata
!   from pg_class.reloptions, instead of pg_autovacuum
! 
! - logswitch fix resolving a potential data loss + statement blocking
!   bug...
! 
!   Before attempting to TRUNCATE the sl_log_* tables, we need to
!   successfully request an exclusive lock.  By doing so in an
!   exception block with NOWAIT option, this can "lose" gracefully.
! 
! - Add LOG_NAME_SUFFIX to altperl tools
\ No newline at end of file

From cbbrowne at lists.slony.info  Tue Jul 28 15:19:40 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Jul 28 15:19:42 2009
Subject: [Slony1-commit] slony1-engine/src/slon cleanup_thread.c
Message-ID: <20090728221940.8C86D290C25@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slon
In directory main.slony.info:/tmp/cvs-serv1327/src/slon

Modified Files:
      Tag: REL_1_2_STABLE
	cleanup_thread.c 
Log Message:
Check for version 8.4, and if found, use an alternative query to determine
which tables are managed by autovacuum and hence do not need to be vacuumed
in the cleanup thread


Index: cleanup_thread.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/cleanup_thread.c,v
retrieving revision 1.33.2.4
retrieving revision 1.33.2.5
diff -C2 -d -r1.33.2.4 -r1.33.2.5
*** cleanup_thread.c	22 Aug 2007 21:20:23 -0000	1.33.2.4
--- cleanup_thread.c	28 Jul 2009 22:19:38 -0000	1.33.2.5
***************
*** 303,311 ****
  				if (a_vac==1)
  				{
! 					slon_mkquery(&query3,"select (case when pga.enabled ISNULL THEN true ELSE pga.enabled END) "
! 						"from \"pg_catalog\".pg_namespace PGN, \"pg_catalog\".pg_class PGC LEFT OUTER JOIN "
! 						"\"pg_catalog\".pg_autovacuum pga ON (PGC.oid = pga.vacrelid) where PGC.relnamespace = PGN.oid "
! 						"and %s.slon_quote_input('%s')=%s.slon_quote_brute(PGN.nspname) || '.' || %s.slon_quote_brute(PGC.relname);",
! 					 	rtcfg_namespace,tstring, rtcfg_namespace, rtcfg_namespace);
  
  					res = PQexec(dbconn, dstring_data(&query3));
--- 303,322 ----
  				if (a_vac==1)
  				{
! 					if (conn->pg_version < 80400) {
! 						slon_mkquery(&query3,"select (case when pga.enabled ISNULL THEN true ELSE pga.enabled END) "
! 									 "from \"pg_catalog\".pg_namespace PGN, \"pg_catalog\".pg_class PGC LEFT OUTER JOIN "
! 									 "\"pg_catalog\".pg_autovacuum pga ON (PGC.oid = pga.vacrelid) where PGC.relnamespace = PGN.oid "
! 									 "and %s.slon_quote_input('%s')=%s.slon_quote_brute(PGN.nspname) || '.' || %s.slon_quote_brute(PGC.relname);",
! 									 rtcfg_namespace,tstring, rtcfg_namespace, rtcfg_namespace);
! 
! 					} else {
! 						/* PostgreSQL 8.4 */
! 						slon_mkquery (&query3, 
! 									  "select coalesce ('autovacuum_enabled=on' = any(reloptions), 't'::boolean) "
! 									  "from \"pg_catalog\".pg_class pgc, \"pg_catalog\".pg_namespace pgn "
! 									  "where pgc.relnamespace = pgn.oid and %s.slon_quote_input('%s')= "
! 									  " %s.slon_quote_brute(PGN.nspname) || '.' || %s.slon_quote_brute(PGC.relname);",
! 									  rtcfg_namespace,tstring, rtcfg_namespace, rtcfg_namespace);
! 					}
  
  					res = PQexec(dbconn, dstring_data(&query3));

From cbbrowne at lists.slony.info  Tue Jul 28 15:20:50 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Jul 28 15:20:51 2009
Subject: [Slony1-commit] slony1-engine/tests run_test.sh
Message-ID: <20090728222050.7E46B290411@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/tests
In directory main.slony.info:/tmp/cvs-serv1404/tests

Modified Files:
      Tag: REL_1_2_STABLE
	run_test.sh 
Log Message:
Change createdb requests to draw from template0, so that the tests
work on PG 8.4, where this becomes needful in order to create databases
using UTF-8


Index: run_test.sh
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/tests/run_test.sh,v
retrieving revision 1.11.2.3
retrieving revision 1.11.2.4
diff -C2 -d -r1.11.2.3 -r1.11.2.4
*** run_test.sh	7 Mar 2008 19:00:14 -0000	1.11.2.3
--- run_test.sh	28 Jul 2009 22:20:48 -0000	1.11.2.4
***************
*** 258,264 ****
  	if [ -n "${db}" -a "${host}" -a "${user}" ]; then
  	  status "creating origin DB: $user -h $host -U $user -p $port $db"
!   	  $pgbindir/createdb -O $user -h $host -U $user -p $port --encoding $ENCODING $db 1> ${mktmp}/createdb.${originnode} 2> ${mktmp}/createdb.${originnode}
  	  if [ $? -ne 0 ]; then	   
! 	    err 3 "An error occured trying to $pgbindir/createdb -O $user -h $host -U $user -p $port --encoding $ENCODING $db, ${mktmp}/createdb.${originnode} for details"
  	  fi
  	else
--- 258,264 ----
  	if [ -n "${db}" -a "${host}" -a "${user}" ]; then
  	  status "creating origin DB: $user -h $host -U $user -p $port $db"
!   	  $pgbindir/createdb -O $user -h $host -U $user -p $port --encoding $ENCODING -T template0 $db 1> ${mktmp}/createdb.${originnode} 2> ${mktmp}/createdb.${originnode}
  	  if [ $? -ne 0 ]; then	   
! 	    err 3 "An error occured trying to $pgbindir/createdb -O $user -h $host -U $user -p $port --encoding $ENCODING -T template0 $db, ${mktmp}/createdb.${originnode} for details"
  	  fi
  	else
***************
*** 293,297 ****
                if [ ${alias} -ne ${originnode} ]; then
  		status "creating subscriber ${alias} DB: $user -h $host -U $user -p $port $db"
! 	        $pgbindir/createdb -O $user -h $host -U $user -p $port --encoding $ENCODING $db 1> ${mktmp}/createdb.${alias} 2> ${mktmp}/createdb.${alias}
  		status "add plpgsql to subscriber"
  		$pgbindir/createlang -h $host -U $user -p $port plpgsql $db
--- 293,297 ----
                if [ ${alias} -ne ${originnode} ]; then
  		status "creating subscriber ${alias} DB: $user -h $host -U $user -p $port $db"
! 	        $pgbindir/createdb -O $user -h $host -U $user -p $port --encoding $ENCODING -T template0 $db 1> ${mktmp}/createdb.${alias} 2> ${mktmp}/createdb.${alias}
  		status "add plpgsql to subscriber"
  		$pgbindir/createlang -h $host -U $user -p $port plpgsql $db

From cbbrowne at lists.slony.info  Tue Jul 28 15:21:02 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Jul 28 15:21:04 2009
Subject: [Slony1-commit] slony1-engine RELEASE
Message-ID: <20090728222102.4AFA9290411@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine
In directory main.slony.info:/tmp/cvs-serv1737

Modified Files:
      Tag: REL_1_2_STABLE
	RELEASE 
Log Message:
Update release notes for recent changes


Index: RELEASE
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/RELEASE,v
retrieving revision 1.1.2.36
retrieving revision 1.1.2.37
diff -C2 -d -r1.1.2.36 -r1.1.2.37
*** RELEASE	20 Jul 2009 16:47:22 -0000	1.1.2.36
--- RELEASE	28 Jul 2009 22:21:00 -0000	1.1.2.37
***************
*** 10,13 ****
--- 10,25 ----
    2^31-1 would overflow the "int" value
  
+ - Fix to race condition where file descriptor copies were being made at
+   the wrong time in the scheduler
+ 
+ - Establish compatibility with PostgreSQL 8.4:
+ 
+   - autovac data is on pg_class rather than pg_autovacuum
+ 
+   - Need to use GetActiveSnapshot() rather than expecting to have
+     SerializableSnapshot in the backend
+ 
+   - createdb needs to copy from template0 to ensure it can match locales
+ 
  Release 1.2.16
  

From cbbrowne at lists.slony.info  Tue Jul 28 15:42:04 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Jul 28 15:42:07 2009
Subject: [Slony1-commit] slony1-engine/src/slon remote_worker.c
Message-ID: <20090728224204.E30282903F9@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slon
In directory main.slony.info:/tmp/cvs-serv17404/src/slon

Modified Files:
      Tag: REL_2_0_STABLE
	remote_worker.c 
Log Message:
Diminish some logging from INFO to DEBUG1

Per suggestion from Jeff Frost


Index: remote_worker.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/remote_worker.c,v
retrieving revision 1.176.2.3
retrieving revision 1.176.2.4
diff -C2 -d -r1.176.2.3 -r1.176.2.4
*** remote_worker.c	20 Jul 2009 22:30:10 -0000	1.176.2.3
--- remote_worker.c	28 Jul 2009 22:42:02 -0000	1.176.2.4
***************
*** 3807,3811 ****
  		monitor_subscriber_query(&pm);
  
! 		slon_log(SLON_INFO, "about to monitor_subscriber_query - pulling big actionid list for %d\n", provider->no_id);
  
  		if (PQresultStatus(res1) != PGRES_TUPLES_OK)
--- 3807,3811 ----
  		monitor_subscriber_query(&pm);
  
! 		slon_log(SLON_DEBUG1, "about to monitor_subscriber_query - pulling big actionid list for %d\n", provider->no_id);
  
  		if (PQresultStatus(res1) != PGRES_TUPLES_OK)
***************
*** 4457,4461 ****
  			 TIMEVAL_DIFF(&tv_start, &tv_now));
  
!  	slon_log(SLON_INFO, 
  			 "remoteWorkerThread_%d: SYNC " INT64_FORMAT " sync_event timing: " 
  			 " pqexec (s/count)" 
--- 4457,4461 ----
  			 TIMEVAL_DIFF(&tv_start, &tv_now));
  
!  	slon_log(SLON_DEBUG1, 
  			 "remoteWorkerThread_%d: SYNC " INT64_FORMAT " sync_event timing: " 
  			 " pqexec (s/count)" 
***************
*** 5094,5101 ****
  				 TIMEVAL_DIFF(&tv_start, &tv_now));
  
! 		slon_log(SLON_INFO, "remoteHelperThread_%d_%d: inserts=%d updates=%d deletes=%d\n",
  				 node->no_id, provider->no_id, pm.num_inserts, pm.num_updates, pm.num_deletes);
  
! 		slon_log(SLON_INFO, 
  				 "remoteWorkerThread_%d: sync_helper timing: " 
  				 " pqexec (s/count)" 
--- 5094,5101 ----
  				 TIMEVAL_DIFF(&tv_start, &tv_now));
  
! 		slon_log(SLON_DEBUG1, "remoteHelperThread_%d_%d: inserts=%d updates=%d deletes=%d\n",
  				 node->no_id, provider->no_id, pm.num_inserts, pm.num_updates, pm.num_deletes);
  
! 		slon_log(SLON_DEBUG1, 
  				 "remoteWorkerThread_%d: sync_helper timing: " 
  				 " pqexec (s/count)" 
***************
*** 5106,5110 ****
  				 pm.subscr_query_t, pm.prov_query_c);
  
! 		slon_log(SLON_INFO, 
  				 "remoteWorkerThread_%d: sync_helper timing: " 
  				 " large tuples %.3f/%d\n", 
--- 5106,5110 ----
  				 pm.subscr_query_t, pm.prov_query_c);
  
! 		slon_log(SLON_DEBUG1, 
  				 "remoteWorkerThread_%d: sync_helper timing: " 
  				 " large tuples %.3f/%d\n", 

From cbbrowne at lists.slony.info  Tue Jul 28 15:43:00 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Tue Jul 28 15:43:01 2009
Subject: [Slony1-commit] slony1-engine/src/slon remote_worker.c
Message-ID: <20090728224300.12C28290453@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slon
In directory main.slony.info:/tmp/cvs-serv17478

Modified Files:
	remote_worker.c 
Log Message:
Reduce some logging from INFO level to DEBUG1 level, per email by Jeff
Frost


Index: remote_worker.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slon/remote_worker.c,v
retrieving revision 1.179
retrieving revision 1.180
diff -C2 -d -r1.179 -r1.180
*** remote_worker.c	21 Jul 2009 21:18:43 -0000	1.179
--- remote_worker.c	28 Jul 2009 22:42:57 -0000	1.180
***************
*** 3807,3811 ****
  		monitor_subscriber_query(&pm);
  
! 		slon_log(SLON_INFO, "about to monitor_subscriber_query - pulling big actionid list for %d\n", provider->no_id);
  
  		if (PQresultStatus(res1) != PGRES_TUPLES_OK)
--- 3807,3811 ----
  		monitor_subscriber_query(&pm);
  
! 		slon_log(SLON_DEBUG1, "about to monitor_subscriber_query - pulling big actionid list for %d\n", provider->no_id);
  
  		if (PQresultStatus(res1) != PGRES_TUPLES_OK)
***************
*** 4457,4461 ****
  			 TIMEVAL_DIFF(&tv_start, &tv_now));
  
!  	slon_log(SLON_INFO, 
  			 "remoteWorkerThread_%d: SYNC " INT64_FORMAT " sync_event timing: " 
  			 " pqexec (s/count)" 
--- 4457,4461 ----
  			 TIMEVAL_DIFF(&tv_start, &tv_now));
  
!  	slon_log(SLON_DEBUG1, 
  			 "remoteWorkerThread_%d: SYNC " INT64_FORMAT " sync_event timing: " 
  			 " pqexec (s/count)" 
***************
*** 5094,5101 ****
  				 TIMEVAL_DIFF(&tv_start, &tv_now));
  
! 		slon_log(SLON_INFO, "remoteHelperThread_%d_%d: inserts=%d updates=%d deletes=%d\n",
  				 node->no_id, provider->no_id, pm.num_inserts, pm.num_updates, pm.num_deletes);
  
! 		slon_log(SLON_INFO, 
  				 "remoteWorkerThread_%d: sync_helper timing: " 
  				 " pqexec (s/count)" 
--- 5094,5101 ----
  				 TIMEVAL_DIFF(&tv_start, &tv_now));
  
! 		slon_log(SLON_DEBUG1, "remoteHelperThread_%d_%d: inserts=%d updates=%d deletes=%d\n",
  				 node->no_id, provider->no_id, pm.num_inserts, pm.num_updates, pm.num_deletes);
  
! 		slon_log(SLON_DEBUG1, 
  				 "remoteWorkerThread_%d: sync_helper timing: " 
  				 " pqexec (s/count)" 
***************
*** 5106,5110 ****
  				 pm.subscr_query_t, pm.prov_query_c);
  
! 		slon_log(SLON_INFO, 
  				 "remoteWorkerThread_%d: sync_helper timing: " 
  				 " large tuples %.3f/%d\n", 
--- 5106,5110 ----
  				 pm.subscr_query_t, pm.prov_query_c);
  
! 		slon_log(SLON_DEBUG1, 
  				 "remoteWorkerThread_%d: sync_helper timing: " 
  				 " large tuples %.3f/%d\n", 

From cbbrowne at lists.slony.info  Wed Jul 29 13:51:57 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Wed Jul 29 13:51:58 2009
Subject: [Slony1-commit] slony1-www/content news.txt
Message-ID: <20090729205157.19070290BE1@main.slony.info>

Update of /home/cvsd/slony1/slony1-www/content
In directory main.slony.info:/tmp/cvs-serv22316/content

Modified Files:
	news.txt 
Log Message:
Add notes about 1.2.17 and 2.0.3 release candidates


Index: news.txt
===================================================================
RCS file: /home/cvsd/slony1/slony1-www/content/news.txt,v
retrieving revision 1.57
retrieving revision 1.58
diff -C2 -d -r1.57 -r1.58
*** news.txt	11 May 2009 19:57:24 -0000	1.57
--- news.txt	29 Jul 2009 20:51:54 -0000	1.58
***************
*** 15,18 ****
--- 15,110 ----
  
  ---
+ Slony-I 1.2.17RC release candidate available
+ http://main.slony.info/downloads/1.2/source/slony1-1.2.17-rc.tar.bz2
+ 2009-07-29
+ Chris Browne
+ 
+ Version <a href=
+ "http://main.slony.info/downloads/1.2/source/slony1-1.2.17-rc.tar.bz2">
+ slony1-1.2.17-rc.tar.bz2 </a> has been made available.
+ 
+ <P>Changes since 1.2.16 are as follows:
+ <ul>
+ 
+ <li> Apply changes to logshipper that went into the 2.0 branch but not
+   1.2
+ 
+ <li> Change minimum debugging level to -1 to allow suppressing logging
+ 
+ <li> Bug #92 - compression of event numbers had a bug where events >
+   2^31-1 would overflow the "int" value
+ 
+ <li> Fix to race condition where file descriptor copies were being made at
+   the wrong time in the scheduler
+ 
+ <li> Establish compatibility with PostgreSQL 8.4:
+ 
+ <ul>
+   <li> autovac data is on pg_class rather than pg_autovacuum
+ 
+   <li> Need to use GetActiveSnapshot() rather than expecting to have
+     SerializableSnapshot in the backend
+ 
+   <li> createdb needs to copy from template0 to ensure it can match locales
+ 
+ </ul>
+ </ul>
+ ---
+ Slony-I 2.0.3RC release candidate available
+ http://main.slony.info/downloads/2.0/source/slony1-2.0.3-rc.tar.bz2
+ 2009-07-29
+ Chris Browne
+ 
+ Version <a href=
+ "http://main.slony.info/downloads/2.0/source/slony1-2.0.3-rc.tar.bz2">
+ slony1-2.0.3-rc.tar.bz2 </a> has been made available.
+ 
+ <P>Changes since 2.0.2 are as follows:
+ 
+ <ul>
+ <li>PostgreSQL 8.4 has been released; slonik needs to explicitly recognize it
+ 
+ <li>Add in slonikconfdump.sh tool, which generates a slonik script to duplicate
+   the configuration of a Slony-I cluster
+ 
+ <li>Significant fixes to documentation to reflect 2.0 changes
+ 
+ <li>Add "OMIT COPY" option to the Slonik "SUBSCRIBE SET" command
+ 
+ <li>Document process for Slony-I 2.0 upgrade using OMIT COPY option
+ 
+ <li>Fix to race condition where file descriptor copies were being made at
+   the wrong time in the scheduler
+ 
+ <li>Modify "testseqnames" regression test to create a whole bunch of
+   sequences to validate that things don't break down with either lots of
+   them, or where IDs are large numbers
+ 
+ <li>Change minimum debugging level to -1 to allow suppressing logging
+ 
+ <li>Bug #92 - compression of event numbers had a bug where events >
+   2^31-1 would overflow the "int" value
+ 
+ <li>Autovacuum handling changes in PostgreSQL 8.4 - we pull metadata
+   from pg_class.reloptions, instead of pg_autovacuum
+ 
+ <li>logswitch fix resolving a potential data loss + statement blocking
+   bug...
+ 
+   Before attempting to TRUNCATE the sl_log_* tables, we need to
+   successfully request an exclusive lock.  By doing so in an
+   exception block with NOWAIT option, this can "lose" gracefully.
+ 
+ <li>Add LOG_NAME_SUFFIX to altperl tools
+ </ul>
+ ---
+ Updated Online Docs to 2.0.2
+ http://www.slony.info/documentation
+ 2009-07-14
+ Chris Browne
+ 
+ Updated the online documentation to reflect version 2.0.2; there have
+ been material changes to the docs since 2.0.1.
+ ---
  Slony-I 2.0.2 candidate released
  http://main.slony.info/downloads/2.0/source/slony1-2.0.2.tar.bz2

From cbbrowne at lists.slony.info  Fri Jul 31 12:16:30 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Fri Jul 31 12:16:32 2009
Subject: [Slony1-commit] slony1-engine/src/slonik slonik.c
Message-ID: <20090731191630.47BA329045B@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/slonik
In directory main.slony.info:/tmp/cvs-serv1155/slonik

Modified Files:
      Tag: REL_1_2_STABLE
	slonik.c 
Log Message:
Slonik should recognize PostgreSQL 8.4 as a legitimate supported version.

Fix problem where, with 8.4, a column on pg_class that no longer exists
gets updated by functions that alter/restore tables for/from replication.


Index: slonik.c
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/slonik/slonik.c,v
retrieving revision 1.67.2.19
retrieving revision 1.67.2.20
diff -C2 -d -r1.67.2.19 -r1.67.2.20
*** slonik.c	13 Apr 2009 17:41:33 -0000	1.67.2.19
--- slonik.c	31 Jul 2009 19:16:28 -0000	1.67.2.20
***************
*** 1906,1915 ****
  		use_minor = 0;
  	}
! 	else if ((adminfo->pg_version >= 80100) && adminfo->pg_version < 80400)	/* 8.1, 8.2 and 8.3 */
  	{
  		use_major = 8;
  		use_minor = 1;
  	}
! 	else	/* 8.3+ */
  	{
  		use_major = 8;
--- 1906,1915 ----
  		use_minor = 0;
  	}
! 	else if ((adminfo->pg_version >= 80100) && adminfo->pg_version < 80500)	/* 8.1, 8.2, 8.3, 8.4 */
  	{
  		use_major = 8;
  		use_minor = 1;
  	}
! 	else	/* 8.5+ */
  	{
  		use_major = 8;

From cbbrowne at lists.slony.info  Fri Jul 31 12:16:30 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Fri Jul 31 12:16:32 2009
Subject: [Slony1-commit] slony1-engine/src/backend slony1_funcs.sql
Message-ID: <20090731191630.497DB290C1C@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/backend
In directory main.slony.info:/tmp/cvs-serv1155/backend

Modified Files:
      Tag: REL_1_2_STABLE
	slony1_funcs.sql 
Log Message:
Slonik should recognize PostgreSQL 8.4 as a legitimate supported version.

Fix problem where, with 8.4, a column on pg_class that no longer exists
gets updated by functions that alter/restore tables for/from replication.


Index: slony1_funcs.sql
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/backend/slony1_funcs.sql,v
retrieving revision 1.98.2.35
retrieving revision 1.98.2.36
diff -C2 -d -r1.98.2.35 -r1.98.2.36
*** slony1_funcs.sql	8 Jul 2009 20:46:02 -0000	1.98.2.35
--- slony1_funcs.sql	31 Jul 2009 19:16:27 -0000	1.98.2.36
***************
*** 4010,4014 ****
  					);
  		get diagnostics v_n = row_count;
! 		if v_n > 0 then
  			update "pg_catalog".pg_class
  					set reltriggers = reltriggers - v_n
--- 4010,4014 ----
  					);
  		get diagnostics v_n = row_count;
! 		if (v_n > 0) and exists (select 1 from information_schema.columns where table_name = ''pg_class'' and table_schema = ''pg_catalog'' and column_name = ''reltriggers'') then
  			update "pg_catalog".pg_class
  					set reltriggers = reltriggers - v_n
***************
*** 4134,4138 ****
  				where tgrelid = v_tab_row.indexrelid;
  		get diagnostics v_n = row_count;
! 		if v_n > 0 then
  			update "pg_catalog".pg_class
  					set reltriggers = reltriggers + v_n
--- 4134,4138 ----
  				where tgrelid = v_tab_row.indexrelid;
  		get diagnostics v_n = row_count;
! 		if (v_n > 0) and exists (select 1 from information_schema.columns where table_name = ''pg_class'' and table_schema = ''pg_catalog'' and column_name = ''reltriggers'') then
  			update "pg_catalog".pg_class
  					set reltriggers = reltriggers + v_n

From cbbrowne at lists.slony.info  Fri Jul 31 12:20:28 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Fri Jul 31 12:20:29 2009
Subject: [Slony1-commit] slony1-engine/src/backend slony1_funcs.sql
Message-ID: <20090731192028.5FD0E290C0C@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine/src/backend
In directory main.slony.info:/tmp/cvs-serv1372/backend

Modified Files:
      Tag: REL_2_0_STABLE
	slony1_funcs.sql 
Log Message:
On 8.4, pg_class.reltriggers no longer exists, so query that updates this
should check for existence first


Index: slony1_funcs.sql
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/src/backend/slony1_funcs.sql,v
retrieving revision 1.145.2.14
retrieving revision 1.145.2.15
diff -C2 -d -r1.145.2.14 -r1.145.2.15
*** slony1_funcs.sql	28 Jul 2009 16:03:49 -0000	1.145.2.14
--- slony1_funcs.sql	31 Jul 2009 19:20:26 -0000	1.145.2.15
***************
*** 4052,4056 ****
  				where tgrelid = v_tab_row.indexrelid;
  		get diagnostics v_n = row_count;
! 		if v_n > 0 then
  			update "pg_catalog".pg_class
  					set reltriggers = reltriggers + v_n
--- 4052,4056 ----
  				where tgrelid = v_tab_row.indexrelid;
  		get diagnostics v_n = row_count;
! 		if (v_n > 0) and exists (select 1 from information_schema.columns where table_name = 'pg_class' and table_schema = 'pg_catalog' and column_name = 'reltriggers') then
  			update "pg_catalog".pg_class
  					set reltriggers = reltriggers + v_n

From cbbrowne at lists.slony.info  Fri Jul 31 12:23:07 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Fri Jul 31 12:23:08 2009
Subject: [Slony1-commit] slony1-www/content news.txt
Message-ID: <20090731192307.B152B290411@main.slony.info>

Update of /home/cvsd/slony1/slony1-www/content
In directory main.slony.info:/tmp/cvs-serv1808/content

Modified Files:
	news.txt 
Log Message:
Update to release notes for 1.2.17


Index: news.txt
===================================================================
RCS file: /home/cvsd/slony1/slony1-www/content/news.txt,v
retrieving revision 1.58
retrieving revision 1.59
diff -C2 -d -r1.58 -r1.59
*** news.txt	29 Jul 2009 20:51:54 -0000	1.58
--- news.txt	31 Jul 2009 19:23:05 -0000	1.59
***************
*** 48,51 ****
--- 48,54 ----
    <li> createdb needs to copy from template0 to ensure it can match locales
  
+   <li> pg_class.reltriggers no longer exists in 8.4 and thus shouldn't be
+     touched
+ 
  </ul>
  </ul>

From cbbrowne at lists.slony.info  Fri Jul 31 12:23:47 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Fri Jul 31 12:23:50 2009
Subject: [Slony1-commit] slony1-engine configure
Message-ID: <20090731192349.0B722290464@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine
In directory main.slony.info:/tmp/cvs-serv1869

Modified Files:
      Tag: REL_1_2_STABLE
	configure 
Log Message:
Ran autoconf


Index: configure
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/configure,v
retrieving revision 1.70.2.11
retrieving revision 1.70.2.12
diff -C2 -d -r1.70.2.11 -r1.70.2.12
*** configure	23 Jul 2009 18:30:04 -0000	1.70.2.11
--- configure	31 Jul 2009 19:23:44 -0000	1.70.2.12
***************
*** 1,5 ****
  #! /bin/sh
  # Guess values for system-dependent variables and create Makefiles.
! # Generated by GNU Autoconf 2.62 for postgresql-slony1 1.2.STABLE.
  #
  # Copyright (C) 1992, 1993, 1994, 1995, 1996, 1998, 1999, 2000, 2001,
--- 1,5 ----
  #! /bin/sh
  # Guess values for system-dependent variables and create Makefiles.
! # Generated by GNU Autoconf 2.63 for postgresql-slony1 HEAD_20090728.
  #
[...1366 lines suppressed...]
    :[FHL]*:*);;
!   :L* | :C*:*) { { $as_echo "$as_me:$LINENO: error: invalid tag $ac_tag" >&5
! $as_echo "$as_me: error: invalid tag $ac_tag" >&2;}
     { (exit 1); exit 1; }; };;
    :[FH]-) ac_tag=-:-;;
***************
*** 12378,12383 ****
  fi
  if test -n "$ac_unrecognized_opts" && test "$enable_option_checking" != no; then
!   { $as_echo "$as_me:$LINENO: WARNING: Unrecognized options: $ac_unrecognized_opts" >&5
! $as_echo "$as_me: WARNING: Unrecognized options: $ac_unrecognized_opts" >&2;}
  fi
  
--- 12430,12435 ----
  fi
  if test -n "$ac_unrecognized_opts" && test "$enable_option_checking" != no; then
!   { $as_echo "$as_me:$LINENO: WARNING: unrecognized options: $ac_unrecognized_opts" >&5
! $as_echo "$as_me: WARNING: unrecognized options: $ac_unrecognized_opts" >&2;}
  fi
  

From cbbrowne at lists.slony.info  Fri Jul 31 12:24:07 2009
From: cbbrowne at lists.slony.info (Chris Browne)
Date: Fri Jul 31 12:24:09 2009
Subject: [Slony1-commit] slony1-engine RELEASE
Message-ID: <20090731192407.79883290411@main.slony.info>

Update of /home/cvsd/slony1/slony1-engine
In directory main.slony.info:/tmp/cvs-serv1895

Modified Files:
      Tag: REL_1_2_STABLE
	RELEASE 
Log Message:
Release notes update


Index: RELEASE
===================================================================
RCS file: /home/cvsd/slony1/slony1-engine/RELEASE,v
retrieving revision 1.1.2.37
retrieving revision 1.1.2.38
diff -C2 -d -r1.1.2.37 -r1.1.2.38
*** RELEASE	28 Jul 2009 22:21:00 -0000	1.1.2.37
--- RELEASE	31 Jul 2009 19:24:05 -0000	1.1.2.38
***************
*** 22,25 ****
--- 22,28 ----
    - createdb needs to copy from template0 to ensure it can match locales
  
+   - pg_class.reltriggers no longer exists in 8.4 and thus shouldn't be
+     touched
+ 
  Release 1.2.16
  

