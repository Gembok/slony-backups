From ssinger at ca.afilias.info  Sat May  1 14:26:37 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Sat, 01 May 2010 17:26:37 -0400
Subject: [Slony1-general] [rangerrick@befunk.com: slony patch for osx]
In-Reply-To: <20100423160654.GA18954@fetter.org>
References: <20100423160654.GA18954@fetter.org>
Message-ID: <4BDC9C8D.104@ca.afilias.info>

David Fetter wrote:
> Folks,
> 
> Please find enclosed a patch to get Slony 2.0.3 to compile on OS/X :)

When I apply this patch I can no longer compile on linux.
I get the following

gcc -g -O2 -Wall -Wmissing-prototypes -Wmissing-declarations -I../.. 
-DPGSHARE="\"/usr/local/pgsql_cvs/share/\"" 
-I/usr/local/pgsql_cvs/include/ -I/usr/local/pgsql_cvs/include/server/ 
-c -o parser.o parser.c
parser.y:26: error: expected ?=?, ?,?, ?;?, ?asm? or ?__attribute__? 
before ?yyleng?
parser.y: In function ?yyparse?:
parser.y:374: error: ?yyleng? undeclared (first use in this function)
parser.y:374: error: (Each undeclared identifier is reported only once
parser.y:374: error: for each function it appears in.)
make[2]: *** [parser.o] Error 1


The SIZE_T_TYPE macro is not defined,  If your intention is to use 
size_t for yyleng, shouldn't you be using size_t directly?

Also scan.c in the same directory is still referencing yyleng as a int.



> 
> Cheers,
> David.
> 
> 
> ------------------------------------------------------------------------
> 
> Subject:
> slony patch for osx
> From:
> Benjamin Reed <rangerrick at befunk.com>
> Date:
> Fri, 23 Apr 2010 12:01:11 -0400
> To:
> david at fetter.org
> 
> To:
> david at fetter.org
> 
> 
> -----BEGIN PGP SIGNED MESSAGE-----
> Hash: SHA1
> 
> This is actually mixing 2 things, technically.
> 
> 1) autoconf 2.6 errored out on the AC_DEFINE(FOO) style define, they now
> require you to define a value and description.
> 2) Check for size_t, if it exists, define it to be used in .y files, if
> not, set it to "int" to work the old way.
> 
> The original compile error was:
> 
>> scan.c:161: error: conflicting types for ?yyleng?
>> parser.y:25: error: previous declaration of ?yyleng? was here
> 
> The bison-generated .c file uses yy_size_t which is typedef'd to size_t
> for yyleng.  (an unsigned long).  parser.y from slony uses an int, though.
> 
> Thanks!
> 
> - -- 
> Benjamin Reed a.k.a. Ranger Rick a.k.a. Raccoon Fink
> Fink, KDE, and Mac OS X development
> 
> Blog: http://www.raccoonfink.com/
> Music: http://music.raccoonfink.com/
> 
> -----BEGIN PGP SIGNATURE-----
> Version: GnuPG/MacGPG2 v2.0.12 (Darwin)
> Comment: Using GnuPG with Mozilla - http://enigmail.mozdev.org/
> 
> iD8DBQFL0cRHUu+jZtP2Zf4RAsnSAJ4maF/yIT91PJpthfhIu8vrCNReeACdFJ4m
> R3rBemZQat1rugKfwf+kMqM=
> =7d4U
> -----END PGP SIGNATURE-----
> 
> 
> ------------------------------------------------------------------------
> 
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


-- 
Steve Singer
Afilias Canada
Data Services Developer
416-673-1142

From JanWieck at Yahoo.com  Sat May  1 07:50:10 2010
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Sat, 01 May 2010 10:50:10 -0400
Subject: [Slony1-general] [rangerrick@befunk.com: slony patch for osx]
In-Reply-To: <4BDC9C8D.104@ca.afilias.info>
References: <20100423160654.GA18954@fetter.org> <4BDC9C8D.104@ca.afilias.info>
Message-ID: <4BDC3FA2.1070703@Yahoo.com>

On 5/1/2010 5:26 PM, Steve Singer wrote:
> David Fetter wrote:
>> Folks,
>> 
>> Please find enclosed a patch to get Slony 2.0.3 to compile on OS/X :)
> 
> When I apply this patch I can no longer compile on linux.
> I get the following
> 
> gcc -g -O2 -Wall -Wmissing-prototypes -Wmissing-declarations -I../.. 
> -DPGSHARE="\"/usr/local/pgsql_cvs/share/\"" 
> -I/usr/local/pgsql_cvs/include/ -I/usr/local/pgsql_cvs/include/server/ 
> -c -o parser.o parser.c
> parser.y:26: error: expected ?=?, ?,?, ?;?, ?asm? or ?__attribute__? 
> before ?yyleng?
> parser.y: In function ?yyparse?:
> parser.y:374: error: ?yyleng? undeclared (first use in this function)
> parser.y:374: error: (Each undeclared identifier is reported only once
> parser.y:374: error: for each function it appears in.)
> make[2]: *** [parser.o] Error 1
> 
> 
> The SIZE_T_TYPE macro is not defined,  If your intention is to use 
> size_t for yyleng, shouldn't you be using size_t directly?
> 
> Also scan.c in the same directory is still referencing yyleng as a int.

I think the intention of the patch is to look for a suitable size_t and 
fallback to int if none was found.

However, in my flex skeleton file (flex 2.5.35 FreeBSD) it is defined as 
extern int. That is why scan.c has it as int, because the extern 
declaration in there is coming from the skeleton, not the scan.l file.


Jan

-- 
Anyone who trades liberty for security deserves neither
liberty nor security. -- Benjamin Franklin

From sowjuec at gmail.com  Sun May  2 21:49:02 2010
From: sowjuec at gmail.com (sowjanya v)
Date: Mon, 3 May 2010 10:19:02 +0530
Subject: [Slony1-general] Need Help very urgent.ERROR: Slony-I: Node is
	uninitialized - cluster _sql_cluster2
Message-ID: <y2yae01d4351005022149h3db5c5a5y2de2551995ea4eba@mail.gmail.com>

Hi,

Iam getting an error as mentioned below. I have cluster6 which is valid at
this point of time and not  _sql_cluster2. so How do i delete all this
obsolete cluster. Please reply to this mail at  the earliest.

PGRES_FATAL_ERROR select "_sql_cluster2".unlockSet(1);  - ERROR:  Slony-I:
Node is uninitialized - cluster _sql_cluster2


-- 
Sowjanya
 Wipro Technologies
  Bangalore
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20100503/9c0649d7/attachment.htm 

From ssinger_pg at sympatico.ca  Mon May  3 04:11:05 2010
From: ssinger_pg at sympatico.ca (Steve Singer)
Date: Mon, 3 May 2010 07:11:05 -0400 (EDT)
Subject: [Slony1-general] Need Help very urgent.ERROR: Slony-I: Node is
 uninitialized - cluster _sql_cluster2
In-Reply-To: <y2yae01d4351005022149h3db5c5a5y2de2551995ea4eba@mail.gmail.com>
References: <y2yae01d4351005022149h3db5c5a5y2de2551995ea4eba@mail.gmail.com>
Message-ID: <BLU0-SMTP8811788950367F99AAAC92ACF20@phx.gbl>

On Mon, 3 May 2010, sowjanya v wrote:

> Hi,

How are you getting the error? Is it from the slon process or the slonik 
process?  If it is from slonik can you send the slonik script your 
executing, if it is from slon then can you send the slon command line + conf 
file.

Somewhere in one of them you are referencing cluster2.


>
> Iam getting an error as mentioned below. I have cluster6 which is valid at
> this point of time and not  _sql_cluster2. so How do i delete all this
> obsolete cluster. Please reply to this mail at  the earliest.
>
> PGRES_FATAL_ERROR select "_sql_cluster2".unlockSet(1);  - ERROR:  Slony-I:
> Node is uninitialized - cluster _sql_cluster2
>
>
> -- 
> Sowjanya
> Wipro Technologies
>  Bangalore
>


From JanWieck at Yahoo.com  Mon May  3 05:15:08 2010
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Mon, 03 May 2010 08:15:08 -0400
Subject: [Slony1-general] Need Help very urgent.ERROR: Slony-I: Node is
 uninitialized - cluster _sql_cluster2
In-Reply-To: <BLU0-SMTP8811788950367F99AAAC92ACF20@phx.gbl>
References: <y2yae01d4351005022149h3db5c5a5y2de2551995ea4eba@mail.gmail.com>
	<BLU0-SMTP8811788950367F99AAAC92ACF20@phx.gbl>
Message-ID: <4BDEBE4C.2030300@Yahoo.com>

On 5/3/2010 7:11 AM, Steve Singer wrote:
> On Mon, 3 May 2010, sowjanya v wrote:
> 
>> Hi,
> 
> How are you getting the error? Is it from the slon process or the slonik 
> process?  If it is from slonik can you send the slonik script your 
> executing, if it is from slon then can you send the slon command line + conf 
> file.
> 
> Somewhere in one of them you are referencing cluster2.

unlockSet() is executed on the origin and does not actually generate an 
event, so this must be in response to a slonik script.

However, that error message is coming from inside of getClusterStatus(), 
which is called by getLocalNodeId() in turn called by unlockSet(). Which 
means that the slony schema exists in that database, but the sequence 
sl_local_node_id has a negative value. That value is normally the 
node_id, and set during INIT CLUSTER or STORE NODE.

I think we need to know a little more about that nodes history. Like how 
was it created? How did the lockSet() work in the first place and what 
happened in the meantime?


Jan


> 
> 
>>
>> Iam getting an error as mentioned below. I have cluster6 which is valid at
>> this point of time and not  _sql_cluster2. so How do i delete all this
>> obsolete cluster. Please reply to this mail at  the earliest.
>>
>> PGRES_FATAL_ERROR select "_sql_cluster2".unlockSet(1);  - ERROR:  Slony-I:
>> Node is uninitialized - cluster _sql_cluster2
>>
>>
>> -- 
>> Sowjanya
>> Wipro Technologies
>>  Bangalore
>>
> 
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


-- 
Anyone who trades liberty for security deserves neither
liberty nor security. -- Benjamin Franklin

From JanWieck at Yahoo.com  Mon May  3 19:10:25 2010
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Mon, 03 May 2010 22:10:25 -0400
Subject: [Slony1-general] encoding problems
In-Reply-To: <alpine.LRH.1.10.1004271915240.24242@corp1.xtenit.com>
References: <alpine.LRH.1.10.1004271915240.24242@corp1.xtenit.com>
Message-ID: <4BDF8211.4010509@Yahoo.com>

On 4/27/2010 7:22 PM, jks at selectacast.net wrote:
> Slony replication between my two servers is failing with this:
> 
> " ERROR:  invalid byte sequence for encoding "UTF8": 0xac
> HINT:  This error can also happen if the byte sequence does not match the 
> encoding expected by the server, which is controlled by "client_encoding".

Please see this thread:

http://lists.slony.info/pipermail/slony1-general/2010-April/010596.html

The fix is committed in all relevant branches and will be released ASAP.


Jan


> 
> Searching the archives has revealed that people have had this problem 
> before, but the consensus was that the problem was caused by the two pg 
> installations having different versions or different encodings.  Both my 
> servers are pg 8.4.3, encodings are UTF8, and slony is 2.0.3.
> 
> So my questions are:
> 
> 1) How can I fix this problem and make sure it never happens again?
> 
> 2) In the short run how can I break slony out of its loop?  Can I find 
> this entry in sl_log_X somewhere and delete it?
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


-- 
Anyone who trades liberty for security deserves neither
liberty nor security. -- Benjamin Franklin

From ssinger at ca.afilias.info  Wed May  5 07:51:51 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Wed, 05 May 2010 10:51:51 -0400
Subject: [Slony1-general] [rangerrick@befunk.com: slony patch for osx]
In-Reply-To: <4BDC3FA2.1070703@Yahoo.com>
References: <20100423160654.GA18954@fetter.org> <4BDC9C8D.104@ca.afilias.info>
	<4BDC3FA2.1070703@Yahoo.com>
Message-ID: <4BE18607.70202@ca.afilias.info>

Jan Wieck wrote:
> On 5/1/2010 5:26 PM, Steve Singer wrote:
>> David Fetter wrote:
>>> Folks,

> 
> I think the intention of the patch is to look for a suitable size_t and 
> fallback to int if none was found.

The patch seemed to address 1 things

1) Support for newer autoconfs, which seems to not break the older 2.59. 
  I am happy committing that portion of the patch (attached here, also 
available as commit b77b608d63cab2a4519f66f7436a29cc808b502a on the 
REL2_0_PROPOSED_ssinger branch at my git mirror 
(git://github.com/ssinger/slony.git) of the code.

2) The issue with the datatype to use for yyleng.  I would like to know 
the actual error your getting on osx and what version of flex it is 
using. If it really should be size_t then this patch isn't sufficient 
(we need to change all imports of yyleng) but as Jan points out that 
doesn't seem right on some platforms.

Can someone with easy access to an osx machine try building slony with 
the above autoconf patch applied and report on what is happening?

Thanks





> 
> However, in my flex skeleton file (flex 2.5.35 FreeBSD) it is defined as 
> extern int. That is why scan.c has it as int, because the extern 
> declaration in there is coming from the skeleton, not the scan.l file.
> 
> 
> Jan
> 


-- 
Steve Singer
Afilias Canada
Data Services Developer
416-673-1142
-------------- next part --------------
A non-text attachment was scrubbed...
Name: autoconf_fixes.diff
Type: text/x-patch
Size: 3050 bytes
Desc: not available
Url : http://lists.slony.info/pipermail/slony1-general/attachments/20100505/adcad19b/attachment.bin 

From david at fetter.org  Wed May  5 08:20:58 2010
From: david at fetter.org (David Fetter)
Date: Wed, 5 May 2010 08:20:58 -0700
Subject: [Slony1-general] [rangerrick@befunk.com: slony patch for osx]
In-Reply-To: <4BE18607.70202@ca.afilias.info>
References: <20100423160654.GA18954@fetter.org> <4BDC9C8D.104@ca.afilias.info>
	<4BDC3FA2.1070703@Yahoo.com> <4BE18607.70202@ca.afilias.info>
Message-ID: <20100505152058.GB32707@fetter.org>

On Wed, May 05, 2010 at 10:51:51AM -0400, Steve Singer wrote:
> Jan Wieck wrote:
> >On 5/1/2010 5:26 PM, Steve Singer wrote:
> >>David Fetter wrote:
> >>>Folks,
> 
> >
> >I think the intention of the patch is to look for a suitable
> >size_t and fallback to int if none was found.
> 
> The patch seemed to address 1 things
> 
> 1) Support for newer autoconfs, which seems to not break the older
> 2.59.  I am happy committing that portion of the patch (attached
> here, also available as commit
> b77b608d63cab2a4519f66f7436a29cc808b502a on the
> REL2_0_PROPOSED_ssinger branch at my git mirror
> (git://github.com/ssinger/slony.git) of the code.
> 
> 2) The issue with the datatype to use for yyleng.  I would like to
> know the actual error your getting on osx and what version of flex
> it is using. If it really should be size_t then this patch isn't
> sufficient (we need to change all imports of yyleng) but as Jan
> points out that doesn't seem right on some platforms.

According to Benjamin Reed, the patch author, osx expects yyleng to be
size_t.

> Can someone with easy access to an osx machine try building slony
> with the above autoconf patch applied and report on what is
> happening?

Will do and report :)

Cheers,
David.
> diff --git a/config/acx_libpq.m4 b/config/acx_libpq.m4
> index 6047544..cf1412d 100644
> --- a/config/acx_libpq.m4
> +++ b/config/acx_libpq.m4
> @@ -397,11 +397,11 @@ if test -z "$ac_cv_typenameTypeId_args"; then
>    AC_MSG_RESULT(no)
>  else
>    if test "$ac_cv_typenameTypeId_args" = 3; then
> -    AC_DEFINE(HAVE_TYPENAMETYPEID_3)
> +    AC_DEFINE(HAVE_TYPENAMETYPEID_3,1,[typenameTypeId has 3 arguments])
>    elif test "$ac_cv_typenameTypeId_args" = 2; then
> -    AC_DEFINE(HAVE_TYPENAMETYPEID_2)
> +    AC_DEFINE(HAVE_TYPENAMETYPEID_2,1,[typenameTypeId has 2 arguments])
>    elif test "$ac_cv_typenameTypeId_args" = 1; then
> -    AC_DEFINE(HAVE_TYPENAMETYPEID_1)
> +    AC_DEFINE(HAVE_TYPENAMETYPEID_1,1,[typenameTypeId has 1 argument])
>    fi
>    AC_MSG_RESULT([yes, and it takes $ac_cv_typenameTypeId_args arguments])
>  fi
> @@ -410,7 +410,7 @@ AC_MSG_CHECKING(for GetActiveSnapshot)
>  AC_EGREP_HEADER(GetActiveSnapshot, 
>  	utils/snapmgr.h, 
>  	[AC_MSG_RESULT(yes) 
> -	AC_DEFINE(HAVE_GETACTIVESNAPSHOT)], 
> +	AC_DEFINE(HAVE_GETACTIVESNAPSHOT,1,[GetActiveSnapshot in utils/snapmgr.h])],
>  	AC_MSG_RESULT(no)
>  )
>  
> @@ -419,9 +419,9 @@ if test -z "$ac_cv_ScanKeywordLookup_args"; then
>    AC_MSG_RESULT(no)
>  else
>    if test "$ac_cv_ScanKeywordLookup_args" = 1; then
> -	AC_DEFINE(SCANKEYWORDLOOKUP_1)
> +	AC_DEFINE(SCANKEYWORDLOOKUP_1,1,[ScanKeyWordLookup has 1 argument])
>    elif test "$ac_cv_ScanKeywordLookup_args" = 3; then
> -	AC_DEFINE(SCANKEYWORDLOOKUP_3)
> +	AC_DEFINE(SCANKEYWORDLOOKUP_3,1,[ScanKeyWordLookup has 3 arguments])
>    fi
>    AC_MSG_RESULT([yes, and it takes $ac_cv_ScanKeywordLookup_args arguments])
>  fi
> @@ -431,7 +431,7 @@ if test -z "$ac_cv_standard_conforming_strings"; then
>    AC_EGREP_HEADER(standard_conforming_strings, 
>      parser/gramparse.h, 
>      [AC_MSG_RESULT(yes)
> -     AC_DEFINE(HAVE_STANDARDCONFORMINGSTRINGS)],
> +     AC_DEFINE(HAVE_STANDARDCONFORMINGSTRINGS,1,[standard_conforming_strings in parser/gramparse.h])],
>      AC_MSG_RESULT(no)
>      )
>  fi
> diff --git a/configure.ac b/configure.ac
> index 9aaf910..afe2176 100644
> --- a/configure.ac
> +++ b/configure.ac
> @@ -15,6 +15,8 @@ m4_define([SLONREL_VERSION], esyscmd([echo "$Name:  $" | \
>    sed -e 's/\:\ REL_//' -e 's/\$//g' -e 's/_/./g' -e 's/\./\_/3' \
>      -e 's/\ //g' -e s/\:/`date +HEAD_%Y%m%d`/ | tr -d '\n']))
>  
> +m4_pattern_allow([^SLON_AC_])
> +
>  AC_INIT(slony1,[SLONREL_VERSION])
>  AC_CONFIG_HEADERS(config.h)
>  AC_CONFIG_AUX_DIR(config)
> @@ -119,9 +121,10 @@ AC_CHECK_FUNCS([strtoul])
>  
>  AC_CHECK_TYPES([int32_t, uint32_t, u_int32_t])
>  AC_CHECK_TYPES([int64_t, uint64_t, u_int64_t])
> -AC_CHECK_TYPES([ssize_t])
> +AC_CHECK_TYPES([size_t, ssize_t])
>  SLON_AC_FUNC_POSIX_SIGNALS()
>  
> +
>  # ----
>  # Locate PostgreSQL paths
>  # ----
> diff --git a/src/slony_logshipper/parser.y b/src/slony_logshipper/parser.y
> index a3898bf..539e0ef 100755
> --- a/src/slony_logshipper/parser.y
> +++ b/src/slony_logshipper/parser.y
> @@ -11,6 +11,7 @@
>   *-------------------------------------------------------------------------
>   */
>  
> +#include "config.h"
>  #include "postgres.h"
>  #include "libpq-fe.h"
>  #include "slony_logshipper.h"


-- 
David Fetter <david at fetter.org> http://fetter.org/
Phone: +1 415 235 3778  AIM: dfetter666  Yahoo!: dfetter
Skype: davidfetter      XMPP: david.fetter at gmail.com
iCal: webcal://www.tripit.com/feed/ical/people/david74/tripit.ics

Remember to vote!
Consider donating to Postgres: http://www.postgresql.org/about/donate

From ssinger at ca.afilias.info  Wed May  5 09:04:29 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Wed, 05 May 2010 12:04:29 -0400
Subject: [Slony1-general] [rangerrick@befunk.com: slony patch for osx]
In-Reply-To: <20100505152058.GB32707@fetter.org>
References: <20100423160654.GA18954@fetter.org> <4BDC9C8D.104@ca.afilias.info>
	<4BDC3FA2.1070703@Yahoo.com> <4BE18607.70202@ca.afilias.info>
	<20100505152058.GB32707@fetter.org>
Message-ID: <4BE1970D.6050400@ca.afilias.info>

David Fetter wrote:
> 
> According to Benjamin Reed, the patch author, osx expects yyleng to be
> size_t.
>

It looks like flex changed the datatype they use around version 2.5.35 
(http://flex.cvs.sourceforge.net/viewvc/flex/flex/NEWS?revision=2.194&view=markup) 


I think I can replace our direct use of yyleng with calls to yyget_len() 
to avoid this issue






-- 
Steve Singer
Afilias Canada
Data Services Developer
416-673-1142

From ssinger at ca.afilias.info  Wed May  5 12:55:39 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Wed, 05 May 2010 15:55:39 -0400
Subject: [Slony1-general] [Slony1-patches] [rangerrick@befunk.com: slony
 patch for osx]
In-Reply-To: <4BE1970D.6050400@ca.afilias.info>
References: <20100423160654.GA18954@fetter.org>
	<4BDC9C8D.104@ca.afilias.info>	<4BDC3FA2.1070703@Yahoo.com>
	<4BE18607.70202@ca.afilias.info>	<20100505152058.GB32707@fetter.org>
	<4BE1970D.6050400@ca.afilias.info>
Message-ID: <4BE1CD3B.6000304@ca.afilias.info>

Steve Singer wrote:
> David Fetter wrote:
> 
> 
> I think I can replace our direct use of yyleng with calls to yyget_len() 
> to avoid this issue


David, does this patch (in addition to the autoconf changes) get things 
working on your version of OSX? I've replaced uses of yyleng with 
yyget_len() and am having flex generate a proper prototype for it.



http://github.com/ssinger/slony/commit/0febbf93046600e3fd7c59e37ca3b14cc137eb64



> 
> 
> 
> 
> 
> 


-- 
Steve Singer
Afilias Canada
Data Services Developer
416-673-1142
-------------- next part --------------
A non-text attachment was scrubbed...
Name: flex_yyget_leng.diff
Type: text/x-patch
Size: 8945 bytes
Desc: not available
Url : http://lists.slony.info/pipermail/slony1-general/attachments/20100505/06e1120f/attachment.bin 

From johnfrederickmoran at gmail.com  Wed May  5 14:52:05 2010
From: johnfrederickmoran at gmail.com (John Moran)
Date: Wed, 5 May 2010 22:52:05 +0100
Subject: [Slony1-general] I don't want failover;
	Can I skip chatter between slaves?
Message-ID: <y2ya6e804a01005051452l7dc2a342y7593286510c08ba8@mail.gmail.com>

Hi,

I'm not interested in failover; it doesn't make sense for my domain.
I'd like to use Slony, without paying for the overhead of "chatter"
between slaves; they don't need to SYNC between each other, because
I'll never failover or switchover.

Can I simply not have paths between slaves, and avoid the performance penalty?

Thanks,
John Moran

From melvin6925 at yahoo.com  Wed May  5 15:02:44 2010
From: melvin6925 at yahoo.com (Melvin Davidson)
Date: Wed, 5 May 2010 15:02:44 -0700 (PDT)
Subject: [Slony1-general] I don't want failover;
	Can I skip chatter between slaves?
In-Reply-To: <y2ya6e804a01005051452l7dc2a342y7593286510c08ba8@mail.gmail.com>
Message-ID: <142930.38704.qm@web53005.mail.re2.yahoo.com>

>Can I simply not have paths between slaves, and avoid the performance 
penalty?

That's kind of like saying "I want a car, but I don't want it to have an engine because
I'm never going to use the gas pedal".

If you don't have paths, it won't work. Slony needs paths to know were to send that data.
Likewise, it needs to know if the data got to the slaves, hence the "chatter".

Melvin Davidson 


--- On Wed, 5/5/10, John Moran <johnfrederickmoran at gmail.com> wrote:

From: John Moran <johnfrederickmoran at gmail.com>
Subject: [Slony1-general] I don't want failover; Can I skip chatter between slaves?
To: slony1-general at lists.slony.info
Date: Wednesday, May 5, 2010, 4:52 PM

Hi,

I'm not interested in failover; it doesn't make sense for my domain.
I'd like to use Slony, without paying for the overhead of "chatter"
between slaves; they don't need to SYNC between each other, because
I'll never failover or switchover.

Can I simply not have paths between slaves, and avoid the performance penalty?

Thanks,
John Moran
_______________________________________________
Slony1-general mailing list
Slony1-general at lists.slony.info
http://lists.slony.info/mailman/listinfo/slony1-general



      
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20100505/7c99e8a1/attachment.htm 

From johnfrederickmoran at gmail.com  Wed May  5 15:27:25 2010
From: johnfrederickmoran at gmail.com (John Moran)
Date: Wed, 5 May 2010 23:27:25 +0100
Subject: [Slony1-general] I don't want failover;
	Can I skip chatter 	between slaves?
In-Reply-To: <142930.38704.qm@web53005.mail.re2.yahoo.com>
References: <y2ya6e804a01005051452l7dc2a342y7593286510c08ba8@mail.gmail.com>
	<142930.38704.qm@web53005.mail.re2.yahoo.com>
Message-ID: <s2ia6e804a01005051527l67500226jf0ea0993a22bca96@mail.gmail.com>

>
> That's kind of like saying "I want a car, but I don't want it to have an
> engine because
> I'm never going to use the gas pedal".
>
> If you don't have paths, it won't work. Slony needs paths to know were to
> send that data.
> Likewise, it needs to know if the data got to the slaves, hence the
> "chatter".
>
>
Are you sure about that? I understood that you could get away with not
having paths between slaves, provided you had paths to and from each slave
and the master. The downside was that failover wouldn't work, but that's
acceptable for my purposes. Why pay for something I'm not using?

Thanks,
John
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20100505/1b5e3130/attachment.htm 

From melvin6925 at yahoo.com  Wed May  5 15:50:57 2010
From: melvin6925 at yahoo.com (Melvin Davidson)
Date: Wed, 5 May 2010 15:50:57 -0700 (PDT)
Subject: [Slony1-general] I don't want failover;
	Can I skip chatter  between slaves?
In-Reply-To: <s2ia6e804a01005051527l67500226jf0ea0993a22bca96@mail.gmail.com>
Message-ID: <955317.16495.qm@web53008.mail.re2.yahoo.com>

>I understood that you could get away with not having paths between 
slaves, provided you >had paths to and from each slave and the master.

Ah! That is not what you originally stated. Your original query was understood to mean to not have _any_ paths. Yes, if you define the path(s) from master to slave(s), then it will work. Although I personally don;t see the benefit, unless you are talking about _many_ slaves.

Melvin Davidson 


--- On Wed, 5/5/10, John Moran <johnfrederickmoran at gmail.com> wrote:

From: John Moran <johnfrederickmoran at gmail.com>
Subject: Re: [Slony1-general] I don't want failover; Can I skip chatter  between slaves?
To: "Melvin Davidson" <melvin6925 at yahoo.com>
Cc: slony1-general at lists.slony.info
Date: Wednesday, May 5, 2010, 5:27 PM




That's kind of like saying "I want a car, but I don't want it to have an engine because
I'm never going to use the gas pedal".

If you don't have paths, it won't work. Slony needs paths to know were to send that data.

Likewise, it needs to know if the data got to the slaves, hence the "chatter".


Are you sure about that? I understood that you could get away with not having paths between slaves, provided you had paths to and from each slave and the master. The downside was that failover wouldn't work, but that's acceptable for my purposes. Why pay for something I'm not using?


Thanks,
John




      
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20100505/960baa8e/attachment.htm 

From johnfrederickmoran at gmail.com  Wed May  5 15:56:35 2010
From: johnfrederickmoran at gmail.com (John Moran)
Date: Wed, 5 May 2010 23:56:35 +0100
Subject: [Slony1-general] I don't want failover;
	Can I skip chatter 	between slaves?
In-Reply-To: <955317.16495.qm@web53008.mail.re2.yahoo.com>
References: <s2ia6e804a01005051527l67500226jf0ea0993a22bca96@mail.gmail.com>
	<955317.16495.qm@web53008.mail.re2.yahoo.com>
Message-ID: <p2ma6e804a01005051556m42650e20g6f5bf8764d3f1ce@mail.gmail.com>

Hi Melvin,


> Ah! That is not what you originally stated. Your original query was
> understood to mean to not have _any_ paths. Yes, if you define the path(s)
> from master to slave(s), then it will work. Although I personally don;t see
> the benefit, unless you are talking about _many_ slaves.


The benefit is that I don't have to maintain paths, nor do I pay any
overhead for a feature I am absolutely certain I will never use.

Regards,
John
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20100505/eb7f3e78/attachment-0001.htm 

From cbbrowne at ca.afilias.info  Thu May  6 08:22:28 2010
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Thu, 06 May 2010 11:22:28 -0400
Subject: [Slony1-general] I don't want failover;
	Can I skip chatter 	between slaves?
In-Reply-To: <p2ma6e804a01005051556m42650e20g6f5bf8764d3f1ce@mail.gmail.com>
	(John Moran's message of "Wed, 5 May 2010 23:56:35 +0100")
References: <s2ia6e804a01005051527l67500226jf0ea0993a22bca96@mail.gmail.com>
	<955317.16495.qm@web53008.mail.re2.yahoo.com>
	<p2ma6e804a01005051556m42650e20g6f5bf8764d3f1ce@mail.gmail.com>
Message-ID: <87mxwdrr63.fsf@ca.afilias.info>

John Moran <johnfrederickmoran at gmail.com> writes:
>
>     Ah! That is not what you originally stated. Your original query was
>     understood to mean to not have _any_ paths. Yes, if you define the path(s)
>     from master to slave(s), then it will work. Although I personally don;t see
>     the benefit, unless you are talking about _many_ slaves.
>
>
> The benefit is that I don't have to maintain paths, nor do I pay any overhead
> for a feature I am absolutely certain I will never use.

There will still be chatter, because, in order for replication logs
(e.g. - tables sl_log_1 and sl_log_2, sl_event, sl_confirm) to get
trimmed, Slony-I requires that events propagate in to/from all nodes.

If you haven't got paths between the subscribers, that's OK - the
chatter (and therefore, overhead) will get communicated via the paths to
the master.

- The chatter will still take place, so confirmations will get through,
  and trimmable tables will get trimmed.

  +1

- The chatter will still take place, so the chatter you imagined you
  were saving yourself from will still take place.

  -1

In other words, while what you're doing is feasible and supportable, it
doesn't save you what you think it's saving.

But the same total number of SYNC and confirmation events still have to
get from each node to every other node, so you're not really eliminating
the chatter.

It's possible that by aggregating the event propagation into the pair of
sets of channels (e.g. - from origin to subscribers, and from
subscribers to origin), there may be *some* savings.  I imagine that:
  a) There should be somewhat fewer DB connections, and
  b) It's possible that event propagation takes place more "in bulk."
     (Though this could be a mirage that I'm imagining.)
-- 
output = ("cbbrowne" "@" "ca.afilias.info")
Christopher Browne
"Bother,"  said Pooh,  "Eeyore, ready  two photon  torpedoes  and lock
phasers on the Heffalump, Piglet, meet me in transporter room three"

From JanWieck at Yahoo.com  Thu May  6 08:42:57 2010
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Thu, 06 May 2010 11:42:57 -0400
Subject: [Slony1-general] I don't want failover;
 Can I skip chatter 	between slaves?
In-Reply-To: <87mxwdrr63.fsf@ca.afilias.info>
References: <s2ia6e804a01005051527l67500226jf0ea0993a22bca96@mail.gmail.com>	<955317.16495.qm@web53008.mail.re2.yahoo.com>	<p2ma6e804a01005051556m42650e20g6f5bf8764d3f1ce@mail.gmail.com>
	<87mxwdrr63.fsf@ca.afilias.info>
Message-ID: <4BE2E381.3040304@Yahoo.com>

Actually it is beneficial to NOT have a full web of paths from 
everywhere to everywhere, but only have the paths defined where data 
travels and confirmations flow back. Less places to listen on, less DB 
connections to maintain.

People just tend to create those full blown webs because they can't 
figure out how to properly reconfigure their cluster the moment, they 
need to fail over.

As long as you create paths from your subscribers to the origin and back 
you are fine. And you're not even making failover impossible. It just 
becomes a slightly longer slonik script.


Jan

-- 
Anyone who trades liberty for security deserves neither
liberty nor security. -- Benjamin Franklin

From johnfrederickmoran at gmail.com  Fri May  7 04:45:55 2010
From: johnfrederickmoran at gmail.com (John Moran)
Date: Fri, 7 May 2010 12:45:55 +0100
Subject: [Slony1-general] I don't want failover;
	Can I skip chatter 	between slaves?
In-Reply-To: <4BE2E381.3040304@Yahoo.com>
References: <s2ia6e804a01005051527l67500226jf0ea0993a22bca96@mail.gmail.com>
	<955317.16495.qm@web53008.mail.re2.yahoo.com>
	<p2ma6e804a01005051556m42650e20g6f5bf8764d3f1ce@mail.gmail.com>
	<87mxwdrr63.fsf@ca.afilias.info> <4BE2E381.3040304@Yahoo.com>
Message-ID: <v2wa6e804a01005070445oc3b5a71dr16787a46123d206b@mail.gmail.com>

Thanks a lot guys. That's very helpful.

Regards,
John

From sowjuec at gmail.com  Sun May  9 22:29:25 2010
From: sowjuec at gmail.com (sowjanya v)
Date: Mon, 10 May 2010 10:59:25 +0530
Subject: [Slony1-general] Need Urgent Help
Message-ID: <g2iae01d4351005092229u9fb4cea1hdef5c36288530496@mail.gmail.com>

Hi,

I have two databases db1 and db2. db2 is replica of db1. Now i have added a
column in a table in db1. Since schema changes do not propogate by itself to
db2, need to execute execute script. But the input for that is a sql file
with all  difference in schema. Hence please let me know how replicate the
schema changes. If i do the diff of two schemas, it only shows the lines
where the difference is present and not the sql command to be executed on
db2 to make it same as db1. Please do reply immediately.

-- 
Sowjanya
 Wipro Technologies
  Bangalore
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20100510/98cd1f4d/attachment.htm 

From glynastill at yahoo.co.uk  Mon May 10 00:58:20 2010
From: glynastill at yahoo.co.uk (Glyn Astill)
Date: Mon, 10 May 2010 07:58:20 +0000 (GMT)
Subject: [Slony1-general] Need Urgent Help
In-Reply-To: <g2iae01d4351005092229u9fb4cea1hdef5c36288530496@mail.gmail.com>
Message-ID: <623679.38829.qm@web23604.mail.ird.yahoo.com>

Sowjanya,

You put the ddl into the sql file to run via slonik execute script and the changes are made by slony on the origin and all subscribed nodes.

You shouldn't be doing any ddl on replicated tables outside of slonik.

Glyn

--- On Mon, 10/5/10, sowjanya v <sowjuec at gmail.com> wrote:

From: sowjanya v <sowjuec at gmail.com>
Subject: [Slony1-general] Need Urgent Help
To: slony1-general at lists.slony.info
Date: Monday, 10 May, 2010, 6:29

Hi,

I have two databases db1 and db2. db2 is replica of db1. Now i have added a column in a table in db1. Since schema changes do not propogate by itself to db2, need to execute execute script. But the input for that is a sql file with all? difference in schema. Hence please let me know how replicate the schema changes. If i do the diff of two schemas, it only shows the lines where the difference is present and not the sql command to be executed on db2 to make it same as db1. Please do reply immediately. 


-- 
Sowjanya
 ?Wipro Technologies
 ? Bangalore


-----Inline Attachment Follows-----

_______________________________________________
Slony1-general mailing list
Slony1-general at lists.slony.info
http://lists.slony.info/mailman/listinfo/slony1-general



      
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20100510/70f5857e/attachment.htm 

From ssinger_pg at sympatico.ca  Mon May 10 04:07:00 2010
From: ssinger_pg at sympatico.ca (Steve Singer)
Date: Mon, 10 May 2010 07:07:00 -0400 (EDT)
Subject: [Slony1-general] Need Urgent Help
In-Reply-To: <g2iae01d4351005092229u9fb4cea1hdef5c36288530496@mail.gmail.com>
References: <g2iae01d4351005092229u9fb4cea1hdef5c36288530496@mail.gmail.com>
Message-ID: <BLU0-SMTP47E7D346CB1E0FEF2761D9ACF90@phx.gbl>

On Mon, 10 May 2010, sowjanya v wrote:

> Hi,
>
> I have two databases db1 and db2. db2 is replica of db1. Now i have added a
> column in a table in db1. Since schema changes do not propogate by itself to
> db2, need to execute execute script. But the input for that is a sql file
> with all  difference in schema. Hence please let me know how replicate the
> schema changes. If i do the diff of two schemas, it only shows the lines
> where the difference is present and not the sql command to be executed on
> db2 to make it same as db1. Please do reply immediately.

What do you mean by 'with all difference in schema'? Are you saying that db1 
and db2 have a different schema on them? Specifically different columns for 
the same table? If so I think your asking for trouble.



>
> -- 
> Sowjanya
> Wipro Technologies
>  Bangalore
>


From JanWieck at Yahoo.com  Mon May 10 07:49:37 2010
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Mon, 10 May 2010 10:49:37 -0400
Subject: [Slony1-general] Need Urgent Help
In-Reply-To: <BLU0-SMTP47E7D346CB1E0FEF2761D9ACF90@phx.gbl>
References: <g2iae01d4351005092229u9fb4cea1hdef5c36288530496@mail.gmail.com>
	<BLU0-SMTP47E7D346CB1E0FEF2761D9ACF90@phx.gbl>
Message-ID: <4BE81D01.2020700@Yahoo.com>

On 5/10/2010 7:07 AM, Steve Singer wrote:
> On Mon, 10 May 2010, sowjanya v wrote:
> 
>> Hi,
>>
>> I have two databases db1 and db2. db2 is replica of db1. Now i have added a
>> column in a table in db1. Since schema changes do not propogate by itself to
>> db2, need to execute execute script. But the input for that is a sql file
>> with all  difference in schema. Hence please let me know how replicate the
>> schema changes. If i do the diff of two schemas, it only shows the lines
>> where the difference is present and not the sql command to be executed on
>> db2 to make it same as db1. Please do reply immediately.
> 
> What do you mean by 'with all difference in schema'? Are you saying that db1 
> and db2 have a different schema on them? Specifically different columns for 
> the same table? If so I think your asking for trouble.

Sounds to me as if Sowjanya already did all the DDL against db1, 
probably manually and not protocoling what exactly was done, and is now 
looking for some automagical way to get db2's schema back into sync.


Jan

-- 
Anyone who trades liberty for security deserves neither
liberty nor security. -- Benjamin Franklin

From vivek at khera.org  Mon May 10 08:14:39 2010
From: vivek at khera.org (Vick Khera)
Date: Mon, 10 May 2010 11:14:39 -0400
Subject: [Slony1-general] Need Urgent Help
In-Reply-To: <g2iae01d4351005092229u9fb4cea1hdef5c36288530496@mail.gmail.com>
References: <g2iae01d4351005092229u9fb4cea1hdef5c36288530496@mail.gmail.com>
Message-ID: <AANLkTikNjEywF861ZZcM3Prjm9othlIcrC3yHpBZRUw8@mail.gmail.com>

On Mon, May 10, 2010 at 1:29 AM, sowjanya v <sowjuec at gmail.com> wrote:
> Hi,
>
> I have two databases db1 and db2. db2 is replica of db1. Now i have added a
> column in a table in db1. Since schema changes do not propogate by itself to
> db2, need to execute execute script. But the input for that is a sql file
> with all? difference in schema. Hence please let me know how replicate the
> schema changes. If i do the diff of two schemas, it only shows the lines
> where the difference is present and not the sql command to be executed on
> db2 to make it same as db1. Please do reply immediately.

What you need to do is take the commands that you actually ran by hand
(they should be in your .pgsql_history file) and put those into a
file, then run that script.  You should *never* update your production
schemas in any other way than having the commands in a file.  Further
you should never update your schemas without running them thru EXECUTE
SCRIPTslonik command.

You will want to un-do whatever changes you made to your master and
run those thru the EXECUTE SCRIPT slonik command as well.  Otherwise
your replication will likely be broken.  Without knowing what changes
you made, it is even possibile your data is not properly synchronized
already.

From dba at richyen.com  Mon May 10 12:24:07 2010
From: dba at richyen.com (Richard Yen)
Date: Mon, 10 May 2010 12:24:07 -0700
Subject: [Slony1-general] Need Urgent Help
In-Reply-To: <AANLkTikMZCwZovZbPc_egsdp9WxKpBjpb6dbCSTUa8rU@mail.gmail.com>
References: <g2iae01d4351005092229u9fb4cea1hdef5c36288530496@mail.gmail.com>
	<0735983E-D667-4F18-AFCC-018E3CAB120F@iparadigms.com>
	<AANLkTikMZCwZovZbPc_egsdp9WxKpBjpb6dbCSTUa8rU@mail.gmail.com>
Message-ID: <45BBBBA4-EBEA-4CCE-877C-E562691C51D2@richyen.com>

Yeah, you just need the one command in the file.  When you call EXECUTE SCRIPT, you will need to provide a file name.

"second doubt is will slonik automaticall switch the db to mydb(contactdb), before executing that commnad?"

I'm not sure what you mean by that...can you be more specific?  What is meant by switching, and are db/mydb different machines or different databases?  I think I need to get a better understanding of your architecture.

--Richard


On May 10, 2010, at 4:09 AM, sowjanya v wrote:

> Is it sufficient to have only one line mentioned below in .sql file or is there any syntax for it? send me one sample file. 
> 
> alter table sowjanya add column address1;
> 
> second doubt is will slonik automaticall switch the db to mydb(contactdb), before executing that commnad? 
> 
> 
> On Mon, May 10, 2010 at 11:56 AM, Richard Yen <dba at richyen.com> wrote:
> If you haven't populated the new column on db1, you can just drop the column.  then, you can add the column via EXECUTE SCRIPT and you should be all set--that will create the column on both db1 and db2.
> 
> --Richard
> 
> 
> On May 9, 2010, at 10:29 PM, sowjanya v wrote:
> 
> > Hi,
> >
> > I have two databases db1 and db2. db2 is replica of db1. Now i have added a column in a table in db1. Since schema changes do not propogate by itself to db2, need to execute execute script. But the input for that is a sql file with all  difference in schema. Hence please let me know how replicate the schema changes. If i do the diff of two schemas, it only shows the lines where the difference is present and not the sql command to be executed on db2 to make it same as db1. Please do reply immediately.
> >
> > --
> > Sowjanya
> > Wipro Technologies
> > Bangalore
> > _______________________________________________
> > Slony1-general mailing list
> > Slony1-general at lists.slony.info
> > http://lists.slony.info/mailman/listinfo/slony1-general
> 
> 
> 
> 
> -- 
> Sowjanya
>  Wipro Technologies
>   Bangalore


From cbbrowne at ca.afilias.info  Mon May 10 14:41:04 2010
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Mon, 10 May 2010 17:41:04 -0400
Subject: [Slony1-general] Need Urgent Help
In-Reply-To: <g2iae01d4351005092229u9fb4cea1hdef5c36288530496@mail.gmail.com>
	(sowjanya v.'s message of "Mon, 10 May 2010 10:59:25 +0530")
References: <g2iae01d4351005092229u9fb4cea1hdef5c36288530496@mail.gmail.com>
Message-ID: <87sk5zbfkf.fsf@ca.afilias.info>

sowjanya v <sowjuec at gmail.com> writes:
> I have two databases db1 and db2. db2 is replica of db1. Now i have added a
> column in a table in db1. Since schema changes do not propogate by itself to
> db2, need to execute execute script. But the input for that is a sql file with
> all? difference in schema. Hence please let me know how replicate the schema
> changes. If i do the diff of two schemas, it only shows the lines where the
> difference is present and not the sql command to be executed on db2 to make it
> same as db1. Please do reply immediately.

It sounds to me as though you're trying to use an SCM's "diff" command
to find the difference between schemas.

At simplest level, this would be like having two files:

% cat schema1.sql
create table t1 (
  id serial primary key,
  name text not null unique,
  created_on timestamptz default now()
);
% cat schema2.sql
create table t1 (
  id serial primary key,
  name text not null unique,
  created_on timestamptz NOT NULL default now(),
  updated_on timestamptz NOT NULL default now()
);
% diff schema1.sql schema2.sql
4c4,5
<   created_on timestamptz default now()
---
>   created_on timestamptz NOT NULL default now(),
>   updated_on timestamptz NOT NULL default now()

If you're using CVS, Subversion, or such, the commands might be a bit
different, but the output would be pretty similar.

What you'd presumably need, in order to set up EXECUTE SCRIPT to make
this change, is a SQL script consisting of something like the following:

  -- Upgrade from schema1.sql to schema2.sql
  alter table t1 alter column created_on set not null;
  alter table t1 add column updated_on timestamptz;
  update t1 set updated_on = '2010-05-10'; -- somewhat arbitrary value
  alter table t1 alter column updated_on set default now();
  alter table t1 alter column updated_on set not null;

There isn't a way to get a text-file-oriented SCM to generate that set
of 5 SQL statements.

There exist some tools that *try* to create "differencing scripts."
Some of our folks at Afilias have had some success with DBSolo
<http://www.dbsolo.com/>, though that success was fairly limited.

DBSolo might be able to figure out the 4 ALTER TABLE statements, but
it's not aware that the data requires alteration (e.g. - the UPDATE
statement), and that's not something that seems reasonable to expect a
tool to mechanically figure out for you.

In effect, you need to generate the update script.

And, not inicidentally, if you've already altered the first database,
db1, then replication is more than likely already quite badly broken.
Cleaning up after the problem is liable to be a lot more burdensome in
understanding all the details.
-- 
output = ("cbbrowne" "@" "ca.afilias.info")
Christopher Browne
"Bother,"  said Pooh,  "Eeyore, ready  two photon  torpedoes  and lock
phasers on the Heffalump, Piglet, meet me in transporter room three"

From cdave at ca.afilias.info  Mon May 10 14:53:28 2010
From: cdave at ca.afilias.info (Chirag Dave)
Date: Mon, 10 May 2010 17:53:28 -0400
Subject: [Slony1-general] Need Urgent Help
In-Reply-To: <87sk5zbfkf.fsf@ca.afilias.info>
References: <g2iae01d4351005092229u9fb4cea1hdef5c36288530496@mail.gmail.com>
	<87sk5zbfkf.fsf@ca.afilias.info>
Message-ID: <4BE88058.9030302@ca.afilias.info>

Christopher Browne wrote:
> sowjanya v <sowjuec at gmail.com> writes:
>   
>> I have two databases db1 and db2. db2 is replica of db1. Now i have added a
>> column in a table in db1. Since schema changes do not propogate by itself to
>> db2, need to execute execute script. But the input for that is a sql file with
>> all  difference in schema. Hence please let me know how replicate the schema
>> changes. If i do the diff of two schemas, it only shows the lines where the
>> difference is present and not the sql command to be executed on db2 to make it
>> same as db1. Please do reply immediately.
>>     
>
> It sounds to me as though you're trying to use an SCM's "diff" command
> to find the difference between schemas.
>
> At simplest level, this would be like having two files:
>
> % cat schema1.sql
> create table t1 (
>   id serial primary key,
>   name text not null unique,
>   created_on timestamptz default now()
> );
> % cat schema2.sql
> create table t1 (
>   id serial primary key,
>   name text not null unique,
>   created_on timestamptz NOT NULL default now(),
>   updated_on timestamptz NOT NULL default now()
> );
> % diff schema1.sql schema2.sql
> 4c4,5
> <   created_on timestamptz default now()
> ---
>   
>>   created_on timestamptz NOT NULL default now(),
>>   updated_on timestamptz NOT NULL default now()
>>     
>
> If you're using CVS, Subversion, or such, the commands might be a bit
> different, but the output would be pretty similar.
>
> What you'd presumably need, in order to set up EXECUTE SCRIPT to make
> this change, is a SQL script consisting of something like the following:
>
>   -- Upgrade from schema1.sql to schema2.sql
>   alter table t1 alter column created_on set not null;
>   alter table t1 add column updated_on timestamptz;
>   update t1 set updated_on = '2010-05-10'; -- somewhat arbitrary value
>   alter table t1 alter column updated_on set default now();
>   alter table t1 alter column updated_on set not null;
>
> There isn't a way to get a text-file-oriented SCM to generate that set
> of 5 SQL statements.
>
> There exist some tools that *try* to create "differencing scripts."
> Some of our folks at Afilias have had some success with DBSolo
> <http://www.dbsolo.com/>, though that success was fairly limited.
>   
There are other tools like Aquafold (http://www.aquafold.com) which does 
a good job as well.
> DBSolo might be able to figure out the 4 ALTER TABLE statements, but
> it's not aware that the data requires alteration (e.g. - the UPDATE
> statement), and that's not something that seems reasonable to expect a
> tool to mechanically figure out for you.
>
> In effect, you need to generate the update script.
>
> And, not inicidentally, if you've already altered the first database,
> db1, then replication is more than likely already quite badly broken.
> Cleaning up after the problem is liable to be a lot more burdensome in
> understanding all the details.
>   


-- 
Chirag Dave  416-673-4102
Database Administrator, Afilias Canada Corp.
cdave at ca.afilias.info



From brianf at consistentstate.com  Mon May 10 15:07:25 2010
From: brianf at consistentstate.com (Brian Fehrle)
Date: Mon, 10 May 2010 16:07:25 -0600
Subject: [Slony1-general] Drop Node command works, but leaves crumbs behind.
Message-ID: <4BE8839D.8070708@consistentstate.com>

Hi all,
    I've been running into a problem with dropping a node from the slony 
cluster, in which the slony system catalogs aren't getting fully cleaned 
up upon the dropping of the node.

    I have a three node cluster, one master and two slaves. I have a 
script that will generate the slonik command that will drop one of the 
slaves (in this case node three) from the slony cluster and it executes 
without problem. However, after preforming the drop node a few dozen 
times, there have been several instances in which the data in 
_slony.sl_status still refers to a third node, and the st_lag_num_events 
climb and climb (since there's no node to sync with, it will never drop 
to 0).

So the problem is after I drop a node, everything looks great except for 
the _slony.sl_status table, in any or all the remaining nodes, still 
refers to the node that was just dropped.

I did quite a few test runs of the drop node to try to reproduce and 
determine the cause. After the drop node, if I look in sl_node, sl_path, 
sl_event, or any other sl_ location, I see no reference to the third 
node. However, about half the time I would still get references to the 
third node in sl_status. This can either be on the master node, or the 
(remaining) slave node, or both. There was one test scenario that I 
monitored the sl_status table and noticed that node 3 disappeared, then 
reappeared a second later, then remained.

Example queries done on node 2 (slave) after dropping node 3 (other slave):

postgres=# select * from _slony.sl_node;
 no_id | no_active | no_comment | no_spool
-------+-----------+------------+----------
     1 | t         | Server 1   | f
     2 | t         | Server 2   | f
(2 rows)

postgres=# select * from _slony.sl_path ;
 pa_server | pa_client |                        
pa_conninfo                         | pa_connretry
-----------+-----------+------------------------------------------------------------+--------------
         1 |         2 | dbname=postgres host=172.16.44.111 port=5432 
user=postgres |           10
         2 |         1 | dbname=postgres host=172.16.44.129 port=5432 
user=postgres |           10
(2 rows)

postgres=# select * from _slony.sl_status;
 st_origin | st_received | st_last_event |      st_last_event_ts      | 
st_last_received |    st_last_received_ts     | 
st_last_received_event_ts  | st_lag_num_events |   st_lag_time
-----------+-------------+---------------+----------------------------+------------------+----------------------------+----------------------------+-------------------+-----------------
         2 |           1 |          1649 | 2010-05-10 15:53:16.245529 
|             1649 | 2010-05-10 15:53:16.246212 | 2010-05-10 
15:53:16.245529 |                 0 | 00:00:05.57205
         2 |           3 |          1656 | 2010-05-10 15:54:26.280131 
|             1636 | 2010-05-10 15:51:05.341512 | 2010-05-10 
15:51:05.343754 |                20 | 00:03:22.66664


Also, another problem that may be linked is the fact that the slon 
daemon for node 3 does not terminate itself after it. Watching the log 
output by that daemon, it shows that it recieves the drop node command 
for itself, and it drops the _slony schema as intended. However after 
that it reports "2010-05-10 15:57:56 MDT FATAL  main: Node is not 
initialized properly - sleep 10s" and keeps checking every ten seconds. 
I'm not sure if somehow this daemon is causing some post-drop-node 
entries into the sl_event section that causes the sl_status entry to be 
recreated.

In case it helps, here is a copy of the drop node script I'm running.

#!/bin/bash
slonik <<_EOF_
cluster name = slony;
node 1 admin conninfo = ' dbname=postgres host=172.16.44.111 port=5432 
user=postgres';
node 2 admin conninfo = ' dbname=postgres host=172.16.44.129 port=5432 
user=postgres';
node 3 admin conninfo = ' dbname=postgres host=172.16.44.142 port=5432 
user=postgres';
DROP NODE ( ID = 3, EVENT NODE = 1 );
_EOF_

I am running on a CentOS 5, postgres 8.4.2, and slony 1.2.20 environment 
on all three nodes.

Thanks in advance,
    Brian Fehrle

From fernandoaguada at gmail.com  Mon May 10 17:19:29 2010
From: fernandoaguada at gmail.com (Fernando Aguada)
Date: Mon, 10 May 2010 21:19:29 -0300
Subject: [Slony1-general] how run  test_slony_state on windows
Message-ID: <A7CBD78AA3564B10920613CFD6CC940C@fernando>

Hello 
sorry for my English !
I'm new to Slony and wanted to know how to run the script test_slony_state on windows,  is this possible?
I appreciate any response.
regards !

Fernando
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20100510/7c56c0b0/attachment.htm 

From JanWieck at Yahoo.com  Mon May 10 19:57:18 2010
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Mon, 10 May 2010 22:57:18 -0400
Subject: [Slony1-general] Drop Node command works,
	but leaves crumbs behind.
In-Reply-To: <4BE8839D.8070708@consistentstate.com>
References: <4BE8839D.8070708@consistentstate.com>
Message-ID: <4BE8C78E.8070501@Yahoo.com>

On 5/10/2010 6:07 PM, Brian Fehrle wrote:
> Hi all,
>     I've been running into a problem with dropping a node from the slony 
> cluster, in which the slony system catalogs aren't getting fully cleaned 
> up upon the dropping of the node.
> 
>     I have a three node cluster, one master and two slaves. I have a 
> script that will generate the slonik command that will drop one of the 
> slaves (in this case node three) from the slony cluster and it executes 
> without problem. However, after preforming the drop node a few dozen 
> times, there have been several instances in which the data in 
> _slony.sl_status still refers to a third node, and the st_lag_num_events 
> climb and climb (since there's no node to sync with, it will never drop 
> to 0).
> 
> So the problem is after I drop a node, everything looks great except for 
> the _slony.sl_status table, in any or all the remaining nodes, still 
> refers to the node that was just dropped.
> 
> I did quite a few test runs of the drop node to try to reproduce and 
> determine the cause. After the drop node, if I look in sl_node, sl_path, 
> sl_event, or any other sl_ location, I see no reference to the third 
> node. However, about half the time I would still get references to the 
> third node in sl_status. This can either be on the master node, or the 
> (remaining) slave node, or both. There was one test scenario that I 
> monitored the sl_status table and noticed that node 3 disappeared, then 
> reappeared a second later, then remained.
> 
> Example queries done on node 2 (slave) after dropping node 3 (other slave):
> 
> postgres=# select * from _slony.sl_node;
>  no_id | no_active | no_comment | no_spool
> -------+-----------+------------+----------
>      1 | t         | Server 1   | f
>      2 | t         | Server 2   | f
> (2 rows)
> 
> postgres=# select * from _slony.sl_path ;
>  pa_server | pa_client |                        
> pa_conninfo                         | pa_connretry
> -----------+-----------+------------------------------------------------------------+--------------
>          1 |         2 | dbname=postgres host=172.16.44.111 port=5432 
> user=postgres |           10
>          2 |         1 | dbname=postgres host=172.16.44.129 port=5432 
> user=postgres |           10
> (2 rows)
> 
> postgres=# select * from _slony.sl_status;
>  st_origin | st_received | st_last_event |      st_last_event_ts      | 
> st_last_received |    st_last_received_ts     | 
> st_last_received_event_ts  | st_lag_num_events |   st_lag_time
> -----------+-------------+---------------+----------------------------+------------------+----------------------------+----------------------------+-------------------+-----------------
>          2 |           1 |          1649 | 2010-05-10 15:53:16.245529 
> |             1649 | 2010-05-10 15:53:16.246212 | 2010-05-10 
> 15:53:16.245529 |                 0 | 00:00:05.57205
>          2 |           3 |          1656 | 2010-05-10 15:54:26.280131 
> |             1636 | 2010-05-10 15:51:05.341512 | 2010-05-10 
> 15:51:05.343754 |                20 | 00:03:22.66664

Since sl_status is a view, the crumbs must be somewhere else. I suspect 
sl_confirm.

There is probably some race condition between dropping the node and 
receiving confirmations from the (now dropped) node. We should add some 
extra cleanup to the cleanup thread as well as STORE NODE to make sure 
things are clean before someone recreates a node with that id.

> Also, another problem that may be linked is the fact that the slon 
> daemon for node 3 does not terminate itself after it. Watching the log 
> output by that daemon, it shows that it recieves the drop node command 
> for itself, and it drops the _slony schema as intended. However after 
> that it reports "2010-05-10 15:57:56 MDT FATAL  main: Node is not 
> initialized properly - sleep 10s" and keeps checking every ten seconds. 
> I'm not sure if somehow this daemon is causing some post-drop-node 
> entries into the sl_event section that causes the sl_status entry to be 
> recreated.

Not sure if terminating that slon by default is the right answer. If you 
are off by one with STORE NODE and starting the slon, you will pile up 
sl_log data and clog the whole cluster until you notice (yes, there are 
people who start the slon before running the STORE NODE).


Jan

-- 
Anyone who trades liberty for security deserves neither
liberty nor security. -- Benjamin Franklin

From raagavendra.rao at gmail.com  Mon May 10 22:33:37 2010
From: raagavendra.rao at gmail.com (raghavendra t)
Date: Tue, 11 May 2010 11:03:37 +0530
Subject: [Slony1-general] --with-perltools is failing when am installing
	Slony-I-1.2.20
Message-ID: <AANLkTikQuHnpcpHQXFgiRg_CjSBq2AckACl3X4pKzBNI@mail.gmail.com>

Hi All,

Can anyone help on this. Am installing slony 1.2.20 on RHEL 5.1 and pointing
to the Postgresql 8.3.9 with perltools, but am not getting all the tools in
my bin directory. Please see  the following configuration command tried for
extracting the perl tools

./configure --prefix=/usr/local/pgsql8.3/bin
--with-pgconfigdir=/usr/local/pgsql8.3/bin
--with-perltools=/usr/local/pgsql8.3/bin

make

make install


After this process, if i check in the /usr/local/pgsql8.3/bin location i see
only "bin" directory and not the perl tools.

Please Advice.

Regards

Raghav
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20100511/523ee444/attachment.htm 

From devrim at gunduz.org  Mon May 10 23:06:03 2010
From: devrim at gunduz.org (Devrim =?ISO-8859-1?Q?G=DCND=DCZ?=)
Date: Tue, 11 May 2010 09:06:03 +0300
Subject: [Slony1-general] --with-perltools is failing when am installing
 Slony-I-1.2.20
In-Reply-To: <AANLkTikQuHnpcpHQXFgiRg_CjSBq2AckACl3X4pKzBNI@mail.gmail.com>
References: <AANLkTikQuHnpcpHQXFgiRg_CjSBq2AckACl3X4pKzBNI@mail.gmail.com>
Message-ID: <1273557963.2190.1.camel@hp-laptop2.gunduz.org>

On Tue, 2010-05-11 at 11:03 +0530, raghavendra t wrote:

> ./configure --prefix=/usr/local/pgsql8.3/bin
> --with-pgconfigdir=/usr/local/pgsql8.3/bin
> --with-perltools=/usr/local/pgsql8.3/bin

IIRC you will need to add

--with-toolsbindir=/usr/local/pgsql8.3/bin

to install perltools.

-- 
Devrim G?ND?Z
PostgreSQL Dan??man?/Consultant, Red Hat Certified Engineer
PostgreSQL RPM Repository: http://yum.pgrpms.org
Community: devrim~PostgreSQL.org, devrim.gunduz~linux.org.tr
http://www.gunduz.org  Twitter: http://twitter.com/devrimgunduz
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 198 bytes
Desc: This is a digitally signed message part
Url : http://lists.slony.info/pipermail/slony1-general/attachments/20100511/34009697/attachment.pgp 

From raagavendra.rao at gmail.com  Mon May 10 23:47:32 2010
From: raagavendra.rao at gmail.com (raghavendra t)
Date: Tue, 11 May 2010 12:17:32 +0530
Subject: [Slony1-general] --with-perltools is failing when am installing
	Slony-I-1.2.20
In-Reply-To: <1273557963.2190.1.camel@hp-laptop2.gunduz.org>
References: <AANLkTikQuHnpcpHQXFgiRg_CjSBq2AckACl3X4pKzBNI@mail.gmail.com>
	<1273557963.2190.1.camel@hp-laptop2.gunduz.org>
Message-ID: <AANLkTinzgfrSdGbtiKNPfKLqW1igc6cWj-aY1cxb7u7G@mail.gmail.com>

Thank you for the update, but still i am not getting the tools, Please find
the output of make and make install


Make install output
==============

make[2]: Entering directory
`/usr/local/src/slony1-1.2.20/src/slony_logshipper'
Missing yacc parser.y parser.c
make[2]: *** [parser.c] Error 1
make[2]: Leaving directory
`/usr/local/src/slony1-1.2.20/src/slony_logshipper'
make[1]: *** [install] Error 2
make[1]: Leaving directory `/usr/local/src/slony1-1.2.20/src'
make: *** [install] Error 2

I have used --with-toolsbindir

Regards
Raghav

2010/5/11 Devrim G?ND?Z <devrim at gunduz.org>

> On Tue, 2010-05-11 at 11:03 +0530, raghavendra t wrote:
>
> > ./configure --prefix=/usr/local/pgsql8.3/bin
> > --with-pgconfigdir=/usr/local/pgsql8.3/bin
> > --with-perltools=/usr/local/pgsql8.3/bin
>
> IIRC you will need to add
>
> --with-toolsbindir=/usr/local/pgsql8.3/bin
>
> to install perltools.
>
> --
> Devrim G?ND?Z
> PostgreSQL Dan??man?/Consultant, Red Hat Certified Engineer
> PostgreSQL RPM Repository: http://yum.pgrpms.org
> Community: devrim~PostgreSQL.org, devrim.gunduz~linux.org.tr
> http://www.gunduz.org  Twitter: http://twitter.com/devrimgunduz
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20100511/b98a4bbe/attachment.htm 

From devrim at gunduz.org  Tue May 11 00:55:34 2010
From: devrim at gunduz.org (Devrim =?ISO-8859-1?Q?G=DCND=DCZ?=)
Date: Tue, 11 May 2010 10:55:34 +0300
Subject: [Slony1-general] --with-perltools is failing when am installing
 Slony-I-1.2.20
In-Reply-To: <AANLkTinzgfrSdGbtiKNPfKLqW1igc6cWj-aY1cxb7u7G@mail.gmail.com>
References: <AANLkTikQuHnpcpHQXFgiRg_CjSBq2AckACl3X4pKzBNI@mail.gmail.com>
	<1273557963.2190.1.camel@hp-laptop2.gunduz.org>
	<AANLkTinzgfrSdGbtiKNPfKLqW1igc6cWj-aY1cxb7u7G@mail.gmail.com>
Message-ID: <1273564534.5575.21.camel@hp-laptop2.gunduz.org>

On Tue, 2010-05-11 at 12:17 +0530, raghavendra t wrote:
> Missing yacc parser.y parser.c

Please run 

yum -y install byacc flex perl-DBD-Pg

and install necessary packages for build. Please note that you need to
re-run configure script.

BTW, there is a howto about installing Slony-I on RHEL/CentOS:

http://people.planetpostgresql.org/devrim/index.php?/archives/38-Installing,-configuring,-running-and-administrating-Slony-I-2.0-on-Red-Hat-CentOS-using-RPMs-Part-1.html#extended

Regards,
-- 
Devrim G?ND?Z
PostgreSQL Dan??man?/Consultant, Red Hat Certified Engineer
PostgreSQL RPM Repository: http://yum.pgrpms.org
Community: devrim~PostgreSQL.org, devrim.gunduz~linux.org.tr
http://www.gunduz.org  Twitter: http://twitter.com/devrimgunduz
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 198 bytes
Desc: This is a digitally signed message part
Url : http://lists.slony.info/pipermail/slony1-general/attachments/20100511/bfe15240/attachment.pgp 

From ssinger at ca.afilias.info  Tue May 11 06:13:03 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Tue, 11 May 2010 09:13:03 -0400
Subject: [Slony1-general] how run  test_slony_state on windows
In-Reply-To: <A7CBD78AA3564B10920613CFD6CC940C@fernando>
References: <A7CBD78AA3564B10920613CFD6CC940C@fernando>
Message-ID: <4BE957DF.5010303@ca.afilias.info>

Fernando Aguada wrote:
> Hello
> sorry for my English !
> I'm new to Slony and wanted to know how to run the script 
> test_slony_state on windows,  is this possible?
> I appreciate any response.
> regards !
>  


I haven't tried it myself, but looking at the test_slony_state.pl script 
it looks like it will  work on windows (If perl + DBI is installed). 
For the email to work you will need some sort of windows mail command 
line utility that must exist.






> Fernando
> 
> 
> ------------------------------------------------------------------------
> 
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


-- 
Steve Singer
Afilias Canada
Data Services Developer
416-673-1142

From raagavendra.rao at gmail.com  Tue May 11 20:38:27 2010
From: raagavendra.rao at gmail.com (raghavendra t)
Date: Wed, 12 May 2010 09:08:27 +0530
Subject: [Slony1-general] --with-perltools is failing when am installing
	Slony-I-1.2.20
In-Reply-To: <1273564534.5575.21.camel@hp-laptop2.gunduz.org>
References: <AANLkTikQuHnpcpHQXFgiRg_CjSBq2AckACl3X4pKzBNI@mail.gmail.com>
	<1273557963.2190.1.camel@hp-laptop2.gunduz.org>
	<AANLkTinzgfrSdGbtiKNPfKLqW1igc6cWj-aY1cxb7u7G@mail.gmail.com>
	<1273564534.5575.21.camel@hp-laptop2.gunduz.org>
Message-ID: <AANLkTimLvWE8U8T5is62h4CrurNH35kZah6grY_Ymvph@mail.gmail.com>

Hi Devrim,

Thank you for ur timely help. It got resolved. I have installed two packages
as you have suggested.

yum install flex
yum install bison

Thanks Once again :)

Regards
Raghav

2010/5/11 Devrim G?ND?Z <devrim at gunduz.org>

> On Tue, 2010-05-11 at 12:17 +0530, raghavendra t wrote:
> > Missing yacc parser.y parser.c
>
> Please run
>
> yum -y install byacc flex perl-DBD-Pg
>
> and install necessary packages for build. Please note that you need to
> re-run configure script.
>
> BTW, there is a howto about installing Slony-I on RHEL/CentOS:
>
>
> http://people.planetpostgresql.org/devrim/index.php?/archives/38-Installing,-configuring,-running-and-administrating-Slony-I-2.0-on-Red-Hat-CentOS-using-RPMs-Part-1.html#extended
>
> Regards,
> --
> Devrim G?ND?Z
> PostgreSQL Dan??man?/Consultant, Red Hat Certified Engineer
> PostgreSQL RPM Repository: http://yum.pgrpms.org
> Community: devrim~PostgreSQL.org, devrim.gunduz~linux.org.tr
> http://www.gunduz.org  Twitter: http://twitter.com/devrimgunduz
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20100512/8b64baad/attachment.htm 

From sowjuec at gmail.com  Tue May 11 22:27:17 2010
From: sowjuec at gmail.com (sowjanya v)
Date: Wed, 12 May 2010 10:57:17 +0530
Subject: [Slony1-general] unable to create replication set for a table not
	having private key
Message-ID: <AANLkTilAlpOQetby0zYJgWKxvHWjlzzcUNuLxezJf96z@mail.gmail.com>

Hi,

I am not able create replication set for a table not having private key. Is
there anything that can be done?

-- 
Sowjanya.V
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20100512/c375d9e1/attachment.htm 

From Jayadevan.Maymala at ibsplc.com  Tue May 11 22:30:43 2010
From: Jayadevan.Maymala at ibsplc.com (Jayadevan M)
Date: Wed, 12 May 2010 11:00:43 +0530
Subject: [Slony1-general] unable to create replication set for a table
	not	having private key
In-Reply-To: <AANLkTilAlpOQetby0zYJgWKxvHWjlzzcUNuLxezJf96z@mail.gmail.com>
References: <AANLkTilAlpOQetby0zYJgWKxvHWjlzzcUNuLxezJf96z@mail.gmail.com>
Message-ID: <OF9979488F.0FB59CBC-ON65257721.001E378B-65257721.001E4BC8@ibsplc.com>

> I am not able create replication set for a table not having private key. 
Is there anything that can be done?
This is what you are looking for?
http://www.slony.info/adminguide/slony1-1.2.6/doc/adminguide/stmttableaddkey.html
Regards,
Jayadevan 





DISCLAIMER: 

"The information in this e-mail and any attachment is intended only for 
the person to whom it is addressed and may contain confidential and/or 
privileged material. If you have received this e-mail in error, kindly 
contact the sender and destroy all copies of the original communication. 
IBS makes no warranty, express or implied, nor guarantees the accuracy, 
adequacy or completeness of the information contained in this email or any 
attachment and is not liable for any errors, defects, omissions, viruses 
or for resultant loss or damage, if any, direct or indirect."




-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20100512/441b9eba/attachment.htm 

From ssinger_pg at sympatico.ca  Wed May 12 04:52:56 2010
From: ssinger_pg at sympatico.ca (Steve Singer)
Date: Wed, 12 May 2010 07:52:56 -0400 (EDT)
Subject: [Slony1-general] unable to create replication set for a table
 not having private key
In-Reply-To: <AANLkTilAlpOQetby0zYJgWKxvHWjlzzcUNuLxezJf96z@mail.gmail.com>
References: <AANLkTilAlpOQetby0zYJgWKxvHWjlzzcUNuLxezJf96z@mail.gmail.com>
Message-ID: <BLU0-SMTP165C9F1E09C51E860B8FC6ACFB0@phx.gbl>

On Wed, 12 May 2010, sowjanya v wrote:

> Hi,
>
> I am not able create replication set for a table not having private key. Is
> there anything that can be done?

If by 'private key' you mean 'primary key' then what you need to do is add a 
primary key to your table.  It can be a serial datatype that isn't used by 
the rest of your application (if you want) but the table must have a primary 
key.



>
> -- 
> Sowjanya.V
>


From venkatraju at gmail.com  Wed May 12 06:19:00 2010
From: venkatraju at gmail.com (Venkatraju)
Date: Wed, 12 May 2010 18:49:00 +0530
Subject: [Slony1-general] Replication subscriber setup failure
Message-ID: <AANLkTimIjHgKQPEzgP8dzLJuaji1bDdu8LJqYHlXn9fj@mail.gmail.com>

Hi,

I am trying to setup a 2 node Slony cluster on PostgreSQL 8.4.1 using
Slony 1.2.20 on CentOS 5.4. Setting up subscriber was stuck and timed
out during the COPY process.

2010-05-10 15:41:42 PDT [24765] DEBUG2 remoteWorkerThread_1:  nodeon73 is 0
NOTICE:  truncate of "public"."table1" succeeded
2010-05-10 15:41:42 PDT [24765] DEBUG2 remoteWorkerThread_1: 96 bytes
copied for table "public"."table1"
2010-05-10 15:41:42 PDT [24765] DEBUG2 remoteWorkerThread_1: 0.290
seconds to copy table "public"."table1"
2010-05-10 15:41:42 PDT [24765] DEBUG2 remoteWorkerThread_1: copy
table "public"."table2"
2010-05-10 15:41:42 PDT [24765] DEBUG3 remoteWorkerThread_1: table
"public"."table2" does not require Slony-I serial key
2010-05-10 15:41:42 PDT [24765] DEBUG2 remoteWorkerThread_1: Begin
COPY of table "public"."table2"
2010-05-10 15:41:42 PDT [24765] DEBUG2 remoteWorkerThread_1:  nodeon73 is 0
NOTICE:  truncate of "public"."table2" failed - doing delete
2010-05-10 15:41:48 PDT [24765] DEBUG2 localListenThread: Received
event 2,2 SYNC
2010-05-10 15:42:09 PDT [24765] DEBUG2 remoteListenThread_1: LISTEN
2010-05-10 15:42:11 PDT [24765] DEBUG2 remoteListenThread_1: queue
event 1,7633 SYNC
2010-05-10 15:42:11 PDT [24765] DEBUG2 remoteListenThread_1: UNLISTEN

It is almost as if it is stuck copying table2 which has just one row
of data. Replication setup was aborted since there was no progress for
10 minutes.

Not sure if this is related, but the only log line in Postgres logs at
about the same time is:
2010-05-10 15:41:14 PDT superuser mydb 24720 4be88b8a.6090
19000WARNING:  type attribute "externallength" not recognized

PostgreSQL logs when the replication setup was aborted:
2010-05-10 15:51:25 PDT superuser mydb 24774 4be88b8e.60c6 19009ERROR:
 unexpected EOF on client connection
2010-05-10 15:51:25 PDT superuser mydb 24774 4be88b8e.60c6
19009CONTEXT:  COPY table2, line 1
2010-05-10 15:51:25 PDT superuser mydb 24774 4be88b8e.60c6
19009STATEMENT:  select "_mycluster".prepareTableForCopy(72); copy
"public"."table2" ("id","name","title","logo","org_id") from stdin;
2010-05-10 15:51:25 PDT superuser mydb 24774 4be88b8e.60c6 19009LOG:
could not send data to client: Broken pipe

Looks like it was stuck in prepareTableForCopy function. Replication
setup succeeded when the operation was repeated. Has anyone seen this
before? Any ideas about what could cause this?

Regards,
Venkat

From JanWieck at Yahoo.com  Wed May 12 06:42:28 2010
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Wed, 12 May 2010 09:42:28 -0400
Subject: [Slony1-general] unable to create replication set for a table
 not	having private key
In-Reply-To: <OF9979488F.0FB59CBC-ON65257721.001E378B-65257721.001E4BC8@ibsplc.com>
References: <AANLkTilAlpOQetby0zYJgWKxvHWjlzzcUNuLxezJf96z@mail.gmail.com>
	<OF9979488F.0FB59CBC-ON65257721.001E378B-65257721.001E4BC8@ibsplc.com>
Message-ID: <4BEAB044.8050701@Yahoo.com>

On 5/12/2010 1:30 AM, Jayadevan M wrote:
>  > I am not able create replication set for a table not having private 
> key. Is there anything that can be done?
> This is what you are looking for?
> http://www.slony.info/adminguide/slony1-1.2.6/doc/adminguide/stmttableaddkey.html 
> 
> Regards,
> Jayadevan

This is certainly not what he is looking for.

This command is  no longer supported  as of Slony-I version 2.0. In 
version 2, the various "catalogue breakages" done in PostgreSQL versions 
prior to 8.3 are being eliminated so that schema dumps may be taken from 
any node. That leaves the "kludgy"  columns created via TABLE ADD KEY as 
the only thing that prevents SLONIK UNINSTALL NODE from being comprised 
of the SQL statement drop schema _ClusterName cascade;.


Jan

-- 
Anyone who trades liberty for security deserves neither
liberty nor security. -- Benjamin Franklin

From singh.gurjeet at gmail.com  Wed May 12 07:31:06 2010
From: singh.gurjeet at gmail.com (Gurjeet Singh)
Date: Wed, 12 May 2010 10:31:06 -0400
Subject: [Slony1-general] An old event not confirmed: A possible bug?
Message-ID: <AANLkTikflK7G1bHIJjQLynJ-VZIwhAvAWazUNqyFQm5i@mail.gmail.com>

Hi All,

    I have two Slony test beds which show the exact same symptoms!

select * from sl_event order by ev_seqno;

 ev_origin |  ev_seqno  |        ev_timestamp        |
ev_snapshot         | ev_type |
-----------+------------+----------------------------+----------------------------+---------+-
         2 | 5000000002 | 2010-04-30 08:32:38.622928 |
458:458:                   | SYNC    |
         1 | 5000525721 | 2010-05-12 13:30:22.79626  |
72685915:72685915:         | SYNC    |
         1 | 5000525722 | 2010-05-12 13:30:24.800943 |
72686139:72686139:         | SYNC    |
         1 | 5000525723 | 2010-05-12 13:30:26.804862 |
72686224:72686224:         | SYNC    |
...

The reason I think this _might_ be a bug is that on both clusters, slave
node's sl_event has the exact same record for ev_seqno=5000000002 except for
the timestamp; same origin, and same snapshot!

The head of sl_confirm has:

 select * from sl_confirm order by con_seqno;

 con_origin | con_received | con_seqno  |       con_timestamp
------------+--------------+------------+----------------------------
          2 |            1 | 5000000002 | 2010-04-30 08:32:53.974021
          1 |            2 | 5000527075 | 2010-05-12 14:15:41.192279
          1 |            2 | 5000527076 | 2010-05-12 14:15:43.193607
          1 |            2 | 5000527077 | 2010-05-12 14:15:45.196291
          1 |            2 | 5000527078 | 2010-05-12 14:15:47.197005
...

Can someone comment on the health of the cluster? All events, except for
that on, are being confirmed and purged from the system regularly, so my
assumption is that the cluster is healthy and that the slave is in sync with
the master.

Thanks in advance.
-- 
gurjeet.singh
@ EnterpriseDB - The Enterprise Postgres Company
http://www.enterprisedb.com

singh.gurjeet@{ gmail | yahoo }.com
Twitter/Skype: singh_gurjeet

Mail sent from my BlackLaptop device
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20100512/38abcc81/attachment-0001.htm 

From JanWieck at Yahoo.com  Wed May 12 07:56:04 2010
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Wed, 12 May 2010 10:56:04 -0400
Subject: [Slony1-general] An old event not confirmed: A possible bug?
In-Reply-To: <AANLkTikflK7G1bHIJjQLynJ-VZIwhAvAWazUNqyFQm5i@mail.gmail.com>
References: <AANLkTikflK7G1bHIJjQLynJ-VZIwhAvAWazUNqyFQm5i@mail.gmail.com>
Message-ID: <4BEAC184.1000702@Yahoo.com>

On 5/12/2010 10:31 AM, Gurjeet Singh wrote:
> Hi All,
> 
>     I have two Slony test beds which show the exact same symptoms!
> 
> select * from sl_event order by ev_seqno;
> 
>  ev_origin |  ev_seqno  |        ev_timestamp        |        
> ev_snapshot         | ev_type |
> -----------+------------+----------------------------+----------------------------+---------+-
>          2 | 5000000002 | 2010-04-30 08:32:38.622928 | 
> 458:458:                   | SYNC    |
>          1 | 5000525721 | 2010-05-12 13:30:22.79626  | 
> 72685915:72685915:         | SYNC    |
>          1 | 5000525722 | 2010-05-12 13:30:24.800943 | 
> 72686139:72686139:         | SYNC    |
>          1 | 5000525723 | 2010-05-12 13:30:26.804862 | 
> 72686224:72686224:         | SYNC    |
> ...
> 

Slony always keeps at least the last event per origin around. Otherwise 
the view sl_status would not work.

What should worry you is that there are no newer SYNC events from node 2 
available. Slony does create a sporadic SYNC every now and then even if 
there is no activity or the node isn't an origin anyway.

Is it possible that node 2's clock is way off?


Jan

> The reason I think this _might_ be a bug is that on both clusters, slave 
> node's sl_event has the exact same record for ev_seqno=5000000002 except 
> for the timestamp; same origin, and same snapshot!
> 
> The head of sl_confirm has:
> 
>  select * from sl_confirm order by con_seqno;
> 
>  con_origin | con_received | con_seqno  |       con_timestamp
> ------------+--------------+------------+----------------------------
>           2 |            1 | 5000000002 | 2010-04-30 08:32:53.974021
>           1 |            2 | 5000527075 | 2010-05-12 14:15:41.192279
>           1 |            2 | 5000527076 | 2010-05-12 14:15:43.193607
>           1 |            2 | 5000527077 | 2010-05-12 14:15:45.196291
>           1 |            2 | 5000527078 | 2010-05-12 14:15:47.197005
> ...
> 
> Can someone comment on the health of the cluster? All events, except for 
> that on, are being confirmed and purged from the system regularly, so my 
> assumption is that the cluster is healthy and that the slave is in sync 
> with the master.
> 
> Thanks in advance.
> -- 
> gurjeet.singh
> @ EnterpriseDB - The Enterprise Postgres Company
> http://www.enterprisedb.com
> 
> singh.gurjeet@{ gmail | yahoo }.com
> Twitter/Skype: singh_gurjeet
> 
> Mail sent from my BlackLaptop device
> 
> 
> ------------------------------------------------------------------------
> 
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


-- 
Anyone who trades liberty for security deserves neither
liberty nor security. -- Benjamin Franklin

From cbbrowne at ca.afilias.info  Wed May 12 09:10:08 2010
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Wed, 12 May 2010 12:10:08 -0400
Subject: [Slony1-general] unable to create replication set for a table
	not having private key
In-Reply-To: <AANLkTilAlpOQetby0zYJgWKxvHWjlzzcUNuLxezJf96z@mail.gmail.com>
	(sowjanya v.'s message of "Wed, 12 May 2010 10:57:17 +0530")
References: <AANLkTilAlpOQetby0zYJgWKxvHWjlzzcUNuLxezJf96z@mail.gmail.com>
Message-ID: <87k4r9ayov.fsf@ca.afilias.info>

sowjanya v <sowjuec at gmail.com> writes:
> I am not able create replication set for a table not having private key. Is
> there anything that can be done?

Yes, you can replicate it once you add a primary key to the table.

Ideally it should be well and truly a primary key:

  alter table my_table add primary key(some_column);

It is quite acceptable for it to be a candidate primary key (e.g. - a
unique index defined on columns defined as NOT NULL).

If you haven't got any of the above, then you cannot replicate the
table.

Period.

As mentioned elsewhere in the thread, there used to be a "TABLE ADD KEY"
command in Slony-I, but that is widely considered a misfeature, and has
therefore been removed from modern versions.
-- 
output = ("cbbrowne" "@" "ca.afilias.info")
Christopher Browne
"Bother,"  said Pooh,  "Eeyore, ready  two photon  torpedoes  and lock
phasers on the Heffalump, Piglet, meet me in transporter room three"

From singh.gurjeet at gmail.com  Wed May 12 09:44:52 2010
From: singh.gurjeet at gmail.com (Gurjeet Singh)
Date: Wed, 12 May 2010 12:44:52 -0400
Subject: [Slony1-general] An old event not confirmed: A possible bug?
In-Reply-To: <4BEAC184.1000702@Yahoo.com>
References: <AANLkTikflK7G1bHIJjQLynJ-VZIwhAvAWazUNqyFQm5i@mail.gmail.com> 
	<4BEAC184.1000702@Yahoo.com>
Message-ID: <AANLkTinH3vK-4jAEWMaXvROXkJ0ThTQCBxmRzmxvfjco@mail.gmail.com>

On Wed, May 12, 2010 at 10:56 AM, Jan Wieck <JanWieck at yahoo.com> wrote:

> On 5/12/2010 10:31 AM, Gurjeet Singh wrote:
>
>> Hi All,
>>
>>    I have two Slony test beds which show the exact same symptoms!
>>
>> select * from sl_event order by ev_seqno;
>>
>>  ev_origin |  ev_seqno  |        ev_timestamp        |        ev_snapshot
>>         | ev_type |
>>
>> -----------+------------+----------------------------+----------------------------+---------+-
>>         2 | 5000000002 | 2010-04-30 08:32:38.622928 | 458:458:
>>       | SYNC    |
>>         1 | 5000525721 | 2010-05-12 13:30:22.79626  | 72685915:72685915:
>>       | SYNC    |
>>         1 | 5000525722 | 2010-05-12 13:30:24.800943 | 72686139:72686139:
>>       | SYNC    |
>>         1 | 5000525723 | 2010-05-12 13:30:26.804862 | 72686224:72686224:
>>       | SYNC    |
>> ...
>>
>>
> Slony always keeps at least the last event per origin around. Otherwise the
> view sl_status would not work.
>
> What should worry you is that there are no newer SYNC events from node 2
> available. Slony does create a sporadic SYNC every now and then even if
> there is no activity or the node isn't an origin anyway.
>
> Is it possible that node 2's clock is way off?
>

# ssh root at 10.32.169.215 date; ssh root at 10.32.169.216 date
Wed May 12 16:38:20 UTC 2010
Wed May 12 16:38:20 UTC 2010

Above the difference of times on the two nodes; 215 has the origin and 216
has the subscriber. They seem to be perfectly in sync.

I think I forgot to paste the test_slony_state.pl output before. This is
waht raised the concern
<snip>
Node: 2 Confirmations not propagating from 2 to 1
================================================
Confirmations not propagating quickly in sl_confirm -

For origin node 2, receiver node 1, earliest propagated
confirmation has age 12 days > 00:30:00

Are slons running for both nodes?

Could listen paths be missing so that confirmations are not propagating?


Node: 2 Events not propagating to node 2
================================================
Events not propagating quickly in sl_event -
For origin node 2, earliest propagated event of age 12 days 00:01:00 >
00:30:00

Are slons running for both nodes?

Could listen paths be missing so that events are not propagating?
</snip>

And the path and listen configs:

system.db=# select * from sl_path;
 pa_server | pa_client |                    pa_conninfo                    |
pa_connretry
-----------+-----------+---------------------------------------------------+--------------
         2 |         1 | dbname=system.db host=10.32.169.216 user=postgres
|           10
         1 |         2 | dbname=system.db host=10.32.169.215 user=postgres
|           10
(2 rows)
system.db=# select * from sl_listen ;
 li_origin | li_provider | li_receiver
-----------+-------------+-------------
         2 |           2 |           1
         1 |           1 |           2
(2 rows)


Thanks and best regards,


>
>
> Jan
>
>  The reason I think this _might_ be a bug is that on both clusters, slave
>> node's sl_event has the exact same record for ev_seqno=5000000002 except for
>> the timestamp; same origin, and same snapshot!
>>
>> The head of sl_confirm has:
>>
>>  select * from sl_confirm order by con_seqno;
>>
>>  con_origin | con_received | con_seqno  |       con_timestamp
>> ------------+--------------+------------+----------------------------
>>          2 |            1 | 5000000002 | 2010-04-30 08:32:53.974021
>>          1 |            2 | 5000527075 | 2010-05-12 14:15:41.192279
>>          1 |            2 | 5000527076 | 2010-05-12 14:15:43.193607
>>          1 |            2 | 5000527077 | 2010-05-12 14:15:45.196291
>>          1 |            2 | 5000527078 | 2010-05-12 14:15:47.197005
>> ...
>>
>> Can someone comment on the health of the cluster? All events, except for
>> that on, are being confirmed and purged from the system regularly, so my
>> assumption is that the cluster is healthy and that the slave is in sync with
>> the master.
>>
>> Thanks in advance.
>> --
>> gurjeet.singh
>> @ EnterpriseDB - The Enterprise Postgres Company
>> http://www.enterprisedb.com
>>
>> singh.gurjeet@{ gmail | yahoo }.com
>> Twitter/Skype: singh_gurjeet
>>
>> Mail sent from my BlackLaptop device
>>
>>
>> ------------------------------------------------------------------------
>>
>> _______________________________________________
>> Slony1-general mailing list
>> Slony1-general at lists.slony.info
>> http://lists.slony.info/mailman/listinfo/slony1-general
>>
>
>
> --
> Anyone who trades liberty for security deserves neither
> liberty nor security. -- Benjamin Franklin
>



-- 
gurjeet.singh
@ EnterpriseDB - The Enterprise Postgres Company
http://www.enterprisedb.com

singh.gurjeet@{ gmail | yahoo }.com
Twitter/Skype: singh_gurjeet

Mail sent from my BlackLaptop device
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20100512/ba6812db/attachment.htm 

From fernandoaguada at gmail.com  Wed May 12 09:51:58 2010
From: fernandoaguada at gmail.com (Fernando Aguada)
Date: Wed, 12 May 2010 13:51:58 -0300
Subject: [Slony1-general] how run  test_slony_state on windows
References: <A7CBD78AA3564B10920613CFD6CC940C@fernando>
	<4BE957DF.5010303@ca.afilias.info>
Message-ID: <4CB533397520478F874BE0CFB737C543@fernando>

thank you Steve, very thankful !
regards

Fernando
----- Original Message ----- 
From: "Steve Singer" <ssinger at ca.afilias.info>
To: "Fernando Aguada" <fernandoaguada at gmail.com>
Cc: "Lista Slony" <slony1-general at lists.slony.info>
Sent: Tuesday, May 11, 2010 10:13 AM
Subject: Re: [Slony1-general] how run test_slony_state on windows


> Fernando Aguada wrote:
>> Hello
>> sorry for my English !
>> I'm new to Slony and wanted to know how to run the script 
>> test_slony_state on windows,  is this possible?
>> I appreciate any response.
>> regards !
>>  
> 
> 
> I haven't tried it myself, but looking at the test_slony_state.pl script 
> it looks like it will  work on windows (If perl + DBI is installed). 
> For the email to work you will need some sort of windows mail command 
> line utility that must exist.
> 
> 
> 
> 
> 
> 
>> Fernando
>> 
>> 
>> ------------------------------------------------------------------------
>> 
>> _______________________________________________
>> Slony1-general mailing list
>> Slony1-general at lists.slony.info
>> http://lists.slony.info/mailman/listinfo/slony1-general
> 
> 
> -- 
> Steve Singer
> Afilias Canada
> Data Services Developer
> 416-673-1142

From bench at silentmedia.com  Wed May 12 10:22:52 2010
From: bench at silentmedia.com (Ben Chobot)
Date: Wed, 12 May 2010 10:22:52 -0700
Subject: [Slony1-general] (re)shaping a cluster
Message-ID: <CCB6BE77-6DB6-4C35-97E3-A853A973091D@silentmedia.com>

I currently have 5 nodes in my slony 1.2 cluster: A, B, C, D, and E. Nodes A and B take turns being the origin. Node C will always be a subscriber but is also a provider to nodes D and E, which have subscribed to their set with forward=no. (All other nodes have subscribed with forward=yes.) So:

(A or B) provides to C provides to (D and E)

I have two intertwined questions about this configuration. The first is, how do I reshape when C dies? I assume I should just tell D and E to receive from A or B.....

...but (and this is the second question) D and E have subscribed with forward=no, and I've heard that you don't want something with forward=no talking to a node which might be become the origin. So should I just subscribe D and E with forward=yes, even though they'll never forward their data on?


As a third question, I'm becoming a bit concerned about the number of nodes in my cluster, especially because I want to add a third node that might become the origin and also a third node that feeds from C in the common case. Do D and E need paths between their current provider only, or do they need to be in constant talk with all of their potential providers?

From ssinger at ca.afilias.info  Wed May 12 14:33:30 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Wed, 12 May 2010 17:33:30 -0400
Subject: [Slony1-general] Replication subscriber setup failure
In-Reply-To: <AANLkTimIjHgKQPEzgP8dzLJuaji1bDdu8LJqYHlXn9fj@mail.gmail.com>
References: <AANLkTimIjHgKQPEzgP8dzLJuaji1bDdu8LJqYHlXn9fj@mail.gmail.com>
Message-ID: <4BEB1EAA.9060502@ca.afilias.info>

Venkatraju wrote:
> Hi,
> 
> I am trying to setup a 2 node Slony cluster on PostgreSQL 8.4.1 using
> Slony 1.2.20 on CentOS 5.4. Setting up subscriber was stuck and timed
> out during the COPY process.

Is anything holding locks on your table2?
Do you have any long running transactions?


> 
> 2010-05-10 15:41:42 PDT [24765] DEBUG2 remoteWorkerThread_1:  nodeon73 is 0
> NOTICE:  truncate of "public"."table1" succeeded
> 2010-05-10 15:41:42 PDT [24765] DEBUG2 remoteWorkerThread_1: 96 bytes
> copied for table "public"."table1"
> 2010-05-10 15:41:42 PDT [24765] DEBUG2 remoteWorkerThread_1: 0.290
> seconds to copy table "public"."table1"
> 2010-05-10 15:41:42 PDT [24765] DEBUG2 remoteWorkerThread_1: copy
> table "public"."table2"
> 2010-05-10 15:41:42 PDT [24765] DEBUG3 remoteWorkerThread_1: table
> "public"."table2" does not require Slony-I serial key
> 2010-05-10 15:41:42 PDT [24765] DEBUG2 remoteWorkerThread_1: Begin
> COPY of table "public"."table2"
> 2010-05-10 15:41:42 PDT [24765] DEBUG2 remoteWorkerThread_1:  nodeon73 is 0
> NOTICE:  truncate of "public"."table2" failed - doing delete
> 2010-05-10 15:41:48 PDT [24765] DEBUG2 localListenThread: Received
> event 2,2 SYNC
> 2010-05-10 15:42:09 PDT [24765] DEBUG2 remoteListenThread_1: LISTEN
> 2010-05-10 15:42:11 PDT [24765] DEBUG2 remoteListenThread_1: queue
> event 1,7633 SYNC
> 2010-05-10 15:42:11 PDT [24765] DEBUG2 remoteListenThread_1: UNLISTEN
> 
> It is almost as if it is stuck copying table2 which has just one row
> of data. Replication setup was aborted since there was no progress for
> 10 minutes.
> 
> Not sure if this is related, but the only log line in Postgres logs at
> about the same time is:
> 2010-05-10 15:41:14 PDT superuser mydb 24720 4be88b8a.6090
> 19000WARNING:  type attribute "externallength" not recognized
> 
> PostgreSQL logs when the replication setup was aborted:
> 2010-05-10 15:51:25 PDT superuser mydb 24774 4be88b8e.60c6 19009ERROR:
>  unexpected EOF on client connection
> 2010-05-10 15:51:25 PDT superuser mydb 24774 4be88b8e.60c6
> 19009CONTEXT:  COPY table2, line 1
> 2010-05-10 15:51:25 PDT superuser mydb 24774 4be88b8e.60c6
> 19009STATEMENT:  select "_mycluster".prepareTableForCopy(72); copy
> "public"."table2" ("id","name","title","logo","org_id") from stdin;
> 2010-05-10 15:51:25 PDT superuser mydb 24774 4be88b8e.60c6 19009LOG:
> could not send data to client: Broken pipe
> 
> Looks like it was stuck in prepareTableForCopy function. Replication
> setup succeeded when the operation was repeated. Has anyone seen this
> before? Any ideas about what could cause this?
> 
> Regards,
> Venkat
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


-- 
Steve Singer
Afilias Canada
Data Services Developer
416-673-1142

From jaime at 2ndquadrant.com  Wed May 12 19:18:35 2010
From: jaime at 2ndquadrant.com (Jaime Casanova)
Date: Wed, 12 May 2010 21:18:35 -0500
Subject: [Slony1-general] [slony-general] changing ip of a node
Message-ID: <AANLkTik5Ym7fTXPj8Kah04WTkpRCRV4FsJnNEoXEA9Kb@mail.gmail.com>

Hi,

Is it possible to add a node with certain ip (ej: 10.1.0.1) and then
move it to another network with other ip (ej: 10.1.1.1)?
i guess it's simply a matter of fixing the ip in the sl_path, no?

-- 
Jaime Casanova         www.2ndQuadrant.com
Soporte y capacitaci?n de PostgreSQL

From ssinger_pg at sympatico.ca  Wed May 12 20:00:51 2010
From: ssinger_pg at sympatico.ca (Steve Singer)
Date: Wed, 12 May 2010 23:00:51 -0400 (EDT)
Subject: [Slony1-general] [slony-general] changing ip of a node
In-Reply-To: <AANLkTik5Ym7fTXPj8Kah04WTkpRCRV4FsJnNEoXEA9Kb@mail.gmail.com>
References: <AANLkTik5Ym7fTXPj8Kah04WTkpRCRV4FsJnNEoXEA9Kb@mail.gmail.com>
Message-ID: <BLU0-SMTP9040C1BDE720BD939E6F06ACFC0@phx.gbl>

On Wed, 12 May 2010, Jaime Casanova wrote:

> Hi,
>
> Is it possible to add a node with certain ip (ej: 10.1.0.1) and then
> move it to another network with other ip (ej: 10.1.1.1)?
> i guess it's simply a matter of fixing the ip in the sl_path, no?

Yes, if you issue a new 'store path' command with the new IP and the restart 
the relevant slons it should start using the new ip address.



>
> -- 
> Jaime Casanova         www.2ndQuadrant.com
> Soporte y capacitaci?n de PostgreSQL
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
>

From JanWieck at Yahoo.com  Wed May 12 22:15:14 2010
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Thu, 13 May 2010 01:15:14 -0400
Subject: [Slony1-general] [slony-general] changing ip of a node
In-Reply-To: <BLU0-SMTP9040C1BDE720BD939E6F06ACFC0@phx.gbl>
References: <AANLkTik5Ym7fTXPj8Kah04WTkpRCRV4FsJnNEoXEA9Kb@mail.gmail.com>
	<BLU0-SMTP9040C1BDE720BD939E6F06ACFC0@phx.gbl>
Message-ID: <4BEB8AE2.6000008@Yahoo.com>

On 5/12/2010 11:00 PM, Steve Singer wrote:
> On Wed, 12 May 2010, Jaime Casanova wrote:
> 
>> Hi,
>>
>> Is it possible to add a node with certain ip (ej: 10.1.0.1) and then
>> move it to another network with other ip (ej: 10.1.1.1)?
>> i guess it's simply a matter of fixing the ip in the sl_path, no?
> 
> Yes, if you issue a new 'store path' command with the new IP and the restart 
> the relevant slons it should start using the new ip address.

Well, unless he split the historical Class-A ARPA-net into smaller bits 
and pieces (sub nets) for his own, personal abuse, 10.1.0.1 and 10.1.1.1 
are still inside the same network.

But I guess he did and you are right.


Jan

-- 
Anyone who trades liberty for security deserves neither
liberty nor security. -- Benjamin Franklin

From ssinger at ca.afilias.info  Fri May 14 13:53:21 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Fri, 14 May 2010 16:53:21 -0400
Subject: [Slony1-general] Drop Node command works,
	but leaves crumbs behind.
In-Reply-To: <4BE8839D.8070708@consistentstate.com>
References: <4BE8839D.8070708@consistentstate.com>
Message-ID: <4BEDB841.7030801@ca.afilias.info>

Brian Fehrle wrote:
> Hi all,
> 

> 
> So the problem is after I drop a node, everything looks great except for 
> the _slony.sl_status table, in any or all the remaining nodes, still 
> refers to the node that was just dropped.

sl_status is a view not a table.
The view definition involves sl_event and sl_confirm.

The dropNode_int function should be deleting everything involving the 
dropped node from both tables.

So my question would be is the sequence number of the event for your 
dropped table less than the sequence number of your DROP NODE command or 
is it greater than?  I can't tell this from what you've sent.


(I am wondering if these is some sort of race condition where the 
dropNode_int() function deletes the rows from sl_event but a new event 
gets added after?, though looking at the code I don't see any obvious 
issues)


> 
> I did quite a few test runs of the drop node to try to reproduce and 
> determine the cause. After the drop node, if I look in sl_node, sl_path, 
> sl_event, or any other sl_ location, I see no reference to the third 
> node. However, about half the time I would still get references to the 
> third node in sl_status. This can either be on the master node, or the 
> (remaining) slave node, or both. There was one test scenario that I 
> monitored the sl_status table and noticed that node 3 disappeared, then 
> reappeared a second later, then remained.
> 
> Example queries done on node 2 (slave) after dropping node 3 (other slave):
> 
> postgres=# select * from _slony.sl_node;
>  no_id | no_active | no_comment | no_spool
> -------+-----------+------------+----------
>      1 | t         | Server 1   | f
>      2 | t         | Server 2   | f
> (2 rows)
> 
> postgres=# select * from _slony.sl_path ;
>  pa_server | pa_client |                        
> pa_conninfo                         | pa_connretry
> -----------+-----------+------------------------------------------------------------+--------------
>          1 |         2 | dbname=postgres host=172.16.44.111 port=5432 
> user=postgres |           10
>          2 |         1 | dbname=postgres host=172.16.44.129 port=5432 
> user=postgres |           10
> (2 rows)
> 
> postgres=# select * from _slony.sl_status;
>  st_origin | st_received | st_last_event |      st_last_event_ts      | 
> st_last_received |    st_last_received_ts     | 
> st_last_received_event_ts  | st_lag_num_events |   st_lag_time
> -----------+-------------+---------------+----------------------------+------------------+----------------------------+----------------------------+-------------------+-----------------
>          2 |           1 |          1649 | 2010-05-10 15:53:16.245529 
> |             1649 | 2010-05-10 15:53:16.246212 | 2010-05-10 
> 15:53:16.245529 |                 0 | 00:00:05.57205
>          2 |           3 |          1656 | 2010-05-10 15:54:26.280131 
> |             1636 | 2010-05-10 15:51:05.341512 | 2010-05-10 
> 15:51:05.343754 |                20 | 00:03:22.66664
> 
> 
> Also, another problem that may be linked is the fact that the slon 
> daemon for node 3 does not terminate itself after it. Watching the log 
> output by that daemon, it shows that it recieves the drop node command 
> for itself, and it drops the _slony schema as intended. However after 
> that it reports "2010-05-10 15:57:56 MDT FATAL  main: Node is not 
> initialized properly - sleep 10s" and keeps checking every ten seconds. 
> I'm not sure if somehow this daemon is causing some post-drop-node 
> entries into the sl_event section that causes the sl_status entry to be 
> recreated.
> 
> In case it helps, here is a copy of the drop node script I'm running.
> 
> #!/bin/bash
> slonik <<_EOF_
> cluster name = slony;
> node 1 admin conninfo = ' dbname=postgres host=172.16.44.111 port=5432 
> user=postgres';
> node 2 admin conninfo = ' dbname=postgres host=172.16.44.129 port=5432 
> user=postgres';
> node 3 admin conninfo = ' dbname=postgres host=172.16.44.142 port=5432 
> user=postgres';
> DROP NODE ( ID = 3, EVENT NODE = 1 );
> _EOF_
> 
> I am running on a CentOS 5, postgres 8.4.2, and slony 1.2.20 environment 
> on all three nodes.
> 
> Thanks in advance,
>     Brian Fehrle
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


-- 
Steve Singer
Afilias Canada
Data Services Developer
416-673-1142

From singh.gurjeet at gmail.com  Sun May 16 05:22:38 2010
From: singh.gurjeet at gmail.com (Gurjeet Singh)
Date: Sun, 16 May 2010 08:22:38 -0400
Subject: [Slony1-general] Slony triggers included in pg_dump
Message-ID: <AANLkTik3kuhrTf7xiy5ylZi-N4AprDvtBP831Il6oxhS@mail.gmail.com>

Hi All,

    The docs here http://www.slony.info/documentation/triggers.html says
that post Postgres 8.3 version

<snip>

   - If you take a pg_dump of a Slony-I node, and drop out the
Slony-Inamespace, this now cleanly removes
   *all* Slony-I components, leaving the database, *including its schema,*in a
   "pristine", consistent fashion, ready for whatever use may be desired.

</snip>

But I see that when dumping a schema containing tables monitored by Slony,
the dump still shows the log triggers on those tables.

postgres=# select version();

version
----------------------------------------------------------------------------------------------------
 PostgreSQL 8.3.10 on i686-pc-linux-gnu, compiled by GCC gcc (GCC) 4.3.2
20081105 (Red Hat 4.3.2-7)

# pg_dump --schema-only --schema pgbench -p 5433 -U postgres | grep "CREATE
TRIGGER"
CREATE TRIGGER _pgbench_logtrigger_1
CREATE TRIGGER _pgbench_logtrigger_2
CREATE TRIGGER _pgbench_logtrigger_3

So is that statement in the docs incorrect, or is this a regression?

Best regards,
-- 
gurjeet.singh
@ EnterpriseDB - The Enterprise Postgres Company
http://www.enterprisedb.com

singh.gurjeet@{ gmail | yahoo }.com
Twitter/Skype: singh_gurjeet

Mail sent from my BlackLaptop device
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20100516/fabd4530/attachment.htm 

From ssinger at ca.afilias.info  Sun May 16 07:36:06 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Sun, 16 May 2010 10:36:06 -0400
Subject: [Slony1-general] Slony triggers included in pg_dump
In-Reply-To: <AANLkTik3kuhrTf7xiy5ylZi-N4AprDvtBP831Il6oxhS@mail.gmail.com>
References: <AANLkTik3kuhrTf7xiy5ylZi-N4AprDvtBP831Il6oxhS@mail.gmail.com>
Message-ID: <4BF002D6.3030805@ca.afilias.info>

Gurjeet Singh wrote:
> Hi All,
> 
>     The docs here http://www.slony.info/documentation/triggers.html says 
> that post Postgres 8.3 version
> 
> <snip>
> 
>     * If you take a pg_dump of a Slony-I node, and drop out the Slony-I
>       namespace, this now cleanly removes /all/ Slony-I components,
>       leaving the database, /including its schema,/ in a "pristine",
>       consistent fashion, ready for whatever use may be desired. 
> 
> </snip>
> 
> But I see that when dumping a schema containing tables monitored by 
> Slony, the dump still shows the log triggers on those tables.

When it says 'drop out' it means use the 'DROP SCHEMA' postgresql 
command to drop out the slony schema this will remove your triggers. 
This only works with Slony1 2.0.0 or above (You were probably reading 
the 2.0.3 documentation on the website).    This is the same procedure 
you need to use against a master with 1.2 (but with 2.0 it works against 
both slaves and masters).

In 1.2.x slony munges the catalog on the slaves and dropping the slony 
schema from a slave will leave your leave in a bad state.

If your planning on using Slony 2.0.x you are better off with the tip of 
REL_2_0_STABLE from cvs versus 2.0.3 due to the 'invalid utf8' bug fixed 
a few weeks ago.

Does the attached documentation patch make that paragraph more clear?



> -- 
> gurjeet.singh
> @ EnterpriseDB - The Enterprise Postgres Company
> http://www.enterprisedb.com
> 
> singh.gurjeet@{ gmail | yahoo }.com
> Twitter/Skype: singh_gurjeet
> 
> Mail sent from my BlackLaptop device

-- 
Steve Singer
Afilias Canada
Data Services Developer
416-673-1142
-------------- next part --------------
A non-text attachment was scrubbed...
Name: trigger.diff
Type: text/x-patch
Size: 827 bytes
Desc: not available
Url : http://lists.slony.info/pipermail/slony1-general/attachments/20100516/f791713a/attachment.bin 

From singh.gurjeet at gmail.com  Mon May 17 10:58:14 2010
From: singh.gurjeet at gmail.com (Gurjeet Singh)
Date: Mon, 17 May 2010 13:58:14 -0400
Subject: [Slony1-general] Slony triggers included in pg_dump
In-Reply-To: <4BF002D6.3030805@ca.afilias.info>
References: <AANLkTik3kuhrTf7xiy5ylZi-N4AprDvtBP831Il6oxhS@mail.gmail.com> 
	<4BF002D6.3030805@ca.afilias.info>
Message-ID: <AANLkTilq9QncnLfnHKwS3YEr3sELyzEHHTMFZrHqdN6b@mail.gmail.com>

On Sun, May 16, 2010 at 10:36 AM, Steve Singer <ssinger at ca.afilias.info>wrote:

> Gurjeet Singh wrote:
>
>> Hi All,
>>
>>    The docs here http://www.slony.info/documentation/triggers.html says
>> that post Postgres 8.3 version
>>
>> <snip>
>>
>>    * If you take a pg_dump of a Slony-I node, and drop out the Slony-I
>>      namespace, this now cleanly removes /all/ Slony-I components,
>>      leaving the database, /including its schema,/ in a "pristine",
>>      consistent fashion, ready for whatever use may be desired.
>> </snip>
>>
>> But I see that when dumping a schema containing tables monitored by Slony,
>> the dump still shows the log triggers on those tables.
>>
>
> When it says 'drop out' it means use the 'DROP SCHEMA' postgresql command
> to drop out the slony schema this will remove your triggers. This only works
> with Slony1 2.0.0 or above (You were probably reading the 2.0.3
> documentation on the website).    This is the same procedure you need to use
> against a master with 1.2 (but with 2.0 it works against both slaves and
> masters).
>
> In 1.2.x slony munges the catalog on the slaves and dropping the slony
> schema from a slave will leave your leave in a bad state.
>
> If your planning on using Slony 2.0.x you are better off with the tip of
> REL_2_0_STABLE from cvs versus 2.0.3 due to the 'invalid utf8' bug fixed a
> few weeks ago.
>
> Does the attached documentation patch make that paragraph more clear?
>
>
The doc-patch does make it more clear, but I don't think DROP SCHEMA
_slony_cluster_name CASCADE is something I'd like to do with my running
Slony replication. A cleaner way would be more desirable.

Regards,
-- 
gurjeet.singh
@ EnterpriseDB - The Enterprise Postgres Company
http://www.enterprisedb.com

singh.gurjeet@{ gmail | yahoo }.com
Twitter/Skype: singh_gurjeet

Mail sent from my BlackLaptop device
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20100517/755f3721/attachment.htm 

From ssinger at ca.afilias.info  Mon May 17 11:58:01 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Mon, 17 May 2010 14:58:01 -0400
Subject: [Slony1-general] Slony triggers included in pg_dump
In-Reply-To: <AANLkTilq9QncnLfnHKwS3YEr3sELyzEHHTMFZrHqdN6b@mail.gmail.com>
References: <AANLkTik3kuhrTf7xiy5ylZi-N4AprDvtBP831Il6oxhS@mail.gmail.com>
	<4BF002D6.3030805@ca.afilias.info>
	<AANLkTilq9QncnLfnHKwS3YEr3sELyzEHHTMFZrHqdN6b@mail.gmail.com>
Message-ID: <4BF191B9.5000607@ca.afilias.info>

Gurjeet Singh wrote:

> The doc-patch does make it more clear, but I don't think DROP SCHEMA 
> _slony_cluster_name CASCADE is something I'd like to do with my running 
> Slony replication. A cleaner way would be more desirable.

Another option you have is to restore the dump that you create of your 
pgbench schema to another database(a new one).  When you restore the 
CREATE TRIGGER statements will fail because the slony stored procedures 
won't exist in your new database.   This should leave you with your 
database - any slony stuff.  (I agree having to put up with 'errors' 
during the restore or make a second copy of the database just to do 
'DROP SCHEMA' are both less than ideal solutions)




> 
> Regards,
> -- 
> gurjeet.singh
> @ EnterpriseDB - The Enterprise Postgres Company
> http://www.enterprisedb.com
> 
> singh.gurjeet@{ gmail | yahoo }.com
> Twitter/Skype: singh_gurjeet
> 
> Mail sent from my BlackLaptop device


-- 
Steve Singer
Afilias Canada
Data Services Developer
416-673-1142

From bench at silentmedia.com  Tue May 18 14:39:52 2010
From: bench at silentmedia.com (Ben Chobot)
Date: Tue, 18 May 2010 14:39:52 -0700
Subject: [Slony1-general] (re)shaping a cluster
In-Reply-To: <CCB6BE77-6DB6-4C35-97E3-A853A973091D@silentmedia.com>
References: <CCB6BE77-6DB6-4C35-97E3-A853A973091D@silentmedia.com>
Message-ID: <AF497632-6E45-4989-8F31-BC46B8B05F89@silentmedia.com>

Anybody?

On May 12, 2010, at 10:22 AM, Ben Chobot wrote:

> I currently have 5 nodes in my slony 1.2 cluster: A, B, C, D, and E. Nodes A and B take turns being the origin. Node C will always be a subscriber but is also a provider to nodes D and E, which have subscribed to their set with forward=no. (All other nodes have subscribed with forward=yes.) So:
> 
> (A or B) provides to C provides to (D and E)
> 
> I have two intertwined questions about this configuration. The first is, how do I reshape when C dies? I assume I should just tell D and E to receive from A or B.....
> 
> ...but (and this is the second question) D and E have subscribed with forward=no, and I've heard that you don't want something with forward=no talking to a node which might be become the origin. So should I just subscribe D and E with forward=yes, even though they'll never forward their data on?
> 
> 
> As a third question, I'm becoming a bit concerned about the number of nodes in my cluster, especially because I want to add a third node that might become the origin and also a third node that feeds from C in the common case. Do D and E need paths between their current provider only, or do they need to be in constant talk with all of their potential providers?
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


From ssinger_pg at sympatico.ca  Tue May 18 14:47:31 2010
From: ssinger_pg at sympatico.ca (Steve Singer)
Date: Tue, 18 May 2010 17:47:31 -0400 (EDT)
Subject: [Slony1-general] (re)shaping a cluster
In-Reply-To: <AF497632-6E45-4989-8F31-BC46B8B05F89@silentmedia.com>
References: <CCB6BE77-6DB6-4C35-97E3-A853A973091D@silentmedia.com>
	<AF497632-6E45-4989-8F31-BC46B8B05F89@silentmedia.com>
Message-ID: <BLU0-SMTP681A78BBD8D3A9A09C6227ACE10@phx.gbl>

On Tue, 18 May 2010, Ben Chobot wrote:

> Anybody?
>
> On May 12, 2010, at 10:22 AM, Ben Chobot wrote:
>
>> I currently have 5 nodes in my slony 1.2 cluster: A, B, C, D, and E. 
>> Nodes A and B take turns being the origin. Node C will always be a 
>> subscriber but is also a provider to nodes D and E, which have subscribed 
>> to their set with forward=no. (All other nodes have subscribed with 
>> forward=yes.) So:
>>
>> (A or B) provides to C provides to (D and E)
>>
>> I have two intertwined questions about this configuration. The first is, 
>> how do I reshape when C dies? I assume I should just tell D and E to 
>> receive from A or B.....

Yes I think so.

>>
>> ...but (and this is the second question) D and E have subscribed with 
>> forward=no, and I've heard that you don't want something with forward=no 
>> talking to a node which might be become the origin. So should I just 
>> subscribe D and E with forward=yes, even though they'll never forward 
>> their data on?


You don't want a node that MIGHT become a provider(say in the event of 
another node failing) with forwarder=no.  The origin can send data to nodes 
with forward=no, those nodes just won't be useful as backup providers if the 
origin fails.

>>
>>
>> As a third question, I'm becoming a bit concerned about the number of
>>nodes in my cluster, especially because I want to add a third node that 
>>might become the origin and also a third node that feeds from C in the 
>> common case. Do D and E need paths between their current provider only, 
>>or do they need to be in constant talk with all of their potential 
>>providers?

D and E only need paths between their current provider.  If you reshape your 
cluster so D and E have a new provider you can add paths at that 
time.



>> _______________________________________________
>> Slony1-general mailing list
>> Slony1-general at lists.slony.info
>> http://lists.slony.info/mailman/listinfo/slony1-general
>
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
>


From JanWieck at Yahoo.com  Tue May 18 19:55:49 2010
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Tue, 18 May 2010 22:55:49 -0400
Subject: [Slony1-general] [Slony1-bugs] Slony triggers included in
	pg_dump
In-Reply-To: <AANLkTik3kuhrTf7xiy5ylZi-N4AprDvtBP831Il6oxhS@mail.gmail.com>
References: <AANLkTik3kuhrTf7xiy5ylZi-N4AprDvtBP831Il6oxhS@mail.gmail.com>
Message-ID: <4BF35335.7090502@Yahoo.com>

On 5/16/2010 8:22 AM, Gurjeet Singh wrote:
> Hi All,
> 
>     The docs here http://www.slony.info/documentation/triggers.html says 
> that post Postgres 8.3 version
> 
> <snip>
> 
>     * If you take a pg_dump of a Slony-I node, and drop out the Slony-I
>       namespace, this now cleanly removes /all/ Slony-I components,
>       leaving the database, /including its schema,/ in a "pristine",
>       consistent fashion, ready for whatever use may be desired. 
> 
> </snip>
> 
> But I see that when dumping a schema containing tables monitored by 
> Slony, the dump still shows the log triggers on those tables.

I think you misinterpret the statement.

If you take a complete dump of all schemas, restore that and THEN drop 
the slony schema, you have a pristine stand alone system as the result.

pg_dump does not exclude cross-schema definitions like those triggers. 
You will get the same for example with foreign keys. For a table in the 
schema you are dumping, that references a table in a non-dumped schema, 
pg_dump will still emit the ALTER TABLE attempting to create the constraint.


Jan

> 
> postgres=# select version();
>                                               
> version                                              
> ----------------------------------------------------------------------------------------------------
>  PostgreSQL 8.3.10 on i686-pc-linux-gnu, compiled by GCC gcc (GCC) 4.3.2 
> 20081105 (Red Hat 4.3.2-7)
> 
> # pg_dump --schema-only --schema pgbench -p 5433 -U postgres | grep 
> "CREATE TRIGGER"
> CREATE TRIGGER _pgbench_logtrigger_1
> CREATE TRIGGER _pgbench_logtrigger_2
> CREATE TRIGGER _pgbench_logtrigger_3
> 
> So is that statement in the docs incorrect, or is this a regression?
> 
> Best regards,
> -- 
> gurjeet.singh
> @ EnterpriseDB - The Enterprise Postgres Company
> http://www.enterprisedb.com
> 
> singh.gurjeet@{ gmail | yahoo }.com
> Twitter/Skype: singh_gurjeet
> 
> Mail sent from my BlackLaptop device
> 
> 
> ------------------------------------------------------------------------
> 
> _______________________________________________
> Slony1-bugs mailing list
> Slony1-bugs at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-bugs


-- 
Anyone who trades liberty for security deserves neither
liberty nor security. -- Benjamin Franklin

From michael at aers.ca  Wed May 19 10:12:24 2010
From: michael at aers.ca (michael at aers.ca)
Date: Wed, 19 May 2010 10:12:24 -0700
Subject: [Slony1-general] Maximum relations for replication
Message-ID: <6B5AF6293A289F45826220B17ABE79370150094B@BORON.aers.local>

Is there any maximum # of relations for a replication cluster and/or
set? I'm currently using Slony I 2.0.3. Haven't been able to spot this
in the docs. Thanks!

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20100519/a3d1e03e/attachment.htm 

From scott.marlowe at gmail.com  Wed May 19 10:59:04 2010
From: scott.marlowe at gmail.com (Scott Marlowe)
Date: Wed, 19 May 2010 11:59:04 -0600
Subject: [Slony1-general] Maximum relations for replication
In-Reply-To: <6B5AF6293A289F45826220B17ABE79370150094B@BORON.aers.local>
References: <Acr3dnN9gp01A2CkQfesj9H6HTTrEQ==>
	<6B5AF6293A289F45826220B17ABE79370150094B@BORON.aers.local>
Message-ID: <AANLkTilf5Yvpx1TdzRlQVy0xa3DNonnGQVz8lQFtdZjp@mail.gmail.com>

I run a slony replication set with about 1000 relations.  That's
pretty big.  It's not too hard to manage, but we have about 50,000
other relations in the same db and for slony 1 1.2.latest, that's an
issue, as it takes about a minute now for each table  to be added to a
set.

On Wed, May 19, 2010 at 11:12 AM,  <michael at aers.ca> wrote:
> Is there any maximum # of relations for a replication cluster and/or set?
> I?m currently using Slony I 2.0.3. Haven?t been able to spot this in the
> docs. Thanks!
>
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
>
>



-- 
When fascism comes to America, it will be intolerance sold as diversity.

From threshar at torgo.978.org  Wed May 19 12:25:37 2010
From: threshar at torgo.978.org (Jeff)
Date: Wed, 19 May 2010 15:25:37 -0400
Subject: [Slony1-general] sl_log getting sequencing of events wrong
Message-ID: <26562A16-4975-4A14-BC9E-29C5CE192B07@torgo.978.org>

This is going to sound very very odd and highly improbable.  We've had  
a long time intermittent issue where a slave will get a primary key  
violation on a replicated table.   Sometimes we go a few weeks without  
it occurring, sometimes a few hours. Until now I hadn't been motivated  
enough to really dig in (as it often liked to do so at inopportune  
times).  This has happened under PG 8.2 and 8.4 (we're currently on  
8.4, both origin & slave) and on various slony1 versions (we're  
currently on 1.2.17).

The code which is causing the problem is a plpgsql function fired from  
a trigger.
It basically does:
begin;
	delete from thetable where id = v_id;
	insert into thetable (id, otherjunk) values (v_id, v_otherjunk);
end;

"thetable" has a pk on the id column.

Now, for the evidence - this is pulled from sl_log_2 and while I can't  
include log_cmddata here, here is the rest:

   log_xid   | log_actionseq | log_cmdtype
------------+---------------+-------------
  1153890130 |    2800679119 | I
  1153890130 |    2800679120 | D
  1153890760 |    2800716473 | D
  1153890760 |    2800716474 | I
  1153919695 |    2800872885 | D
  1153919695 |    2800880852 | I

Notice in the first txn we insert then delete, then in a later one we  
delete then insert (twice actually).
I was just thinking "what if 2 of them executed at the same time for  
the same id?" but look at the xid - same txn, so there goes that theory.

I looked at the log trigger source and it is assigning actionseq  
through a nextval so I'm at a complete loss as to how this could  
possibly happen.  It does not happen often, and tends to only happen  
on this one table (It may have done so on other tables in the past)  
and we use the delete; insert; pattern in numerous other places  
without issue.  It does not happen all the time - and since it only  
happens on the slave it worked ok and in the proper order on the origin.

Any ideas or are you as baffled as I?

So far, I cannot reproduce this on-demand.

--
Jeff Trout <jeff at jefftrout.com>
http://www.stuarthamm.net/
http://www.dellsmartexitin.com/




From vivek at khera.org  Wed May 19 12:35:40 2010
From: vivek at khera.org (Vick Khera)
Date: Wed, 19 May 2010 15:35:40 -0400
Subject: [Slony1-general] sl_log getting sequencing of events wrong
In-Reply-To: <26562A16-4975-4A14-BC9E-29C5CE192B07@torgo.978.org>
References: <26562A16-4975-4A14-BC9E-29C5CE192B07@torgo.978.org>
Message-ID: <AANLkTin2WJP0lKomq_Zfn9gLG8QTCOoXaosZs3e_H8qc@mail.gmail.com>

On Wed, May 19, 2010 at 3:25 PM, Jeff <threshar at torgo.978.org> wrote:
> Any ideas or are you as baffled as I?
>

My bet is that somewhere somehow at some time someone did some DDL
without going thru EXECUTE SCRIPT, and that some trigger is being
fired on the replica where it should not be.

The fix is to run EXECUTE SCRIPT with a harmless script that does
nothing, such as "SELECT 1;". This will cause slony to fix up all the
triggers on the replica to not fire.  Of course you'll have to verify
your data is still correct.

From threshar at torgo.978.org  Wed May 19 12:46:07 2010
From: threshar at torgo.978.org (Jeff)
Date: Wed, 19 May 2010 15:46:07 -0400
Subject: [Slony1-general] sl_log getting sequencing of events wrong
In-Reply-To: <AANLkTin2WJP0lKomq_Zfn9gLG8QTCOoXaosZs3e_H8qc@mail.gmail.com>
References: <26562A16-4975-4A14-BC9E-29C5CE192B07@torgo.978.org>
	<AANLkTin2WJP0lKomq_Zfn9gLG8QTCOoXaosZs3e_H8qc@mail.gmail.com>
Message-ID: <0156E335-4DEB-448E-B0D2-0F000A52B344@torgo.978.org>


On May 19, 2010, at 3:35 PM, Vick Khera wrote:

> On Wed, May 19, 2010 at 3:25 PM, Jeff <threshar at torgo.978.org> wrote:
>> Any ideas or are you as baffled as I?
>>
>
> My bet is that somewhere somehow at some time someone did some DDL
> without going thru EXECUTE SCRIPT, and that some trigger is being
> fired on the replica where it should not be.
>
> The fix is to run EXECUTE SCRIPT with a harmless script that does
> nothing, such as "SELECT 1;". This will cause slony to fix up all the
> triggers on the replica to not fire.  Of course you'll have to verify
> your data is still correct.


That would not explain the contents of sl_log though - the insert is  
being logged before the delete in the same txn.
Since it is replicated, it has the deny trigger on it so some "rouge  
code" would not be able to insert data into the table.

--
Jeff Trout <jeff at jefftrout.com>
http://www.stuarthamm.net/
http://www.dellsmartexitin.com/




From vivek at khera.org  Wed May 19 12:51:12 2010
From: vivek at khera.org (Vick Khera)
Date: Wed, 19 May 2010 15:51:12 -0400
Subject: [Slony1-general] sl_log getting sequencing of events wrong
In-Reply-To: <0156E335-4DEB-448E-B0D2-0F000A52B344@torgo.978.org>
References: <26562A16-4975-4A14-BC9E-29C5CE192B07@torgo.978.org>
	<AANLkTin2WJP0lKomq_Zfn9gLG8QTCOoXaosZs3e_H8qc@mail.gmail.com>
	<0156E335-4DEB-448E-B0D2-0F000A52B344@torgo.978.org>
Message-ID: <AANLkTinj5LwQ7TgvYcBTtJloygpQcFs8JLaX58zeEDhR@mail.gmail.com>

On Wed, May 19, 2010 at 3:46 PM, Jeff <threshar at torgo.978.org> wrote:
> Since it is replicated, it has the deny trigger on it so some "rouge
> code" would not be able to insert data into the table.
>

I've managed to screw up a replication such that this is exactly what
happened.  The replica was trying to insert rows via trigger that the
master already did and replicated to that table.

From threshar at torgo.978.org  Wed May 19 12:57:23 2010
From: threshar at torgo.978.org (Jeff)
Date: Wed, 19 May 2010 15:57:23 -0400
Subject: [Slony1-general] sl_log getting sequencing of events wrong
In-Reply-To: <AANLkTinj5LwQ7TgvYcBTtJloygpQcFs8JLaX58zeEDhR@mail.gmail.com>
References: <26562A16-4975-4A14-BC9E-29C5CE192B07@torgo.978.org>
	<AANLkTin2WJP0lKomq_Zfn9gLG8QTCOoXaosZs3e_H8qc@mail.gmail.com>
	<0156E335-4DEB-448E-B0D2-0F000A52B344@torgo.978.org>
	<AANLkTinj5LwQ7TgvYcBTtJloygpQcFs8JLaX58zeEDhR@mail.gmail.com>
Message-ID: <CA3B96DF-29A3-49E0-8D15-ABA103350A2B@torgo.978.org>


On May 19, 2010, at 3:51 PM, Vick Khera wrote:

> On Wed, May 19, 2010 at 3:46 PM, Jeff <threshar at torgo.978.org> wrote:
>> Since it is replicated, it has the deny trigger on it so some "rouge
>> code" would not be able to insert data into the table.
>>
>
> I've managed to screw up a replication such that this is exactly what
> happened.  The replica was trying to insert rows via trigger that the
> master already did and replicated to that table.

If you refer back to my initial mail I included the contents of  
sl_log_2 showing an insert then delete on the table (for the same id  
if that wasn't clear) which is backwards from what the code actually  
does.  So it did the insert first, as it had the lower log_actionseq,  
which failed instead of the delete first. (as you could see what what  
happened later)

--
Jeff Trout <jeff at jefftrout.com>
http://www.stuarthamm.net/
http://www.dellsmartexitin.com/




From JanWieck at Yahoo.com  Wed May 19 02:00:33 2010
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Wed, 19 May 2010 05:00:33 -0400
Subject: [Slony1-general] sl_log getting sequencing of events wrong
In-Reply-To: <26562A16-4975-4A14-BC9E-29C5CE192B07@torgo.978.org>
References: <26562A16-4975-4A14-BC9E-29C5CE192B07@torgo.978.org>
Message-ID: <4BF3A8B1.2070004@Yahoo.com>

On 5/19/2010 3:25 PM, Jeff wrote:
> This is going to sound very very odd and highly improbable.  We've had  
> a long time intermittent issue where a slave will get a primary key  
> violation on a replicated table.   Sometimes we go a few weeks without  
> it occurring, sometimes a few hours. Until now I hadn't been motivated  
> enough to really dig in (as it often liked to do so at inopportune  
> times).  This has happened under PG 8.2 and 8.4 (we're currently on  
> 8.4, both origin & slave) and on various slony1 versions (we're  
> currently on 1.2.17).
> 
> The code which is causing the problem is a plpgsql function fired from  
> a trigger.
> It basically does:
> begin;
> 	delete from thetable where id = v_id;
> 	insert into thetable (id, otherjunk) values (v_id, v_otherjunk);
> end;
> 
> "thetable" has a pk on the id column.
> 
> Now, for the evidence - this is pulled from sl_log_2 and while I can't  
> include log_cmddata here, here is the rest:
> 
>    log_xid   | log_actionseq | log_cmdtype
> ------------+---------------+-------------
>   1153890130 |    2800679119 | I
>   1153890130 |    2800679120 | D
>   1153890760 |    2800716473 | D
>   1153890760 |    2800716474 | I
>   1153919695 |    2800872885 | D
>   1153919695 |    2800880852 | I

I have no idea why that would happen. I will need to check if the 
trigger queue of 8.4 may do funky stuff here, like actually firing all 
those AFTER triggers when the stored procedure returns, rather than at 
the end of each command within your procedure.

Notice also that there is a 1000+ bump in the log_actionsequence for the 
two operations done by the last transaction. This suggests that somehow 
that sequence is configured for cacheing, which is a bad thing in general.


Jan

-- 
Anyone who trades liberty for security deserves neither
liberty nor security. -- Benjamin Franklin

From JanWieck at Yahoo.com  Wed May 19 02:42:26 2010
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Wed, 19 May 2010 05:42:26 -0400
Subject: [Slony1-general] sl_log getting sequencing of events wrong
In-Reply-To: <4BF3A8B1.2070004@Yahoo.com>
References: <26562A16-4975-4A14-BC9E-29C5CE192B07@torgo.978.org>
	<4BF3A8B1.2070004@Yahoo.com>
Message-ID: <4BF3B282.3040703@Yahoo.com>

On 5/19/2010 5:00 AM, Jan Wieck wrote:
> On 5/19/2010 3:25 PM, Jeff wrote:
>> This is going to sound very very odd and highly improbable.  We've had  
>> a long time intermittent issue where a slave will get a primary key  
>> violation on a replicated table.   Sometimes we go a few weeks without  
>> it occurring, sometimes a few hours. Until now I hadn't been motivated  
>> enough to really dig in (as it often liked to do so at inopportune  
>> times).  This has happened under PG 8.2 and 8.4 (we're currently on  
>> 8.4, both origin & slave) and on various slony1 versions (we're  
>> currently on 1.2.17).
>> 
>> The code which is causing the problem is a plpgsql function fired from  
>> a trigger.
>> It basically does:
>> begin;
>> 	delete from thetable where id = v_id;
>> 	insert into thetable (id, otherjunk) values (v_id, v_otherjunk);
>> end;
>> 
>> "thetable" has a pk on the id column.
>> 
>> Now, for the evidence - this is pulled from sl_log_2 and while I can't  
>> include log_cmddata here, here is the rest:
>> 
>>    log_xid   | log_actionseq | log_cmdtype
>> ------------+---------------+-------------
>>   1153890130 |    2800679119 | I
>>   1153890130 |    2800679120 | D
>>   1153890760 |    2800716473 | D
>>   1153890760 |    2800716474 | I
>>   1153919695 |    2800872885 | D
>>   1153919695 |    2800880852 | I
> 
> I have no idea why that would happen. I will need to check if the 
> trigger queue of 8.4 may do funky stuff here, like actually firing all 
> those AFTER triggers when the stored procedure returns, rather than at 
> the end of each command within your procedure.

I created a very small test and it suggests that the triggers fire 
during the execution of the function, not at the end. So there goes that 
idea.


Jan

-- 
Anyone who trades liberty for security deserves neither
liberty nor security. -- Benjamin Franklin

From aiwaniuk at instytut.com.pl  Thu May 20 01:28:31 2010
From: aiwaniuk at instytut.com.pl (aiwaniuk at instytut.com.pl)
Date: Thu, 20 May 2010 10:28:31 +0200
Subject: [Slony1-general] Maximum relations for replication
In-Reply-To: <AANLkTilf5Yvpx1TdzRlQVy0xa3DNonnGQVz8lQFtdZjp@mail.gmail.com>
References: <6B5AF6293A289F45826220B17ABE79370150094B@BORON.aers.local>
	<AANLkTilf5Yvpx1TdzRlQVy0xa3DNonnGQVz8lQFtdZjp@mail.gmail.com>
Message-ID: <20100520082831.GA21717@troy.imm>

On Wed, May 19, 2010 at 11:59:04AM -0600, Scott Marlowe wrote:
> I run a slony replication set with about 1000 relations.  That's
> pretty big.  It's not too hard to manage, but we have about 50,000
> other relations in the same db and for slony 1 1.2.latest, that's an
> issue, as it takes about a minute now for each table  to be added to a
> set.
> 
> On Wed, May 19, 2010 at 11:12 AM,  <michael at aers.ca> wrote:
> > Is there any maximum # of relations for a replication cluster and/or set?
> > I?m currently using Slony I 2.0.3. Haven?t been able to spot this in the
> > docs. Thanks!
> >


i have 6500. i don't see any relation between number of tables and
normal circumstances. but once i used slony to upgrade postgres and
switchover took almost 2 hours. addititionally, if you created set with
thousands of tables and then while subscribing something went wrong,
slony will start from the scratch - this could be very time consuming.


-- 
IaS


From threshar at torgo.978.org  Thu May 20 05:24:23 2010
From: threshar at torgo.978.org (Jeff)
Date: Thu, 20 May 2010 08:24:23 -0400
Subject: [Slony1-general] sl_log getting sequencing of events wrong
In-Reply-To: <4BF3A8B1.2070004@Yahoo.com>
References: <26562A16-4975-4A14-BC9E-29C5CE192B07@torgo.978.org>
	<4BF3A8B1.2070004@Yahoo.com>
Message-ID: <11DDB087-3759-4066-B867-E540B791E888@torgo.978.org>


On May 19, 2010, at 5:00 AM, Jan Wieck wrote:

>
>
> Notice also that there is a 1000+ bump in the log_actionsequence for  
> the
> two operations done by the last transaction. This suggests that  
> somehow
> that sequence is configured for cacheing, which is a bad thing in  
> general.
>

The db is quite write heavy - so it is feasible that it bumped by 1000  
in that window. (We generate around 5500 wal segments a day on the  
origin to give you an idea)

Yeah, I'm still completely baffled - I saved sl_log from yesterday's  
hiccup - would there be anything else of use to capture when it occurs  
again?  But I think the smoking gun was that log_actionseq being  
bassackwards.  If it were something with caching or ordering of  
triggers we'd be seeing that a whole lot more often I'd wager.  I also  
find it paticularly interesting that it is almost always (as far as I  
can remember anyway) this one paticular table.

to give a bit more details - we have a few tables here, lets call them  
"sourcereport", "events", and "summary".  All three are replicated.

An insert is done on the sourcereport table (which fires slon logger)
This fires a trigger to determine if the contents of that insert are  
worthy of getting an entry in events. If so, we insert into events.  
(which fires a slon logger).
After that trigger we fire the summary trigger which updates the  
summary table based on the new sourcereport row by doing delete from  
summary where id = XXX;
insert into summary (id, blah) select XXX, blah from sourcereport;

this happens 20-30 times a day, m-f

--
Jeff Trout <jeff at jefftrout.com>
http://www.stuarthamm.net/
http://www.dellsmartexitin.com/




From cscetbon.ext at orange-ftgroup.com  Thu May 20 06:35:23 2010
From: cscetbon.ext at orange-ftgroup.com (Cyril Scetbon)
Date: Thu, 20 May 2010 15:35:23 +0200
Subject: [Slony1-general] An old event not confirmed: A possible bug?
In-Reply-To: <4BEAC184.1000702@Yahoo.com>
References: <AANLkTikflK7G1bHIJjQLynJ-VZIwhAvAWazUNqyFQm5i@mail.gmail.com>
	<4BEAC184.1000702@Yahoo.com>
Message-ID: <4BF53A9B.7020103@orange-ftgroup.com>



Jan Wieck a ?crit :
> On 5/12/2010 10:31 AM, Gurjeet Singh wrote:
>   
>> Hi All,
>>
>>     I have two Slony test beds which show the exact same symptoms!
>>
>> select * from sl_event order by ev_seqno;
>>
>>  ev_origin |  ev_seqno  |        ev_timestamp        |        
>> ev_snapshot         | ev_type |
>> -----------+------------+----------------------------+----------------------------+---------+-
>>          2 | 5000000002 | 2010-04-30 08:32:38.622928 | 
>> 458:458:                   | SYNC    |
>>          1 | 5000525721 | 2010-05-12 13:30:22.79626  | 
>> 72685915:72685915:         | SYNC    |
>>          1 | 5000525722 | 2010-05-12 13:30:24.800943 | 
>> 72686139:72686139:         | SYNC    |
>>          1 | 5000525723 | 2010-05-12 13:30:26.804862 | 
>> 72686224:72686224:         | SYNC    |
>> ...
>>
>>     
>
> Slony always keeps at least the last event per origin around. Otherwise 
> the view sl_status would not work.
>   
Hi Jan, Can you talk more about it ? I've posted a mail today to 
slony1-bugs cause test_slony_state.pl is warning us about old events 
(that's exactly the eldest ones). That's a matter for events generated 
from the local node. I see events from the local node only when I 
restart it :

select * from _OURCLUSTER.sl_event where 
ev_origin=102;                                  
 ev_origin | ev_seqno |        ev_timestamp        |     
ev_snapshot      | ev_type | ev_data1 | ev_data2 | ev_data3 | ev_data4 | 
ev_data5 | ev_data6 | ev_data7 | ev_data8
-----------+----------+----------------------------+----------------------+---------+----------+----------+----------+----------+----------+----------+----------+----------
       102 |       51 | 2010-05-20 12:27:00.099562 | 
338318875:338318875: | SYNC    |          |          |          
|          |          |          |          |
(1 row)

select * from _OURCLUSTER.sl_confirm where con_origin=102;
 con_origin | con_received | con_seqno |       con_timestamp       
------------+--------------+-----------+----------------------------
        102 |          101 |        51 | 2010-05-20 12:27:02.78581
        102 |          103 |        51 | 2010-05-20 12:27:00.118815
        102 |          104 |        51 | 2010-05-20 12:27:00.253975

the SYNC appears in slony logs as "new sl_action_seq 1 - SYNC %d"

> What should worry you is that there are no newer SYNC events from node 2 
> available. Slony does create a sporadic SYNC every now and then even if 
> there is no activity or the node isn't an origin anyway.
>
> Is it possible that node 2's clock is way off?
>
>
> Jan
>
>   
>> The reason I think this _might_ be a bug is that on both clusters, slave 
>> node's sl_event has the exact same record for ev_seqno=5000000002 except 
>> for the timestamp; same origin, and same snapshot!
>>
>> The head of sl_confirm has:
>>
>>  select * from sl_confirm order by con_seqno;
>>
>>  con_origin | con_received | con_seqno  |       con_timestamp
>> ------------+--------------+------------+----------------------------
>>           2 |            1 | 5000000002 | 2010-04-30 08:32:53.974021
>>           1 |            2 | 5000527075 | 2010-05-12 14:15:41.192279
>>           1 |            2 | 5000527076 | 2010-05-12 14:15:43.193607
>>           1 |            2 | 5000527077 | 2010-05-12 14:15:45.196291
>>           1 |            2 | 5000527078 | 2010-05-12 14:15:47.197005
>> ...
>>
>> Can someone comment on the health of the cluster? All events, except for 
>> that on, are being confirmed and purged from the system regularly, so my 
>> assumption is that the cluster is healthy and that the slave is in sync 
>> with the master.
>>
>> Thanks in advance.
>> -- 
>> gurjeet.singh
>> @ EnterpriseDB - The Enterprise Postgres Company
>> http://www.enterprisedb.com
>>
>> singh.gurjeet@{ gmail | yahoo }.com
>> Twitter/Skype: singh_gurjeet
>>
>> Mail sent from my BlackLaptop device
>>
>>
>> ------------------------------------------------------------------------
>>
>> _______________________________________________
>> Slony1-general mailing list
>> Slony1-general at lists.slony.info
>> http://lists.slony.info/mailman/listinfo/slony1-general
>>     
>
>
>   

-- 
Cyril SCETBON

From JanWieck at Yahoo.com  Wed May 19 19:36:09 2010
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Wed, 19 May 2010 22:36:09 -0400
Subject: [Slony1-general] sl_log getting sequencing of events wrong
In-Reply-To: <11DDB087-3759-4066-B867-E540B791E888@torgo.978.org>
References: <26562A16-4975-4A14-BC9E-29C5CE192B07@torgo.978.org>	<4BF3A8B1.2070004@Yahoo.com>
	<11DDB087-3759-4066-B867-E540B791E888@torgo.978.org>
Message-ID: <4BF4A019.2080108@Yahoo.com>

On 5/20/2010 8:24 AM, Jeff wrote:
> On May 19, 2010, at 5:00 AM, Jan Wieck wrote:
> 
>>
>>
>> Notice also that there is a 1000+ bump in the log_actionsequence for  
>> the
>> two operations done by the last transaction. This suggests that  
>> somehow
>> that sequence is configured for cacheing, which is a bad thing in  
>> general.
>>
> 
> The db is quite write heavy - so it is feasible that it bumped by 1000  
> in that window. (We generate around 5500 wal segments a day on the  
> origin to give you an idea)

If the sl_action_seq has a cache_value of 1 (as it should be), then this 
bump would mean that between the DELETE and the INSERT, which are 
consecutive statements inside the same PL/pgSQL function, other 
transactions were able to call nextval('sl_action_seq') 1,000+ times.

> 
> Yeah, I'm still completely baffled - I saved sl_log from yesterday's  
> hiccup - would there be anything else of use to capture when it occurs  
> again?  But I think the smoking gun was that log_actionseq being  
> bassackwards.  If it were something with caching or ordering of  
> triggers we'd be seeing that a whole lot more often I'd wager.  I also  
> find it paticularly interesting that it is almost always (as far as I  
> can remember anyway) this one paticular table.
> 
> to give a bit more details - we have a few tables here, lets call them  
> "sourcereport", "events", and "summary".  All three are replicated.
> 
> An insert is done on the sourcereport table (which fires slon logger)
> This fires a trigger to determine if the contents of that insert are  
> worthy of getting an entry in events. If so, we insert into events.  
> (which fires a slon logger).
> After that trigger we fire the summary trigger which updates the  
> summary table based on the new sourcereport row by doing delete from  
> summary where id = XXX;
> insert into summary (id, blah) select XXX, blah from sourcereport;

Does that happen inside of a transaction context that involves other 
triggers and/or constraints? As per my tests, AFTER user triggers are 
fired from the queue at the end of each statement. The slon logger 
firing out of order of those statements could still point towards a bug 
in the trigger queue, which would be extremely serious.


Jan

-- 
Anyone who trades liberty for security deserves neither
liberty nor security. -- Benjamin Franklin

From JanWieck at Yahoo.com  Wed May 19 19:58:41 2010
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Wed, 19 May 2010 22:58:41 -0400
Subject: [Slony1-general] [Slony1-bugs] An old event not confirmed: A
 possible bug?
In-Reply-To: <4BF53A9B.7020103@orange-ftgroup.com>
References: <AANLkTikflK7G1bHIJjQLynJ-VZIwhAvAWazUNqyFQm5i@mail.gmail.com>	<4BEAC184.1000702@Yahoo.com>
	<4BF53A9B.7020103@orange-ftgroup.com>
Message-ID: <4BF4A561.2050909@Yahoo.com>

On 5/20/2010 9:35 AM, Cyril Scetbon wrote:
> 
> Jan Wieck a ?crit :
>> On 5/12/2010 10:31 AM, Gurjeet Singh wrote:
>>   
>>> Hi All,
>>>
>>>     I have two Slony test beds which show the exact same symptoms!
>>>
>>> select * from sl_event order by ev_seqno;
>>>
>>>  ev_origin |  ev_seqno  |        ev_timestamp        |        
>>> ev_snapshot         | ev_type |
>>> -----------+------------+----------------------------+----------------------------+---------+-
>>>          2 | 5000000002 | 2010-04-30 08:32:38.622928 | 
>>> 458:458:                   | SYNC    |
>>>          1 | 5000525721 | 2010-05-12 13:30:22.79626  | 
>>> 72685915:72685915:         | SYNC    |
>>>          1 | 5000525722 | 2010-05-12 13:30:24.800943 | 
>>> 72686139:72686139:         | SYNC    |
>>>          1 | 5000525723 | 2010-05-12 13:30:26.804862 | 
>>> 72686224:72686224:         | SYNC    |
>>> ...
>>>
>>>     
>>
>> Slony always keeps at least the last event per origin around. Otherwise 
>> the view sl_status would not work.
>>   
> Hi Jan, Can you talk more about it ? I've posted a mail today to 
> slony1-bugs cause test_slony_state.pl is warning us about old events 
> (that's exactly the eldest ones). That's a matter for events generated 
> from the local node. I see events from the local node only when I 
> restart it :

I presume that you have set sync_interval_timeout to zero on the 
subscribers, which will prevent the generation of SYNC events on those 
nodes because no actual replication work is ever generated there. Looks 
like test_slony_state.pl depends on that parameter no be non-zero 
(default is -t 10000, meaning every 10 seconds).


Jan

> 
> select * from _OURCLUSTER.sl_event where 
> ev_origin=102;                                  
>  ev_origin | ev_seqno |        ev_timestamp        |     
> ev_snapshot      | ev_type | ev_data1 | ev_data2 | ev_data3 | ev_data4 | 
> ev_data5 | ev_data6 | ev_data7 | ev_data8
> -----------+----------+----------------------------+----------------------+---------+----------+----------+----------+----------+----------+----------+----------+----------
>        102 |       51 | 2010-05-20 12:27:00.099562 | 
> 338318875:338318875: | SYNC    |          |          |          
> |          |          |          |          |
> (1 row)
> 
> select * from _OURCLUSTER.sl_confirm where con_origin=102;
>  con_origin | con_received | con_seqno |       con_timestamp       
> ------------+--------------+-----------+----------------------------
>         102 |          101 |        51 | 2010-05-20 12:27:02.78581
>         102 |          103 |        51 | 2010-05-20 12:27:00.118815
>         102 |          104 |        51 | 2010-05-20 12:27:00.253975
> 
> the SYNC appears in slony logs as "new sl_action_seq 1 - SYNC %d"
> 
>> What should worry you is that there are no newer SYNC events from node 2 
>> available. Slony does create a sporadic SYNC every now and then even if 
>> there is no activity or the node isn't an origin anyway.
>>
>> Is it possible that node 2's clock is way off?
>>
>>
>> Jan
>>
>>   
>>> The reason I think this _might_ be a bug is that on both clusters, slave 
>>> node's sl_event has the exact same record for ev_seqno=5000000002 except 
>>> for the timestamp; same origin, and same snapshot!
>>>
>>> The head of sl_confirm has:
>>>
>>>  select * from sl_confirm order by con_seqno;
>>>
>>>  con_origin | con_received | con_seqno  |       con_timestamp
>>> ------------+--------------+------------+----------------------------
>>>           2 |            1 | 5000000002 | 2010-04-30 08:32:53.974021
>>>           1 |            2 | 5000527075 | 2010-05-12 14:15:41.192279
>>>           1 |            2 | 5000527076 | 2010-05-12 14:15:43.193607
>>>           1 |            2 | 5000527077 | 2010-05-12 14:15:45.196291
>>>           1 |            2 | 5000527078 | 2010-05-12 14:15:47.197005
>>> ...
>>>
>>> Can someone comment on the health of the cluster? All events, except for 
>>> that on, are being confirmed and purged from the system regularly, so my 
>>> assumption is that the cluster is healthy and that the slave is in sync 
>>> with the master.
>>>
>>> Thanks in advance.
>>> -- 
>>> gurjeet.singh
>>> @ EnterpriseDB - The Enterprise Postgres Company
>>> http://www.enterprisedb.com
>>>
>>> singh.gurjeet@{ gmail | yahoo }.com
>>> Twitter/Skype: singh_gurjeet
>>>
>>> Mail sent from my BlackLaptop device
>>>
>>>
>>> ------------------------------------------------------------------------
>>>
>>> _______________________________________________
>>> Slony1-general mailing list
>>> Slony1-general at lists.slony.info
>>> http://lists.slony.info/mailman/listinfo/slony1-general
>>>     
>>
>>
>>   
> 


-- 
Anyone who trades liberty for security deserves neither
liberty nor security. -- Benjamin Franklin

From cscetbon.ext at orange-ftgroup.com  Thu May 20 07:48:26 2010
From: cscetbon.ext at orange-ftgroup.com (Cyril Scetbon)
Date: Thu, 20 May 2010 16:48:26 +0200
Subject: [Slony1-general] [Slony1-bugs] An old event not confirmed: A
 possible bug?
In-Reply-To: <4BF4A561.2050909@Yahoo.com>
References: <AANLkTikflK7G1bHIJjQLynJ-VZIwhAvAWazUNqyFQm5i@mail.gmail.com>	<4BEAC184.1000702@Yahoo.com>	<4BF53A9B.7020103@orange-ftgroup.com>
	<4BF4A561.2050909@Yahoo.com>
Message-ID: <4BF54BBA.2050101@orange-ftgroup.com>



Jan Wieck a ?crit :
> On 5/20/2010 9:35 AM, Cyril Scetbon wrote:
>   
>> Jan Wieck a ?crit :
>>     
>>> On 5/12/2010 10:31 AM, Gurjeet Singh wrote:
>>>   
>>>       
>>>> Hi All,
>>>>
>>>>     I have two Slony test beds which show the exact same symptoms!
>>>>
>>>> select * from sl_event order by ev_seqno;
>>>>
>>>>  ev_origin |  ev_seqno  |        ev_timestamp        |        
>>>> ev_snapshot         | ev_type |
>>>> -----------+------------+----------------------------+----------------------------+---------+-
>>>>          2 | 5000000002 | 2010-04-30 08:32:38.622928 | 
>>>> 458:458:                   | SYNC    |
>>>>          1 | 5000525721 | 2010-05-12 13:30:22.79626  | 
>>>> 72685915:72685915:         | SYNC    |
>>>>          1 | 5000525722 | 2010-05-12 13:30:24.800943 | 
>>>> 72686139:72686139:         | SYNC    |
>>>>          1 | 5000525723 | 2010-05-12 13:30:26.804862 | 
>>>> 72686224:72686224:         | SYNC    |
>>>> ...
>>>>
>>>>     
>>>>         
>>> Slony always keeps at least the last event per origin around. Otherwise 
>>> the view sl_status would not work.
>>>   
>>>       
>> Hi Jan, Can you talk more about it ? I've posted a mail today to 
>> slony1-bugs cause test_slony_state.pl is warning us about old events 
>> (that's exactly the eldest ones). That's a matter for events generated 
>> from the local node. I see events from the local node only when I 
>> restart it :
>>     
>
> I presume that you have set sync_interval_timeout to zero on the 
> subscribers, which will prevent the generation of SYNC events on those 
> nodes because no actual replication work is ever generated there. Looks 
> like test_slony_state.pl depends on that parameter no be non-zero 
> (default is -t 10000, meaning every 10 seconds).
>   
No as you can see :

2010-05-20 15:31:55 CEST CONFIG slon: watchdog ready - pid = 23457
2010-05-20 15:31:55 CEST CONFIG main: Integer option vac_frequency = 3
2010-05-20 15:31:55 CEST CONFIG main: Integer option log_level = 2
2010-05-20 15:31:55 CEST CONFIG main: Integer option sync_interval = 500
2010-05-20 15:31:55 CEST CONFIG main: Integer option 
sync_interval_timeout = 10000
2010-05-20 15:31:55 CEST CONFIG main: Integer option sync_group_maxsize = 20
2010-05-20 15:31:55 CEST CONFIG main: Integer option desired_sync_time = 
60000
2010-05-20 15:31:55 CEST CONFIG main: Integer option syslog = 0
2010-05-20 15:31:55 CEST CONFIG main: Integer option quit_sync_provider = 0
2010-05-20 15:31:55 CEST CONFIG main: Integer option quit_sync_finalsync = 0
2010-05-20 15:31:55 CEST CONFIG main: Integer option sync_max_rowsize = 8192
2010-05-20 15:31:55 CEST CONFIG main: Integer option sync_max_largemem = 
5242880
2010-05-20 15:31:55 CEST CONFIG main: Integer option 
remote_listen_timeout = 300
2010-05-20 15:31:55 CEST CONFIG main: Boolean option log_pid = 0
2010-05-20 15:31:55 CEST CONFIG main: Boolean option log_timestamp = 1
2010-05-20 15:31:55 CEST CONFIG main: Boolean option cleanup_deletelogs = 0
2010-05-20 15:31:55 CEST CONFIG main: Real option real_placeholder = 
0.000000

But this is a receiver and I saw in the code of  function 
generate_sync_event that it does not generate sync interval on a node 
which is not the origin of a set. That's why I presume there is no sync 
created except the one created at startup (mandatory) in syncThread_main :

/*
         * We don't initialize the last known action sequence to the 
actual value.
         * This causes that we create a SYNC event allways on startup, 
just in
         * case.
         */
        last_actseq_buf[0] = '\0';

        /*
         * Build the query that starts a transaction and retrieves the 
last value
         * from the action sequence.
         */
        dstring_init(&query1);
        slon_mkquery(&query1,
                                 "start transaction;"
                                 "set transaction isolation level 
serializable;"
                                 "select last_value from %s.sl_action_seq;",
                                 rtcfg_namespace);

        /*
         * Build the query that calls createEvent() for the SYNC
         */
        dstring_init(&query2);
        slon_mkquery(&query2,
                     "select %s.createEvent('_%s', 'SYNC', NULL)"
                     " from %s.sl_node where no_id = 
%s.getLocalNodeId('_%s') "
                     " and exists (select 1 from %s.sl_set where 
set_origin= no_id);",
                     rtcfg_namespace, rtcfg_cluster_name,
                     rtcfg_namespace, rtcfg_namespace, 
rtcfg_cluster_name, rtcfg_namespace);


>
> Jan
>
>   
>> select * from _OURCLUSTER.sl_event where 
>> ev_origin=102;                                  
>>  ev_origin | ev_seqno |        ev_timestamp        |     
>> ev_snapshot      | ev_type | ev_data1 | ev_data2 | ev_data3 | ev_data4 | 
>> ev_data5 | ev_data6 | ev_data7 | ev_data8
>> -----------+----------+----------------------------+----------------------+---------+----------+----------+----------+----------+----------+----------+----------+----------
>>        102 |       51 | 2010-05-20 12:27:00.099562 | 
>> 338318875:338318875: | SYNC    |          |          |          
>> |          |          |          |          |
>> (1 row)
>>
>> select * from _OURCLUSTER.sl_confirm where con_origin=102;
>>  con_origin | con_received | con_seqno |       con_timestamp       
>> ------------+--------------+-----------+----------------------------
>>         102 |          101 |        51 | 2010-05-20 12:27:02.78581
>>         102 |          103 |        51 | 2010-05-20 12:27:00.118815
>>         102 |          104 |        51 | 2010-05-20 12:27:00.253975
>>
>> the SYNC appears in slony logs as "new sl_action_seq 1 - SYNC %d"
>>
>>     
>>> What should worry you is that there are no newer SYNC events from node 2 
>>> available. Slony does create a sporadic SYNC every now and then even if 
>>> there is no activity or the node isn't an origin anyway.
>>>
>>> Is it possible that node 2's clock is way off?
>>>
>>>
>>> Jan
>>>
>>>   
>>>       
>>>> The reason I think this _might_ be a bug is that on both clusters, slave 
>>>> node's sl_event has the exact same record for ev_seqno=5000000002 except 
>>>> for the timestamp; same origin, and same snapshot!
>>>>
>>>> The head of sl_confirm has:
>>>>
>>>>  select * from sl_confirm order by con_seqno;
>>>>
>>>>  con_origin | con_received | con_seqno  |       con_timestamp
>>>> ------------+--------------+------------+----------------------------
>>>>           2 |            1 | 5000000002 | 2010-04-30 08:32:53.974021
>>>>           1 |            2 | 5000527075 | 2010-05-12 14:15:41.192279
>>>>           1 |            2 | 5000527076 | 2010-05-12 14:15:43.193607
>>>>           1 |            2 | 5000527077 | 2010-05-12 14:15:45.196291
>>>>           1 |            2 | 5000527078 | 2010-05-12 14:15:47.197005
>>>> ...
>>>>
>>>> Can someone comment on the health of the cluster? All events, except for 
>>>> that on, are being confirmed and purged from the system regularly, so my 
>>>> assumption is that the cluster is healthy and that the slave is in sync 
>>>> with the master.
>>>>
>>>> Thanks in advance.
>>>> -- 
>>>> gurjeet.singh
>>>> @ EnterpriseDB - The Enterprise Postgres Company
>>>> http://www.enterprisedb.com
>>>>
>>>> singh.gurjeet@{ gmail | yahoo }.com
>>>> Twitter/Skype: singh_gurjeet
>>>>
>>>> Mail sent from my BlackLaptop device
>>>>
>>>>
>>>> ------------------------------------------------------------------------
>>>>
>>>> _______________________________________________
>>>> Slony1-general mailing list
>>>> Slony1-general at lists.slony.info
>>>> http://lists.slony.info/mailman/listinfo/slony1-general
>>>>     
>>>>         
>>>   
>>>       
>
>
>   

-- 
Cyril SCETBON

From threshar at torgo.978.org  Thu May 20 08:02:30 2010
From: threshar at torgo.978.org (Jeff)
Date: Thu, 20 May 2010 11:02:30 -0400
Subject: [Slony1-general] sl_log getting sequencing of events wrong
In-Reply-To: <4BF4A019.2080108@Yahoo.com>
References: <26562A16-4975-4A14-BC9E-29C5CE192B07@torgo.978.org>
	<4BF3A8B1.2070004@Yahoo.com>
	<11DDB087-3759-4066-B867-E540B791E888@torgo.978.org>
	<4BF4A019.2080108@Yahoo.com>
Message-ID: <555043C7-204F-4BC1-8395-F6287A920684@torgo.978.org>


On May 19, 2010, at 10:36 PM, Jan Wieck wrote:

> If the sl_action_seq has a cache_value of 1 (as it should be), then  
> this bump would mean that between the DELETE and the INSERT, which  
> are consecutive statements inside the same PL/pgSQL function, other  
> transactions were able to call nextval('sl_action_seq') 1,000+ times.
>

cache is set to 1. and they are consecutive statements. like I said,  
sometimes the db is pretty write heavy.
Looking at my stats collector collector, yesterday I got the following  
counts for insert, upd, and del:
  46249049 | 1859054 | 42489642

>> oes that happen inside of a transaction context that involves other  
>> triggers and/or constraints? As per my tests, AFTER user triggers  
>> are fired from the queue at the end of each statement. The slon  
>> logger firing out of order of those statements could still point  
>> towards a bug in the trigger queue, which would be extremely serious.
>

Yes.

"sourcereport" has an FK to another table, in addition to 3 triggers -  
the slon logger, the event adder and the summary updater.  Since PG  
executes triggers in alpha order the ordering is slony, event trig,  
summary trig.

if an event is added that table also has an fk and some triggers on it  
(and is replicated)

the summary table has an FK back to the 'sourcereport' table.  Here's  
the whole sl_log for that txn in question (tablenames have been  
changed to protect the innocent)

the exact chain of events was they deleted from sourcereport, which  
caused a cascade of events being removed (a report can cause multiple  
events), then the summary being updated.

   log_xid   | log_actionseq | log_tableid |    tab_relname    |  
log_cmdtype
------------+---------------+-------------+------------------- 
+-------------
  1153890130 |    2800679112 |        7600 | soucereport    | D
  1153890130 |    2800679113 |        6600 | events     | D
  1153890130 |    2800679114 |        7900 | events_log | I
  1153890130 |    2800679115 |        6600 | events     | D
  1153890130 |    2800679116 |        7900 | events_log | I
  1153890130 |    2800679117 |        6600 | events     | D
  1153890130 |    2800679118 |        7900 | events_log | I
  1153890130 |    2800679119 |        5700 | summary      | I
  1153890130 |    2800679120 |        5700 | summary      | D

Like I said, this only happens once in a while - happened twice  
yesterday (db was a bit less loaded than normal actually) before that  
maybe a week or two previous?

Here's most of the body of the trigger that fires to update summary  
(from sourcereport) - again changed some var names
(it is an after trigger)

DECLARE
	v_sourceid int;
BEGIN
	
	if TG_OP = 'DELETE' then
		v_sourceid := OLD.sourceid;
	else
		v_sourceid := NEW.sourceid;
	end if;

	delete from summary
		where sourceid = v_cik;

	insert into summary (sourceid, ... )
		select sourceid, ....
		from sourcereport
		where sourceid = v_sourceid
		order by publishdate desc, id desc limit 1;

	return NULL;
END

huh. return null is a bit odd, but since it is an after it works.

--
Jeff Trout <jeff at jefftrout.com>
http://www.stuarthamm.net/
http://www.dellsmartexitin.com/




From threshar at torgo.978.org  Thu May 20 08:33:19 2010
From: threshar at torgo.978.org (Jeff)
Date: Thu, 20 May 2010 11:33:19 -0400
Subject: [Slony1-general] sl_log getting sequencing of events wrong
In-Reply-To: <555043C7-204F-4BC1-8395-F6287A920684@torgo.978.org>
References: <26562A16-4975-4A14-BC9E-29C5CE192B07@torgo.978.org>
	<4BF3A8B1.2070004@Yahoo.com>
	<11DDB087-3759-4066-B867-E540B791E888@torgo.978.org>
	<4BF4A019.2080108@Yahoo.com>
	<555043C7-204F-4BC1-8395-F6287A920684@torgo.978.org>
Message-ID: <76C914E8-3DAB-4E73-B243-DFCE598A4CF7@torgo.978.org>

it happened again - wanted to get this post out before I do more  
digging:

table summary as an on delete cascade FK into sourcereports.
we delete from sourcereports.
the RI trigger deletes from summary (5700) but does not fire the log  
trigger yet.
we go on our merry way nuking events.
then my summary update trigger runs - the delete inside it does  
nothing due to the FK already nuking the row then proceeds to insert  
into it.
then we execute the slon logger for the original FK delete and it  
records a delete record after the insert.

then someone comes along and loads a new report for the same sourceid  
(to avoid confusion, it is a company identifier)

I need to flesh this out a bit more but I think it is related, I'll  
report back in a bit with more details.


--
Jeff Trout <jeff at jefftrout.com>
http://www.stuarthamm.net/
http://www.dellsmartexitin.com/




From ssinger at ca.afilias.info  Thu May 20 08:49:50 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Thu, 20 May 2010 11:49:50 -0400
Subject: [Slony1-general] sl_log getting sequencing of events wrong
In-Reply-To: <76C914E8-3DAB-4E73-B243-DFCE598A4CF7@torgo.978.org>
References: <26562A16-4975-4A14-BC9E-29C5CE192B07@torgo.978.org>	<4BF3A8B1.2070004@Yahoo.com>	<11DDB087-3759-4066-B867-E540B791E888@torgo.978.org>	<4BF4A019.2080108@Yahoo.com>	<555043C7-204F-4BC1-8395-F6287A920684@torgo.978.org>
	<76C914E8-3DAB-4E73-B243-DFCE598A4CF7@torgo.978.org>
Message-ID: <4BF55A1E.3010903@ca.afilias.info>

Jeff wrote:

> then someone comes along and loads a new report for the same sourceid  
> (to avoid confusion, it is a company identifier)

Does the insert happen in the same transaction as the delete? From your 
previous posts I sort of assumed that a single connection/transaction 
was doing the then the insert.  Could another connection be doing the 
insert?  Your use of 'someone' is a bit vague.


> 
> I need to flesh this out a bit more but I think it is related, I'll  
> report back in a bit with more details.
> 
> 
> --
> Jeff Trout <jeff at jefftrout.com>
> http://www.stuarthamm.net/
> http://www.dellsmartexitin.com/
> 
> 
> 
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


-- 
Steve Singer
Afilias Canada
Data Services Developer
416-673-1142

From JanWieck at Yahoo.com  Wed May 19 21:41:54 2010
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Thu, 20 May 2010 00:41:54 -0400
Subject: [Slony1-general] sl_log getting sequencing of events wrong
In-Reply-To: <76C914E8-3DAB-4E73-B243-DFCE598A4CF7@torgo.978.org>
References: <26562A16-4975-4A14-BC9E-29C5CE192B07@torgo.978.org>	<4BF3A8B1.2070004@Yahoo.com>
	<11DDB087-3759-4066-B867-E540B791E888@torgo.978.org>
	<4BF4A019.2080108@Yahoo.com>
	<555043C7-204F-4BC1-8395-F6287A920684@torgo.978.org>
	<76C914E8-3DAB-4E73-B243-DFCE598A4CF7@torgo.978.org>
Message-ID: <4BF4BD92.9060404@Yahoo.com>

On 5/20/2010 11:33 AM, Jeff wrote:
> it happened again - wanted to get this post out before I do more  
> digging:
> 
> table summary as an on delete cascade FK into sourcereports.
> we delete from sourcereports.
> the RI trigger deletes from summary (5700) but does not fire the log  
> trigger yet.
> we go on our merry way nuking events.
> then my summary update trigger runs - the delete inside it does  
> nothing due to the FK already nuking the row then proceeds to insert  
> into it.
> then we execute the slon logger for the original FK delete and it  
> records a delete record after the insert.

Does summary also have an FK with cascade referencing sourcereport?

The thing that I don't understand is where the insert into summary is 
actually coming from. The trigger does

     insert into summary (...) select ... from sourcereport
         where sourceid = <just_deleted_id>

Since it is an AFTER trigger, the result set of that select should be 
empty and no row get inserted.

This still does not explain the wrong ordering of the log rows, but I'm 
getting a better picture of it.


Jan


> 
> then someone comes along and loads a new report for the same sourceid  
> (to avoid confusion, it is a company identifier)
> 
> I need to flesh this out a bit more but I think it is related, I'll  
> report back in a bit with more details.
> 
> 
> --
> Jeff Trout <jeff at jefftrout.com>
> http://www.stuarthamm.net/
> http://www.dellsmartexitin.com/
> 
> 


-- 
Anyone who trades liberty for security deserves neither
liberty nor security. -- Benjamin Franklin

From threshar at torgo.978.org  Thu May 20 09:18:11 2010
From: threshar at torgo.978.org (Jeff)
Date: Thu, 20 May 2010 12:18:11 -0400
Subject: [Slony1-general] sl_log getting sequencing of events wrong
In-Reply-To: <76C914E8-3DAB-4E73-B243-DFCE598A4CF7@torgo.978.org>
References: <26562A16-4975-4A14-BC9E-29C5CE192B07@torgo.978.org>
	<4BF3A8B1.2070004@Yahoo.com>
	<11DDB087-3759-4066-B867-E540B791E888@torgo.978.org>
	<4BF4A019.2080108@Yahoo.com>
	<555043C7-204F-4BC1-8395-F6287A920684@torgo.978.org>
	<76C914E8-3DAB-4E73-B243-DFCE598A4CF7@torgo.978.org>
Message-ID: <2A472A25-9F83-4FF9-9223-359C73CDE538@torgo.978.org>


On May 20, 2010, at 11:33 AM, Jeff wrote:

> it happened again - wanted to get this post out before I do more  
> digging:
>
> table summary as an on delete cascade FK into sourcereports.
> we delete from sourcereports.
> the RI trigger deletes from summary (5700) but does not fire the log  
> trigger yet.
> we go on our merry way nuking events.
> then my summary update trigger runs - the delete inside it does  
> nothing due to the FK already nuking the row then proceeds to insert  
> into it.
> then we execute the slon logger for the original FK delete and it  
> records a delete record after the insert.
>
> then someone comes along and loads a new report for the same  
> sourceid (to avoid confusion, it is a company identifier)
>
> I need to flesh this out a bit more but I think it is related, I'll  
> report back in a bit with more details.
>
>

I have a test case here - turns out the bug is ultimately in my code  
and there is really nothing slony can do about it. but I figure for  
the good of the world, I'll present my findings.

we have a table testsource and another table testsummary which has an  
on delete fk to testsource(id).
I added a number of triggers onto them to simulate slony and my own  
code:

indie=> insert into testsource(company) values (2);
NOTICE:  logger - OP: INSERT REL: testsource WHEN: AFTER
NOTICE:  update summary
NOTICE:  tabaction - OP: INSERT REL: testsummary WHEN: BEFORE
CONTEXT:  SQL statement "insert into testsummary (company, source_id)  
values ( $1 ,  $2 )"
PL/pgSQL function "testupdatesummary" line 18 at SQL statement
NOTICE:  logger - OP: INSERT REL: testsummary WHEN: AFTER
CONTEXT:  SQL statement "insert into testsummary (company, source_id)  
values ( $1 ,  $2 )"
PL/pgSQL function "testupdatesummary" line 18 at SQL statement
NOTICE:  tabaction - OP: INSERT REL: testsummary WHEN: AFTER
CONTEXT:  SQL statement "insert into testsummary (company, source_id)  
values ( $1 ,  $2 )"
PL/pgSQL function "testupdatesummary" line 18 at SQL statement
INSERT 0 1
indie=> select * from testsource;
  id | company | data
----+---------+------
   2 |       2 |
(1 row)

things look sane.
now lets nuke it:

indie=> delete from testsource where id = 2;
NOTICE:  tabaction - OP: DELETE REL: testsummary WHEN: BEFORE
CONTEXT:  SQL statement "DELETE FROM ONLY "public"."testsummary" WHERE  
$1 OPERATOR(pg_catalog.=) "source_id""
NOTICE:  logger - OP: DELETE REL: testsource WHEN: AFTER
NOTICE:  update summary
NOTICE:  tabaction - OP: INSERT REL: testsummary WHEN: BEFORE
CONTEXT:  SQL statement "insert into testsummary (company, source_id)  
values ( $1 ,  $2 )"
PL/pgSQL function "testupdatesummary" line 18 at SQL statement
NOTICE:  logger - OP: INSERT REL: testsummary WHEN: AFTER
CONTEXT:  SQL statement "insert into testsummary (company, source_id)  
values ( $1 ,  $2 )"
PL/pgSQL function "testupdatesummary" line 18 at SQL statement
NOTICE:  tabaction - OP: INSERT REL: testsummary WHEN: AFTER
CONTEXT:  SQL statement "insert into testsummary (company, source_id)  
values ( $1 ,  $2 )"
PL/pgSQL function "testupdatesummary" line 18 at SQL statement
NOTICE:  logger - OP: DELETE REL: testsummary WHEN: AFTER
NOTICE:  tabaction - OP: DELETE REL: testsummary WHEN: AFTER
DELETE 1

first we see a before trigger for the FK fire.
then we log our delete from testsource, which fires the summary update  
trigger
since the summary for that company is gone we do not delete and just  
insert and log that.
after that the after trigger from the fk delete is fired, which logs.

so the main bug is the FK in testsummary is wrong and not needed. the  
other is the ordering of operations from there, but I don't think  
slony can do anything about it.  it is a bit interesting the FK stuff  
occurs in an odd sequence though. I would have expected the after  
triggers to fire after the fk induced delete...


-------------- next part --------------
A non-text attachment was scrubbed...
Name: broketest1.sql
Type: application/octet-stream
Size: 1779 bytes
Desc: not available
Url : http://lists.slony.info/pipermail/slony1-general/attachments/20100520/b82b9b2e/attachment.obj 
-------------- next part --------------



--
Jeff Trout <jeff at jefftrout.com>
http://www.stuarthamm.net/
http://www.dellsmartexitin.com/




From JanWieck at Yahoo.com  Wed May 19 22:00:19 2010
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Thu, 20 May 2010 01:00:19 -0400
Subject: [Slony1-general] [Slony1-bugs] An old event not confirmed: A
 possible bug?
In-Reply-To: <4BF54BBA.2050101@orange-ftgroup.com>
References: <AANLkTikflK7G1bHIJjQLynJ-VZIwhAvAWazUNqyFQm5i@mail.gmail.com>	<4BEAC184.1000702@Yahoo.com>	<4BF53A9B.7020103@orange-ftgroup.com>
	<4BF4A561.2050909@Yahoo.com> <4BF54BBA.2050101@orange-ftgroup.com>
Message-ID: <4BF4C1E3.1050206@Yahoo.com>

On 5/20/2010 10:48 AM, Cyril Scetbon wrote:
> But this is a receiver and I saw in the code of  function 
> generate_sync_event that it does not generate sync interval on a node 
> which is not the origin of a set. That's why I presume there is no sync 
> created except the one created at startup (mandatory) in syncThread_main :

 From the CVS log:

> ----------------------------
> revision 1.19
> date: 2007-03-14 15:59:32 +0000;  author: cbbrowne;  state: Exp;  lines: +20 -6;
> Reduce the quantity of spurious events generated:
> 
> 1.  generate_sync_event() only needs to generate a SYNC on a node
>     that is the origin for a set
> 
> 2.  sync thread generates a SYNC when it starts; in later iterations,
>     it will only generate a SYNC for its node if that node is the origin
>     for a replication set
> 
> Per discussions with Jan Wieck on 2007-02-09; this seemed an experiment
> worth trying.  I tried it, and the tests run fine, so I'm committing this.
> ----------------------------

Seems we finally found a reason why this isn't such a good idea after 
all. Question now is do we want to revert back to the default, where 
slon's of pure receivers create useless SYNC events or not?


Jan

-- 
Anyone who trades liberty for security deserves neither
liberty nor security. -- Benjamin Franklin

From JanWieck at Yahoo.com  Thu May 20 02:55:08 2010
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Thu, 20 May 2010 05:55:08 -0400
Subject: [Slony1-general] sl_log getting sequencing of events wrong
In-Reply-To: <2A472A25-9F83-4FF9-9223-359C73CDE538@torgo.978.org>
References: <26562A16-4975-4A14-BC9E-29C5CE192B07@torgo.978.org>	<4BF3A8B1.2070004@Yahoo.com>	<11DDB087-3759-4066-B867-E540B791E888@torgo.978.org>	<4BF4A019.2080108@Yahoo.com>	<555043C7-204F-4BC1-8395-F6287A920684@torgo.978.org>	<76C914E8-3DAB-4E73-B243-DFCE598A4CF7@torgo.978.org>
	<2A472A25-9F83-4FF9-9223-359C73CDE538@torgo.978.org>
Message-ID: <4BF506FC.3010901@Yahoo.com>

On 5/20/2010 12:18 PM, Jeff wrote:
> On May 20, 2010, at 11:33 AM, Jeff wrote:
> 
>> it happened again - wanted to get this post out before I do more  
>> digging:
>>
>> table summary as an on delete cascade FK into sourcereports.
>> we delete from sourcereports.
>> the RI trigger deletes from summary (5700) but does not fire the log  
>> trigger yet.
>> we go on our merry way nuking events.
>> then my summary update trigger runs - the delete inside it does  
>> nothing due to the FK already nuking the row then proceeds to insert  
>> into it.
>> then we execute the slon logger for the original FK delete and it  
>> records a delete record after the insert.
>>
>> then someone comes along and loads a new report for the same  
>> sourceid (to avoid confusion, it is a company identifier)
>>
>> I need to flesh this out a bit more but I think it is related, I'll  
>> report back in a bit with more details.
>>
>>
> 
> I have a test case here - turns out the bug is ultimately in my code  
> and there is really nothing slony can do about it. but I figure for  
> the good of the world, I'll present my findings.
> 
> we have a table testsource and another table testsummary which has an  
> on delete fk to testsource(id).
> I added a number of triggers onto them to simulate slony and my own  
> code:
> 
> indie=> insert into testsource(company) values (2);
> NOTICE:  logger - OP: INSERT REL: testsource WHEN: AFTER
> NOTICE:  update summary
> NOTICE:  tabaction - OP: INSERT REL: testsummary WHEN: BEFORE
> CONTEXT:  SQL statement "insert into testsummary (company, source_id)  
> values ( $1 ,  $2 )"
> PL/pgSQL function "testupdatesummary" line 18 at SQL statement
> NOTICE:  logger - OP: INSERT REL: testsummary WHEN: AFTER
> CONTEXT:  SQL statement "insert into testsummary (company, source_id)  
> values ( $1 ,  $2 )"
> PL/pgSQL function "testupdatesummary" line 18 at SQL statement
> NOTICE:  tabaction - OP: INSERT REL: testsummary WHEN: AFTER
> CONTEXT:  SQL statement "insert into testsummary (company, source_id)  
> values ( $1 ,  $2 )"
> PL/pgSQL function "testupdatesummary" line 18 at SQL statement
> INSERT 0 1
> indie=> select * from testsource;
>   id | company | data
> ----+---------+------
>    2 |       2 |
> (1 row)
> 
> things look sane.
> now lets nuke it:
> 
> indie=> delete from testsource where id = 2;
> NOTICE:  tabaction - OP: DELETE REL: testsummary WHEN: BEFORE
> CONTEXT:  SQL statement "DELETE FROM ONLY "public"."testsummary" WHERE  
> $1 OPERATOR(pg_catalog.=) "source_id""
> NOTICE:  logger - OP: DELETE REL: testsource WHEN: AFTER
> NOTICE:  update summary
> NOTICE:  tabaction - OP: INSERT REL: testsummary WHEN: BEFORE
> CONTEXT:  SQL statement "insert into testsummary (company, source_id)  
> values ( $1 ,  $2 )"
> PL/pgSQL function "testupdatesummary" line 18 at SQL statement
> NOTICE:  logger - OP: INSERT REL: testsummary WHEN: AFTER
> CONTEXT:  SQL statement "insert into testsummary (company, source_id)  
> values ( $1 ,  $2 )"
> PL/pgSQL function "testupdatesummary" line 18 at SQL statement
> NOTICE:  tabaction - OP: INSERT REL: testsummary WHEN: AFTER
> CONTEXT:  SQL statement "insert into testsummary (company, source_id)  
> values ( $1 ,  $2 )"
> PL/pgSQL function "testupdatesummary" line 18 at SQL statement
> NOTICE:  logger - OP: DELETE REL: testsummary WHEN: AFTER
> NOTICE:  tabaction - OP: DELETE REL: testsummary WHEN: AFTER
> DELETE 1
>
> first we see a before trigger for the FK fire.
> then we log our delete from testsource, which fires the summary update  
> trigger
> since the summary for that company is gone we do not delete and just  
> insert and log that.
> after that the after trigger from the fk delete is fired, which logs.
> 
> so the main bug is the FK in testsummary is wrong and not needed. the  
> other is the ordering of operations from there, but I don't think  
> slony can do anything about it.  it is a bit interesting the FK stuff  
> occurs in an odd sequence though. I would have expected the after  
> triggers to fire after the fk induced delete...

I rather think that the problem is that your trigger updating the 
summary is a BEFORE trigger. If you turn that into an AFTER trigger that 
is named so that it fires after the FK CASCADE did its job, the problem 
may go away.

This is an interesting test case.


Jan

-- 
Anyone who trades liberty for security deserves neither
liberty nor security. -- Benjamin Franklin

From JanWieck at Yahoo.com  Thu May 20 10:47:51 2010
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Thu, 20 May 2010 13:47:51 -0400
Subject: [Slony1-general] sl_log getting sequencing of events wrong
In-Reply-To: <4BF506FC.3010901@Yahoo.com>
References: <26562A16-4975-4A14-BC9E-29C5CE192B07@torgo.978.org>	<4BF3A8B1.2070004@Yahoo.com>	<11DDB087-3759-4066-B867-E540B791E888@torgo.978.org>	<4BF4A019.2080108@Yahoo.com>	<555043C7-204F-4BC1-8395-F6287A920684@torgo.978.org>	<76C914E8-3DAB-4E73-B243-DFCE598A4CF7@torgo.978.org>	<2A472A25-9F83-4FF9-9223-359C73CDE538@torgo.978.org>
	<4BF506FC.3010901@Yahoo.com>
Message-ID: <4BF575C7.3060605@Yahoo.com>

On 5/20/2010 5:55 AM, Jan Wieck wrote:
> On 5/20/2010 12:18 PM, Jeff wrote:
>> On May 20, 2010, at 11:33 AM, Jeff wrote:
>> 
>>> it happened again - wanted to get this post out before I do more  
>>> digging:
>>>
>>> table summary as an on delete cascade FK into sourcereports.
>>> we delete from sourcereports.
>>> the RI trigger deletes from summary (5700) but does not fire the log  
>>> trigger yet.
>>> we go on our merry way nuking events.
>>> then my summary update trigger runs - the delete inside it does  
>>> nothing due to the FK already nuking the row then proceeds to insert  
>>> into it.
>>> then we execute the slon logger for the original FK delete and it  
>>> records a delete record after the insert.
>>>
>>> then someone comes along and loads a new report for the same  
>>> sourceid (to avoid confusion, it is a company identifier)
>>>
>>> I need to flesh this out a bit more but I think it is related, I'll  
>>> report back in a bit with more details.
>>>
>>>
>> 
>> I have a test case here - turns out the bug is ultimately in my code  
>> and there is really nothing slony can do about it. but I figure for  
>> the good of the world, I'll present my findings.
>> 
>> we have a table testsource and another table testsummary which has an  
>> on delete fk to testsource(id).
>> I added a number of triggers onto them to simulate slony and my own  
>> code:
>> 
>> indie=> insert into testsource(company) values (2);
>> NOTICE:  logger - OP: INSERT REL: testsource WHEN: AFTER
>> NOTICE:  update summary
>> NOTICE:  tabaction - OP: INSERT REL: testsummary WHEN: BEFORE
>> CONTEXT:  SQL statement "insert into testsummary (company, source_id)  
>> values ( $1 ,  $2 )"
>> PL/pgSQL function "testupdatesummary" line 18 at SQL statement
>> NOTICE:  logger - OP: INSERT REL: testsummary WHEN: AFTER
>> CONTEXT:  SQL statement "insert into testsummary (company, source_id)  
>> values ( $1 ,  $2 )"
>> PL/pgSQL function "testupdatesummary" line 18 at SQL statement
>> NOTICE:  tabaction - OP: INSERT REL: testsummary WHEN: AFTER
>> CONTEXT:  SQL statement "insert into testsummary (company, source_id)  
>> values ( $1 ,  $2 )"
>> PL/pgSQL function "testupdatesummary" line 18 at SQL statement
>> INSERT 0 1
>> indie=> select * from testsource;
>>   id | company | data
>> ----+---------+------
>>    2 |       2 |
>> (1 row)
>> 
>> things look sane.
>> now lets nuke it:
>> 
>> indie=> delete from testsource where id = 2;
>> NOTICE:  tabaction - OP: DELETE REL: testsummary WHEN: BEFORE
>> CONTEXT:  SQL statement "DELETE FROM ONLY "public"."testsummary" WHERE  
>> $1 OPERATOR(pg_catalog.=) "source_id""
>> NOTICE:  logger - OP: DELETE REL: testsource WHEN: AFTER
>> NOTICE:  update summary
>> NOTICE:  tabaction - OP: INSERT REL: testsummary WHEN: BEFORE
>> CONTEXT:  SQL statement "insert into testsummary (company, source_id)  
>> values ( $1 ,  $2 )"
>> PL/pgSQL function "testupdatesummary" line 18 at SQL statement
>> NOTICE:  logger - OP: INSERT REL: testsummary WHEN: AFTER
>> CONTEXT:  SQL statement "insert into testsummary (company, source_id)  
>> values ( $1 ,  $2 )"
>> PL/pgSQL function "testupdatesummary" line 18 at SQL statement
>> NOTICE:  tabaction - OP: INSERT REL: testsummary WHEN: AFTER
>> CONTEXT:  SQL statement "insert into testsummary (company, source_id)  
>> values ( $1 ,  $2 )"
>> PL/pgSQL function "testupdatesummary" line 18 at SQL statement
>> NOTICE:  logger - OP: DELETE REL: testsummary WHEN: AFTER
>> NOTICE:  tabaction - OP: DELETE REL: testsummary WHEN: AFTER
>> DELETE 1
>>
>> first we see a before trigger for the FK fire.
>> then we log our delete from testsource, which fires the summary update  
>> trigger
>> since the summary for that company is gone we do not delete and just  
>> insert and log that.
>> after that the after trigger from the fk delete is fired, which logs.
>> 
>> so the main bug is the FK in testsummary is wrong and not needed. the  
>> other is the ordering of operations from there, but I don't think  
>> slony can do anything about it.  it is a bit interesting the FK stuff  
>> occurs in an odd sequence though. I would have expected the after  
>> triggers to fire after the fk induced delete...
> 
> I rather think that the problem is that your trigger updating the 
> summary is a BEFORE trigger. If you turn that into an AFTER trigger that 
> is named so that it fires after the FK CASCADE did its job, the problem 
> may go away.

Oh complete fail!

That scenario is actually working as designed! You have an FK on summary 
referencing source with on delete cascade. And your trigger is trying to 
insert such conflicting reference. In the BEFORE case, it is correct 
that the summary row is deleted again. In the AFTER case, that insert 
should fail.


Jan

-- 
Anyone who trades liberty for security deserves neither
liberty nor security. -- Benjamin Franklin

From cscetbon.ext at orange-ftgroup.com  Fri May 21 01:46:52 2010
From: cscetbon.ext at orange-ftgroup.com (Cyril Scetbon)
Date: Fri, 21 May 2010 10:46:52 +0200
Subject: [Slony1-general] [Slony1-bugs] An old event not confirmed: A
 possible bug?
In-Reply-To: <4BF4C1E3.1050206@Yahoo.com>
References: <AANLkTikflK7G1bHIJjQLynJ-VZIwhAvAWazUNqyFQm5i@mail.gmail.com>	<4BEAC184.1000702@Yahoo.com>	<4BF53A9B.7020103@orange-ftgroup.com>	<4BF4A561.2050909@Yahoo.com>
	<4BF54BBA.2050101@orange-ftgroup.com> <4BF4C1E3.1050206@Yahoo.com>
Message-ID: <4BF6487C.3040107@orange-ftgroup.com>

the fastest fix is to modify test_slony_state.pl to not take into 
account events or confirms done for the initial SYNC on a receiver node.

Jan Wieck a ?crit :
> On 5/20/2010 10:48 AM, Cyril Scetbon wrote:
>   
>> But this is a receiver and I saw in the code of  function 
>> generate_sync_event that it does not generate sync interval on a node 
>> which is not the origin of a set. That's why I presume there is no sync 
>> created except the one created at startup (mandatory) in syncThread_main :
>>     
>
>  From the CVS log:
>
>   
>> ----------------------------
>> revision 1.19
>> date: 2007-03-14 15:59:32 +0000;  author: cbbrowne;  state: Exp;  lines: +20 -6;
>> Reduce the quantity of spurious events generated:
>>
>> 1.  generate_sync_event() only needs to generate a SYNC on a node
>>     that is the origin for a set
>>
>> 2.  sync thread generates a SYNC when it starts; in later iterations,
>>     it will only generate a SYNC for its node if that node is the origin
>>     for a replication set
>>
>> Per discussions with Jan Wieck on 2007-02-09; this seemed an experiment
>> worth trying.  I tried it, and the tests run fine, so I'm committing this.
>> ----------------------------
>>     
>
> Seems we finally found a reason why this isn't such a good idea after 
> all. Question now is do we want to revert back to the default, where 
> slon's of pure receivers create useless SYNC events or not?
>
>
> Jan
>
>   

-- 
Cyril SCETBON

From JanWieck at Yahoo.com  Thu May 20 11:24:49 2010
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Thu, 20 May 2010 14:24:49 -0400
Subject: [Slony1-general] [Slony1-bugs] An old event not confirmed: A
 possible bug?
In-Reply-To: <4BF6487C.3040107@orange-ftgroup.com>
References: <AANLkTikflK7G1bHIJjQLynJ-VZIwhAvAWazUNqyFQm5i@mail.gmail.com>	<4BEAC184.1000702@Yahoo.com>	<4BF53A9B.7020103@orange-ftgroup.com>	<4BF4A561.2050909@Yahoo.com>	<4BF54BBA.2050101@orange-ftgroup.com>
	<4BF4C1E3.1050206@Yahoo.com> <4BF6487C.3040107@orange-ftgroup.com>
Message-ID: <4BF57E71.50708@Yahoo.com>

On 5/21/2010 4:46 AM, Cyril Scetbon wrote:
> the fastest fix is to modify test_slony_state.pl to not take into 
> account events or confirms done for the initial SYNC on a receiver node.

Wouldn't that mask problems where confirmations don't flow properly back 
to non-origin nodes?

As long as they don't produce any events, that's not much of a problem. 
But it is better to discover such before attempting to use that node as 
a failover target or the like.


Jan


> 
> Jan Wieck a ?crit :
>> On 5/20/2010 10:48 AM, Cyril Scetbon wrote:
>>   
>>> But this is a receiver and I saw in the code of  function 
>>> generate_sync_event that it does not generate sync interval on a node 
>>> which is not the origin of a set. That's why I presume there is no sync 
>>> created except the one created at startup (mandatory) in syncThread_main :
>>>     
>>
>>  From the CVS log:
>>
>>   
>>> ----------------------------
>>> revision 1.19
>>> date: 2007-03-14 15:59:32 +0000;  author: cbbrowne;  state: Exp;  lines: +20 -6;
>>> Reduce the quantity of spurious events generated:
>>>
>>> 1.  generate_sync_event() only needs to generate a SYNC on a node
>>>     that is the origin for a set
>>>
>>> 2.  sync thread generates a SYNC when it starts; in later iterations,
>>>     it will only generate a SYNC for its node if that node is the origin
>>>     for a replication set
>>>
>>> Per discussions with Jan Wieck on 2007-02-09; this seemed an experiment
>>> worth trying.  I tried it, and the tests run fine, so I'm committing this.
>>> ----------------------------
>>>     
>>
>> Seems we finally found a reason why this isn't such a good idea after 
>> all. Question now is do we want to revert back to the default, where 
>> slon's of pure receivers create useless SYNC events or not?
>>
>>
>> Jan
>>
>>   
> 


-- 
Anyone who trades liberty for security deserves neither
liberty nor security. -- Benjamin Franklin

From cscetbon.ext at orange-ftgroup.com  Fri May 21 05:22:23 2010
From: cscetbon.ext at orange-ftgroup.com (Cyril Scetbon)
Date: Fri, 21 May 2010 14:22:23 +0200
Subject: [Slony1-general] [Slony1-bugs] An old event not confirmed: A
 possible bug?
In-Reply-To: <4BF57E71.50708@Yahoo.com>
References: <AANLkTikflK7G1bHIJjQLynJ-VZIwhAvAWazUNqyFQm5i@mail.gmail.com>	<4BEAC184.1000702@Yahoo.com>	<4BF53A9B.7020103@orange-ftgroup.com>	<4BF4A561.2050909@Yahoo.com>	<4BF54BBA.2050101@orange-ftgroup.com>	<4BF4C1E3.1050206@Yahoo.com>
	<4BF6487C.3040107@orange-ftgroup.com> <4BF57E71.50708@Yahoo.com>
Message-ID: <4BF67AFF.5020006@orange-ftgroup.com>



Jan Wieck a ?crit :
> On 5/21/2010 4:46 AM, Cyril Scetbon wrote:
>   
>> the fastest fix is to modify test_slony_state.pl to not take into 
>> account events or confirms done for the initial SYNC on a receiver node.
>>     
>
> Wouldn't that mask problems where confirmations don't flow properly back 
> to non-origin nodes?
>   
if we don't take into account the event (SYNC) created on a non-origin 
node but confirmed by others what could it mask ? everything worked fine 
and as this the last event it won't be removed (and so live longer than 
the interval defined in test-slony-state)
> As long as they don't produce any events, that's not much of a problem. 
> But it is better to discover such before attempting to use that node as 
> a failover target or the like.
>   
in this case the event must have been confirmed to not be taken into 
account.
>
> Jan
>
>
>   
>> Jan Wieck a ?crit :
>>     
>>> On 5/20/2010 10:48 AM, Cyril Scetbon wrote:
>>>   
>>>       
>>>> But this is a receiver and I saw in the code of  function 
>>>> generate_sync_event that it does not generate sync interval on a node 
>>>> which is not the origin of a set. That's why I presume there is no sync 
>>>> created except the one created at startup (mandatory) in syncThread_main :
>>>>     
>>>>         
>>>  From the CVS log:
>>>
>>>   
>>>       
>>>> ----------------------------
>>>> revision 1.19
>>>> date: 2007-03-14 15:59:32 +0000;  author: cbbrowne;  state: Exp;  lines: +20 -6;
>>>> Reduce the quantity of spurious events generated:
>>>>
>>>> 1.  generate_sync_event() only needs to generate a SYNC on a node
>>>>     that is the origin for a set
>>>>
>>>> 2.  sync thread generates a SYNC when it starts; in later iterations,
>>>>     it will only generate a SYNC for its node if that node is the origin
>>>>     for a replication set
>>>>
>>>> Per discussions with Jan Wieck on 2007-02-09; this seemed an experiment
>>>> worth trying.  I tried it, and the tests run fine, so I'm committing this.
>>>> ----------------------------
>>>>     
>>>>         
>>> Seems we finally found a reason why this isn't such a good idea after 
>>> all. Question now is do we want to revert back to the default, where 
>>> slon's of pure receivers create useless SYNC events or not?
>>>
>>>
>>> Jan
>>>
>>>   
>>>       
>
>
>   

-- 
Cyril SCETBON

From JanWieck at Yahoo.com  Thu May 20 18:41:13 2010
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Thu, 20 May 2010 21:41:13 -0400
Subject: [Slony1-general] [Slony1-bugs] An old event not confirmed: A
 possible bug?
In-Reply-To: <4BF67AFF.5020006@orange-ftgroup.com>
References: <AANLkTikflK7G1bHIJjQLynJ-VZIwhAvAWazUNqyFQm5i@mail.gmail.com>	<4BEAC184.1000702@Yahoo.com>	<4BF53A9B.7020103@orange-ftgroup.com>	<4BF4A561.2050909@Yahoo.com>	<4BF54BBA.2050101@orange-ftgroup.com>	<4BF4C1E3.1050206@Yahoo.com>
	<4BF6487C.3040107@orange-ftgroup.com> <4BF57E71.50708@Yahoo.com>
	<4BF67AFF.5020006@orange-ftgroup.com>
Message-ID: <4BF5E4B9.9020308@Yahoo.com>

On 5/21/2010 8:22 AM, Cyril Scetbon wrote:
> 
> Jan Wieck a ?crit :
>> On 5/21/2010 4:46 AM, Cyril Scetbon wrote:
>>   
>>> the fastest fix is to modify test_slony_state.pl to not take into 
>>> account events or confirms done for the initial SYNC on a receiver node.
>>>     
>>
>> Wouldn't that mask problems where confirmations don't flow properly back 
>> to non-origin nodes?
>>   
> if we don't take into account the event (SYNC) created on a non-origin 
> node but confirmed by others what could it mask ? everything worked fine 
> and as this the last event it won't be removed (and so live longer than 
> the interval defined in test-slony-state)
>> As long as they don't produce any events, that's not much of a problem. 
>> But it is better to discover such before attempting to use that node as 
>> a failover target or the like.
>>   
> in this case the event must have been confirmed to not be taken into 
> account.

I don't care much about that one old event. It does no harm other than 
currently confusing test_slony_state. What I worry about is attempting 
to failover in the case of emergency with an only half functioning path 
network.


Jan


>>
>> Jan
>>
>>
>>   
>>> Jan Wieck a ?crit :
>>>     
>>>> On 5/20/2010 10:48 AM, Cyril Scetbon wrote:
>>>>   
>>>>       
>>>>> But this is a receiver and I saw in the code of  function 
>>>>> generate_sync_event that it does not generate sync interval on a node 
>>>>> which is not the origin of a set. That's why I presume there is no sync 
>>>>> created except the one created at startup (mandatory) in syncThread_main :
>>>>>     
>>>>>         
>>>>  From the CVS log:
>>>>
>>>>   
>>>>       
>>>>> ----------------------------
>>>>> revision 1.19
>>>>> date: 2007-03-14 15:59:32 +0000;  author: cbbrowne;  state: Exp;  lines: +20 -6;
>>>>> Reduce the quantity of spurious events generated:
>>>>>
>>>>> 1.  generate_sync_event() only needs to generate a SYNC on a node
>>>>>     that is the origin for a set
>>>>>
>>>>> 2.  sync thread generates a SYNC when it starts; in later iterations,
>>>>>     it will only generate a SYNC for its node if that node is the origin
>>>>>     for a replication set
>>>>>
>>>>> Per discussions with Jan Wieck on 2007-02-09; this seemed an experiment
>>>>> worth trying.  I tried it, and the tests run fine, so I'm committing this.
>>>>> ----------------------------
>>>>>     
>>>>>         
>>>> Seems we finally found a reason why this isn't such a good idea after 
>>>> all. Question now is do we want to revert back to the default, where 
>>>> slon's of pure receivers create useless SYNC events or not?
>>>>
>>>>
>>>> Jan
>>>>
>>>>   
>>>>       
>>
>>
>>   
> 


-- 
Anyone who trades liberty for security deserves neither
liberty nor security. -- Benjamin Franklin

From cscetbon.ext at orange-ftgroup.com  Fri May 21 07:42:29 2010
From: cscetbon.ext at orange-ftgroup.com (Cyril Scetbon)
Date: Fri, 21 May 2010 16:42:29 +0200
Subject: [Slony1-general] [Slony1-bugs] An old event not confirmed: A
 possible bug?
In-Reply-To: <4BF5E4B9.9020308@Yahoo.com>
References: <AANLkTikflK7G1bHIJjQLynJ-VZIwhAvAWazUNqyFQm5i@mail.gmail.com>	<4BEAC184.1000702@Yahoo.com>	<4BF53A9B.7020103@orange-ftgroup.com>	<4BF4A561.2050909@Yahoo.com>	<4BF54BBA.2050101@orange-ftgroup.com>	<4BF4C1E3.1050206@Yahoo.com>	<4BF6487C.3040107@orange-ftgroup.com>
	<4BF57E71.50708@Yahoo.com>	<4BF67AFF.5020006@orange-ftgroup.com>
	<4BF5E4B9.9020308@Yahoo.com>
Message-ID: <4BF69BD5.5010204@orange-ftgroup.com>



Jan Wieck a ?crit :
> On 5/21/2010 8:22 AM, Cyril Scetbon wrote:
>   
>> Jan Wieck a ?crit :
>>     
>>> On 5/21/2010 4:46 AM, Cyril Scetbon wrote:
>>>   
>>>       
>>>> the fastest fix is to modify test_slony_state.pl to not take into 
>>>> account events or confirms done for the initial SYNC on a receiver node.
>>>>     
>>>>         
>>> Wouldn't that mask problems where confirmations don't flow properly back 
>>> to non-origin nodes?
>>>   
>>>       
>> if we don't take into account the event (SYNC) created on a non-origin 
>> node but confirmed by others what could it mask ? everything worked fine 
>> and as this the last event it won't be removed (and so live longer than 
>> the interval defined in test-slony-state)
>>     
>>> As long as they don't produce any events, that's not much of a problem. 
>>> But it is better to discover such before attempting to use that node as 
>>> a failover target or the like.
>>>   
>>>       
>> in this case the event must have been confirmed to not be taken into 
>> account.
>>     
>
> I don't care much about that one old event. It does no harm other than 
> currently confusing test_slony_state. What I worry about is attempting 
> to failover in the case of emergency with an only half functioning path 
> network.
>   
I don't really understand the issue you're talking about... Certainly 
I've a weak knowledge of your code :)
You're talking about missing errors in network cause there are no SYNC 
generated on a receiver ? If yes, if it confirms events from others it's 
not enough to say that everything works ?
>
> Jan
>
>
>   
>>> Jan
>>>
>>>
>>>   
>>>       
>>>> Jan Wieck a ?crit :
>>>>     
>>>>         
>>>>> On 5/20/2010 10:48 AM, Cyril Scetbon wrote:
>>>>>   
>>>>>       
>>>>>           
>>>>>> But this is a receiver and I saw in the code of  function 
>>>>>> generate_sync_event that it does not generate sync interval on a node 
>>>>>> which is not the origin of a set. That's why I presume there is no sync 
>>>>>> created except the one created at startup (mandatory) in syncThread_main :
>>>>>>     
>>>>>>         
>>>>>>             
>>>>>  From the CVS log:
>>>>>
>>>>>   
>>>>>       
>>>>>           
>>>>>> ----------------------------
>>>>>> revision 1.19
>>>>>> date: 2007-03-14 15:59:32 +0000;  author: cbbrowne;  state: Exp;  lines: +20 -6;
>>>>>> Reduce the quantity of spurious events generated:
>>>>>>
>>>>>> 1.  generate_sync_event() only needs to generate a SYNC on a node
>>>>>>     that is the origin for a set
>>>>>>
>>>>>> 2.  sync thread generates a SYNC when it starts; in later iterations,
>>>>>>     it will only generate a SYNC for its node if that node is the origin
>>>>>>     for a replication set
>>>>>>
>>>>>> Per discussions with Jan Wieck on 2007-02-09; this seemed an experiment
>>>>>> worth trying.  I tried it, and the tests run fine, so I'm committing this.
>>>>>> ----------------------------
>>>>>>     
>>>>>>         
>>>>>>             
>>>>> Seems we finally found a reason why this isn't such a good idea after 
>>>>> all. Question now is do we want to revert back to the default, where 
>>>>> slon's of pure receivers create useless SYNC events or not?
>>>>>
>>>>>
>>>>> Jan
>>>>>
>>>>>   
>>>>>       
>>>>>           
>>>   
>>>       
>
>
>   

-- 
Cyril SCETBON

From JanWieck at Yahoo.com  Thu May 20 22:24:52 2010
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Fri, 21 May 2010 01:24:52 -0400
Subject: [Slony1-general] [Slony1-bugs] An old event not confirmed: A
 possible bug?
In-Reply-To: <4BF69BD5.5010204@orange-ftgroup.com>
References: <AANLkTikflK7G1bHIJjQLynJ-VZIwhAvAWazUNqyFQm5i@mail.gmail.com>	<4BEAC184.1000702@Yahoo.com>	<4BF53A9B.7020103@orange-ftgroup.com>	<4BF4A561.2050909@Yahoo.com>	<4BF54BBA.2050101@orange-ftgroup.com>	<4BF4C1E3.1050206@Yahoo.com>	<4BF6487C.3040107@orange-ftgroup.com>	<4BF57E71.50708@Yahoo.com>	<4BF67AFF.5020006@orange-ftgroup.com>	<4BF5E4B9.9020308@Yahoo.com>
	<4BF69BD5.5010204@orange-ftgroup.com>
Message-ID: <4BF61924.6010806@Yahoo.com>

On 5/21/2010 10:42 AM, Cyril Scetbon wrote:
> 
> Jan Wieck a ?crit :
>> I don't care much about that one old event. It does no harm other than 
>> currently confusing test_slony_state. What I worry about is attempting 
>> to failover in the case of emergency with an only half functioning path 
>> network.
>>   
> I don't really understand the issue you're talking about... Certainly 
> I've a weak knowledge of your code :)
> You're talking about missing errors in network cause there are no SYNC 
> generated on a receiver ? If yes, if it confirms events from others it's 
> not enough to say that everything works ?

Let me try to explain the problem.

In a multi node cluster, not every node necessarily needs to be able to 
talk to every other node. Let us just look at a cascaded 3 node cluster:

     1 - 2 - 3

This setup requires 4 sl_path entries to work:

     server=1, client=2
     server=2, client=1
     server=2, client=3
     server=3, client=2

And it is supposed to generate the following sl_listen rows:

     origin=1, receiver=2, provider=1
     origin=1, receiver=3, provider=2
     origin=2, receiver=1, provider=2
     origin=2, receiver=3, provider=2
     origin=3, receiver=1, provider=2
     origin=3, receiver=2, provider=3

It does not matter which node is currently the origin of any set at all. 
All these paths and connections are important for the health and well 
being of the Slony cluster. If for example the listening for events from 
2, receiver=3 would be broken, then node 3 would still perfectly fine 
replicate data originating from 1. But as soon as you move set to node 
2, it would start falling behind and you effectively lose your second 
level backup.

This is why Slony originally created a SYNC on EVERY node at least every 
10 seconds. Just so there is some harmless event passing going on to 
have something to monitor and keep sl_status looking good.

That is what got removed and that is what I think we should put back.


Jan

-- 
Anyone who trades liberty for security deserves neither
liberty nor security. -- Benjamin Franklin

From ssinger at ca.afilias.info  Fri May 21 11:13:24 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Fri, 21 May 2010 14:13:24 -0400
Subject: [Slony1-general] [Slony1-bugs] An old event not confirmed: A
 possible bug?
In-Reply-To: <4BF61924.6010806@Yahoo.com>
References: <AANLkTikflK7G1bHIJjQLynJ-VZIwhAvAWazUNqyFQm5i@mail.gmail.com>	<4BEAC184.1000702@Yahoo.com>	<4BF53A9B.7020103@orange-ftgroup.com>	<4BF4A561.2050909@Yahoo.com>	<4BF54BBA.2050101@orange-ftgroup.com>	<4BF4C1E3.1050206@Yahoo.com>	<4BF6487C.3040107@orange-ftgroup.com>	<4BF57E71.50708@Yahoo.com>	<4BF67AFF.5020006@orange-ftgroup.com>	<4BF5E4B9.9020308@Yahoo.com>	<4BF69BD5.5010204@orange-ftgroup.com>
	<4BF61924.6010806@Yahoo.com>
Message-ID: <4BF6CD44.2070408@ca.afilias.info>

Jan Wieck wrote:
> On 5/21/2010 10:42 AM, Cyril Scetbon wrote:

> This is why Slony originally created a SYNC on EVERY node at least every 
> 10 seconds. Just so there is some harmless event passing going on to 
> have something to monitor and keep sl_status looking good.
> 
> That is what got removed and that is what I think we should put back.

I'm inclined to agree, I have opened a bug on this.
http://bugs.slony.info/bugzilla/show_bug.cgi?id=127

Though I'm not sure if we want to change this in 1.2.x or just look into 
changing this in 2.0


> 
> 
> Jan
> 


-- 
Steve Singer
Afilias Canada
Data Services Developer
416-673-1142

From samn at consistentstate.com  Fri May 21 15:21:00 2010
From: samn at consistentstate.com (Sam Nelson)
Date: Fri, 21 May 2010 17:21:00 -0500 (CDT)
Subject: [Slony1-general] Failover with more than two nodes
Message-ID: <1274480460.v2.mailanyonewebmail-591536@fuse114>

I'm trying to run a failover on a three node cluster (for testing purposes) and it doesn't seem to be working, no matter how I try it.

I've tried running the following in slonik:

node 1 admin conninfo = 'dbname=$dbname host=$host1 port=$port user=$user ';
node 2 admin conninfo = 'dbname=$dbname host=$host2 port=$port user=$user ';
node 3 admin conninfo = 'dbname=$dbname host=$host3 port=$port user=$user ';

echo 'Failing over...';

failover (id = 1, backup node = 2);
echo 'Dropping node 1...';
drop node (id = 1, event node = 2);
echo 'Failover complete';

I have also tried to (as per the &quot;Failover With Complex Node Set&quot; instructions) run subscribe set to update the subscription info for other nodes before failing over to node 2, but the subscribe set command fails with &quot;could not connect to server: Connection refused&quot; (even though none of the nodes used in the subscribe set command are the master node).  So I went back to just running failover and letting the failover function take care of subscribing nodes and junk.

The results have been ... well, they have been sort of random.  It does occasionally seem to report a successful run, but even then, node 3 usually has some incorrect information about the new structure of the cluster.  The most common ocurrance (and the only one I have logs for), though, is that I receive the following output from the above slonik commands:

>;stdin;stdin;stdin
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20100521/e959bfd1/attachment.htm 

From singh.gurjeet at gmail.com  Fri May 21 19:24:03 2010
From: singh.gurjeet at gmail.com (Gurjeet Singh)
Date: Fri, 21 May 2010 22:24:03 -0400
Subject: [Slony1-general] [Slony1-bugs] An old event not confirmed: A
	possible bug?
In-Reply-To: <4BF61924.6010806@Yahoo.com>
References: <AANLkTikflK7G1bHIJjQLynJ-VZIwhAvAWazUNqyFQm5i@mail.gmail.com> 
	<4BF4A561.2050909@Yahoo.com> <4BF54BBA.2050101@orange-ftgroup.com> 
	<4BF4C1E3.1050206@Yahoo.com> <4BF6487C.3040107@orange-ftgroup.com> 
	<4BF57E71.50708@Yahoo.com> <4BF67AFF.5020006@orange-ftgroup.com> 
	<4BF5E4B9.9020308@Yahoo.com> <4BF69BD5.5010204@orange-ftgroup.com> 
	<4BF61924.6010806@Yahoo.com>
Message-ID: <AANLkTilEswv3JiTG4mhPpQoNhmMw8kZctY0csQp3gSoo@mail.gmail.com>

On Fri, May 21, 2010 at 1:24 AM, Jan Wieck <JanWieck at yahoo.com> wrote:

>
> In a multi node cluster, not every node necessarily needs to be able to
> talk to every other node. Let us just look at a cascaded 3 node cluster:
>
>     1 - 2 - 3
>
> This setup requires 4 sl_path entries to work:
>
>     server=1, client=2
>     server=2, client=1
>     server=2, client=3
>     server=3, client=2
>
> And it is supposed to generate the following sl_listen rows:
>
>     origin=1, receiver=2, provider=1
>     origin=1, receiver=3, provider=2
>     origin=2, receiver=1, provider=2
>     origin=2, receiver=3, provider=2
>     origin=3, receiver=1, provider=2
>     origin=3, receiver=2, provider=3
>
> It does not matter which node is currently the origin of any set at all.
> All these paths and connections are important for the health and well
> being of the Slony cluster. If for example the listening for events from
> 2, receiver=3 would be broken, then node 3 would still perfectly fine
> replicate data originating from 1. But as soon as you move set to node
> 2, it would start falling behind and you effectively lose your second
> level backup.
>
> This is why Slony originally created a SYNC on EVERY node at least every
> 10 seconds. Just so there is some harmless event passing going on to
> have something to monitor and keep sl_status looking good.
>
> That is what got removed and that is what I think we should put back.
>
>
This is exactly the kind of Slony black magic I want to understand. Do we
have someplace where we can get these internals of Slony, or design specs;
or would you suggest diving into code?

Regards,
-- 
gurjeet.singh
@ EnterpriseDB - The Enterprise Postgres Company
http://www.enterprisedb.com

singh.gurjeet@{ gmail | yahoo }.com
Twitter/Skype: singh_gurjeet

Mail sent from my BlackLaptop device
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20100521/da6929e5/attachment.htm 

From ssinger_pg at sympatico.ca  Sat May 22 19:24:02 2010
From: ssinger_pg at sympatico.ca (Steve Singer)
Date: Sat, 22 May 2010 22:24:02 -0400 (EDT)
Subject: [Slony1-general] [Slony1-bugs] An old event not confirmed: A
 possible bug?
In-Reply-To: <AANLkTilEswv3JiTG4mhPpQoNhmMw8kZctY0csQp3gSoo@mail.gmail.com>
References: <AANLkTikflK7G1bHIJjQLynJ-VZIwhAvAWazUNqyFQm5i@mail.gmail.com> 
	<4BF4A561.2050909@Yahoo.com> <4BF54BBA.2050101@orange-ftgroup.com> 
	<4BF4C1E3.1050206@Yahoo.com> <4BF6487C.3040107@orange-ftgroup.com> 
	<4BF57E71.50708@Yahoo.com> <4BF67AFF.5020006@orange-ftgroup.com> 
	<4BF5E4B9.9020308@Yahoo.com> <4BF69BD5.5010204@orange-ftgroup.com> 
	<4BF61924.6010806@Yahoo.com>
	<AANLkTilEswv3JiTG4mhPpQoNhmMw8kZctY0csQp3gSoo@mail.gmail.com>
Message-ID: <BLU0-SMTP973C68B6F2FF054CC83E41ACE60@phx.gbl>

On Fri, 21 May 2010, Gurjeet Singh wrote:

> This is exactly the kind of Slony black magic I want to understand. Do we
> have someplace where we can get these internals of Slony, or design specs;
> or would you suggest diving into code?

The original design document is available 
http://developer.postgresql.org/%7Ewieck/slony1/Slony-I-concept.pdf though 
some of the information does seem dated in it and might not reflect the 
current reality.

It is worth your time to give the admin guide a good reading though it isn't 
going to explain everything you want in a clear manner.

I often find myself tracing through the slony code (particularly 
remote_worker.c, slonik.c and the slony1_funcs.sql) to figure out  how 
something actually works.   I sometimes find the best way for me to confirm 
that I understand something is to try and describe it, so I've published a 
blog post on how subscribe set works 
(http://scanningpages.wordpress.com/2010/05/22/slony-subscribe-set-explained/) 
I plan on doing this for a few more slony concepts as I get around to it.

You should also feel free to ask questions on the list about how something 
works.  There is a desire to increase the number of people familiar with 
slony internals (and ideally increase the number of developers contributing 
to slony).  Questions asking how things work internally in slony will 
probably be replied to (though it might take a few days depending on who has 
the ability to reply)


Steve



>
> Regards,
> -- 
> gurjeet.singh
> @ EnterpriseDB - The Enterprise Postgres Company
> http://www.enterprisedb.com
>
> singh.gurjeet@{ gmail | yahoo }.com
> Twitter/Skype: singh_gurjeet
>
> Mail sent from my BlackLaptop device
>


From ssinger_pg at sympatico.ca  Sat May 22 19:48:45 2010
From: ssinger_pg at sympatico.ca (Steve Singer)
Date: Sat, 22 May 2010 22:48:45 -0400 (EDT)
Subject: [Slony1-general] Failover with more than two nodes
In-Reply-To: <1274480460.v2.mailanyonewebmail-591536@fuse114>
References: <1274480460.v2.mailanyonewebmail-591536@fuse114>
Message-ID: <BLU0-SMTP182CC957BE88BF95C1470CACE60@phx.gbl>

On Fri, 21 May 2010, Sam Nelson wrote:


It would be useful to know

1) What version of slony are you using (I'm guessing 1.2.x since other folks 
from consistent state have mentioned that)

2) What paths have you created.

'could not connect to server: Connection refused' makes me think that you 
have a typo in a hostname or port somewhere possibly when you did a store 
path.  Before doing the failover it would be worth while to look at the 
sl_path table on each of your nodes to make sure it looks as you expect 
(sometimes when slonik scripts are generated through shell scripts an error 
in the shell substitution can mean that the slonik script that got executed 
isn't exactly what you through you were executing)

The error you quote below from RebuildListenEntries() indicates that slony 
is trying to build the sl_listen entries based on the contents of sl_path 
but is having a problem (a null value).  I would double check what sl_path 
has as a next step.


> I'm trying to run a failover on a three node cluster (for testing 
> purposes) and it doesn't seem to be working, no matter how I try it.
>
> I've tried running the following in slonik:
>
> node 1 admin conninfo = 'dbname=$dbname host=$host1 port=$port user=$user 
> '; node 2 admin conninfo = 'dbname=$dbname host=$host2 port=$port 
> user=$user '; node 3 admin conninfo = 'dbname=$dbname host=$host3 
> port=$port user=$user ';
>
> echo 'Failing over...';
>
> failover (id = 1, backup node = 2);
> echo 'Dropping node 1...';
> drop node (id = 1, event node = 2);
> echo 'Failover complete';
>
> I have also tried to (as per the &quot;Failover With Complex Node 
> Set&quot; instructions) run subscribe set to update the subscription info 
> for other nodes before failing over to node 2, but the subscribe set 
> command fails with &quot;could not connect to server: Connection 
> refused&quot; (even though none of the nodes used in the subscribe set 
> command are the master node).  So I went back to just running failover and 
> letting the failover function take care of subscribing nodes and junk.
>
> The results have been ... well, they have been sort of random.  It does 
> occasionally seem to report a successful run, but even then, node 3 
> usually has some incorrect information about the new structure of the 
> cluster.  The most common ocurrance (and the only one I have logs for), 
> though, is that I receive the following output from the above slonik 
> commands:
>
>> ;stdin;stdin;stdin


From david at fetter.org  Sun May 23 06:40:20 2010
From: david at fetter.org (David Fetter)
Date: Sun, 23 May 2010 06:40:20 -0700
Subject: [Slony1-general] Slony 2.0.3 caveats?
Message-ID: <20100523134020.GA23842@fetter.org>

Folks,

What exactly is it that might keep someone from deploying 2.0.3, apart
from features not promised in 2.0x?

Cheers,
David.
-- 
David Fetter <david at fetter.org> http://fetter.org/
Phone: +1 415 235 3778  AIM: dfetter666  Yahoo!: dfetter
Skype: davidfetter      XMPP: david.fetter at gmail.com
iCal: webcal://www.tripit.com/feed/ical/people/david74/tripit.ics

Remember to vote!
Consider donating to Postgres: http://www.postgresql.org/about/donate

From ssinger_pg at sympatico.ca  Sun May 23 05:51:40 2010
From: ssinger_pg at sympatico.ca (Steve Singer)
Date: Sun, 23 May 2010 08:51:40 -0400 (EDT)
Subject: [Slony1-general] Slony 2.0.3 caveats?
In-Reply-To: <20100523134020.GA23842@fetter.org>
References: <20100523134020.GA23842@fetter.org>
Message-ID: <BLU0-SMTP10044026CCAEAF574B997D3ACE60@phx.gbl>

On Sun, 23 May 2010, David Fetter wrote:

> Folks,
>
> What exactly is it that might keep someone from deploying 2.0.3, apart
> from features not promised in 2.0x?

See this thread 
http://lists.slony.info/pipermail/slony1-general/2010-April/010596.html 
(fixed in cvs).  Note that this problem isn't specific to utf8 data in any 
character set can suffer the corruption.

Also Bug # 119 makes CLONE FINISH unuseable in practice (also fixed in cvs)



>
> Cheers,
> David.
> -- 
> David Fetter <david at fetter.org> http://fetter.org/
> Phone: +1 415 235 3778  AIM: dfetter666  Yahoo!: dfetter
> Skype: davidfetter      XMPP: david.fetter at gmail.com
> iCal: webcal://www.tripit.com/feed/ical/people/david74/tripit.ics
>
> Remember to vote!
> Consider donating to Postgres: http://www.postgresql.org/about/donate
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
>


From david at fetter.org  Sun May 23 06:55:58 2010
From: david at fetter.org (David Fetter)
Date: Sun, 23 May 2010 06:55:58 -0700
Subject: [Slony1-general] Slony triggers included in pg_dump
In-Reply-To: <4BF191B9.5000607@ca.afilias.info>
References: <AANLkTik3kuhrTf7xiy5ylZi-N4AprDvtBP831Il6oxhS@mail.gmail.com>
	<4BF002D6.3030805@ca.afilias.info>
	<AANLkTilq9QncnLfnHKwS3YEr3sELyzEHHTMFZrHqdN6b@mail.gmail.com>
	<4BF191B9.5000607@ca.afilias.info>
Message-ID: <20100523135558.GB23842@fetter.org>

On Mon, May 17, 2010 at 02:58:01PM -0400, Steve Singer wrote:
> Gurjeet Singh wrote:
> 
> > The doc-patch does make it more clear, but I don't think DROP
> > SCHEMA _slony_cluster_name CASCADE is something I'd like to do
> > with my running Slony replication. A cleaner way would be more
> > desirable.
> 
> Another option you have is to restore the dump that you create of
> your pgbench schema to another database(a new one).  When you
> restore the CREATE TRIGGER statements will fail because the slony
> stored procedures won't exist in your new database.   This should
> leave you with your database - any slony stuff.  (I agree having to
> put up with 'errors' during the restore or make a second copy of the
> database just to do 'DROP SCHEMA' are both less than ideal
> solutions)

Would it help if some future version of pg_dump had some option to the
effect of, "leave out the following objects and everything that
depends on them?"

Cheers,
David.
-- 
David Fetter <david at fetter.org> http://fetter.org/
Phone: +1 415 235 3778  AIM: dfetter666  Yahoo!: dfetter
Skype: davidfetter      XMPP: david.fetter at gmail.com
iCal: webcal://www.tripit.com/feed/ical/people/david74/tripit.ics

Remember to vote!
Consider donating to Postgres: http://www.postgresql.org/about/donate

From david at fetter.org  Sun May 23 07:28:07 2010
From: david at fetter.org (David Fetter)
Date: Sun, 23 May 2010 07:28:07 -0700
Subject: [Slony1-general] Slony 2.0.3 caveats?
In-Reply-To: <BLU0-SMTP10044026CCAEAF574B997D3ACE60@phx.gbl>
References: <20100523134020.GA23842@fetter.org>
	<BLU0-SMTP10044026CCAEAF574B997D3ACE60@phx.gbl>
Message-ID: <20100523142806.GC23842@fetter.org>

On Sun, May 23, 2010 at 08:51:40AM -0400, Steve Singer wrote:
> On Sun, 23 May 2010, David Fetter wrote:
> 
> >Folks,
> >
> >What exactly is it that might keep someone from deploying 2.0.3, apart
> >from features not promised in 2.0x?
> 
> See this thread http://lists.slony.info/pipermail/slony1-general/2010-April/010596.html
> (fixed in cvs).  Note that this problem isn't specific to utf8 data
> in any character set can suffer the corruption.
> 
> Also Bug # 119 makes CLONE FINISH unuseable in practice (also fixed in cvs)

Do we have an ETA on Slony 2.0.4?

Whatever it is, how can people help get it out sooner?

Cheers,
David.
-- 
David Fetter <david at fetter.org> http://fetter.org/
Phone: +1 415 235 3778  AIM: dfetter666  Yahoo!: dfetter
Skype: davidfetter      XMPP: david.fetter at gmail.com
iCal: webcal://www.tripit.com/feed/ical/people/david74/tripit.ics

Remember to vote!
Consider donating to Postgres: http://www.postgresql.org/about/donate

From JanWieck at Yahoo.com  Sun May 23 07:30:44 2010
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Sun, 23 May 2010 10:30:44 -0400
Subject: [Slony1-general] Slony 2.0.3 caveats?
In-Reply-To: <20100523142806.GC23842@fetter.org>
References: <20100523134020.GA23842@fetter.org>	<BLU0-SMTP10044026CCAEAF574B997D3ACE60@phx.gbl>
	<20100523142806.GC23842@fetter.org>
Message-ID: <4BF93C14.8070607@Yahoo.com>

On 5/23/2010 10:28 AM, David Fetter wrote:

> Whatever it is, how can people help get it out sooner?

Testing, reporting and/or fixing bugs.


Jan

-- 
Anyone who trades liberty for security deserves neither
liberty nor security. -- Benjamin Franklin

From JanWieck at Yahoo.com  Sun May 23 07:40:07 2010
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Sun, 23 May 2010 10:40:07 -0400
Subject: [Slony1-general] Slony triggers included in pg_dump
In-Reply-To: <20100523135558.GB23842@fetter.org>
References: <AANLkTik3kuhrTf7xiy5ylZi-N4AprDvtBP831Il6oxhS@mail.gmail.com>	<4BF002D6.3030805@ca.afilias.info>	<AANLkTilq9QncnLfnHKwS3YEr3sELyzEHHTMFZrHqdN6b@mail.gmail.com>	<4BF191B9.5000607@ca.afilias.info>
	<20100523135558.GB23842@fetter.org>
Message-ID: <4BF93E47.7010902@Yahoo.com>

On 5/23/2010 9:55 AM, David Fetter wrote:
> On Mon, May 17, 2010 at 02:58:01PM -0400, Steve Singer wrote:
>> Gurjeet Singh wrote:
>> 
>> > The doc-patch does make it more clear, but I don't think DROP
>> > SCHEMA _slony_cluster_name CASCADE is something I'd like to do
>> > with my running Slony replication. A cleaner way would be more
>> > desirable.
>> 
>> Another option you have is to restore the dump that you create of
>> your pgbench schema to another database(a new one).  When you
>> restore the CREATE TRIGGER statements will fail because the slony
>> stored procedures won't exist in your new database.   This should
>> leave you with your database - any slony stuff.  (I agree having to
>> put up with 'errors' during the restore or make a second copy of the
>> database just to do 'DROP SCHEMA' are both less than ideal
>> solutions)
> 
> Would it help if some future version of pg_dump had some option to the
> effect of, "leave out the following objects and everything that
> depends on them?"

That would certainly help and it is a more general use case, not 
something specific to Slony. If you have this

> create schema s1;
> create schema s2;
> create table s1.t1 (id integer primary key, data text);
> create table s2.t2 (id integer primary key, id1 integer references s1.t1 (id));

and then do a pg_dump -n s2, your dump will still contain

> --
> -- Name: t2_id1_fkey; Type: FK CONSTRAINT; Schema: s2; Owner: -
> --
> 
> ALTER TABLE ONLY t2
>     ADD CONSTRAINT t2_id1_fkey FOREIGN KEY (id1) REFERENCES s1.t1(id);

Fortunately, the foreign key in the dump is separated out so that the 
CREATE TABLE still succeeds, but you get an error message here as well.


Jan

-- 
Anyone who trades liberty for security deserves neither
liberty nor security. -- Benjamin Franklin

From david at fetter.org  Sun May 23 08:34:54 2010
From: david at fetter.org (David Fetter)
Date: Sun, 23 May 2010 08:34:54 -0700
Subject: [Slony1-general] Slony 2.0.3 caveats?
In-Reply-To: <4BF93C14.8070607@Yahoo.com>
References: <20100523134020.GA23842@fetter.org>
	<BLU0-SMTP10044026CCAEAF574B997D3ACE60@phx.gbl>
	<20100523142806.GC23842@fetter.org> <4BF93C14.8070607@Yahoo.com>
Message-ID: <20100523153454.GA32373@fetter.org>

On Sun, May 23, 2010 at 10:30:44AM -0400, Jan Wieck wrote:
> On 5/23/2010 10:28 AM, David Fetter wrote:
> 
> >Whatever it is, how can people help get it out sooner?
> 
> Testing, reporting and/or fixing bugs.

What are the gating issues as you see them for 2.0.4?  I'm asking
because I'm sure I'm not alone in that there are outfits which will
not, under any circumstances, deploy from CVS HEAD.

Cheers,
David.
-- 
David Fetter <david at fetter.org> http://fetter.org/
Phone: +1 415 235 3778  AIM: dfetter666  Yahoo!: dfetter
Skype: davidfetter      XMPP: david.fetter at gmail.com
iCal: webcal://www.tripit.com/feed/ical/people/david74/tripit.ics

Remember to vote!
Consider donating to Postgres: http://www.postgresql.org/about/donate

From ssinger_pg at sympatico.ca  Sun May 23 08:33:57 2010
From: ssinger_pg at sympatico.ca (Steve Singer)
Date: Sun, 23 May 2010 11:33:57 -0400 (EDT)
Subject: [Slony1-general] Slony 2.0.3 caveats?
In-Reply-To: <20100523153454.GA32373@fetter.org>
References: <20100523134020.GA23842@fetter.org>
	<BLU0-SMTP10044026CCAEAF574B997D3ACE60@phx.gbl>
	<20100523142806.GC23842@fetter.org> <4BF93C14.8070607@Yahoo.com>
	<20100523153454.GA32373@fetter.org>
Message-ID: <BLU0-SMTP24EEE3FD941055995F95A5ACE60@phx.gbl>

On Sun, 23 May 2010, David Fetter wrote:

> On Sun, May 23, 2010 at 10:30:44AM -0400, Jan Wieck wrote:
>> On 5/23/2010 10:28 AM, David Fetter wrote:
>>
>>> Whatever it is, how can people help get it out sooner?
>>
>> Testing, reporting and/or fixing bugs.
>
> What are the gating issues as you see them for 2.0.4?  I'm asking
> because I'm sure I'm not alone in that there are outfits which will
> not, under any circumstances, deploy from CVS HEAD.

My inclination is that someone (maybe Jan or Chris) should review

The OSX 
patches 
(http://lists.slony.info/pipermail/slony1-patches/2010-May/000065.html)

and I think one or two unapplied patches that are also outstanding.

We can then tag a 2.0.4 RC and have some people actually test it.  If we get 
feedback that 2.0.4 RC is better than 2.0.3 and fixes all the major issues 
we know about then we can release 2.0.4

I'm sure we'll find more issues for a 2.0.5 in the coming months but at 
least we have done better than 2.0.3



>
> Cheers,
> David.
> -- 
> David Fetter <david at fetter.org> http://fetter.org/
> Phone: +1 415 235 3778  AIM: dfetter666  Yahoo!: dfetter
> Skype: davidfetter      XMPP: david.fetter at gmail.com
> iCal: webcal://www.tripit.com/feed/ical/people/david74/tripit.ics
>
> Remember to vote!
> Consider donating to Postgres: http://www.postgresql.org/about/donate
>


From JanWieck at Yahoo.com  Sun May 23 12:03:57 2010
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Sun, 23 May 2010 15:03:57 -0400
Subject: [Slony1-general] Slony 2.0.3 caveats?
In-Reply-To: <BLU0-SMTP24EEE3FD941055995F95A5ACE60@phx.gbl>
References: <20100523134020.GA23842@fetter.org>
	<BLU0-SMTP10044026CCAEAF574B997D3ACE60@phx.gbl>
	<20100523142806.GC23842@fetter.org> <4BF93C14.8070607@Yahoo.com>
	<20100523153454.GA32373@fetter.org>
	<BLU0-SMTP24EEE3FD941055995F95A5ACE60@phx.gbl>
Message-ID: <4BF97C1D.3080208@Yahoo.com>

On 5/23/2010 11:33 AM, Steve Singer wrote:
> On Sun, 23 May 2010, David Fetter wrote:
> 
>> On Sun, May 23, 2010 at 10:30:44AM -0400, Jan Wieck wrote:
>>> On 5/23/2010 10:28 AM, David Fetter wrote:
>>>
>>>> Whatever it is, how can people help get it out sooner?
>>>
>>> Testing, reporting and/or fixing bugs.
>>
>> What are the gating issues as you see them for 2.0.4?  I'm asking
>> because I'm sure I'm not alone in that there are outfits which will
>> not, under any circumstances, deploy from CVS HEAD.
> 
> My inclination is that someone (maybe Jan or Chris) should review
> 
> The OSX 
> patches 
> (http://lists.slony.info/pipermail/slony1-patches/2010-May/000065.html)
> 
> and I think one or two unapplied patches that are also outstanding.
> 
> We can then tag a 2.0.4 RC and have some people actually test it.  If we get 
> feedback that 2.0.4 RC is better than 2.0.3 and fixes all the major issues 
> we know about then we can release 2.0.4
> 
> I'm sure we'll find more issues for a 2.0.5 in the coming months but at 
> least we have done better than 2.0.3

Before tagging 2.0.4 I want to go over some of the bugs that are open 
and have the sporadic SYNC on non-origins back, since it seems to be 
what causes bug 92.


Jan

-- 
Anyone who trades liberty for security deserves neither
liberty nor security. -- Benjamin Franklin

From brendanh at jims.net  Sun May 23 20:54:26 2010
From: brendanh at jims.net (Brendan Hill)
Date: Mon, 24 May 2010 13:54:26 +1000
Subject: [Slony1-general] Sending notification on replication problem
Message-ID: <012901cafaf4$da404610$8ec0d230$@net>

Hi all,

 

I've googled this to no avail.

 

How can I configure Slony to send some notification - an email, call a URL,
run a program, flash something red on the screen, anything whatsoever - if
it encounters a replication problem?

 

We discovered a problem this morning - a field had been added to the master
database but not the slave database. Slony ceased replicating
(understandably) but offered no notification. We discovered this about 12
hours later when people started reporting problems.

 

We're building a custom solution to poll both databases and alert us if
replication is broken, but is there something in Slony to alert on error?

 

-Brendan

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20100524/6861a60c/attachment.htm 

From peter.geoghegan86 at gmail.com  Mon May 24 05:09:05 2010
From: peter.geoghegan86 at gmail.com (Peter Geoghegan)
Date: Mon, 24 May 2010 13:09:05 +0100
Subject: [Slony1-general] Sending notification on replication problem
In-Reply-To: <012901cafaf4$da404610$8ec0d230$@net>
References: <012901cafaf4$da404610$8ec0d230$@net>
Message-ID: <AANLkTiksAdmHLZawsyI5uYPnj_Qm8TNybPG8vciBOYkj@mail.gmail.com>

> We discovered a problem this morning ? a field had been added to the master
> database but not the slave database. Slony ceased replicating
> (understandably) but offered no notification. We discovered this about 12
> hours later when people started reporting problems.

In case you aren't aware of this, you should have done a SLONIK
EXECUTE SCRIPT to add a new column to a replicated table. DDL triggers
are sort of on the agenda for Postgres 9.1 - Jan Wieck has expressed
interest in implementing them - so there may come a day when what you
did actually does work, in a future version of Slony.

Slony explicitly disclaims responsibility for determining when
replication is broken in the case of failover. The docs say "Slony-I
does not provide any automatic detection for failed systems", and I
think that's applicable for your situation too. That said, it may be
possible to write a pl/perlu trigger on one of the tables in the
_your_replication_set schema, that sends notification when an event
backlog reaches some arbitrary threshold value. Perhaps one of the
Slony hackers can weigh in on this. However, this is just as ad-hoc as
what you're already doing, and I'm not sure it's an improvement at
all.

Regards,
Peter Geoghegan

From ssinger_pg at sympatico.ca  Mon May 24 05:05:17 2010
From: ssinger_pg at sympatico.ca (Steve Singer)
Date: Mon, 24 May 2010 08:05:17 -0400 (EDT)
Subject: [Slony1-general] Sending notification on replication problem
In-Reply-To: <012901cafaf4$da404610$8ec0d230$@net>
References: <012901cafaf4$da404610$8ec0d230$@net>
Message-ID: <BLU0-SMTP89B1C11BE81CD3E3071CE3ACE70@phx.gbl>

On Mon, 24 May 2010, Brendan Hill wrote:

> Hi all,
>
>
> How can I configure Slony to send some notification - an email, call a URL,
> run a program, flash something red on the screen, anything whatsoever - if
> it encounters a replication problem?

If you write a script/program (in perl,python,java etc..) to start your slon 
processes you have access to the stderr and stdout of the slon.  Your script 
can then scan each line of output for slon looking for useful error strings 
and send an alert.

You could even get complicated and run slon with enough debugging output so 
it logs the amount of tuples INSERT/UPDATE/DELETES replicated and log an error 
when that number is lower than you expect for too long.

I think there are monitoring frameworks that can monitor files (or syslog) 
to do this type of thing as well but if your not already using one it 
probably isn't worth your time to set one up just for this.

Another option is to monitor the lag on your sl_status on each of your 
nodes.  In the case you describe replication should have stopped so the lag 
numbers should be increasing (I think this is discussed in the slony manual 
and the check_slony_cluster.sh does this.




>
>
>
> We discovered a problem this morning - a field had been added to the master
> database but not the slave database. Slony ceased replicating
> (understandably) but offered no notification. We discovered this about 12
> hours later when people started reporting problems.
>
>
>
> We're building a custom solution to poll both databases and alert us if
> replication is broken, but is there something in Slony to alert on error?
>
>
>
> -Brendan
>
>


From greg at endpoint.com  Mon May 24 06:08:52 2010
From: greg at endpoint.com (Greg Sabino Mullane)
Date: Mon, 24 May 2010 09:08:52 -0400
Subject: [Slony1-general] Sending notification on replication problem
In-Reply-To: <012901cafaf4$da404610$8ec0d230$@net>
References: <012901cafaf4$da404610$8ec0d230$@net>
Message-ID: <20100524130851.GA32763@core.home>

> How can I configure Slony to send some notification ? an email, call a
> URL, run a program, flash something red on the screen, anything
> whatsoever ? if it encounters a replication problem?

That's outside the purview of Slony, but there are other simple ways 
to accomplish it. Easiest would probably be to use the check_postgres 
program with the "replication_row" or "slony_status" actions. If 
you already have Nagios, you'll be done in about five minutes.

http://bucardo.org/check_postgres/check_postgres.pl.html

-- 
Greg Sabino Mullane greg at endpoint.com
End Point Corporation
PGP Key: 0x14964AC8
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 163 bytes
Desc: not available
Url : http://lists.slony.info/pipermail/slony1-general/attachments/20100524/66732bde/attachment.pgp 

From david at fetter.org  Mon May 24 08:30:09 2010
From: david at fetter.org (David Fetter)
Date: Mon, 24 May 2010 08:30:09 -0700
Subject: [Slony1-general] Upgrade from 2.0.3
Message-ID: <20100524153009.GA4413@fetter.org>

Hello,

What's the minimum change needed from 2.0.3?  Specifically, is
replacing the slon binary enough, or does everything need to go?

Cheers,
David.
-- 
David Fetter <david at fetter.org> http://fetter.org/
Phone: +1 415 235 3778  AIM: dfetter666  Yahoo!: dfetter
Skype: davidfetter      XMPP: david.fetter at gmail.com
iCal: webcal://www.tripit.com/feed/ical/people/david74/tripit.ics

Remember to vote!
Consider donating to Postgres: http://www.postgresql.org/about/donate

From ssinger_pg at sympatico.ca  Mon May 24 08:13:48 2010
From: ssinger_pg at sympatico.ca (Steve Singer)
Date: Mon, 24 May 2010 11:13:48 -0400 (EDT)
Subject: [Slony1-general] Upgrade from 2.0.3
In-Reply-To: <20100524153009.GA4413@fetter.org>
References: <20100524153009.GA4413@fetter.org>
Message-ID: <BLU0-SMTP668371314E79A3A03000AFACE70@phx.gbl>

On Mon, 24 May 2010, David Fetter wrote:

> Hello,
>
> What's the minimum change needed from 2.0.3?  Specifically, is
> replacing the slon binary enough, or does everything need to go?



From bogus@does.not.exist.com  Wed May 12 20:23:46 2010
From: bogus@does.not.exist.com ()
Date: Thu, 13 May 2010 03:23:46 -0000
Subject: No subject
Message-ID: <mailman.0.1274717781.4667.slony1-general@lists.slony.info>

a) The slon binary for the data corruption bug

b) slony1_funcs.sql for bug # 119, if your planning on using CLONE FINISH 
(it's a 1 line change to one of plpgsql functions)

Everything checked in since 2.0.3 looks to be documentation related.



>
> Cheers,
> David.
> -- 
> David Fetter <david at fetter.org> http://fetter.org/
> Phone: +1 415 235 3778  AIM: dfetter666  Yahoo!: dfetter
> Skype: davidfetter      XMPP: david.fetter at gmail.com
> iCal: webcal://www.tripit.com/feed/ical/people/david74/tripit.ics
>
> Remember to vote!
> Consider donating to Postgres: http://www.postgresql.org/about/donate
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
>


From david at fetter.org  Mon May 24 10:16:28 2010
From: david at fetter.org (David Fetter)
Date: Mon, 24 May 2010 10:16:28 -0700
Subject: [Slony1-general] Upgrade from 2.0.3
In-Reply-To: <BLU0-SMTP668371314E79A3A03000AFACE70@phx.gbl>
References: <20100524153009.GA4413@fetter.org>
	<BLU0-SMTP668371314E79A3A03000AFACE70@phx.gbl>
Message-ID: <20100524171628.GC4413@fetter.org>

On Mon, May 24, 2010 at 11:13:48AM -0400, Steve Singer wrote:
> On Mon, 24 May 2010, David Fetter wrote:
> 
> >Hello,
> >
> >What's the minimum change needed from 2.0.3?  Specifically, is
> >replacing the slon binary enough, or does everything need to go?
> 
> 
> >From 2.0.3 to what is in cvs today you would want to replace
> 
> a) The slon binary for the data corruption bug
> 
> b) slony1_funcs.sql for bug # 119, if your planning on using CLONE
> FINISH (it's a 1 line change to one of plpgsql functions)
> 
> Everything checked in since 2.0.3 looks to be documentation related.

Thanks a lot.  That's super helpful :)

On a related note, what's needed to pull the 2.0.3 release from the
front page of the site, or failing that, to place giant warning labels
all over about the current state of 2.0.x?  I'd be happy to make such
a patch, assuming I still have the needed commit bits.

Cheers,
David.
-- 
David Fetter <david at fetter.org> http://fetter.org/
Phone: +1 415 235 3778  AIM: dfetter666  Yahoo!: dfetter
Skype: davidfetter      XMPP: david.fetter at gmail.com
iCal: webcal://www.tripit.com/feed/ical/people/david74/tripit.ics

Remember to vote!
Consider donating to Postgres: http://www.postgresql.org/about/donate

From singh.gurjeet at gmail.com  Mon May 24 11:04:34 2010
From: singh.gurjeet at gmail.com (Gurjeet Singh)
Date: Mon, 24 May 2010 14:04:34 -0400
Subject: [Slony1-general] [Slony1-bugs] Slony triggers included in
	pg_dump
In-Reply-To: <4BF35335.7090502@Yahoo.com>
References: <AANLkTik3kuhrTf7xiy5ylZi-N4AprDvtBP831Il6oxhS@mail.gmail.com> 
	<4BF35335.7090502@Yahoo.com>
Message-ID: <AANLkTinKm6PwIpLppG5ZBW_pk-67Rwxhju-BdSjBBvsc@mail.gmail.com>

On Tue, May 18, 2010 at 10:55 PM, Jan Wieck <JanWieck at yahoo.com> wrote:

> On 5/16/2010 8:22 AM, Gurjeet Singh wrote:
>
>> Hi All,
>>
>>    The docs here http://www.slony.info/documentation/triggers.html says
>> that post Postgres 8.3 version
>>
>> <snip>
>>
>>    * If you take a pg_dump of a Slony-I node, and drop out the Slony-I
>>      namespace, this now cleanly removes /all/ Slony-I components,
>>      leaving the database, /including its schema,/ in a "pristine",
>>      consistent fashion, ready for whatever use may be desired.
>> </snip>
>>
>> But I see that when dumping a schema containing tables monitored by Slony,
>> the dump still shows the log triggers on those tables.
>>
>
> I think you misinterpret the statement.
>
> If you take a complete dump of all schemas, restore that and THEN drop the
> slony schema, you have a pristine stand alone system as the result.
>
> pg_dump does not exclude cross-schema definitions like those triggers. You
> will get the same for example with foreign keys. For a table in the schema
> you are dumping, that references a table in a non-dumped schema, pg_dump
> will still emit the ALTER TABLE attempting to create the constraint.
>
>
Makes sense now. But I guess the statement should have read like this:

<snip>

   * If you restore a backup of a Slony-I node (taken by pg_dump or any
other method), and drop the Slony-I
     namespace, this now cleanly removes /all/ Slony-I components,
     leaving the database, /including its schema,/ in a "pristine",
     consistent fashion, ready for whatever use may be desired.
</snip>


Regards,

-- 
gurjeet.singh
@ EnterpriseDB - The Enterprise Postgres Company
http://www.enterprisedb.com

singh.gurjeet@{ gmail | yahoo }.com
Twitter/Skype: singh_gurjeet

Mail sent from my BlackLaptop device
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20100524/90492445/attachment.htm 

From cscetbon.ext at orange-ftgroup.com  Sat May 22 14:13:36 2010
From: cscetbon.ext at orange-ftgroup.com (Cyril Scetbon)
Date: Sat, 22 May 2010 23:13:36 +0200
Subject: [Slony1-general] [Slony1-bugs] An old event not confirmed: A
 possible bug?
In-Reply-To: <4BF61924.6010806@Yahoo.com>
References: <AANLkTikflK7G1bHIJjQLynJ-VZIwhAvAWazUNqyFQm5i@mail.gmail.com>	<4BEAC184.1000702@Yahoo.com>	<4BF53A9B.7020103@orange-ftgroup.com>	<4BF4A561.2050909@Yahoo.com>	<4BF54BBA.2050101@orange-ftgroup.com>	<4BF4C1E3.1050206@Yahoo.com>	<4BF6487C.3040107@orange-ftgroup.com>	<4BF57E71.50708@Yahoo.com>	<4BF67AFF.5020006@orange-ftgroup.com>	<4BF5E4B9.9020308@Yahoo.com>	<4BF69BD5.5010204@orange-ftgroup.com>
	<4BF61924.6010806@Yahoo.com>
Message-ID: <4BF84900.4070906@orange-ftgroup.com>



Jan Wieck a ?crit :
> On 5/21/2010 10:42 AM, Cyril Scetbon wrote:
>   
>> Jan Wieck a ?crit :
>>     
>>> I don't care much about that one old event. It does no harm other than 
>>> currently confusing test_slony_state. What I worry about is attempting 
>>> to failover in the case of emergency with an only half functioning path 
>>> network.
>>>   
>>>       
>> I don't really understand the issue you're talking about... Certainly 
>> I've a weak knowledge of your code :)
>> You're talking about missing errors in network cause there are no SYNC 
>> generated on a receiver ? If yes, if it confirms events from others it's 
>> not enough to say that everything works ?
>>     
>
> Let me try to explain the problem.
>
> In a multi node cluster, not every node necessarily needs to be able to 
> talk to every other node. Let us just look at a cascaded 3 node cluster:
>
>      1 - 2 - 3
>
> This setup requires 4 sl_path entries to work:
>
>      server=1, client=2
>      server=2, client=1
>      server=2, client=3
>      server=3, client=2
>
> And it is supposed to generate the following sl_listen rows:
>
>      origin=1, receiver=2, provider=1
>      origin=1, receiver=3, provider=2
>      origin=2, receiver=1, provider=2
>      origin=2, receiver=3, provider=2
>      origin=3, receiver=1, provider=2
>      origin=3, receiver=2, provider=3
>
> It does not matter which node is currently the origin of any set at all. 
> All these paths and connections are important for the health and well 
> being of the Slony cluster. If for example the listening for events from 
> 2, receiver=3 would be broken, then node 3 would still perfectly fine 
> replicate data originating from 1. But as soon as you move set to node 
> 2, it would start falling behind and you effectively lose your second 
> level backup.
>
> This is why Slony originally created a SYNC on EVERY node at least every 
> 10 seconds. Just so there is some harmless event passing going on to 
> have something to monitor and keep sl_status looking good.
>
> That is what got removed and that is what I think we should put back.
>   
thanks for the explanation ! I agree too.
>
> Jan
>
>   

-- 
Cyril SCETBON


From alexander.kolodziej at tactel.se  Tue May 25 04:19:55 2010
From: alexander.kolodziej at tactel.se (Alexander Kolodziej)
Date: Tue, 25 May 2010 13:19:55 +0200
Subject: [Slony1-general] child terminated status: 11 -> restart of worker
	in 10 seconds
Message-ID: <4BFBB25B.5010709@tactel.se>

Hello!

I have 6 pairs of servers which use slony (1.2.15) with postgresql 8.3.7
on Ubuntu 9.04.

Each pair is a master/slave combination, which replicates 2 DBs, one
smaller and one bigger (on disk they total 16gb on the masters).

The system is a high availability setup with automatic failovers.
Failovers have occured, and then the master/slave servers have switched
place, so to speak, and replication has (manually) been restarted in the
other direction.

That has worked fine, until just recently, where 1 server pair fails to
replicate.

First i noticed "too many files open" errors on the new slave (on the
bigger DB) just before it had managed to replicate all data.

--------------------------
2010-05-25 07:06:08 UTC ERROR  slon_connectdb: PQconnectdb("dbname=BIGDB
host=10.10.130.51 user=postgres password=pass") failed - could not
create socket: Too many open files
2010-05-25 07:06:08 UTC ERROR  remoteWorkerThread_1: cannot connect to
data provider 1 on 'dbname=BIGDB host=10.10.130.51 user=postgres
password=pass'
2010-05-25 07:06:08 UTC DEBUG1 slon: shutdown requested
2010-05-25 07:06:08 UTC DEBUG2 slon: notify worker process to shutdown
2010-05-25 07:06:08 UTC INFO   remoteListenThread_1: disconnecting from
'dbname=BIGDB host=10.10.130.51 user=postgres password=pass'
--------------------------

The .51 IP is the slaves IP.

So i restarted the system, and hoped for the best.

For the smaller DB i saw this on the slave:
--------------------------
2010-05-25 07:33:39 UTC DEBUG1 slon: child termination timeout - kill child
2010-05-25 07:33:39 UTC DEBUG2 slon: child terminated status: 9; pid:
30273, current worker pid: 30273
2010-05-25 07:33:39 UTC DEBUG1 slon: done
2010-05-25 07:33:39 UTC DEBUG2 slon: remove pid file
2010-05-25 07:33:39 UTC DEBUG2 slon: exit(0)
--------------------------

For the bigger DB i saw this on the slave:
--------------------------
2010-05-25 11:14:29 UTC DEBUG2 remoteListenThread_1: queue event 1,1320 SYNC
2010-05-25 11:14:29 UTC DEBUG2 remoteListenThread_1: queue event 1,1321 SYNC
2010-05-25 11:14:29 UTC DEBUG2 remoteWorkerThread_1: syncing set 1 with
30 table(s) from provider 1
2010-05-25 11:14:29 UTC DEBUG2 remoteListenThread_1: queue event 1,1322 SYNC
2010-05-25 11:14:29 UTC DEBUG2 remoteListenThread_1: queue event 1,1323 SYNC
2010-05-25 11:14:29 UTC DEBUG2 slon: child terminated status: 11; pid:
28735, current worker pid: 28735
2010-05-25 11:14:29 UTC DEBUG1 slon: restart of worker in 10 seconds
--------------------------

So i restarted /etc/init.d/slony1, and looked again.
The smaller DB all of a sudden worked fine, and caught up.
But the bigger DB just keeps getting these
--------------------------
...
2010-05-25 11:16:00 UTC DEBUG2 remoteListenThread_1: queue event 1,2533 SYNC
2010-05-25 11:16:00 UTC DEBUG2 slon: child terminated status: 11; pid:
29027, current worker pid: 29027
2010-05-25 11:16:00 UTC DEBUG1 slon: restart of worker in 10 seconds
--------------------------

In syslog i see this on the slave (slon segfault errors every 10s):
--------------------------
May 25 11:16:30 semc-sh62 kernel: [20053518.436336] slon[29076]:
segfault at 273936 ip 00007fd69e8bac40 sp 00007fd69ad48698 error 4 in
libc-2.9.so[7fd69e83a000+168000]
May 25 11:16:40 semc-sh62 kernel: [20053528.548794] slon[29104]:
segfault at 273936 ip 00007f359f4f4c40 sp 00007f359b982698 error 4 in
libc-2.9.so[7f359f474000+168000]
--------------------------

What could cause this?
Looking at the size of /var/lib/postgresql/8.3/ i can see that it has
almost succeeded in replicating the DB, but something is going boink.

Slon loglevel is set to 4.
Are there any slon sl_* tables i can look in for info?
Tried google but only get 8 results on: "child terminated status: 11" +
"restart of worker", and none of those provide a solution.

  wbr / Alexander

From ssinger at ca.afilias.info  Tue May 25 06:30:02 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Tue, 25 May 2010 09:30:02 -0400
Subject: [Slony1-general] [Slony1-bugs] Slony triggers included
	in	pg_dump
In-Reply-To: <AANLkTinKm6PwIpLppG5ZBW_pk-67Rwxhju-BdSjBBvsc@mail.gmail.com>
References: <AANLkTik3kuhrTf7xiy5ylZi-N4AprDvtBP831Il6oxhS@mail.gmail.com>
	<4BF35335.7090502@Yahoo.com>
	<AANLkTinKm6PwIpLppG5ZBW_pk-67Rwxhju-BdSjBBvsc@mail.gmail.com>
Message-ID: <4BFBD0DA.5040504@ca.afilias.info>

Gurjeet Singh wrote:

> Makes sense now. But I guess the statement should have read like this:
> 
> <snip>
> 
>    * If you restore a backup of a Slony-I node (taken by pg_dump or any 
> other method), and drop the Slony-I
>      namespace, this now cleanly removes /all/ Slony-I components,
>      leaving the database, /including its schema,/ in a "pristine",
>      consistent fashion, ready for whatever use may be desired.
> </snip>
> 
> 

Documentation patch applied.


> Regards,
> 
> -- 
> gurjeet.singh
> @ EnterpriseDB - The Enterprise Postgres Company
> http://www.enterprisedb.com
> 
> singh.gurjeet@{ gmail | yahoo }.com
> Twitter/Skype: singh_gurjeet
> 
> Mail sent from my BlackLaptop device
> 
> 
> ------------------------------------------------------------------------
> 
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


-- 
Steve Singer
Afilias Canada
Data Services Developer
416-673-1142

From ssinger at ca.afilias.info  Tue May 25 06:49:19 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Tue, 25 May 2010 09:49:19 -0400
Subject: [Slony1-general] child terminated status: 11 -> restart of
 worker in 10 seconds
In-Reply-To: <4BFBB25B.5010709@tactel.se>
References: <4BFBB25B.5010709@tactel.se>
Message-ID: <4BFBD55F.9000200@ca.afilias.info>

Alexander Kolodziej wrote:
> Hello!
> ...
> 2010-05-25 11:16:00 UTC DEBUG2 remoteListenThread_1: queue event 1,2533 SYNC
> 2010-05-25 11:16:00 UTC DEBUG2 slon: child terminated status: 11; pid:
> 29027, current worker pid: 29027
> 2010-05-25 11:16:00 UTC DEBUG1 slon: restart of worker in 10 seconds
> --------------------------
> 
> In syslog i see this on the slave (slon segfault errors every 10s):
> --------------------------
> May 25 11:16:30 semc-sh62 kernel: [20053518.436336] slon[29076]:
> segfault at 273936 ip 00007fd69e8bac40 sp 00007fd69ad48698 error 4 in
> libc-2.9.so[7fd69e83a000+168000]
> May 25 11:16:40 semc-sh62 kernel: [20053528.548794] slon[29104]:
> segfault at 273936 ip 00007f359f4f4c40 sp 00007f359b982698 error 4 in
> libc-2.9.so[7f359f474000+168000]
> --------------------------
>

Can you rub gdb against a core file, or start slony up inside of gdb, so 
we can get a stack trace of what slon was doing went it died?

(from a build with debugging symbols would be even more useful)


> What could cause this?
> Looking at the size of /var/lib/postgresql/8.3/ i can see that it has
> almost succeeded in replicating the DB, but something is going boink.
> 
> Slon loglevel is set to 4.
> Are there any slon sl_* tables i can look in for info?
> Tried google but only get 8 results on: "child terminated status: 11" +
> "restart of worker", and none of those provide a solution.
> 
>   wbr / Alexander
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


-- 
Steve Singer
Afilias Canada
Data Services Developer
416-673-1142

From brianf at consistentstate.com  Tue May 25 10:27:26 2010
From: brianf at consistentstate.com (Brian Fehrle)
Date: Tue, 25 May 2010 11:27:26 -0600
Subject: [Slony1-general] Table not replicating,
	but no errors reported by slony.
Message-ID: <4BFC087E.30701@consistentstate.com>

Hi all,
    I'm having some trouble determining why replication isn't happening 
on a replication table. I have a two node slony cluster. I have a table 
in the slony replication set that has 72332 records on the master, 
however it has 71225 records on the slave. It's been this way for a few 
hours at least (could be more as that is when we first noticed it). This 
table was added to the replication set several weeks ago, so it's not 
stalled mid-publish. The slon daemons are running, and the logs for the 
daemons report no abnormalities. I've restarted the slon daemons to see 
if it would clear anything up, but it remains the same.

Looking at sl_status, the lag events never go above 1, and the lag time 
never goes above a couple of minutes.

Best reasons I can think of are, either something is causing the 
replication on this particular table to be on "hold" and not update the 
remaining rows on the slave, while not alerting me via the slon logs. Or 
something went screwy and replication for that table is out of sync and 
I need to drop the table from the set and add it back again, let it sync 
up (however this solution is not ideal.)

Any tips of places I should look to see what may be going on?

Thanks in advance.

       - Brian Fehrle

Data that may be important:

Commands that start the slon daemons:
/usr/local/pgsql/bin/slon -p /usr/local/pgsql/log/slon.node1.pid -s 
60000 -t 300000 SLONY "dbname=$MASTERDBNAME port=$MASTERPORT 
host=$MASTERHOST user=$REPUSER"  > /usr/local/pgsql/log/slon.node1.log 
2>&1 &
/usr/local/pgsql/bin/slon -p  /usr/local/pgsql/log/slon.node2.pid-s 
60000 -a /usr/local/pgsql/slon_logs -t 300000 -x "log_parsing_script" 
SLONY "dbname=$SLAVEDBNAME port=$SLAVEPORT host=$SLAVEHOST 
user=$REPUSER"  > /usr/local/pgsql/log/slon.node2.log 2>&1 &

slony version 1.2.20
master PostgreSQL version 8.4.1
slave PostgreSQL version 8.4.2



From ssinger at ca.afilias.info  Tue May 25 10:52:25 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Tue, 25 May 2010 13:52:25 -0400
Subject: [Slony1-general] Table not replicating,
 but no errors reported by slony.
In-Reply-To: <4BFC087E.30701@consistentstate.com>
References: <4BFC087E.30701@consistentstate.com>
Message-ID: <4BFC0E59.6060109@ca.afilias.info>

Brian Fehrle wrote:

 > Hi all,

A few things I would look at

Look at  sl_event and sl_confirm.  Are there events in sl_event that are 
larger than what shows up as being confirmed in sl_confirm?  When where 
these events generated?   If so look at the next unconfirmed event in 
sl_event and see what type of event it is.


You can look at sl_log_1 and sl_log_2, you should see your missing rows, 
in particular the ev_snapshot from sl_event of the last unconfirmed SYNC 
event should give you the range of rows (log_txid) of some of the 
unreplicated rows.  The set of all of the unconfirmed sync events should 
give you all of the rows in sl_log_1 and sl_log_2 that need to still be 
sent.


You can also try a slonik script like

sync(id=1);
wait for event(origin=1, confirmed=all, wait on=1);


This generate a sync event and wait until it gets replicated.  If slonik 
exists on success and  your still missing those rows then something 
strange is going on (I would start to wonder if you did something like 
an execute script on your replica that deleted rows just from the replica)

Steve





>     I'm having some trouble determining why replication isn't happening 
> on a replication table. I have a two node slony cluster. I have a table 
> in the slony replication set that has 72332 records on the master, 
> however it has 71225 records on the slave. It's been this way for a few 
> hours at least (could be more as that is when we first noticed it). This 
> table was added to the replication set several weeks ago, so it's not 
> stalled mid-publish. The slon daemons are running, and the logs for the 
> daemons report no abnormalities. I've restarted the slon daemons to see 
> if it would clear anything up, but it remains the same.
> 
> Looking at sl_status, the lag events never go above 1, and the lag time 
> never goes above a couple of minutes.
> 
> Best reasons I can think of are, either something is causing the 
> replication on this particular table to be on "hold" and not update the 
> remaining rows on the slave, while not alerting me via the slon logs. Or 
> something went screwy and replication for that table is out of sync and 
> I need to drop the table from the set and add it back again, let it sync 
> up (however this solution is not ideal.)
> 
> Any tips of places I should look to see what may be going on?
> 
> Thanks in advance.
> 
>        - Brian Fehrle
> 
> Data that may be important:
> 
> Commands that start the slon daemons:
> /usr/local/pgsql/bin/slon -p /usr/local/pgsql/log/slon.node1.pid -s 
> 60000 -t 300000 SLONY "dbname=$MASTERDBNAME port=$MASTERPORT 
> host=$MASTERHOST user=$REPUSER"  > /usr/local/pgsql/log/slon.node1.log 
> 2>&1 &
> /usr/local/pgsql/bin/slon -p  /usr/local/pgsql/log/slon.node2.pid-s 
> 60000 -a /usr/local/pgsql/slon_logs -t 300000 -x "log_parsing_script" 
> SLONY "dbname=$SLAVEDBNAME port=$SLAVEPORT host=$SLAVEHOST 
> user=$REPUSER"  > /usr/local/pgsql/log/slon.node2.log 2>&1 &
> 
> slony version 1.2.20
> master PostgreSQL version 8.4.1
> slave PostgreSQL version 8.4.2
> 
> 
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


-- 
Steve Singer
Afilias Canada
Data Services Developer
416-673-1142

From brianf at consistentstate.com  Tue May 25 11:21:27 2010
From: brianf at consistentstate.com (Brian Fehrle)
Date: Tue, 25 May 2010 12:21:27 -0600
Subject: [Slony1-general] Table not replicating,
 but no errors reported by slony.
In-Reply-To: <4BFC0E59.6060109@ca.afilias.info>
References: <4BFC087E.30701@consistentstate.com>
	<4BFC0E59.6060109@ca.afilias.info>
Message-ID: <4BFC1527.3080600@consistentstate.com>

Steve Singer wrote:
> Brian Fehrle wrote:
>
> > Hi all,
>
> A few things I would look at
>
> Look at  sl_event and sl_confirm.  Are there events in sl_event that 
> are larger than what shows up as being confirmed in sl_confirm?  When 
> where these events generated?   If so look at the next unconfirmed 
> event in sl_event and see what type of event it is.
>
All entries between sl_event and sl_confirm match exactly (each 
con_seqno from sl_confirm matches an ev_seqno from sl_event)
>
> You can look at sl_log_1 and sl_log_2, you should see your missing 
> rows, in particular the ev_snapshot from sl_event of the last 
> unconfirmed SYNC event should give you the range of rows (log_txid) of 
> some of the unreplicated rows.  The set of all of the unconfirmed sync 
> events should give you all of the rows in sl_log_1 and sl_log_2 that 
> need to still be sent.
>
On both the master and the slave, there are zero entries in either 
sl_log_1 or sl_log_2.
>
> You can also try a slonik script like
>
> sync(id=1);
> wait for event(origin=1, confirmed=all, wait on=1);
>
>
> This generate a sync event and wait until it gets replicated.  If 
> slonik exists on success and  your still missing those rows then 
> something strange is going on (I would start to wonder if you did 
> something like an execute script on your replica that deleted rows 
> just from the replica)
I was wondering the same thing, however doesn't the slave node refuse 
updates/inserts/deletes via a locking system? There are quite a few 
people who use the databases and I can't account for all actions by 
everyone. I will give this sync command a try in a bit, I need to wait 
on some things before I can give it a try.

Another thing that has come to mind, when we first added this table to 
the replication set, we had a few problems with some of our scrips which 
resulted in a daemon attempting to start the slon daemons even if they 
were already running. Normally the daemons are smart enough to kill 
themselves, however since this was going on during the initial 
propagation of the data to the slave, it may have done something 
unintentional.

- Brian
>
> Steve
>
>
>
>
>
>>     I'm having some trouble determining why replication isn't 
>> happening on a replication table. I have a two node slony cluster. I 
>> have a table in the slony replication set that has 72332 records on 
>> the master, however it has 71225 records on the slave. It's been this 
>> way for a few hours at least (could be more as that is when we first 
>> noticed it). This table was added to the replication set several 
>> weeks ago, so it's not stalled mid-publish. The slon daemons are 
>> running, and the logs for the daemons report no abnormalities. I've 
>> restarted the slon daemons to see if it would clear anything up, but 
>> it remains the same.
>>
>> Looking at sl_status, the lag events never go above 1, and the lag 
>> time never goes above a couple of minutes.
>>
>> Best reasons I can think of are, either something is causing the 
>> replication on this particular table to be on "hold" and not update 
>> the remaining rows on the slave, while not alerting me via the slon 
>> logs. Or something went screwy and replication for that table is out 
>> of sync and I need to drop the table from the set and add it back 
>> again, let it sync up (however this solution is not ideal.)
>>
>> Any tips of places I should look to see what may be going on?
>>
>> Thanks in advance.
>>
>>        - Brian Fehrle
>>
>> Data that may be important:
>>
>> Commands that start the slon daemons:
>> /usr/local/pgsql/bin/slon -p /usr/local/pgsql/log/slon.node1.pid -s 
>> 60000 -t 300000 SLONY "dbname=$MASTERDBNAME port=$MASTERPORT 
>> host=$MASTERHOST user=$REPUSER"  > 
>> /usr/local/pgsql/log/slon.node1.log 2>&1 &
>> /usr/local/pgsql/bin/slon -p  /usr/local/pgsql/log/slon.node2.pid-s 
>> 60000 -a /usr/local/pgsql/slon_logs -t 300000 -x "log_parsing_script" 
>> SLONY "dbname=$SLAVEDBNAME port=$SLAVEPORT host=$SLAVEHOST 
>> user=$REPUSER"  > /usr/local/pgsql/log/slon.node2.log 2>&1 &
>>
>> slony version 1.2.20
>> master PostgreSQL version 8.4.1
>> slave PostgreSQL version 8.4.2
>>
>>
>> _______________________________________________
>> Slony1-general mailing list
>> Slony1-general at lists.slony.info
>> http://lists.slony.info/mailman/listinfo/slony1-general
>
>


From brianf at consistentstate.com  Tue May 25 12:09:26 2010
From: brianf at consistentstate.com (Brian Fehrle)
Date: Tue, 25 May 2010 13:09:26 -0600
Subject: [Slony1-general] Table not replicating,
 but no errors reported by slony.
In-Reply-To: <4BFC1527.3080600@consistentstate.com>
References: <4BFC087E.30701@consistentstate.com>	<4BFC0E59.6060109@ca.afilias.info>
	<4BFC1527.3080600@consistentstate.com>
Message-ID: <4BFC2066.9050604@consistentstate.com>

I've run the slonik script that did the sync, and it finished with a 
result of 0. The number of rows remain unchanged, the slave being less 
than the master.

I've generated a list of rows that the master has that the slave does 
not, and we're doing some investigating to see if it was somthing that 
someone had done, or something else.

- Brian Fehrle

Brian Fehrle wrote:
> Steve Singer wrote:
>   
>> Brian Fehrle wrote:
>>
>>     
>>> Hi all,
>>>       
>> A few things I would look at
>>
>> Look at  sl_event and sl_confirm.  Are there events in sl_event that 
>> are larger than what shows up as being confirmed in sl_confirm?  When 
>> where these events generated?   If so look at the next unconfirmed 
>> event in sl_event and see what type of event it is.
>>
>>     
> All entries between sl_event and sl_confirm match exactly (each 
> con_seqno from sl_confirm matches an ev_seqno from sl_event)
>   
>> You can look at sl_log_1 and sl_log_2, you should see your missing 
>> rows, in particular the ev_snapshot from sl_event of the last 
>> unconfirmed SYNC event should give you the range of rows (log_txid) of 
>> some of the unreplicated rows.  The set of all of the unconfirmed sync 
>> events should give you all of the rows in sl_log_1 and sl_log_2 that 
>> need to still be sent.
>>
>>     
> On both the master and the slave, there are zero entries in either 
> sl_log_1 or sl_log_2.
>   
>> You can also try a slonik script like
>>
>> sync(id=1);
>> wait for event(origin=1, confirmed=all, wait on=1);
>>
>>
>> This generate a sync event and wait until it gets replicated.  If 
>> slonik exists on success and  your still missing those rows then 
>> something strange is going on (I would start to wonder if you did 
>> something like an execute script on your replica that deleted rows 
>> just from the replica)
>>     
> I was wondering the same thing, however doesn't the slave node refuse 
> updates/inserts/deletes via a locking system? There are quite a few 
> people who use the databases and I can't account for all actions by 
> everyone. I will give this sync command a try in a bit, I need to wait 
> on some things before I can give it a try.
>
> Another thing that has come to mind, when we first added this table to 
> the replication set, we had a few problems with some of our scrips which 
> resulted in a daemon attempting to start the slon daemons even if they 
> were already running. Normally the daemons are smart enough to kill 
> themselves, however since this was going on during the initial 
> propagation of the data to the slave, it may have done something 
> unintentional.
>
> - Brian
>   
>> Steve
>>
>>
>>
>>
>>
>>     
>>>     I'm having some trouble determining why replication isn't 
>>> happening on a replication table. I have a two node slony cluster. I 
>>> have a table in the slony replication set that has 72332 records on 
>>> the master, however it has 71225 records on the slave. It's been this 
>>> way for a few hours at least (could be more as that is when we first 
>>> noticed it). This table was added to the replication set several 
>>> weeks ago, so it's not stalled mid-publish. The slon daemons are 
>>> running, and the logs for the daemons report no abnormalities. I've 
>>> restarted the slon daemons to see if it would clear anything up, but 
>>> it remains the same.
>>>
>>> Looking at sl_status, the lag events never go above 1, and the lag 
>>> time never goes above a couple of minutes.
>>>
>>> Best reasons I can think of are, either something is causing the 
>>> replication on this particular table to be on "hold" and not update 
>>> the remaining rows on the slave, while not alerting me via the slon 
>>> logs. Or something went screwy and replication for that table is out 
>>> of sync and I need to drop the table from the set and add it back 
>>> again, let it sync up (however this solution is not ideal.)
>>>
>>> Any tips of places I should look to see what may be going on?
>>>
>>> Thanks in advance.
>>>
>>>        - Brian Fehrle
>>>
>>> Data that may be important:
>>>
>>> Commands that start the slon daemons:
>>> /usr/local/pgsql/bin/slon -p /usr/local/pgsql/log/slon.node1.pid -s 
>>> 60000 -t 300000 SLONY "dbname=$MASTERDBNAME port=$MASTERPORT 
>>> host=$MASTERHOST user=$REPUSER"  > 
>>> /usr/local/pgsql/log/slon.node1.log 2>&1 &
>>> /usr/local/pgsql/bin/slon -p  /usr/local/pgsql/log/slon.node2.pid-s 
>>> 60000 -a /usr/local/pgsql/slon_logs -t 300000 -x "log_parsing_script" 
>>> SLONY "dbname=$SLAVEDBNAME port=$SLAVEPORT host=$SLAVEHOST 
>>> user=$REPUSER"  > /usr/local/pgsql/log/slon.node2.log 2>&1 &
>>>
>>> slony version 1.2.20
>>> master PostgreSQL version 8.4.1
>>> slave PostgreSQL version 8.4.2
>>>
>>>
>>> _______________________________________________
>>> Slony1-general mailing list
>>> Slony1-general at lists.slony.info
>>> http://lists.slony.info/mailman/listinfo/slony1-general
>>>       
>>     
>
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
>   


From ssinger at ca.afilias.info  Tue May 25 12:22:19 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Tue, 25 May 2010 15:22:19 -0400
Subject: [Slony1-general] Table not replicating,
 but no errors reported by slony.
In-Reply-To: <4BFC1527.3080600@consistentstate.com>
References: <4BFC087E.30701@consistentstate.com>
	<4BFC0E59.6060109@ca.afilias.info>
	<4BFC1527.3080600@consistentstate.com>
Message-ID: <4BFC236B.7040703@ca.afilias.info>

Brian Fehrle wrote:
> Steve Singer wrote:
>> Brian Fehrle wrote:
>>
>> > Hi all,
>>


> All entries between sl_event and sl_confirm match exactly (each 
> con_seqno from sl_confirm matches an ev_seqno from sl_event)

It sounds like your cluster is caught up.

> On both the master and the slave, there are zero entries in either 
> sl_log_1 or sl_log_2.
>>
> I was wondering the same thing, however doesn't the slave node refuse 
> updates/inserts/deletes via a locking system? There are quite a few 
> people who use the databases and I can't account for all actions by 
> everyone. I will give this sync command a try in a bit, I need to wait 
> on some things before I can give it a try.

The slave should refuse updates to replicated tables except if your run 
EXECUTE SCRIPT, the execute script commands restores the tables on the 
replica to the normal state then runs the SQL in your script.  Once it 
is finished the replica deny triggers get enabled again.

 From what your saying the possible sources of the issues are

1) There was some sort of issue in initial sync that prevented some rows 
from being replicated and no error was generated (I don't think this is 
likely but there could be a bug somewhere)

2) There is some sort of bug that caused changes to not replicate either 
the trigger didn't fire properly or something got marked as replicated 
when it didn't.  I'd be surprised if your the only one reporting this 
but anything is possible

3) Someone ran EXECUTE SCRIP(ONLY ON=?) either with a INSERT on the 
oriigin that wouldn't get replicated or with DELETE on the replica.

4) Someone with sufficient privileges connected to either the origin or 
the replica and manipulated things to circumvent the slony triggers

5) Someone did an ALTER TABLE ... without using execute script leaving 
your replication triggers in a bad state.




> 
> Another thing that has come to mind, when we first added this table to 
> the replication set, we had a few problems with some of our scrips which 
> resulted in a daemon attempting to start the slon daemons even if they 
> were already running. Normally the daemons are smart enough to kill 
> themselves, however since this was going on during the initial 
> propagation of the data to the slave, it may have done something 
> unintentional.

I've never seen this, but I guess it is possible.


> 
> - Brian
>>
>> Steve
>>
>>
>>




-- 
Steve Singer
Afilias Canada
Data Services Developer
416-673-1142

From singh.gurjeet at gmail.com  Tue May 25 13:18:14 2010
From: singh.gurjeet at gmail.com (Gurjeet Singh)
Date: Tue, 25 May 2010 16:18:14 -0400
Subject: [Slony1-general] [Slony1-bugs] Slony triggers included in
	pg_dump
In-Reply-To: <4BFBD0DA.5040504@ca.afilias.info>
References: <AANLkTik3kuhrTf7xiy5ylZi-N4AprDvtBP831Il6oxhS@mail.gmail.com> 
	<4BF35335.7090502@Yahoo.com>
	<AANLkTinKm6PwIpLppG5ZBW_pk-67Rwxhju-BdSjBBvsc@mail.gmail.com> 
	<4BFBD0DA.5040504@ca.afilias.info>
Message-ID: <AANLkTik9_Iu0yros8UHdsWecnzJORF6mhfkBf290Yr5m@mail.gmail.com>

On Tue, May 25, 2010 at 9:30 AM, Steve Singer <ssinger at ca.afilias.info>wrote:

> Gurjeet Singh wrote:
>
>  Makes sense now. But I guess the statement should have read like this:
>>
>> <snip>
>>
>>   * If you restore a backup of a Slony-I node (taken by pg_dump or any
>> other method), and drop the Slony-I
>>     namespace, this now cleanly removes /all/ Slony-I components,
>>     leaving the database, /including its schema,/ in a "pristine",
>>     consistent fashion, ready for whatever use may be desired.
>> </snip>
>>
>>
>>
> Documentation patch applied.
>

Thanks.

-- 
gurjeet.singh
@ EnterpriseDB - The Enterprise Postgres Company
http://www.enterprisedb.com

singh.gurjeet@{ gmail | yahoo }.com
Twitter/Skype: singh_gurjeet

Mail sent from my BlackLaptop device
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20100525/53487b84/attachment.htm 

From aiwaniuk at instytut.com.pl  Wed May 26 05:18:10 2010
From: aiwaniuk at instytut.com.pl (aiwaniuk at instytut.com.pl)
Date: Wed, 26 May 2010 14:18:10 +0200
Subject: [Slony1-general] child terminated status: 11 -> restart of
	worker in 10 seconds
In-Reply-To: <4BFBD55F.9000200@ca.afilias.info>
References: <4BFBB25B.5010709@tactel.se> <4BFBD55F.9000200@ca.afilias.info>
Message-ID: <20100526121810.GC8987@troy.imm>

On Tue, May 25, 2010 at 09:49:19AM -0400, Steve Singer wrote:
> > segfault at 273936 ip 00007f359f4f4c40 sp 00007f359b982698 error 4 in
> > libc-2.9.so[7f359f474000+168000]
> 
> Can you rub gdb against a core file, or start slony up inside of gdb, so 
> we can get a stack trace of what slon was doing went it died?
> 
> (from a build with debugging symbols would be even more useful)

i've faced the same problem while replicating postgres8.3 using slony
2.0.3
subscribe operation had finisher successfully, but then while synchronizing
tables i still have segfaults. backtrace has shown

#0  0xb7761f93 in strlen () from /lib/libc.so.6
#1  0x0805e35d in slon_appendquery_int (dsp=0xb4b11a38, fmt=0x8068af5
"_log_%d_",ap=0xb42fe1cc "\f`????\022??\t\b\036??\t\b0??\006\b\020??\t\b\022??\t\b\036??\t\b\214??/????\v?
??\b\f?
??\002")   at /usr/include/bits/string3.h:52
#2  0x0805e7d7 in snprintf (conn=0xb4b11a38) at /usr/include/bits/stdio2.h:65
#3  db_checkSchemaVersion (conn=0xb4b11a38) at dbutils.c:311
#4  0x08051f75 in sync_helper (cdata=0xb4c4600c) at remote_worker.c:4993
#5  0xb783c42f in start_thread () from /lib/libpthread.so.0
#6  0xb77be79e in clone () from /lib/libc.so.6
    

i looked up through sources (dbutils.c) and in function slon_appendquery_int
in 
switch (*fmt)
        {
                        case 's':
while executing: dstring_append(dsp, s) (which is in fact macro) there
is indeed strlen. i thought that problem lies in fact in dstring_nappend
(executed after strlen) function which makes some memory allocation operations. 
but code in slony 1.2 (which i'm using sucesfully right now) looks the same. 

then i thought that maybe this precisely OS/platform issue, but runnig slave
slonny on slave machine and master machine gives the same effect (both
linux, but one x86 other amd64, different glibcs, different kernels)

i end up in conculsion that data structure or row in replicated table is
the couse - one row of replicated data occupies 300kB of space (select
saved using psql with \o).



funny thing is the way slony created replication sqls (this is output of
slony):
2010-04-28 14:51:45 CESTERROR  remoteWorkerThread_1:
insert into TABLE1 (....) values (13314972,................); -OK
insert into TABLE2 (....) values (..,13314972,............); - there is
refference from table2 to table1, then vierd entry
insert into TABLE1 rt into TABLE1 (....) values (13314972,................); -again but modyfied
insert into TABLE2 (....) values (..,13314972,............); -again the
same
insert into TABLE1 rt into TABLE1 (....) values (13314972,................);
insert into TABLE2 (....) values (..,13314972,............);
insert into TABLE1 rt into TABLE1 (....) values (13314972,................); 
insert into TABLE2 (....) values (..,13314972,............); 
insert into TABLE1 rt into TABLE1 (....) values (13314972,................);
insert into TABLE2 (....) values (..,13314972,............); 
insert into TABLE1 rt into TABLE1 (....) values (13314972,................); 
insert into TABLE2 (....) values (..,13314972,............); 
insert into TABLE3 ................
insert into TABLE3 ................
insert into TABLE3 ................
insert into TABLE3 ................
insert into TABLE3 ................
ERROR:  syntax error at or near "rt"
LINE 3: insert into TABLE1" rt into "pub...
- qualification was:
2010-04-28 14:51:45 CESTERROR  remoteWorkerThread_1: SYNC aborted




i finaly gave up and turn to other things. 

-- 
IaS

From ssinger at ca.afilias.info  Wed May 26 06:30:55 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Wed, 26 May 2010 09:30:55 -0400
Subject: [Slony1-general] child terminated status: 11 -> restart
 of	worker in 10 seconds
In-Reply-To: <20100526121810.GC8987@troy.imm>
References: <4BFBB25B.5010709@tactel.se> <4BFBD55F.9000200@ca.afilias.info>
	<20100526121810.GC8987@troy.imm>
Message-ID: <4BFD228F.6050305@ca.afilias.info>

aiwaniuk at instytut.com.pl wrote:
> On Tue, May 25, 2010 at 09:49:19AM -0400, Steve Singer wrote:
>>> segfault at 273936 ip 00007f359f4f4c40 sp 00007f359b982698 error 4 in
>>> libc-2.9.so[7f359f474000+168000]
>> Can you rub gdb against a core file, or start slony up inside of gdb, so 
>> we can get a stack trace of what slon was doing went it died?
>>
>> (from a build with debugging symbols would be even more useful)
> 
> i've faced the same problem while replicating postgres8.3 using slony
> 2.0.3
> subscribe operation had finisher successfully, but then while synchronizing
> tables i still have segfaults. backtrace has shown

If your running into this problem on 2.0.3 AND your dealing with a large 
300kb row then it is probably the issue reported in this thread 
(http://lists.slony.info/pipermail/slony1-general/2010-April/010596.html) 
that has been fixed in REL_2_0_STABLE CVS.

However I am not aware of that being an issue in the 1.2 branch.  Are 
your issues with 1.2 the same or somewhat different (is the stack trace 
the same?)





> 
> #0  0xb7761f93 in strlen () from /lib/libc.so.6
> #1  0x0805e35d in slon_appendquery_int (dsp=0xb4b11a38, fmt=0x8068af5
> "_log_%d_",ap=0xb42fe1cc "\f`????\022??\t\b\036??\t\b0??\006\b\020??\t\b\022??\t\b\036??\t\b\214??/????\v?
??\b\f?
??\002")   at /usr/include/bits/string3.h:52
> #2  0x0805e7d7 in snprintf (conn=0xb4b11a38) at /usr/include/bits/stdio2.h:65
> #3  db_checkSchemaVersion (conn=0xb4b11a38) at dbutils.c:311
> #4  0x08051f75 in sync_helper (cdata=0xb4c4600c) at remote_worker.c:4993
> #5  0xb783c42f in start_thread () from /lib/libpthread.so.0
> #6  0xb77be79e in clone () from /lib/libc.so.6
>     
> 
> i looked up through sources (dbutils.c) and in function slon_appendquery_int
> in 
> switch (*fmt)
>         {
>                         case 's':
> while executing: dstring_append(dsp, s) (which is in fact macro) there
> is indeed strlen. i thought that problem lies in fact in dstring_nappend
> (executed after strlen) function which makes some memory allocation operations. 
> but code in slony 1.2 (which i'm using sucesfully right now) looks the same. 
> 
> then i thought that maybe this precisely OS/platform issue, but runnig slave
> slonny on slave machine and master machine gives the same effect (both
> linux, but one x86 other amd64, different glibcs, different kernels)
> 
> i end up in conculsion that data structure or row in replicated table is
> the couse - one row of replicated data occupies 300kB of space (select
> saved using psql with \o).
> 
> 
> 
> funny thing is the way slony created replication sqls (this is output of
> slony):
> 2010-04-28 14:51:45 CESTERROR  remoteWorkerThread_1:
> insert into TABLE1 (....) values (13314972,................); -OK
> insert into TABLE2 (....) values (..,13314972,............); - there is
> refference from table2 to table1, then vierd entry
> insert into TABLE1 rt into TABLE1 (....) values (13314972,................); -again but modyfied
> insert into TABLE2 (....) values (..,13314972,............); -again the
> same
> insert into TABLE1 rt into TABLE1 (....) values (13314972,................);
> insert into TABLE2 (....) values (..,13314972,............);
> insert into TABLE1 rt into TABLE1 (....) values (13314972,................); 
> insert into TABLE2 (....) values (..,13314972,............); 
> insert into TABLE1 rt into TABLE1 (....) values (13314972,................);
> insert into TABLE2 (....) values (..,13314972,............); 
> insert into TABLE1 rt into TABLE1 (....) values (13314972,................); 
> insert into TABLE2 (....) values (..,13314972,............); 
> insert into TABLE3 ................
> insert into TABLE3 ................
> insert into TABLE3 ................
> insert into TABLE3 ................
> insert into TABLE3 ................
> ERROR:  syntax error at or near "rt"
> LINE 3: insert into TABLE1" rt into "pub...
> - qualification was:
> 2010-04-28 14:51:45 CESTERROR  remoteWorkerThread_1: SYNC aborted
> 
> 
> 
> 
> i finaly gave up and turn to other things. 
> 


-- 
Steve Singer
Afilias Canada
Data Services Developer
416-673-1142

From stephane.schildknecht at postgresql.fr  Wed May 26 14:13:42 2010
From: stephane.schildknecht at postgresql.fr (=?ISO-8859-15?Q?=22St=E9phane_A=2E_Schildknecht=22?=)
Date: Wed, 26 May 2010 23:13:42 +0200
Subject: [Slony1-general] Table not replicating,
 but no errors reported by slony.
In-Reply-To: <4BFC087E.30701@consistentstate.com>
References: <4BFC087E.30701@consistentstate.com>
Message-ID: <4BFD8F06.5050607@postgresql.fr>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Good evening,

Le 25/05/2010 19:27, Brian Fehrle a ?crit :
> Hi all,
(...)

> 
> Any tips of places I should look to see what may be going on?
> 

Could you check that this table is in sl_tables, and in which set it is ?

Maybe this set isn't subscribed.

Regards,
- -- 
St?phane Schildknecht
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.10 (GNU/Linux)
Comment: Using GnuPG with Mozilla - http://enigmail.mozdev.org/

iEYEARECAAYFAkv9jwYACgkQA+REPKWGI0Ed9QCfZS+J6iWDQQ5XYyXUhZEX0rIq
DAgAoLSv0iRlfwPMXByoH/6+DUgd10Jt
=g49D
-----END PGP SIGNATURE-----

From jaime at 2ndquadrant.com  Wed May 26 18:22:00 2010
From: jaime at 2ndquadrant.com (Jaime Casanova)
Date: Wed, 26 May 2010 20:22:00 -0500
Subject: [Slony1-general] Table not replicating,
	but no errors reported by 	slony.
In-Reply-To: <4BFC236B.7040703@ca.afilias.info>
References: <4BFC087E.30701@consistentstate.com>
	<4BFC0E59.6060109@ca.afilias.info> 
	<4BFC1527.3080600@consistentstate.com>
	<4BFC236B.7040703@ca.afilias.info>
Message-ID: <AANLkTikp0KvHe28SX8zGqIjc62kj0kza6ackNuV4dXOq@mail.gmail.com>

On Tue, May 25, 2010 at 2:22 PM, Steve Singer <ssinger at ca.afilias.info> wrote:
> Brian Fehrle wrote:
>
>> On both the master and the slave, there are zero entries in either
>> sl_log_1 or sl_log_2.
>>>
>> I was wondering the same thing, however doesn't the slave node refuse
>> updates/inserts/deletes via a locking system? There are quite a few
>> people who use the databases and I can't account for all actions by
>> everyone. I will give this sync command a try in a bit, I need to wait
>> on some things before I can give it a try.
>
> The slave should refuse updates to replicated tables except if your run
> EXECUTE SCRIPT, the execute script commands restores the tables on the
> replica to the normal state then runs the SQL in your script. ?Once it
> is finished the replica deny triggers get enabled again.
>

unless someone had executed TRUNCATE at some time on the slave... not
sure if that fits in your problem though

> ?From what your saying the possible sources of the issues are
>
> 1) There was some sort of issue in initial sync that prevented some rows
> from being replicated and no error was generated (I don't think this is
> likely but there could be a bug somewhere)
>

yes, the one discovered here: http://www.slony.info/bugzilla/show_bug.cgi?id=118

> 2) There is some sort of bug that caused changes to not replicate either
> the trigger didn't fire properly or something got marked as replicated
> when it didn't. ?I'd be surprised if your the only one reporting this
> but anything is possible
>

scary! but i don't think this is the case

> 3) Someone ran EXECUTE SCRIP(ONLY ON=?) either with a INSERT on the
> oriigin that wouldn't get replicated or with DELETE on the replica.
>

maybe we wan't to refuse INSERT/UPDATE/DELETE/something else in
EXECUTE SCRIPT (ONLY ON=x)?

> 4) Someone with sufficient privileges connected to either the origin or
> the replica and manipulated things to circumvent the slony triggers
>

vandalism! always a possibility... have you fired someone recently? ;)

> 5) Someone did an ALTER TABLE ... without using execute script leaving
> your replication triggers in a bad state.
>
>

have seen a lot of this and always can figure out something wrong
because sl_status and rows always are in sl_log_x (someone maybe
thought those tables were growing enough and truncate them?)

-- 
Jaime Casanova         www.2ndQuadrant.com
Soporte y capacitaci?n de PostgreSQL

From jaime at 2ndquadrant.com  Wed May 26 18:26:39 2010
From: jaime at 2ndquadrant.com (Jaime Casanova)
Date: Wed, 26 May 2010 20:26:39 -0500
Subject: [Slony1-general] Table not replicating,
	but no errors reported by 	slony.
In-Reply-To: <4BFD8F06.5050607@postgresql.fr>
References: <4BFC087E.30701@consistentstate.com>
	<4BFD8F06.5050607@postgresql.fr>
Message-ID: <AANLkTimwqV0WPnLe3vpQHqX2nDjacdIl2r76VNmXeQ0U@mail.gmail.com>

On Wed, May 26, 2010 at 4:13 PM, "St?phane A. Schildknecht"
<stephane.schildknecht at postgresql.fr> wrote:
>
> Could you check that this table is in sl_tables, and in which set it is ?
>
> Maybe this set isn't subscribed.
>

or maybe the table has the wrong tab_reloid in the slave. you can
probe that with this simple query (the same for sequences):
select * from _cluster_name.sl_table where tab_reloid <> (tab_nspname
|| '.' || tab_relname)::regclass;

-- 
Jaime Casanova         www.2ndQuadrant.com
Soporte y capacitaci?n de PostgreSQL

From guillaume at lelarge.info  Thu May 27 06:17:43 2010
From: guillaume at lelarge.info (Guillaume Lelarge)
Date: Thu, 27 May 2010 15:17:43 +0200
Subject: [Slony1-general] Having a version.rss would be great
Message-ID: <4BFE70F7.6050500@lelarge.info>

Hi,

$SUBJECT is pretty cryptic, so I'll explain it a bit more.
http://www.postgresql.org publishes a list of stable releases for each
branch in a RSS file. It's great for someone to check for latest
releases. It's even greater for tools like check_postgres.pl which can
download this file and compare the releases with the one installed on
many servers and launch appropriate actions if required.

You'll find attached a versions.rss file, modified for slony.info. BTW,
I didn't put anyone in the author tag, as I don't know of an appropriate
email address. I also put the same URL for 2.0 and 1.2 branches. It
would be great to have access to both documentations.

Hope it would be of use.

Regards.


-- 
Guillaume
 http://www.postgresql.fr
 http://dalibo.com
-------------- next part --------------
A non-text attachment was scrubbed...
Name: versions.rss
Type: application/rss+xml
Size: 1007 bytes
Desc: not available
Url : http://lists.slony.info/pipermail/slony1-general/attachments/20100527/b1a7684b/attachment.rss 

From ssinger at ca.afilias.info  Thu May 27 07:57:19 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Thu, 27 May 2010 10:57:19 -0400
Subject: [Slony1-general] Having a version.rss would be great
In-Reply-To: <4BFE70F7.6050500@lelarge.info>
References: <4BFE70F7.6050500@lelarge.info>
Message-ID: <4BFE884F.1020803@ca.afilias.info>

Guillaume Lelarge wrote:

The 1.2 documentation is actually available at 
http://lists.slony.info/adminguide/1.2/doc/adminguide/index.html there 
is just no link to it from the main page.

I've posted a version of that file (for discussion purposes, I have not 
yet committed it to cvs) at  http://www.slony.info/versions.rss

Should the <link> point at the documentation or the source tar?

What are proper values of the guid?

Do other people find this thing useful? We would have to manually update 
it each time we do a release (which isn't a big deal if people use it)




> Hi,
> 
> $SUBJECT is pretty cryptic, so I'll explain it a bit more.
> http://www.postgresql.org publishes a list of stable releases for each
> branch in a RSS file. It's great for someone to check for latest
> releases. It's even greater for tools like check_postgres.pl which can
> download this file and compare the releases with the one installed on
> many servers and launch appropriate actions if required.
> 
> You'll find attached a versions.rss file, modified for slony.info. BTW,
> I didn't put anyone in the author tag, as I don't know of an appropriate
> email address. I also put the same URL for 2.0 and 1.2 branches. It
> would be great to have access to both documentations.
> 
> Hope it would be of use.
> 
> Regards.
> 
> 
> 
> 
> ------------------------------------------------------------------------
> 
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


-- 
Steve Singer
Afilias Canada
Data Services Developer
416-673-1142

From guillaume at lelarge.info  Thu May 27 08:08:05 2010
From: guillaume at lelarge.info (Guillaume Lelarge)
Date: Thu, 27 May 2010 17:08:05 +0200
Subject: [Slony1-general] Having a version.rss would be great
In-Reply-To: <4BFE884F.1020803@ca.afilias.info>
References: <4BFE70F7.6050500@lelarge.info> <4BFE884F.1020803@ca.afilias.info>
Message-ID: <4BFE8AD5.9010208@lelarge.info>

Le 27/05/2010 16:57, Steve Singer a ?crit :
> Guillaume Lelarge wrote:
> 
> The 1.2 documentation is actually available at
> http://lists.slony.info/adminguide/1.2/doc/adminguide/index.html there
> is just no link to it from the main page.

Oh great, I didn't know that. And the 2.0 is available in the same way
(just need to s/1.2/2.0/).

> I've posted a version of that file (for discussion purposes, I have not
> yet committed it to cvs) at  http://www.slony.info/versions.rss

OK, thanks.

> Should the <link> point at the documentation or the source tar?

On PostgreSQL versions.rss, it links to the release notes. I didn't find
any in Slony's docs. So I added a link to the documentation.

> What are proper values of the guid?

Same as the link one.

> Do other people find this thing useful? We would have to manually update
> it each time we do a release (which isn't a big deal if people use it)

If it gets updated, I'll write a new check_postgres.pl action to
automatically check slony's version.

Thanks.


-- 
Guillaume
 http://www.postgresql.fr
 http://dalibo.com

From cbbrowne at ca.afilias.info  Thu May 27 08:30:27 2010
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Thu, 27 May 2010 15:30:27 +0000
Subject: [Slony1-general] Having a version.rss would be great
In-Reply-To: <4BFE884F.1020803@ca.afilias.info>
References: <4BFE70F7.6050500@lelarge.info> <4BFE884F.1020803@ca.afilias.info>
Message-ID: <4BFE9013.30707@ca.afilias.info>

Steve Singer wrote:
> Guillaume Lelarge wrote:
> 
> The 1.2 documentation is actually available at 
> http://lists.slony.info/adminguide/1.2/doc/adminguide/index.html there 
> is just no link to it from the main page.
> 
> I've posted a version of that file (for discussion purposes, I have not 
> yet committed it to cvs) at  http://www.slony.info/versions.rss
> 
> Should the <link> point at the documentation or the source tar?
> 
> What are proper values of the guid?
> 
> Do other people find this thing useful? We would have to manually update 
> it each time we do a release (which isn't a big deal if people use it)

I'd be completely disinclined to create a manual update process for
this; that's going to fall out of date and get forgotten quickly.  I
think, however, it should be pretty possible to automate it.

Consider...

When tarballs are deployed, we already use a makefile to regenerate
md5 checksums.

Each tarball does contain release notes, always stored in the file
"RELEASE".

Perhaps the Makefile could be extended to pull release notes out of
the tarballs, something like the following...

  For each tarball

    - Create a subdirectory based on version name

    - Untar the RELEASE file

    - Pull timestamp off the tarball, and generate an RSS entry
      consisting of a reference to the release notes, a description
      generated out of the release number, and the timestamp

The pieces then get assembled into an RSS file.

-- 
(reverse (concatenate 'string "ofni.sailifa.ac" "@" "enworbbc"))
Christopher Browne
(416) 673-4124 (land)

From guillaume at lelarge.info  Thu May 27 08:32:46 2010
From: guillaume at lelarge.info (Guillaume Lelarge)
Date: Thu, 27 May 2010 17:32:46 +0200
Subject: [Slony1-general] Having a version.rss would be great
In-Reply-To: <4BFE9013.30707@ca.afilias.info>
References: <4BFE70F7.6050500@lelarge.info> <4BFE884F.1020803@ca.afilias.info>
	<4BFE9013.30707@ca.afilias.info>
Message-ID: <4BFE909E.1080703@lelarge.info>

Le 27/05/2010 17:30, Christopher Browne a ?crit :
> Steve Singer wrote:
>> Guillaume Lelarge wrote:
>>
>> The 1.2 documentation is actually available at
>> http://lists.slony.info/adminguide/1.2/doc/adminguide/index.html there
>> is just no link to it from the main page.
>>
>> I've posted a version of that file (for discussion purposes, I have
>> not yet committed it to cvs) at  http://www.slony.info/versions.rss
>>
>> Should the <link> point at the documentation or the source tar?
>>
>> What are proper values of the guid?
>>
>> Do other people find this thing useful? We would have to manually
>> update it each time we do a release (which isn't a big deal if people
>> use it)
> 
> I'd be completely disinclined to create a manual update process for
> this; that's going to fall out of date and get forgotten quickly.  I
> think, however, it should be pretty possible to automate it.
> 
> Consider...
> 
> When tarballs are deployed, we already use a makefile to regenerate
> md5 checksums.
> 
> Each tarball does contain release notes, always stored in the file
> "RELEASE".
> 
> Perhaps the Makefile could be extended to pull release notes out of
> the tarballs, something like the following...
> 
>  For each tarball
> 
>    - Create a subdirectory based on version name
> 
>    - Untar the RELEASE file
> 
>    - Pull timestamp off the tarball, and generate an RSS entry
>      consisting of a reference to the release notes, a description
>      generated out of the release number, and the timestamp
> 
> The pieces then get assembled into an RSS file.
> 

It seems way better to me. I'm all for automatic maintenance of this kind :)


-- 
Guillaume
 http://www.postgresql.fr
 http://dalibo.com

From cbbrowne at ca.afilias.info  Thu May 27 09:14:33 2010
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Thu, 27 May 2010 16:14:33 +0000
Subject: [Slony1-general] [Slony1-patches] [rangerrick@befunk.com: slony
 patch for osx]
In-Reply-To: <4BE1CD3B.6000304@ca.afilias.info>
References: <20100423160654.GA18954@fetter.org>	<4BDC9C8D.104@ca.afilias.info>	<4BDC3FA2.1070703@Yahoo.com>	<4BE18607.70202@ca.afilias.info>	<20100505152058.GB32707@fetter.org>	<4BE1970D.6050400@ca.afilias.info>
	<4BE1CD3B.6000304@ca.afilias.info>
Message-ID: <4BFE9A69.6060502@ca.afilias.info>

Steve Singer wrote:
> Steve Singer wrote:
>> David Fetter wrote:
>>
>>
>> I think I can replace our direct use of yyleng with calls to 
>> yyget_len() to avoid this issue
> 
> 
> David, does this patch (in addition to the autoconf changes) get things 
> working on your version of OSX? I've replaced uses of yyleng with 
> yyget_len() and am having flex generate a proper prototype for it.
> 
> 
> 
> http://github.com/ssinger/slony/commit/0febbf93046600e3fd7c59e37ca3b14cc137eb64 

FYI, result of some discussion that should get exposed on list...

yyget_len() is available on modern versions of flex (at least as far 
back as 2.5.31, which is what PostgreSQL requires, of late).

So, I'm suggesting that configure be modified to check for 2.5.31 (or 
later), for which a sample test may be gotten from config/programs.m4 in 
the PostgreSQL tree.  Given that, it'll be very clear to people that 
have any difficulties that they're using a too-old flex.

I don't feel badly about going back as far as PostgreSQL does ;-).

I could do this change; it may be opportunity for Steve to improve his 
configure-foo.

That's better than putting some documentation somewhere saying "oh, by 
the way, you need to use version X of flex".
-- 
(reverse (concatenate 'string "ofni.sailifa.ac" "@" "enworbbc"))
<http://dba2.int.libertyrms.com/>
Christopher Browne
(416) 673-4124 (land)

From brianf at consistentstate.com  Thu May 27 12:14:23 2010
From: brianf at consistentstate.com (Brian Fehrle)
Date: Thu, 27 May 2010 13:14:23 -0600
Subject: [Slony1-general] Table not replicating,
 but no errors reported by 	slony.
In-Reply-To: <AANLkTimwqV0WPnLe3vpQHqX2nDjacdIl2r76VNmXeQ0U@mail.gmail.com>
References: <4BFC087E.30701@consistentstate.com>	<4BFD8F06.5050607@postgresql.fr>
	<AANLkTimwqV0WPnLe3vpQHqX2nDjacdIl2r76VNmXeQ0U@mail.gmail.com>
Message-ID: <4BFEC48F.60101@consistentstate.com>

Jaime Casanova wrote:
> On Wed, May 26, 2010 at 4:13 PM, "St?phane A. Schildknecht"
> <stephane.schildknecht at postgresql.fr> wrote:
>   
>> Could you check that this table is in sl_tables, and in which set it is ?
>>
>> Maybe this set isn't subscribed.
>>
>>     
>
>   
Those all look fine, the table exists in the replication set on both 
machines, and the tab_relname matches the correct table in 
pg_catalog.pg_class.

Just a little status update to the problem. The master and slave 
databases still do not match, as they are missing a small chunk of data. 
Yet replication is still taking place, any new data inserted into the 
master ends up on the slave. After doing more looking at it, all the 
data that is missing off the slave were added to the master in a certain 
window of time. We're looking into what happened during that period of 
time via logs and whatnot.

Our daemons are started with the -a command, and I have a copy of every 
archive log from the slony slave since the point of adding that table to 
replication until now. I got a list of every single ID of the rows that 
are missing from the slony slave, and wrote up a little script to search 
for each of those rows ID's in each of the slony archive logs. None of 
them were present. So I think we can conclude that the data was not 
deleted from the slave underneath slony by a user, but rather it was 
never replicated to the slave in the first place.

One thing is that we had a daemon that would attempt to start the slon 
daemons once every minute if they are not running already. Due to a bug, 
it ended up starting a new set of daemons once every minute. This was 
happening before, during, and after the chunk of data that is missing 
was generated. Each minute it generated an error message saying 
"duplicate key value violates unique constraint "sl_nodelock-pkey"", 
which points to the daemon realizing there is already a daemon running, 
and then exit. No other errors pertaining to the replicated table in 
question were present in the postgres logs at this time.

At this point we will probably be removing the table from replication, 
then adding it again and let it sync up.

A question: I'm still a little unfamiliar with a couple aspects of 
slony, but from my understanding (correct me if I'm wrong), when adding 
a table to replication, slonik modifies the table so that whenever a 
insert, delete, update happens, it creates a trigger that alerts slony 
of the existence of data that needs to be sent to the slave nodes. I 
guess my question is, is there a way to insert data into the table and 
cause that trigger effect to not be executed? And if it is possible, 
could that cause the situation of "missing data" that slony itself 
doesn't even know about (since it's reporting everything is in sync). If 
this is possible, then I may have an situation where a user is inserting 
data in an odd way that makes the inserted data not able to be replicated

Thanks,
    Brian Fehrle
> or maybe the table has the wrong tab_reloid in the slave. you can
> probe that with this simple query (the same for sequences):
> select * from _cluster_name.sl_table where tab_reloid <> (tab_nspname
> || '.' || tab_relname)::regclass;
>
>   


From threshar at torgo.978.org  Thu May 27 12:36:40 2010
From: threshar at torgo.978.org (Jeff)
Date: Thu, 27 May 2010 15:36:40 -0400
Subject: [Slony1-general] pg_listener vs autovacuum cancellation
Message-ID: <FB12EFB6-E0E3-4A10-8275-B8179558E631@torgo.978.org>

Just ran into an interesting problem where I had a slave that was  
lagging for no apparent reason.
After some digging I fired up pgspy and watched the timing of queries   
and noticed forwardConfirm was consistently taking a long time (1-2  
seconds).  The queries it issued seemed to be zippy, leaving just the  
notify.

Sure enough:
XXXX=# select * from pgstattuple('pg_listener');
-[ RECORD 1 ]------+----------
table_len          | 312877056
tuple_count        | 3
tuple_len          | 288
tuple_percent      | 0
dead_tuple_count   | 44
dead_tuple_len     | 4224
dead_tuple_percent | 0
free_space         | 299606604
free_percent       | 95.76

we've got a bit of the ol' bloat there. but wait,  I'm running 8.4.2  
shouldn't AV be taking care of that?
Looking at pg_stat_all_tables I see

last_vacuum      |
last_autovacuum  | 2010-05-19 13:21:37.349991-04
last_analyze     | 2010-05-27 14:16:39.887117-04
last_autoanalyze | 2010-05-19 13:21:37.349991-04

well shoot, that was last week!  someone on irc suggested autovac  
cancellation so I looked at my logs and sure enough, pg_listener and  
autovac were NOT getting along (along with some other tables as  
well).  after building a list of the most commonly aborted autovacs I  
checked those out and all had recent autovac records in  
pg_stat_all_tables.

a vacuum full of pg_listener and we're back in business, lag  
immediately dropped to 0.

not sure what I can do to cope with the continued cancellations - I  
would have thought it would have tried again shortly but apparently I  
was wrong.  time to whip up yet another nagios alarm :(

Mostly just putting this out there for others who may have run into  
this.

btw, this is on a patched slony 1.2.17 & pg 8.4.2

--
Jeff Trout <jeff at jefftrout.com>
http://www.stuarthamm.net/
http://www.dellsmartexitin.com/




From jaime at 2ndquadrant.com  Thu May 27 12:48:26 2010
From: jaime at 2ndquadrant.com (Jaime Casanova)
Date: Thu, 27 May 2010 14:48:26 -0500
Subject: [Slony1-general] Table not replicating,
	but no errors reported by 	slony.
In-Reply-To: <4BFEC48F.60101@consistentstate.com>
References: <4BFC087E.30701@consistentstate.com>
	<4BFD8F06.5050607@postgresql.fr> 
	<AANLkTimwqV0WPnLe3vpQHqX2nDjacdIl2r76VNmXeQ0U@mail.gmail.com> 
	<4BFEC48F.60101@consistentstate.com>
Message-ID: <AANLkTimrbRkyf-2pUZGSRN9911--dnCEawhTeIcjVyV-@mail.gmail.com>

On Thu, May 27, 2010 at 2:14 PM, Brian Fehrle
<brianf at consistentstate.com> wrote:
>
>
> A question: I'm still a little unfamiliar with a couple aspects of
> slony, but from my understanding (correct me if I'm wrong), when adding
> a table to replication, slonik modifies the table so that whenever a
> insert, delete, update happens, it creates a trigger that alerts slony
> of the existence of data that needs to be sent to the slave nodes. I
> guess my question is, is there a way to insert data into the table and
> cause that trigger effect to not be executed?

yes, you can disable triggers... before 8.1 you do it by updating the
tg_enabled field in the pg_trigger catalog but after 8.1 you can do:
ALTER TABLE jcm DISABLE TRIGGER [nombre | ALL | USER];

> And if it is possible,
> could that cause the situation of "missing data" that slony itself
> doesn't even know about (since it's reporting everything is in sync). If
> this is possible, then I may have an situation where a user is inserting
> data in an odd way that makes the inserted data not able to be replicated
>

but as you can see one that knows what's doing had to be the
culprit... is not something that happens by "accident"
another posibility is that someone TRUNCATE the slave table at some
point in time (TRUNCATE triggers aren't created by slony because they
appear in 8.4)

--
Jaime Casanova ? ? ? ? www.2ndQuadrant.com
Soporte y capacitaci?n de PostgreSQL

From ssinger at ca.afilias.info  Fri May 28 06:45:24 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Fri, 28 May 2010 09:45:24 -0400
Subject: [Slony1-general] 2.0.4 RC1
Message-ID: <4BFFC8F4.20305@ca.afilias.info>

I have tagged a release candidate for 2.0.4

This includes fixes for the large rows/utf8/memory corruption issue 
introduced with 2.0.3

It would be nice if some people could test this version out and let us 
know if there are any serious issues with it.  Once I've received a 
number of successful test reports we can then do an official 2.0.4 release.


http://lists.slony.info/downloads/2.0/source/slony1-2.0.4.rc1.tar.bz2



-- 
Steve Singer
Afilias Canada
Data Services Developer
416-673-1142

From ssinger at ca.afilias.info  Fri May 28 06:57:02 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Fri, 28 May 2010 09:57:02 -0400
Subject: [Slony1-general] Having a version.rss would be great
In-Reply-To: <4BFE909E.1080703@lelarge.info>
References: <4BFE70F7.6050500@lelarge.info> <4BFE884F.1020803@ca.afilias.info>
	<4BFE9013.30707@ca.afilias.info> <4BFE909E.1080703@lelarge.info>
Message-ID: <4BFFCBAE.7030104@ca.afilias.info>

Guillaume Lelarge wrote:
> Le 27/05/2010 17:30, Christopher Browne a ?crit :

>>  For each tarball
>>
>>    - Create a subdirectory based on version name
>>
>>    - Untar the RELEASE file
>>
>>    - Pull timestamp off the tarball, and generate an RSS entry
>>      consisting of a reference to the release notes, a description
>>      generated out of the release number, and the timestamp
>>
>> The pieces then get assembled into an RSS file.
>>
> 
> It seems way better to me. I'm all for automatic maintenance of this kind :)

Any volunteers to write this makefile/script?



-- 
Steve Singer
Afilias Canada
Data Services Developer
416-673-1142

From guillaume at lelarge.info  Fri May 28 07:05:08 2010
From: guillaume at lelarge.info (Guillaume Lelarge)
Date: Fri, 28 May 2010 16:05:08 +0200
Subject: [Slony1-general] Having a version.rss would be great
In-Reply-To: <4BFFCBAE.7030104@ca.afilias.info>
References: <4BFE70F7.6050500@lelarge.info> <4BFE884F.1020803@ca.afilias.info>
	<4BFE9013.30707@ca.afilias.info> <4BFE909E.1080703@lelarge.info>
	<4BFFCBAE.7030104@ca.afilias.info>
Message-ID: <4BFFCD94.9080208@lelarge.info>

Le 28/05/2010 15:57, Steve Singer a ?crit :
> Guillaume Lelarge wrote:
>> Le 27/05/2010 17:30, Christopher Browne a ?crit :
> 
>>>  For each tarball
>>>
>>>    - Create a subdirectory based on version name
>>>
>>>    - Untar the RELEASE file
>>>
>>>    - Pull timestamp off the tarball, and generate an RSS entry
>>>      consisting of a reference to the release notes, a description
>>>      generated out of the release number, and the timestamp
>>>
>>> The pieces then get assembled into an RSS file.
>>>
>>
>> It seems way better to me. I'm all for automatic maintenance of this
>> kind :)
> 
> Any volunteers to write this makefile/script?
> 

I would be interested in working on this, but I couldn't find the
Makefile Christopher told us about.



-- 
Guillaume
 http://www.postgresql.fr
 http://dalibo.com

From ssinger at ca.afilias.info  Fri May 28 07:09:47 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Fri, 28 May 2010 10:09:47 -0400
Subject: [Slony1-general] Having a version.rss would be great
In-Reply-To: <4BFFCD94.9080208@lelarge.info>
References: <4BFE70F7.6050500@lelarge.info> <4BFE884F.1020803@ca.afilias.info>
	<4BFE9013.30707@ca.afilias.info> <4BFE909E.1080703@lelarge.info>
	<4BFFCBAE.7030104@ca.afilias.info> <4BFFCD94.9080208@lelarge.info>
Message-ID: <4BFFCEAB.2040708@ca.afilias.info>


> 
> I would be interested in working on this, but I couldn't find the
> Makefile Christopher told us about.
> 
> 

The current makefile is literally

------------------
all:
         md5sum * > MD5SUMS

---------------

and sits inside of the downloads/2.0/source  and downloads/1.2/source 
directories on the webserver.  It does not appear to be in cvs (but 
probably should be in the slony1-www project).



-- 
Steve Singer
Afilias Canada
Data Services Developer
416-673-1142

From guillaume at lelarge.info  Fri May 28 07:30:54 2010
From: guillaume at lelarge.info (Guillaume Lelarge)
Date: Fri, 28 May 2010 16:30:54 +0200
Subject: [Slony1-general] Having a version.rss would be great
In-Reply-To: <4BFFCEAB.2040708@ca.afilias.info>
References: <4BFE70F7.6050500@lelarge.info> <4BFE884F.1020803@ca.afilias.info>
	<4BFE9013.30707@ca.afilias.info> <4BFE909E.1080703@lelarge.info>
	<4BFFCBAE.7030104@ca.afilias.info> <4BFFCD94.9080208@lelarge.info>
	<4BFFCEAB.2040708@ca.afilias.info>
Message-ID: <4BFFD39E.1070806@lelarge.info>

Le 28/05/2010 16:09, Steve Singer a ?crit :
> 
>>
>> I would be interested in working on this, but I couldn't find the
>> Makefile Christopher told us about.
>>
>>
> 
> The current makefile is literally
> 
> ------------------
> all:
>         md5sum * > MD5SUMS
> 
> ---------------
> 
> and sits inside of the downloads/2.0/source  and downloads/1.2/source
> directories on the webserver.  It does not appear to be in cvs (but
> probably should be in the slony1-www project).
> 

OK, working on it.


-- 
Guillaume
 http://www.postgresql.fr
 http://dalibo.com

From cbbrowne at ca.afilias.info  Fri May 28 08:11:13 2010
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Fri, 28 May 2010 15:11:13 +0000
Subject: [Slony1-general] Having a version.rss would be great
In-Reply-To: <4BFFCD94.9080208@lelarge.info>
References: <4BFE70F7.6050500@lelarge.info> <4BFE884F.1020803@ca.afilias.info>
	<4BFE9013.30707@ca.afilias.info> <4BFE909E.1080703@lelarge.info>
	<4BFFCBAE.7030104@ca.afilias.info> <4BFFCD94.9080208@lelarge.info>
Message-ID: <4BFFDD11.2050701@ca.afilias.info>

Guillaume Lelarge wrote:
> Le 28/05/2010 15:57, Steve Singer a ?crit :
>> Guillaume Lelarge wrote:
>>> Le 27/05/2010 17:30, Christopher Browne a ?crit :
>>>>  For each tarball
>>>>
>>>>    - Create a subdirectory based on version name
>>>>
>>>>    - Untar the RELEASE file
>>>>
>>>>    - Pull timestamp off the tarball, and generate an RSS entry
>>>>      consisting of a reference to the release notes, a description
>>>>      generated out of the release number, and the timestamp
>>>>
>>>> The pieces then get assembled into an RSS file.
>>>>
>>> It seems way better to me. I'm all for automatic maintenance of this
>>> kind :)
>> Any volunteers to write this makefile/script?
>>
> 
> I would be interested in working on this, but I couldn't find the
> Makefile Christopher told us about.

There's a makefile in each of the download directories, thus:

cbbrowne at main:/home/community/slony/htdocs/downloads/2.0/source$ ls -l
total 13328
-rw-rw-rw- 1 cbbrowne slony      1264 May 28 06:40 MD5SUMS
-rw-rw-rw- 1 cbbrowne slony        25 Jun 27  2008 Makefile
-rw-r--r-- 1 cbbrowne slony    227071 Nov 24  2008 slony1-2.0.0-docs.tar.bz2
-rw-rw-rw- 1 cbbrowne slony    222752 Jun 27  2008 
slony1-2.0.0-rc1-docs.tar.bz2
-rw-rw-rw- 1 cbbrowne slony    903376 Jun 27  2008 slony1-2.0.0-rc1.tar.bz2
-rw-r--r-- 1 cbbrowne slony   1135050 Sep 24  2008 slony1-2.0.0-rc2.tar.bz2
-rw-r--r-- 1 cbbrowne slony    909567 Nov 24  2008 slony1-2.0.0.tar.bz2
-rw-r--r-- 1 cbbrowne slony    244898 Mar  2  2009 slony1-2.0.1-docs.tar.bz2
-rw-r--r-- 1 cbbrowne slony    934787 Mar  2  2009 slony1-2.0.1.tar.bz2
-rw-r--r-- 1 cbbrowne slony    242622 May  8  2009 slony1-2.0.2-docs.tar.bz2
-rw-r--r-- 1 cbbrowne slony    933307 Apr 30  2009 slony1-2.0.2-rc.tar.bz2
-rw-r--r-- 1 cbbrowne slony    933793 May  8  2009 slony1-2.0.2.tar.bz2
-rw-r--r-- 1 ssinger  ssinger  219032 Apr  9 14:37 slony1-2.0.3-doc.tar.bz2
-rw-r--r-- 1 devrim   devrim   219032 Apr 25 02:57 slony1-2.0.3-docs.tar.bz2
-rw-r--r-- 1 cbbrowne slony    989184 Jul 29  2009 slony1-2.0.3-rc.tar.bz2
-rw-r--r-- 1 cbbrowne slony    231012 Sep  4  2009 
slony1-2.0.3-rc2-doc.tar.bz2
-rw-r--r-- 1 cbbrowne slony    983499 Aug 12  2009 slony1-2.0.3-rc2.tar.bz2
-rw-rw-rw- 1 cbbrowne slony    982847 Nov 20  2009 slony1-2.0.3-rc3.tar.bz2
-rw-r--r-- 1 cbbrowne slony    210169 Apr  6 13:54 
slony1-2.0.3-rc4-doc.tar.bz2
-rw-r--r-- 1 cbbrowne slony    987934 Apr  6 13:54 slony1-2.0.3-rc4.tar.bz2
-rw-r--r-- 1 ssinger  ssinger 1003446 Apr  9 13:34 slony1-2.0.3.tar.bz2
-rw-r--r-- 1 ssinger  ssinger 1003433 May 28 06:39 slony1-2.0.4.rc1.tar.bz2
cbbrowne at main:/home/community/slony/htdocs/downloads/2.0/source$ cat 
Makefile
all:
         md5sum * > MD5SUMS

Probably not sitting in CVS.  I suppose that when we migrate to git, it 
would likely be a good idea to add the downloads explicitly to the 
repository.  It's not a huge amount of data, and tracking them isn't too 
expensive.
-- 
(reverse (concatenate 'string "ofni.sailifa.ac" "@" "enworbbc"))
<http://dba2.int.libertyrms.com/>
Christopher Browne
(416) 673-4124 (land)

From singh.gurjeet at gmail.com  Fri May 28 11:39:46 2010
From: singh.gurjeet at gmail.com (Gurjeet Singh)
Date: Fri, 28 May 2010 14:39:46 -0400
Subject: [Slony1-general] 2.0.4 RC1
In-Reply-To: <4BFFC8F4.20305@ca.afilias.info>
References: <4BFFC8F4.20305@ca.afilias.info>
Message-ID: <AANLkTil6oottZSmC43fh9U7Py7OTXX--O81XjqSaWogv@mail.gmail.com>

On Fri, May 28, 2010 at 9:45 AM, Steve Singer <ssinger at ca.afilias.info>wrote:

> I have tagged a release candidate for 2.0.4
>
> This includes fixes for the large rows/utf8/memory corruption issue
> introduced with 2.0.3
>
> It would be nice if some people could test this version out and let us
> know if there are any serious issues with it.  Once I've received a
> number of successful test reports we can then do an official 2.0.4 release.
>
>
> http://lists.slony.info/downloads/2.0/source/slony1-2.0.4.rc1.tar.bz2
>
>
Does this include the patches to fix memory-leak, sent recently by Ulrich
Weber?

Regards,

-- 
gurjeet.singh
@ EnterpriseDB - The Enterprise Postgres Company
http://www.enterprisedb.com

singh.gurjeet@{ gmail | yahoo }.com
Twitter/Skype: singh_gurjeet

Mail sent from my BlackLaptop device
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20100528/6c70c49e/attachment-0001.htm 

From ssinger at ca.afilias.info  Fri May 28 11:55:19 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Fri, 28 May 2010 14:55:19 -0400
Subject: [Slony1-general] 2.0.4 RC1
In-Reply-To: <AANLkTil6oottZSmC43fh9U7Py7OTXX--O81XjqSaWogv@mail.gmail.com>
References: <4BFFC8F4.20305@ca.afilias.info>
	<AANLkTil6oottZSmC43fh9U7Py7OTXX--O81XjqSaWogv@mail.gmail.com>
Message-ID: <4C001197.4080502@ca.afilias.info>

Gurjeet Singh wrote:
> Does this include the patches to fix memory-leak, sent recently by 
> Ulrich Weber?

It does not.

The memory corruption issue that appeared in 2.0.3 was caused by an 
attempt to fix memory leak issues that were a placed a bit too early in 
the code (that particular leak was fixed with the fix that was included 
in 2.0.3) so I'm a bit uneasy about trying to push more memory leak 
fixes into this release.

My inclination is to commit those to the 2.0 branch just after we 
release 2.0.4 so they'd be included in 2.0.5 so they'd be able to sit in 
cvs a bit longer (and have the benefit of more of the automated tests we 
are working on being finished)

Having said that, if the user community thinks they should be included 
in 2.0.4 I'm open to arguments.

Particularly if

A) Some people have already been using/testing these fixes against the 
2.0 branch and are reporting success

B) People are finding these memory leaks a big deal vs a minor annoyance.


> 
> Regards,
> 
> -- 
> gurjeet.singh
> @ EnterpriseDB - The Enterprise Postgres Company
> http://www.enterprisedb.com
> 
> singh.gurjeet@{ gmail | yahoo }.com
> Twitter/Skype: singh_gurjeet
> 
> Mail sent from my BlackLaptop device


-- 
Steve Singer
Afilias Canada
Data Services Developer
416-673-1142

From singh.gurjeet at gmail.com  Fri May 28 13:56:51 2010
From: singh.gurjeet at gmail.com (Gurjeet Singh)
Date: Fri, 28 May 2010 16:56:51 -0400
Subject: [Slony1-general] 2.0.4 RC1
In-Reply-To: <4C001197.4080502@ca.afilias.info>
References: <4BFFC8F4.20305@ca.afilias.info>
	<AANLkTil6oottZSmC43fh9U7Py7OTXX--O81XjqSaWogv@mail.gmail.com> 
	<4C001197.4080502@ca.afilias.info>
Message-ID: <AANLkTinOicW_y6F4Qcp_pcGcJrj3-gs9n1OzOibWS-q8@mail.gmail.com>

On Fri, May 28, 2010 at 2:55 PM, Steve Singer <ssinger at ca.afilias.info>wrote:

> Gurjeet Singh wrote:
>
>> Does this include the patches to fix memory-leak, sent recently by Ulrich
>> Weber?
>>
>
> It does not.
>
> The memory corruption issue that appeared in 2.0.3 was caused by an attempt
> to fix memory leak issues that were a placed a bit too early in the code
> (that particular leak was fixed with the fix that was included in 2.0.3) so
> I'm a bit uneasy about trying to push more memory leak fixes into this
> release.
>
> My inclination is to commit those to the 2.0 branch just after we release
> 2.0.4 so they'd be included in 2.0.5 so they'd be able to sit in cvs a bit
> longer (and have the benefit of more of the automated tests we are working
> on being finished)
>
> Having said that, if the user community thinks they should be included in
> 2.0.4 I'm open to arguments.
>
> Particularly if
>
> A) Some people have already been using/testing these fixes against the 2.0
> branch and are reporting success
>
> B) People are finding these memory leaks a big deal vs a minor annoyance.
>
>
One of our customers is looking to deploy this in an almost unattended
environment, and having memory leaks in Slon will most definitely hurt their
ability to deploy it with confidence.

I would prefer to see the patch incorporated in 2.0.4 and have people test
the RC1 than have it included after 2.0.4 in the hopes that people would
test the CVS version.

Regards,
-- 
gurjeet.singh
@ EnterpriseDB - The Enterprise Postgres Company
http://www.EnterpriseDB.com

singh.gurjeet@{ gmail | yahoo }.com
Twitter/Skype: singh_gurjeet

Mail sent from my BlackLaptop device
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20100528/fcec12a5/attachment.htm 

From ssinger at ca.afilias.info  Fri May 28 15:57:05 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Fri, 28 May 2010 18:57:05 -0400
Subject: [Slony1-general] 2.0.4 RC1
In-Reply-To: <AANLkTinOicW_y6F4Qcp_pcGcJrj3-gs9n1OzOibWS-q8@mail.gmail.com>
References: <4BFFC8F4.20305@ca.afilias.info>
	<AANLkTil6oottZSmC43fh9U7Py7OTXX--O81XjqSaWogv@mail.gmail.com>
	<4C001197.4080502@ca.afilias.info>
	<AANLkTinOicW_y6F4Qcp_pcGcJrj3-gs9n1OzOibWS-q8@mail.gmail.com>
Message-ID: <4C004A41.6030800@ca.afilias.info>

Gurjeet Singh wrote:
> On Fri, May 28, 2010 at 2:55 PM, Steve Singer <ssinger at ca.afilias.info 

> One of our customers is looking to deploy this in an almost unattended 
> environment, and having memory leaks in Slon will most definitely hurt 
> their ability to deploy it with confidence.
> 
> I would prefer to see the patch incorporated in 2.0.4 and have people 
> test the RC1 than have it included after 2.0.4 in the hopes that people 
> would test the CVS version.

What do others think?

I take it your offering to give the leak memory hanges a good workout 
before we tag 2.0.4 final?


(A version of 2.0.4 RC1 + these changes can be found at 
http://github.com/ssinger/slony/tree/203_memfixes_UlrichWeber)



> 
> Regards,
> -- 
> gurjeet.singh
> @ EnterpriseDB - The Enterprise Postgres Company
> http://www.EnterpriseDB.com
> 
> singh.gurjeet@{ gmail | yahoo }.com
> Twitter/Skype: singh_gurjeet
> 
> Mail sent from my BlackLaptop device


-- 
Steve Singer
Afilias Canada
Data Services Developer
416-673-1142

From david at fetter.org  Sat May 29 18:41:37 2010
From: david at fetter.org (David Fetter)
Date: Sat, 29 May 2010 18:41:37 -0700
Subject: [Slony1-general] 2.0.4 RC1
In-Reply-To: <4C004A41.6030800@ca.afilias.info>
References: <4BFFC8F4.20305@ca.afilias.info>
	<AANLkTil6oottZSmC43fh9U7Py7OTXX--O81XjqSaWogv@mail.gmail.com>
	<4C001197.4080502@ca.afilias.info>
	<AANLkTinOicW_y6F4Qcp_pcGcJrj3-gs9n1OzOibWS-q8@mail.gmail.com>
	<4C004A41.6030800@ca.afilias.info>
Message-ID: <20100530014137.GE3615@fetter.org>

On Fri, May 28, 2010 at 06:57:05PM -0400, Steve Singer wrote:
> Gurjeet Singh wrote:
> > On Fri, May 28, 2010 at 2:55 PM, Steve Singer <ssinger at ca.afilias.info 
> 
> > One of our customers is looking to deploy this in an almost unattended 
> > environment, and having memory leaks in Slon will most definitely hurt 
> > their ability to deploy it with confidence.
> > 
> > I would prefer to see the patch incorporated in 2.0.4 and have people 
> > test the RC1 than have it included after 2.0.4 in the hopes that people 
> > would test the CVS version.
> 
> What do others think?

I think the right thing to do is fix the leak and if needed, roll more
RCs.

It's already asking a lot of people to test RCs.  Asking people to
pull from some random SCM system and test that will trim that already
tiny group.

> I take it your offering to give the leak memory hanges a good workout 
> before we tag 2.0.4 final?

I suspect I can find people who will :)

Cheers,
David.
-- 
David Fetter <david at fetter.org> http://fetter.org/
Phone: +1 415 235 3778  AIM: dfetter666  Yahoo!: dfetter
Skype: davidfetter      XMPP: david.fetter at gmail.com
iCal: webcal://www.tripit.com/feed/ical/people/david74/tripit.ics

Remember to vote!
Consider donating to Postgres: http://www.postgresql.org/about/donate

From scott.marlowe at gmail.com  Sun May 30 23:08:02 2010
From: scott.marlowe at gmail.com (Scott Marlowe)
Date: Mon, 31 May 2010 00:08:02 -0600
Subject: [Slony1-general] corrupted slave
Message-ID: <AANLkTinvcYrTBwD5GQVeB4kSqWc1akBGTZpoDRF5h7Hq@mail.gmail.com>

I have a slave db that has a corrupted data store, and it may or may
not start up and / or run slony commands reliably.

How do I remove it from the cluster?  I know of failover commands that
make a slave take over for a failed master, but I'm not sure I'm
seeing anything similar to just excise a read slave from the slony
cluster.

Any advice would be appreciated.

From ssinger_pg at sympatico.ca  Mon May 31 04:17:12 2010
From: ssinger_pg at sympatico.ca (Steve Singer)
Date: Mon, 31 May 2010 07:17:12 -0400 (EDT)
Subject: [Slony1-general] corrupted slave
In-Reply-To: <AANLkTinvcYrTBwD5GQVeB4kSqWc1akBGTZpoDRF5h7Hq@mail.gmail.com>
References: <AANLkTinvcYrTBwD5GQVeB4kSqWc1akBGTZpoDRF5h7Hq@mail.gmail.com>
Message-ID: <BLU0-SMTP154E99D9E64E351CCFDE85ACEE0@phx.gbl>

On Mon, 31 May 2010, Scott Marlowe wrote:

> I have a slave db that has a corrupted data store, and it may or may
> not start up and / or run slony commands reliably.
>
> How do I remove it from the cluster?  I know of failover commands that
> make a slave take over for a failed master, but I'm not sure I'm
> seeing anything similar to just excise a read slave from the slony
> cluster.

I think you want the DROP NODE command.

http://www.slony.info/documentation/stmtdropnode.html

>
> Any advice would be appreciated.
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
>


From l.bolzani at gmail.com  Mon May 31 06:25:24 2010
From: l.bolzani at gmail.com (Lorenzo Bolzani)
Date: Mon, 31 May 2010 15:25:24 +0200
Subject: [Slony1-general] Slony with different schemas
Message-ID: <AANLkTikgOh4Tmd1D1D7vl6FyW8d7ekcrlVmS-kSmrtXW@mail.gmail.com>

Hi all,
I'm evaluating for my current project.

I suspect this question has been answered several times but I checked the
docs and google and I didn't found a clear answer.

Can slony be used if the slave schemas are slightly different from the
master one?

We have a 1 master and 2 slave installations of a system automation
application. The application can be upgraded independently on the three
nodes.

So this could be an actual scenario:

master:  version 1.34
slave1:  version  1.35
slave2:  version  1.32

Any version update could imply some schema changes, for example:

- add/drop/modify a column
- add/drop a table

The schema changes must NOT be replicated because any version of the running
application expects different schemas (of course small changes can be
replicated without problems).

What I'd like slony to do is to handle missing columns (with defaults if not
null), extra columns (ignoring), and for big changes transform data through
a custom script.

Can this be achieved?

It's acceptable, for the most complex cases, to use temporary tables to save
changes to be applied later on the actual ones.


Thanks for any pointer


Bye

Lorenzo
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20100531/6e252235/attachment.htm 

From scott.marlowe at gmail.com  Mon May 31 06:35:53 2010
From: scott.marlowe at gmail.com (Scott Marlowe)
Date: Mon, 31 May 2010 07:35:53 -0600
Subject: [Slony1-general] Slony with different schemas
In-Reply-To: <AANLkTikgOh4Tmd1D1D7vl6FyW8d7ekcrlVmS-kSmrtXW@mail.gmail.com>
References: <AANLkTikgOh4Tmd1D1D7vl6FyW8d7ekcrlVmS-kSmrtXW@mail.gmail.com>
Message-ID: <AANLkTin2X3UgKnIASP2syAtFVgeGz11mtXdtxqgdQw9i@mail.gmail.com>

On Mon, May 31, 2010 at 7:25 AM, Lorenzo Bolzani <l.bolzani at gmail.com> wrote:
>
> Hi all,
> I'm evaluating for my current project.
>
> I suspect this question has been answered several times but I checked the
> docs and google and I didn't found a clear answer.
>
> Can slony be used if the slave schemas are slightly different from the
> master one?
>
> We have a 1 master and 2 slave installations of a system automation
> application. The application can be upgraded independently on the three
> nodes.
>
> So this could be an actual scenario:
>
> master:? version 1.34
> slave1:? version? 1.35
> slave2:? version? 1.32
>
> Any version update could imply some schema changes, for example:
>
> - add/drop/modify a column
> - add/drop a table
>
> The schema changes must NOT be replicated because any version of the running
> application expects different schemas (of course small changes can be
> replicated without problems).
>
> What I'd like slony to do is to handle missing columns (with defaults if not
> null), extra columns (ignoring), and for big changes transform data through
> a custom script.
>
> Can this be achieved?

Not really.  Slony expects the schemas on each node to match up.  I'm
guessing you could have extra fields maybe, but not fewer, on a
destination table.  You would have to burn down / recreate your set
each time, as applying changes to the schema like you're talking about
will break replication in a set that's already up and running.

From melvin6925 at yahoo.com  Mon May 31 06:38:14 2010
From: melvin6925 at yahoo.com (Melvin Davidson)
Date: Mon, 31 May 2010 06:38:14 -0700 (PDT)
Subject: [Slony1-general] Slony with different schemas
In-Reply-To: <AANLkTikgOh4Tmd1D1D7vl6FyW8d7ekcrlVmS-kSmrtXW@mail.gmail.com>
Message-ID: <3704.90630.qm@web53008.mail.re2.yahoo.com>

>Can slony be used if the slave schemas are slightly different from the 
master one?

The short simple answer is no.

For slony to work correctly, all versions of slony on master and slaves must be the same version. But most important, slony _cannot_ handle missing columns. That is specifically stated in the Current Limitations section. Slony-I does not automatically 
propagate schema changes, nor
does it have any ability to replicate large objects. 
http://slony.info/documentation/slonyintro.html#INTRODUCTION

It is your responsibility to insure that all schemas are identical. That is why EXECUTE SCRIPT is used to maintain the changes. 
http://slony.info/documentation/stmtddlscript.html

You do have the option of only replicating tables that are identical across all schemas, but I doubt that would be of help to you in this scenario.

Melvin Davidson 
 



      
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20100531/1cb135a7/attachment.htm 

From ssinger at ca.afilias.info  Mon May 31 06:41:15 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Mon, 31 May 2010 09:41:15 -0400
Subject: [Slony1-general] Slony with different schemas
In-Reply-To: <AANLkTikgOh4Tmd1D1D7vl6FyW8d7ekcrlVmS-kSmrtXW@mail.gmail.com>
References: <AANLkTikgOh4Tmd1D1D7vl6FyW8d7ekcrlVmS-kSmrtXW@mail.gmail.com>
Message-ID: <4C03BC7B.7050604@ca.afilias.info>

Lorenzo Bolzani wrote:
> 
> Hi all,
> I'm evaluating for my current project.
> 
> I suspect this question has been answered several times but I checked 
> the docs and google and I didn't found a clear answer.

That is because the answer is "it depends"

> 
> Can slony be used if the slave schemas are slightly different from the 
> master one?
> 

Yes, depending on what 'slightly means'

> We have a 1 master and 2 slave installations of a system automation 
> application. The application can be upgraded independently on the three 
> nodes.
> 
> So this could be an actual scenario:
> 
> master:  version 1.34
> slave1:  version  1.35
> slave2:  version  1.32
> 
> Any version update could imply some schema changes, for example:
> 
> - add/drop/modify a column

You can add columns on the replica safely (if your using version 1.2.x 
remember to use EXECUTE SCRIPT  with the ONLY ON option).

If you DROP a column from the replica on a replicated table you will 
have a problem when slony tries to replicate data into the table but you 
can drop columns from the origin before they are dropped from the 
replica (as long as they are NOT NULL columns).




> - add/drop a table
>

You can add a table to the origin and not replicate it, similarly you 
can add a table to the replica and it doesn't need to exist on the 
origin.   If you want to drop a replicated table you will need to first 
make it a non-replicated table by removing it from your replication set 
(then you can do whatever you want, assuming you have no foreign key 
issues, since it isn't replicated anymore)



> The schema changes must NOT be replicated because any version of the 
> running application expects different schemas (of course small changes 
> can be replicated without problems).
> 
> What I'd like slony to do is to handle missing columns (with defaults if 
> not null), extra columns (ignoring), and for big changes transform data 
> through a custom script.
> 
> Can this be achieved?

I think so, if your careful about the ordering you apply things etc...

> 
> It's acceptable, for the most complex cases, to use temporary tables to 
> save changes to be applied later on the actual ones.
> 
> 
> Thanks for any pointer
> 
> 
> Bye
> 
> Lorenzo
> 
> 
> 
> ------------------------------------------------------------------------
> 
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


-- 
Steve Singer
Afilias Canada
Data Services Developer
416-673-1142

From ssinger at ca.afilias.info  Mon May 31 06:54:16 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Mon, 31 May 2010 09:54:16 -0400
Subject: [Slony1-general] Slony with different schemas
In-Reply-To: <4C03BC7B.7050604@ca.afilias.info>
References: <AANLkTikgOh4Tmd1D1D7vl6FyW8d7ekcrlVmS-kSmrtXW@mail.gmail.com>
	<4C03BC7B.7050604@ca.afilias.info>
Message-ID: <4C03BF88.4090001@ca.afilias.info>

Steve Singer wrote:
> Lorenzo Bolzani wrote:
>> Hi all,
>> What I'd like slony to do is to handle missing columns (with defaults if 
>> not null), extra columns (ignoring), and for big changes transform data 
>> through a custom script.
>>
>> Can this be achieved?
> 
> I think so, if your careful about the ordering you apply things etc...

I should clarify.

-Extra columns on the replicas are okay
-Extra columns on the origin are NOT okay

DEFAULT values will NOT be filled in on the replicas they columns will 
be left as NULL.





> 
>> It's acceptable, for the most complex cases, to use temporary tables to 
>> save changes to be applied later on the actual ones.
>>
>>
>> Thanks for any pointer
>>
>>
>> Bye
>>
>> Lorenzo
>>
>>
>>
>> ------------------------------------------------------------------------
>>
>> _______________________________________________
>> Slony1-general mailing list
>> Slony1-general at lists.slony.info
>> http://lists.slony.info/mailman/listinfo/slony1-general
> 
> 


-- 
Steve Singer
Afilias Canada
Data Services Developer
416-673-1142

From l.bolzani at gmail.com  Mon May 31 07:43:45 2010
From: l.bolzani at gmail.com (Lorenzo Bolzani)
Date: Mon, 31 May 2010 16:43:45 +0200
Subject: [Slony1-general] Slony with different schemas
In-Reply-To: <AANLkTin2X3UgKnIASP2syAtFVgeGz11mtXdtxqgdQw9i@mail.gmail.com>
References: <AANLkTikgOh4Tmd1D1D7vl6FyW8d7ekcrlVmS-kSmrtXW@mail.gmail.com>
	<AANLkTin2X3UgKnIASP2syAtFVgeGz11mtXdtxqgdQw9i@mail.gmail.com>
Message-ID: <AANLkTik3OKuU5Jd9koPr3FAmtY5m-atjavJrBFfmgsWM@mail.gmail.com>

Hi, thanks all for the replies.

If I can take advantage of your expertise in this field, how would you
handle this scenario?

Each installation is upgraded on it's own without any specific order.
Upgrading all the three plants at once is not an option, so schemas
sometimes will be slightly different.

I'm considering to use a message exchange like this

<table="aaa" op=insert>
<column name=""/>
...

and then process each message in a custom "apply" method custom written for
each slave plant. But I fee a LOT like I'm reinventing the wheel.

I cannot use any complex tool for data migration because there is not, nor
there will be, the expertise for it and 99% of the differences should be
trivial.

For very complex schema changes I think some different strategy coud be
evaluated. In these cases I think a "data-migration only" upgrade could be
considered.



Thanks, bye

Lorenzo
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20100531/77ab5d35/attachment.htm 

From ajs at crankycanuck.ca  Mon May 31 08:46:44 2010
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Mon, 31 May 2010 11:46:44 -0400
Subject: [Slony1-general] Slony with different schemas
In-Reply-To: <AANLkTikgOh4Tmd1D1D7vl6FyW8d7ekcrlVmS-kSmrtXW@mail.gmail.com>
References: <AANLkTikgOh4Tmd1D1D7vl6FyW8d7ekcrlVmS-kSmrtXW@mail.gmail.com>
Message-ID: <20100531154639.GA45740@shinkuro.com>

On Mon, May 31, 2010 at 03:25:24PM +0200, Lorenzo Bolzani wrote:
> 
> So this could be an actual scenario:
> 
> master:  version 1.34
> slave1:  version  1.35
> slave2:  version  1.32
> 
> Any version update could imply some schema changes, for example:
> 
> - add/drop/modify a column
> - add/drop a table

You're not going to be able to do this without a lot of pain.

However, one way you could maybe do it is with quite complicated
views.  I think this would be more painful than it would be worth, but
I investigated the feasibility of this for someone one time, and it
was just possible.

A



-- 
Andrew Sullivan
ajs at crankycanuck.ca

From ssinger at ca.afilias.info  Mon May 31 08:51:47 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Mon, 31 May 2010 11:51:47 -0400
Subject: [Slony1-general] Slony with different schemas
In-Reply-To: <20100531154639.GA45740@shinkuro.com>
References: <AANLkTikgOh4Tmd1D1D7vl6FyW8d7ekcrlVmS-kSmrtXW@mail.gmail.com>
	<20100531154639.GA45740@shinkuro.com>
Message-ID: <4C03DB13.3070400@ca.afilias.info>

Andrew Sullivan wrote:
> On Mon, May 31, 2010 at 03:25:24PM +0200, Lorenzo Bolzani wrote:
>> So this could be an actual scenario:
>>
>> master:  version 1.34
>> slave1:  version  1.35
>> slave2:  version  1.32
>>
>> Any version update could imply some schema changes, for example:
>>
>> - add/drop/modify a column
>> - add/drop a table
> 
> You're not going to be able to do this without a lot of pain.
> 
> However, one way you could maybe do it is with quite complicated
> views.  I think this would be more painful than it would be worth, but
> I investigated the feasibility of this for someone one time, and it
> was just possible.
> 

Techniques along these lines are described in Scott Ambler's 'Database 
Refactoring' book 
(http://www.amazon.com/Refactoring-Databases-Evolutionary-Database-Design/dp/0321293533/ref=sr_1_1?ie=UTF8&s=books&qid=1275320926&sr=8-1)

The idea is that you use a mixture of views and triggers to have 1 
schema that can be used by both versions of the applications that expect 
different schemas.  You then upgrade all your applications and then you 
swap the schema out to one that only has support for the newer version 
of the application.

This sounds like a lot of extra work




> A
> 
> 
> 


-- 
Steve Singer
Afilias Canada
Data Services Developer
416-673-1142

From msquires at whitepages.com  Mon May 31 09:54:47 2010
From: msquires at whitepages.com (Michael Squires)
Date: Mon, 31 May 2010 09:54:47 -0700
Subject: [Slony1-general] Slony with different schemas
In-Reply-To: <AANLkTikgOh4Tmd1D1D7vl6FyW8d7ekcrlVmS-kSmrtXW@mail.gmail.com>
References: <AANLkTikgOh4Tmd1D1D7vl6FyW8d7ekcrlVmS-kSmrtXW@mail.gmail.com>
Message-ID: <4C03E9D7.4080809@whitepages.com>

I'd encourage you to explore ways to constrain your requirements in some way.

Regardless of your ability to play tricks on slony in this scenario, it feels like you are setting
yourself up for a testing and operational nightmare.

Maybe a better way to visualize this is to forget replication for a minute. Imagine that I have a
single machine that has the 1.32, 1.34, and 1.35 applications installed on it such that I can stop
one application and start another one at any time. Imagine that I have a magic tool that will take
the data for a 1.34 schema and copy it to a 1.35 schema.

If I need to be prepared to stop version X, run the magic tool to convert the data, and start
version Y at any point in time, what do I need to do? I need to test for full forward and backward
compatibility (i.e., I need to run a 1.32 application against a database that was written by a 1.35
application (with suitable magic changes) - and vice versa). I need to constrain my schema changes
in such a way that an old application can run without the new column entirely, and a newer
application can do its work rationally without counting on having that column populated.

Are you using slony strictly for one-way replication (e.g., the current master node will always be
the master, with data flowing out to the slaves) or do you need to be prepared to have any slave
become a master?

If you need to be able to have any node be a master, then you have the full weight of the arbitrary
testing scenario on you. If node 1 is the only one that can be a master, and you are able to at
least set things up such that node 1 is always the first (or last) upgraded, then you can simplify
your testing quite a bit.

If your applications have subtle bugs due to forward/backward compatability issues, or you aren't
able to failover nodes when you need to, having a more contrained but more easily verified system
will look cheap in comparison.

I don't know how hard your constraints are or where you might have some flexibility. My concern is
that you may have both feet in a bucket and one hand tied behind your back, and it's not clear that
our advice (from the slony community) telling you how you can hop sideways while spinning a bit in
the air will really help you solve your true business problem.

Michael

On 5/31/10 6:25 AM, Lorenzo Bolzani wrote:
> 
> Hi all,
> I'm evaluating for my current project.
> 
> I suspect this question has been answered several times but I checked
> the docs and google and I didn't found a clear answer.
> 
> Can slony be used if the slave schemas are slightly different from the
> master one?
> 
> We have a 1 master and 2 slave installations of a system automation
> application. The application can be upgraded independently on the three
> nodes.
> 
> So this could be an actual scenario:
> 
> master:  version 1.34
> slave1:  version  1.35
> slave2:  version  1.32
> 
> Any version update could imply some schema changes, for example:
> 
> - add/drop/modify a column
> - add/drop a table
> 
> The schema changes must NOT be replicated because any version of the
> running application expects different schemas (of course small changes
> can be replicated without problems).
> 
> What I'd like slony to do is to handle missing columns (with defaults if
> not null), extra columns (ignoring), and for big changes transform data
> through a custom script.
> 
> Can this be achieved?
> 
> It's acceptable, for the most complex cases, to use temporary tables to
> save changes to be applied later on the actual ones.
> 
> 
> Thanks for any pointer
> 
> 
> Bye
> 
> Lorenzo
> 
> 

From ajs at crankycanuck.ca  Mon May 31 21:01:50 2010
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Tue, 1 Jun 2010 00:01:50 -0400
Subject: [Slony1-general] Slony with different schemas
In-Reply-To: <4C03DB13.3070400@ca.afilias.info>
References: <AANLkTikgOh4Tmd1D1D7vl6FyW8d7ekcrlVmS-kSmrtXW@mail.gmail.com>
	<20100531154639.GA45740@shinkuro.com>
	<4C03DB13.3070400@ca.afilias.info>
Message-ID: <20100601040148.GI45740@shinkuro.com>

On Mon, May 31, 2010 at 11:51:47AM -0400, Steve Singer wrote:
> The idea is that you use a mixture of views and triggers to have 1  
> schema that can be used by both versions of the applications that expect  
> different schemas.  You then upgrade all your applications and then you  

Exactly right.

> This sounds like a lot of extra work

You bet.  On the other hand, if the alternative is "rewrite the
application" and you know SQL better than whatever the application is
written in (or the application is written in such a way that no human
could understand how it got that way grumble five files to set up a
database pool grumble no I know nothing about this), it might be
easier anyway.

A

-- 
Andrew Sullivan
ajs at crankycanuck.ca

From JanWieck at Yahoo.com  Mon May 31 19:08:03 2010
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Mon, 31 May 2010 22:08:03 -0400
Subject: [Slony1-general] child terminated status: 11 -> restart
 of	worker in 10 seconds
In-Reply-To: <20100526121810.GC8987@troy.imm>
References: <4BFBB25B.5010709@tactel.se> <4BFBD55F.9000200@ca.afilias.info>
	<20100526121810.GC8987@troy.imm>
Message-ID: <4C046B83.3080900@Yahoo.com>

On 5/26/2010 8:18 AM, aiwaniuk at instytut.com.pl wrote:
> On Tue, May 25, 2010 at 09:49:19AM -0400, Steve Singer wrote:
>> > segfault at 273936 ip 00007f359f4f4c40 sp 00007f359b982698 error 4 in
>> > libc-2.9.so[7f359f474000+168000]
>> 
>> Can you rub gdb against a core file, or start slony up inside of gdb, so 
>> we can get a stack trace of what slon was doing went it died?
>> 
>> (from a build with debugging symbols would be even more useful)
> 
> i've faced the same problem while replicating postgres8.3 using slony
> 2.0.3
> subscribe operation had finisher successfully, but then while synchronizing
> tables i still have segfaults. backtrace has shown
> 
> #0  0xb7761f93 in strlen () from /lib/libc.so.6
> #1  0x0805e35d in slon_appendquery_int (dsp=0xb4b11a38, fmt=0x8068af5
> "_log_%d_",ap=0xb42fe1cc "\f`????\022??\t\b\036??\t\b0??\006\b\020??\t\b\022??\t\b\036??\t\b\214??/????\v?
??\b\f?
??\002")   at /usr/include/bits/string3.h:52
> #2  0x0805e7d7 in snprintf (conn=0xb4b11a38) at /usr/include/bits/stdio2.h:65
> #3  db_checkSchemaVersion (conn=0xb4b11a38) at dbutils.c:311
> #4  0x08051f75 in sync_helper (cdata=0xb4c4600c) at remote_worker.c:4993

There are things that make me believe this stack itself is mangled 
already to a point where it is useless for tracing purposes.

1) sync_helper() of 1.2.15 does not call db_checkSchemaVersion() on line 
4993. It performs a slon_mkquery() to build the query string to select 
from sl_log_2.

2) slon_appendquery_int() is definitely not located in string3.h and 
should never be called from snprintf() anyway.

Reading through the release notes of versions later than 1.2.15 this one 
from 1.2.20 strikes me as particular suspicious:

> Fix problem with logging where vsnprintf would, with very large output, 
 > clobber the byte after malloc()ed output

I suggest upgrading to current 1.2.21 ASAP and in the meantime, try to 
run with a very low debug level.


Jan

-- 
Anyone who trades liberty for security deserves neither
liberty nor security. -- Benjamin Franklin

