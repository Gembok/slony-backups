From david at fetter.org  Mon Nov  1 07:58:59 2010
From: david at fetter.org (David Fetter)
Date: Mon, 1 Nov 2010 07:58:59 -0700
Subject: [Slony1-general] Slony1-general Digest, Vol 44, Issue 16
In-Reply-To: <4CCD2EE9.1040405@adyen.com>
References: <mailman.1.1288119602.25883.slony1-general@lists.slony.info>
	<4CCD2EE9.1040405@adyen.com>
Message-ID: <20101101145859.GA17221@fetter.org>

On Sun, Oct 31, 2010 at 09:55:05AM +0100, Ger Timmens wrote:
> Can we change the definitions of all 'timestamp' columns
> from 'timestamp without time zone' to timestamp with time stamp'
> in slony (we are using 1.2.20 rightnow).

You need to send any DDL changes via EXECUTE SCRIPT.  ALTER TABLE is a
DDL change :)

Cheers,
David.
-- 
David Fetter <david at fetter.org> http://fetter.org/
Phone: +1 415 235 3778  AIM: dfetter666  Yahoo!: dfetter
Skype: davidfetter      XMPP: david.fetter at gmail.com
iCal: webcal://www.tripit.com/feed/ical/people/david74/tripit.ics

Remember to vote!
Consider donating to Postgres: http://www.postgresql.org/about/donate

From Ger.Timmens at adyen.com  Mon Nov  1 08:05:43 2010
From: Ger.Timmens at adyen.com (Ger Timmens)
Date: Mon, 01 Nov 2010 16:05:43 +0100
Subject: [Slony1-general] Slony1-general Digest, Vol 44, Issue 16
In-Reply-To: <20101101145859.GA17221@fetter.org>
References: <mailman.1.1288119602.25883.slony1-general@lists.slony.info>
	<4CCD2EE9.1040405@adyen.com> <20101101145859.GA17221@fetter.org>
Message-ID: <4CCED747.7020102@adyen.com>

I understand, but maybe I wasn't clear:
The column defition of the slony sl_ tables should be adapted
to 'timestamp with time zone' instead of 'timestamp without
timezone' to prevent any errors in monitoring scripts when
the clock goes one hour back from summer to winter time.

So it's more of a suggestion/patch for
slony-1.2.22 and slony-2.0.6.

Regards,

Ger Timmens


On 11/01/2010 03:58 PM, David Fetter wrote:
> On Sun, Oct 31, 2010 at 09:55:05AM +0100, Ger Timmens wrote:
>> Can we change the definitions of all 'timestamp' columns
>> from 'timestamp without time zone' to timestamp with time stamp'
>> in slony (we are using 1.2.20 rightnow).
> 
> You need to send any DDL changes via EXECUTE SCRIPT.  ALTER TABLE is a
> DDL change :)
> 
> Cheers,
> David.

From cbbrowne at ca.afilias.info  Mon Nov  1 08:15:11 2010
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Mon, 01 Nov 2010 11:15:11 -0400
Subject: [Slony1-general] Slony1-general Digest, Vol 44, Issue 16
In-Reply-To: <4CCD2EE9.1040405@adyen.com> (Ger Timmens's message of "Sun, 31
	Oct 2010 09:55:05 +0100")
References: <mailman.1.1288119602.25883.slony1-general@lists.slony.info>
	<4CCD2EE9.1040405@adyen.com>
Message-ID: <87eib5ulc0.fsf@cbbrowne.afilias-int.info>

Ger Timmens <Ger.Timmens at adyen.com> writes:
> Can we change the definitions of all 'timestamp' columns
> from 'timestamp without time zone' to timestamp with time stamp'
> in slony (we are using 1.2.20 rightnow).

Sure, you could submit DDL requests via the slonik command EXECUTE
SCRIPT
   <http://slony.info/documentation/1.2/stmtddlscript.html>

The script would consist of a series of ALTER TABLE commands, one for
each column to be thus altered.

I suspect you'll find this to be a mighty expensive operation, as it:

  a) locks all the tables (in 1.2, ALL replicated tables, in 2.0, just
     the ones that need to be altered) for the duration, and

  b) fairly likely leads to the affected tables being rewritten, so all
     the old tuples are dead, so they need vacuuming rather badly.

So, expensive, but it can certainly be done.
-- 
let name="cbbrowne" and tld="afilias.info" in String.concat "@" [name;tld];;
Christopher Browne
"Bother,"  said Pooh,  "Eeyore, ready  two photon  torpedoes  and lock
phasers on the Heffalump, Piglet, meet me in transporter room three"

From david at fetter.org  Mon Nov  1 08:22:36 2010
From: david at fetter.org (David Fetter)
Date: Mon, 1 Nov 2010 08:22:36 -0700
Subject: [Slony1-general] Slony1-general Digest, Vol 44, Issue 16
In-Reply-To: <4CCED747.7020102@adyen.com>
References: <mailman.1.1288119602.25883.slony1-general@lists.slony.info>
	<4CCD2EE9.1040405@adyen.com> <20101101145859.GA17221@fetter.org>
	<4CCED747.7020102@adyen.com>
Message-ID: <20101101152236.GC17221@fetter.org>

This may or may not be a bug fix.  It's possible it's a large enough
feature change that it might need to go into 2.1.

Cheers,
David.
On Mon, Nov 01, 2010 at 04:05:43PM +0100, Ger Timmens wrote:
> I understand, but maybe I wasn't clear:
> The column defition of the slony sl_ tables should be adapted
> to 'timestamp with time zone' instead of 'timestamp without
> timezone' to prevent any errors in monitoring scripts when
> the clock goes one hour back from summer to winter time.
> 
> So it's more of a suggestion/patch for
> slony-1.2.22 and slony-2.0.6.
> 
> Regards,
> 
> Ger Timmens
> 
> 
> On 11/01/2010 03:58 PM, David Fetter wrote:
> > On Sun, Oct 31, 2010 at 09:55:05AM +0100, Ger Timmens wrote:
> >> Can we change the definitions of all 'timestamp' columns
> >> from 'timestamp without time zone' to timestamp with time stamp'
> >> in slony (we are using 1.2.20 rightnow).
> > 
> > You need to send any DDL changes via EXECUTE SCRIPT.  ALTER TABLE is a
> > DDL change :)
> > 
> > Cheers,
> > David.

-- 
David Fetter <david at fetter.org> http://fetter.org/
Phone: +1 415 235 3778  AIM: dfetter666  Yahoo!: dfetter
Skype: davidfetter      XMPP: david.fetter at gmail.com
iCal: webcal://www.tripit.com/feed/ical/people/david74/tripit.ics

Remember to vote!
Consider donating to Postgres: http://www.postgresql.org/about/donate

From Ger.Timmens at adyen.com  Mon Nov  1 08:25:57 2010
From: Ger.Timmens at adyen.com (Ger Timmens)
Date: Mon, 01 Nov 2010 16:25:57 +0100
Subject: [Slony1-general] Slony1-general Digest, Vol 44, Issue 16
In-Reply-To: <87eib5ulc0.fsf@cbbrowne.afilias-int.info>
References: <mailman.1.1288119602.25883.slony1-general@lists.slony.info>	<4CCD2EE9.1040405@adyen.com>
	<87eib5ulc0.fsf@cbbrowne.afilias-int.info>
Message-ID: <4CCEDC05.7050904@adyen.com>

In addition to my previous posts:

I suggest (for slony 1.2.2x):

ALTER TABLE sl_archive_count ALTER COLUMN ac_timestamp TYPE
timestamp with time zone;

ALTER TABLE sl_confirm ALTER COLUMN con_timestamp TYPE timestamp
with time zone;

ALTER TABLE sl_registry ALTER COLUMN reg_timestamp TYPE timestamp
with time zone;

ALTER TABLE sl_event ALTER COLUMN ev_timestamp TYPE timestamp with
time zone;

Probably slony 2.0.x needs the same changes.

Regards,

Ger


On 11/01/2010 04:15 PM, Christopher Browne wrote:
> Ger Timmens <Ger.Timmens at adyen.com> writes:
>> Can we change the definitions of all 'timestamp' columns
>> from 'timestamp without time zone' to timestamp with time stamp'
>> in slony (we are using 1.2.20 rightnow).
> 
> Sure, you could submit DDL requests via the slonik command EXECUTE
> SCRIPT
>    <http://slony.info/documentation/1.2/stmtddlscript.html>
> 
> The script would consist of a series of ALTER TABLE commands, one for
> each column to be thus altered.
> 
> I suspect you'll find this to be a mighty expensive operation, as it:
> 
>   a) locks all the tables (in 1.2, ALL replicated tables, in 2.0, just
>      the ones that need to be altered) for the duration, and
> 
>   b) fairly likely leads to the affected tables being rewritten, so all
>      the old tuples are dead, so they need vacuuming rather badly.
> 
> So, expensive, but it can certainly be done.

From cbbrowne at ca.afilias.info  Mon Nov  1 08:53:54 2010
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Mon, 01 Nov 2010 11:53:54 -0400
Subject: [Slony1-general] Slony1-general Digest, Vol 44, Issue 16
In-Reply-To: <4CCED747.7020102@adyen.com> (Ger Timmens's message of "Mon, 01
	Nov 2010 16:05:43 +0100")
References: <mailman.1.1288119602.25883.slony1-general@lists.slony.info>
	<4CCD2EE9.1040405@adyen.com> <20101101145859.GA17221@fetter.org>
	<4CCED747.7020102@adyen.com>
Message-ID: <87aaltujjh.fsf@cbbrowne.afilias-int.info>

Ger Timmens <Ger.Timmens at adyen.com> writes:
> I understand, but maybe I wasn't clear:
> The column defition of the slony sl_ tables should be adapted
> to 'timestamp with time zone' instead of 'timestamp without
> timezone' to prevent any errors in monitoring scripts when
> the clock goes one hour back from summer to winter time.
>
> So it's more of a suggestion/patch for
> slony-1.2.22 and slony-2.0.6.

Ah.

If the slon processes are running in UTC/GMT, as is recommended, then
there's no issue whatever, because UTC/GMT do not adjust for DST.

 <http://www.slony.info/adminguide/slony1-1.2.6/doc/adminguide/requirements.html#TIMES>
-- 
let name="cbbrowne" and tld="ca.afilias.info" in String.concat "@" [name;tld];;
Christopher Browne
"Bother,"  said Pooh,  "Eeyore, ready  two photon  torpedoes  and lock
phasers on the Heffalump, Piglet, meet me in transporter room three"

From bhirt at me.com  Mon Nov  1 10:26:34 2010
From: bhirt at me.com (Brian Hirt)
Date: Mon, 01 Nov 2010 11:26:34 -0600
Subject: [Slony1-general] Slony1-general Digest, Vol 44, Issue 16
In-Reply-To: <87aaltujjh.fsf@cbbrowne.afilias-int.info>
References: <mailman.1.1288119602.25883.slony1-general@lists.slony.info>
	<4CCD2EE9.1040405@adyen.com> <20101101145859.GA17221@fetter.org>
	<4CCED747.7020102@adyen.com> <87aaltujjh.fsf@cbbrowne.afilias-int.info>
Message-ID: <6FCE441D-4D48-4E7D-9031-6157FA184CA1@me.com>

If it's known that slon has problems with time zones with daylight savings time, wouldn't it make sense to default it to UTC or at least give you a warning when it starts up?   I had no idea about this and I could see others being bit in the rump by this as well.  I've set up my scripts to use TZ=UTC now instead of the machines local time zone and have restarted them, but now I wonder what would have happened if I didn't read this thread?

That being said wouldn't it make more sense, like the OP is saying, to  use timestamp without timezone?   Why give someone a gun to shoot themselves in the foot if it can be avoided?

--brian

On Nov 1, 2010, at 9:53 AM, Christopher Browne wrote:

> Ger Timmens <Ger.Timmens at adyen.com> writes:
>> I understand, but maybe I wasn't clear:
>> The column defition of the slony sl_ tables should be adapted
>> to 'timestamp with time zone' instead of 'timestamp without
>> timezone' to prevent any errors in monitoring scripts when
>> the clock goes one hour back from summer to winter time.
>> 
>> So it's more of a suggestion/patch for
>> slony-1.2.22 and slony-2.0.6.
> 
> Ah.
> 
> If the slon processes are running in UTC/GMT, as is recommended, then
> there's no issue whatever, because UTC/GMT do not adjust for DST.
> 
> <http://www.slony.info/adminguide/slony1-1.2.6/doc/adminguide/requirements.html#TIMES>
> -- 
> let name="cbbrowne" and tld="ca.afilias.info" in String.concat "@" [name;tld];;
> Christopher Browne
> "Bother,"  said Pooh,  "Eeyore, ready  two photon  torpedoes  and lock
> phasers on the Heffalump, Piglet, meet me in transporter room three"
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


From ajs at crankycanuck.ca  Mon Nov  1 11:33:33 2010
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Mon, 1 Nov 2010 14:33:33 -0400
Subject: [Slony1-general] Slony1-general Digest, Vol 44, Issue 16
In-Reply-To: <6FCE441D-4D48-4E7D-9031-6157FA184CA1@me.com>
References: <mailman.1.1288119602.25883.slony1-general@lists.slony.info>
	<4CCD2EE9.1040405@adyen.com> <20101101145859.GA17221@fetter.org>
	<4CCED747.7020102@adyen.com>
	<87aaltujjh.fsf@cbbrowne.afilias-int.info>
	<6FCE441D-4D48-4E7D-9031-6157FA184CA1@me.com>
Message-ID: <20101101183333.GG18482@shinkuro.com>

On Mon, Nov 01, 2010 at 11:26:34AM -0600, Brian Hirt wrote:
> If it's known that slon has problems with time zones with daylight
> savings time, wouldn't it make sense to default it to UTC or at
> least give you a warning when it starts up?  I had no idea about
> this and I could see others being bit in the rump by this as well.

Well, it _is_ in the documentation.  I dimly recall that we attempted
to do something with the time zones in the past, but then people would
try to make the machines operate in different time zones, and that
broke in different and unpleasant ways.  Maybe I'm imagining that,
however.

Anyway, yes, all your machines need to be in the same time zone, and
one where the time doesn't occasionally whip around in insane ways.
It's generally a good idea to run in UTC for other reasons, too.  For
instance, your syslog has this problem as well.  If someone manages to
reboot the box in the one hour of "lost" time on Sunday, how will you
know what time it happened?

A

-- 
Andrew Sullivan
ajs at crankycanuck.ca

From vivek at khera.org  Mon Nov  1 12:06:57 2010
From: vivek at khera.org (Vick Khera)
Date: Mon, 1 Nov 2010 15:06:57 -0400
Subject: [Slony1-general] Slony1-general Digest, Vol 44, Issue 16
In-Reply-To: <87aaltujjh.fsf@cbbrowne.afilias-int.info>
References: <mailman.1.1288119602.25883.slony1-general@lists.slony.info>
	<4CCD2EE9.1040405@adyen.com> <20101101145859.GA17221@fetter.org>
	<4CCED747.7020102@adyen.com>
	<87aaltujjh.fsf@cbbrowne.afilias-int.info>
Message-ID: <AANLkTik4uG_qHxC9=7Qob62BsabmzR3zpYxNcXz1h0hD@mail.gmail.com>

On Mon, Nov 1, 2010 at 11:53 AM, Christopher Browne
<cbbrowne at ca.afilias.info> wrote:
> If the slon processes are running in UTC/GMT, as is recommended, then
> there's no issue whatever, because UTC/GMT do not adjust for DST.
>

I disagree.  At least at some point in history this happened to me at
the DST switchover:

[rt]% psql -U postgres -x -c 'select * from _rt.sl_status' rt3
-[ RECORD 1 ]-------------+---------------------------
st_origin                 | 20
st_received               | 10
st_last_event             | 4896924
st_last_event_ts          | 2007-11-04 01:08:57.010633
st_last_received          | 4896923
st_last_received_ts       | 2007-11-04 01:08:53.002901
st_last_received_event_ts | 2007-11-04 01:08:53.002292
st_lag_num_events         | 1
st_lag_time               | -00:59:54.583198

[rt]% date
Sun Nov  4 01:09:01 EDT 2007


I'm not 100% convinced that having the slon run in UTC is sufficient
for there to be "no problems" as the above is totally based on the
server's idea of the time.

For that full hour the lag time was off by one hour.  It made for some
fun nagios alerts.

I guess this sunday night we can try again and see what happens... :)
I don't recall what slony version that the above was from.  Whatever
was current at that date.  And it would have been on Pg 8.1.

From bhirt at me.com  Mon Nov  1 12:21:34 2010
From: bhirt at me.com (Brian Hirt)
Date: Mon, 01 Nov 2010 13:21:34 -0600
Subject: [Slony1-general] Slony1-general Digest, Vol 44, Issue 16
In-Reply-To: <AANLkTik4uG_qHxC9=7Qob62BsabmzR3zpYxNcXz1h0hD@mail.gmail.com>
References: <mailman.1.1288119602.25883.slony1-general@lists.slony.info>
	<4CCD2EE9.1040405@adyen.com> <20101101145859.GA17221@fetter.org>
	<4CCED747.7020102@adyen.com> <87aaltujjh.fsf@cbbrowne.afilias-int.info>
	<AANLkTik4uG_qHxC9=7Qob62BsabmzR3zpYxNcXz1h0hD@mail.gmail.com>
Message-ID: <C3058027-A8DA-49B9-8C8B-5C0ED8102FF4@me.com>

On Nov 1, 2010, at 1:06 PM, Vick Khera wrote:
> 
> For that full hour the lag time was off by one hour.  It made for some
> fun nagios alerts.
> 

Vick, 

Do you know if it is just lag time that's reported incorrectly, or are there actual problems with replication during this window?

--brian



From cbbrowne at ca.afilias.info  Mon Nov  1 13:21:23 2010
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Mon, 01 Nov 2010 16:21:23 -0400
Subject: [Slony1-general] Slony1-general Digest, Vol 44, Issue 16
In-Reply-To: <6FCE441D-4D48-4E7D-9031-6157FA184CA1@me.com> (Brian Hirt's
	message of "Mon, 01 Nov 2010 11:26:34 -0600")
References: <mailman.1.1288119602.25883.slony1-general@lists.slony.info>
	<4CCD2EE9.1040405@adyen.com> <20101101145859.GA17221@fetter.org>
	<4CCED747.7020102@adyen.com>
	<87aaltujjh.fsf@cbbrowne.afilias-int.info>
	<6FCE441D-4D48-4E7D-9031-6157FA184CA1@me.com>
Message-ID: <87wrowu75o.fsf@cbbrowne.afilias-int.info>

Brian Hirt <bhirt at me.com> writes:
> If it's known that slon has problems with time zones with daylight
> savings time, wouldn't it make sense to default it to UTC or at least
> give you a warning when it starts up?  I had no idea about this and I
> could see others being bit in the rump by this as well.  I've set up
> my scripts to use TZ=UTC now instead of the machines local time zone
> and have restarted them, but now I wonder what would have happened if
> I didn't read this thread?

Ooh, splendid idea!

Bug #156 does "health check" stuff at startup time.

Adding a timezone check which warns if you start up with an
unstable/discontinuous timezone seems like a nice thing to add.

> That being said wouldn't it make more sense, like the OP is saying, to
> use timestamp without timezone?  Why give someone a gun to shoot
> themselves in the foot if it can be avoided?

Actually, that's backwards.  We have always used timestamp *without*
timezone, and the proposal is to change to use timestamp *with*
timezone.

There's a small issue that "with timezone" consumes a little more space;
I wouldn't consider that terribly important.

In my view, to use a timezone which has a known incontinuity (e.g. -
where you can expect a 1 hour "leap" every so often) *is* the footgun.
-- 
output = ("cbbrowne" "@" "afilias.info")
Christopher Browne
"Bother,"  said Pooh,  "Eeyore, ready  two photon  torpedoes  and lock
phasers on the Heffalump, Piglet, meet me in transporter room three"

From bhirt at me.com  Mon Nov  1 13:41:29 2010
From: bhirt at me.com (Brian Hirt)
Date: Mon, 01 Nov 2010 14:41:29 -0600
Subject: [Slony1-general] Slony1-general Digest, Vol 44, Issue 16
In-Reply-To: <87wrowu75o.fsf@cbbrowne.afilias-int.info>
References: <mailman.1.1288119602.25883.slony1-general@lists.slony.info>
	<4CCD2EE9.1040405@adyen.com> <20101101145859.GA17221@fetter.org>
	<4CCED747.7020102@adyen.com> <87aaltujjh.fsf@cbbrowne.afilias-int.info>
	<6FCE441D-4D48-4E7D-9031-6157FA184CA1@me.com>
	<87wrowu75o.fsf@cbbrowne.afilias-int.info>
Message-ID: <3865D4CF-A985-4FA9-883E-18B3C14C37EE@me.com>

> 
> Actually, that's backwards.  We have always used timestamp *without*
> timezone, and the proposal is to change to use timestamp *with*
> timezone.
> 
> There's a small issue that "with timezone" consumes a little more space;
> I wouldn't consider that terribly important.
> 
> In my view, to use a timezone which has a known incontinuity (e.g. -
> where you can expect a 1 hour "leap" every so often) *is* the footgun.

Christopher,

You are right, i did get it backwards and say it the other way around.  Right now the timestamp in the sl_* tables are timestamp without time zone.   If they were all timestamp with time zone, couldn't the  slon clients just issue a "set timezone TO 'UTC'" command when they start up and everything would work nicely because postgres would be able to translate to a time zone that slony would like to see the data in. 

--brian


From msquires at whitepages.com  Mon Nov  1 13:49:26 2010
From: msquires at whitepages.com (Michael Squires)
Date: Mon, 1 Nov 2010 13:49:26 -0700
Subject: [Slony1-general] Slony1-general Digest, Vol 44, Issue 16
In-Reply-To: <87wrowu75o.fsf@cbbrowne.afilias-int.info>
References: <mailman.1.1288119602.25883.slony1-general@lists.slony.info>	<4CCD2EE9.1040405@adyen.com>
	<20101101145859.GA17221@fetter.org>	<4CCED747.7020102@adyen.com>	<87aaltujjh.fsf@cbbrowne.afilias-int.info>	<6FCE441D-4D48-4E7D-9031-6157FA184CA1@me.com>
	<87wrowu75o.fsf@cbbrowne.afilias-int.info>
Message-ID: <4CCF27D6.60202@whitepages.com>

On 11/1/10 1:21 PM, Christopher Browne wrote:
> In my view, to use a timezone which has a known incontinuity (e.g. -
> where you can expect a 1 hour "leap" every so often) *is* the footgun.

For many organizations, by the time they realize that they have a timezone problem it has propagated
throughout their data center. They have databases, load balancers, network devices, etc. that all
have a notion of "time" in them, and reconciling those is a huge task.

Any timezone that has the concept of daylight savings time has one "missing" hour and one
"duplicated" hour every year. It is subject to "political" changes (e.g., changing the begin/end of
DST a few years ago in the US). If you have machines in multiple time zones, and, even worse, in
multiple time zone "regimes" (such that they can change at different times), you WILL have bizarre
effects where your log files are borked up or you have apparent discontinuities in your metrics.

I think that everyone should run everything in their data centers on UTC, and only "localize" the
time when necessary to deal with "outside" users. It makes sense that you schedule things like
machine downtime for convenient times for the majority of users (rather than "midnight UTC"), but
that doesn't stop you from expressing those schedules in UTC.

If you do this on day 1 of your enterprise (no matter how small) you will save yourself large
amounts of grief as you grow.

I know that several large internet companies haven't unified on UTC (because of the mass of things
that would have to change) and just expect problems at least twice a year as a result.

Michael

From vivek at khera.org  Mon Nov  1 14:00:10 2010
From: vivek at khera.org (Vick Khera)
Date: Mon, 1 Nov 2010 17:00:10 -0400
Subject: [Slony1-general] Slony1-general Digest, Vol 44, Issue 16
In-Reply-To: <C3058027-A8DA-49B9-8C8B-5C0ED8102FF4@me.com>
References: <mailman.1.1288119602.25883.slony1-general@lists.slony.info>
	<4CCD2EE9.1040405@adyen.com> <20101101145859.GA17221@fetter.org>
	<4CCED747.7020102@adyen.com>
	<87aaltujjh.fsf@cbbrowne.afilias-int.info>
	<AANLkTik4uG_qHxC9=7Qob62BsabmzR3zpYxNcXz1h0hD@mail.gmail.com>
	<C3058027-A8DA-49B9-8C8B-5C0ED8102FF4@me.com>
Message-ID: <AANLkTinj-_Y=VBNpz+Pj9+yHYrOiQ45maW3HGd7i2YvY@mail.gmail.com>

On Mon, Nov 1, 2010 at 3:21 PM, Brian Hirt <bhirt at me.com> wrote:
>> For that full hour the lag time was off by one hour. ?It made for some
>> fun nagios alerts.
>
> Vick,
>
> Do you know if it is just lag time that's reported incorrectly, or are there actual problems with replication during this window?


Replication was perfectly fine and up-to-date. The only error was the
sl_status table lagtime value was reporting a negative lag, which is
totally nonsensical.

I'm looking forward to this sunday :-)

From cbbrowne at ca.afilias.info  Mon Nov  1 14:10:26 2010
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Mon, 01 Nov 2010 17:10:26 -0400
Subject: [Slony1-general] Slony1-general Digest, Vol 44, Issue 16
In-Reply-To: <3865D4CF-A985-4FA9-883E-18B3C14C37EE@me.com> (Brian Hirt's
	message of "Mon, 01 Nov 2010 14:41:29 -0600")
References: <mailman.1.1288119602.25883.slony1-general@lists.slony.info>
	<4CCD2EE9.1040405@adyen.com> <20101101145859.GA17221@fetter.org>
	<4CCED747.7020102@adyen.com>
	<87aaltujjh.fsf@cbbrowne.afilias-int.info>
	<6FCE441D-4D48-4E7D-9031-6157FA184CA1@me.com>
	<87wrowu75o.fsf@cbbrowne.afilias-int.info>
	<3865D4CF-A985-4FA9-883E-18B3C14C37EE@me.com>
Message-ID: <87pquou4vx.fsf@cbbrowne.afilias-int.info>

Brian Hirt <bhirt at me.com> writes:
>> 
>> Actually, that's backwards.  We have always used timestamp *without*
>> timezone, and the proposal is to change to use timestamp *with*
>> timezone.
>> 
>> There's a small issue that "with timezone" consumes a little more space;
>> I wouldn't consider that terribly important.
>> 
>> In my view, to use a timezone which has a known incontinuity (e.g. -
>> where you can expect a 1 hour "leap" every so often) *is* the footgun.
>
> Christopher,
>
> You are right, i did get it backwards and say it the other way around.
> Right now the timestamp in the sl_* tables are timestamp without time
> zone.  If they were all timestamp with time zone, couldn't the slon
> clients just issue a "set timezone TO 'UTC'" command when they start
> up and everything would work nicely because postgres would be able to
> translate to a time zone that slony would like to see the data in.

Ah, and you're probably right there.

We have places where we force other aspects of environment.

Notably, the logtrigger functions force DateStyle to "ISO".

It doesn't seem "out there" to have slon processes expressly operate in
UTC, which should address this issue.  I'll put in a bug that indicates
this as one of the options, at any rate.
-- 
output = reverse("ofni.sailifa.ac" "@" "enworbbc")
Christopher Browne
"Bother,"  said Pooh,  "Eeyore, ready  two photon  torpedoes  and lock
phasers on the Heffalump, Piglet, meet me in transporter room three"

From cbbrowne at ca.afilias.info  Mon Nov  1 14:20:46 2010
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Mon, 01 Nov 2010 17:20:46 -0400
Subject: [Slony1-general] Slony1-general Digest, Vol 44, Issue 16
In-Reply-To: <3865D4CF-A985-4FA9-883E-18B3C14C37EE@me.com> (Brian Hirt's
	message of "Mon, 01 Nov 2010 14:41:29 -0600")
References: <mailman.1.1288119602.25883.slony1-general@lists.slony.info>
	<4CCD2EE9.1040405@adyen.com> <20101101145859.GA17221@fetter.org>
	<4CCED747.7020102@adyen.com>
	<87aaltujjh.fsf@cbbrowne.afilias-int.info>
	<6FCE441D-4D48-4E7D-9031-6157FA184CA1@me.com>
	<87wrowu75o.fsf@cbbrowne.afilias-int.info>
	<3865D4CF-A985-4FA9-883E-18B3C14C37EE@me.com>
Message-ID: <87lj5cu4ep.fsf@cbbrowne.afilias-int.info>

Brian Hirt <bhirt at me.com> writes:
> You are right, i did get it backwards and say it the other way around.
> Right now the timestamp in the sl_* tables are timestamp without time
> zone.  If they were all timestamp with time zone, couldn't the slon
> clients just issue a "set timezone TO 'UTC'" command when they start
> up and everything would work nicely because postgres would be able to
> translate to a time zone that slony would like to see the data in.

That presents a nice third option; I have outlined the options in new
bug #163.

http://www.slony.info/bugzilla/show_bug.cgi?id=163
-- 
output = reverse("ofni.sailifa.ac" "@" "enworbbc")
Christopher Browne
"Bother,"  said Pooh,  "Eeyore, ready  two photon  torpedoes  and lock
phasers on the Heffalump, Piglet, meet me in transporter room three"

From vivek at khera.org  Sat Nov  6 22:53:53 2010
From: vivek at khera.org (Vick Khera)
Date: Sun, 7 Nov 2010 01:53:53 -0400
Subject: [Slony1-general] attack of the timezone
Message-ID: <AANLkTikrWXQuGOgS6k7MGiitNgD2iPVXqZ+MH041Sfi9@mail.gmail.com>

Following up on the discussion earlier this week regarding using
timestamp with timezone for slony's tables... I was just awoken to a
false alarm page from my nagios monitoring of the replication on my
servers.  The negative time lag confused nagios.  It will remain this
way until 2am, at which point it will become 1am again.


[d01]% slony-vkmlm/repstatus
-[ RECORD 1 ]-------------+---------------------------
st_origin                 | 4
st_received               | 1
st_last_event             | 15075665
st_last_event_ts          | 2010-11-07 01:06:22.61718
st_last_received          | 15075664
st_last_received_ts       | 2010-11-07 01:06:22.494841
st_last_received_event_ts | 2010-11-07 01:06:20.611323
st_lag_num_events         | 1
st_lag_time               | -00:59:56.265608


[d01]% uname -a
FreeBSD d01.m1e.net 8.1-RELEASE FreeBSD 8.1-RELEASE #7: Mon Aug 30
13:57:04 EDT 2010
steve at d01:/n/lorax1/usr8/obj.amd64/n/lorax1/usr8/src/sys/KCI64SMP
amd64
[d01]% slon -v
slon version 1.2.20
[d01]% psql --version
psql (PostgreSQL) 9.0.1

The origin is running Pg 8.3.11.

This is occurring on all my DB replicas (I have two other databases I
replicate between different boxes).  I restarted all the slons, and
even set the TZ=UTC but that made not one bit of difference.

It appears that the error is coming from the discrepancy of timezones
of now() and the ev_timestamp:


# select now()-ev_timestamp,now()-CAST(ev_timestamp as timestamptz) AS
x from _mailermailer.sl_event order by ev_timestamp desc limit 3;
     ?column?     |        x
------------------+------------------
 -00:59:56.741957 | -00:59:56.741957
 -00:59:54.736794 | -00:59:54.736794
 -00:59:52.731122 | -00:59:52.731122
(3 rows)


# select ev_timestamp,CAST(ev_timestamp as timestamptz) AS x from
_mailermailer.sl_event order by ev_timestamp desc limit 3;
        ev_timestamp        |               x
----------------------------+-------------------------------
 2010-11-07 01:40:37.72615  | 2010-11-07 01:40:37.72615-05
 2010-11-07 01:40:36.176595 | 2010-11-07 01:40:36.176595-05
 2010-11-07 01:40:34.171789 | 2010-11-07 01:40:34.171789-05
(3 rows)



# select now();
              now
-------------------------------
 2010-11-07 01:40:44.088584-04
(1 row)


Note how now() says it is in zone -04 but the cast of ev_timestamp to
timestamptz gives zone -05.

The above is run on my 9.0.1 replica server.

I suppose this could be a postgres bug, but then again, the timestamps
right now are ambiguous... are they in the pre-switch or post-switch
"1am" hour?  Postgres seems to decide that the 1am hour is always
after the switchover, so puts it in the standard timezone.

The only fix I see is to store the times with timezone in slony.

From bhirt at me.com  Sun Nov  7 09:19:53 2010
From: bhirt at me.com (Brian Hirt)
Date: Sun, 07 Nov 2010 10:19:53 -0700
Subject: [Slony1-general] attack of the timezone
In-Reply-To: <AANLkTikrWXQuGOgS6k7MGiitNgD2iPVXqZ+MH041Sfi9@mail.gmail.com>
References: <AANLkTikrWXQuGOgS6k7MGiitNgD2iPVXqZ+MH041Sfi9@mail.gmail.com>
Message-ID: <EEF65893-011C-430F-81AC-16AD657FA86E@me.com>

For what it's worth...  Earlier in the week following this discussion I also restarted all my slon processes with TZ=UTC.  However our postgresql server is still using a time zone with DST so I was fully expecting nagios to pester me this morning.  However, that didn't happen and I'm not sure why.  It seems lag time would have been off based on what was discussed, but not a single event was logged in nagios.   The only difference I see between your setup and ours is that we use slony 2.0.5 and you are using 1.2.20

--brian

On Nov 6, 2010, at 11:53 PM, Vick Khera wrote:

> Following up on the discussion earlier this week regarding using
> timestamp with timezone for slony's tables... I was just awoken to a
> false alarm page from my nagios monitoring of the replication on my
> servers.  The negative time lag confused nagios.  It will remain this
> way until 2am, at which point it will become 1am again.
> 
> 
> [d01]% slony-vkmlm/repstatus
> -[ RECORD 1 ]-------------+---------------------------
> st_origin                 | 4
> st_received               | 1
> st_last_event             | 15075665
> st_last_event_ts          | 2010-11-07 01:06:22.61718
> st_last_received          | 15075664
> st_last_received_ts       | 2010-11-07 01:06:22.494841
> st_last_received_event_ts | 2010-11-07 01:06:20.611323
> st_lag_num_events         | 1
> st_lag_time               | -00:59:56.265608
> 
> 
> [d01]% uname -a
> FreeBSD d01.m1e.net 8.1-RELEASE FreeBSD 8.1-RELEASE #7: Mon Aug 30
> 13:57:04 EDT 2010
> steve at d01:/n/lorax1/usr8/obj.amd64/n/lorax1/usr8/src/sys/KCI64SMP
> amd64
> [d01]% slon -v
> slon version 1.2.20
> [d01]% psql --version
> psql (PostgreSQL) 9.0.1
> 
> The origin is running Pg 8.3.11.
> 
> This is occurring on all my DB replicas (I have two other databases I
> replicate between different boxes).  I restarted all the slons, and
> even set the TZ=UTC but that made not one bit of difference.
> 
> It appears that the error is coming from the discrepancy of timezones
> of now() and the ev_timestamp:
> 
> 
> # select now()-ev_timestamp,now()-CAST(ev_timestamp as timestamptz) AS
> x from _mailermailer.sl_event order by ev_timestamp desc limit 3;
>     ?column?     |        x
> ------------------+------------------
> -00:59:56.741957 | -00:59:56.741957
> -00:59:54.736794 | -00:59:54.736794
> -00:59:52.731122 | -00:59:52.731122
> (3 rows)
> 
> 
> # select ev_timestamp,CAST(ev_timestamp as timestamptz) AS x from
> _mailermailer.sl_event order by ev_timestamp desc limit 3;
>        ev_timestamp        |               x
> ----------------------------+-------------------------------
> 2010-11-07 01:40:37.72615  | 2010-11-07 01:40:37.72615-05
> 2010-11-07 01:40:36.176595 | 2010-11-07 01:40:36.176595-05
> 2010-11-07 01:40:34.171789 | 2010-11-07 01:40:34.171789-05
> (3 rows)
> 
> 
> 
> # select now();
>              now
> -------------------------------
> 2010-11-07 01:40:44.088584-04
> (1 row)
> 
> 
> Note how now() says it is in zone -04 but the cast of ev_timestamp to
> timestamptz gives zone -05.
> 
> The above is run on my 9.0.1 replica server.
> 
> I suppose this could be a postgres bug, but then again, the timestamps
> right now are ambiguous... are they in the pre-switch or post-switch
> "1am" hour?  Postgres seems to decide that the 1am hour is always
> after the switchover, so puts it in the standard timezone.
> 
> The only fix I see is to store the times with timezone in slony.
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


From dba at richyen.com  Tue Nov  9 08:09:13 2010
From: dba at richyen.com (Richard Yen)
Date: Tue, 9 Nov 2010 08:09:13 -0800
Subject: [Slony1-general] Does Slony ever "abandon" connections?
Message-ID: <AANLkTikX2i_=0r6ux+snw4oyOUTECoMgtyKpQiXPykP+@mail.gmail.com>

Hi, does anyone know if slony ever "abandons" connections?  I've had an idle
transaction for the past 6 hours on one of my subscriber nodes,
and according to my logs, the transaction was started, but there was never
any action done in it, except to set the transaction level to serializable

Odd thing is--the node is not lagging from the origin when I look at the
origin's sl_status table

Also, I don't know if this might be relevant, but the backend for the
transaction has been open since 2010-11-01, and it's been processing plenty
of transactions successfully up until this point

How else can I diagnose this problem?
--Richard
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20101109/24fcc0bb/attachment.htm 

From sreddy at spark.net  Tue Nov  9 10:54:01 2010
From: sreddy at spark.net (sharadov)
Date: Tue, 9 Nov 2010 10:54:01 -0800 (PST)
Subject: [Slony1-general]  Sl_log table is huge, over 100 million rows
Message-ID: <30173901.post@talk.nabble.com>



We have slony replication set up, and the replication on the slave has
fallen behind by 10 days. On investigating I noticed that the sl_log_1 table
has 25K records, but the sl_log_2 table has over 100 million rows, and they
keep going up. How do I go about troubleshooting this?

I am a newbie to slony, and would appreciate all the help that I can get

-- 
View this message in context: http://old.nabble.com/Sl_log-table-is-huge%2C-over-100-million-rows-tp30173901p30173901.html
Sent from the Slony-I -- General mailing list archive at Nabble.com.


From vivek at khera.org  Tue Nov  9 11:22:30 2010
From: vivek at khera.org (Vick Khera)
Date: Tue, 9 Nov 2010 14:22:30 -0500
Subject: [Slony1-general] Sl_log table is huge, over 100 million rows
In-Reply-To: <30173901.post@talk.nabble.com>
References: <30173901.post@talk.nabble.com>
Message-ID: <AANLkTinzwmP10-kJgmKh-eUjh2JLGjpdr7hF3DrNX6MA@mail.gmail.com>

On Tue, Nov 9, 2010 at 1:54 PM, sharadov <sreddy at spark.net> wrote:
>
>
> We have slony replication set up, and the replication on the slave has
> fallen behind by 10 days. On investigating I noticed that the sl_log_1 table
> has 25K records, but the sl_log_2 table has over 100 million rows, and they
> keep going up. How do I go about troubleshooting this?

What is the output of

select * from _XXX.sl_status;

on your master node, where XXX is the cluster name?

are the slon daemons running?

From cbbrowne at ca.afilias.info  Tue Nov  9 13:27:49 2010
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Tue, 09 Nov 2010 16:27:49 -0500
Subject: [Slony1-general] Sl_log table is huge, over 100 million rows
In-Reply-To: <30173901.post@talk.nabble.com> (sharadov's message of "Tue, 9
	Nov 2010 10:54:01 -0800 (PST)")
References: <30173901.post@talk.nabble.com>
Message-ID: <87aaligpbe.fsf@cbbrowne.afilias-int.info>

sharadov <sreddy at spark.net> writes:
> We have slony replication set up, and the replication on the slave has
> fallen behind by 10 days. On investigating I noticed that the sl_log_1 table
> has 25K records, but the sl_log_2 table has over 100 million rows, and they
> keep going up. How do I go about troubleshooting this?
>
> I am a newbie to slony, and would appreciate all the help that I can get

You should consider running the "test_slony_state" script which pokes at
various parts of the configuration with a view to seeing what might be
wrong.

  <http://slony.info/documentation/2.0/monitoring.html>

Some questions...

  - Why didn't you notice for 10 days?

    Presumably monitoring hasn't been done right.  I'd suggest running
    test_slony_state on an hourly basis; it complains only if something
    seems broken...

  - Are the slon processes running?

    Usually /usr/bin/ps can help find them...

  - Is the slon for the subscriber actually replicating data?

    You should search in the slon logs for the subscriber for lines
    looking like:

       DEBUG2: remoteWorkerThread_%d: SYNC %d done in %.3f seconds
       DEBUG2: remoteWorkerThread_%d_d: inserts=%d updates=%d deletes=%d

    That should give you an idea as to whether replication work is
    actually taking place.

    If it's running into errors before doing real work, then there's
    some problem that need to get rectified.

    There's a somewhat "worst case scenario" where if there are way too
    many events to process, and a timeout gets exceeded:

       ERROR: remoteListenThread_%d: timeout for event selection

     This means that the listener thread (src/slon/remote_listener.c)
     timed out when trying to determine what events were outstanding for
     it.

     This could occur because network connections broke, in which case
     restarting the slon might help.

     Alternatively, this might occur because the slon for this node has
     been broken for a long time, and there are an enormous number of
     entries in sl_event on this or other nodes for the node to work
     through, and it is taking more than slon_conf_remote_listen_timeout
     seconds to run the query. In older versions of Slony-I, that
     configuration parameter did not exist; the timeout was fixed at 300
     seconds. In newer versions, you might increase that timeout in the
     slon config file to a larger value so that it can continue to
     completion. And then investigate why nobody was monitoring things
     such that replication broke for such a long time...

   If this proves to be the problem, then you can change the listen
   timeout to something rather larger than 300 seconds.  And hopefully
   the slon can get past the too-many-events problem.
-- 
"cbbrowne","@","ca.afilias.info"
Christopher Browne
"Bother,"  said Pooh,  "Eeyore, ready  two photon  torpedoes  and lock
phasers on the Heffalump, Piglet, meet me in transporter room three"

From sreddy at spark.net  Tue Nov  9 11:45:58 2010
From: sreddy at spark.net (sharadov)
Date: Tue, 9 Nov 2010 11:45:58 -0800 (PST)
Subject: [Slony1-general] Sl_log table is huge, over 100 million rows
In-Reply-To: <AANLkTinzwmP10-kJgmKh-eUjh2JLGjpdr7hF3DrNX6MA@mail.gmail.com>
References: <30173901.post@talk.nabble.com>
	<AANLkTinzwmP10-kJgmKh-eUjh2JLGjpdr7hF3DrNX6MA@mail.gmail.com>
Message-ID: <30174341.post@talk.nabble.com>


Here is the result:

1;3;10917446;"2010-11-09 11:43:11.552822";10306542;"2010-10-19
16:52:12.919763";"2010-10-19 16:52:06.15117";610904;"20 days
19:51:08.936181"
1;4;10917446;"2010-11-09 11:43:11.552822";10641537;"2010-11-09
12:50:41.670451";"2010-10-30 23:12:54.809831";275909;"9 days 13:30:20.27752"
1;2;10917446;"2010-11-09 11:43:11.552822";10641538;"2010-11-09
11:40:48.698673";"2010-10-30 23:13:00.813928";275908;"9 days
13:30:14.273423"



how do i check if the son daemons are running?


Vick Khera wrote:
> 
> On Tue, Nov 9, 2010 at 1:54 PM, sharadov <sreddy at spark.net> wrote:
>>
>>
>> We have slony replication set up, and the replication on the slave has
>> fallen behind by 10 days. On investigating I noticed that the sl_log_1
>> table
>> has 25K records, but the sl_log_2 table has over 100 million rows, and
>> they
>> keep going up. How do I go about troubleshooting this?
> 
> What is the output of
> 
> select * from _XXX.sl_status;
> 
> on your master node, where XXX is the cluster name?
> 
> are the slon daemons running?
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
> 
> 

-- 
View this message in context: http://old.nabble.com/Sl_log-table-is-huge%2C-over-100-million-rows-tp30173901p30174341.html
Sent from the Slony-I -- General mailing list archive at Nabble.com.


From ssinger at ca.afilias.info  Tue Nov  9 14:38:46 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Tue, 09 Nov 2010 17:38:46 -0500
Subject: [Slony1-general] Does Slony ever "abandon" connections?
In-Reply-To: <AANLkTikX2i_=0r6ux+snw4oyOUTECoMgtyKpQiXPykP+@mail.gmail.com>
References: <AANLkTikX2i_=0r6ux+snw4oyOUTECoMgtyKpQiXPykP+@mail.gmail.com>
Message-ID: <4CD9CD76.9020401@ca.afilias.info>

On 10-11-09 11:09 AM, Richard Yen wrote:
> Hi, does anyone know if slony ever "abandons" connections?  I've had an
> idle transaction for the past 6 hours on one of my subscriber nodes,
> and according to my logs, the transaction was started, but there was
> never any action done in it, except to set the transaction level to
> serializable
>
> Odd thing is--the node is not lagging from the origin when I look at the
> origin's sl_status table
>
> Also, I don't know if this might be relevant, but the backend for the
> transaction has been open since 2010-11-01, and it's been processing
> plenty of transactions successfully up until this point
>
> How else can I diagnose this problem?
> --Richard
>


First I would determine which slon process the connection comes from 
(pg_stat_activity matched to the process id).

If the slon is the 'local' to the slave database (that is, this is the 
slon servicing the node that is reporting the idle connection) then you 
need to figure out which thread the has stopped.

Have you changed the time/date on your server recently?
Do you see traffic in the logs from localListener, cleanupThread? the 
sync thread?


If it is a remote connection, then what was the last thing that remote 
listener did.

Slony doesn't normally abandon connections but it is possible something 
went wrong.





>
>
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


From dba at richyen.com  Tue Nov  9 16:13:55 2010
From: dba at richyen.com (Richard Yen)
Date: Tue, 9 Nov 2010 16:13:55 -0800
Subject: [Slony1-general] Does Slony ever "abandon" connections?
In-Reply-To: <4CD9CD76.9020401@ca.afilias.info>
References: <AANLkTikX2i_=0r6ux+snw4oyOUTECoMgtyKpQiXPykP+@mail.gmail.com>
	<4CD9CD76.9020401@ca.afilias.info>
Message-ID: <AANLkTi=vD39joLg9EKf6aW0QUQsH+=bwj0MG5kQVEZ_5@mail.gmail.com>

Hmm, that seems to make sense.  Given that Daylight Savings Time just ended,
that might explain the reason why it got abandoned, since my slon procs run
on a central/remote server

Leads me to a separate question: are there pros/cons to running the slon app
on a remote server rather than on the local server?  Seems like it makes
administration easer--but at the cost of increased network traffic?

Do you have any insight to this?

--Richard

On Tue, Nov 9, 2010 at 2:38 PM, Steve Singer <ssinger at ca.afilias.info>wrote:

> On 10-11-09 11:09 AM, Richard Yen wrote:
>
>> Hi, does anyone know if slony ever "abandons" connections?  I've had an
>> idle transaction for the past 6 hours on one of my subscriber nodes,
>> and according to my logs, the transaction was started, but there was
>> never any action done in it, except to set the transaction level to
>> serializable
>>
>> Odd thing is--the node is not lagging from the origin when I look at the
>> origin's sl_status table
>>
>> Also, I don't know if this might be relevant, but the backend for the
>> transaction has been open since 2010-11-01, and it's been processing
>> plenty of transactions successfully up until this point
>>
>> How else can I diagnose this problem?
>> --Richard
>>
>>
>
> First I would determine which slon process the connection comes from
> (pg_stat_activity matched to the process id).
>
> If the slon is the 'local' to the slave database (that is, this is the slon
> servicing the node that is reporting the idle connection) then you need to
> figure out which thread the has stopped.
>
> Have you changed the time/date on your server recently?
> Do you see traffic in the logs from localListener, cleanupThread? the sync
> thread?
>
>
> If it is a remote connection, then what was the last thing that remote
> listener did.
>
> Slony doesn't normally abandon connections but it is possible something
> went wrong.
>
>
>
>
>
>
>>
>> _______________________________________________
>> Slony1-general mailing list
>> Slony1-general at lists.slony.info
>> http://lists.slony.info/mailman/listinfo/slony1-general
>>
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20101109/3a85c3ca/attachment.htm 

From vivek at khera.org  Tue Nov  9 16:54:02 2010
From: vivek at khera.org (Vick Khera)
Date: Tue, 9 Nov 2010 19:54:02 -0500
Subject: [Slony1-general] Sl_log table is huge, over 100 million rows
In-Reply-To: <30174341.post@talk.nabble.com>
References: <30173901.post@talk.nabble.com>
	<AANLkTinzwmP10-kJgmKh-eUjh2JLGjpdr7hF3DrNX6MA@mail.gmail.com>
	<30174341.post@talk.nabble.com>
Message-ID: <AANLkTikNAxixEeH6fRoZRWoxuquvECr-hhiG28qx1Ax5@mail.gmail.com>

On Tue, Nov 9, 2010 at 2:45 PM, sharadov <sreddy at spark.net> wrote:
> how do i check if the son daemons are running?
>

They're just unix processes. Look for them.  If you don't know how to
do that, just turn off your computers and go home as this is well
beyond your experience.

Your replication has fallen behind by 20 days.  At this point I'd say
it would be faster to drop it all and recreate from scratch.

From utha_de_hikaru at yahoo.co.id  Tue Nov  9 21:38:50 2010
From: utha_de_hikaru at yahoo.co.id (utha zoro)
Date: Wed, 10 Nov 2010 13:38:50 +0800 (SGT)
Subject: [Slony1-general] Error when delete replication
Message-ID: <373350.80175.qm@web77111.mail.sg1.yahoo.com>

i need help when delete entire replication on slave database.

i have 2 database connected and have replication each other before. node 1 is 
master and node 2 is slave. when i delete replication on master and then i 
delete replication on slave, i got problem when delete on slave. the error 
message is :

ERROR:  Slony-I: alterTableRestore(): Table with id 1 not found
CONTEXT:  SQL statement "SELECT  "_ad_cluster".alterTableRestore( $1 )"
PL/pgSQL function "uninstallnode" line 14 at PERFORM

do i have to delete replication on slave first before master? and badly, i dont 
have backup of my database master. can anyone suggests me how i have to do to 
delete replication on slave?

thx for ur help.

regards,


zuhri

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20101110/7cf523b4/attachment.htm 

From shoaibmir at gmail.com  Tue Nov  9 21:49:20 2010
From: shoaibmir at gmail.com (Shoaib Mir)
Date: Wed, 10 Nov 2010 16:49:20 +1100
Subject: [Slony1-general] Error when delete replication
In-Reply-To: <373350.80175.qm@web77111.mail.sg1.yahoo.com>
References: <373350.80175.qm@web77111.mail.sg1.yahoo.com>
Message-ID: <AANLkTi=Vz64pTox4e0wcA6X++nu6f4=bEk23cC9qdw_x@mail.gmail.com>

On Wed, Nov 10, 2010 at 4:38 PM, utha zoro <utha_de_hikaru at yahoo.co.id>wrote:

> ERROR:  Slony-I: alterTableRestore(): Table with id 1 not found
> CONTEXT:  SQL statement "SELECT  "_ad_cluster".alterTableRestore( $1 )"
> PL/pgSQL function "uninstallnode" line 14 at PERFORM
>
>
>
Whats the output for:

SELECT * from _ad_cluster.sl_table where tab_id=1

And once you find the tablename please also show the output for:

\d <tablename>

-- 
Shoaib Mir
http://shoaibmir.wordpress.com/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20101110/e2632e3e/attachment.htm 

From utha_de_hikaru at yahoo.co.id  Tue Nov  9 22:01:38 2010
From: utha_de_hikaru at yahoo.co.id (utha zoro)
Date: Wed, 10 Nov 2010 14:01:38 +0800 (SGT)
Subject: [Slony1-general] Bls:  Error when delete replication
In-Reply-To: <AANLkTi=Vz64pTox4e0wcA6X++nu6f4=bEk23cC9qdw_x@mail.gmail.com>
References: <373350.80175.qm@web77111.mail.sg1.yahoo.com>
	<AANLkTi=Vz64pTox4e0wcA6X++nu6f4=bEk23cC9qdw_x@mail.gmail.com>
Message-ID: <542450.58775.qm@web77116.mail.sg1.yahoo.com>



output for : 

SELECT * from _ad_cluster.sl_table where tab_id=1

is

tab_id | tab_reloid | tab_relname | tab_nspname | tab_set |   tab_idxname   | 
tab_altered |   tab_comment     
--------+------------+-------------+-------------+---------+-----------------+-------------+------------------
       1 |     147286 | ad_element  | adempiere   |       1 | ad_element_pkey | 
t           | Table ad_element (1 row)

output for : 

\d ad_element

 ad_element_id  | numeric(10,0)               | not null
 ad_client_id   | numeric(10,0)               | not null
 ad_org_id      | numeric(10,0)               | not null
 isactive       | character(1)                | not null default 'Y'::bpchar
 created        | timestamp without time zone | not null
 createdby      | numeric(10,0)               | not null
 updated        | timestamp without time zone | not null default now()
 updatedby      | numeric(10,0)               | not null
 columnname     | character varying(30)       | not null
 entitytype     | character varying(40)       | not null default 'D'::character 
varying
 name           | character varying(60)       | not null
 printname      | character varying(60)       | not null
 description    | character varying(255)      | 
 help           | character varying(2000)     | 
 po_name        | character varying(60)       | 
 po_printname   | character varying(60)       | 
 po_description | character varying(255)      | 
 po_help        | character varying(2000)     | 
Indexes:
    "ad_element_pkey" PRIMARY KEY, btree (ad_element_id)
    "ad_element_uppercolumnname" UNIQUE, btree (upper(columnname::text))
    "ad_element_clientorg" btree (ad_client_id, ad_org_id)
    "ad_element_name" btree (name)
Check constraints:
    "ad_element_isactive_check" CHECK (isactive = ANY (ARRAY['Y'::bpchar, 
'N'::bpchar]))
Foreign-key constraints:
    "entityt_adelement" FOREIGN KEY (entitytype) REFERENCES 
ad_entitytype(entitytype) DEFERRABLE INITIALLY DEFERRED
Referenced by:
    TABLE "ad_column" CONSTRAINT "ad_element_ad_column" FOREIGN KEY 
(ad_element_id) REFERENCES ad_element(ad_element_id) DEFERRABLE INITIALLY 
DEFERRED
    TABLE "ad_element_trl" CONSTRAINT "adelement_adelementtrl" FOREIGN KEY 
(ad_element_id) REFERENCES ad_element(ad_element_id) ON DELETE CASCADE 
DEFERRABLE INITIALLY DEFERRED
    TABLE "ad_infocolumn" CONSTRAINT "adelement_adinfocolumn" FOREIGN KEY 
(ad_element_id) REFERENCES ad_element(ad_element_id) DEFERRABLE INITIALLY 
DEFERRED
    TABLE "ad_process_para" CONSTRAINT "adelement_adprocesspara" FOREIGN KEY 
(ad_element_id) REFERENCES ad_element(ad_element_id) DEFERRABLE INITIALLY 
DEFERRED
Triggers:
    _ad_cluster_denyaccess_1 BEFORE INSERT OR DELETE OR UPDATE ON ad_element FOR 
EACH ROW EXECUTE PROCEDURE _ad_cluster.denyaccess('_ad_cluster')

(END) 

what i have to do next, mr? thx

regards,

zuhri


________________________________
Dari: Shoaib Mir <shoaibmir at gmail.com>
Kepada: utha zoro <utha_de_hikaru at yahoo.co.id>
Cc: slony1-general at lists.slony.info
Terkirim: Rab, 10 November, 2010 12:49:20
Judul: Re: [Slony1-general] Error when delete replication

On Wed, Nov 10, 2010 at 4:38 PM, utha zoro <utha_de_hikaru at yahoo.co.id> wrote:

ERROR:  Slony-I: alterTableRestore(): Table with id 1 not found
>CONTEXT:  SQL statement "SELECT  "_ad_cluster".alterTableRestore( $1 )"
>PL/pgSQL function "uninstallnode" line 14 at PERFORM
>
>
>
>

Whats the output for:

SELECT * from _ad_cluster.sl_table where tab_id=1

And once you find the tablename please also show the output for:

\d <tablename>
 -- 
Shoaib Mir
http://shoaibmir.wordpress.com/


-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20101110/5f7c1ff8/attachment-0001.htm 

From shoaibmir at gmail.com  Tue Nov  9 22:08:24 2010
From: shoaibmir at gmail.com (Shoaib Mir)
Date: Wed, 10 Nov 2010 17:08:24 +1100
Subject: [Slony1-general] Error when delete replication
In-Reply-To: <542450.58775.qm@web77116.mail.sg1.yahoo.com>
References: <373350.80175.qm@web77111.mail.sg1.yahoo.com>
	<AANLkTi=Vz64pTox4e0wcA6X++nu6f4=bEk23cC9qdw_x@mail.gmail.com>
	<542450.58775.qm@web77116.mail.sg1.yahoo.com>
Message-ID: <AANLkTikP3i_JAr7qCmekMcT2pjF6j63b2+CjmemqiaJn@mail.gmail.com>

On Wed, Nov 10, 2010 at 5:01 PM, utha zoro <utha_de_hikaru at yahoo.co.id>
 wrote:

>
>
> what i have to do next, mr? thx
>
>
Hmm well I thought you have changed the index name or something like that
but doesnt look like.

Have you tried doing "drop schema _ad_cluster cascade;" ??

-- 
Shoaib Mir
http://shoaibmir.wordpress.com/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20101110/306396ff/attachment.htm 

From ssinger at ca.afilias.info  Wed Nov 10 05:15:26 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Wed, 10 Nov 2010 08:15:26 -0500
Subject: [Slony1-general] Does Slony ever "abandon" connections?
In-Reply-To: <AANLkTi=vD39joLg9EKf6aW0QUQsH+=bwj0MG5kQVEZ_5@mail.gmail.com>
References: <AANLkTikX2i_=0r6ux+snw4oyOUTECoMgtyKpQiXPykP+@mail.gmail.com>	<4CD9CD76.9020401@ca.afilias.info>
	<AANLkTi=vD39joLg9EKf6aW0QUQsH+=bwj0MG5kQVEZ_5@mail.gmail.com>
Message-ID: <4CDA9AEE.8030002@ca.afilias.info>

On 10-11-09 07:13 PM, Richard Yen wrote:
> Hmm, that seems to make sense.  Given that Daylight Savings Time just
> ended, that might explain the reason why it got abandoned, since my slon
> procs run on a central/remote server
>
> Leads me to a separate question: are there pros/cons to running the slon
> app on a remote server rather than on the local server?  Seems like it
> makes administration easer--but at the cost of increased network traffic?
>
> Do you have any insight to this?

Administration is easier, it MIGHT simplify your security procedures 
(you could have all the db servers 'trust' one admin server or have a 
.pgpass file in the one admin server instead of passwords spread out 
everywhere).   But it will increase network traffic.

I'd say that at a minimum I would try to have the slon running on the 
same LAN segment as the database instance it is serving.  The latency of 
running slon over a WAN might be an issue + slon does not deal well with 
network outages that tend to be more common on a WAN.

Our dba team tends to run the slons from central admin servers and I 
think they are happy with how it works out.


>
> --Richard
>
> On Tue, Nov 9, 2010 at 2:38 PM, Steve Singer <ssinger at ca.afilias.info
> <mailto:ssinger at ca.afilias.info>> wrote:
>
>     On 10-11-09 11:09 AM, Richard Yen wrote:
>
>         Hi, does anyone know if slony ever "abandons" connections?  I've
>         had an
>         idle transaction for the past 6 hours on one of my subscriber nodes,
>         and according to my logs, the transaction was started, but there was
>         never any action done in it, except to set the transaction level to
>         serializable
>
>         Odd thing is--the node is not lagging from the origin when I
>         look at the
>         origin's sl_status table
>
>         Also, I don't know if this might be relevant, but the backend
>         for the
>         transaction has been open since 2010-11-01, and it's been processing
>         plenty of transactions successfully up until this point
>
>         How else can I diagnose this problem?
>         --Richard
>
>
>
>     First I would determine which slon process the connection comes from
>     (pg_stat_activity matched to the process id).
>
>     If the slon is the 'local' to the slave database (that is, this is
>     the slon servicing the node that is reporting the idle connection)
>     then you need to figure out which thread the has stopped.
>
>     Have you changed the time/date on your server recently?
>     Do you see traffic in the logs from localListener, cleanupThread?
>     the sync thread?
>
>
>     If it is a remote connection, then what was the last thing that
>     remote listener did.
>
>     Slony doesn't normally abandon connections but it is possible
>     something went wrong.
>
>
>
>
>
>
>
>         _______________________________________________
>         Slony1-general mailing list
>         Slony1-general at lists.slony.info
>         <mailto:Slony1-general at lists.slony.info>
>         http://lists.slony.info/mailman/listinfo/slony1-general
>
>
>


From ssinger at ca.afilias.info  Wed Nov 10 05:21:15 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Wed, 10 Nov 2010 08:21:15 -0500
Subject: [Slony1-general] Error when delete replication
In-Reply-To: <AANLkTikP3i_JAr7qCmekMcT2pjF6j63b2+CjmemqiaJn@mail.gmail.com>
References: <373350.80175.qm@web77111.mail.sg1.yahoo.com>	<AANLkTi=Vz64pTox4e0wcA6X++nu6f4=bEk23cC9qdw_x@mail.gmail.com>	<542450.58775.qm@web77116.mail.sg1.yahoo.com>
	<AANLkTikP3i_JAr7qCmekMcT2pjF6j63b2+CjmemqiaJn@mail.gmail.com>
Message-ID: <4CDA9C4B.3020907@ca.afilias.info>

On 10-11-10 01:08 AM, Shoaib Mir wrote:
> On Wed, Nov 10, 2010 at 5:01 PM, utha zoro <utha_de_hikaru at yahoo.co.id
> <mailto:utha_de_hikaru at yahoo.co.id>> wrote:
>
>
>
>     what i have to do next, mr? thx
>
>
> Hmm well I thought you have changed the index name or something like
> that but doesnt look like.
>
> Have you tried doing "drop schema _ad_cluster cascade;" ??
>

With slony 1.2.x (or earlier) this won't work for a slave database.

You must use the UNINSTALL NODE slonik command.  See
(http://www.slony.info/documentation/1.2/stmtuninstallnode.html)


It is important that you "uninstall" the slave node BEFORE your drop the 
slony schema on that slave node.



> --
> Shoaib Mir
> http://shoaibmir.wordpress.com/
>
>
>
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


From sreddy at spark.net  Tue Nov  9 17:08:47 2010
From: sreddy at spark.net (sharadov)
Date: Tue, 9 Nov 2010 17:08:47 -0800 (PST)
Subject: [Slony1-general] Sl_log table is huge, over 100 million rows
In-Reply-To: <AANLkTikNAxixEeH6fRoZRWoxuquvECr-hhiG28qx1Ax5@mail.gmail.com>
References: <30173901.post@talk.nabble.com>
	<AANLkTinzwmP10-kJgmKh-eUjh2JLGjpdr7hF3DrNX6MA@mail.gmail.com>
	<30174341.post@talk.nabble.com>
	<AANLkTikNAxixEeH6fRoZRWoxuquvECr-hhiG28qx1Ax5@mail.gmail.com>
Message-ID: <30176888.post@talk.nabble.com>


Hey Vick - I inherited this system, and the reason am here on this forum, is
to figure this out.
And I don't need any unsolicited advice from the likes of you.






Vick Khera wrote:
> 
> On Tue, Nov 9, 2010 at 2:45 PM, sharadov <sreddy at spark.net> wrote:
>> how do i check if the son daemons are running?
>>
> 
> They're just unix processes. Look for them.  If you don't know how to
> do that, just turn off your computers and go home as this is well
> beyond your experience.
> 
> Your replication has fallen behind by 20 days.  At this point I'd say
> it would be faster to drop it all and recreate from scratch.
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
> 
> 

-- 
View this message in context: http://old.nabble.com/Sl_log-table-is-huge%2C-over-100-million-rows-tp30173901p30176888.html
Sent from the Slony-I -- General mailing list archive at Nabble.com.


From sreddy at spark.net  Tue Nov  9 17:09:26 2010
From: sreddy at spark.net (sharadov)
Date: Tue, 9 Nov 2010 17:09:26 -0800 (PST)
Subject: [Slony1-general] Sl_log table is huge, over 100 million rows
In-Reply-To: <87aaligpbe.fsf@cbbrowne.afilias-int.info>
References: <30173901.post@talk.nabble.com>
	<87aaligpbe.fsf@cbbrowne.afilias-int.info>
Message-ID: <30176891.post@talk.nabble.com>


I'll start working through what you suggested.


Christopher Browne wrote:
> 
> sharadov <sreddy at spark.net> writes:
>> We have slony replication set up, and the replication on the slave has
>> fallen behind by 10 days. On investigating I noticed that the sl_log_1
>> table
>> has 25K records, but the sl_log_2 table has over 100 million rows, and
>> they
>> keep going up. How do I go about troubleshooting this?
>>
>> I am a newbie to slony, and would appreciate all the help that I can get
> 
> You should consider running the "test_slony_state" script which pokes at
> various parts of the configuration with a view to seeing what might be
> wrong.
> 
>   <http://slony.info/documentation/2.0/monitoring.html>
> 
> Some questions...
> 
>   - Why didn't you notice for 10 days?
> 
>     Presumably monitoring hasn't been done right.  I'd suggest running
>     test_slony_state on an hourly basis; it complains only if something
>     seems broken...
> 
>   - Are the slon processes running?
> 
>     Usually /usr/bin/ps can help find them...
> 
>   - Is the slon for the subscriber actually replicating data?
> 
>     You should search in the slon logs for the subscriber for lines
>     looking like:
> 
>        DEBUG2: remoteWorkerThread_%d: SYNC %d done in %.3f seconds
>        DEBUG2: remoteWorkerThread_%d_d: inserts=%d updates=%d deletes=%d
> 
>     That should give you an idea as to whether replication work is
>     actually taking place.
> 
>     If it's running into errors before doing real work, then there's
>     some problem that need to get rectified.
> 
>     There's a somewhat "worst case scenario" where if there are way too
>     many events to process, and a timeout gets exceeded:
> 
>        ERROR: remoteListenThread_%d: timeout for event selection
> 
>      This means that the listener thread (src/slon/remote_listener.c)
>      timed out when trying to determine what events were outstanding for
>      it.
> 
>      This could occur because network connections broke, in which case
>      restarting the slon might help.
> 
>      Alternatively, this might occur because the slon for this node has
>      been broken for a long time, and there are an enormous number of
>      entries in sl_event on this or other nodes for the node to work
>      through, and it is taking more than slon_conf_remote_listen_timeout
>      seconds to run the query. In older versions of Slony-I, that
>      configuration parameter did not exist; the timeout was fixed at 300
>      seconds. In newer versions, you might increase that timeout in the
>      slon config file to a larger value so that it can continue to
>      completion. And then investigate why nobody was monitoring things
>      such that replication broke for such a long time...
> 
>    If this proves to be the problem, then you can change the listen
>    timeout to something rather larger than 300 seconds.  And hopefully
>    the slon can get past the too-many-events problem.
> -- 
> "cbbrowne","@","ca.afilias.info"
> Christopher Browne
> "Bother,"  said Pooh,  "Eeyore, ready  two photon  torpedoes  and lock
> phasers on the Heffalump, Piglet, meet me in transporter room three"
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
> 
> 

-- 
View this message in context: http://old.nabble.com/Sl_log-table-is-huge%2C-over-100-million-rows-tp30173901p30176891.html
Sent from the Slony-I -- General mailing list archive at Nabble.com.


From JanWieck at Yahoo.com  Wed Nov 10 06:47:45 2010
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Wed, 10 Nov 2010 09:47:45 -0500
Subject: [Slony1-general] Sl_log table is huge, over 100 million rows
In-Reply-To: <30176888.post@talk.nabble.com>
References: <30173901.post@talk.nabble.com>	<AANLkTinzwmP10-kJgmKh-eUjh2JLGjpdr7hF3DrNX6MA@mail.gmail.com>	<30174341.post@talk.nabble.com>	<AANLkTikNAxixEeH6fRoZRWoxuquvECr-hhiG28qx1Ax5@mail.gmail.com>
	<30176888.post@talk.nabble.com>
Message-ID: <4CDAB091.80003@Yahoo.com>

On 11/9/2010 8:08 PM, sharadov wrote:
>
> Hey Vick - I inherited this system, and the reason am here on this forum, is
> to figure this out.
> And I don't need any unsolicited advice from the likes of you.

Everyone take a deep breath!

We don't need exchanges like this on the Slony mailing lists. Vick is 
one of the most helpful people on here. That comment about going home 
may have been uncalled for, but it isn't that bad either. If you 
inherited production servers and have such little expertise in the 
actual administration of that operating system that you don't know how 
to check if a certain executable is running, the chance for you doing 
more harm while stumbling around with root permissions is pretty big. IF 
that is the case that you are on an unfamiliar OS lacking proper 
documentation of what is installed and where, you should consider hiring 
a consultant for a day or two to figure this out.

If that is not an option, first of all figure out how the slon processes 
are launched (if at all) on system startup. Depending on your OS and 
distribution, there should be a start/stop script somewhere in a init.d 
or rc.d directory, that launches and kills the slon executable.

 From that script you should be able to figure out the actual location 
of the slon process binary. Execute that with the -v option to get the 
exact version number of the installed Slony. This will allow us to give 
you version specific help since things have changed over time.

The script should also show you where the slon log files are located. 
Examine them according to Chris' comments.


Jan



>
>
>
>
>
>
> Vick Khera wrote:
>>
>>  On Tue, Nov 9, 2010 at 2:45 PM, sharadov<sreddy at spark.net>  wrote:
>>>  how do i check if the son daemons are running?
>>>
>>
>>  They're just unix processes. Look for them.  If you don't know how to
>>  do that, just turn off your computers and go home as this is well
>>  beyond your experience.
>>
>>  Your replication has fallen behind by 20 days.  At this point I'd say
>>  it would be faster to drop it all and recreate from scratch.
>>  _______________________________________________
>>  Slony1-general mailing list
>>  Slony1-general at lists.slony.info
>>  http://lists.slony.info/mailman/listinfo/slony1-general
>>
>>
>


-- 
Anyone who trades liberty for security deserves neither
liberty nor security. -- Benjamin Franklin

From JanWieck at Yahoo.com  Wed Nov 10 06:51:49 2010
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Wed, 10 Nov 2010 09:51:49 -0500
Subject: [Slony1-general] Error when delete replication
In-Reply-To: <AANLkTikP3i_JAr7qCmekMcT2pjF6j63b2+CjmemqiaJn@mail.gmail.com>
References: <373350.80175.qm@web77111.mail.sg1.yahoo.com>	<AANLkTi=Vz64pTox4e0wcA6X++nu6f4=bEk23cC9qdw_x@mail.gmail.com>	<542450.58775.qm@web77116.mail.sg1.yahoo.com>
	<AANLkTikP3i_JAr7qCmekMcT2pjF6j63b2+CjmemqiaJn@mail.gmail.com>
Message-ID: <4CDAB185.3020804@Yahoo.com>

On 11/10/2010 1:08 AM, Shoaib Mir wrote:
> On Wed, Nov 10, 2010 at 5:01 PM, utha zoro <utha_de_hikaru at yahoo.co.id
> <mailto:utha_de_hikaru at yahoo.co.id>> wrote:
>
>
>
>     what i have to do next, mr? thx
>
>
> Hmm well I thought you have changed the index name or something like
> that but doesnt look like.
>
> Have you tried doing "drop schema _ad_cluster cascade;" ??

STOP!

That only works without leaving behind a corrupted system catalog in 
version 2.0.

It appears that this table has been dropped and recreated on the slave 
without going through EXECUTE SCRIPT. You will be able to fix this with 
REPAIR CONFIG. After that, you should be able to do the UNINSTALL NODE.


Jan

>
> --
> Shoaib Mir
> http://shoaibmir.wordpress.com/
>
>
>
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


-- 
Anyone who trades liberty for security deserves neither
liberty nor security. -- Benjamin Franklin

From greg at endpoint.com  Wed Nov 10 06:55:57 2010
From: greg at endpoint.com (Greg Sabino Mullane)
Date: Wed, 10 Nov 2010 09:55:57 -0500
Subject: [Slony1-general] Error when delete replication
In-Reply-To: <4CDAB185.3020804@Yahoo.com>
References: <373350.80175.qm@web77111.mail.sg1.yahoo.com>
	<AANLkTi=Vz64pTox4e0wcA6X++nu6f4=bEk23cC9qdw_x@mail.gmail.com>
	<542450.58775.qm@web77116.mail.sg1.yahoo.com>
	<AANLkTikP3i_JAr7qCmekMcT2pjF6j63b2+CjmemqiaJn@mail.gmail.com>
	<4CDAB185.3020804@Yahoo.com>
Message-ID: <20101110145557.GU27378@core.home>

> > Have you tried doing "drop schema _ad_cluster cascade;" ??
> 
> STOP!
> 
> That only works without leaving behind a corrupted system catalog in 
> version 2.0.

To be precise, it only corrupts the slaves, not the master, IIUC.

-- 
Greg Sabino Mullane greg at endpoint.com
End Point Corporation
PGP Key: 0x14964AC8
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 163 bytes
Desc: not available
Url : http://lists.slony.info/pipermail/slony1-general/attachments/20101110/7b45cd08/attachment-0001.pgp 

From cbbrowne at ca.afilias.info  Wed Nov 10 08:54:25 2010
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Wed, 10 Nov 2010 11:54:25 -0500
Subject: [Slony1-general] Does Slony ever "abandon" connections?
In-Reply-To: <4CDA9AEE.8030002@ca.afilias.info> (Steve Singer's message of
	"Wed, 10 Nov 2010 08:15:26 -0500")
References: <AANLkTikX2i_=0r6ux+snw4oyOUTECoMgtyKpQiXPykP+@mail.gmail.com>
	<4CD9CD76.9020401@ca.afilias.info>
	<AANLkTi=vD39joLg9EKf6aW0QUQsH+=bwj0MG5kQVEZ_5@mail.gmail.com>
	<4CDA9AEE.8030002@ca.afilias.info>
Message-ID: <8739r9glvi.fsf@cbbrowne.afilias-int.info>

Steve Singer <ssinger at ca.afilias.info> writes:
> Our dba team tends to run the slons from central admin servers and I 
> think they are happy with how it works out.

The case that I know has turned out badly is when slon processes were
running in a network segment distant from the DBs they manage.  

We'd occasionally have network glitches between sites (consider "virtual
LAN tunnelling" and such), and that would make those particular slons'
connections stop; it would typically take a couple hours (based on
TCP/IP timeouts) for the database to conclude the connection was dead,
and close it automatically.

Until that happened, replication would cease, unless someone went in and
terminated the useless connection on the DB server by hand.

If the slons managing nodes at "site A" run at "site A," and the slons
managing nodes at "site B" run at "site B," that sort of problem
normally doesn't take place.
-- 
output = ("cbbrowne" "@" "ca.afilias.info")
Christopher Browne
"Bother,"  said Pooh,  "Eeyore, ready  two photon  torpedoes  and lock
phasers on the Heffalump, Piglet, meet me in transporter room three"

From shoaibmir at gmail.com  Wed Nov 10 14:56:38 2010
From: shoaibmir at gmail.com (Shoaib Mir)
Date: Thu, 11 Nov 2010 09:56:38 +1100
Subject: [Slony1-general] Error when delete replication
In-Reply-To: <4CDAB185.3020804@Yahoo.com>
References: <373350.80175.qm@web77111.mail.sg1.yahoo.com>
	<AANLkTi=Vz64pTox4e0wcA6X++nu6f4=bEk23cC9qdw_x@mail.gmail.com>
	<542450.58775.qm@web77116.mail.sg1.yahoo.com>
	<AANLkTikP3i_JAr7qCmekMcT2pjF6j63b2+CjmemqiaJn@mail.gmail.com>
	<4CDAB185.3020804@Yahoo.com>
Message-ID: <AANLkTimuKO424PEJtoebHLD7w8W_6pQBV6=qXDWj5Xm-@mail.gmail.com>

On Thu, Nov 11, 2010 at 1:51 AM, Jan Wieck <JanWieck at yahoo.com> wrote:

> On 11/10/2010 1:08 AM, Shoaib Mir wrote:
>
>> On Wed, Nov 10, 2010 at 5:01 PM, utha zoro <utha_de_hikaru at yahoo.co.id
>> <mailto:utha_de_hikaru at yahoo.co.id>> wrote:
>>
>>
>>
>>    what i have to do next, mr? thx
>>
>>
>> Hmm well I thought you have changed the index name or something like
>> that but doesnt look like.
>>
>> Have you tried doing "drop schema _ad_cluster cascade;" ??
>>
>
> STOP!
>
> That only works without leaving behind a corrupted system catalog in
> version 2.0.
>
>
Yes my bad as not doing an UNINSTALL would have missed to get the tables
back to unlocked state.... so I guess if hes already done the DROP SCHEMA
then the solution can be:

- Re-create the database
- Restore the schema only dump from master
- Initialize the cluster (which will copy all the data across)

-- 
Shoaib Mir
http://shoaibmir.wordpress.com/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20101111/c3a02d16/attachment.htm 

From atsaloli.tech at gmail.com  Fri Nov 12 10:56:06 2010
From: atsaloli.tech at gmail.com (Aleksey Tsalolikhin)
Date: Fri, 12 Nov 2010 10:56:06 -0800
Subject: [Slony1-general] how to troubleshoot slony replication lag?
Message-ID: <AANLkTi=nQudqbkoH-0gVLfVk9K7GgvUaaYxarwu=uCuE@mail.gmail.com>

Any pointers for troubleshooting slony replication lag?  We're running
slony-I 1.2.20, and replicating a 23 GB database across WAN (between
nearby cities).

last afternoon, slony lag started growing, and has been steadily
slowly inching up... the lag is now 2 hours 48 minutes...

I don't see any "troubleshooting" documentation on the slony web site
and hope someone can help me out...

I've tried restarting the slony slave, and the slony master and slave,
and even rebooting the slave server...  the lag is still growing.
I've confirmed the slave can get to the master's DB, and the master
can get to the slave's DB.

i've checked latency in our network monitoring system, between the two
sites, and things are humming along.

what else do I look at?

oh, yeah, and I initiated a slony log switch yesterday, that didn't help...

What else should I try besides dropping the replication set and re-creating it?

Best,
-at

From wmoran at potentialtech.com  Fri Nov 12 11:05:34 2010
From: wmoran at potentialtech.com (Bill Moran)
Date: Fri, 12 Nov 2010 14:05:34 -0500
Subject: [Slony1-general] how to troubleshoot slony replication lag?
In-Reply-To: <AANLkTi=nQudqbkoH-0gVLfVk9K7GgvUaaYxarwu=uCuE@mail.gmail.com>
References: <AANLkTi=nQudqbkoH-0gVLfVk9K7GgvUaaYxarwu=uCuE@mail.gmail.com>
Message-ID: <20101112140534.cb102590.wmoran@potentialtech.com>

In response to Aleksey Tsalolikhin <atsaloli.tech at gmail.com>:

> Any pointers for troubleshooting slony replication lag?  We're running
> slony-I 1.2.20, and replicating a 23 GB database across WAN (between
> nearby cities).
> 
> last afternoon, slony lag started growing, and has been steadily
> slowly inching up... the lag is now 2 hours 48 minutes...
> 
> I don't see any "troubleshooting" documentation on the slony web site
> and hope someone can help me out...
> 
> I've tried restarting the slony slave, and the slony master and slave,
> and even rebooting the slave server...  the lag is still growing.
> I've confirmed the slave can get to the master's DB, and the master
> can get to the slave's DB.
> 
> i've checked latency in our network monitoring system, between the two
> sites, and things are humming along.
> 
> what else do I look at?
> 
> oh, yeah, and I initiated a slony log switch yesterday, that didn't help...
> 
> What else should I try besides dropping the replication set and re-creating it?

Are you monitoring the PostgreSQL and Slony logs on both servers?

Usually when we see lag that isn't catching up, it's the result of someone
making a schema change and not properly changing all the servers.  This
usually has some fairly obvious errors in the logs.

-- 
Bill Moran
http://www.potentialtech.com
http://people.collaborativefusion.com/~wmoran/

From dba at richyen.com  Fri Nov 12 11:28:42 2010
From: dba at richyen.com (Richard Yen)
Date: Fri, 12 Nov 2010 11:28:42 -0800
Subject: [Slony1-general] how to troubleshoot slony replication lag?
In-Reply-To: <AANLkTi=nQudqbkoH-0gVLfVk9K7GgvUaaYxarwu=uCuE@mail.gmail.com>
References: <AANLkTi=nQudqbkoH-0gVLfVk9K7GgvUaaYxarwu=uCuE@mail.gmail.com>
Message-ID: <AANLkTik7rcEp5Zjp97dM_b6Zq3uwZHu4OpzfK13ZwOyK@mail.gmail.com>

Aleksey,

Hmm, can you describe any changes that have happened in the past couple of
days?  i.e., schema changes, usage changes, architecture changes?  Seems odd
that it would suddenly start lagging like this.

Also, can you check on the master under _<slony_schema>.sl_status and let us
know if the st_last_event and st_last_received are growing?  And if you have
any postgres or slon logs (for both nodes), can you report on any errors
that might be showing up?  This would help in figuring out what state looks
like.

last afternoon, slony lag started growing, and has been steadily
> slowly inching up... the lag is now 2 hours 48 minutes...
>
>
Thanks,
--Richard
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20101112/aa8f1d78/attachment.htm 

From richyen at iparadigms.com  Fri Nov 12 11:26:54 2010
From: richyen at iparadigms.com (Richard Yen)
Date: Fri, 12 Nov 2010 11:26:54 -0800
Subject: [Slony1-general] how to troubleshoot slony replication lag?
In-Reply-To: <AANLkTi=nQudqbkoH-0gVLfVk9K7GgvUaaYxarwu=uCuE@mail.gmail.com>
References: <AANLkTi=nQudqbkoH-0gVLfVk9K7GgvUaaYxarwu=uCuE@mail.gmail.com>
Message-ID: <AANLkTikF5FEs5TNgyhypL-ar+WrZCaiwj-7pL_PTMDV0@mail.gmail.com>

Aleksey,

Hmm, can you describe any changes that have happened in the past couple of
days?  i.e., schema changes, usage changes, architecture changes?  Seems odd
that it would suddenly start lagging like this.

Also, can you check on the master under _<slony_schema>.sl_status and let us
know if the st_last_event and st_last_received are growing?  And if you have
any postgres or slon logs (for both nodes), can you report on any errors
that might be showing up?  This would help in figuring out what state looks
like.

last afternoon, slony lag started growing, and has been steadily
> slowly inching up... the lag is now 2 hours 48 minutes...
>
>
Thanks,
--Richard
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20101112/3802fd38/attachment.htm 

From ssinger at ca.afilias.info  Fri Nov 12 12:50:56 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Fri, 12 Nov 2010 15:50:56 -0500
Subject: [Slony1-general] how to troubleshoot slony replication lag?
In-Reply-To: <AANLkTi=nQudqbkoH-0gVLfVk9K7GgvUaaYxarwu=uCuE@mail.gmail.com>
References: <AANLkTi=nQudqbkoH-0gVLfVk9K7GgvUaaYxarwu=uCuE@mail.gmail.com>
Message-ID: <4CDDA8B0.5080600@ca.afilias.info>

On 10-11-12 01:56 PM, Aleksey Tsalolikhin wrote:
> Any pointers for troubleshooting slony replication lag?  We're running
> slony-I 1.2.20, and replicating a 23 GB database across WAN (between
> nearby cities).
>
> last afternoon, slony lag started growing, and has been steadily
> slowly inching up... the lag is now 2 hours 48 minutes...
>
> I don't see any "troubleshooting" documentation on the slony web site
> and hope someone can help me out...
>


http://www.slony.info/documentation/1.2/loganalysis.html is worth reviewing



I would check to see if it is one of the following three situations

1) A query was executed on the master that touched many (millions?) of 
rows in table.  Something like a "UPDATE foo SET count=1;" on a table 
might be fast on the master but slony will replicate this one row at a 
time.  Over a WAN the round-trip latency on table can be pretty painful.
If this is the case you either have to wait until it finishes or give up 
teardown replication and start again.  I can't think of a way to 
determine how far along it is since nothing becomes visible until the 
transaction completes+commits.

2) Something has happened so the replication (insert,update,delete) is 
failing on the slave. You should see errors in the slon logs if this is 
the case.

3) You have a high volume database and a long running transaction.  The 
long running transaction will have prevented log switch from happening 
(slony can't truncate sl_log until the long running transaction finishes 
and replicates).  Your sl_log_1 has grown very big (and will keep 
growing since the truncate + log switch can't happen until the 
transaction finishes).  Since sl_log is so big each SYNC (both 
generating and replicating) takes a long time,  If this is the case you 
should see slony making progress (confirming events) just at a slow rate.



> I've tried restarting the slony slave, and the slony master and slave,
> and even rebooting the slave server...  the lag is still growing.
> I've confirmed the slave can get to the master's DB, and the master
> can get to the slave's DB.
>
> i've checked latency in our network monitoring system, between the two
> sites, and things are humming along.
>
> what else do I look at?
>
> oh, yeah, and I initiated a slony log switch yesterday, that didn't help...
>
> What else should I try besides dropping the replication set and re-creating it?
>
> Best,
> -at
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


From atsaloli.tech at gmail.com  Fri Nov 12 23:48:38 2010
From: atsaloli.tech at gmail.com (Aleksey Tsalolikhin)
Date: Fri, 12 Nov 2010 23:48:38 -0800
Subject: [Slony1-general] how to troubleshoot slony replication lag?
In-Reply-To: <4CDDA8B0.5080600@ca.afilias.info>
References: <AANLkTi=nQudqbkoH-0gVLfVk9K7GgvUaaYxarwu=uCuE@mail.gmail.com>
	<4CDDA8B0.5080600@ca.afilias.info>
Message-ID: <AANLkTinu1S0Gf7HGtg13vvyCDtTtt_-Y47814J5F3hVF@mail.gmail.com>

Thank you for your kind replies. sl_status table in the slony schema
shows st_last_event and st_last_received are growing.

No errors in the Slony or Postgres log files on the master nor the slave.

I've shut down the slave and master; dropped the DB on the slave; and
recreated the replication set.  It's copying across now (23 GB).
We'll see how it holds up after the resync.

Thanks!
Aleksey

From bhirt at me.com  Sat Nov 13 07:30:44 2010
From: bhirt at me.com (Brian Hirt)
Date: Sat, 13 Nov 2010 08:30:44 -0700
Subject: [Slony1-general] how to troubleshoot slony replication lag?
In-Reply-To: <AANLkTinu1S0Gf7HGtg13vvyCDtTtt_-Y47814J5F3hVF@mail.gmail.com>
References: <AANLkTi=nQudqbkoH-0gVLfVk9K7GgvUaaYxarwu=uCuE@mail.gmail.com>
	<4CDDA8B0.5080600@ca.afilias.info>
	<AANLkTinu1S0Gf7HGtg13vvyCDtTtt_-Y47814J5F3hVF@mail.gmail.com>
Message-ID: <569A84EC-2CF3-4429-9826-DFA90585FA37@me.com>

check_postgres.pl (http://bucardo.org/wiki/Check_postgres) is a great tool for giving you an early heads up that replication lag is getting behind.  Used in conjunction with something like nagios, it will pretty much let you know as soon as things start going wrong.  In my experience, once you get to that point where replication falls a day behind it's becomes progressively harder to fix.  Knowing that something broke five minutes ago usually makes it much easier to track down.

Brian Hirt
bhirt at me.com



On Nov 13, 2010, at 12:48 AM, Aleksey Tsalolikhin wrote:

> Thank you for your kind replies. sl_status table in the slony schema
> shows st_last_event and st_last_received are growing.
> 
> No errors in the Slony or Postgres log files on the master nor the slave.
> 
> I've shut down the slave and master; dropped the DB on the slave; and
> recreated the replication set.  It's copying across now (23 GB).
> We'll see how it holds up after the resync.
> 
> Thanks!
> Aleksey
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


From atsaloli.tech at gmail.com  Sat Nov 13 08:06:00 2010
From: atsaloli.tech at gmail.com (Aleksey Tsalolikhin)
Date: Sat, 13 Nov 2010 08:06:00 -0800
Subject: [Slony1-general] how to troubleshoot slony replication lag?
In-Reply-To: <569A84EC-2CF3-4429-9826-DFA90585FA37@me.com>
References: <AANLkTi=nQudqbkoH-0gVLfVk9K7GgvUaaYxarwu=uCuE@mail.gmail.com>
	<4CDDA8B0.5080600@ca.afilias.info>
	<AANLkTinu1S0Gf7HGtg13vvyCDtTtt_-Y47814J5F3hVF@mail.gmail.com>
	<569A84EC-2CF3-4429-9826-DFA90585FA37@me.com>
Message-ID: <AANLkTikMqjMv0GseOC33ySbEpQfocrsWFh_NZ0P_Ln6J@mail.gmail.com>

Replication lag is present (and growing) again after resync.  Help!

We do use check_postgres.pl, thanks, Brian, that's how we noticed the problem.

I've reviewed http://www.slony.info/documentation/1.2/loganalysis.html,
thanks, Steve; there are no ERROR messages on the slon slave or
master, only DEBUG.

There is one interesting DEBUG message on the master, and I could not
find it in loganalysis.html:  "calc sync size", and the ideal is often
larger than the proposed, example:  (ideal: 14, proposed: 3)


DEBUG2 remoteListenThread_2: queue event 2,2659 SYNC
DEBUG2 remoteWorkerThread_2: Received event 2,2659 SYNC
DEBUG2 calc sync size - last time: 1 last length: 4152 ideal: 14
proposed size: 3
DEBUG2 remoteWorkerThread_2: SYNC 2659 processing
DEBUG2 remoteWorkerThread_2: no sets need syncing for this event


another example:  (ideal 11, proposed 5)


DEBUG2 remoteListenThread_2: UNLISTEN
DEBUG2 remoteWorkerThread_2: Received event 2,2667 SYNC
DEBUG2 calc sync size - last time: 2 last length: 10008 ideal: 11
proposed size: 5
DEBUG2 remoteWorkerThread_2: SYNC 2667 processing
DEBUG2 remoteWorkerThread_2: no sets need syncing for this event
DEBUG2 localListenThread: Received event 1,14742 SYNC


Would suboptimal sync size influence replication time?

What else can I do to analyze and resolve this problem, please?

From atsaloli.tech at gmail.com  Sat Nov 13 08:14:03 2010
From: atsaloli.tech at gmail.com (Aleksey Tsalolikhin)
Date: Sat, 13 Nov 2010 08:14:03 -0800
Subject: [Slony1-general] how to troubleshoot slony replication lag?
In-Reply-To: <AANLkTikMqjMv0GseOC33ySbEpQfocrsWFh_NZ0P_Ln6J@mail.gmail.com>
References: <AANLkTi=nQudqbkoH-0gVLfVk9K7GgvUaaYxarwu=uCuE@mail.gmail.com>
	<4CDDA8B0.5080600@ca.afilias.info>
	<AANLkTinu1S0Gf7HGtg13vvyCDtTtt_-Y47814J5F3hVF@mail.gmail.com>
	<569A84EC-2CF3-4429-9826-DFA90585FA37@me.com>
	<AANLkTikMqjMv0GseOC33ySbEpQfocrsWFh_NZ0P_Ln6J@mail.gmail.com>
Message-ID: <AANLkTi=Tt7RyvZgFhLr5KHkfig4Ggv_V8fkhCHe7_d25@mail.gmail.com>

P.S.  Here are my sl_log_1 and sl_log_2 table sizes (including the
index): are these OK for a 23 GB database?   (on the slon_master)


db# select pg_size_pretty(pg_total_relation_size('slony_schema.sl_log_1'));
 pg_size_pretty
----------------
 24 kB
(1 row)

db# select pg_size_pretty(pg_total_relation_size('slony_schema.sl_log_2'));
 pg_size_pretty
----------------
 2301 MB
(1 row)

db#

From ssinger_pg at sympatico.ca  Sat Nov 13 09:20:22 2010
From: ssinger_pg at sympatico.ca (Steve Singer)
Date: Sat, 13 Nov 2010 12:20:22 -0500
Subject: [Slony1-general] how to troubleshoot slony replication lag?
In-Reply-To: <AANLkTikMqjMv0GseOC33ySbEpQfocrsWFh_NZ0P_Ln6J@mail.gmail.com>
References: <AANLkTi=nQudqbkoH-0gVLfVk9K7GgvUaaYxarwu=uCuE@mail.gmail.com>
	<4CDDA8B0.5080600@ca.afilias.info>
	<AANLkTinu1S0Gf7HGtg13vvyCDtTtt_-Y47814J5F3hVF@mail.gmail.com>
	<569A84EC-2CF3-4429-9826-DFA90585FA37@me.com>
	<AANLkTikMqjMv0GseOC33ySbEpQfocrsWFh_NZ0P_Ln6J@mail.gmail.com>
Message-ID: <BLU0-SMTP89D8BEDDE017727723F1FFAC340@phx.gbl>

On Sat, 13 Nov 2010, Aleksey Tsalolikhin wrote:

> Replication lag is present (and growing) again after resync.  Help!
>
> We do use check_postgres.pl, thanks, Brian, that's how we noticed the problem.
>
> I've reviewed http://www.slony.info/documentation/1.2/loganalysis.html,
> thanks, Steve; there are no ERROR messages on the slon slave or
> master, only DEBUG.
>
> There is one interesting DEBUG message on the master, and I could not
> find it in loganalysis.html:  "calc sync size", and the ideal is often
> larger than the proposed, example:  (ideal: 14, proposed: 3)
>
>
> DEBUG2 remoteListenThread_2: queue event 2,2659 SYNC
> DEBUG2 remoteWorkerThread_2: Received event 2,2659 SYNC
> DEBUG2 calc sync size - last time: 1 last length: 4152 ideal: 14
> proposed size: 3
> DEBUG2 remoteWorkerThread_2: SYNC 2659 processing
> DEBUG2 remoteWorkerThread_2: no sets need syncing for this event
>
>
> another example:  (ideal 11, proposed 5)
>
>
> DEBUG2 remoteListenThread_2: UNLISTEN
> DEBUG2 remoteWorkerThread_2: Received event 2,2667 SYNC

This line means that the 2667'th event originating from node 2 has been 
processed (I am assuming that this is the node 1 log).

In the node to log do you see similar lines but with an event like "1,1234"
indicating that node 2 is processing events from node 1.

If not what does show up in your log for that node.

> DEBUG2 calc sync size - last time: 2 last length: 10008 ideal: 11
> proposed size: 5



> DEBUG2 remoteWorkerThread_2: SYNC 2667 processing
> DEBUG2 remoteWorkerThread_2: no sets need syncing for this event
> DEBUG2 localListenThread: Received event 1,14742 SYNC
>
>
> Would suboptimal sync size influence replication time?
>
> What else can I do to analyze and resolve this problem, please?
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
>


From atsaloli.tech at gmail.com  Mon Nov 15 01:27:01 2010
From: atsaloli.tech at gmail.com (Aleksey Tsalolikhin)
Date: Mon, 15 Nov 2010 01:27:01 -0800
Subject: [Slony1-general] how to troubleshoot slony replication lag?
In-Reply-To: <AANLkTinZG8=pjpeLyU7Hoq4bjwhPmKkwcUQYp+gBi71C@mail.gmail.com>
References: <AANLkTi=nQudqbkoH-0gVLfVk9K7GgvUaaYxarwu=uCuE@mail.gmail.com>
	<4CDDA8B0.5080600@ca.afilias.info>
	<AANLkTinu1S0Gf7HGtg13vvyCDtTtt_-Y47814J5F3hVF@mail.gmail.com>
	<569A84EC-2CF3-4429-9826-DFA90585FA37@me.com>
	<AANLkTikMqjMv0GseOC33ySbEpQfocrsWFh_NZ0P_Ln6J@mail.gmail.com>
	<BLU0-SMTP89D8BEDDE017727723F1FFAC340@phx.gbl>
	<AANLkTinZG8=pjpeLyU7Hoq4bjwhPmKkwcUQYp+gBi71C@mail.gmail.com>
Message-ID: <AANLkTi=QMKEKTRSgYWtBMzWGcGsBVpvXLvNjqqJ+i9X9@mail.gmail.com>

On Sun, Nov 14, 2010 at 4:41 PM, Aleksey Tsalolikhin
<atsaloli.tech at gmail.com> wrote:
> Dear Steve,
>
> Thanks for your reply, here is the information you requested.

message did not go through due to large size (over 40 KB)

Here's a few seconds of master/slave logs (from the same time window):

http://pastebin.com/JxmrPfdY

looks like the slave is not handling the events from the master?

at this point replication lag is 35+ hours and the sl_log_1 and
sl_log_2 total 43 GB (on an originally 23 GB database, now 65 GB in
size including sl_log_1 and sl_log_2)

we are going to take an emergency maintenance window to upgrade from
slony-I 1.2.20 to 1.2.21 and resync, see how it looks then.

Aleksey

From atsaloli.tech at gmail.com  Mon Nov 15 03:19:31 2010
From: atsaloli.tech at gmail.com (Aleksey Tsalolikhin)
Date: Mon, 15 Nov 2010 03:19:31 -0800
Subject: [Slony1-general] how to troubleshoot slony replication lag?
In-Reply-To: <AANLkTi=QMKEKTRSgYWtBMzWGcGsBVpvXLvNjqqJ+i9X9@mail.gmail.com>
References: <AANLkTi=nQudqbkoH-0gVLfVk9K7GgvUaaYxarwu=uCuE@mail.gmail.com>
	<4CDDA8B0.5080600@ca.afilias.info>
	<AANLkTinu1S0Gf7HGtg13vvyCDtTtt_-Y47814J5F3hVF@mail.gmail.com>
	<569A84EC-2CF3-4429-9826-DFA90585FA37@me.com>
	<AANLkTikMqjMv0GseOC33ySbEpQfocrsWFh_NZ0P_Ln6J@mail.gmail.com>
	<BLU0-SMTP89D8BEDDE017727723F1FFAC340@phx.gbl>
	<AANLkTinZG8=pjpeLyU7Hoq4bjwhPmKkwcUQYp+gBi71C@mail.gmail.com>
	<AANLkTi=QMKEKTRSgYWtBMzWGcGsBVpvXLvNjqqJ+i9X9@mail.gmail.com>
Message-ID: <AANLkTike1dyLb=iW48ajH5pHpjpYtQAqMB=K8+FeepSc@mail.gmail.com>

On Mon, Nov 15, 2010 at 1:27 AM, Aleksey Tsalolikhin
<atsaloli.tech at gmail.com> wrote:
>
> we are going to take an emergency maintenance window to upgrade from
> slony-I 1.2.20 to 1.2.21 and resync, see how it looks then.

Looks good so far, replication lag after initial sync is 23 minutes
and shrinking; let's see how it holds up under load tomorrow.

BTW, when I did a 3 second sample on master and slave log file, the
slave log file was hundreds of lines, not thousands of lines as when
we were having trouble.

Yours truly,
-at

From atsaloli.tech at gmail.com  Mon Nov 15 09:29:14 2010
From: atsaloli.tech at gmail.com (Aleksey Tsalolikhin)
Date: Mon, 15 Nov 2010 09:29:14 -0800
Subject: [Slony1-general] how to troubleshoot slony replication lag?
In-Reply-To: <AANLkTike1dyLb=iW48ajH5pHpjpYtQAqMB=K8+FeepSc@mail.gmail.com>
References: <AANLkTi=nQudqbkoH-0gVLfVk9K7GgvUaaYxarwu=uCuE@mail.gmail.com>
	<4CDDA8B0.5080600@ca.afilias.info>
	<AANLkTinu1S0Gf7HGtg13vvyCDtTtt_-Y47814J5F3hVF@mail.gmail.com>
	<569A84EC-2CF3-4429-9826-DFA90585FA37@me.com>
	<AANLkTikMqjMv0GseOC33ySbEpQfocrsWFh_NZ0P_Ln6J@mail.gmail.com>
	<BLU0-SMTP89D8BEDDE017727723F1FFAC340@phx.gbl>
	<AANLkTinZG8=pjpeLyU7Hoq4bjwhPmKkwcUQYp+gBi71C@mail.gmail.com>
	<AANLkTi=QMKEKTRSgYWtBMzWGcGsBVpvXLvNjqqJ+i9X9@mail.gmail.com>
	<AANLkTike1dyLb=iW48ajH5pHpjpYtQAqMB=K8+FeepSc@mail.gmail.com>
Message-ID: <AANLkTi=iuhkF45GhJ0XCimTPfXx6fVsp9HmV8U-pq=S=@mail.gmail.com>

On Mon, Nov 15, 2010 at 3:19 AM, Aleksey Tsalolikhin
<atsaloli.tech at gmail.com> wrote:
> On Mon, Nov 15, 2010 at 1:27 AM, Aleksey Tsalolikhin
> <atsaloli.tech at gmail.com> wrote:
>>
>> we are going to take an emergency maintenance window to upgrade from
>> slony-I 1.2.20 to 1.2.21 and resync, see how it looks then.

Lag is over an hour now.  Here is a quick snapshot of the logs:


Slony master:


2010-11-15 09:24:50 PSTDEBUG2 localListenThread: Received event 1,12426 SYNC
2010-11-15 09:24:52 PSTDEBUG2 syncThread: new sl_action_seq 22626110 -
SYNC 12427
2010-11-15 09:24:52 PSTDEBUG2 localListenThread: Received event 1,12427 SYNC
2010-11-15 09:24:53 PSTDEBUG2 remoteListenThread_2: LISTEN
2010-11-15 09:24:54 PSTDEBUG2 syncThread: new sl_action_seq 22626117 -
SYNC 12428
2010-11-15 09:24:54 PSTDEBUG2 localListenThread: Received event 1,12428 SYNC


Slony slave:


2010-11-15 09:24:53 PSTDEBUG2 syncThread: new sl_action_seq 1 - SYNC 2353
2010-11-15 09:24:54 PSTDEBUG2 remoteListenThread_1: queue event 1,12428 SYNC
2010-11-15 09:24:55 PSTDEBUG4 remoteWorkerThread_1: returning lines to pool
2010-11-15 09:24:55 PSTDEBUG4 remoteHelperThread_1_1: fetch from cursor
2010-11-15 09:24:55 PSTDEBUG4 remoteHelperThread_1_1: fetched 100 log rows
2010-11-15 09:24:55 PSTDEBUG4 remoteHelperThread_1_1: deliver 10 lines to worker
2010-11-15 09:24:55 PSTDEBUG4 remoteHelperThread_1_1: allocate line buffers
2010-11-15 09:24:56 PSTDEBUG2 remoteListenThread_1: queue event 1,12429 SYNC


What does "SYNC 2353" mean?  The number is off from the other numbers
(in the 12 thousand  4 hundred range).

Best,
-at

From atsaloli.tech at gmail.com  Mon Nov 15 09:35:18 2010
From: atsaloli.tech at gmail.com (Aleksey Tsalolikhin)
Date: Mon, 15 Nov 2010 09:35:18 -0800
Subject: [Slony1-general] how to troubleshoot slony replication lag?
In-Reply-To: <AANLkTi=iuhkF45GhJ0XCimTPfXx6fVsp9HmV8U-pq=S=@mail.gmail.com>
References: <AANLkTi=nQudqbkoH-0gVLfVk9K7GgvUaaYxarwu=uCuE@mail.gmail.com>
	<4CDDA8B0.5080600@ca.afilias.info>
	<AANLkTinu1S0Gf7HGtg13vvyCDtTtt_-Y47814J5F3hVF@mail.gmail.com>
	<569A84EC-2CF3-4429-9826-DFA90585FA37@me.com>
	<AANLkTikMqjMv0GseOC33ySbEpQfocrsWFh_NZ0P_Ln6J@mail.gmail.com>
	<BLU0-SMTP89D8BEDDE017727723F1FFAC340@phx.gbl>
	<AANLkTinZG8=pjpeLyU7Hoq4bjwhPmKkwcUQYp+gBi71C@mail.gmail.com>
	<AANLkTi=QMKEKTRSgYWtBMzWGcGsBVpvXLvNjqqJ+i9X9@mail.gmail.com>
	<AANLkTike1dyLb=iW48ajH5pHpjpYtQAqMB=K8+FeepSc@mail.gmail.com>
	<AANLkTi=iuhkF45GhJ0XCimTPfXx6fVsp9HmV8U-pq=S=@mail.gmail.com>
Message-ID: <AANLkTinwyCHmdCmrrh3jLk2H4YV6gYXfuxOQe7wXgj2F@mail.gmail.com>

I have to add, the slave server is a bit sluggish at the command-line and
it didn't used to be that way.  load average is over 3 due to
processes blocked on I/O.

Looks like the system is I/O consists mainly of writing to disk ("bo"
blocks out in vmstat 1).

There is nothing on this system but postgres and slon.

I've asked the on-site IT guys to eye ball the server to make sure
there isn't a failed disk...

# vmstat 1
procs -----------memory---------- ---swap-- -----io---- --system--
-----cpu------
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 1  2    200  49656  51856 7659972    0    0   110   496   20   14  1
1 92  6  0
 0  3    200  49656  51856 7659972    0    0     0  7200 1910 1522  0
1 82 17  0
 0  3    200  49656  51856 7659972    0    0     0  6224 1738 1233  0
1 75 24  0
 0  3    200  49656  51856 7659972    0    0     0  6176 1741 1283  0
1 75 24  0
 0  3    200  49656  51856 7660092    0    0     0  6440 1957 1925  2
1 85 13  0
 0  0    200  53408  51892 7655436    0    0     0  3880 1749 2263  3
1 87  9  0
 0  0    200  53284  51892 7655716    0    0     0   284 1496 3169  6
1 92  0  0
 1  0    200  53036  51892 7656056    0    0     0   264 1516 3186  6
1 92  0  0
 0  0    200  52912  51892 7656336    0    0     0   272 1499 3222  7
1 92  0  0
 1  0    200  68288  51892 7641144    0    0     0   656 2045 3826  5
1 94  0  0
 0  2    200  67420  51892 7641888    0    0     0  6028 2330 3807  4
1 91  4  0
 1  0    200  67420  51900 7642220    0    0     0  5868 1908 1723  1
1 87 11  0
 0  0    200  66056  51900 7643764    0    0     0  1024 2136 4070  6
1 93  0  0
 0  0    200  64692  51904 7644780    0    0     0   736 2027 3776  5
1 94  0  0
 1  0    200  63204  51904 7646144    0    0     0   768 2086 3918  6
1 93  0  0
 0  3    200  61716  51904 7646824    0    0     0  3388 2177 3430  4
1 91  4  0
 0  5    200  61716  51904 7647092    0    0     0  6324 1738 1244  0
0 87 13  0
 0  3    200  61592  51904 7647092    0    0     0  6236 1727 1287  0
0 87 13  0
 0  4    200  61716  51904 7647100    0    0     0  7328 1861 1357  0
1 88 12  0
 0  4    200  61716  51904 7647100    0    0     0  7188 1852 1284  0
1 87 12  0
 0  3    200  61716  51904 7647164    0    0     0  6672 1804 1502  0
1 86 13  0
 0  3    200  61716  51908 7647160    0    0     0  6072 1725 1328  0
0 86 14  0
 0  3    200  61592  51908 7647224    0    0     0  6524 1877 1736  1
1 86 12  0
 0  3    200  61344  51908 7647224    0    0     0  6316 1894 1536  0
1 74 25  0
 0  3    200  61344  51908 7647496    0    0     0  6232 1724 1287  0
0 75 25  0
 0  2    200  61220  51916 7647488    0    0     0  6748 1887 1522  0
1 76 22  0
 0  0    200  61468  51924 7647600    0    0     0  4908 1824 1628  1
1 76 22  0
 0  0    200  61040  51924 7648280    0    0   144   648 1489 2794  4
1 95  1  0
 0  0    200  60916  51924 7648784    0    0     0   256 1443 2943  6
1 93  0  0
 0  0    200  60420  51924 7649124    0    0     0   248 1415 2805  5
1 94  0  0
 0  4    200  60172  51924 7649144    0    0     0  5612 1789 2176  2
1 87 10  0
 0  6    200  60172  51924 7649144    0    0     0  6988 1835 1320  0
1 87 12  0
 0  4    200  60172  51924 7649196    0    0     0  6488 1796 1498  0
1 81 18  0
 0  4    200  60172  51924 7649196    0    0     0  6424 1768 1462  1
1 75 23  0
 1  3    200  60048  51924 7649268    0    0     0  6704 1899 1616  0
1 75 24  0
 0  3    200  59428  51924 7649268    0    0     0  6968 1876 1404  0
1 74 25  0
 0  3    200  59676  51932 7649320    0    0     0  6344 1836 1640  1
1 80 18  0
 0  3    200  59676  51932 7649320    0    0     0  6400 1788 1241  0
1 88 12  0
 1  0    200  59924  51944 7649456    0    0     0   688 1469 2537  4
1 92  3  0

From ssinger at ca.afilias.info  Mon Nov 15 09:49:44 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Mon, 15 Nov 2010 12:49:44 -0500
Subject: [Slony1-general] how to troubleshoot slony replication lag?
In-Reply-To: <AANLkTi=iuhkF45GhJ0XCimTPfXx6fVsp9HmV8U-pq=S=@mail.gmail.com>
References: <AANLkTi=nQudqbkoH-0gVLfVk9K7GgvUaaYxarwu=uCuE@mail.gmail.com>	<4CDDA8B0.5080600@ca.afilias.info>	<AANLkTinu1S0Gf7HGtg13vvyCDtTtt_-Y47814J5F3hVF@mail.gmail.com>	<569A84EC-2CF3-4429-9826-DFA90585FA37@me.com>	<AANLkTikMqjMv0GseOC33ySbEpQfocrsWFh_NZ0P_Ln6J@mail.gmail.com>	<BLU0-SMTP89D8BEDDE017727723F1FFAC340@phx.gbl>	<AANLkTinZG8=pjpeLyU7Hoq4bjwhPmKkwcUQYp+gBi71C@mail.gmail.com>	<AANLkTi=QMKEKTRSgYWtBMzWGcGsBVpvXLvNjqqJ+i9X9@mail.gmail.com>	<AANLkTike1dyLb=iW48ajH5pHpjpYtQAqMB=K8+FeepSc@mail.gmail.com>
	<AANLkTi=iuhkF45GhJ0XCimTPfXx6fVsp9HmV8U-pq=S=@mail.gmail.com>
Message-ID: <4CE172B8.4010901@ca.afilias.info>

On 10-11-15 12:29 PM, Aleksey Tsalolikhin wrote:
> On Mon, Nov 15, 2010 at 3:19 AM, Aleksey Tsalolikhin
> <atsaloli.tech at gmail.com>  wrote:
>> On Mon, Nov 15, 2010 at 1:27 AM, Aleksey Tsalolikhin
>> <atsaloli.tech at gmail.com>  wrote:
>>>
>>> we are going to take an emergency maintenance window to upgrade from
>>> slony-I 1.2.20 to 1.2.21 and resync, see how it looks then.
>
> Lag is over an hour now.  Here is a quick snapshot of the logs:
>
>
> Slony master:
>
>
> 2010-11-15 09:24:50 PSTDEBUG2 localListenThread: Received event 1,12426 SYNC
> 2010-11-15 09:24:52 PSTDEBUG2 syncThread: new sl_action_seq 22626110 -
> SYNC 12427
> 2010-11-15 09:24:52 PSTDEBUG2 localListenThread: Received event 1,12427 SYNC
> 2010-11-15 09:24:53 PSTDEBUG2 remoteListenThread_2: LISTEN
> 2010-11-15 09:24:54 PSTDEBUG2 syncThread: new sl_action_seq 22626117 -
> SYNC 12428
> 2010-11-15 09:24:54 PSTDEBUG2 localListenThread: Received event 1,12428 SYNC
>
> Slony slave:
>
>
> 2010-11-15 09:24:53 PSTDEBUG2 syncThread: new sl_action_seq 1 - SYNC 2353
> 2010-11-15 09:24:54 PSTDEBUG2 remoteListenThread_1: queue event 1,12428 SYNC
> 2010-11-15 09:24:55 PSTDEBUG4 remoteWorkerThread_1: returning lines to pool
> 2010-11-15 09:24:55 PSTDEBUG4 remoteHelperThread_1_1: fetch from cursor
> 2010-11-15 09:24:55 PSTDEBUG4 remoteHelperThread_1_1: fetched 100 log rows
> 2010-11-15 09:24:55 PSTDEBUG4 remoteHelperThread_1_1: deliver 10 lines to worker
> 2010-11-15 09:24:55 PSTDEBUG4 remoteHelperThread_1_1: allocate line buffers
> 2010-11-15 09:24:56 PSTDEBUG2 remoteListenThread_1: queue event 1,12429 SYNC
>
>
> What does "SYNC 2353" mean?  The number is off from the other numbers
> (in the 12 thousand  4 hundred range).
>
A sync is identified by two numbers, the origin on which the sync was 
generated and a sequence number for the sync.

1,1  is the first sync generated on node 1
1,2  is the second sync generated on node 1

2,1 is the first sync generated on node 2
2,2 is the second sync generated on node 2.

The slave slon  has a sync thread that generates sync events on the 
slave (your node 2).   The sync thread above is refering to event 
"2,2353" - we aren't printing the 2 but probably should be.

If the slon configuration is the same for both your master and slave 
(your aren't adjusting the sync timing intervals) and you created both 
nodes at about the same time and started the slons at about the same 
time then it sounds like your slave is generating events at a slower 
rate than the master, which isn't a problem per say but might be a 
consequence of your real problem.

It sounds to me like your transaction rate is too high for your setup. 
Either the network can't keep up or the hardware can't keep up.  Based 
on your other post it sounds like the slave is having problems keeping 
up.  Are your master + slave a similar hardware configuration?




> Best,
> -at
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


From atsaloli.tech at gmail.com  Mon Nov 15 22:39:38 2010
From: atsaloli.tech at gmail.com (Aleksey Tsalolikhin)
Date: Mon, 15 Nov 2010 22:39:38 -0800
Subject: [Slony1-general] how to troubleshoot slony replication lag?
In-Reply-To: <4CE172B8.4010901@ca.afilias.info>
References: <AANLkTi=nQudqbkoH-0gVLfVk9K7GgvUaaYxarwu=uCuE@mail.gmail.com>
	<4CDDA8B0.5080600@ca.afilias.info>
	<AANLkTinu1S0Gf7HGtg13vvyCDtTtt_-Y47814J5F3hVF@mail.gmail.com>
	<569A84EC-2CF3-4429-9826-DFA90585FA37@me.com>
	<AANLkTikMqjMv0GseOC33ySbEpQfocrsWFh_NZ0P_Ln6J@mail.gmail.com>
	<BLU0-SMTP89D8BEDDE017727723F1FFAC340@phx.gbl>
	<AANLkTinZG8=pjpeLyU7Hoq4bjwhPmKkwcUQYp+gBi71C@mail.gmail.com>
	<AANLkTi=QMKEKTRSgYWtBMzWGcGsBVpvXLvNjqqJ+i9X9@mail.gmail.com>
	<AANLkTike1dyLb=iW48ajH5pHpjpYtQAqMB=K8+FeepSc@mail.gmail.com>
	<AANLkTi=iuhkF45GhJ0XCimTPfXx6fVsp9HmV8U-pq=S=@mail.gmail.com>
	<4CE172B8.4010901@ca.afilias.info>
Message-ID: <AANLkTimsK_NNEgX6=ofcBSTgAKobuqmXGz7qaR=BGa--@mail.gmail.com>

On Mon, Nov 15, 2010 at 9:49 AM, Steve Singer <ssinger at ca.afilias.info> wrote:
>
> It sounds to me like your transaction rate is too high for your setup.
...
> ?Based on
> your other post it sounds like the slave is having problems keeping up. ?Are
> your master + slave a similar hardware configuration?

Identical.  And you hit the nail right on the head about the transaction rate
being too high, I got the bottom of it, one of our application sub-modules
was generating orders of magnitude more inserts/deletes than we expected --
brought this to light using pgstatspack, very handy.

We dropped that one table from replication (we could do that) and very quickly
replication lag went to near zero.  Yay!!  :)

Thanks very much for the clear explanation of the sync event id's in
the Slony logs
and all your big help!  Very much appreciated!

Yours truly,
Aleksey

From bhirt at me.com  Tue Nov 16 07:35:42 2010
From: bhirt at me.com (Brian Hirt)
Date: Tue, 16 Nov 2010 08:35:42 -0700
Subject: [Slony1-general] how to troubleshoot slony replication lag?
In-Reply-To: <AANLkTimsK_NNEgX6=ofcBSTgAKobuqmXGz7qaR=BGa--@mail.gmail.com>
References: <AANLkTi=nQudqbkoH-0gVLfVk9K7GgvUaaYxarwu=uCuE@mail.gmail.com>
	<4CDDA8B0.5080600@ca.afilias.info>
	<AANLkTinu1S0Gf7HGtg13vvyCDtTtt_-Y47814J5F3hVF@mail.gmail.com>
	<569A84EC-2CF3-4429-9826-DFA90585FA37@me.com>
	<AANLkTikMqjMv0GseOC33ySbEpQfocrsWFh_NZ0P_Ln6J@mail.gmail.com>
	<BLU0-SMTP89D8BEDDE017727723F1FFAC340@phx.gbl>
	<AANLkTinZG8=pjpeLyU7Hoq4bjwhPmKkwcUQYp+gBi71C@mail.gmail.com>
	<AANLkTi=QMKEKTRSgYWtBMzWGcGsBVpvXLvNjqqJ+i9X9@mail.gmail.com>
	<AANLkTike1dyLb=iW48ajH5pHpjpYtQAqMB=K8+FeepSc@mail.gmail.com>
	<AANLkTi=iuhkF45GhJ0XCimTPfXx6fVsp9HmV8U-pq=S=@mail.gmail.com>
	<4CE172B8.4010901@ca.afilias.info>
	<AANLkTimsK_NNEgX6=ofcBSTgAKobuqmXGz7qaR=BGa--@mail.gmail.com>
Message-ID: <51A2C3BF-F0CB-4944-B4EE-66385234427F@me.com>

On Nov 15, 2010, at 11:39 PM, Aleksey Tsalolikhin wrote:

> Identical.  And you hit the nail right on the head about the transaction rate
> being too high

I'm glad you got it figured out.  It seems strange that with two identical machines the slave would fall behind to quickly and dramatically.  Is it expected that slaves require better hardware to keep up?  Just curious...

--brian 

From ajs at crankycanuck.ca  Tue Nov 16 07:54:07 2010
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Tue, 16 Nov 2010 10:54:07 -0500
Subject: [Slony1-general] how to troubleshoot slony replication lag?
In-Reply-To: <51A2C3BF-F0CB-4944-B4EE-66385234427F@me.com>
References: <569A84EC-2CF3-4429-9826-DFA90585FA37@me.com>
	<AANLkTikMqjMv0GseOC33ySbEpQfocrsWFh_NZ0P_Ln6J@mail.gmail.com>
	<BLU0-SMTP89D8BEDDE017727723F1FFAC340@phx.gbl>
	<AANLkTinZG8=pjpeLyU7Hoq4bjwhPmKkwcUQYp+gBi71C@mail.gmail.com>
	<AANLkTi=QMKEKTRSgYWtBMzWGcGsBVpvXLvNjqqJ+i9X9@mail.gmail.com>
	<AANLkTike1dyLb=iW48ajH5pHpjpYtQAqMB=K8+FeepSc@mail.gmail.com>
	<AANLkTi=iuhkF45GhJ0XCimTPfXx6fVsp9HmV8U-pq=S=@mail.gmail.com>
	<4CE172B8.4010901@ca.afilias.info>
	<AANLkTimsK_NNEgX6=ofcBSTgAKobuqmXGz7qaR=BGa--@mail.gmail.com>
	<51A2C3BF-F0CB-4944-B4EE-66385234427F@me.com>
Message-ID: <20101116155407.GL1389@shinkuro.com>

On Tue, Nov 16, 2010 at 08:35:42AM -0700, Brian Hirt wrote:
> 
> I'm glad you got it figured out.  It seems strange that with two identical machines the slave would fall behind to quickly and dramatically.  Is it expected that slaves require better hardware to keep up?  Just curious...
> 

IME, they often do.  The problem is that the master gets the
transactions retail, and the slave gets them in largeish chunks.
There's overhead in managing the additional work in getting things to
the targets, too.

Also, often you can solve some of this with tuning of the slave.
Because its transaction profile is not exactly the same as the master,
you can sometimes find that settings on the master don't work well for
a slave.

A

-- 
Andrew Sullivan
ajs at crankycanuck.ca

From jaime at 2ndquadrant.com  Wed Nov 17 07:46:28 2010
From: jaime at 2ndquadrant.com (Jaime Casanova)
Date: Wed, 17 Nov 2010 10:46:28 -0500
Subject: [Slony1-general] postgres 8.4 supported by slony 1.2.21?
Message-ID: <AANLkTik8zaf8YK-_QNHwhva7i1mupzgx=Oyraw__LM0j@mail.gmail.com>

Hi,

I'm in the process of upgrade from 1.2.20 to 1.2.21.
So, in both nodes i follow these steps:
- stop the slon processes
- build slony from sources indicating pg_configdir (configure, make,
make install)
- execute the slonik command: update functions (i did this first with node 1)

and when doing that i get this message:
$ sh slony_admin.sh
<stdin>:21: Possible unsupported PostgreSQL version 8.4, defaulting to
8.1 support

just in case pg_config says:
$ pg_config --version
PostgreSQL 8.4.3

and the slony installed:
$ slon -v
slon version 1.2.21

$ slonik -v
slonik version 1.2.21


so, is this something i have to worry about? more important, does
slony 1.2.21 support 9.0?

-- 
Jaime Casanova? ? ? ?? www.2ndQuadrant.com
Professional PostgreSQL: Soporte y capacitaci?n de PostgreSQL

From jaime at 2ndquadrant.com  Wed Nov 17 07:58:42 2010
From: jaime at 2ndquadrant.com (Jaime Casanova)
Date: Wed, 17 Nov 2010 10:58:42 -0500
Subject: [Slony1-general] postgres 8.4 supported by slony 1.2.21?
In-Reply-To: <AANLkTik8zaf8YK-_QNHwhva7i1mupzgx=Oyraw__LM0j@mail.gmail.com>
References: <AANLkTik8zaf8YK-_QNHwhva7i1mupzgx=Oyraw__LM0j@mail.gmail.com>
Message-ID: <AANLkTimBSrgF7DPdf32T3o_R89Z3U1SJ3pHOS9vR=xeW@mail.gmail.com>

On Wed, Nov 17, 2010 at 10:46 AM, Jaime Casanova <jaime at 2ndquadrant.com> wrote:
>
> so, is this something i have to worry about? more important, does
> slony 1.2.21 support 9.0?
>

ah! seems like the function load_slony_base() in slonik.c should be
updated but not sure how...
because the condition seems to be including 8.4, besides it needs to
know that 8.5 doesn't exists but is 9.0 instead

now being the case that every one of those versions all use the schema
for 8.1 then it seems safe, at least until 8.4... 9.0 will use the
same schema? anything to be worried?

"""
        else if ((adminfo->pg_version >= 80100) && adminfo->pg_version
< 80500) /* 8.1, 8.2, 8.3, 8.4 */
        {
                use_major = 8;
                use_minor = 1;
        }
        else    /* 8.5+ */
        {
                use_major = 8;
                use_minor = 1;
                printf("%s:%d: Possible unsupported PostgreSQL "
                        "version (%d) %d.%d, defaulting to 8.1 support\n",
                        stmt->stmt_filename, stmt->stmt_lno,
adminfo->pg_version,
                        (adminfo->pg_version/10000),
((adminfo->pg_version%10000)/100));
        }

"""

-- 
Jaime Casanova? ? ? ?? www.2ndQuadrant.com
Professional PostgreSQL: Soporte y capacitaci?n de PostgreSQL

From peter.geoghegan86 at gmail.com  Wed Nov 17 08:04:09 2010
From: peter.geoghegan86 at gmail.com (Peter Geoghegan)
Date: Wed, 17 Nov 2010 16:04:09 +0000
Subject: [Slony1-general] postgres 8.4 supported by slony 1.2.21?
In-Reply-To: <AANLkTik8zaf8YK-_QNHwhva7i1mupzgx=Oyraw__LM0j@mail.gmail.com>
References: <AANLkTik8zaf8YK-_QNHwhva7i1mupzgx=Oyraw__LM0j@mail.gmail.com>
Message-ID: <AANLkTi=ZHa6UFoBM2i-V4E0wPWsjdqyGQdyy3r98Vq7A@mail.gmail.com>

> so, is this something i have to worry about? more important, does
> slony 1.2.21 support 9.0?

I've used 2.0.2, and found that this error can be safely ignored. I
seem to recall reading on slony.info that this unnecessary warning was
removed in one of the 2.0.3RCs.

-- 
Regards,
Peter Geoghegan

From ssinger at ca.afilias.info  Wed Nov 17 08:07:21 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Wed, 17 Nov 2010 11:07:21 -0500
Subject: [Slony1-general] postgres 8.4 supported by slony 1.2.21?
In-Reply-To: <AANLkTimBSrgF7DPdf32T3o_R89Z3U1SJ3pHOS9vR=xeW@mail.gmail.com>
References: <AANLkTik8zaf8YK-_QNHwhva7i1mupzgx=Oyraw__LM0j@mail.gmail.com>
	<AANLkTimBSrgF7DPdf32T3o_R89Z3U1SJ3pHOS9vR=xeW@mail.gmail.com>
Message-ID: <4CE3FDB9.3000400@ca.afilias.info>

On 10-11-17 10:58 AM, Jaime Casanova wrote:

I'm thinking we might want to release a 1.2.22 soon.

A handful of things have accumulated up in the 1.2 branch.

git log  REL_1_2_STABLE ^REL_1_2_21

These changes have been applied already, I think in 
http://git.postgresql.org/gitweb?p=slony1-engine.git;a=commit;h=0d1781229fd3cc6a2abac083174166945d08ed7f

That commit also fixes a bug that will show up in 8.4 and later.

Other than that I am not aware of any issues 1.2 will have with 9.0.  I 
haven't done much testing of 1.2 with 9.0 (have others?) but while I was 
testing 2.0.x against 9.0 betas I don't recall seeing anything that 
needed back-porting.




> On Wed, Nov 17, 2010 at 10:46 AM, Jaime Casanova<jaime at 2ndquadrant.com>  wrote:
>>
>> so, is this something i have to worry about? more important, does
>> slony 1.2.21 support 9.0?
>>
>
> ah! seems like the function load_slony_base() in slonik.c should be
> updated but not sure how...
> because the condition seems to be including 8.4, besides it needs to
> know that 8.5 doesn't exists but is 9.0 instead
>
> now being the case that every one of those versions all use the schema
> for 8.1 then it seems safe, at least until 8.4... 9.0 will use the
> same schema? anything to be worried?
>
> """
>          else if ((adminfo->pg_version>= 80100)&&  adminfo->pg_version
> <  80500) /* 8.1, 8.2, 8.3, 8.4 */
>          {
>                  use_major = 8;
>                  use_minor = 1;
>          }
>          else    /* 8.5+ */
>          {
>                  use_major = 8;
>                  use_minor = 1;
>                  printf("%s:%d: Possible unsupported PostgreSQL "
>                          "version (%d) %d.%d, defaulting to 8.1 support\n",
>                          stmt->stmt_filename, stmt->stmt_lno,
> adminfo->pg_version,
>                          (adminfo->pg_version/10000),
> ((adminfo->pg_version%10000)/100));
>          }
>
> """
>


From jaime at 2ndquadrant.com  Wed Nov 17 09:36:48 2010
From: jaime at 2ndquadrant.com (Jaime Casanova)
Date: Wed, 17 Nov 2010 12:36:48 -0500
Subject: [Slony1-general] postgres 8.4 supported by slony 1.2.21?
In-Reply-To: <4CE3FDB9.3000400@ca.afilias.info>
References: <AANLkTik8zaf8YK-_QNHwhva7i1mupzgx=Oyraw__LM0j@mail.gmail.com>
	<AANLkTimBSrgF7DPdf32T3o_R89Z3U1SJ3pHOS9vR=xeW@mail.gmail.com>
	<4CE3FDB9.3000400@ca.afilias.info>
Message-ID: <AANLkTik7Hf2x=fqMFtcjpWhyCxZTEGLwN7QgTjOoOccT@mail.gmail.com>

On Wed, Nov 17, 2010 at 11:07 AM, Steve Singer <ssinger at ca.afilias.info> wrote:
> On 10-11-17 10:58 AM, Jaime Casanova wrote:
>
> I'm thinking we might want to release a 1.2.22 soon.
>

+1

-- 
Jaime Casanova? ? ? ?? www.2ndQuadrant.com
Professional PostgreSQL: Soporte y capacitaci?n de PostgreSQL

From vivek at khera.org  Wed Nov 17 11:12:24 2010
From: vivek at khera.org (Vick Khera)
Date: Wed, 17 Nov 2010 14:12:24 -0500
Subject: [Slony1-general] postgres 8.4 supported by slony 1.2.21?
In-Reply-To: <AANLkTimBSrgF7DPdf32T3o_R89Z3U1SJ3pHOS9vR=xeW@mail.gmail.com>
References: <AANLkTik8zaf8YK-_QNHwhva7i1mupzgx=Oyraw__LM0j@mail.gmail.com>
	<AANLkTimBSrgF7DPdf32T3o_R89Z3U1SJ3pHOS9vR=xeW@mail.gmail.com>
Message-ID: <AANLkTimBu4ap+3x2v96ybAxpMUPVd9jX0-Cq4ZAZ+fi+@mail.gmail.com>

On Wed, Nov 17, 2010 at 10:58 AM, Jaime Casanova <jaime at 2ndquadrant.com> wrote:
> now being the case that every one of those versions all use the schema
> for 8.1 then it seems safe, at least until 8.4... 9.0 will use the
> same schema? anything to be worried?
>

9.0 uses the same schema.  At least I have not observed any errors
replicating from 8.3 to 9.0 using slony 1.2.21.

From jaime at 2ndquadrant.com  Wed Nov 17 12:14:55 2010
From: jaime at 2ndquadrant.com (Jaime Casanova)
Date: Wed, 17 Nov 2010 15:14:55 -0500
Subject: [Slony1-general] postgres 8.4 supported by slony 1.2.21?
In-Reply-To: <4CE3FDB9.3000400@ca.afilias.info>
References: <AANLkTik8zaf8YK-_QNHwhva7i1mupzgx=Oyraw__LM0j@mail.gmail.com>
	<AANLkTimBSrgF7DPdf32T3o_R89Z3U1SJ3pHOS9vR=xeW@mail.gmail.com>
	<4CE3FDB9.3000400@ca.afilias.info>
Message-ID: <AANLkTinThG9Kp9c0fug8PFuBdjaMiDkFJmCV02wk6whC@mail.gmail.com>

On Wed, Nov 17, 2010 at 11:07 AM, Steve Singer <ssinger at ca.afilias.info> wrote:
>
> Other than that I am not aware of any issues 1.2 will have with 9.0. ?I
> haven't done much testing of 1.2 with 9.0 (have others?) but while I was
> testing 2.0.x against 9.0 betas I don't recall seeing anything that
> needed back-porting.
>
>

mmm... well, i have postgresql 9.0.1 installed on a node (this was
installed via the yum repository) and because the repo have 2.0.4 and
i don't want to kill my existing slony installation so i'm compiling
1.2.21 and get this error:

"""
gcc -g -O2 -Wall -Wmissing-prototypes -Wmissing-declarations -I../..
-DPGSHARE="\"/usr/pgsql-9.0/bin//../share/\"" -DPG_VERSION_MAJOR=9
slonik.o dbutil.o parser.o  ../parsestatements/scanner.o
-L/usr/pgsql-9.0/lib/ -L/usr/pgsql-9.0/lib/ -lpq
-Wl,-rpath,/usr/pgsql-9.0/lib/ -lpgport  -o slonik
/usr/bin/ld: skipping incompatible /usr/pgsql-9.0/lib//libpgport.a
when searching for -lpgport
/usr/bin/ld: skipping incompatible /usr/pgsql-9.0/lib//libpgport.a
when searching for -lpgport
/usr/bin/ld: cannot find -lpgport
collect2: ld returned 1 exit status
"""

there were a change there too?

-- 
Jaime Casanova? ? ? ?? www.2ndQuadrant.com
Professional PostgreSQL: Soporte y capacitaci?n de PostgreSQL

From cbbrowne at ca.afilias.info  Wed Nov 17 12:24:04 2010
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Wed, 17 Nov 2010 15:24:04 -0500
Subject: [Slony1-general] postgres 8.4 supported by slony 1.2.21?
In-Reply-To: <AANLkTimBu4ap+3x2v96ybAxpMUPVd9jX0-Cq4ZAZ+fi+@mail.gmail.com>
	(Vick Khera's message of "Wed, 17 Nov 2010 14:12:24 -0500")
References: <AANLkTik8zaf8YK-_QNHwhva7i1mupzgx=Oyraw__LM0j@mail.gmail.com>
	<AANLkTimBSrgF7DPdf32T3o_R89Z3U1SJ3pHOS9vR=xeW@mail.gmail.com>
	<AANLkTimBu4ap+3x2v96ybAxpMUPVd9jX0-Cq4ZAZ+fi+@mail.gmail.com>
Message-ID: <87y68rem1n.fsf@cbbrowne.afilias-int.info>

Vick Khera <vivek at khera.org> writes:
> On Wed, Nov 17, 2010 at 10:58 AM, Jaime Casanova <jaime at 2ndquadrant.com> wrote:
>> now being the case that every one of those versions all use the schema
>> for 8.1 then it seems safe, at least until 8.4... 9.0 will use the
>> same schema? anything to be worried?
>>
>
> 9.0 uses the same schema.  At least I have not observed any errors
> replicating from 8.3 to 9.0 using slony 1.2.21.

There are *NO* differences in the tables used.

Looking at the source tree for 1.2:
http://git.postgresql.org/gitweb?p=slony1-engine.git;a=tree;f=src/backend;h=03c8724fbb6e8574d56d58bdb3be54e4ad113f91;hb=refs/heads/REL_1_2_STABLE

The schema goes in slony1_base.sql.

While there are "version-specific" files  nominally for 7.3, 7.4, 8.0,
and 8.1, you'll find that these files are totally empty.

In contrast, there are material differences between the functions used,
where 7.3, 7.4, 8.0, 8.1, and 8.4 files contain not-huge but still
material bits of code that are loaded in by STORE NODE/UPDATE FUNCTIONS.

9.0 uses the same functions as 8.4, in that case.
-- 
output = ("cbbrowne" "@" "afilias.info")
Christopher Browne
"Bother,"  said Pooh,  "Eeyore, ready  two photon  torpedoes  and lock
phasers on the Heffalump, Piglet, meet me in transporter room three"

From ssinger at ca.afilias.info  Wed Nov 17 12:28:31 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Wed, 17 Nov 2010 15:28:31 -0500
Subject: [Slony1-general] postgres 8.4 supported by slony 1.2.21?
In-Reply-To: <AANLkTinThG9Kp9c0fug8PFuBdjaMiDkFJmCV02wk6whC@mail.gmail.com>
References: <AANLkTik8zaf8YK-_QNHwhva7i1mupzgx=Oyraw__LM0j@mail.gmail.com>
	<AANLkTimBSrgF7DPdf32T3o_R89Z3U1SJ3pHOS9vR=xeW@mail.gmail.com>
	<4CE3FDB9.3000400@ca.afilias.info>
	<AANLkTinThG9Kp9c0fug8PFuBdjaMiDkFJmCV02wk6whC@mail.gmail.com>
Message-ID: <4CE43AEF.5030204@ca.afilias.info>

On 10-11-17 03:14 PM, Jaime Casanova wrote:
> /usr/bin/ld: skipping incompatible /usr/pgsql-9.0/lib//libpgport.a
> when searching for -lpgport
> /usr/bin/ld: skipping incompatible /usr/pgsql-9.0/lib//libpgport.a
> when searching for -lpgport
> /usr/bin/ld: cannot find -lpgport


Could this be a 32 bit vs 64 bit issue?  Is your pg 9 RPM 64 or 32 bits?




From jaime at 2ndquadrant.com  Wed Nov 17 13:32:32 2010
From: jaime at 2ndquadrant.com (Jaime Casanova)
Date: Wed, 17 Nov 2010 16:32:32 -0500
Subject: [Slony1-general] postgres 8.4 supported by slony 1.2.21?
In-Reply-To: <4CE43AEF.5030204@ca.afilias.info>
References: <AANLkTik8zaf8YK-_QNHwhva7i1mupzgx=Oyraw__LM0j@mail.gmail.com>
	<AANLkTimBSrgF7DPdf32T3o_R89Z3U1SJ3pHOS9vR=xeW@mail.gmail.com>
	<4CE3FDB9.3000400@ca.afilias.info>
	<AANLkTinThG9Kp9c0fug8PFuBdjaMiDkFJmCV02wk6whC@mail.gmail.com>
	<4CE43AEF.5030204@ca.afilias.info>
Message-ID: <AANLkTi=82DGdYJYjNT=MK43AN6Eds-j9kfr8bJ+KYhOH@mail.gmail.com>

On Wed, Nov 17, 2010 at 3:28 PM, Steve Singer <ssinger at ca.afilias.info> wrote:
> On 10-11-17 03:14 PM, Jaime Casanova wrote:
>> /usr/bin/ld: skipping incompatible /usr/pgsql-9.0/lib//libpgport.a
>> when searching for -lpgport
>> /usr/bin/ld: skipping incompatible /usr/pgsql-9.0/lib//libpgport.a
>> when searching for -lpgport
>> /usr/bin/ld: cannot find -lpgport
>
>
> Could this be a 32 bit vs 64 bit issue? ?Is your pg 9 RPM 64 or 32 bits?
>

mmm... it's a 64bits one...

looking at what gets installed i get this (all from 9.0.1-4PGDG.rhel5  pgdg90):

pg_top90                                   x86_64
postgresql90                               x86_64
 postgresql90-contrib                       x86_64
 postgresql90-devel                         i386
 postgresql90-devel                         x86_64
 postgresql90-plperl                        x86_64
 postgresql90-server                        x86_64
Installing for dependencies:
 compat-postgresql-libs                     x86_64
 postgresql90-libs                          i386
 postgresql90-libs                          x86_64


so, there are 32bits libraries in there right? but also 64bit's

-- 
Jaime Casanova? ? ? ?? www.2ndQuadrant.com
Professional PostgreSQL: Soporte y capacitaci?n de PostgreSQL

From cbbrowne at ca.afilias.info  Wed Nov 17 14:06:08 2010
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Wed, 17 Nov 2010 17:06:08 -0500
Subject: [Slony1-general] Enhancement Proposal: Automatic WAIT FOR EVENT
Message-ID: <87pqu3r4fj.fsf@cbbrowne.afilias-int.info>

A thing that several of us have been ruminating over for a while is the
problem that people get confused about how you submit Slonik scripts,
you may have some actions that require waits.

For instance if it takes 20 minutes for SUBSCRIBE SET to complete, it's
pretty likely that you want to wait for that to be complete before
proceeding with other configuration that depends on it.

That is already supported today, after a fashion - you 'merely' need to
sprinkle your Slonik script with WAIT FOR EVENT requests.

But the word 'merely' seems unfair; it is rarely particularly obvious
what semantics are appropriate.  (It is frequently not obvious to me,
and I have touched a lot of the Slony codebase!)

The "obvious" thought which has occurred is to have Slonik commands
automatically wait for the appropriate events.  In effect, we'd go thru
each Slonik command, and have it automatically call slonik_wait_event()
(found in src/slonik/slonik.c), or some refactoring thereof.

A few questions and issues occur to me...

1.  Does this seem like a worthwhile exercise?  (Alternatively...  Are
there other Much Bigger Issues that should be looked at first?)

2.  This obviously requires going through and determining a reasonable
default "wait policy" for each of the Slonik commands.

It's not a huge list:
  <http://slony.info/documentation/2.0/cmds.html>

Presumably we could analyze this in a tabular fashion:
create table wait_policy (tabname text, origin text, confirmed text,
wait_on text);

foo at localhost->  select * from wait_policy ;
    tabname    |   origin   | confirmed  |  wait_on
---------------+------------+------------+------------
 echo          | none       | none       | none
 exit          | none       | none       | none
 init cluster  | none       | none       | none
 store node    | none       | none       | none
 drop node     | event node | event node | event node
 subscribe set | provider   | receiver   | receiver
(6 rows)

Which obviously needs to get extended a bit :-).

Some of these may need some more functionality - SUBSCRIBE SET generates
a pair of events so that it may be necessary to wait for a subsequent
event, and perhaps to request synthesizing a SYNC, and waiting for
*that*.

Complications are a given, but it seems reasonable to list everything,
handle the simple items simply, and list (and handle) the complications.

3.  How to integrate this in?

It seems to me we'd take whatever falls from #2, and make sure there is
a wait_for_whatever_needs_waiting() function (and possibly helpers) so
that implementation can frequently amount to adding a single line of
code to the functions in src/slonik/slonik.c that implement the Slonik
commands.

As already mentioned, there may be some complications, and hence some
extra functions to help handle the "uglier" scenarios.

4.  Do we want overrides?

Perhaps some might want the ability to revert to today's functionality,
so one can run a "fire and forget" series of SUBSCRIBE SET requests.

I think this could be handled by adding an extra option to Slonik
commands, to suppress waiting:
   NOWAIT

Thus...

   subscribe set (id=1,provider=3,subscriber=4,forward=yes,nowait);

5.  One might go further down the path of #4, and have a series of
options:

  -- Default behaviour:
  drop set(id=3, origin=4);
  -- Also default behaviour, which makes this option pretty worthless
  drop set(id=3, origin=4, wait policy=default);
  -- More complex, and possibly frivolous
  drop set(id=3, origin=4, wait origin=3,wait confirm=4,wait on=1,
           timeout=300);

6.  Do we possibly need for there to be a way to force aborting a script
if the WAIT times out?

   This presumably means Still More Options added to Slonik commands.
   That's not notably horrible - the logic for processing the abort only
   need be written once.

7.  I think this invalidates TRY { } ON ERROR { } ON SUCCESS { }
    handling, for the most part.

    At the very least, if we're waiting for things to succeed on a
    remote node, it invalidates the notion that we're performing the
    contents of the TRY block as a single transaction on the initial
    node.

    It's not particularly obvious how TRY requests get grouped into a
    single "transaction" anyways.  Perhaps this points at there being
    something invalid/broken about TRY.

8.  This is possibly not totally friendly towards tools like pgAdmin,
    which, I think, presently take the approach that all you need do to
    configure Slony clusters is to call the stored functions.

    But perhaps I'm tilting at a windmill here.
-- 
let name="cbbrowne" and tld="afilias.info" in name ^ "@" ^ tld;;
Christopher Browne
"Bother,"  said Pooh,  "Eeyore, ready  two photon  torpedoes  and lock
phasers on the Heffalump, Piglet, meet me in transporter room three"

From devrim at gunduz.org  Wed Nov 17 15:25:17 2010
From: devrim at gunduz.org (Devrim =?ISO-8859-1?Q?G=DCND=DCZ?=)
Date: Thu, 18 Nov 2010 01:25:17 +0200
Subject: [Slony1-general] postgres 8.4 supported by slony 1.2.21?
In-Reply-To: <AANLkTinThG9Kp9c0fug8PFuBdjaMiDkFJmCV02wk6whC@mail.gmail.com>
References: <AANLkTik8zaf8YK-_QNHwhva7i1mupzgx=Oyraw__LM0j@mail.gmail.com>
	<AANLkTimBSrgF7DPdf32T3o_R89Z3U1SJ3pHOS9vR=xeW@mail.gmail.com>
	<4CE3FDB9.3000400@ca.afilias.info>
	<AANLkTinThG9Kp9c0fug8PFuBdjaMiDkFJmCV02wk6whC@mail.gmail.com>
Message-ID: <1290036317.7107.14.camel@hp-laptop02.gunduz.org>

On Wed, 2010-11-17 at 15:14 -0500, Jaime Casanova wrote:
> 
> 
> mmm... well, i have postgresql 9.0.1 installed on a node (this was
> installed via the yum repository) and because the repo have 2.0.4 and
> i don't want to kill my existing slony installation so i'm compiling
> 1.2.21 and get this error: 

Cannot duplicate this on my F-13 and RHEL-5 boxes, both on 1.2.21 and
2.0.5. I remember to have seen it before, but I fixed is somehow in
RPMs, but I don't remember how :) Probably it was a packaging error. 

Regards,
-- 
Devrim G?ND?Z
PostgreSQL Dan??man?/Consultant, Red Hat Certified Engineer
PostgreSQL RPM Repository: http://yum.pgrpms.org
Community: devrim~PostgreSQL.org, devrim.gunduz~linux.org.tr
http://www.gunduz.org  Twitter: http://twitter.com/devrimgunduz
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 198 bytes
Desc: This is a digitally signed message part
Url : http://lists.slony.info/pipermail/slony1-general/attachments/20101118/4fb3fe54/attachment.pgp 

From P.Tecza at icm.edu.pl  Thu Nov 18 03:19:28 2010
From: P.Tecza at icm.edu.pl (=?UTF-8?Q?Pawe=C5=82_T=C4=99cza?=)
Date: Thu, 18 Nov 2010 12:19:28 +0100
Subject: [Slony1-general] Replicating 2 databases from 1 server
Message-ID: <1290079168.4323.30.camel@localhost>

Hello All,

I have a following scenario: there are 2 Debian Lenny boxes with
Postgres 8.3. The first of them (say hostM) is a master and second (say
hostS) is a backup (slave). I would like to replicate 2 databases (say
db1 and db2) from hostM to hostS using Slony-I 1.2.15. I hope it's
rather standard case :)

What configuration method of Slony-I is better for my scenario? By hand
(it means using slonik command directly) or Perl tools? Is it possible
to use only one /etc/slony1/slon_tools.conf to setup replication for 2
different databases if I'll choose Perl tools? Maybe I should have 2
separated slon_tools.conf files for them? 

All your comments are welcome :D 

My best regards,
Pawel Tecza


From jaime at 2ndquadrant.com  Thu Nov 18 04:55:25 2010
From: jaime at 2ndquadrant.com (Jaime Casanova)
Date: Thu, 18 Nov 2010 07:55:25 -0500
Subject: [Slony1-general] postgres 8.4 supported by slony 1.2.21?
In-Reply-To: <1290036317.7107.14.camel@hp-laptop02.gunduz.org>
References: <AANLkTik8zaf8YK-_QNHwhva7i1mupzgx=Oyraw__LM0j@mail.gmail.com>
	<AANLkTimBSrgF7DPdf32T3o_R89Z3U1SJ3pHOS9vR=xeW@mail.gmail.com>
	<4CE3FDB9.3000400@ca.afilias.info>
	<AANLkTinThG9Kp9c0fug8PFuBdjaMiDkFJmCV02wk6whC@mail.gmail.com>
	<1290036317.7107.14.camel@hp-laptop02.gunduz.org>
Message-ID: <AANLkTikjnb=0C1TgMC0NvkOfkHFRnfYOPLtRb0fqX5ev@mail.gmail.com>

2010/11/17 Devrim G?ND?Z <devrim at gunduz.org>:
> On Wed, 2010-11-17 at 15:14 -0500, Jaime Casanova wrote:
>>
>>
>> mmm... well, i have postgresql 9.0.1 installed on a node (this was
>> installed via the yum repository) and because the repo have 2.0.4 and
>> i don't want to kill my existing slony installation so i'm compiling
>> 1.2.21 and get this error:
>
> Cannot duplicate this on my F-13 and RHEL-5 boxes, both on 1.2.21 and
> 2.0.5. I remember to have seen it before, but I fixed is somehow in
> RPMs, but I don't remember how :) Probably it was a packaging error.
>

what i did to solve this...

download pg 9 sources and recompile using pg_config --configure
installed by pgdg repo (hope that put things in the same place and
that yum doesn't get confused if i try to remove)


-- 
Jaime Casanova? ? ? ?? www.2ndQuadrant.com
Professional PostgreSQL: Soporte y capacitaci?n de PostgreSQL

From jaime at 2ndquadrant.com  Thu Nov 18 05:11:19 2010
From: jaime at 2ndquadrant.com (Jaime Casanova)
Date: Thu, 18 Nov 2010 08:11:19 -0500
Subject: [Slony1-general] postgres 8.4 supported by slony 1.2.21?
In-Reply-To: <AANLkTinThG9Kp9c0fug8PFuBdjaMiDkFJmCV02wk6whC@mail.gmail.com>
References: <AANLkTik8zaf8YK-_QNHwhva7i1mupzgx=Oyraw__LM0j@mail.gmail.com>
	<AANLkTimBSrgF7DPdf32T3o_R89Z3U1SJ3pHOS9vR=xeW@mail.gmail.com>
	<4CE3FDB9.3000400@ca.afilias.info>
	<AANLkTinThG9Kp9c0fug8PFuBdjaMiDkFJmCV02wk6whC@mail.gmail.com>
Message-ID: <AANLkTimDx0P+GXEaKPnEG8GdGeTNgGvAr=ytpTAdZH5R@mail.gmail.com>

On Wed, Nov 17, 2010 at 3:14 PM, Jaime Casanova <jaime at 2ndquadrant.com> wrote:
> On Wed, Nov 17, 2010 at 11:07 AM, Steve Singer <ssinger at ca.afilias.info> wrote:
>>
>> Other than that I am not aware of any issues 1.2 will have with 9.0. ?I
>> haven't done much testing of 1.2 with 9.0 (have others?) but while I was
>> testing 2.0.x against 9.0 betas I don't recall seeing anything that
>> needed back-porting.
>>
>>
>
> mmm... well, i have postgresql 9.0.1 installed on a node (this was
> installed via the yum repository) and because the repo have 2.0.4 and
> i don't want to kill my existing slony installation so i'm compiling
> 1.2.21 and get this error:
>

once i solved this, i encounter another problem when trying to store
the node with 9.0... it told me that it can't open the xxid.v84.sql
file... i think that datatype isn't used anymore so it shouldn't be
looking for that file at al... right?

-- 
Jaime Casanova? ? ? ?? www.2ndQuadrant.com
Professional PostgreSQL: Soporte y capacitaci?n de PostgreSQL

From ssinger at ca.afilias.info  Thu Nov 18 05:52:04 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Thu, 18 Nov 2010 08:52:04 -0500
Subject: [Slony1-general] postgres 8.4 supported by slony 1.2.21?
In-Reply-To: <AANLkTimDx0P+GXEaKPnEG8GdGeTNgGvAr=ytpTAdZH5R@mail.gmail.com>
References: <AANLkTik8zaf8YK-_QNHwhva7i1mupzgx=Oyraw__LM0j@mail.gmail.com>
	<AANLkTimBSrgF7DPdf32T3o_R89Z3U1SJ3pHOS9vR=xeW@mail.gmail.com>
	<4CE3FDB9.3000400@ca.afilias.info>
	<AANLkTinThG9Kp9c0fug8PFuBdjaMiDkFJmCV02wk6whC@mail.gmail.com>
	<AANLkTimDx0P+GXEaKPnEG8GdGeTNgGvAr=ytpTAdZH5R@mail.gmail.com>
Message-ID: <4CE52F84.1020502@ca.afilias.info>

On 10-11-18 08:11 AM, Jaime Casanova wrote:
> On Wed, Nov 17, 2010 at 3:14 PM, Jaime Casanova<jaime at 2ndquadrant.com>  wrote:
>> On Wed, Nov 17, 2010 at 11:07 AM, Steve Singer<ssinger at ca.afilias.info>  wrote:
>>>
>>> Other than that I am not aware of any issues 1.2 will have with 9.0.  I
>>> haven't done much testing of 1.2 with 9.0 (have others?) but while I was
>>> testing 2.0.x against 9.0 betas I don't recall seeing anything that
>>> needed back-porting.
>>>
>>>
>>
>> mmm... well, i have postgresql 9.0.1 installed on a node (this was
>> installed via the yum repository) and because the repo have 2.0.4 and
>> i don't want to kill my existing slony installation so i'm compiling
>> 1.2.21 and get this error:
>>
>
> once i solved this, i encounter another problem when trying to store
> the node with 9.0... it told me that it can't open the xxid.v84.sql
> file... i think that datatype isn't used anymore so it shouldn't be
> looking for that file at al... right?
>

This is with the tip of REL_1_2_STABLE right?

1.2 still uses xxid, (2.0 does not).

That change to add 8.4/9.0 compatibility is missing somethings (a copy 
of the xxid.v84.sql).

I propose the following patch for 1.2


-------------- next part --------------
A non-text attachment was scrubbed...
Name: 0001-Adding-.sql-files-for-.v84.patch
Type: text/x-patch
Size: 0 bytes
Desc: not available
Url : http://lists.slony.info/pipermail/slony1-general/attachments/20101118/ccbf8242/attachment.bin 

From ssinger at ca.afilias.info  Thu Nov 18 05:46:27 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Thu, 18 Nov 2010 08:46:27 -0500
Subject: [PATCH] Adding .sql files for .v84
 commit 0d1781229fd3cc6a2abac083174166945d08ed7f  did not
 update xxid and introduce a 1.2 base_funcs file for v.84
 even thought it brought over a 8.4 compatibility mode
Message-ID: <mailman.2.1290088337.4947.slony1-general@lists.slony.info>

---
 src/backend/Makefile            |    7 ++-
 src/backend/slony1_base.v84.sql |   12 +++
 src/xxid/Makefile               |    3 +-
 src/xxid/xxid.v84.sql           |  185 +++++++++++++++++++++++++++++++++++++++
 4 files changed, 205 insertions(+), 2 deletions(-)
 create mode 100644 src/backend/slony1_base.v84.sql
 create mode 100644 src/xxid/xxid.v84.sql

diff --git a/src/backend/Makefile b/src/backend/Makefile
index 053b9f5..8b14eb3 100644
--- a/src/backend/Makefile
+++ b/src/backend/Makefile
@@ -31,6 +31,9 @@ FUNCS_80		= slony1_funcs.v80.sql
 BASE_81			= slony1_base.v81.sql
 FUNCS_81		= slony1_funcs.v81.sql
 
+BASE_84			= slony1_base.v84.sql
+FUNCS_84		= slony1_funcs.v84.sql
+
 SQL_NAMES =				\
 	$(BASE_COMMON)		\
 	$(FUNCS_COMMON)		\
@@ -39,7 +42,9 @@ SQL_NAMES =				\
 	$(BASE_80)			\
 	$(FUNCS_80)			\
 	$(BASE_81)			\
-	$(FUNCS_81)
+	$(FUNCS_81) \
+	$(BASE_84) \
+	$(FUNCS_84)
 
 DISTFILES = Makefile README README.events $(wildcard *.sql) $(wildcard *.in) $(wildcard *.c)
 
diff --git a/src/backend/slony1_base.v84.sql b/src/backend/slony1_base.v84.sql
new file mode 100644
index 0000000..0ccb1c1
--- /dev/null
+++ b/src/backend/slony1_base.v84.sql
@@ -0,0 +1,12 @@
+-- ----------------------------------------------------------------------
+-- slony1_base.v84.sql
+--
+--    Version 8.4 specific parts of the basic replication schema.
+--
+--	Copyright (c) 2003-2009, PostgreSQL Global Development Group
+--	Author: Jan Wieck, Afilias USA INC.
+--
+-- 
+-- ----------------------------------------------------------------------
+
+
diff --git a/src/xxid/Makefile b/src/xxid/Makefile
index f6be086..49b2a11 100644
--- a/src/xxid/Makefile
+++ b/src/xxid/Makefile
@@ -20,7 +20,8 @@ NAME		= xxid
 SQL_NAME74	= $(NAME).v74.sql
 SQL_NAME80	= $(NAME).v80.sql
 SQL_NAME81	= $(NAME).v81.sql
-SQL_NAMES	= $(SQL_NAME74) $(SQL_NAME80) $(SQL_NAME81)
+SQL_NAME84  = $(NAME).v84.sql
+SQL_NAMES	= $(SQL_NAME74) $(SQL_NAME80) $(SQL_NAME81) $(SQL_NAME84)
 GENSQLNAMES = $(filter-out $(SQL_NAME74), $(SQL_NAMES))
 
 SO_OBJS		= xxid.o $(WIN32RES)
diff --git a/src/xxid/xxid.v84.sql b/src/xxid/xxid.v84.sql
new file mode 100644
index 0000000..653c036
--- /dev/null
+++ b/src/xxid/xxid.v84.sql
@@ -0,0 +1,185 @@
+-- ----------
+-- xxid.v74.sql.in
+--
+--	SQL script for loading the transaction ID compatible datatype 
+--
+--	Copyright (c) 2003-2009, PostgreSQL Global Development Group
+--	Author: Jan Wieck, Afilias USA INC.
+--
+-- 
+-- ----------
+
+--
+-- Type specific input and output functions
+--
+CREATE FUNCTION @NAMESPACE at ."xxidin"(cstring) RETURNS @NAMESPACE at ."xxid"
+	AS '$libdir/xxid', '_Slony_I_xxidin'
+	LANGUAGE C STRICT;
+CREATE FUNCTION @NAMESPACE at ."xxidout"(@NAMESPACE at ."xxid") RETURNS cstring
+	AS '$libdir/xxid', '_Slony_I_xxidout'
+	LANGUAGE C STRICT;
+
+
+--
+-- The data type itself
+--
+CREATE TYPE @NAMESPACE at ."xxid" (
+	INPUT = @NAMESPACE at ."xxidin",
+	OUTPUT = @NAMESPACE at ."xxidout",
+	EXTERNALLENGTH = 12,
+	INTERNALLENGTH = 4,
+	PASSEDBYVALUE,
+	ALIGNMENT = int4
+);
+
+
+--
+-- Since our xxid type has special cases for values 0-3, it
+-- in fact IS xid, so allow implicit type casting to and from.
+--
+CREATE CAST (xid AS @NAMESPACE at .xxid)
+	WITHOUT FUNCTION AS IMPLICIT;
+CREATE CAST (@NAMESPACE at .xxid AS xid)
+	WITHOUT FUNCTION AS IMPLICIT;
+
+
+--
+-- Comparision functions for the new datatype
+--
+CREATE FUNCTION @NAMESPACE at ."xxideq"(@NAMESPACE at ."xxid", @NAMESPACE at ."xxid") RETURNS boolean
+	AS '$libdir/xxid', '_Slony_I_xxideq'
+	LANGUAGE C;
+CREATE FUNCTION @NAMESPACE at ."xxidne"(@NAMESPACE at ."xxid", @NAMESPACE at ."xxid") RETURNS boolean
+	AS '$libdir/xxid', '_Slony_I_xxidne'
+	LANGUAGE C;
+CREATE FUNCTION @NAMESPACE at ."xxidlt"(@NAMESPACE at ."xxid", @NAMESPACE at ."xxid") RETURNS boolean
+	AS '$libdir/xxid', '_Slony_I_xxidlt'
+	LANGUAGE C;
+CREATE FUNCTION @NAMESPACE at ."xxidle"(@NAMESPACE at ."xxid", @NAMESPACE at ."xxid") RETURNS boolean
+	AS '$libdir/xxid', '_Slony_I_xxidle'
+	LANGUAGE C;
+CREATE FUNCTION @NAMESPACE at ."xxidgt"(@NAMESPACE at ."xxid", @NAMESPACE at ."xxid") RETURNS boolean
+	AS '$libdir/xxid', '_Slony_I_xxidgt'
+	LANGUAGE C;
+CREATE FUNCTION @NAMESPACE at ."xxidge"(@NAMESPACE at ."xxid", @NAMESPACE at ."xxid") RETURNS boolean
+	AS '$libdir/xxid', '_Slony_I_xxidge'
+	LANGUAGE C;
+CREATE FUNCTION @NAMESPACE at ."btxxidcmp"(@NAMESPACE at ."xxid", @NAMESPACE at ."xxid") RETURNS int4
+	AS '$libdir/xxid', '_Slony_I_btxxidcmp'
+	LANGUAGE C;
+CREATE FUNCTION @NAMESPACE at .getCurrentXid() RETURNS @NAMESPACE at ."xxid"
+	AS '$libdir/xxid', '_Slony_I_getCurrentXid'
+	LANGUAGE C;
+CREATE FUNCTION @NAMESPACE at .getMinXid() RETURNS @NAMESPACE at ."xxid"
+	AS '$libdir/xxid', '_Slony_I_getMinXid'
+	LANGUAGE C;
+CREATE FUNCTION @NAMESPACE at .getMaxXid() RETURNS @NAMESPACE at ."xxid"
+	AS '$libdir/xxid', '_Slony_I_getMaxXid'
+	LANGUAGE C;
+
+
+--
+-- Operators on these comparision functions
+--
+CREATE OPERATOR < (
+	PROCEDURE = @NAMESPACE at ."xxidlt",
+	LEFTARG = @NAMESPACE at ."xxid",
+	RIGHTARG = @NAMESPACE at ."xxid",
+	COMMUTATOR = >, NEGATOR = >=,
+	RESTRICT = scalarltsel, JOIN = scalarltjoinsel
+);
+CREATE OPERATOR = (
+	PROCEDURE = @NAMESPACE at ."xxideq",
+	LEFTARG = @NAMESPACE at ."xxid",
+	RIGHTARG = @NAMESPACE at ."xxid",
+	COMMUTATOR = =, NEGATOR = <>,
+	RESTRICT = eqsel, JOIN = eqjoinsel,
+	SORT1 = <, SORT2 = <
+);
+CREATE OPERATOR <> (
+	PROCEDURE = @NAMESPACE at ."xxidne",
+	LEFTARG = @NAMESPACE at ."xxid",
+	RIGHTARG = @NAMESPACE at ."xxid",
+	COMMUTATOR = <>, NEGATOR = =,
+	RESTRICT = neqsel, JOIN = neqjoinsel
+);
+CREATE OPERATOR > (
+	PROCEDURE = @NAMESPACE at ."xxidgt",
+	LEFTARG = @NAMESPACE at ."xxid",
+	RIGHTARG = @NAMESPACE at ."xxid",
+	COMMUTATOR = <, NEGATOR = <=,
+	RESTRICT = scalargtsel, JOIN = scalargtjoinsel
+);
+CREATE OPERATOR <= (
+	PROCEDURE = @NAMESPACE at ."xxidle",
+	LEFTARG = @NAMESPACE at ."xxid",
+	RIGHTARG = @NAMESPACE at ."xxid",
+	COMMUTATOR = >=, NEGATOR = >,
+	RESTRICT = scalarltsel, JOIN = scalarltjoinsel
+);
+CREATE OPERATOR >= (
+	PROCEDURE = @NAMESPACE at ."xxidge",
+	LEFTARG = @NAMESPACE at ."xxid",
+	RIGHTARG = @NAMESPACE at ."xxid",
+	COMMUTATOR = <=, NEGATOR = <,
+	RESTRICT = scalargtsel, JOIN = scalargtjoinsel
+);
+
+
+--
+-- Finally the default operator class so that we can use our
+-- new data type in btree indexes.
+--
+CREATE OPERATOR CLASS @NAMESPACE at ."xxid_ops"
+	DEFAULT FOR TYPE @NAMESPACE at ."xxid" USING btree AS
+	OPERATOR 1 <  (@NAMESPACE at ."xxid", @NAMESPACE at ."xxid"),
+	OPERATOR 2 <= (@NAMESPACE at ."xxid", @NAMESPACE at ."xxid"),
+	OPERATOR 3 =  (@NAMESPACE at ."xxid", @NAMESPACE at ."xxid"),
+	OPERATOR 4 >= (@NAMESPACE at ."xxid", @NAMESPACE at ."xxid"),
+	OPERATOR 5 >  (@NAMESPACE at ."xxid", @NAMESPACE at ."xxid"),
+	FUNCTION 1 @NAMESPACE at ."btxxidcmp" (@NAMESPACE at ."xxid", @NAMESPACE at ."xxid");
+
+
+--
+-- A special transaction snapshot data type for faster visibility checks
+--
+CREATE FUNCTION @NAMESPACE at ."xxid_snapshot_in"(cstring)
+RETURNS @NAMESPACE at ."xxid_snapshot"
+	AS '$libdir/xxid', '_Slony_I_xxid_snapshot_in'
+	LANGUAGE C STRICT;
+CREATE FUNCTION @NAMESPACE at ."xxid_snapshot_out"(@NAMESPACE at ."xxid_snapshot")
+RETURNS cstring
+	AS '$libdir/xxid', '_Slony_I_xxid_snapshot_out'
+	LANGUAGE C STRICT;
+
+
+--
+-- The data type itself
+--
+CREATE TYPE @NAMESPACE at ."xxid_snapshot" (
+	INPUT = @NAMESPACE at ."xxid_snapshot_in",
+	OUTPUT = @NAMESPACE at ."xxid_snapshot_out",
+	INTERNALLENGTH = variable,
+	ALIGNMENT = int4
+);
+
+
+--
+-- Special comparision functions used by the remote worker
+-- for sync chunk selection
+--
+CREATE FUNCTION @NAMESPACE at ."xxid_lt_snapshot"(
+		@NAMESPACE at ."xxid",
+		@NAMESPACE at ."xxid_snapshot")
+RETURNS boolean
+	AS '$libdir/xxid', '_Slony_I_xxid_lt_snapshot'
+	LANGUAGE C;
+
+CREATE FUNCTION @NAMESPACE at ."xxid_ge_snapshot"(
+		@NAMESPACE at ."xxid",
+		@NAMESPACE at ."xxid_snapshot")
+RETURNS boolean
+	AS '$libdir/xxid', '_Slony_I_xxid_ge_snapshot'
+	LANGUAGE C;
+
+
-- 
1.7.0.4


--------------010800000900040405030100--

From vivek at khera.org  Thu Nov 18 05:53:44 2010
From: vivek at khera.org (Vick Khera)
Date: Thu, 18 Nov 2010 08:53:44 -0500
Subject: [Slony1-general] Enhancement Proposal: Automatic WAIT FOR EVENT
In-Reply-To: <87pqu3r4fj.fsf@cbbrowne.afilias-int.info>
References: <87pqu3r4fj.fsf@cbbrowne.afilias-int.info>
Message-ID: <AANLkTinbG0B__OunPuXPfJ_uq2SAq=pYnio0V40oB_Dv@mail.gmail.com>

On Wed, Nov 17, 2010 at 5:06 PM, Christopher Browne
<cbbrowne at ca.afilias.info> wrote:
> For instance if it takes 20 minutes for SUBSCRIBE SET to complete, it's
> pretty likely that you want to wait for that to be complete before
> proceeding with other configuration that depends on it.
>

None of my scripts ever have a WAIT in them.  I break up my scripts to
be pretty atomic, and I rarely do anything after the subscribe except
sit and wait hours for the copy to happen.

The one thing I'd like to have is a warning when issuing shape
changing commands such as move set if the backlog of events is very
high (say, more than 5 or 10).  On occasion, I've forgotten to check
and issued the move when there was a 10 minute backlog.  I ended up
waiting that out, but it was tense. ;)

From ssinger at ca.afilias.info  Thu Nov 18 06:21:55 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Thu, 18 Nov 2010 09:21:55 -0500
Subject: [Slony1-general] postgres 8.4 supported by slony 1.2.21?
In-Reply-To: <4CE52F84.1020502@ca.afilias.info>
References: <AANLkTik8zaf8YK-_QNHwhva7i1mupzgx=Oyraw__LM0j@mail.gmail.com>	<AANLkTimBSrgF7DPdf32T3o_R89Z3U1SJ3pHOS9vR=xeW@mail.gmail.com>	<4CE3FDB9.3000400@ca.afilias.info>	<AANLkTinThG9Kp9c0fug8PFuBdjaMiDkFJmCV02wk6whC@mail.gmail.com>	<AANLkTimDx0P+GXEaKPnEG8GdGeTNgGvAr=ytpTAdZH5R@mail.gmail.com>
	<4CE52F84.1020502@ca.afilias.info>
Message-ID: <4CE53683.1000507@ca.afilias.info>

On 10-11-18 08:52 AM, Steve Singer wrote:
>
> This is with the tip of REL_1_2_STABLE right?
>
> 1.2 still uses xxid, (2.0 does not).
>
> That change to add 8.4/9.0 compatibility is missing somethings (a copy
> of the xxid.v84.sql).
>
> I propose the following patch for 1.2

I should point out that I'm noticing this message when I run 1.2 + this 
patch against 9.0

WARNING:  type attribute "externallength" not recognized

I have not seen this running 2.0.5 against 9.0.  At this point I can't 
say where it comes from or what it means.


>
>
>
>
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


From jaime at 2ndquadrant.com  Thu Nov 18 06:31:09 2010
From: jaime at 2ndquadrant.com (Jaime Casanova)
Date: Thu, 18 Nov 2010 09:31:09 -0500
Subject: [Slony1-general] postgres 8.4 supported by slony 1.2.21?
In-Reply-To: <4CE52F84.1020502@ca.afilias.info>
References: <AANLkTik8zaf8YK-_QNHwhva7i1mupzgx=Oyraw__LM0j@mail.gmail.com>
	<AANLkTimBSrgF7DPdf32T3o_R89Z3U1SJ3pHOS9vR=xeW@mail.gmail.com>
	<4CE3FDB9.3000400@ca.afilias.info>
	<AANLkTinThG9Kp9c0fug8PFuBdjaMiDkFJmCV02wk6whC@mail.gmail.com>
	<AANLkTimDx0P+GXEaKPnEG8GdGeTNgGvAr=ytpTAdZH5R@mail.gmail.com>
	<4CE52F84.1020502@ca.afilias.info>
Message-ID: <AANLkTi=StuSmrYtMfyHqx3u1JWuNt0XELu=cQOuww0wa@mail.gmail.com>

On Thu, Nov 18, 2010 at 8:52 AM, Steve Singer <ssinger at ca.afilias.info> wrote:
>
> That change to add 8.4/9.0 compatibility is missing somethings (a copy of
> the xxid.v84.sql).
>
> I propose the following patch for 1.2
>

xxid.v84.sql is based on xxid.v81.sql, right?
i hope because that was what i did :D

only the makefile changes i didn't i just copied the files manually,
so i think that should work...

i will confirm later, thanks

-- 
Jaime Casanova? ? ? ?? www.2ndQuadrant.com
Professional PostgreSQL: Soporte y capacitaci?n de PostgreSQL

From ssinger at ca.afilias.info  Thu Nov 18 06:32:36 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Thu, 18 Nov 2010 09:32:36 -0500
Subject: [Slony1-general] postgres 8.4 supported by slony 1.2.21?
In-Reply-To: <AANLkTi=StuSmrYtMfyHqx3u1JWuNt0XELu=cQOuww0wa@mail.gmail.com>
References: <AANLkTik8zaf8YK-_QNHwhva7i1mupzgx=Oyraw__LM0j@mail.gmail.com>
	<AANLkTimBSrgF7DPdf32T3o_R89Z3U1SJ3pHOS9vR=xeW@mail.gmail.com>
	<4CE3FDB9.3000400@ca.afilias.info>
	<AANLkTinThG9Kp9c0fug8PFuBdjaMiDkFJmCV02wk6whC@mail.gmail.com>
	<AANLkTimDx0P+GXEaKPnEG8GdGeTNgGvAr=ytpTAdZH5R@mail.gmail.com>
	<4CE52F84.1020502@ca.afilias.info>
	<AANLkTi=StuSmrYtMfyHqx3u1JWuNt0XELu=cQOuww0wa@mail.gmail.com>
Message-ID: <4CE53904.3060000@ca.afilias.info>

On 10-11-18 09:31 AM, Jaime Casanova wrote:
> On Thu, Nov 18, 2010 at 8:52 AM, Steve Singer<ssinger at ca.afilias.info>  wrote:
>>
>> That change to add 8.4/9.0 compatibility is missing somethings (a copy of
>> the xxid.v84.sql).
>>
>> I propose the following patch for 1.2
>>
>
> xxid.v84.sql is based on xxid.v81.sql, right?
> i hope because that was what i did :D
>
> only the makefile changes i didn't i just copied the files manually,
> so i think that should work...
>
> i will confirm later, thanks
>

Yes I just copied it as well.


From cbbrowne at ca.afilias.info  Thu Nov 18 08:32:16 2010
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Thu, 18 Nov 2010 11:32:16 -0500
Subject: [Slony1-general] Slonik Awareness of Cluster State (was Automatic
	WAIT FOR EVENT)
In-Reply-To: <AANLkTinbG0B__OunPuXPfJ_uq2SAq=pYnio0V40oB_Dv@mail.gmail.com>
	(Vick Khera's message of "Thu, 18 Nov 2010 08:53:44 -0500")
References: <87pqu3r4fj.fsf@cbbrowne.afilias-int.info>
	<AANLkTinbG0B__OunPuXPfJ_uq2SAq=pYnio0V40oB_Dv@mail.gmail.com>
Message-ID: <87lj4qr3sf.fsf_-_@cbbrowne.afilias-int.info>

Vick Khera <vivek at khera.org> writes:
> On Wed, Nov 17, 2010 at 5:06 PM, Christopher Browne
> <cbbrowne at ca.afilias.info> wrote:
>> For instance if it takes 20 minutes for SUBSCRIBE SET to complete, it's
>> pretty likely that you want to wait for that to be complete before
>> proceeding with other configuration that depends on it.
>
> None of my scripts ever have a WAIT in them.  I break up my scripts to
> be pretty atomic, and I rarely do anything after the subscribe except
> sit and wait hours for the copy to happen.
>
> The one thing I'd like to have is a warning when issuing shape
> changing commands such as move set if the backlog of events is very
> high (say, more than 5 or 10).  On occasion, I've forgotten to check
> and issued the move when there was a 10 minute backlog.  I ended up
> waiting that out, but it was tense. ;)

Interesting.

That suggests to me there being some value to having some sort of "fail
if not sufficiently up to date" command.

Perhaps something like:

try {
   ABORT (origin=1, confirmed=2, events behind=10);
} on error {
   echo 'Node 2 behind node 1 by more than 10 events - aborting!';
   exit -1;
} on success {
   echo 'Node 2 sufficiently up to date';
}

Or

try {
   ABORT (origin=1, confirmed=2, events behind by='30 seconds');
} on error {
   echo 'Node 2 behind node 1 by more than 30 seconds - aborting!';
   exit -1;
} on success {
   echo 'Node 2 sufficiently up to date';
}

That seems likely to be an easy addition, and possibly quite handy.

That's pretty specific to "replication being behind" - a different
flavour of useful might be to have have a series of "fail if condition
not met" evaluators to check things like:

  - Is a node there?
  - Is a replication set there?
  - Is a particular subscription configured?
  - Run a bit of SQL, and fail if it errors out.
  - Has a node successfully processed events within [time interval]?
  - Is a node presently processing a particular event?

That last item is suggestive of another branch in the whole "stream of
consciousness"...

It sure would be nice if each slon would note somewhere, in a way that
can be queried by others, what it's working on.  That would be useful
for the common scenario we have where beginners (and sometimes even
experienced folk!) say "I don't quite know if replication is working.
How can I find that out???"

BTW, the larger goal here isn't merely to draw out how we might handle
an "implicit WAIT FOR EVENT" - we (where "we" is initially consisting of
Jan, Steve, and myself as 'core') are trying to figure out what sorts of
enhancements would be worth introducing.  

And your comments have introduced at least two additional ideas to my
list, which I appreciate considerably!
-- 
output = reverse("ofni.sailifa.ac" "@" "enworbbc")
Christopher Browne
"Bother,"  said Pooh,  "Eeyore, ready  two photon  torpedoes  and lock
phasers on the Heffalump, Piglet, meet me in transporter room three"

From stephane.schildknecht at postgresql.fr  Thu Nov 18 09:03:22 2010
From: stephane.schildknecht at postgresql.fr (=?UTF-8?B?IlN0w6lwaGFuZSBBLiBTY2hpbGRrbmVjaHQi?=)
Date: Thu, 18 Nov 2010 18:03:22 +0100
Subject: [Slony1-general] Replicating 2 databases from 1 server
In-Reply-To: <1290079168.4323.30.camel@localhost>
References: <1290079168.4323.30.camel@localhost>
Message-ID: <4CE55C5A.6020905@postgresql.fr>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Le 18/11/2010 12:19, Pawe? T?cza a ?crit :
> Hello All,
> 
> I have a following scenario: there are 2 Debian Lenny boxes with
> Postgres 8.3. The first of them (say hostM) is a master and second (say
> hostS) is a backup (slave). I would like to replicate 2 databases (say
> db1 and db2) from hostM to hostS using Slony-I 1.2.15. I hope it's
> rather standard case :)
> 
> What configuration method of Slony-I is better for my scenario? By hand
> (it means using slonik command directly) or Perl tools? Is it possible
> to use only one /etc/slony1/slon_tools.conf to setup replication for 2
> different databases if I'll choose Perl tools? Maybe I should have 2
> separated slon_tools.conf files for them? 
> 
> All your comments are welcome :D 
> 
> My best regards,
> Pawel Tecza
> 

Hi,

First of all, you should use slony 1.2.21.

Second, there is no limitation on the number of databases your master hosts.

Personally, I work with slony1_ctl (http://slony1-ctl.projects.postgresql.org/)
to deal with my replications. So I'm afraid I can't help choosing between perl
or slonik scripts.

If ever you want to give slony1-ctl a try, don't hesitate to ask for help.

Best regards,
- -- 
St?phane Schildknecht
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.10 (GNU/Linux)
Comment: Using GnuPG with Mozilla - http://enigmail.mozdev.org/

iEYEARECAAYFAkzlXFoACgkQA+REPKWGI0GoagCgqqlyebzS3bc5vHtzd2pUfp1o
0x4An0a0ew7e65V0LgMQcWknUJXfPt3L
=tHUJ
-----END PGP SIGNATURE-----

From cbbrowne at ca.afilias.info  Thu Nov 18 10:15:33 2010
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Thu, 18 Nov 2010 13:15:33 -0500
Subject: [Slony1-general] Feature: SNMP
Message-ID: <87hbfeqz0a.fsf@cbbrowne.afilias-int.info>

I observe that some preliminary SNMP functionality was added back in
2005, but has not been touched, functionality-wise, since then.  (We've
fiddled with #includes, reformatted the code, but nothing changing what
it does.)

http://git.postgresql.org/gitweb?p=slony1-engine.git;a=blob;f=src/slon/snmp_thread.c;h=711e1b34551fe29769884148a34c621e99effa0e;hb=refs/heads/master

Is this valuable, worthy of further enhancement?  Or should we perhaps
consider this a failed experiment, and trim it out?  

I note that it only works if you configure --with-netsnmp; I'm pretty
sure I have never used this for tests, let alone production usage.
-- 
let name="cbbrowne" and tld="afilias.info" in String.concat "@" [name;tld];;
Christopher Browne
"Bother,"  said Pooh,  "Eeyore, ready  two photon  torpedoes  and lock
phasers on the Heffalump, Piglet, meet me in transporter room three"

From P.Tecza at icm.edu.pl  Thu Nov 18 12:02:11 2010
From: P.Tecza at icm.edu.pl (=?UTF-8?Q?Pawe=C5=82_T=C4=99cza?=)
Date: Thu, 18 Nov 2010 21:02:11 +0100
Subject: [Slony1-general] Replicating 2 databases from 1 server
In-Reply-To: <4CE55C5A.6020905@postgresql.fr>
References: <1290079168.4323.30.camel@localhost>
	<4CE55C5A.6020905@postgresql.fr>
Message-ID: <1290110531.2504.17.camel@localhost>

Dnia 2010-11-18, czw o godzinie 18:03 +0100, "St?phane A. Schildknecht"
pisze: 
> 
> Hi,

Hello St?phane,

At first, thank you very much for your response!

> First of all, you should use slony 1.2.21.

Hm. It can be hard, because I use Debian stable (Lenny). But I can try
to grab slony package for Debian testing (Squeeze) or backport for Lenny
if it exits.

BTW, why don't you recommend me slony 1.2.15? Is it really so obsolete?

> Second, there is no limitation on the number of databases your master hosts.

It's good to hear that :)

> Personally, I work with slony1_ctl (http://slony1-ctl.projects.postgresql.org/)
> to deal with my replications. So I'm afraid I can't help choosing between perl
> or slonik scripts.

I have never heard about slony1_ctl. Could you please write more about
that tool? Maybe any examples of usage? What advantages over slonik has
slony1_ctl utility?

Kind regards,
Pawel



From vivek at khera.org  Thu Nov 18 12:14:34 2010
From: vivek at khera.org (Vick Khera)
Date: Thu, 18 Nov 2010 15:14:34 -0500
Subject: [Slony1-general] Replicating 2 databases from 1 server
In-Reply-To: <1290110531.2504.17.camel@localhost>
References: <1290079168.4323.30.camel@localhost>
	<4CE55C5A.6020905@postgresql.fr>
	<1290110531.2504.17.camel@localhost>
Message-ID: <AANLkTikaqhazaSP8WFVNA44jMLrNjw9vLkW+9E4XPjQP@mail.gmail.com>

2010/11/18 Pawe? T?cza <P.Tecza at icm.edu.pl>:
> BTW, why don't you recommend me slony 1.2.15? Is it really so obsolete?
>

That's *6* bugfix releases old.  Releases are issued when there is a
bug capable of causing data loss.  Do you really want to risk losing
or corrupting your data because you didn't have the fixes to known
problems?  Same model applies to postgres releases.   You want the
latest bugfix release for your major version.

From ssinger at ca.afilias.info  Thu Nov 18 12:19:32 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Thu, 18 Nov 2010 15:19:32 -0500
Subject: [Slony1-general] Replicating 2 databases from 1 server
In-Reply-To: <1290110531.2504.17.camel@localhost>
References: <1290079168.4323.30.camel@localhost>	<4CE55C5A.6020905@postgresql.fr>
	<1290110531.2504.17.camel@localhost>
Message-ID: <4CE58A54.30505@ca.afilias.info>

On 10-11-18 03:02 PM, Pawe? T?cza wrote:
> Dnia 2010-11-18, czw o godzinie 18:03 +0100, "St?phane A. Schildknecht"
> pisze:
>>
>> Hi,
>
> Hello St?phane,
>
> At first, thank you very much for your response!
>
>> First of all, you should use slony 1.2.21.
>
> Hm. It can be hard, because I use Debian stable (Lenny). But I can try
> to grab slony package for Debian testing (Squeeze) or backport for Lenny
> if it exits.
>
> BTW, why don't you recommend me slony 1.2.15? Is it really so obsolete?
>

http://packages.debian.org/search?keywords=slony1

Isn't 1.2.21 available for lenny from backports?

See 
http://git.postgresql.org/gitweb?p=slony1-engine.git;a=blob;f=RELEASE;h=2081b98b80bdfb6b79e1baf5410da1eb26da01a4;hb=ce58f4a4f3b57a712d35c1e8420c66562117a7e2

for a list of bugs fixed between 1.2.15 and 1.2.21 the decision is yours.



>> Second, there is no limitation on the number of databases your master hosts.
>
> It's good to hear that :)
>
>> Personally, I work with slony1_ctl (http://slony1-ctl.projects.postgresql.org/)
>> to deal with my replications. So I'm afraid I can't help choosing between perl
>> or slonik scripts.
>
> I have never heard about slony1_ctl. Could you please write more about
> that tool? Maybe any examples of usage? What advantages over slonik has
> slony1_ctl utility?
>
> Kind regards,
> Pawel
>
>
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


From cbbrowne at ca.afilias.info  Thu Nov 18 12:20:27 2010
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Thu, 18 Nov 2010 15:20:27 -0500
Subject: [Slony1-general] Replicating 2 databases from 1 server
In-Reply-To: <1290110531.2504.17.camel@localhost> (=?utf-8?Q?=22Pawe=C5=82?=
	=?utf-8?Q?_T=C4=99cza=22's?= message of
	"Thu, 18 Nov 2010 21:02:11 +0100")
References: <1290079168.4323.30.camel@localhost>
	<4CE55C5A.6020905@postgresql.fr> <1290110531.2504.17.camel@localhost>
Message-ID: <874obeqt84.fsf@cbbrowne.afilias-int.info>

Pawe? T?cza <P.Tecza at icm.edu.pl> writes:
> Dnia 2010-11-18, czw o godzinie 18:03 +0100, "St?phane A. Schildknecht"
> pisze: 
>> Personally, I work with slony1_ctl (http://slony1-ctl.projects.postgresql.org/)
>> to deal with my replications. So I'm afraid I can't help choosing between perl
>> or slonik scripts.
>
> I have never heard about slony1_ctl. Could you please write more about
> that tool? Maybe any examples of usage? What advantages over slonik has
> slony1_ctl utility?

slony1_ctl is a set of shell scripts that write slonik scripts.

They are more or less equivalent to the "altperl" scripts (see
<http://www.slony.info/documentation/2.0/appendix.html#ALTPERL>), with
the primary differences that:

a) slony1_ctl is written as shell scripts, rather than in Perl.

b) slony1_ctl is quite a lot more actively maintained than the "altperl"
stuff in the Slony-I distribution.

slony_ctl and "altperl" are both ways to help generate slonik scripts,
so they're not actually a replacement for slonik.

I haven't used slony1_ctl to configure a  cluster, and have used
"altperl" to so.  On the other hand, I haven't used "altperl" for
anything important in a number of years, so that's not much of a
commendation.

I know there are people who are periodically still using altperl, so it
seems an unsafe idea to drop that from the Slony-I distribution.  I'd
still *like* to drop it, even though I know there's good reason not to!
-- 
let name="cbbrowne" and tld="ca.afilias.info" in name ^ "@" ^ tld;;
Christopher Browne
"Bother,"  said Pooh,  "Eeyore, ready  two photon  torpedoes  and lock
phasers on the Heffalump, Piglet, meet me in transporter room three"

From P.Tecza at icm.edu.pl  Thu Nov 18 12:34:00 2010
From: P.Tecza at icm.edu.pl (=?UTF-8?Q?Pawe=C5=82_T=C4=99cza?=)
Date: Thu, 18 Nov 2010 21:34:00 +0100
Subject: [Slony1-general] Replicating 2 databases from 1 server
In-Reply-To: <AANLkTikaqhazaSP8WFVNA44jMLrNjw9vLkW+9E4XPjQP@mail.gmail.com>
References: <1290079168.4323.30.camel@localhost>
	<4CE55C5A.6020905@postgresql.fr> <1290110531.2504.17.camel@localhost>
	<AANLkTikaqhazaSP8WFVNA44jMLrNjw9vLkW+9E4XPjQP@mail.gmail.com>
Message-ID: <1290112440.2504.34.camel@localhost>

Dnia 2010-11-18, czw o godzinie 15:14 -0500, Vick Khera pisze: 
> 2010/11/18 Pawe? T?cza <P.Tecza at icm.edu.pl>:
> > BTW, why don't you recommend me slony 1.2.15? Is it really so obsolete?
> >
> 
> That's *6* bugfix releases old.  Releases are issued when there is a
> bug capable of causing data loss.  Do you really want to risk losing
> or corrupting your data because you didn't have the fixes to known
> problems?  Same model applies to postgres releases.   You want the
> latest bugfix release for your major version.

Hello Vick,

Thanks a lot for the info! It's really very important for me. I'm a new
user of PostgreSQL and Slony-I, so I didn't know about these bugfixes.
Of course, I would like to use as fresh version of Slony-I as it's
possible :)

Have a nice day,
Pawel





> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general



From P.Tecza at icm.edu.pl  Thu Nov 18 12:42:37 2010
From: P.Tecza at icm.edu.pl (=?UTF-8?Q?Pawe=C5=82_T=C4=99cza?=)
Date: Thu, 18 Nov 2010 21:42:37 +0100
Subject: [Slony1-general] Replicating 2 databases from 1 server
In-Reply-To: <4CE58A54.30505@ca.afilias.info>
References: <1290079168.4323.30.camel@localhost>
	<4CE55C5A.6020905@postgresql.fr> <1290110531.2504.17.camel@localhost>
	<4CE58A54.30505@ca.afilias.info>
Message-ID: <1290112957.2504.43.camel@localhost>

Hello Steve,

Thanks for your reply!

Dnia 2010-11-18, czw o godzinie 15:19 -0500, Steve Singer pisze: 
> On 10-11-18 03:02 PM, Pawe? T?cza wrote:
> > Hm. It can be hard, because I use Debian stable (Lenny). But I can try
> > to grab slony package for Debian testing (Squeeze) or backport for Lenny
> > if it exits.
> >
> > BTW, why don't you recommend me slony 1.2.15? Is it really so obsolete?
> >
> 
> http://packages.debian.org/search?keywords=slony1
> 
> Isn't 1.2.21 available for lenny from backports?

Yes, I can see there backported slony1-bin 1.2.21 and only
postgresql-8.4-slony1 1.2.21. But the problem is that I probably need
postgresql-8.3-slony1 1.2.21 for my PostgreSQL 8.3... If it's necessary,
I can try to build my own backport.

> See 
> http://git.postgresql.org/gitweb?p=slony1-engine.git;a=blob;f=RELEASE;h=2081b98b80bdfb6b79e1baf5410da1eb26da01a4;hb=ce58f4a4f3b57a712d35c1e8420c66562117a7e2
> 
> for a list of bugs fixed between 1.2.15 and 1.2.21 the decision is yours.

Thank you very much for the link! I'll try to update my old and buggy
version of slony soon.

My best regards,
Pawel



From P.Tecza at icm.edu.pl  Thu Nov 18 12:48:01 2010
From: P.Tecza at icm.edu.pl (=?UTF-8?Q?Pawe=C5=82_T=C4=99cza?=)
Date: Thu, 18 Nov 2010 21:48:01 +0100
Subject: [Slony1-general] Replicating 2 databases from 1 server
In-Reply-To: <874obeqt84.fsf@cbbrowne.afilias-int.info>
References: <1290079168.4323.30.camel@localhost>
	<4CE55C5A.6020905@postgresql.fr> <1290110531.2504.17.camel@localhost>
	<874obeqt84.fsf@cbbrowne.afilias-int.info>
Message-ID: <1290113281.2504.47.camel@localhost>

Hello Christopher,

Dnia 2010-11-18, czw o godzinie 15:20 -0500, Christopher Browne pisze: 
> Pawe? T?cza <P.Tecza at icm.edu.pl> writes:
> > I have never heard about slony1_ctl. Could you please write more about
> > that tool? Maybe any examples of usage? What advantages over slonik has
> > slony1_ctl utility?
> 
> slony1_ctl is a set of shell scripts that write slonik scripts.
> 
> They are more or less equivalent to the "altperl" scripts (see
> <http://www.slony.info/documentation/2.0/appendix.html#ALTPERL>), with
> the primary differences that:
> 
> a) slony1_ctl is written as shell scripts, rather than in Perl.
> 
> b) slony1_ctl is quite a lot more actively maintained than the "altperl"
> stuff in the Slony-I distribution.
> 
> slony_ctl and "altperl" are both ways to help generate slonik scripts,
> so they're not actually a replacement for slonik.
> 
> I haven't used slony1_ctl to configure a  cluster, and have used
> "altperl" to so.  On the other hand, I haven't used "altperl" for
> anything important in a number of years, so that's not much of a
> commendation.
> 
> I know there are people who are periodically still using altperl, so it
> seems an unsafe idea to drop that from the Slony-I distribution.  I'd
> still *like* to drop it, even though I know there's good reason not to!

Thank you very much for these details! I'm happy user of Perl, but I can
take a look at slony_ctl too :)

Cheers,
Pawel


From ssinger_pg at sympatico.ca  Mon Nov 15 05:41:17 2010
From: ssinger_pg at sympatico.ca (Steve Singer)
Date: Mon, 15 Nov 2010 08:41:17 -0500
Subject: [Slony1-general] how to troubleshoot slony replication lag?
In-Reply-To: <AANLkTi=QMKEKTRSgYWtBMzWGcGsBVpvXLvNjqqJ+i9X9@mail.gmail.com>
References: <AANLkTi=nQudqbkoH-0gVLfVk9K7GgvUaaYxarwu=uCuE@mail.gmail.com>
	<4CDDA8B0.5080600@ca.afilias.info>
	<AANLkTinu1S0Gf7HGtg13vvyCDtTtt_-Y47814J5F3hVF@mail.gmail.com>
	<569A84EC-2CF3-4429-9826-DFA90585FA37@me.com>
	<AANLkTikMqjMv0GseOC33ySbEpQfocrsWFh_NZ0P_Ln6J@mail.gmail.com>
	<BLU0-SMTP89D8BEDDE017727723F1FFAC340@phx.gbl>
	<AANLkTinZG8=pjpeLyU7Hoq4bjwhPmKkwcUQYp+gBi71C@mail.gmail.com>
	<AANLkTi=QMKEKTRSgYWtBMzWGcGsBVpvXLvNjqqJ+i9X9@mail.gmail.com>
Message-ID: <BLU0-SMTP11CE51B398805AE311C8A4AC3A0@phx.gbl>

On Mon, 15 Nov 2010, Aleksey Tsalolikhin wrote:

> On Sun, Nov 14, 2010 at 4:41 PM, Aleksey Tsalolikhin
> <atsaloli.tech at gmail.com> wrote:
>> Dear Steve,
>>
>> Thanks for your reply, here is the information you requested.
>
> message did not go through due to large size (over 40 KB)
>
> Here's a few seconds of master/slave logs (from the same time window):
>
> http://pastebin.com/JxmrPfdY
>
> looks like the slave is not handling the events from the master?

I think your slave is trying to process a very lage SYNC from the master. 
We see the remote worker fetch groups of 100 rows and the remote worker 
appears to be processing them (based on lines like

DEBUG4 remoteWorkerThread_1: returning lines to pool

How many rows would be involved in teh largest transaction you (or your 
application) would have executed on the master?


>
> at this point replication lag is 35+ hours and the sl_log_1 and
> sl_log_2 total 43 GB (on an originally 23 GB database, now 65 GB in
> size including sl_log_1 and sl_log_2)

The fact that the sl_log's grow to such a large size makes implies that you 
have a very active database.

>
> we are going to take an emergency maintenance window to upgrade from
> slony-I 1.2.20 to 1.2.21 and resync, see how it looks then.
>

I don't think the upgrade is going to help you per say.  Resyncing will at 
least get your replication caught up again.


> Aleksey
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
>


From stuart at stuartbishop.net  Fri Nov 19 01:28:21 2010
From: stuart at stuartbishop.net (Stuart Bishop)
Date: Fri, 19 Nov 2010 16:28:21 +0700
Subject: [Slony1-general] Slonik Awareness of Cluster State (was
 Automatic WAIT FOR EVENT)
In-Reply-To: <87lj4qr3sf.fsf_-_@cbbrowne.afilias-int.info>
References: <87pqu3r4fj.fsf@cbbrowne.afilias-int.info>
	<AANLkTinbG0B__OunPuXPfJ_uq2SAq=pYnio0V40oB_Dv@mail.gmail.com>
	<87lj4qr3sf.fsf_-_@cbbrowne.afilias-int.info>
Message-ID: <AANLkTimETMqzfwVcq4KorhMdibkT4V_ecQqZF9diFK3w@mail.gmail.com>

On Thu, Nov 18, 2010 at 11:32 PM, Christopher Browne
<cbbrowne at ca.afilias.info> wrote:
> Vick Khera <vivek at khera.org> writes:
>> On Wed, Nov 17, 2010 at 5:06 PM, Christopher Browne
>> <cbbrowne at ca.afilias.info> wrote:
>>> For instance if it takes 20 minutes for SUBSCRIBE SET to complete, it's
>>> pretty likely that you want to wait for that to be complete before
>>> proceeding with other configuration that depends on it.
>>
>> None of my scripts ever have a WAIT in them. ?I break up my scripts to
>> be pretty atomic, and I rarely do anything after the subscribe except
>> sit and wait hours for the copy to happen.
>>
>> The one thing I'd like to have is a warning when issuing shape
>> changing commands such as move set if the backlog of events is very
>> high (say, more than 5 or 10). ?On occasion, I've forgotten to check
>> and issued the move when there was a 10 minute backlog. ?I ended up
>> waiting that out, but it was tense. ;)

I certainly use a lot of WAIT and SYNC statements to ensure I don't
throw Slony into some sort of deadlock - one statement at a time
please. These are generated scripts to run complex DDL and add/remove
stuff from replication or canned processes to build and drop replicas.
When doing manual tasks I do things one statement at a time and watch
the logs. I'd certainly love some sort of a mode where the next
statement is not started until the previous statement has been
completed on all nodes to avoid all the WAIT and SYNC nonsense.

The thing that bites us often are statements that block on long
running transactions. At the moment it is left to me to deduce why
something is blocked. I'd love to know what slony is trying to do and,
if it is blocked, what it is waiting for.


> That suggests to me there being some value to having some sort of "fail
> if not sufficiently up to date" command.

Pretty much all my canned scripts start by issuing a sync and waiting
for it. I think it is dangerous to do otherwise. Failing with a
meaningful error rather than leaving sysadmins staring at a blinking
prompt would be preferable.

> That's pretty specific to "replication being behind" - a different
> flavour of useful might be to have have a series of "fail if condition
> not met" evaluators to check things like:
>
> ?- Is a node there?
> ?- Is a replication set there?
> ?- Is a particular subscription configured?
> ?- Run a bit of SQL, and fail if it errors out.
> ?- Has a node successfully processed events within [time interval]?
> ?- Is a node presently processing a particular event?
>
> That last item is suggestive of another branch in the whole "stream of
> consciousness"...

> It sure would be nice if each slon would note somewhere, in a way that
> can be queried by others, what it's working on. ?That would be useful
> for the common scenario we have where beginners (and sometimes even
> experienced folk!) say "I don't quite know if replication is working.
> How can I find that out???"

I'd so love my admins to be able to see that the canned script to add
a new replica is blocked because the 11 hour backup is currently
running.


> BTW, the larger goal here isn't merely to draw out how we might handle
> an "implicit WAIT FOR EVENT" - we (where "we" is initially consisting of
> Jan, Steve, and myself as 'core') are trying to figure out what sorts of
> enhancements would be worth introducing.
>
> And your comments have introduced at least two additional ideas to my
> list, which I appreciate considerably!

The other thing I bumped into the other day - there is no way to get
slonik to emit the current date/time. I've got scripts running against
staging environments that I'd like to get timings for so we can plan
production updates properly. At the moment, I can only get the timing
of the entire script.




-- 
Stuart Bishop <stuart at stuartbishop.net>
http://www.stuartbishop.net/

From stuart at stuartbishop.net  Fri Nov 19 01:45:11 2010
From: stuart at stuartbishop.net (Stuart Bishop)
Date: Fri, 19 Nov 2010 16:45:11 +0700
Subject: [Slony1-general] Enhancement Proposal: Automatic WAIT FOR EVENT
In-Reply-To: <87pqu3r4fj.fsf@cbbrowne.afilias-int.info>
References: <87pqu3r4fj.fsf@cbbrowne.afilias-int.info>
Message-ID: <AANLkTikcWhcU0UDrh0gMUkPPtZ1rGwsjor6x7wqX-sNz@mail.gmail.com>

On Thu, Nov 18, 2010 at 5:06 AM, Christopher Browne
<cbbrowne at ca.afilias.info> wrote:
> A thing that several of us have been ruminating over for a while is the
> problem that people get confused about how you submit Slonik scripts,
> you may have some actions that require waits.
>
> For instance if it takes 20 minutes for SUBSCRIBE SET to complete, it's
> pretty likely that you want to wait for that to be complete before
> proceeding with other configuration that depends on it.
>
> That is already supported today, after a fashion - you 'merely' need to
> sprinkle your Slonik script with WAIT FOR EVENT requests.
>
> But the word 'merely' seems unfair; it is rarely particularly obvious
> what semantics are appropriate. ?(It is frequently not obvious to me,
> and I have touched a lot of the Slony codebase!)
>
> The "obvious" thought which has occurred is to have Slonik commands
> automatically wait for the appropriate events. ?In effect, we'd go thru
> each Slonik command, and have it automatically call slonik_wait_event()
> (found in src/slonik/slonik.c), or some refactoring thereof.
>
> A few questions and issues occur to me...
>
> 1. ?Does this seem like a worthwhile exercise? ?(Alternatively... ?Are
> there other Much Bigger Issues that should be looked at first?)

I'd love it. I've gotten into the habit of sync/wait after nearly
every statement to avoid shooting myself in the foot.

> Some of these may need some more functionality - SUBSCRIBE SET generates
> a pair of events so that it may be necessary to wait for a subsequent
> event, and perhaps to request synthesizing a SYNC, and waiting for
> *that*.

Which is exactly why I do sync/wait. I never know what node I should
be waiting for confirmation from for a particular statement, so just
shove a sync though the system and wait for my entire cluster to
process it.


> 4. ?Do we want overrides?
>
> Perhaps some might want the ability to revert to today's functionality,
> so one can run a "fire and forget" series of SUBSCRIBE SET requests.

How do you know what statements you can "fire and forget"? Is this
something guaranteed to not change between Slony releases? Its
something that has never been clear to me and I just don't risk it any
more.

> 6. ?Do we possibly need for there to be a way to force aborting a script
> if the WAIT times out?

I'd be more interested in knowing why something is blocked that having
my scripts abort midway, leaving my system in an indeterminate state.

> 7. ?I think this invalidates TRY { } ON ERROR { } ON SUCCESS { }
> ? ?handling, for the most part.
>
> ? ?At the very least, if we're waiting for things to succeed on a
> ? ?remote node, it invalidates the notion that we're performing the
> ? ?contents of the TRY block as a single transaction on the initial
> ? ?node.
>
> ? ?It's not particularly obvious how TRY requests get grouped into a
> ? ?single "transaction" anyways. ?Perhaps this points at there being
> ? ?something invalid/broken about TRY.

Try seems broken to me. If it only works in limited circumstances then
attempting to use non-transactional commands inside it should fail
(whatever they are - how do you know?). We might be able to get things
working in a properly transactional manner if we used two-phase
commit.


> 8. ?This is possibly not totally friendly towards tools like pgAdmin,
> ? ?which, I think, presently take the approach that all you need do to
> ? ?configure Slony clusters is to call the stored functions.

I suspect tools that talk directly to the stored functions do so due
to limitations in slonik, which you are attempting to address. I've
been considering dropping slonik and going direct to stored SQL
myself, but that too doesn't seem clear to me (what statements need to
be run on what node in what order waiting for what confirmations).


-- 
Stuart Bishop <stuart at stuartbishop.net>
http://www.stuartbishop.net/

From vivek at khera.org  Fri Nov 19 06:44:00 2010
From: vivek at khera.org (Vick Khera)
Date: Fri, 19 Nov 2010 09:44:00 -0500
Subject: [Slony1-general] Slonik Awareness of Cluster State (was
 Automatic WAIT FOR EVENT)
In-Reply-To: <AANLkTimETMqzfwVcq4KorhMdibkT4V_ecQqZF9diFK3w@mail.gmail.com>
References: <87pqu3r4fj.fsf@cbbrowne.afilias-int.info>
	<AANLkTinbG0B__OunPuXPfJ_uq2SAq=pYnio0V40oB_Dv@mail.gmail.com>
	<87lj4qr3sf.fsf_-_@cbbrowne.afilias-int.info>
	<AANLkTimETMqzfwVcq4KorhMdibkT4V_ecQqZF9diFK3w@mail.gmail.com>
Message-ID: <AANLkTikWUo_nRvug71gkAxUqoP3K2=_AdQL9afHCwukf@mail.gmail.com>

On Fri, Nov 19, 2010 at 4:28 AM, Stuart Bishop <stuart at stuartbishop.net> wrote:
>> That suggests to me there being some value to having some sort of "fail
>> if not sufficiently up to date" command.
>
> Pretty much all my canned scripts start by issuing a sync and waiting
> for it. I think it is dangerous to do otherwise. Failing with a
> meaningful error rather than leaving sysadmins staring at a blinking
> prompt would be preferable.

Nice. What does this look like in the script?

From dba at richyen.com  Fri Nov 19 07:39:17 2010
From: dba at richyen.com (Richard Yen)
Date: Fri, 19 Nov 2010 07:39:17 -0800
Subject: [Slony1-general] Slonik Awareness of Cluster State (was
 Automatic WAIT FOR EVENT)
In-Reply-To: <AANLkTikWUo_nRvug71gkAxUqoP3K2=_AdQL9afHCwukf@mail.gmail.com>
References: <87pqu3r4fj.fsf@cbbrowne.afilias-int.info>
	<AANLkTinbG0B__OunPuXPfJ_uq2SAq=pYnio0V40oB_Dv@mail.gmail.com>
	<87lj4qr3sf.fsf_-_@cbbrowne.afilias-int.info>
	<AANLkTimETMqzfwVcq4KorhMdibkT4V_ecQqZF9diFK3w@mail.gmail.com>
	<AANLkTikWUo_nRvug71gkAxUqoP3K2=_AdQL9afHCwukf@mail.gmail.com>
Message-ID: <AANLkTimbzB+7CZMHRB2tbp=v87xsCNrompdBuodTBiFk@mail.gmail.com>

I don't use WAIT all that much, but I know that it's necessary for some
actions--namely, FAIL OVER, in which I've encountered some race conditions
in the past that were resolved with a WAIT and SYNC.  It'd be nice to have
WAIT built-in to some of the slonik functions.


--Richard



On Fri, Nov 19, 2010 at 6:44 AM, Vick Khera <vivek at khera.org> wrote:

> On Fri, Nov 19, 2010 at 4:28 AM, Stuart Bishop <stuart at stuartbishop.net>
> wrote:
> >> That suggests to me there being some value to having some sort of "fail
> >> if not sufficiently up to date" command.
> >
> > Pretty much all my canned scripts start by issuing a sync and waiting
> > for it. I think it is dangerous to do otherwise. Failing with a
> > meaningful error rather than leaving sysadmins staring at a blinking
> > prompt would be preferable.
>
> Nice. What does this look like in the script?
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20101119/2cb03134/attachment.htm 

From cbbrowne at ca.afilias.info  Fri Nov 19 08:18:53 2010
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Fri, 19 Nov 2010 11:18:53 -0500
Subject: [Slony1-general] Slonik Awareness of Cluster State
In-Reply-To: <AANLkTimETMqzfwVcq4KorhMdibkT4V_ecQqZF9diFK3w@mail.gmail.com>
	(Stuart Bishop's message of "Fri, 19 Nov 2010 16:28:21 +0700")
References: <87pqu3r4fj.fsf@cbbrowne.afilias-int.info>
	<AANLkTinbG0B__OunPuXPfJ_uq2SAq=pYnio0V40oB_Dv@mail.gmail.com>
	<87lj4qr3sf.fsf_-_@cbbrowne.afilias-int.info>
	<AANLkTimETMqzfwVcq4KorhMdibkT4V_ecQqZF9diFK3w@mail.gmail.com>
Message-ID: <87vd3tp9qq.fsf@cbbrowne.afilias-int.info>

Stuart Bishop <stuart at stuartbishop.net> writes:
> The other thing I bumped into the other day - there is no way to get
> slonik to emit the current date/time. I've got scripts running against
> staging environments that I'd like to get timings for so we can plan
> production updates properly. At the moment, I can only get the timing
> of the entire script.

You're thinking of something like
   ECHO 'Step 17 finished';
   DATE;
?

That seems pretty plausible, and I can't imagine it would be
particularly difficult to implement.

I'll certainly add that to the Grand List.
-- 
(format nil "~S@~S" "cbbrowne" "ca.afilias.info")
Christopher Browne
"Bother,"  said Pooh,  "Eeyore, ready  two photon  torpedoes  and lock
phasers on the Heffalump, Piglet, meet me in transporter room three"

From cbbrowne at ca.afilias.info  Fri Nov 19 08:50:12 2010
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Fri, 19 Nov 2010 11:50:12 -0500
Subject: [Slony1-general] Enhancement Proposal: Automatic WAIT FOR EVENT
In-Reply-To: <AANLkTikcWhcU0UDrh0gMUkPPtZ1rGwsjor6x7wqX-sNz@mail.gmail.com>
	(Stuart Bishop's message of "Fri, 19 Nov 2010 16:45:11 +0700")
References: <87pqu3r4fj.fsf@cbbrowne.afilias-int.info>
	<AANLkTikcWhcU0UDrh0gMUkPPtZ1rGwsjor6x7wqX-sNz@mail.gmail.com>
Message-ID: <87r5ehp8aj.fsf@cbbrowne.afilias-int.info>

Stuart Bishop <stuart at stuartbishop.net> writes:
> On Thu, Nov 18, 2010 at 5:06 AM, Christopher Browne
> <cbbrowne at ca.afilias.info> wrote:
>> A thing that several of us have been ruminating over for a while is the
>> problem that people get confused about how you submit Slonik scripts,
>> you may have some actions that require waits.
>>
>> For instance if it takes 20 minutes for SUBSCRIBE SET to complete, it's
>> pretty likely that you want to wait for that to be complete before
>> proceeding with other configuration that depends on it.
>>
>> That is already supported today, after a fashion - you 'merely' need to
>> sprinkle your Slonik script with WAIT FOR EVENT requests.
>>
>> But the word 'merely' seems unfair; it is rarely particularly obvious
>> what semantics are appropriate. ?(It is frequently not obvious to me,
>> and I have touched a lot of the Slony codebase!)
>>
>> The "obvious" thought which has occurred is to have Slonik commands
>> automatically wait for the appropriate events. ?In effect, we'd go thru
>> each Slonik command, and have it automatically call slonik_wait_event()
>> (found in src/slonik/slonik.c), or some refactoring thereof.
>>
>> A few questions and issues occur to me...
>>
>> 1. ?Does this seem like a worthwhile exercise? ?(Alternatively... ?Are
>> there other Much Bigger Issues that should be looked at first?)
>
> I'd love it. I've gotten into the habit of sync/wait after nearly
> every statement to avoid shooting myself in the foot.
>
>> Some of these may need some more functionality - SUBSCRIBE SET generates
>> a pair of events so that it may be necessary to wait for a subsequent
>> event, and perhaps to request synthesizing a SYNC, and waiting for
>> *that*.
>
> Which is exactly why I do sync/wait. I never know what node I should
> be waiting for confirmation from for a particular statement, so just
> shove a sync though the system and wait for my entire cluster to
> process it.

I can't offer a straight answer on that, which is to say that you're
onto something :-).

>> 4. ?Do we want overrides?
>>
>> Perhaps some might want the ability to revert to today's functionality,
>> so one can run a "fire and forget" series of SUBSCRIBE SET requests.
>
> How do you know what statements you can "fire and forget"? Is this
> something guaranteed to not change between Slony releases? Its
> something that has never been clear to me and I just don't risk it any
> more.

Nobody goes in looking to introduce incompatibilities, but if we
guarantee "it won't change between releases," that might guarantee we
can't make improvements, so I expect that's a non-starter.

Again, methinks you're onto something...

>> 6. ?Do we possibly need for there to be a way to force aborting a script
>> if the WAIT times out?
>
> I'd be more interested in knowing why something is blocked that having
> my scripts abort midway, leaving my system in an indeterminate state.

Yep, that's a larger issue that lurks there.  Probably this needs to be
thought about a bit more before deciding on solutions.

>> 7. ?I think this invalidates TRY { } ON ERROR { } ON SUCCESS { }
>> ? ?handling, for the most part.
>>
>> ? ?At the very least, if we're waiting for things to succeed on a
>> ? ?remote node, it invalidates the notion that we're performing the
>> ? ?contents of the TRY block as a single transaction on the initial
>> ? ?node.
>>
>> ? ?It's not particularly obvious how TRY requests get grouped into a
>> ? ?single "transaction" anyways. ?Perhaps this points at there being
>> ? ?something invalid/broken about TRY.
>
> Try seems broken to me. If it only works in limited circumstances then
> attempting to use non-transactional commands inside it should fail
> (whatever they are - how do you know?). We might be able to get things
> working in a properly transactional manner if we used two-phase
> commit.

I think every year I've talked about Slony at PGCon or similar, there
has been a brief discussion about 2PC, which hasn't headed towards "we
want to use it."

I wonder if we could set it up to fail if one requests unsuitable
commands in the block.  That in effect requires documenting clearly (to
the point of them being expressed as part of the compiler grammar!) the
delineation between suitable and non-suitable.

[Adding this...]

>> 8. ?This is possibly not totally friendly towards tools like pgAdmin,
>> ? ?which, I think, presently take the approach that all you need do
>> to ? ?configure Slony clusters is to call the stored functions.
>
> I suspect tools that talk directly to the stored functions do so due
> to limitations in slonik, which you are attempting to address. I've
> been considering dropping slonik and going direct to stored SQL
> myself, but that too doesn't seem clear to me (what statements need to
> be run on what node in what order waiting for what confirmations).

No, we were hoping that a GUI might emerge via people coding to talk to
the stored functions.  That's a feature, not a bug, or at least, that's
what was hoped...

There are a few operations (FAILOVER comes particularly to mind) where
it's necessary to talk to several nodes, so that it's problematic to
just "fire a stored function."

Operations that are rather "thicker" than just a wrapper around a stored
function are:

- EXECUTE SCRIPT
   - Splits DDL into a series of statements

- WAIT FOR EVENT
   - Checks multiple nodes

- STORE NODE
   - Pulls configuration from source node to copy to new node

- FAILOVER
   - Has rather a lot of logic!

FYI, I'm *very* pleased to see discussion continue on this thread; the
valuable thing is for ideas to fall out of it, and they surely are doing
so.  I don't know what will get done out of it, but ideas are needed in
order to have a "so what next?"
-- 
(reverse (concatenate 'string "ofni.sailifa.ac" "@" "enworbbc"))
Christopher Browne
"Bother,"  said Pooh,  "Eeyore, ready  two photon  torpedoes  and lock
phasers on the Heffalump, Piglet, meet me in transporter room three"

From ajs at crankycanuck.ca  Fri Nov 19 08:53:24 2010
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Fri, 19 Nov 2010 11:53:24 -0500
Subject: [Slony1-general] Enhancement Proposal: Automatic WAIT FOR EVENT
In-Reply-To: <87r5ehp8aj.fsf@cbbrowne.afilias-int.info>
References: <87pqu3r4fj.fsf@cbbrowne.afilias-int.info>
	<AANLkTikcWhcU0UDrh0gMUkPPtZ1rGwsjor6x7wqX-sNz@mail.gmail.com>
	<87r5ehp8aj.fsf@cbbrowne.afilias-int.info>
Message-ID: <20101119165324.GJ8050@shinkuro.com>

On Fri, Nov 19, 2010 at 11:50:12AM -0500, Christopher Browne wrote:
> I think every year I've talked about Slony at PGCon or similar, there
> has been a brief discussion about 2PC, which hasn't headed towards "we
> want to use it."

My experience was slightly different: the discussion of 2PC always
tended towards, "Gee, it'd be nice to get that functionality just in
case you need it."  Of course, that boils down to the Do What I Mean
protocol, which is a current bugbear for me over in my day job, so
maybe I'm just inclined to hear that everywhere.

A

-- 
Andrew Sullivan
ajs at crankycanuck.ca

From ssinger at ca.afilias.info  Fri Nov 19 09:16:04 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Fri, 19 Nov 2010 12:16:04 -0500
Subject: [Slony1-general] REL 2.0.6 RC1 released
Message-ID: <4CE6B0D4.4070609@ca.afilias.info>

A release candidate for 2.0.6 can be found at
http://www.slony.info/downloads/2.0/source/slony1-2.0.6.rc1.tar.bz2

and docs at
http://www.slony.info/downloads/2.0/source/slony1-2.0.6.rc1-docs.tar.bz2

The changes from 2.0.5 are:

-Fix for bug #158, Removing extranous '//' from the perl script.

-Fix for bug #155, slon can segfault while shutting down.

-Fix for bug #162, typenameTypeId() changes signatures in 9.1

-Fix for bug #160, if slon gets confused waiting for its child it will exit.

This also should fix some packaging issues in the 2.0.5 tar release and 
includes documentation updates.

Reports of success or failures with these packages are encouraged.

From devrim at gunduz.org  Fri Nov 19 10:33:16 2010
From: devrim at gunduz.org (Devrim =?ISO-8859-1?Q?G=DCND=DCZ?=)
Date: Fri, 19 Nov 2010 20:33:16 +0200
Subject: [Slony1-general] REL 2.0.6 RC1 released
In-Reply-To: <4CE6B0D4.4070609@ca.afilias.info>
References: <4CE6B0D4.4070609@ca.afilias.info>
Message-ID: <1290191596.5475.3.camel@hp-laptop02.gunduz.org>

On Fri, 2010-11-19 at 12:16 -0500, Steve Singer wrote:
> Reports of success or failures with these packages are encouraged.

on RHEL 5, I got the same error that I reported yesterday. On RHEL 6, I
got another error, but it may be because of my RPM packaging, so I'll
report that later if I can't fix.

RHEL 5:
<snip>
checking for flex... configure: WARNING:
*** The installed version of Flex, /usr/bin/flex, is too old to use with Slony-I.
*** Flex version 2.5.31 or later is required, but this is /usr/bin/flex version 2.5.4.
configure: WARNING:
*** The installed version of Flex, /usr/bin/lex, is too old to use with Slony-I.
*** Flex version 2.5.31 or later is required, but this is /usr/bin/lex version 2.5.4.
no
configure: WARNING:
*** Without Flex you will not be able to build Slony-I from CVS nor
*** change any of the scanner definition files.  You can obtain Flex from
*** a GNU mirror site.  (If you are using the official distribution of
*** Slony-I then you do not need to worry about this because the Flex
*** output is pre-generated.)
checking if you have requested slony1-engine building... yes
<snip>
gcc -O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector --param=ssp-buffer-size=4 -m32 -march=i386 -mtune=generic -fasynchronous-unwind-tables -I/usr/include/et -I/usr/include -Wall -Wmissing-prototypes -Wmissing-declarations -I../.. -DPGSHARE="\"/usr/share/pgsql/\""  -I/usr/include/ -I/usr/include/pgsql/server/ -I/usr/include/ -I/usr/include/pgsql/server/ -I/usr/include/ -I/usr/include/pgsql/server/  -I/usr/include/et -I/usr/include -c -o dbutil.o dbutil.c
gcc -O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector --param=ssp-buffer-size=4 -m32 -march=i386 -mtune=generic -fasynchronous-unwind-tables -I/usr/include/et -I/usr/include -Wall -Wmissing-prototypes -Wmissing-declarations -I../.. -DPGSHARE="\"/usr/share/pgsql/\""  -I/usr/include/ -I/usr/include/pgsql/server/ -I/usr/include/ -I/usr/include/pgsql/server/ -I/usr/include/ -I/usr/include/pgsql/server/  -I/usr/include/et -I/usr/include -c -o ipcutil.o ipcutil.c
bison -y -d  parser.y
mv -f y.tab.c parser.c
Missing flex scan.l scan.c
gcc -O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector --param=ssp-buffer-size=4 -m32 -march=i386 -mtune=generic -fasynchronous-unwind-tables -I/usr/include/et -I/usr/include -Wall -Wmissing-prototypes -Wmissing-declarations -I../.. -DPGSHARE="\"/usr/share/pgsql/\""  -I/usr/include/ -I/usr/include/pgsql/server/ -I/usr/include/ -I/usr/include/pgsql/server/ -I/usr/include/ -I/usr/include/pgsql/server/  -I/usr/include/et -I/usr/include -c -o parser.o parser.c
gcc -O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector --param=ssp-buffer-size=4 -m32 -march=i386 -mtune=generic -fasynchronous-unwind-tables -I/usr/include/et -I/usr/include -Wall -Wmissing-prototypes -Wmissing-declarations -I../.. -DPGSHARE="\"/usr/share/pgsql/\""  -I/usr/include/ -I/usr/include/pgsql/server/ -I/usr/include/ -I/usr/include/pgsql/server/ -I/usr/include/ -I/usr/include/pgsql/server/  -I/usr/include/et -I/usr/include -c -o scan.o scan.c
gcc: scan.c: No such file or directory
gcc: no input files

Regards,
-- 
Devrim G?ND?Z
PostgreSQL Dan??man?/Consultant, Red Hat Certified Engineer
PostgreSQL RPM Repository: http://yum.pgrpms.org
Community: devrim~PostgreSQL.org, devrim.gunduz~linux.org.tr
http://www.gunduz.org  Twitter: http://twitter.com/devrimgunduz
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 198 bytes
Desc: This is a digitally signed message part
Url : http://lists.slony.info/pipermail/slony1-general/attachments/20101119/721cd715/attachment-0001.pgp 

From bhirt at me.com  Fri Nov 19 10:48:32 2010
From: bhirt at me.com (Brian Hirt)
Date: Fri, 19 Nov 2010 11:48:32 -0700
Subject: [Slony1-general] Enhancement Proposal: Automatic WAIT FOR EVENT
In-Reply-To: <87r5ehp8aj.fsf@cbbrowne.afilias-int.info>
References: <87pqu3r4fj.fsf@cbbrowne.afilias-int.info>
	<AANLkTikcWhcU0UDrh0gMUkPPtZ1rGwsjor6x7wqX-sNz@mail.gmail.com>
	<87r5ehp8aj.fsf@cbbrowne.afilias-int.info>
Message-ID: <3E8CA78D-66A2-4374-B1C1-A7EAB5F98D07@me.com>

Stuart Bishop <stuart at stuartbishop.net> writes:
On Thu, Nov 18, 2010 at 5:06 AM, Christopher Browne
> <cbbrowne at ca.afilias.info> wrote:
>> A thing that several of us have been ruminating over for a while is the
>> problem that people get confused about how you submit Slonik scripts,
>> you may have some actions that require waits.
>> 
>> For instance if it takes 20 minutes for SUBSCRIBE SET to complete, it's
>> pretty likely that you want to wait for that to be complete before
>> proceeding with other configuration that depends on it.
>> 
>> That is already supported today, after a fashion - you 'merely' need to
>> sprinkle your Slonik script with WAIT FOR EVENT requests.
>> 
>> But the word 'merely' seems unfair; it is rarely particularly obvious
>> what semantics are appropriate.  (It is frequently not obvious to me,
>> and I have touched a lot of the Slony codebase!)
>> 
>> The "obvious" thought which has occurred is to have Slonik commands
>> automatically wait for the appropriate events.  In effect, we'd go thru
>> each Slonik command, and have it automatically call slonik_wait_event()
>> (found in src/slonik/slonik.c), or some refactoring thereof.
>> 
>> A few questions and issues occur to me...
>> 
>> 1.  Does this seem like a worthwhile exercise?  (Alternatively...  Are
>> there other Much Bigger Issues that should be looked at first?)
> 
> I'd love it. I've gotten into the habit of sync/wait after nearly
> every statement to avoid shooting myself in the foot.

I put a sync after practically every statement too.  I've shot my self in the foot because I haven't and it hurts.  It's also not always clear to me when I should/shoudn't be doing it and it can be confusing.   If there was some way to automate this I would be very grateful.

From cbbrowne at ca.afilias.info  Fri Nov 19 11:19:16 2010
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Fri, 19 Nov 2010 14:19:16 -0500
Subject: [Slony1-general] REL 2.0.6 RC1 released
In-Reply-To: <1290191596.5475.3.camel@hp-laptop02.gunduz.org> ("Devrim
	=?utf-8?B?R8OcTkTDnFoiJ3M=?= message of "Fri,
	19 Nov 2010 20:33:16 +0200")
References: <4CE6B0D4.4070609@ca.afilias.info>
	<1290191596.5475.3.camel@hp-laptop02.gunduz.org>
Message-ID: <87ipztp1e3.fsf@cbbrowne.afilias-int.info>

Devrim G?ND?Z <devrim at gunduz.org> writes:
> On Fri, 2010-11-19 at 12:16 -0500, Steve Singer wrote:
>> Reports of success or failures with these packages are encouraged.
>
> on RHEL 5, I got the same error that I reported yesterday. On RHEL 6, I
> got another error, but it may be because of my RPM packaging, so I'll
> report that later if I can't fix.
>
> RHEL 5:
> <snip>
> checking for flex... configure: WARNING:
> *** The installed version of Flex, /usr/bin/flex, is too old to use with Slony-I.
> *** Flex version 2.5.31 or later is required, but this is /usr/bin/flex version 2.5.4.
> configure: WARNING:
> *** The installed version of Flex, /usr/bin/lex, is too old to use with Slony-I.
> *** Flex version 2.5.31 or later is required, but this is /usr/bin/lex version 2.5.4.
> no
> configure: WARNING:
> *** Without Flex you will not be able to build Slony-I from CVS nor
> *** change any of the scanner definition files.  You can obtain Flex from
> *** a GNU mirror site.  (If you are using the official distribution of
> *** Slony-I then you do not need to worry about this because the Flex
> *** output is pre-generated.)

I see the following indicated within configure.ac

 PGAC_PATH_FLEX
# --------------
# Look for Flex, set the output variable FLEX to its path if found.
# Reject versions before 2.5.31, as we need a reasonably non-buggy reentrant
# scanner.    We need at least 2.5.31 because we depend on
# yyget_leng() to be defined since later some versions of flex switched
# the definition of yyleng from an int to a size_t
#  Also find Flex if its installed under `lex', but do not
# accept other Lex programs.

# PGAC_PATH_FLEX

This was committed back in May:

<http://git.postgresql.org/gitweb?p=slony1-engine.git;a=commit;h=b44f967e2c62c60f5a2448ce1c4d5afd878922bf>
-- 
"cbbrowne","@","afilias.info"
Christopher Browne
"Bother,"  said Pooh,  "Eeyore, ready  two photon  torpedoes  and lock
phasers on the Heffalump, Piglet, meet me in transporter room three"

From ssinger at ca.afilias.info  Fri Nov 19 11:33:24 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Fri, 19 Nov 2010 14:33:24 -0500
Subject: [Slony1-general] REL 2.0.6 RC1 released
In-Reply-To: <1290191596.5475.3.camel@hp-laptop02.gunduz.org>
References: <4CE6B0D4.4070609@ca.afilias.info>
	<1290191596.5475.3.camel@hp-laptop02.gunduz.org>
Message-ID: <4CE6D104.8020505@ca.afilias.info>

On 10-11-19 01:33 PM, Devrim G?ND?Z wrote:
> On Fri, 2010-11-19 at 12:16 -0500, Steve Singer wrote:
>> Reports of success or failures with these packages are encouraged.
>
> on RHEL 5, I got the same error that I reported yesterday. On RHEL 6, I
> got another error, but it may be because of my RPM packaging, so I'll
> report that later if I can't fix.

For the benefit of the list.

Bug #159, the bug that referenced this issue had not actually been 
committed to REL_2_0_STABLE.

This has now been done.

2.0.6 RC2 has been released as well (it differs in that includes the fix 
for bug #159, so the packages should contain the required files)



From devrim at gunduz.org  Fri Nov 19 11:44:19 2010
From: devrim at gunduz.org (Devrim =?ISO-8859-1?Q?G=DCND=DCZ?=)
Date: Fri, 19 Nov 2010 21:44:19 +0200
Subject: [Slony1-general] REL 2.0.6 RC1 released
In-Reply-To: <4CE6D104.8020505@ca.afilias.info>
References: <4CE6B0D4.4070609@ca.afilias.info>
	<1290191596.5475.3.camel@hp-laptop02.gunduz.org>
	<4CE6D104.8020505@ca.afilias.info>
Message-ID: <1290195859.5475.6.camel@hp-laptop02.gunduz.org>

On Fri, 2010-11-19 at 14:33 -0500, Steve Singer wrote:
> 
> 
> 2.0.6 RC2 has been released as well (it differs in that includes the
> fix 
> for bug #159, so the packages should contain the required files) 

Thanks. 2.0.6 rc2 builds fine on RHEL5 and RHEL 6. RHEL 6 issue that I
mentioned in my previous e-mail was an RPM related issue, and I already
fixed it.

Regards,
-- 
Devrim G?ND?Z
PostgreSQL Dan??man?/Consultant, Red Hat Certified Engineer
PostgreSQL RPM Repository: http://yum.pgrpms.org
Community: devrim~PostgreSQL.org, devrim.gunduz~linux.org.tr
http://www.gunduz.org  Twitter: http://twitter.com/devrimgunduz
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 198 bytes
Desc: This is a digitally signed message part
Url : http://lists.slony.info/pipermail/slony1-general/attachments/20101119/07353c4a/attachment.pgp 

From cbbrowne at ca.afilias.info  Fri Nov 19 11:59:14 2010
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Fri, 19 Nov 2010 14:59:14 -0500
Subject: [Slony1-general] REL 2.0.6 RC1 released
In-Reply-To: <1290195859.5475.6.camel@hp-laptop02.gunduz.org> ("Devrim
	=?utf-8?B?R8OcTkTDnFoiJ3M=?= message of "Fri,
	19 Nov 2010 21:44:19 +0200")
References: <4CE6B0D4.4070609@ca.afilias.info>
	<1290191596.5475.3.camel@hp-laptop02.gunduz.org>
	<4CE6D104.8020505@ca.afilias.info>
	<1290195859.5475.6.camel@hp-laptop02.gunduz.org>
Message-ID: <87eiahozjh.fsf@cbbrowne.afilias-int.info>

Devrim G?ND?Z <devrim at gunduz.org> writes:
> On Fri, 2010-11-19 at 14:33 -0500, Steve Singer wrote:
>> 
>> 
>> 2.0.6 RC2 has been released as well (it differs in that includes the
>> fix 
>> for bug #159, so the packages should contain the required files) 
>
> Thanks. 2.0.6 rc2 builds fine on RHEL5 and RHEL 6. RHEL 6 issue that I
> mentioned in my previous e-mail was an RPM related issue, and I already
> fixed it.
>
> Regards,

If there were any patches that needed to be done to spec files, we could
add those changes in, too.
-- 
"cbbrowne","@","ca.afilias.info"
Christopher Browne
"Bother,"  said Pooh,  "Eeyore, ready  two photon  torpedoes  and lock
phasers on the Heffalump, Piglet, meet me in transporter room three"

From devrim at gunduz.org  Fri Nov 19 12:09:56 2010
From: devrim at gunduz.org (Devrim =?ISO-8859-1?Q?G=DCND=DCZ?=)
Date: Fri, 19 Nov 2010 22:09:56 +0200
Subject: [Slony1-general] REL 2.0.6 RC1 released
In-Reply-To: <87eiahozjh.fsf@cbbrowne.afilias-int.info>
References: <4CE6B0D4.4070609@ca.afilias.info>
	<1290191596.5475.3.camel@hp-laptop02.gunduz.org>
	<4CE6D104.8020505@ca.afilias.info>
	<1290195859.5475.6.camel@hp-laptop02.gunduz.org>
	<87eiahozjh.fsf@cbbrowne.afilias-int.info>
Message-ID: <1290197396.5475.8.camel@hp-laptop02.gunduz.org>

On Fri, 2010-11-19 at 14:59 -0500, Christopher Browne wrote:
> 
> If there were any patches that needed to be done to spec files, we
> could add those changes in, too. 

Nope. I am not adding any patches to slony spec file...

Regards,

-- 
Devrim G?ND?Z
PostgreSQL Dan??man?/Consultant, Red Hat Certified Engineer
PostgreSQL RPM Repository: http://yum.pgrpms.org
Community: devrim~PostgreSQL.org, devrim.gunduz~linux.org.tr
http://www.gunduz.org  Twitter: http://twitter.com/devrimgunduz
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 198 bytes
Desc: This is a digitally signed message part
Url : http://lists.slony.info/pipermail/slony1-general/attachments/20101119/a045e938/attachment.pgp 

From ssinger at ca.afilias.info  Fri Nov 19 12:30:26 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Fri, 19 Nov 2010 15:30:26 -0500
Subject: [Slony1-general] slonik usability - fewer commands to create a set
Message-ID: <4CE6DE62.4080102@ca.afilias.info>

On the theme of improving the usability of slonik; there are a few 
things that I feel can be done towards this.

1.  You should be able to specify a preamble file on the command lline.

ie

slonik -p /etc/slonik/mycluster.sl.

All slonik scripts start with

--
cluster name=foo;
node 1 admin conninfo='....';
node 2 admin conninfo='....';

------

This way you can have your standard preamble laying around somewhere so 
each time you invoke slonik you can actually start issuing useful 
commands.  I realize that you do an 'include' as soon as you start 
slonik but sometimes that is awkward.

Also if you want to write slonik scripts that can be tested (as in) in a 
test environment before applying them to production it would be easier 
if you just passed the proper preamble file on the command line versus 
having to edit the includes of the script.


2. You should be able to bulk add a bunch of tables to a set.

Most of the time when I add setup a new system for replication I write a 
shell script that queries pg_table and generates a series of 'set add 
table(...' commands.   I shouldn't need to do this.

I propose we let slonik support something like

set add table(set id=1, tables="public.*", origin=1);
set add table(set id=1, tables="billing.(!password)",origin=1);


where posix regular expressions can be used to patch the tables to add 
to the set.

3. Fewer non-default options to 'set add table.'

Specifically slonik should select an appropriate id for the table and 
figure out where the origin is.  Most people don't try adding tables to 
their replication sets while a move set is in progress.


Do other others agree that these features are worth having?

Steve


From dba at richyen.com  Fri Nov 19 12:37:03 2010
From: dba at richyen.com (Richard Yen)
Date: Fri, 19 Nov 2010 12:37:03 -0800
Subject: [Slony1-general] slonik usability - fewer commands to create a
	set
In-Reply-To: <4CE6DE62.4080102@ca.afilias.info>
References: <4CE6DE62.4080102@ca.afilias.info>
Message-ID: <AANLkTi=23AUYXLtYKzz7o-w7BzeDC36hYBtLogZ8NmtR@mail.gmail.com>

On Fri, Nov 19, 2010 at 12:30 PM, Steve Singer <ssinger at ca.afilias.info>wrote:

>  Do other others agree that these features are worth having?
>
> These would be very nice items to have, and I'm sure I'd leverage them for
my admin needs.

--Richard
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20101119/70ec428f/attachment.htm 

From devrim at gunduz.org  Fri Nov 19 12:36:47 2010
From: devrim at gunduz.org (Devrim =?ISO-8859-1?Q?G=DCND=DCZ?=)
Date: Fri, 19 Nov 2010 22:36:47 +0200
Subject: [Slony1-general] postgres 8.4 supported by slony 1.2.21?
In-Reply-To: <AANLkTikjnb=0C1TgMC0NvkOfkHFRnfYOPLtRb0fqX5ev@mail.gmail.com>
References: <AANLkTik8zaf8YK-_QNHwhva7i1mupzgx=Oyraw__LM0j@mail.gmail.com>
	<AANLkTimBSrgF7DPdf32T3o_R89Z3U1SJ3pHOS9vR=xeW@mail.gmail.com>
	<4CE3FDB9.3000400@ca.afilias.info>
	<AANLkTinThG9Kp9c0fug8PFuBdjaMiDkFJmCV02wk6whC@mail.gmail.com>
	<1290036317.7107.14.camel@hp-laptop02.gunduz.org>
	<AANLkTikjnb=0C1TgMC0NvkOfkHFRnfYOPLtRb0fqX5ev@mail.gmail.com>
Message-ID: <1290199007.5475.10.camel@hp-laptop02.gunduz.org>

On Thu, 2010-11-18 at 07:55 -0500, Jaime Casanova wrote:
> what i did to solve this...
> 
> download pg 9 sources and recompile using pg_config --configure
> installed by pgdg repo (hope that put things in the same place and
> that yum doesn't get confused if i try to remove)

FWIW, both 2.0.X and 1.2.X are available in RPM repository.

yum install slony1 (for 1.2.X)
or
yum install slony1-II (for 2.0.X)

will do the trick.

Regards,
-- 
Devrim G?ND?Z
PostgreSQL Dan??man?/Consultant, Red Hat Certified Engineer
PostgreSQL RPM Repository: http://yum.pgrpms.org
Community: devrim~PostgreSQL.org, devrim.gunduz~linux.org.tr
http://www.gunduz.org  Twitter: http://twitter.com/devrimgunduz
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 198 bytes
Desc: This is a digitally signed message part
Url : http://lists.slony.info/pipermail/slony1-general/attachments/20101119/c0a52078/attachment.pgp 

From stuart at stuartbishop.net  Fri Nov 19 12:39:26 2010
From: stuart at stuartbishop.net (Stuart Bishop)
Date: Sat, 20 Nov 2010 03:39:26 +0700
Subject: [Slony1-general] Slonik Awareness of Cluster State
In-Reply-To: <87vd3tp9qq.fsf@cbbrowne.afilias-int.info>
References: <87pqu3r4fj.fsf@cbbrowne.afilias-int.info>
	<AANLkTinbG0B__OunPuXPfJ_uq2SAq=pYnio0V40oB_Dv@mail.gmail.com>
	<87lj4qr3sf.fsf_-_@cbbrowne.afilias-int.info>
	<AANLkTimETMqzfwVcq4KorhMdibkT4V_ecQqZF9diFK3w@mail.gmail.com>
	<87vd3tp9qq.fsf@cbbrowne.afilias-int.info>
Message-ID: <AANLkTi==h6VG+p55JjQOmQx4ShUJn4JwH+X1_Z-AvRVT@mail.gmail.com>

On Fri, Nov 19, 2010 at 11:18 PM, Christopher Browne
<cbbrowne at ca.afilias.info> wrote:
> Stuart Bishop <stuart at stuartbishop.net> writes:
>> The other thing I bumped into the other day - there is no way to get
>> slonik to emit the current date/time. I've got scripts running against
>> staging environments that I'd like to get timings for so we can plan
>> production updates properly. At the moment, I can only get the timing
>> of the entire script.
>
> You're thinking of something like
> ? ECHO 'Step 17 finished';
> ? DATE;
> ?
>
> That seems pretty plausible, and I can't imagine it would be
> particularly difficult to implement.

Yes please.

-- 
Stuart Bishop <stuart at stuartbishop.net>
http://www.stuartbishop.net/

From devrim at gunduz.org  Fri Nov 19 12:41:01 2010
From: devrim at gunduz.org (Devrim =?ISO-8859-1?Q?G=DCND=DCZ?=)
Date: Fri, 19 Nov 2010 22:41:01 +0200
Subject: [Slony1-general] slonik usability - fewer commands to create a
 set
In-Reply-To: <4CE6DE62.4080102@ca.afilias.info>
References: <4CE6DE62.4080102@ca.afilias.info>
Message-ID: <1290199261.5475.13.camel@hp-laptop02.gunduz.org>

On Fri, 2010-11-19 at 15:30 -0500, Steve Singer wrote:

<snip>

> Do other others agree that these features are worth having?

+1 from here.

Regards,
-- 
Devrim G?ND?Z
PostgreSQL Dan??man?/Consultant, Red Hat Certified Engineer
PostgreSQL RPM Repository: http://yum.pgrpms.org
Community: devrim~PostgreSQL.org, devrim.gunduz~linux.org.tr
http://www.gunduz.org  Twitter: http://twitter.com/devrimgunduz
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 198 bytes
Desc: This is a digitally signed message part
Url : http://lists.slony.info/pipermail/slony1-general/attachments/20101119/a8a5da05/attachment.pgp 

From cbbrowne at ca.afilias.info  Fri Nov 19 13:17:25 2010
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Fri, 19 Nov 2010 16:17:25 -0500
Subject: [Slony1-general] slonik usability - fewer commands to create a
	set
In-Reply-To: <4CE6DE62.4080102@ca.afilias.info> (Steve Singer's message of
	"Fri, 19 Nov 2010 15:30:26 -0500")
References: <4CE6DE62.4080102@ca.afilias.info>
Message-ID: <87aal5ovx6.fsf@cbbrowne.afilias-int.info>

Steve Singer <ssinger at ca.afilias.info> writes:
> On the theme of improving the usability of slonik; there are a few 
> things that I feel can be done towards this.

When it comes down to deciding what things should actually get done,
I'll have some objections, but these all are plenty sufficiently
plausible to add to the Grand List.
-- 
(reverse (concatenate 'string "ofni.sailifa.ac" "@" "enworbbc"))
Christopher Browne
"Bother,"  said Pooh,  "Eeyore, ready  two photon  torpedoes  and lock
phasers on the Heffalump, Piglet, meet me in transporter room three"

From cbbrowne at ca.afilias.info  Fri Nov 19 13:21:53 2010
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Fri, 19 Nov 2010 16:21:53 -0500
Subject: [Slony1-general] Slonik Awareness of Cluster State
In-Reply-To: <AANLkTi==h6VG+p55JjQOmQx4ShUJn4JwH+X1_Z-AvRVT@mail.gmail.com>
	(Stuart Bishop's message of "Sat, 20 Nov 2010 03:39:26 +0700")
References: <87pqu3r4fj.fsf@cbbrowne.afilias-int.info>
	<AANLkTinbG0B__OunPuXPfJ_uq2SAq=pYnio0V40oB_Dv@mail.gmail.com>
	<87lj4qr3sf.fsf_-_@cbbrowne.afilias-int.info>
	<AANLkTimETMqzfwVcq4KorhMdibkT4V_ecQqZF9diFK3w@mail.gmail.com>
	<87vd3tp9qq.fsf@cbbrowne.afilias-int.info>
	<AANLkTi==h6VG+p55JjQOmQx4ShUJn4JwH+X1_Z-AvRVT@mail.gmail.com>
Message-ID: <8762vtovpq.fsf@cbbrowne.afilias-int.info>

Stuart Bishop <stuart at stuartbishop.net> writes:
> On Fri, Nov 19, 2010 at 11:18 PM, Christopher Browne
> <cbbrowne at ca.afilias.info> wrote:
>> Stuart Bishop <stuart at stuartbishop.net> writes:
>>> The other thing I bumped into the other day - there is no way to get
>>> slonik to emit the current date/time. I've got scripts running against
>>> staging environments that I'd like to get timings for so we can plan
>>> production updates properly. At the moment, I can only get the timing
>>> of the entire script.
>>
>> You're thinking of something like
>> ? ECHO 'Step 17 finished';
>> ? DATE;
>> ?
>>
>> That seems pretty plausible, and I can't imagine it would be
>> particularly difficult to implement.
>
> Yes please.

Splendid, that's on the list.

FYI, I'm publishing a copy on the web site for now:
  <http://main.slony.info/Slony%203%20Feature%20Ideas.mm.html>

Some time next week, I'll turn it into Wiki pages, and stow it on the
Postgres development site, as that seems like a reasonable place for
shared editing of such material.
-- 
(reverse (concatenate 'string "ofni.sailifa" "@" "enworbbc"))
Christopher Browne
"Bother,"  said Pooh,  "Eeyore, ready  two photon  torpedoes  and lock
phasers on the Heffalump, Piglet, meet me in transporter room three"

From ssinger at ca.afilias.info  Fri Nov 19 14:31:11 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Fri, 19 Nov 2010 17:31:11 -0500
Subject: [Slony1-general] Slony1 1.2.22 RC 1 released
Message-ID: <4CE6FAAF.5070904@ca.afilias.info>

Release candidate 1 for slony1-1.2.22 is available on the website.

This release includes:

-Bug #118 -  Use TRUNCATE ONLY when cleaning out tables on subscribers 
in versions of Postgresql that require it.

-Explicit support for version 9.0

-Removing obsolete EXTERNALLENGTH for 8.4 and 9.0

-Bug # 138 - Fix syntax in autoconf m4 file to define GROFF

- Fix for bug #159, distclean deletes the slony_logshipper flex/bison 
generated files.

I encourage people to check out the release candidate and report  both 
successes and failures.

Packagers (RPM, .deb, freebsd) in particular should try packaging this 
release candidate *during* the release candidate period.  This is the 
first release of 1.2.x since we migrated to git and issues with their 
might be some remaining issues with the build scripts.



From jaime at 2ndquadrant.com  Fri Nov 19 16:36:43 2010
From: jaime at 2ndquadrant.com (Jaime Casanova)
Date: Fri, 19 Nov 2010 19:36:43 -0500
Subject: [Slony1-general] postgres 8.4 supported by slony 1.2.21?
In-Reply-To: <1290199007.5475.10.camel@hp-laptop02.gunduz.org>
References: <AANLkTik8zaf8YK-_QNHwhva7i1mupzgx=Oyraw__LM0j@mail.gmail.com>
	<AANLkTimBSrgF7DPdf32T3o_R89Z3U1SJ3pHOS9vR=xeW@mail.gmail.com>
	<4CE3FDB9.3000400@ca.afilias.info>
	<AANLkTinThG9Kp9c0fug8PFuBdjaMiDkFJmCV02wk6whC@mail.gmail.com>
	<1290036317.7107.14.camel@hp-laptop02.gunduz.org>
	<AANLkTikjnb=0C1TgMC0NvkOfkHFRnfYOPLtRb0fqX5ev@mail.gmail.com>
	<1290199007.5475.10.camel@hp-laptop02.gunduz.org>
Message-ID: <AANLkTikT8ODyfiSfT5-s0pmp9=GY1mN4eh=oi+J=f9GF@mail.gmail.com>

2010/11/19 Devrim G?ND?Z <devrim at gunduz.org>:
> On Thu, 2010-11-18 at 07:55 -0500, Jaime Casanova wrote:
>> what i did to solve this...
>>
>> download pg 9 sources and recompile using pg_config --configure
>> installed by pgdg repo (hope that put things in the same place and
>> that yum doesn't get confused if i try to remove)
>
> FWIW, both 2.0.X and 1.2.X are available in RPM repository.
>

ok, i will give it a try. thanks

-- 
Jaime Casanova? ? ? ?? www.2ndQuadrant.com
Professional PostgreSQL: Soporte y capacitaci?n de PostgreSQL

From brianf at consistentstate.com  Mon Nov 22 08:45:52 2010
From: brianf at consistentstate.com (Brian Fehrle)
Date: Mon, 22 Nov 2010 09:45:52 -0700
Subject: [Slony1-general] Slony unable to write to archive file. Replication
	halted.
Message-ID: <4CEA9E40.6050806@consistentstate.com>

Hi all,
	I have a slony master to slave set up, on slony 1.2.20 and postgres 8.4.2. It is set up so that the slave daemon also writes everything out to an archive file with the -x command on the slon daemon. Just a bit ago, I started getting this message in the slave daemon log:

2010-11-22 08:04:10 PST DEBUG2 remoteWorkerThread_1: SYNC 1317332 processing
2010-11-22 08:04:10 PST ERROR  remoteWorkerThread_1: Cannot open archive file /usr/local/pgsql/slon_logs/slony1_log_2_00000000000001092631.sql.tmp - Too many open files
2010-11-22 08:04:10 PST DEBUG2 remoteListenThread_1: queue event 1,1317688 SYNC
2010-11-22 08:04:31 PST DEBUG1 cleanupThread:    0.002 seconds for cleanupEvent()
2010-11-22 08:04:31 PST DEBUG1 cleanupThread:    0.002 seconds for delete logs
2010-11-22 08:04:31 PST DEBUG3 cleanupThread: minxid: 4780671
2010-11-22 08:04:31 PST DEBUG2 cleanupThread:    0.188 seconds for vacuuming
2010-11-22 08:05:10 PST DEBUG2 remoteWorkerThread_1: SYNC 1317332 processing
2010-11-22 08:05:10 PST ERROR  remoteWorkerThread_1: Cannot open archive file /usr/local/pgsql/slon_logs/slony1_log_2_00000000000001092631.sql.tmp - Too many open files	
2010-11-22 08:05:10 PST DEBUG2 remoteListenThread_1: queue event 1,1317689 SYNC


The file exists, has the same permissions as all my other archive files, but is empty. I restarted the slon daemons, but now I don't get any error messages from the daemon log, and just get:

(many many lines of simple entry - Finished number) 
2010-11-22 08:39:23 PST DEBUG4 simple entry - 25055376
2010-11-22 08:39:23 PST DEBUG4 Finished number: 25057024
2010-11-22 08:39:23 PST DEBUG4 simple entry - 25057867
2010-11-22 08:39:23 PST DEBUG4 simple entry - 25057024
2010-11-22 08:39:23 PST DEBUG2 slon: child terminated status: 11; pid: 24931, current worker pid: 24931
2010-11-22 08:39:23 PST DEBUG1 slon: restart of worker in 10 seconds

And it just loops. I also removed that empty file and a new one is created, but is also empty. 


Anyone know what could have caused this? The only think I know of that was going on was adding additional replication sets to the slony cluster at the time. I am thinking it may be more of a linux thing with too many open files rather than postgres/slony, as I haven't found anything related to slony/postgres when googling around for these errors.

Thanks in advance for any feedback,
- Brian F


From cbbrowne at ca.afilias.info  Mon Nov 22 09:31:08 2010
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Mon, 22 Nov 2010 12:31:08 -0500
Subject: [Slony1-general] Slony unable to write to archive file.
	Replication halted.
In-Reply-To: <4CEA9E40.6050806@consistentstate.com> (Brian Fehrle's message of
	"Mon, 22 Nov 2010 09:45:52 -0700")
References: <4CEA9E40.6050806@consistentstate.com>
Message-ID: <871v6dp8o3.fsf@cbbrowne.afilias-int.info>

Brian Fehrle <brianf at consistentstate.com> writes:
> Anyone know what could have caused this? The only think I know of that was going on was adding additional replication sets to the slony cluster at the time. I am thinking it may be more of a linux thing with too many open files rather than postgres/slony, as I haven't found anything related to slony/postgres when googling around for these errors.
>
> Thanks in advance for any feedback,

You might check the output of "ulimit -a" on your system, as that should
list limits.

cbbrowne at cbbrowne [12:23:35] [~/architecture] [master *]
-> % ulimit -a
-t: cpu time (seconds)         unlimited
-f: file size (blocks)         unlimited
-d: data seg size (kbytes)     unlimited
-s: stack size (kbytes)        8192
-c: core file size (blocks)    0
-m: resident set size (kbytes) unlimited
-u: processes                  unlimited
-n: file descriptors           1024
-l: locked-in-memory size (kb) 64
-v: address space (kb)         unlimited
-x: file locks                 unlimited
-i: pending signals            16382
-q: bytes in POSIX msg queues  819200
-e: max nice                   0
-r: max rt priority            0

On my system, the number of file descriptors is limited to 1024, by
default.  (These parms are commonly overridable, with some
OS-specificity.)

1024 isn't exactly a small number of files, so it's a bit of a surprise
to get hit by this.  If you're running database backends and slons under
a single postgres user, it's conceivable that the competition might be
heading towards the limit, though 1024 is a pretty large limit.

- I haven't had call to search for file descriptor usage, so you'll need
  to research how to do that ;-).  Presumably it can be monitored.

- Perhaps it could help to set up a "slony" Linux user, and run slons in
  that context; that gives an extra 1024 descriptors.

- If there's a process that's chewing up file descriptors and not
  returning that, it would be hugely useful to identify that.  Perhaps
  there's a bug in something.  It's conceivable for it to be the slons,
  but other causes can't be ruled out.
-- 
"cbbrowne","@","afilias.info"
Christopher Browne
"Bother,"  said Pooh,  "Eeyore, ready  two photon  torpedoes  and lock
phasers on the Heffalump, Piglet, meet me in transporter room three"

From brianf at consistentstate.com  Mon Nov 22 09:42:43 2010
From: brianf at consistentstate.com (Brian Fehrle)
Date: Mon, 22 Nov 2010 10:42:43 -0700
Subject: [Slony1-general] Slony unable to write to archive file.
 Replication halted. [resolved]
In-Reply-To: <871v6dp8o3.fsf@cbbrowne.afilias-int.info>
References: <4CEA9E40.6050806@consistentstate.com>
	<871v6dp8o3.fsf@cbbrowne.afilias-int.info>
Message-ID: <4CEAAB93.2030009@consistentstate.com>

Thanks for your reply Christopher, however moments before I found the 
problem.

This is a result of the bug # 55 that was fixed in version 1.2.21. 
Here's where I found it. http://bugs.slony.info/bugzilla/show_bug.cgi?id=55

I did the same as the author stated, I restarted my daemons with setting 
the debug level to 0 and after about 2 minutes replication started 
working again.

So all is good. Thanks again. I'll be pushing the box owners to upgrade 
to 1.2.21 even more now.

- Brian F

Christopher Browne wrote:
> Brian Fehrle <brianf at consistentstate.com> writes:
>   
>> Anyone know what could have caused this? The only think I know of that was going on was adding additional replication sets to the slony cluster at the time. I am thinking it may be more of a linux thing with too many open files rather than postgres/slony, as I haven't found anything related to slony/postgres when googling around for these errors.
>>
>> Thanks in advance for any feedback,
>>     
>
> You might check the output of "ulimit -a" on your system, as that should
> list limits.
>
> cbbrowne at cbbrowne [12:23:35] [~/architecture] [master *]
> -> % ulimit -a
> -t: cpu time (seconds)         unlimited
> -f: file size (blocks)         unlimited
> -d: data seg size (kbytes)     unlimited
> -s: stack size (kbytes)        8192
> -c: core file size (blocks)    0
> -m: resident set size (kbytes) unlimited
> -u: processes                  unlimited
> -n: file descriptors           1024
> -l: locked-in-memory size (kb) 64
> -v: address space (kb)         unlimited
> -x: file locks                 unlimited
> -i: pending signals            16382
> -q: bytes in POSIX msg queues  819200
> -e: max nice                   0
> -r: max rt priority            0
>
> On my system, the number of file descriptors is limited to 1024, by
> default.  (These parms are commonly overridable, with some
> OS-specificity.)
>
> 1024 isn't exactly a small number of files, so it's a bit of a surprise
> to get hit by this.  If you're running database backends and slons under
> a single postgres user, it's conceivable that the competition might be
> heading towards the limit, though 1024 is a pretty large limit.
>
> - I haven't had call to search for file descriptor usage, so you'll need
>   to research how to do that ;-).  Presumably it can be monitored.
>
> - Perhaps it could help to set up a "slony" Linux user, and run slons in
>   that context; that gives an extra 1024 descriptors.
>
> - If there's a process that's chewing up file descriptors and not
>   returning that, it would be hugely useful to identify that.  Perhaps
>   there's a bug in something.  It's conceivable for it to be the slons,
>   but other causes can't be ruled out.
>   


From vivek at khera.org  Mon Nov 22 10:09:51 2010
From: vivek at khera.org (Vick Khera)
Date: Mon, 22 Nov 2010 13:09:51 -0500
Subject: [Slony1-general] Slony unable to write to archive file.
 Replication halted.
In-Reply-To: <871v6dp8o3.fsf@cbbrowne.afilias-int.info>
References: <4CEA9E40.6050806@consistentstate.com>
	<871v6dp8o3.fsf@cbbrowne.afilias-int.info>
Message-ID: <AANLkTimfqbJoMy9LYAf0cdZ9CduTFMGtY682DCC_k-58@mail.gmail.com>

On Mon, Nov 22, 2010 at 12:31 PM, Christopher Browne
<cbbrowne at ca.afilias.info> wrote:
> 1024 isn't exactly a small number of files, so it's a bit of a surprise
> to get hit by this. ?If you're running database backends and slons under
> a single postgres user, it's conceivable that the competition might be
> heading towards the limit, though 1024 is a pretty large limit.

The error doesn't distinguish between process (or user) out of file
handles and system out of file handles.  I've had the latter happen to
me.  For all we know the whole system was out of file handles.

From cbbrowne at ca.afilias.info  Mon Nov 22 13:00:25 2010
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Mon, 22 Nov 2010 16:00:25 -0500
Subject: [Slony1-general] Features Summarized
Message-ID: <877hg5kr9y.fsf@cbbrowne.afilias-int.info>

I have taken the features discussed thus far, along with outstanding bug
reports that are of a "featureful nature," and put them in as a wiki
page on the PostgreSQL developers wiki, here:
  <http://wiki.postgresql.org/wiki/SlonyToDo>

None of them represent promises; they're just some more-or-less
promising ideas of things that might improve the usability of Slony-I.
In early December, the set of us at Afilias are planning to try to
figure out which are more than just promising, with a view to have that
guide our development efforts in 2011.

I thought Jan had some ideas to present to allow community discussion
about some deeper features to take place before the December meetings,
but it looks as though I may have been mistaken.
-- 
select 'cbbrowne' || '@' || 'ca.afilias.info';
Christopher Browne
"Bother,"  said Pooh,  "Eeyore, ready  two photon  torpedoes  and lock
phasers on the Heffalump, Piglet, meet me in transporter room three"

From brianf at consistentstate.com  Mon Nov 22 13:09:52 2010
From: brianf at consistentstate.com (Brian Fehrle)
Date: Mon, 22 Nov 2010 14:09:52 -0700
Subject: [Slony1-general] Upgrading from 1.2.20 to 1.2.21 is easy,
 but what about remote nodes with log shipping?
Message-ID: <4CEADC20.1090008@consistentstate.com>

Hi all,

I am going to be upgrading slony cluster from 1.2.20 to 1.2.21 here 
soon, however before doing it I have some concerns.

My cluster is a simple master to slave, however my slave daemon is 
writing out to archive files, which I am shipping to dozens of other 
nodes via log shipping. I've got the process down and tested it on some 
test boxes to upgrade and that works fine, however I'm wondering if the 
upgrade will cause the remote nodes to suddenly not be able to apply the 
archive logs being shipped to them. I am hoping that since this is a 
minor upgrade (20 -> 21), I would be surprised if this upgrade made any 
major modifications such as this, but I want to be sure.

 I don't think the remote nodes even have slony installed, they just 
have a dump of the slave database from when the nodes were set up from a 
modified version of the slon1_dump.sh file, which I believe is setting 
up the schema and environment they need (such as the _slony schema and 
functions). However I could be wrong on this.

So long story short, upgrading from 1.2.20 to 1.2.21, will I need to 
push any updates to my remote boxes that are not part of the actual 
cluster, but just feeding off the archive logs created.

Thanks in advance,
    - Brian F

From stuart at stuartbishop.net  Tue Nov 23 00:05:34 2010
From: stuart at stuartbishop.net (Stuart Bishop)
Date: Tue, 23 Nov 2010 15:05:34 +0700
Subject: [Slony1-general] Slonik Awareness of Cluster State (was
 Automatic WAIT FOR EVENT)
In-Reply-To: <AANLkTikWUo_nRvug71gkAxUqoP3K2=_AdQL9afHCwukf@mail.gmail.com>
References: <87pqu3r4fj.fsf@cbbrowne.afilias-int.info>
	<AANLkTinbG0B__OunPuXPfJ_uq2SAq=pYnio0V40oB_Dv@mail.gmail.com>
	<87lj4qr3sf.fsf_-_@cbbrowne.afilias-int.info>
	<AANLkTimETMqzfwVcq4KorhMdibkT4V_ecQqZF9diFK3w@mail.gmail.com>
	<AANLkTikWUo_nRvug71gkAxUqoP3K2=_AdQL9afHCwukf@mail.gmail.com>
Message-ID: <AANLkTinY5ftUWV7K-DZyO+ptJJgnA+kgMBt_QujBdxiC@mail.gmail.com>

On Fri, Nov 19, 2010 at 9:44 PM, Vick Khera <vivek at khera.org> wrote:
> On Fri, Nov 19, 2010 at 4:28 AM, Stuart Bishop <stuart at stuartbishop.net> wrote:
>>> That suggests to me there being some value to having some sort of "fail
>>> if not sufficiently up to date" command.
>>
>> Pretty much all my canned scripts start by issuing a sync and waiting
>> for it. I think it is dangerous to do otherwise. Failing with a
>> meaningful error rather than leaving sysadmins staring at a blinking
>> prompt would be preferable.
>
> Nice. What does this look like in the script?

echo 'Waiting for cluster to sync. If this blocks, check for long
running transactions and working slon daemons.';
SYNC (id=@master_node);
WAIT FOR EVENT (origin=@master_node, wait on=@master_node, confirmed=ALL);
echo 'Synced.';









-- 
Stuart Bishop <stuart at stuartbishop.net>
http://www.stuartbishop.net/

From stuart at stuartbishop.net  Tue Nov 23 02:01:41 2010
From: stuart at stuartbishop.net (Stuart Bishop)
Date: Tue, 23 Nov 2010 17:01:41 +0700
Subject: [Slony1-general] Features Summarized
In-Reply-To: <877hg5kr9y.fsf@cbbrowne.afilias-int.info>
References: <877hg5kr9y.fsf@cbbrowne.afilias-int.info>
Message-ID: <AANLkTi=BWGybi1ueGzzFebCK_25EU4=kVkQ9x4vP3WZT@mail.gmail.com>

On Tue, Nov 23, 2010 at 4:00 AM, Christopher Browne
<cbbrowne at ca.afilias.info> wrote:
> I have taken the features discussed thus far, along with outstanding bug
> reports that are of a "featureful nature," and put them in as a wiki
> page on the PostgreSQL developers wiki, here:
> ?<http://wiki.postgresql.org/wiki/SlonyToDo>
>
> None of them represent promises; they're just some more-or-less
> promising ideas of things that might improve the usability of Slony-I.
> In early December, the set of us at Afilias are planning to try to
> figure out which are more than just promising, with a view to have that
> guide our development efforts in 2011.
>
> I thought Jan had some ideas to present to allow community discussion
> about some deeper features to take place before the December meetings,
> but it looks as though I may have been mistaken.

I'm still interested in making my applications cooperate better with
Slony locking.

The idea discussed on the mailing list is to have Slony take out an
advisory lock before attempting to lock tables and releasing that lock
afterwards. At the start of a transaction, my application would block
until that advisory lock is available. This way, Slony can actually be
granted locks on a busy system. Currently, in some situations Slony
will never be granted the locks because there is always at least one
transaction in progress reading the resources it is attempting to
lock.

I imagine this behavior would only occur if the site has configured
which number to use as the lock.

-- 
Stuart Bishop <stuart at stuartbishop.net>
http://www.stuartbishop.net/

From ssinger at ca.afilias.info  Tue Nov 23 06:10:30 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Tue, 23 Nov 2010 09:10:30 -0500
Subject: [Slony1-general] Features Summarized
In-Reply-To: <AANLkTi=BWGybi1ueGzzFebCK_25EU4=kVkQ9x4vP3WZT@mail.gmail.com>
References: <877hg5kr9y.fsf@cbbrowne.afilias-int.info>
	<AANLkTi=BWGybi1ueGzzFebCK_25EU4=kVkQ9x4vP3WZT@mail.gmail.com>
Message-ID: <4CEBCB56.3070709@ca.afilias.info>

On 10-11-23 05:01 AM, Stuart Bishop wrote:
> On Tue, Nov 23, 2010 at 4:00 AM, Christopher Browne
> <cbbrowne at ca.afilias.info>  wrote:
> The idea discussed on the mailing list is to have Slony take out an
> advisory lock before attempting to lock tables and releasing that lock
> afterwards. At the start of a transaction, my application would block
> until that advisory lock is available. This way, Slony can actually be
> granted locks on a busy system. Currently, in some situations Slony
> will never be granted the locks because there is always at least one
> transaction in progress reading the resources it is attempting to
> lock.
>
> I imagine this behavior would only occur if the site has configured
> which number to use as the lock.
>

I've added this to the wiki page along with a link to the prior email 
discussion mentioning this.

From ssinger at ca.afilias.info  Tue Nov 23 06:31:33 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Tue, 23 Nov 2010 09:31:33 -0500
Subject: [Slony1-general] Feature Idea: improve performance when a large
	sl_log backlog exists
Message-ID: <4CEBD045.3070905@ca.afilias.info>

This idea is to try and deal with the following problem.

A user has a multi-node cluster and needs to bring one of the nodes down 
for a while (say a few day).  During this time slony collects the 
transactions to replicate in sl_log_1 and sl_log_2.

The problem is that sl_log_1 or sl_log_2 will bloat to be very big. 
Generating SYNC's will take a lot longer and reading SYNC's for other 
nodes can take a lot longer.



Slony can get into a state where it can't keep up/catch up with 
replication because the sl_log table is so large.


Does this problem bite people often enough in the real world for us to 
devote effort to fixing?

If instead of having 2 sl_log tables we could have a dynamic number of 
them.   During a log switch if no sl_log table is ready to be truncated 
we could instead create a new one.

This would complicate the  logic where we select from sl_log_1 and UNION 
with sl_log_2.


From vivek at khera.org  Tue Nov 23 06:48:33 2010
From: vivek at khera.org (Vick Khera)
Date: Tue, 23 Nov 2010 09:48:33 -0500
Subject: [Slony1-general] Feature Idea: improve performance when a large
 sl_log backlog exists
In-Reply-To: <4CEBD045.3070905@ca.afilias.info>
References: <4CEBD045.3070905@ca.afilias.info>
Message-ID: <AANLkTinX9U+29N6hsWfCaPFXfQoz61NVEE+DErtmxqU0@mail.gmail.com>

On Tue, Nov 23, 2010 at 9:31 AM, Steve Singer <ssinger at ca.afilias.info> wrote:
> Slony can get into a state where it can't keep up/catch up with
> replication because the sl_log table is so large.
>
>
> Does this problem bite people often enough in the real world for us to
> devote effort to fixing?
>

It used to happen to me a lot when I had my origin running on spinning
media.  Ever since I moved to an SSD, it doesn't really happen.  At
worst when I do a large delete I fall behind by a few minutes but it
catches up quickly.  For me, it didn't even require taking the DB down
for any extended period.. just running a large update or delete that
touched many many rows (ie, generated a lot of events in sl_log) could
send the system into a tailspin that would take hours or possibly days
(until we hit a weekend) to recover.

I am not sure it was caused by the log being too big... because
sometimes reindexing the tables on the replica would clear up the
backlog quickly too.  But I may be sniffing down the wrong trail.

From ssinger at ca.afilias.info  Tue Nov 23 08:15:28 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Tue, 23 Nov 2010 11:15:28 -0500
Subject: [Slony1-general] Feature Idea: improve performance when a large
 sl_log backlog exists
In-Reply-To: <AANLkTinX9U+29N6hsWfCaPFXfQoz61NVEE+DErtmxqU0@mail.gmail.com>
References: <4CEBD045.3070905@ca.afilias.info>
	<AANLkTinX9U+29N6hsWfCaPFXfQoz61NVEE+DErtmxqU0@mail.gmail.com>
Message-ID: <4CEBE8A0.6000908@ca.afilias.info>

On 10-11-23 09:48 AM, Vick Khera wrote:
> On Tue, Nov 23, 2010 at 9:31 AM, Steve Singer<ssinger at ca.afilias.info>  wrote:
>> Slony can get into a state where it can't keep up/catch up with
>> replication because the sl_log table is so large.
>>
>>
>> Does this problem bite people often enough in the real world for us to
>> devote effort to fixing?
>>
>
> It used to happen to me a lot when I had my origin running on spinning
> media.  Ever since I moved to an SSD, it doesn't really happen.  At
> worst when I do a large delete I fall behind by a few minutes but it
> catches up quickly.  For me, it didn't even require taking the DB down
> for any extended period.. just running a large update or delete that
> touched many many rows (ie, generated a lot of events in sl_log) could
> send the system into a tailspin that would take hours or possibly days
> (until we hit a weekend) to recover.
>
> I am not sure it was caused by the log being too big... because
> sometimes reindexing the tables on the replica would clear up the
> backlog quickly too.  But I may be sniffing down the wrong trail.
>

The other place this will hit busy systems is during the initial sync.
If your database is very large (or very busy) a lot of log rows can 
accumulate while that initial sync is going on.   OMIT_COPY doesn't help 
you because it requires an outage to get the master and slave in sync 
(just the loading time on a 1TB database is a while).

CLONE PREPARE/FINISH also aren't of help because a) these only work if 
you already have at least 1 subscriber setup and b) after you do the 
clone prepare any later transactions still need to be kept in sl_log 
until the new slave is up and running.




_______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


From cbbrowne at ca.afilias.info  Tue Nov 23 08:19:50 2010
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Tue, 23 Nov 2010 11:19:50 -0500
Subject: [Slony1-general] Slonik Awareness of Cluster State
In-Reply-To: <AANLkTinY5ftUWV7K-DZyO+ptJJgnA+kgMBt_QujBdxiC@mail.gmail.com>
	(Stuart Bishop's message of "Tue, 23 Nov 2010 15:05:34 +0700")
References: <87pqu3r4fj.fsf@cbbrowne.afilias-int.info>
	<AANLkTinbG0B__OunPuXPfJ_uq2SAq=pYnio0V40oB_Dv@mail.gmail.com>
	<87lj4qr3sf.fsf_-_@cbbrowne.afilias-int.info>
	<AANLkTimETMqzfwVcq4KorhMdibkT4V_ecQqZF9diFK3w@mail.gmail.com>
	<AANLkTikWUo_nRvug71gkAxUqoP3K2=_AdQL9afHCwukf@mail.gmail.com>
	<AANLkTinY5ftUWV7K-DZyO+ptJJgnA+kgMBt_QujBdxiC@mail.gmail.com>
Message-ID: <8739qsko61.fsf@cbbrowne.afilias-int.info>

Stuart Bishop <stuart at stuartbishop.net> writes:
> On Fri, Nov 19, 2010 at 9:44 PM, Vick Khera <vivek at khera.org> wrote:
>> On Fri, Nov 19, 2010 at 4:28 AM, Stuart Bishop <stuart at stuartbishop.net> wrote:
>>>> That suggests to me there being some value to having some sort of "fail
>>>> if not sufficiently up to date" command.
>>>
>>> Pretty much all my canned scripts start by issuing a sync and waiting
>>> for it. I think it is dangerous to do otherwise. Failing with a
>>> meaningful error rather than leaving sysadmins staring at a blinking
>>> prompt would be preferable.
>>
>> Nice. What does this look like in the script?
>
> echo 'Waiting for cluster to sync. If this blocks, check for long
> running transactions and working slon daemons.';
> SYNC (id=@master_node);
> WAIT FOR EVENT (origin=@master_node, wait on=@master_node, confirmed=ALL);
> echo 'Synced.';

Hmm.  That would be nicely enhanced by some form of 
 ABORT( some specified cluster condition );

If things are up to date, you can continue, but terminate cleanly,
early, if things aren't up to date.

  <http://wiki.postgresql.org/wiki/SlonyToDo#ABORT>
-- 
(reverse (concatenate 'string "ofni.sailifa" "@" "enworbbc"))
Christopher Browne
"Bother,"  said Pooh,  "Eeyore, ready  two photon  torpedoes  and lock
phasers on the Heffalump, Piglet, meet me in transporter room three"

From cbbrowne at ca.afilias.info  Tue Nov 23 08:53:33 2010
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Tue, 23 Nov 2010 11:53:33 -0500
Subject: [Slony1-general] Feature Idea: improve performance when a large
	sl_log backlog exists
In-Reply-To: <4CEBE8A0.6000908@ca.afilias.info> (Steve Singer's message of
	"Tue, 23 Nov 2010 11:15:28 -0500")
References: <4CEBD045.3070905@ca.afilias.info>
	<AANLkTinX9U+29N6hsWfCaPFXfQoz61NVEE+DErtmxqU0@mail.gmail.com>
	<4CEBE8A0.6000908@ca.afilias.info>
Message-ID: <87tyj8j81e.fsf@cbbrowne.afilias-int.info>

Steve Singer <ssinger at ca.afilias.info> writes:
> On 10-11-23 09:48 AM, Vick Khera wrote:
>> On Tue, Nov 23, 2010 at 9:31 AM, Steve Singer<ssinger at ca.afilias.info>  wrote:
>>> Slony can get into a state where it can't keep up/catch up with
>>> replication because the sl_log table is so large.
>>>
>>>
>>> Does this problem bite people often enough in the real world for us to
>>> devote effort to fixing?
>>>
>>
>> It used to happen to me a lot when I had my origin running on spinning
>> media.  Ever since I moved to an SSD, it doesn't really happen.  At
>> worst when I do a large delete I fall behind by a few minutes but it
>> catches up quickly.  For me, it didn't even require taking the DB down
>> for any extended period.. just running a large update or delete that
>> touched many many rows (ie, generated a lot of events in sl_log) could
>> send the system into a tailspin that would take hours or possibly days
>> (until we hit a weekend) to recover.
>>
>> I am not sure it was caused by the log being too big... because
>> sometimes reindexing the tables on the replica would clear up the
>> backlog quickly too.  But I may be sniffing down the wrong trail.
>>
>
> The other place this will hit busy systems is during the initial sync.
> If your database is very large (or very busy) a lot of log rows can 
> accumulate while that initial sync is going on.   OMIT_COPY doesn't help 
> you because it requires an outage to get the master and slave in sync 
> (just the loading time on a 1TB database is a while).
>
> CLONE PREPARE/FINISH also aren't of help because a) these only work if 
> you already have at least 1 subscriber setup and b) after you do the 
> clone prepare any later transactions still need to be kept in sl_log 
> until the new slave is up and running.

I'm not sure that we gain much by splitting the logs into a bunch of
pieces for that case.

It's still the same huge backlog, and until it gets worked down, it's
bloated, period.

A different suggestion, that doesn't involve any changes to Slony...

Initially, it might be a good idea to set up the new subscriber with
FORWARD=no...

   subscribe set (id=1, provider=1, receiver=2,forward=no);

That means that log data won't get captured in sl_log_(1|2) on the
subscriber for a while, while the subscription is catching up.  Once
it's reasonably caught up, you submit:

   subscribe set (id=1, provider=1, receiver=2,forward=yes);

which turns that logging on, so that the new node becomes a failover
target and a legitimate target to feed other subscriptions.

While node #2 is catching up, it's a crummy candidate for a failover
target, so while this strategy *altogether* loses the ability for it to
be a failover target while catching up, remember that it was moving from
18-ish hours behind towards caught up, which represented a crummy
failover target.  I don't think something hugely useful is being lost,
here.
-- 
select 'cbbrowne' || '@' || 'ca.afilias.info';
Christopher Browne
"Bother,"  said Pooh,  "Eeyore, ready  two photon  torpedoes  and lock
phasers on the Heffalump, Piglet, meet me in transporter room three"

From ssinger at ca.afilias.info  Tue Nov 23 09:49:35 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Tue, 23 Nov 2010 12:49:35 -0500
Subject: [Slony1-general] Feature Idea: improve performance when a large
 sl_log backlog exists
In-Reply-To: <87tyj8j81e.fsf@cbbrowne.afilias-int.info>
References: <4CEBD045.3070905@ca.afilias.info>	<AANLkTinX9U+29N6hsWfCaPFXfQoz61NVEE+DErtmxqU0@mail.gmail.com>	<4CEBE8A0.6000908@ca.afilias.info>
	<87tyj8j81e.fsf@cbbrowne.afilias-int.info>
Message-ID: <4CEBFEAF.3070303@ca.afilias.info>

On 10-11-23 11:53 AM, Christopher Browne wrote:
>
> I'm not sure that we gain much by splitting the logs into a bunch of
> pieces for that case.
>
> It's still the same huge backlog, and until it gets worked down, it's
> bloated, period.

My concern is with the performance on the master (and any other slaves) 
caused by the bloat not the slave being populated.

Right now sl_log_1 can grow to be gigabytes on the master.  Each time 
the sync thread on the master needs to select from sl_log_1 to generate 
a sync it queries a table that is gigabytes in size.  Similarly when any 
other slaves need to select from sl_log_1 against the master they need 
to query a table that is gigabytes.

With having a  growable pool of sl_log tables my thinking is that once 
all transactions using sl_log_x have committed we can do a final sync 
against sl_log_x and then sync thread no longer needs to access it. 
Similarly other subscribers that querying the the master could be made 
smart enough to not need to look at sl_log segments for which they have 
already received all of the data.


This way the bloat caused by backlog won't effect the performance of 
normal (up-to-date) syncs.



>
> A different suggestion, that doesn't involve any changes to Slony...
>
> Initially, it might be a good idea to set up the new subscriber with
> FORWARD=no...
>
>     subscribe set (id=1, provider=1, receiver=2,forward=no);
>
> That means that log data won't get captured in sl_log_(1|2) on the
> subscriber for a while, while the subscription is catching up.  Once
> it's reasonably caught up, you submit:
>
>     subscribe set (id=1, provider=1, receiver=2,forward=yes);
>
> which turns that logging on, so that the new node becomes a failover
> target and a legitimate target to feed other subscriptions.
>
> While node #2 is catching up, it's a crummy candidate for a failover
> target, so while this strategy *altogether* loses the ability for it to
> be a failover target while catching up, remember that it was moving from
> 18-ish hours behind towards caught up, which represented a crummy
> failover target.  I don't think something hugely useful is being lost,
> here.


From msteben at autorevenue.com  Tue Nov 23 13:12:45 2010
From: msteben at autorevenue.com (Mark Steben)
Date: Tue, 23 Nov 2010 16:12:45 -0500
Subject: [Slony1-general] install instruction
Message-ID: <20101123211301.64680290CED@main.slony.info>

Hi 

 

I might just be blind (Been accused of it many times), but I'm having
trouble

Installing slony1-2.0.5 and can't seem to find installation instructions

In www.slony.info .  I seem to get the ./configure to work but am getting

Errors on the make command.

 

If someone could point me to doc, or give me some insights relative

To slony1-2 and how installation is different from slony1-1.  I previously

Had that successfully installed.

 

Thank you,

 

Mark Steben | Database Administrator 
 <http://www.autorevenue.com> @utoRevenueR - "Keeping Customers Close" 
95D Ashley Ave, West Springfield, MA 01089 
413.243.4800 x1512 (Phone) |413.732-1824 (Fax) 
 <http://www.dominionenterprises.com> @utoRevenue is a registered trademark
and a division of Dominion Enterprises 
 

 

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20101123/53c9f313/attachment.htm 

From vivek at khera.org  Tue Nov 23 13:22:57 2010
From: vivek at khera.org (Vick Khera)
Date: Tue, 23 Nov 2010 16:22:57 -0500
Subject: [Slony1-general] install instruction
In-Reply-To: <20101123211301.64680290CED@main.slony.info>
References: <20101123211301.64680290CED@main.slony.info>
Message-ID: <AANLkTikrW=WjzFE3q9AcdMDqVSYKbWNyhj-FL7e687mL@mail.gmail.com>

On Tue, Nov 23, 2010 at 4:12 PM, Mark Steben <msteben at autorevenue.com> wrote:
> In www.slony.info .? I seem to get the ./configure to work but am getting
>
> Errors on the make command.

The rest of us are flying blind until you show the error you got...
also details like what OS you're on would be useful.

From JanWieck at Yahoo.com  Thu Nov 25 08:45:21 2010
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Thu, 25 Nov 2010 11:45:21 -0500
Subject: [Slony1-general] Feature Idea: improve performance when a large
 sl_log backlog exists
In-Reply-To: <87tyj8j81e.fsf@cbbrowne.afilias-int.info>
References: <4CEBD045.3070905@ca.afilias.info>	<AANLkTinX9U+29N6hsWfCaPFXfQoz61NVEE+DErtmxqU0@mail.gmail.com>	<4CEBE8A0.6000908@ca.afilias.info>
	<87tyj8j81e.fsf@cbbrowne.afilias-int.info>
Message-ID: <4CEE92A1.8040400@Yahoo.com>

On 11/23/2010 11:53 AM, Christopher Browne wrote:
> Steve Singer<ssinger at ca.afilias.info>  writes:
>>  On 10-11-23 09:48 AM, Vick Khera wrote:
>>>  On Tue, Nov 23, 2010 at 9:31 AM, Steve Singer<ssinger at ca.afilias.info>   wrote:
>>>>  Slony can get into a state where it can't keep up/catch up with
>>>>  replication because the sl_log table is so large.
>>>>
>>>>
>>>>  Does this problem bite people often enough in the real world for us to
>>>>  devote effort to fixing?
>>>>
>>>
>>>  It used to happen to me a lot when I had my origin running on spinning
>>>  media.  Ever since I moved to an SSD, it doesn't really happen.  At
>>>  worst when I do a large delete I fall behind by a few minutes but it
>>>  catches up quickly.  For me, it didn't even require taking the DB down
>>>  for any extended period.. just running a large update or delete that
>>>  touched many many rows (ie, generated a lot of events in sl_log) could
>>>  send the system into a tailspin that would take hours or possibly days
>>>  (until we hit a weekend) to recover.
>>>
>>>  I am not sure it was caused by the log being too big... because
>>>  sometimes reindexing the tables on the replica would clear up the
>>>  backlog quickly too.  But I may be sniffing down the wrong trail.
>>>
>>
>>  The other place this will hit busy systems is during the initial sync.
>>  If your database is very large (or very busy) a lot of log rows can
>>  accumulate while that initial sync is going on.   OMIT_COPY doesn't help
>>  you because it requires an outage to get the master and slave in sync
>>  (just the loading time on a 1TB database is a while).
>>
>>  CLONE PREPARE/FINISH also aren't of help because a) these only work if
>>  you already have at least 1 subscriber setup and b) after you do the
>>  clone prepare any later transactions still need to be kept in sl_log
>>  until the new slave is up and running.
>
> I'm not sure that we gain much by splitting the logs into a bunch of
> pieces for that case.
>
> It's still the same huge backlog, and until it gets worked down, it's
> bloated, period.

Agreed.

>
> A different suggestion, that doesn't involve any changes to Slony...
>
> Initially, it might be a good idea to set up the new subscriber with
> FORWARD=no...

I don't think it is actually the new subscriber, that is having a 
problem, but rather the fact that the origin and all forwarders keep the 
log and event data until every subscriber has confirmed it.

Let me ignore the problem of the initial COPY and catch up of the first 
replica for now.

This fully redundant log and event keeping until everyone has confirmed 
everything is done so that any subscriber can be reconfigured to use 
another data provider at any point in time, willy nilly. It also keeps 
things simple for failover. But it does hurt in the cases described, 
like taking a leaf node down for a few days.

The cure for this would be to add configuration information so that 
certain nodes will be allowed to "assume" confirmation from another node 
and go ahead with their cleanup. This certainly complicates the 
configuration, but I "assume" power users are fine with that.


Jan

-- 
Anyone who trades liberty for security deserves neither
liberty nor security. -- Benjamin Franklin

From JanWieck at Yahoo.com  Thu Nov 25 08:50:54 2010
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Thu, 25 Nov 2010 11:50:54 -0500
Subject: [Slony1-general] Feature Idea: improve performance when a large
 sl_log backlog exists
In-Reply-To: <4CEBFEAF.3070303@ca.afilias.info>
References: <4CEBD045.3070905@ca.afilias.info>	<AANLkTinX9U+29N6hsWfCaPFXfQoz61NVEE+DErtmxqU0@mail.gmail.com>	<4CEBE8A0.6000908@ca.afilias.info>	<87tyj8j81e.fsf@cbbrowne.afilias-int.info>
	<4CEBFEAF.3070303@ca.afilias.info>
Message-ID: <4CEE93EE.10808@Yahoo.com>

On 11/23/2010 12:49 PM, Steve Singer wrote:
> On 10-11-23 11:53 AM, Christopher Browne wrote:
>>
>>  I'm not sure that we gain much by splitting the logs into a bunch of
>>  pieces for that case.
>>
>>  It's still the same huge backlog, and until it gets worked down, it's
>>  bloated, period.
>
> My concern is with the performance on the master (and any other slaves)
> caused by the bloat not the slave being populated.
>
> Right now sl_log_1 can grow to be gigabytes on the master.  Each time
> the sync thread on the master needs to select from sl_log_1 to generate
> a sync it queries a table that is gigabytes in size.  Similarly when any
> other slaves need to select from sl_log_1 against the master they need
> to query a table that is gigabytes.

Since when does the SYNC generation SELECT from sl_log_x? It should only 
INSERT into sl_event and be done with it. Only the direct subscribers 
should query sl_log_x on the master.

> With having a  growable pool of sl_log tables my thinking is that once
> all transactions using sl_log_x have committed we can do a final sync
> against sl_log_x and then sync thread no longer needs to access it.
> Similarly other subscribers that querying the the master could be made
> smart enough to not need to look at sl_log segments for which they have
> already received all of the data.
>
>
> This way the bloat caused by backlog won't effect the performance of
> normal (up-to-date) syncs.

But as you noticed in another mail already, this would complicate the 
log selection union. And in more ways than may be obvious.


Jan

-- 
Anyone who trades liberty for security deserves neither
liberty nor security. -- Benjamin Franklin

From cbbrowne at ca.afilias.info  Thu Nov 25 10:53:50 2010
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Thu, 25 Nov 2010 13:53:50 -0500
Subject: [Slony1-general] Feature Idea: improve performance when a large
	sl_log backlog exists
In-Reply-To: <4CEE92A1.8040400@Yahoo.com> (Jan Wieck's message of "Thu, 25 Nov
	2010 11:45:21 -0500")
References: <4CEBD045.3070905@ca.afilias.info>
	<AANLkTinX9U+29N6hsWfCaPFXfQoz61NVEE+DErtmxqU0@mail.gmail.com>
	<4CEBE8A0.6000908@ca.afilias.info>
	<87tyj8j81e.fsf@cbbrowne.afilias-int.info>
	<4CEE92A1.8040400@Yahoo.com>
Message-ID: <87bp5djku9.fsf@cbbrowne.afilias-int.info>

Jan Wieck <JanWieck at Yahoo.com> writes:
> On 11/23/2010 11:53 AM, Christopher Browne wrote:
>> A different suggestion, that doesn't involve any changes to Slony...
>>
>> Initially, it might be a good idea to set up the new subscriber with
>> FORWARD=no...
>
> I don't think it is actually the new subscriber, that is having a
> problem, but rather the fact that the origin and all forwarders keep
> the log and event data until every subscriber has confirmed it.

Yes, that seems the root of the problem, and I don't expect it to be
worthwhile to try to twist our way around it if we're not really getting
at the root of it.

> Let me ignore the problem of the initial COPY and catch up of the
> first replica for now.

Sure.  That may be unsolvable, and if so, there's little point fighting
it futilely.

> This fully redundant log and event keeping until everyone has
> confirmed everything is done so that any subscriber can be
> reconfigured to use another data provider at any point in time, willy
> nilly. It also keeps things simple for failover. But it does hurt in
> the cases described, like taking a leaf node down for a few days.
>
> The cure for this would be to add configuration information so that
> certain nodes will be allowed to "assume" confirmation from another
> node and go ahead with their cleanup. This certainly complicates the
> configuration, but I "assume" power users are fine with that.

That all sounds pretty plausible, and worth adding as a possible
enhancement.

[mulling for a while...]

So, would this suggest setting up a "shunned nodes" table, where a node
would ignore the specified set of nodes for the purposes of
confirmations?  That sounds not *too* tough to implement.  It's a bit of
a footgun, notably as it enables losing more nodes at FAIL OVER time.

I'll add a "shunned node" idea to the list.
-- 
let name="cbbrowne" and tld="ca.afilias.info" in String.concat "@" [name;tld];;
Christopher Browne
"Bother,"  said Pooh,  "Eeyore, ready  two photon  torpedoes  and lock
phasers on the Heffalump, Piglet, meet me in transporter room three"

From ssinger at ca.afilias.info  Thu Nov 25 13:32:03 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Thu, 25 Nov 2010 16:32:03 -0500
Subject: [Slony1-general] Feature Idea: improve performance when a large
 sl_log backlog exists
In-Reply-To: <4CEE92A1.8040400@Yahoo.com>
References: <4CEBD045.3070905@ca.afilias.info>	<AANLkTinX9U+29N6hsWfCaPFXfQoz61NVEE+DErtmxqU0@mail.gmail.com>	<4CEBE8A0.6000908@ca.afilias.info>	<87tyj8j81e.fsf@cbbrowne.afilias-int.info>
	<4CEE92A1.8040400@Yahoo.com>
Message-ID: <4CEED5D3.8050902@ca.afilias.info>

On 10-11-25 11:45 AM, Jan Wieck wrote:
> On 11/23/2010 11:53 AM, Christopher Browne wrote:
>
> This fully redundant log and event keeping until everyone has confirmed
> everything is done so that any subscriber can be reconfigured to use
> another data provider at any point in time, willy nilly. It also keeps
> things simple for failover. But it does hurt in the cases described,
> like taking a leaf node down for a few days.
>
> The cure for this would be to add configuration information so that
> certain nodes will be allowed to "assume" confirmation from another node
> and go ahead with their cleanup. This certainly complicates the
> configuration, but I "assume" power users are fine with that.
>
>

Having the events immediately events as confirmed on the master solves 
the problem of the master suffering a slow down.   This means that you 
could setup your cluster with cascaded slaves and not have to worry 
about a misbehaving cascaded slave impacting the master.  Assuming you 
can live with the failover implications.  I think this stands on its own 
as a feature idea.

Will this actually solve the problem I described?  The slave (that acts 
as the forwarder) still needs to keep all of the data in sl_log.  These 
tables will grow pretty big.  Are there any performance implications for 
this slave(the forwarder)?  The queries cleanupThread performs might be 
a bit on the expensive side but other than that I can't think of any.

That still leaves the initial copy to deal with. I've also noticed that 
so far no one has yet chimed in on this thread saying that this issue is 
actually causing pain for them in the real world.



> Jan
>


From JanWieck at Yahoo.com  Fri Nov 26 12:16:33 2010
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Fri, 26 Nov 2010 15:16:33 -0500
Subject: [Slony1-general] Enhancement Proposal: Automatic WAIT FOR EVENT
In-Reply-To: <87pqu3r4fj.fsf@cbbrowne.afilias-int.info>
References: <87pqu3r4fj.fsf@cbbrowne.afilias-int.info>
Message-ID: <4CF015A1.4070509@Yahoo.com>

On 11/17/2010 5:06 PM, Christopher Browne wrote:
> A thing that several of us have been ruminating over for a while is the
> problem that people get confused about how you submit Slonik scripts,
> you may have some actions that require waits.

One major problem with automatic waiting for events is that it is 
extremely context sensitive to wait at all.

One cannot wait inside of a TRY block. The events aren't committed yet, 
so they cannot propagate.

One needs to be careful not to wait if the current path configuration is 
incomplete. You should for example never wait for the FIRST store path 
... you'd wait forever.

This all basically exposes that slonik has insufficient knowledge about 
the overall cluster configuration and healthiness. It basically fires 
off "commands" blindly. I've long been thinking that slonik itself needs 
a major overhaul. My recent experiences with the Mozilla Rhino 
JavaScript engine (Steve and I developed a cluster test framework using 
it) makes me think that actually creating a complete new slonik from 
scratch won't be too bad of an idea.


Jan

-- 
Anyone who trades liberty for security deserves neither
liberty nor security. -- Benjamin Franklin

From vivek at khera.org  Fri Nov 26 12:16:36 2010
From: vivek at khera.org (Vick Khera)
Date: Fri, 26 Nov 2010 15:16:36 -0500
Subject: [Slony1-general] Enhancement Proposal: Automatic WAIT FOR EVENT
In-Reply-To: <4CF015A1.4070509@Yahoo.com>
References: <87pqu3r4fj.fsf@cbbrowne.afilias-int.info>
	<4CF015A1.4070509@Yahoo.com>
Message-ID: <AANLkTin9Xb30AsRdZOpqup9GVApWm8ek1AV5u7OHORGL@mail.gmail.com>

On Fri, Nov 26, 2010 at 3:16 PM, Jan Wieck <JanWieck at yahoo.com> wrote:
> a major overhaul. My recent experiences with the Mozilla Rhino
> JavaScript engine (Steve and I developed a cluster test framework using
> it) makes me think that actually creating a complete new slonik from
> scratch won't be too bad of an idea.
>

just don't make java a dependency, please....

From ssinger at ca.afilias.info  Fri Nov 26 12:30:19 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Fri, 26 Nov 2010 15:30:19 -0500
Subject: [Slony1-general] Enhancement Proposal: Automatic WAIT FOR EVENT
In-Reply-To: <4CF015A1.4070509@Yahoo.com>
References: <87pqu3r4fj.fsf@cbbrowne.afilias-int.info>
	<4CF015A1.4070509@Yahoo.com>
Message-ID: <4CF018DB.8080809@ca.afilias.info>

On 10-11-26 03:16 PM, Jan Wieck wrote:
> On 11/17/2010 5:06 PM, Christopher Browne wrote:
>> A thing that several of us have been ruminating over for a while is the
>> problem that people get confused about how you submit Slonik scripts,
>> you may have some actions that require waits.
>
> One major problem with automatic waiting for events is that it is
> extremely context sensitive to wait at all.
>
> One cannot wait inside of a TRY block. The events aren't committed yet,
> so they cannot propagate.
>
> One needs to be careful not to wait if the current path configuration is
> incomplete. You should for example never wait for the FIRST store path
> ... you'd wait forever.
>
> This all basically exposes that slonik has insufficient knowledge about
> the overall cluster configuration and healthiness. It basically fires
> off "commands" blindly. I've long been thinking that slonik itself needs
> a major overhaul. My recent experiences with the Mozilla Rhino
> JavaScript engine (Steve and I developed a cluster test framework using
> it) makes me think that actually creating a complete new slonik from
> scratch won't be too bad of an idea.

What would you want to change in slonik (from the users point of view) 
if you were doing that?

When I was developing tests for the framework I spent countless hours 
debugging tests were the problem ended up being a missing or an extra 
wait for (or one against the wrong node). Expecting the average DBA to 
figure this stuff out isn't nice.   Slonik should be able to figure out 
if paths exist to the required nodes and other dependencies on the 
configuration.  I think slonik should check as many things as we can 
make and give the user useful error messages instead of 'waiting for ever'

I agree with Vick that a Java dependency for slony would be a bad idea.


>
>
> Jan
>


From cbbrowne at ca.afilias.info  Fri Nov 26 13:02:51 2010
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Fri, 26 Nov 2010 16:02:51 -0500
Subject: [Slony1-general] Enhancement Proposal: Automatic WAIT FOR EVENT
In-Reply-To: <AANLkTin9Xb30AsRdZOpqup9GVApWm8ek1AV5u7OHORGL@mail.gmail.com>
	(Vick Khera's message of "Fri, 26 Nov 2010 15:16:36 -0500")
References: <87pqu3r4fj.fsf@cbbrowne.afilias-int.info>
	<4CF015A1.4070509@Yahoo.com>
	<AANLkTin9Xb30AsRdZOpqup9GVApWm8ek1AV5u7OHORGL@mail.gmail.com>
Message-ID: <87mxoviyro.fsf@cbbrowne.afilias-int.info>

Vick Khera <vivek at khera.org> writes:
> On Fri, Nov 26, 2010 at 3:16 PM, Jan Wieck <JanWieck at yahoo.com> wrote:
>> a major overhaul. My recent experiences with the Mozilla Rhino
>> JavaScript engine (Steve and I developed a cluster test framework using
>> it) makes me think that actually creating a complete new slonik from
>> scratch won't be too bad of an idea.
>
> just don't make java a dependency, please....

That's looking increasingly like a dependancy on The DBMS With an O In
Its Name ;-).

There is merit to redoing parts of Slony in a language less nasty about
threading and string manipulation than C, but that's not nearly the same
thing as saying "sure, port to Java!"  (If Go ran on more than x86, ARM,
x86_64, I might wonder about it as an option...)

Also, JavaScript != Java.  They are quite separate languages, and the
fact that both contain "Java" in their name misleads people to imagine
they are rather more related than they are.
-- 
(reverse (concatenate 'string "ofni.sailifa" "@" "enworbbc"))
Christopher Browne
"Bother,"  said Pooh,  "Eeyore, ready  two photon  torpedoes  and lock
phasers on the Heffalump, Piglet, meet me in transporter room three"

From cbbrowne at ca.afilias.info  Fri Nov 26 13:20:43 2010
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Fri, 26 Nov 2010 16:20:43 -0500
Subject: [Slony1-general] Enhancement Proposal: Automatic WAIT FOR EVENT
In-Reply-To: <4CF015A1.4070509@Yahoo.com> (Jan Wieck's message of "Fri, 26 Nov
	2010 15:16:33 -0500")
References: <87pqu3r4fj.fsf@cbbrowne.afilias-int.info>
	<4CF015A1.4070509@Yahoo.com>
Message-ID: <87ipzjixxw.fsf@cbbrowne.afilias-int.info>

Jan Wieck <JanWieck at Yahoo.com> writes:
> On 11/17/2010 5:06 PM, Christopher Browne wrote:
>> A thing that several of us have been ruminating over for a while is the
>> problem that people get confused about how you submit Slonik scripts,
>> you may have some actions that require waits.
>
> One major problem with automatic waiting for events is that it is
> extremely context sensitive to wait at all.
>
> One cannot wait inside of a TRY block. The events aren't committed
> yet, so they cannot propagate.
>
> One needs to be careful not to wait if the current path configuration
> is incomplete. You should for example never wait for the FIRST store
> path ... you'd wait forever.
>
> This all basically exposes that slonik has insufficient knowledge
> about the overall cluster configuration and healthiness. It basically
> fires off "commands" blindly. I've long been thinking that slonik
> itself needs a major overhaul. My recent experiences with the Mozilla
> Rhino JavaScript engine (Steve and I developed a cluster test
> framework using it) makes me think that actually creating a complete
> new slonik from scratch won't be too bad of an idea.

I'm not sure yet what the answer is.  The following are possibilities,
each seeming to have merits and demerits:

1.  Drop TRY, so people don't make the mistake of imagining
transactional safety that's not there.  If we add "automatic waits,"
we're likely giving up on the capability of TRY.

2.  Define clearly what things are allowed in a TRY block and what
things are not, so that the slonik parser forbids invalid actions.

I'm not sure if that's plausible.

These items are evolutionary changes, not revolutionary.

If we're to have something altogether replacing Slonik, I'd think:

3.  It needs to have a new name, so people don't confuse "old Slonik"
with "new Slonik."

I have worked on projects where they tried desperately to retain the
same name for fundamentally different designs, and this causes no end of
confusion.

4.  We need an overview of what the new tool is, and the qualities that
define it.  It should be possible to have a fair bit of detail of things
the slonik replacement does and doesn't have.
-- 
let name="cbbrowne" and tld="afilias.info" in String.concat "@" [name;tld];;
Christopher Browne
"Bother,"  said Pooh,  "Eeyore, ready  two photon  torpedoes  and lock
phasers on the Heffalump, Piglet, meet me in transporter room three"

From ssinger at ca.afilias.info  Fri Nov 26 13:45:05 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Fri, 26 Nov 2010 16:45:05 -0500
Subject: [Slony1-general] Enhancement Proposal: Automatic WAIT FOR EVENT
In-Reply-To: <87ipzjixxw.fsf@cbbrowne.afilias-int.info>
References: <87pqu3r4fj.fsf@cbbrowne.afilias-int.info>	<4CF015A1.4070509@Yahoo.com>
	<87ipzjixxw.fsf@cbbrowne.afilias-int.info>
Message-ID: <4CF02A61.60901@ca.afilias.info>

On 10-11-26 04:20 PM, Christopher Browne wrote:
> Jan Wieck<JanWieck at Yahoo.com>  writes:

>
> 1.  Drop TRY, so people don't make the mistake of imagining
> transactional safety that's not there.  If we add "automatic waits,"
> we're likely giving up on the capability of TRY.
>
> 2.  Define clearly what things are allowed in a TRY block and what
> things are not, so that the slonik parser forbids invalid actions.
>
> I'm not sure if that's plausible.

Well what can't be in a TRY?
Anything that you need to wait for to propogate to another node.

When do you need to wait for something to propagate to another node?

Any time the event node of a subsequent command is different than the 
event node of the current command.  The subsequent command might change 
the other node before (or after) the first command is replicated. 
Depending on the nature of the commands this might or might not be an issue.

I also want to point out that some commands have an implicit event node. 
  ie store path.

Slonik knows the event node of each command before it starts executing 
anything(1). (either the event node is specified or slonik infers it 
from another parameter).

I think we want to write some code in slonik that walks the parse tree 
and looks for any time the event node will change.  If so we would then
a) Make sure that this isn't happening in a TRY block. If so error out 
(at parse time).

b) Add an automatic wait to make sure that the previous event on the 
current event node has been confirmed by the next event node (or does it 
have to be confirmed everywhere?)


Footnotes:

1) This isn't actually true.  In 2.0.5 for subscribe set, slonik 
interogates the cluster to find the current origin of the set.  It picks 
this as the event node.  Jan has said that the original idea for 
subscribe set was that the receiver would be the event node.  That would 
solve this.  The other case is FAILOVER that gets the most-ahead node at 
the time it runs.   This is kind of special anyway because if your using 
FAILOVER chances are some node isn't confirming events anyway.



>
> These items are evolutionary changes, not revolutionary.
>
> If we're to have something altogether replacing Slonik, I'd think:
>
> 3.  It needs to have a new name, so people don't confuse "old Slonik"
> with "new Slonik."
>
> I have worked on projects where they tried desperately to retain the
> same name for fundamentally different designs, and this causes no end of
> confusion.
>
> 4.  We need an overview of what the new tool is, and the qualities that
> define it.  It should be possible to have a fair bit of detail of things
> the slonik replacement does and doesn't have.


From JanWieck at Yahoo.com  Fri Nov 26 14:56:42 2010
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Fri, 26 Nov 2010 17:56:42 -0500
Subject: [Slony1-general] Enhancement Proposal: Automatic WAIT FOR EVENT
In-Reply-To: <4CF018DB.8080809@ca.afilias.info>
References: <87pqu3r4fj.fsf@cbbrowne.afilias-int.info>	<4CF015A1.4070509@Yahoo.com>
	<4CF018DB.8080809@ca.afilias.info>
Message-ID: <4CF03B2A.8030700@Yahoo.com>

On 11/26/2010 3:30 PM, Steve Singer wrote:
> On 10-11-26 03:16 PM, Jan Wieck wrote:
>>  On 11/17/2010 5:06 PM, Christopher Browne wrote:
>>>  A thing that several of us have been ruminating over for a while is the
>>>  problem that people get confused about how you submit Slonik scripts,
>>>  you may have some actions that require waits.
>>
>>  One major problem with automatic waiting for events is that it is
>>  extremely context sensitive to wait at all.
>>
>>  One cannot wait inside of a TRY block. The events aren't committed yet,
>>  so they cannot propagate.
>>
>>  One needs to be careful not to wait if the current path configuration is
>>  incomplete. You should for example never wait for the FIRST store path
>>  ... you'd wait forever.
>>
>>  This all basically exposes that slonik has insufficient knowledge about
>>  the overall cluster configuration and healthiness. It basically fires
>>  off "commands" blindly. I've long been thinking that slonik itself needs
>>  a major overhaul. My recent experiences with the Mozilla Rhino
>>  JavaScript engine (Steve and I developed a cluster test framework using
>>  it) makes me think that actually creating a complete new slonik from
>>  scratch won't be too bad of an idea.
>
> What would you want to change in slonik (from the users point of view)
> if you were doing that?
>
> When I was developing tests for the framework I spent countless hours
> debugging tests were the problem ended up being a missing or an extra
> wait for (or one against the wrong node). Expecting the average DBA to
> figure this stuff out isn't nice.   Slonik should be able to figure out
> if paths exist to the required nodes and other dependencies on the
> configuration.  I think slonik should check as many things as we can
> make and give the user useful error messages instead of 'waiting for ever'
>
> I agree with Vick that a Java dependency for slony would be a bad idea.

Would it really be such a bad idea?

The system where slonik (or an alternative to it) is running does NOT 
have to be any of the DB servers or systems, where even slon is running. 
It can be the sysadmin's laptop for all that matters.

Anyhow, I don't think the language is that important at this point in 
the discussion. Way more important is the question how much we would 
like slonik to actually "know".

If I had to write slonik again it would on startup connect to each node, 
that it has an admin-conninfo for, and read the whole cluster 
configuration from its sl_* tables. It would update that information 
before executing any command.

This way it would "know" which sets exist, which nodes are subscribed to 
them (and up to what level, like in-progress). It would know that a 
certain node isn't the origin of a certain set "yet".

Of course, this sort of safety could also be achieved by just extending 
the current slonik code.

In any case, I do think we need to make slonik smarter. I just don't 
know if C is still the right language to do it in.


Jan

-- 
Anyone who trades liberty for security deserves neither
liberty nor security. -- Benjamin Franklin

From cbbrowne at ca.afilias.info  Fri Nov 26 16:04:04 2010
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Fri, 26 Nov 2010 19:04:04 -0500
Subject: [Slony1-general] Enhancement Proposal: Automatic WAIT FOR EVENT
In-Reply-To: <4CF03B2A.8030700@Yahoo.com> (Jan Wieck's message of "Fri, 26 Nov
	2010 17:56:42 -0500")
References: <87pqu3r4fj.fsf@cbbrowne.afilias-int.info>
	<4CF015A1.4070509@Yahoo.com> <4CF018DB.8080809@ca.afilias.info>
	<4CF03B2A.8030700@Yahoo.com>
Message-ID: <87bp5biqdn.fsf@cbbrowne.afilias-int.info>

Jan Wieck <JanWieck at Yahoo.com> writes:
> On 11/26/2010 3:30 PM, Steve Singer wrote:
>> On 10-11-26 03:16 PM, Jan Wieck wrote:
>>>  On 11/17/2010 5:06 PM, Christopher Browne wrote:
>>>>  A thing that several of us have been ruminating over for a while is the
>>>>  problem that people get confused about how you submit Slonik scripts,
>>>>  you may have some actions that require waits.
>>>
>>>  One major problem with automatic waiting for events is that it is
>>>  extremely context sensitive to wait at all.
>>>
>>>  One cannot wait inside of a TRY block. The events aren't committed yet,
>>>  so they cannot propagate.
>>>
>>>  One needs to be careful not to wait if the current path configuration is
>>>  incomplete. You should for example never wait for the FIRST store path
>>>  ... you'd wait forever.
>>>
>>>  This all basically exposes that slonik has insufficient knowledge about
>>>  the overall cluster configuration and healthiness. It basically fires
>>>  off "commands" blindly. I've long been thinking that slonik itself needs
>>>  a major overhaul. My recent experiences with the Mozilla Rhino
>>>  JavaScript engine (Steve and I developed a cluster test framework using
>>>  it) makes me think that actually creating a complete new slonik from
>>>  scratch won't be too bad of an idea.
>>
>> What would you want to change in slonik (from the users point of view)
>> if you were doing that?
>>
>> When I was developing tests for the framework I spent countless hours
>> debugging tests were the problem ended up being a missing or an extra
>> wait for (or one against the wrong node). Expecting the average DBA to
>> figure this stuff out isn't nice.   Slonik should be able to figure out
>> if paths exist to the required nodes and other dependencies on the
>> configuration.  I think slonik should check as many things as we can
>> make and give the user useful error messages instead of 'waiting for ever'
>>
>> I agree with Vick that a Java dependency for slony would be a bad idea.
>
> Would it really be such a bad idea?

I think it's premature to say anything about implementation language,
when we don't yet have a systematic description of the replacement. (I
note that you start such here... [1])

> The system where slonik (or an alternative to it) is running does NOT 
> have to be any of the DB servers or systems, where even slon is running. 
> It can be the sysadmin's laptop for all that matters.
>
> Anyhow, I don't think the language is that important at this point in 
> the discussion.  Way more important is the question how much we would 
> like slonik to actually "know".

Indeed.

[1]
> If I had to write slonik again it would on startup connect to each node, 
> that it has an admin-conninfo for, and read the whole cluster 
> configuration from its sl_* tables. It would update that information 
> before executing any command.
>
> This way it would "know" which sets exist, which nodes are subscribed to 
> them (and up to what level, like in-progress). It would know that a 
> certain node isn't the origin of a certain set "yet".

This starts a "systematic description" of what's different from slonik
as it is today, which is nice to have start.

I don't think it'll be enough to just say, "oh, some commands will have
some changed semantics."  Rather, I expect that we'll have some new
abstractions in Slonik.

Sounds like...

1.  Today, we have a preamble consisting of
      CLUSTER NAME...
      ADMIN CONN INFO ... (for each node, which is never stored in DB)

    Sounds like this changes to
      CLUSTER NAME...
      ADMIN CONN INFO [specify ONE node to talk to]

    ... and we need to have a new table + command to store the ADMIN
    CONN INFO ...


      

> Of course, this sort of safety could also be achieved by just extending 
> the current slonik code.

I imagine so.  None of what you have mentioned thus far intrinsically
points to functionality that couldn't be captured by (scan.l + parser.y
+ slonik.c + dbutil.c).

> In any case, I do think we need to make slonik smarter. I just don't 
> know if C is still the right language to do it in.

I don't think we need to think about that at all until we determine with
greater exactitude what "smarter" means.
-- 
output = ("cbbrowne" "@" "ca.afilias.info")
Christopher Browne
"Bother,"  said Pooh,  "Eeyore, ready  two photon  torpedoes  and lock
phasers on the Heffalump, Piglet, meet me in transporter room three"

From cbbrowne at ca.afilias.info  Fri Nov 26 16:24:48 2010
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Fri, 26 Nov 2010 19:24:48 -0500
Subject: [Slony1-general] Enhancement Proposal: Automatic WAIT FOR EVENT
In-Reply-To: <4CF03B2A.8030700@Yahoo.com> (Jan Wieck's message of "Fri, 26 Nov
	2010 17:56:42 -0500")
References: <87pqu3r4fj.fsf@cbbrowne.afilias-int.info>
	<4CF015A1.4070509@Yahoo.com> <4CF018DB.8080809@ca.afilias.info>
	<4CF03B2A.8030700@Yahoo.com>
Message-ID: <87aakvipf3.fsf@cbbrowne.afilias-int.info>

Jan Wieck <JanWieck at Yahoo.com> writes:
> On 11/26/2010 3:30 PM, Steve Singer wrote:
>> On 10-11-26 03:16 PM, Jan Wieck wrote:
>>>  On 11/17/2010 5:06 PM, Christopher Browne wrote:
>>>>  A thing that several of us have been ruminating over for a while is the
>>>>  problem that people get confused about how you submit Slonik scripts,
>>>>  you may have some actions that require waits.
>>>
>>>  One major problem with automatic waiting for events is that it is
>>>  extremely context sensitive to wait at all.
>>>
>>>  One cannot wait inside of a TRY block. The events aren't committed yet,
>>>  so they cannot propagate.
>>>
>>>  One needs to be careful not to wait if the current path configuration is
>>>  incomplete. You should for example never wait for the FIRST store path
>>>  ... you'd wait forever.
>>>
>>>  This all basically exposes that slonik has insufficient knowledge about
>>>  the overall cluster configuration and healthiness. It basically fires
>>>  off "commands" blindly. I've long been thinking that slonik itself needs
>>>  a major overhaul. My recent experiences with the Mozilla Rhino
>>>  JavaScript engine (Steve and I developed a cluster test framework using
>>>  it) makes me think that actually creating a complete new slonik from
>>>  scratch won't be too bad of an idea.
>>
>> What would you want to change in slonik (from the users point of view)
>> if you were doing that?
>>
>> When I was developing tests for the framework I spent countless hours
>> debugging tests were the problem ended up being a missing or an extra
>> wait for (or one against the wrong node). Expecting the average DBA to
>> figure this stuff out isn't nice.   Slonik should be able to figure out
>> if paths exist to the required nodes and other dependencies on the
>> configuration.  I think slonik should check as many things as we can
>> make and give the user useful error messages instead of 'waiting for ever'
>>
>> I agree with Vick that a Java dependency for slony would be a bad idea.
>
> Would it really be such a bad idea?

I think it's premature to say anything about implementation language,
when we don't yet have a systematic description of the replacement. (I
note that you start such here... [1])

> The system where slonik (or an alternative to it) is running does NOT 
> have to be any of the DB servers or systems, where even slon is running. 
> It can be the sysadmin's laptop for all that matters.
>
> Anyhow, I don't think the language is that important at this point in 
> the discussion.  Way more important is the question how much we would 
> like slonik to actually "know".

Indeed.

[1]
> If I had to write slonik again it would on startup connect to each node, 
> that it has an admin-conninfo for, and read the whole cluster 
> configuration from its sl_* tables. It would update that information 
> before executing any command.
>
> This way it would "know" which sets exist, which nodes are subscribed to 
> them (and up to what level, like in-progress). It would know that a 
> certain node isn't the origin of a certain set "yet".

This starts a "systematic description" of what's different from slonik
as it is today, which is nice to have start.

I don't think it'll be enough to just say, "oh, some commands will have
some changed semantics."  Rather, I expect that we'll have some new
abstractions in Slonik.

As a start...

1. Defining admin connections explicitly
 
   Today, we have a preamble consisting of
      CLUSTER NAME...
      ADMIN CONN INFO ... (for each node, which is never stored in DB)

    Sounds like this changes to
      CLUSTER NAME...
      ADMIN CONN INFO [specify ONE node to talk to]

    ... and we need to have a new table + command to store the ADMIN
        CONN INFO ...

2. Capturing current cluster state

   There's a new semantic here; state needs to be loaded in, sometimes.

   I'm not yet sure why or when, or what the basis would be to re-load
   state.  (I'm not challenging you - just saying that for the system to
   be predictable, there has to be some predictable basis for
   loading and reloading state.  I don't know what to call it yet.)

   There needs to be some basis for using cluster state.  That needs to
   be described, and we need a name for this, so it's not "oh, we need
   to do magic..."

There are likely more abstract bits that I'm not thinking of yet.  I
need to think about this more.

And if we don't have descriptive names for the new things, then they're
not well enough defined, yet.  Or maybe we need a diagram...

> Of course, this sort of safety could also be achieved by just extending 
> the current slonik code.

I imagine so.  None of what you have mentioned thus far intrinsically
points to functionality that couldn't be captured by (scan.l + parser.y
+ slonik.c + dbutil.c).

> In any case, I do think we need to make slonik smarter. I just don't 
> know if C is still the right language to do it in.

I don't think we need to think about that at all until we determine with
considerably greater exactitude what "smarter" means.
-- 
output = ("cbbrowne" "@" "ca.afilias.info")
Christopher Browne
"Bother,"  said Pooh,  "Eeyore, ready  two photon  torpedoes  and lock
phasers on the Heffalump, Piglet, meet me in transporter room three"

From JanWieck at Yahoo.com  Sun Nov 28 14:33:34 2010
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Sun, 28 Nov 2010 22:33:34 -0000
Subject: [Slony1-general] Rapid-fire updates to table missed by slony
In-Reply-To: <F28333AE-2DB0-43A8-AB5A-F2E0F02121E2@palisadesystems.com>
References: <6B66C950-980F-4608-844D-1A02A95C92CB@palisadesystems.com>	<4C72CF3D.2000007@ca.afilias.info>
	<C80821A7-A3D3-4D97-AAD5-2117393E7752@palisadesystems.com>
	<4C755E3C.2050108@Yahoo.com>
	<F28333AE-2DB0-43A8-AB5A-F2E0F02121E2@palisadesystems.com>
Message-ID: <4C7828A2.8080000@Yahoo.com>

On 8/26/2010 11:03 AM, Guy Helmer wrote:
>> It looks like there is one delete for user_id=34 missing. This could be caused by a corrupted index on sl_log_1. Can you do a
>> 
>>    REINDEX _replication.sl_log_1;
>> 
>> and then repeat that SELECT?
>> 
> 
> I had already manually intervened in the slave's table to get the replication working again, so the sl_log_1 table was empty.  I have run the REINDEX TABLE _replication.sl_log_1 command, and the table is still empty...

Sure.

The thing is that I recall from long ago a case where I had a corrupted 
sl_log_x index. I forgot which PG and/or Slony versions that was. The 
specific in that case was that one and the same heap tuple showed up in 
an index scan (same ctid), but not in a sequential scan. Since then we 
have moved away from deleting and vacuuming sl_log_x and simply truncate.

What I am wondering is if you have encountered a similar case where an 
index tuple points to the wrong row and thus, the row that is missing 
isn't found in that index scan. You won't get a duplicate row if the 
wrong one it is pointing to is a deleted one.


Jan

-- 
Anyone who trades liberty for security deserves neither
liberty nor security. -- Benjamin Franklin


From vivek at khera.org  Sun Nov 28 16:37:31 2010
From: vivek at khera.org (Vick Khera)
Date: Sun, 28 Nov 2010 19:37:31 -0500
Subject: [Slony1-general] Enhancement Proposal: Automatic WAIT FOR EVENT
In-Reply-To: <87mxoviyro.fsf@cbbrowne.afilias-int.info>
References: <87pqu3r4fj.fsf@cbbrowne.afilias-int.info>
	<4CF015A1.4070509@Yahoo.com>
	<AANLkTin9Xb30AsRdZOpqup9GVApWm8ek1AV5u7OHORGL@mail.gmail.com>
	<87mxoviyro.fsf@cbbrowne.afilias-int.info>
Message-ID: <AANLkTikK0=zgNUDzgw4jusfOeMr5QTmGAnY7U4vJAab5@mail.gmail.com>

On Fri, Nov 26, 2010 at 4:02 PM, Christopher Browne
<cbbrowne at ca.afilias.info> wrote:
> Also, JavaScript != Java. ?They are quite separate languages, and the
> fact that both contain "Java" in their name misleads people to imagine
> they are rather more related than they are.
>

Rhino == JavaScript for Java, thus my wish.

Building code in javascript is not so bad as long as it runs on
interpreters other than Rhino, too.  The node.js people seem to have
something nice... but then again you're stuck in x86, ARM, and x86_64
just like with Go.

From ssinger at ca.afilias.info  Mon Nov 29 06:49:26 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Mon, 29 Nov 2010 09:49:26 -0500
Subject: [Slony1-general] Enhancement Proposal: Automatic WAIT FOR EVENT
In-Reply-To: <4CF03B2A.8030700@Yahoo.com>
References: <87pqu3r4fj.fsf@cbbrowne.afilias-int.info>	<4CF015A1.4070509@Yahoo.com>
	<4CF018DB.8080809@ca.afilias.info> <4CF03B2A.8030700@Yahoo.com>
Message-ID: <4CF3BD76.7050605@ca.afilias.info>

On 10-11-26 05:56 PM, Jan Wieck wrote:
> The system where slonik (or an alternative to it) is running does NOT
> have to be any of the DB servers or systems, where even slon is running.
> It can be the sysadmin's laptop for all that matters.

I'm going to hold off debating that till another time.

>
> Anyhow, I don't think the language is that important at this point in
> the discussion. Way more important is the question how much we would
> like slonik to actually "know".
>
> If I had to write slonik again it would on startup connect to each node,
> that it has an admin-conninfo for, and read the whole cluster
> configuration from its sl_* tables. It would update that information
> before executing any command.
>
> This way it would "know" which sets exist, which nodes are subscribed to
> them (and up to what level, like in-progress). It would know that a
> certain node isn't the origin of a certain set "yet".
>

Can we come up with a more specific list of when slonik should *know* 
things, what it should know and how it would use that information?

* Filling in defaults like the next available table_id and the set 
origin to subscribe set is one example

* Providing protection against breaking things by preventing a user from 
issuing the wrong command while an action is in progress is another (ie 
unsubscribe while a subscribe is in progress).  This might be in the 
form of rejecting the command or it might involve cancelling the 
in-progress command. - Determining in progress state in a distributed 
asynchronous system can be a challenge.

If we are revisiting these things we also should think about if slony 
commands should be propogated through sl_event or applied directly on 
each node by slonik - and if so do we need 2pc to make this work 
reliably, and is this that a good idea.



> Of course, this sort of safety could also be achieved by just extending
> the current slonik code.
>
> In any case, I do think we need to make slonik smarter. I just don't
> know if C is still the right language to do it in.
>

Once we know what exactly what we want slonik to do we will be in a 
better position to have that discussion.


>
> Jan
>


From emma.lovatt at ticketline.co.uk  Tue Nov 30 03:36:55 2010
From: emma.lovatt at ticketline.co.uk (Emma Lovatt)
Date: Tue, 30 Nov 2010 11:36:55 -0000
Subject: [Slony1-general] Replication breaking on a table and can you
	replicate certain parts of a table
Message-ID: <32EEB8B223E62246AE0387AC2981D9BC02D8F3FE@Nibbler.piccadillyboxoffice.com>

Hi,

 

I've been searching the web for the answer to my questions but cannot
find it and was hoping that someone might be able to help or point me in
the right direction

 

We have an issue where replication is breaking on one of our tables
which has the following format

 

Field Name                        Type                      Length
Allow Null

Seating_mapid                  int4                        32
NO

Name                                    varchar                 50
NO

Description                         varchar                 50
YES

Is_default                           int4                        32
NO

Bmap                                    bytea                    0
YES

Miniature                            int4                        32
NO

Spaceid                                int4                        32
NO

Capacity                               int4                        32
YES

Active                                   int4                        32
NO

 

Our entire database is encoding SQL_ASCII.  I found that there may be a
possibility that the bytea column is not  replicating and it is due to
the encoding of the database which is SQL_ASCII could anyone confirm
this?

 

 

My second question relates to my first if I cannot replicate my bytea
column, I would like to know if it is possible to only replicate parts
of a table and miss out certain columns, is this possible?

 

Kind Regards

 

Emma Lovatt

 

 

 

 



------------------------
This email was scanned by BitDefender.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20101130/e5fb304d/attachment.htm 

From vivek at khera.org  Tue Nov 30 08:06:12 2010
From: vivek at khera.org (Vick Khera)
Date: Tue, 30 Nov 2010 11:06:12 -0500
Subject: [Slony1-general] Replication breaking on a table and can you
 replicate certain parts of a table
In-Reply-To: <32EEB8B223E62246AE0387AC2981D9BC02D8F3FE@Nibbler.piccadillyboxoffice.com>
References: <32EEB8B223E62246AE0387AC2981D9BC02D8F3FE@Nibbler.piccadillyboxoffice.com>
Message-ID: <AANLkTikW7kSX5mpFgu_vVpV7Bj+Tkd2f3E1MB-LH6k+r@mail.gmail.com>

On Tue, Nov 30, 2010 at 6:36 AM, Emma Lovatt
<emma.lovatt at ticketline.co.uk> wrote:

You say "replication is breaking". Please describe your symptoms
exactly.  Nobody can offer you help without knowing exactly what you
observe.  Also include details on what system you have and what
versions of your OS, Postgres, and slony you are running.

My first guess based on zero information is that someone ran a schema
alteration without running it through the slonik EXECUTE SCRIPT
command.

> Our entire database is encoding SQL_ASCII.? I found that there may be a
> possibility that the bytea column is not? replicating and it is due to the
> encoding of the database which is SQL_ASCII could anyone confirm this?

this is incorrect.  bytea columns replicate just fine.

> My second question relates to my first if I cannot replicate my bytea
> column, I would like to know if it is possible to only replicate parts of a
> table and miss out certain columns, is this possible?

no.  the minimal unit of replication is the table.

From msteben at autorevenue.com  Tue Nov 30 08:21:46 2010
From: msteben at autorevenue.com (Mark Steben)
Date: Tue, 30 Nov 2010 11:21:46 -0500
Subject: [Slony1-general] install instruction
Message-ID: <20101130162155.36593290CF0@main.slony.info>



Mark Steben?|?Database Administrator?
@utoRevenue? - "Keeping Customers Close"?
95D Ashley Ave, West Springfield, MA 01089 
413.243.4800 x1512 (Phone) |413.732-1824 (Fax) 
@utoRevenue is a registered trademark and a division of Dominion
Enterprises?
?
________________________________________
From: Mark Steben [mailto:msteben at autorevenue.com] 
Sent: Tuesday, November 23, 2010 4:13 PM
To: 'slony1-general at lists.slony.info'
Subject: install instruction

Hi 

I might just be blind (Been accused of it many times), but I?m having
trouble
Installing slony1-2.0.5 and can?t seem to find installation instructions
In www.slony.info .? I seem to get the ./configure to work but am getting
Errors on the make command.

If someone could point me to doc, or give me some insights relative
To slony1-2 and how installation is different from slony1-1.? I previously
Had that successfully installed.

Thank you,


The rest of us are flying blind until you show the error you got...
also details like what OS you're on would be useful.


I?m ok now. At first I installed 2.0.5 ? took the tarball out of the main
slony  website www.slony.info
For some reason the source was missing some input components:
  
src/slony1-2.0.5/src/slony_logshipper/scan.c 

to be exact
So I reverted back to 2.0.4 and the install went flawlessly
Do I need to stay away from 2.0.5?


Mark Steben?|?Database Administrator?
@utoRevenue? - "Keeping Customers Close"?
95D Ashley Ave, West Springfield, MA 01089 
413.243.4800 x1512 (Phone) |413.732-1824 (Fax) 
@utoRevenue is a registered trademark and a division of Dominion
Enterprises?
?




From ktm at rice.edu  Tue Nov 30 08:34:32 2010
From: ktm at rice.edu (Kenneth Marshall)
Date: Tue, 30 Nov 2010 10:34:32 -0600
Subject: [Slony1-general] install instruction
In-Reply-To: <20101130162155.36593290CF0@main.slony.info>
References: <20101130162155.36593290CF0@main.slony.info>
Message-ID: <20101130163432.GI19162@aart.is.rice.edu>

On Tue, Nov 30, 2010 at 11:21:46AM -0500, Mark Steben wrote:
> 
> 
> Mark Steben?|?Database Administrator?
> @utoRevenue? - "Keeping Customers Close"?
> 95D Ashley Ave, West Springfield, MA 01089 
> 413.243.4800 x1512 (Phone) |413.732-1824 (Fax) 
> @utoRevenue is a registered trademark and a division of Dominion
> Enterprises?
> ?
> ________________________________________
> From: Mark Steben [mailto:msteben at autorevenue.com] 
> Sent: Tuesday, November 23, 2010 4:13 PM
> To: 'slony1-general at lists.slony.info'
> Subject: install instruction
> 
> Hi 
> 
> I might just be blind (Been accused of it many times), but I?m having
> trouble
> Installing slony1-2.0.5 and can?t seem to find installation instructions
> In www.slony.info .? I seem to get the ./configure to work but am getting
> Errors on the make command.
> 
> If someone could point me to doc, or give me some insights relative
> To slony1-2 and how installation is different from slony1-1.? I previously
> Had that successfully installed.
> 
> Thank you,
> 
> 
> The rest of us are flying blind until you show the error you got...
> also details like what OS you're on would be useful.
> 
> 
> I?m ok now. At first I installed 2.0.5 ? took the tarball out of the main
> slony  website www.slony.info
> For some reason the source was missing some input components:
>   
> src/slony1-2.0.5/src/slony_logshipper/scan.c 
> 
> to be exact
> So I reverted back to 2.0.4 and the install went flawlessly
> Do I need to stay away from 2.0.5?
> 
> 
> Mark Steben?|?Database Administrator?
> @utoRevenue? - "Keeping Customers Close"?
> 95D Ashley Ave, West Springfield, MA 01089 
> 413.243.4800 x1512 (Phone) |413.732-1824 (Fax) 
> @utoRevenue is a registered trademark and a division of Dominion
> Enterprises?
> ?
> 

2.0.5 is working well here, which was certainly not the case for
earlier 2.0.x releases. Please post your error messages from the
build.

Cheers,
Ken

From msteben at autorevenue.com  Tue Nov 30 09:16:10 2010
From: msteben at autorevenue.com (Mark Steben)
Date: Tue, 30 Nov 2010 12:16:10 -0500
Subject: [Slony1-general] install instruction
In-Reply-To: <20101130163432.GI19162@aart.is.rice.edu>
Message-ID: <20101130171619.612C8290D06@main.slony.info>

Here is the error from 'make'

make
make[1]: Entering directory `/usr/local/src/slony1-2.0.5/src'
make[2]: Entering directory
`/usr/local/src/slony1-2.0.5/src/parsestatements'
./test-scanner < /dev/null > emptytestresult.log
cmp ./emptytestresult.log emptytestresult.expected
./test-scanner < ./test_sql.sql > test_sql.log
cmp ./test_sql.log ./test_sql.expected
./test-scanner < ./cstylecomments.sql > cstylecomments.log
cmp ./cstylecomments.log ./cstylecomments.expected
make[2]: Leaving directory `/usr/local/src/slony1-2.0.5/src/parsestatements'
make[2]: Entering directory `/usr/local/src/slony1-2.0.5/src/slon'
make[2]: Nothing to be done for `all'.
make[2]: Leaving directory `/usr/local/src/slony1-2.0.5/src/slon'
make[2]: Entering directory `/usr/local/src/slony1-2.0.5/src/slonik'
make[2]: Nothing to be done for `all'.
make[2]: Leaving directory `/usr/local/src/slony1-2.0.5/src/slonik'
make[2]: Entering directory `/usr/local/src/slony1-2.0.5/src/backend'
make[2]: Nothing to be done for `all'.
make[2]: Leaving directory `/usr/local/src/slony1-2.0.5/src/backend'
make[2]: Entering directory `/usr/local/src/slony1-2.0.5/src/ducttape'
make[2]: Leaving directory `/usr/local/src/slony1-2.0.5/src/ducttape'
make[2]: Entering directory
`/usr/local/src/slony1-2.0.5/src/slony_logshipper'
Missing flex scan.l scan.c
gcc -g -O2 -Wall -Wmissing-prototypes -Wmissing-declarations -I../..
-DPGSHARE="\"/usr/local/postgresql-8.3.11/share/\""
-I/usr/local/postgresql-8.3.11/include/
-I/usr/local/postgresql-8.3.11/include/server/  -c -o parser.o parser.c
gcc -g -O2 -Wall -Wmissing-prototypes -Wmissing-declarations -I../..
-DPGSHARE="\"/usr/local/postgresql-8.3.11/share/\""
-I/usr/local/postgresql-8.3.11/include/
-I/usr/local/postgresql-8.3.11/include/server/  -c -o scan.o scan.c
gcc: scan.c: No such file or directory
gcc: no input files
make[2]: *** [scan.o] Error 1
make[2]: Leaving directory
`/usr/local/src/slony1-2.0.5/src/slony_logshipper'
make[1]: *** [all] Error 2
make[1]: Leaving directory `/usr/local/src/slony1-2.0.5/src'
make: *** [all] Error 2
[root at msteben-centos slony1-2.0.5]#

And here is the contents of the slony_logshipper folder:


[root at msteben-centos slony_logshipper]# ls -la
total 392
drwxr-xr-x  2 1589 1000  4096 Nov 30 12:11 .
drwxr-xr-x 10 1589 1000  4096 Oct  6 12:33 ..
-rw-r--r--  1 1589 1000  2996 Oct  6 12:33 dbutil.c
-rw-r--r--  1 root root 12704 Nov 24 13:12 dbutil.o
-rwxr-xr-x  1 1589 1000    45 Oct  6 12:33 .gitignore
-rw-r--r--  1 1589 1000 13997 Oct  6 12:33 ipcutil.c
-rw-r--r--  1 root root 30128 Nov 24 13:12 ipcutil.o
-rw-r--r--  1 1589 1000  1917 Oct  6 12:33 Makefile
-rw-r--r--  1 root root 83330 Nov 24 13:12 parser.c
-rw-r--r--  1 root root 51064 Nov 30 12:11 parser.o
-rw-r--r--  1 1589 1000 21642 Oct  6 12:33 parser.y
-rw-r--r--  1 1589 1000  7389 Oct  7 09:09 scan.h
-rw-r--r--  1 1589 1000 12048 Oct  6 12:33 scan.l
-rw-r--r--  1 1589 1000 28331 Oct  6 12:33 slony_logshipper.c
-rw-r--r--  1 1589 1000  5905 Oct  6 12:33 slony_logshipper.h
-rw-r--r--  1 root root 72296 Nov 24 13:12 slony_logshipper.o
-rw-r--r--  1 root root  4728 Nov 24 13:12 y.tab.h

Mark Steben | Database Administrator 
@utoRevenueR - "Keeping Customers Close" 
95D Ashley Ave, West Springfield, MA 01089 
413.243.4800 x1512 (Phone) |413.732-1824 (Fax) 
@utoRevenue is a registered trademark and a division of Dominion Enterprises

 
-----Original Message-----
From: Kenneth Marshall [mailto:ktm at rice.edu] 
Sent: Tuesday, November 30, 2010 11:35 AM
To: Mark Steben
Cc: slony1-general at lists.slony.info
Subject: Re: [Slony1-general] install instruction

On Tue, Nov 30, 2010 at 11:21:46AM -0500, Mark Steben wrote:
> 
> 
> Mark Steben?|?Database Administrator?
> @utoRevenue? - "Keeping Customers Close"?
> 95D Ashley Ave, West Springfield, MA 01089 
> 413.243.4800 x1512 (Phone) |413.732-1824 (Fax) 
> @utoRevenue is a registered trademark and a division of Dominion
> Enterprises?
> ?
> ________________________________________
> From: Mark Steben [mailto:msteben at autorevenue.com] 
> Sent: Tuesday, November 23, 2010 4:13 PM
> To: 'slony1-general at lists.slony.info'
> Subject: install instruction
> 
> Hi 
> 
> I might just be blind (Been accused of it many times), but I?m having
> trouble
> Installing slony1-2.0.5 and can?t seem to find installation instructions
> In www.slony.info .? I seem to get the ./configure to work but am getting
> Errors on the make command.
> 
> If someone could point me to doc, or give me some insights relative
> To slony1-2 and how installation is different from slony1-1.? I previously
> Had that successfully installed.
> 
> Thank you,
> 
> 
> The rest of us are flying blind until you show the error you got...
> also details like what OS you're on would be useful.
> 
> 
> I?m ok now. At first I installed 2.0.5 ? took the tarball out of the main
> slony  website www.slony.info
> For some reason the source was missing some input components:
>   
> src/slony1-2.0.5/src/slony_logshipper/scan.c 
> 
> to be exact
> So I reverted back to 2.0.4 and the install went flawlessly
> Do I need to stay away from 2.0.5?
> 
> 
> Mark Steben?|?Database Administrator?
> @utoRevenue? - "Keeping Customers Close"?
> 95D Ashley Ave, West Springfield, MA 01089 
> 413.243.4800 x1512 (Phone) |413.732-1824 (Fax) 
> @utoRevenue is a registered trademark and a division of Dominion
> Enterprises?
> ?
> 

2.0.5 is working well here, which was certainly not the case for
earlier 2.0.x releases. Please post your error messages from the
build.

Cheers,
Ken




From ssinger at ca.afilias.info  Tue Nov 30 09:18:42 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Tue, 30 Nov 2010 12:18:42 -0500
Subject: [Slony1-general] install instruction
In-Reply-To: <20101130171619.612C8290D06@main.slony.info>
References: <20101130171619.612C8290D06@main.slony.info>
Message-ID: <4CF531F2.5040306@ca.afilias.info>

On 10-11-30 12:16 PM, Mark Steben wrote:
> Here is the error from 'make'
>
> -DPGSHARE="\"/usr/local/postgresql-8.3.11/share/\""
> -I/usr/local/postgresql-8.3.11/include/
> -I/usr/local/postgresql-8.3.11/include/server/  -c -o scan.o scan.c
> gcc: scan.c: No such file or directory
> gcc: no input files
> make[2]: *** [scan.o] Error 1
> make[2]: Leaving directory
> `/usr/local/src/slony1-2.0.5/src/slony_logshipper'
> make[1]: *** [all] Error 2
> make[1]: Leaving directory `/usr/local/src/slony1-2.0.5/src'
> make: *** [all] Error 2
> [root at msteben-centos slony1-2.0.5]#


See bug 165 http://bugs.slony.info/bugzilla/show_bug.cgi?id=164

Either install flex + bison or grab the missing files attached to that bug.





>
> And here is the contents of the slony_logshipper folder:
>
>
> [root at msteben-centos slony_logshipper]# ls -la
> total 392
> drwxr-xr-x  2 1589 1000  4096 Nov 30 12:11 .
> drwxr-xr-x 10 1589 1000  4096 Oct  6 12:33 ..
> -rw-r--r--  1 1589 1000  2996 Oct  6 12:33 dbutil.c
> -rw-r--r--  1 root root 12704 Nov 24 13:12 dbutil.o
> -rwxr-xr-x  1 1589 1000    45 Oct  6 12:33 .gitignore
> -rw-r--r--  1 1589 1000 13997 Oct  6 12:33 ipcutil.c
> -rw-r--r--  1 root root 30128 Nov 24 13:12 ipcutil.o
> -rw-r--r--  1 1589 1000  1917 Oct  6 12:33 Makefile
> -rw-r--r--  1 root root 83330 Nov 24 13:12 parser.c
> -rw-r--r--  1 root root 51064 Nov 30 12:11 parser.o
> -rw-r--r--  1 1589 1000 21642 Oct  6 12:33 parser.y
> -rw-r--r--  1 1589 1000  7389 Oct  7 09:09 scan.h
> -rw-r--r--  1 1589 1000 12048 Oct  6 12:33 scan.l
> -rw-r--r--  1 1589 1000 28331 Oct  6 12:33 slony_logshipper.c
> -rw-r--r--  1 1589 1000  5905 Oct  6 12:33 slony_logshipper.h
> -rw-r--r--  1 root root 72296 Nov 24 13:12 slony_logshipper.o
> -rw-r--r--  1 root root  4728 Nov 24 13:12 y.tab.h
>
> Mark Steben | Database Administrator
> @utoRevenueR - "Keeping Customers Close"
> 95D Ashley Ave, West Springfield, MA 01089
> 413.243.4800 x1512 (Phone) |413.732-1824 (Fax)
> @utoRevenue is a registered trademark and a division of Dominion Enterprises
>
>
> -----Original Message-----
> From: Kenneth Marshall [mailto:ktm at rice.edu]
> Sent: Tuesday, November 30, 2010 11:35 AM
> To: Mark Steben
> Cc: slony1-general at lists.slony.info
> Subject: Re: [Slony1-general] install instruction
>
> On Tue, Nov 30, 2010 at 11:21:46AM -0500, Mark Steben wrote:
>>
>>
>> Mark Steben?|?Database Administrator?
>> @utoRevenue? - "Keeping Customers Close"?
>> 95D Ashley Ave, West Springfield, MA 01089
>> 413.243.4800 x1512 (Phone) |413.732-1824 (Fax)
>> @utoRevenue is a registered trademark and a division of Dominion
>> Enterprises?
>> ?
>> ________________________________________
>> From: Mark Steben [mailto:msteben at autorevenue.com]
>> Sent: Tuesday, November 23, 2010 4:13 PM
>> To: 'slony1-general at lists.slony.info'
>> Subject: install instruction
>>
>> Hi
>>
>> I might just be blind (Been accused of it many times), but I?m having
>> trouble
>> Installing slony1-2.0.5 and can?t seem to find installation instructions
>> In www.slony.info .? I seem to get the ./configure to work but am getting
>> Errors on the make command.
>>
>> If someone could point me to doc, or give me some insights relative
>> To slony1-2 and how installation is different from slony1-1.? I previously
>> Had that successfully installed.
>>
>> Thank you,
>>
>>
>> The rest of us are flying blind until you show the error you got...
>> also details like what OS you're on would be useful.
>>
>>
>> I?m ok now. At first I installed 2.0.5 ? took the tarball out of the main
>> slony  website www.slony.info
>> For some reason the source was missing some input components:
>>
>> src/slony1-2.0.5/src/slony_logshipper/scan.c
>>
>> to be exact
>> So I reverted back to 2.0.4 and the install went flawlessly
>> Do I need to stay away from 2.0.5?
>>
>>
>> Mark Steben?|?Database Administrator?
>> @utoRevenue? - "Keeping Customers Close"?
>> 95D Ashley Ave, West Springfield, MA 01089
>> 413.243.4800 x1512 (Phone) |413.732-1824 (Fax)
>> @utoRevenue is a registered trademark and a division of Dominion
>> Enterprises?
>> ?
>>
>
> 2.0.5 is working well here, which was certainly not the case for
> earlier 2.0.x releases. Please post your error messages from the
> build.
>
> Cheers,
> Ken
>
>
>
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


From emma.lovatt at ticketline.co.uk  Tue Nov 30 08:13:16 2010
From: emma.lovatt at ticketline.co.uk (Emma Lovatt)
Date: Tue, 30 Nov 2010 16:13:16 -0000
Subject: [Slony1-general] Replication breaking on a table and can you
	replicate certain parts of a table
In-Reply-To: <AANLkTikW7kSX5mpFgu_vVpV7Bj+Tkd2f3E1MB-LH6k+r@mail.gmail.com>
References: <32EEB8B223E62246AE0387AC2981D9BC02D8F3FE@Nibbler.piccadillyboxoffice.com>
	<AANLkTikW7kSX5mpFgu_vVpV7Bj+Tkd2f3E1MB-LH6k+r@mail.gmail.com>
Message-ID: <32EEB8B223E62246AE0387AC2981D9BC02D8F415@Nibbler.piccadillyboxoffice.com>

Sorry I'm working on the information the DBA has given me as I myself am not a DBA but really trying hard to understand J

 

The error in the slony log is:_

 

2010-11-10 13:21:50 GMTERROR  remoteWorkerThread_1: "update only "public"."stp_seatingmaps" set pa?;

" ERROR:  syntax error at or near ""

LINE 1: update only "public"."stp_seatingmaps" set pa?;

 

 

This happens when that table is updated on the master and it tried to replicate to the slave producing that error, we have had to turn off the replication on that table for the moment.  We are running RedHat Enterprise Linux 5 advanced server 64 bit, Postgresql Plus Advanced server 8.4 and slony is version 2.0.3

 

Thanks for answering so quickly, I hope this is a bit more information for you

 

From: Vick Khera [mailto:vivek at khera.org] 
Sent: 30 November 2010 16:06
To: Emma Lovatt
Cc: slony1-general at lists.slony.info
Subject: Re: [Slony1-general] Replication breaking on a table and can you replicate certain parts of a table

 

On Tue, Nov 30, 2010 at 6:36 AM, Emma Lovatt
<emma.lovatt at ticketline.co.uk> wrote:

You say "replication is breaking". Please describe your symptoms
exactly.  Nobody can offer you help without knowing exactly what you
observe.  Also include details on what system you have and what
versions of your OS, Postgres, and slony you are running.

My first guess based on zero information is that someone ran a schema
alteration without running it through the slonik EXECUTE SCRIPT
command.

> Our entire database is encoding SQL_ASCII.  I found that there may be a
> possibility that the bytea column is not  replicating and it is due to the
> encoding of the database which is SQL_ASCII could anyone confirm this?

this is incorrect.  bytea columns replicate just fine.

> My second question relates to my first if I cannot replicate my bytea
> column, I would like to know if it is possible to only replicate parts of a
> table and miss out certain columns, is this possible?

no.  the minimal unit of replication is the table.

------------------------
This email was scanned by BitDefender.

________________________________

No virus found in this message.
Checked by AVG - www.avg.com
Version: 10.0.1170 / Virus Database: 426/3288 - Release Date: 11/29/10



------------------------
This email was scanned by BitDefender.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20101130/848b7575/attachment.htm 

From ssinger at ca.afilias.info  Tue Nov 30 10:06:16 2010
From: ssinger at ca.afilias.info (Steve Singer)
Date: Tue, 30 Nov 2010 13:06:16 -0500
Subject: [Slony1-general] Replication breaking on a table and can you
 replicate certain parts of a table
In-Reply-To: <32EEB8B223E62246AE0387AC2981D9BC02D8F415@Nibbler.piccadillyboxoffice.com>
References: <32EEB8B223E62246AE0387AC2981D9BC02D8F3FE@Nibbler.piccadillyboxoffice.com>	<AANLkTikW7kSX5mpFgu_vVpV7Bj+Tkd2f3E1MB-LH6k+r@mail.gmail.com>
	<32EEB8B223E62246AE0387AC2981D9BC02D8F415@Nibbler.piccadillyboxoffice.com>
Message-ID: <4CF53D18.7040905@ca.afilias.info>

On 10-11-30 11:13 AM, Emma Lovatt wrote:
> Sorry I?m working on the information the DBA has given me as I myself am
> not a DBA but really trying hard to understand J
>
> The error in the slony log is:_
>
> 2010-11-10 13:21:50 GMTERROR remoteWorkerThread_1: "update only
> "public"."stp_seatingmaps" set pa?;
>
> " ERROR: syntax error at or near ""
>
> LINE 1: update only "public"."stp_seatingmaps" set pa?;
>
> This happens when that table is updated on the master and it tried to
> replicate to the slave producing that error, we have had to turn off the
> replication on that table for the moment.  We are running RedHat
> Enterprise Linux 5 advanced server 64 bit, Postgresql Plus Advanced
> server 8.4 and slony is version 2.0.3
>

Your are hitting this because you are on slony 2.0.3.  Upgrade to 2.0.4 
or 2.0.5

2.0.3 had a bug that caused this issue.




> Thanks for answering so quickly, I hope this is a bit more information
> for you
>
> *From:* Vick Khera [mailto:vivek at khera.org]
> *Sent:* 30 November 2010 16:06
> *To:* Emma Lovatt
> *Cc:* slony1-general at lists.slony.info
> *Subject:* Re: [Slony1-general] Replication breaking on a table and can
> you replicate certain parts of a table
>
> On Tue, Nov 30, 2010 at 6:36 AM, Emma Lovatt
> <emma.lovatt at ticketline.co.uk <mailto:emma.lovatt at ticketline.co.uk>> wrote:
>
> You say "replication is breaking". Please describe your symptoms
> exactly. Nobody can offer you help without knowing exactly what you
> observe. Also include details on what system you have and what
> versions of your OS, Postgres, and slony you are running.
>
> My first guess based on zero information is that someone ran a schema
> alteration without running it through the slonik EXECUTE SCRIPT
> command.
>
>>  Our entire database is encoding SQL_ASCII. I found that there may be a
>>  possibility that the bytea column is not replicating and it is due to the
>>  encoding of the database which is SQL_ASCII could anyone confirm this?
>
> this is incorrect. bytea columns replicate just fine.
>
>>  My second question relates to my first if I cannot replicate my bytea
>>  column, I would like to know if it is possible to only replicate parts
> of a
>>  table and miss out certain columns, is this possible?
>
> no. the minimal unit of replication is the table.
>
> ------------------------
> This email was scanned by BitDefender.
>
> ------------------------------------------------------------------------
>
> No virus found in this message.
> Checked by AVG - www.avg.com <http://www.avg.com>
> Version: 10.0.1170 / Virus Database: 426/3288 - Release Date: 11/29/10
>
>
> ------------------------
> This email was scanned by BitDefender.
>
>
>
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


From emma.lovatt at ticketline.co.uk  Tue Nov 30 10:08:30 2010
From: emma.lovatt at ticketline.co.uk (Emma Lovatt)
Date: Tue, 30 Nov 2010 18:08:30 +0000
Subject: [Slony1-general] Replication breaking on a table and can you
	replicate certain parts of a table
In-Reply-To: <4CF53D18.7040905@ca.afilias.info>
References: <32EEB8B223E62246AE0387AC2981D9BC02D8F3FE@Nibbler.piccadillyboxoffice.com>
	<AANLkTikW7kSX5mpFgu_vVpV7Bj+Tkd2f3E1MB-LH6k+r@mail.gmail.com>
	<32EEB8B223E62246AE0387AC2981D9BC02D8F415@Nibbler.piccadillyboxoffice.com>
	<4CF53D18.7040905@ca.afilias.info>
Message-ID: <C6AE4881-C410-4D3F-BF95-76405810B600@ticketline.co.uk>

thanks Steve that's much appreciated!!!

On 30 Nov 2010, at 06:06 PM, "Steve Singer" <ssinger at ca.afilias.info> wrote:

> On 10-11-30 11:13 AM, Emma Lovatt wrote:
>> Sorry I???m working on the information the DBA has given me as I myself am
>> not a DBA but really trying hard to understand J
>> 
>> The error in the slony log is:_
>> 
>> 2010-11-10 13:21:50 GMTERROR remoteWorkerThread_1: "update only
>> "public"."stp_seatingmaps" set pa? ;
>> 
>> " ERROR: syntax error at or near ""
>> 
>> LINE 1: update only "public"."stp_seatingmaps" set pa? ;
>> 
>> This happens when that table is updated on the master and it tried to
>> replicate to the slave producing that error, we have had to turn off the
>> replication on that table for the moment.  We are running RedHat
>> Enterprise Linux 5 advanced server 64 bit, Postgresql Plus Advanced
>> server 8.4 and slony is version 2.0.3
>> 
> 
> Your are hitting this because you are on slony 2.0.3.  Upgrade to 2.0.4 or 2.0.5
> 
> 2.0.3 had a bug that caused this issue.
> 
> 
> 
> 
>> Thanks for answering so quickly, I hope this is a bit more information
>> for you
>> 
>> *From:* Vick Khera [mailto:vivek at khera.org]
>> *Sent:* 30 November 2010 16:06
>> *To:* Emma Lovatt
>> *Cc:* slony1-general at lists.slony.info
>> *Subject:* Re: [Slony1-general] Replication breaking on a table and can
>> you replicate certain parts of a table
>> 
>> On Tue, Nov 30, 2010 at 6:36 AM, Emma Lovatt
>> <emma.lovatt at ticketline.co.uk <mailto:emma.lovatt at ticketline.co.uk>> wrote:
>> 
>> You say "replication is breaking". Please describe your symptoms
>> exactly. Nobody can offer you help without knowing exactly what you
>> observe. Also include details on what system you have and what
>> versions of your OS, Postgres, and slony you are running.
>> 
>> My first guess based on zero information is that someone ran a schema
>> alteration without running it through the slonik EXECUTE SCRIPT
>> command.
>> 
>>> Our entire database is encoding SQL_ASCII. I found that there may be a
>>> possibility that the bytea column is not replicating and it is due to the
>>> encoding of the database which is SQL_ASCII could anyone confirm this?
>> 
>> this is incorrect. bytea columns replicate just fine.
>> 
>>> My second question relates to my first if I cannot replicate my bytea
>>> column, I would like to know if it is possible to only replicate parts
>> of a
>>> table and miss out certain columns, is this possible?
>> 
>> no. the minimal unit of replication is the table.
>> 
>> ------------------------
>> This email was scanned by BitDefender.
>> 
>> ------------------------------------------------------------------------
>> 
>> No virus found in this message.
>> Checked by AVG - www.avg.com <http://www.avg.com>
>> Version: 10.0.1170 / Virus Database: 426/3288 - Release Date: 11/29/10
>> 
>> 
>> ------------------------
>> This email was scanned by BitDefender.
>> 
>> 
>> 
>> _______________________________________________
>> Slony1-general mailing list
>> Slony1-general at lists.slony.info
>> http://lists.slony.info/mailman/listinfo/slony1-general
> 
> 
> ------------------------
> This email was scanned by BitDefender.

------------------------
This email was scanned by BitDefender.

