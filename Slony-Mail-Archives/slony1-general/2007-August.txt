From cbbrowne at ca.afilias.info  Wed Aug  1 06:15:41 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Wed Aug  1 06:15:45 2007
Subject: [Slony1-general] Re: log shipping gone wrong
In-Reply-To: <2ca799770707312105h7eb778f2l78c6b6e2885652e1@mail.gmail.com>
	(Mikko Partio's message of "Wed, 1 Aug 2007 07:05:38 +0300")
References: <2ca799770707200605j1bb37c13o98c86a21834db2ab@mail.gmail.com>
	<2ca799770707222327y5e5939bg6ccee843d0ef0097@mail.gmail.com>
	<46A4AE4F.4080304@Yahoo.com>
	<2ca799770707230728h3e3afa3auefdc1ae8dd429156@mail.gmail.com>
	<46A4C3E7.1020107@Yahoo.com>
	<2ca799770707232129p27822251v9947c748d2395630@mail.gmail.com>
	<46ACCF3A.9050005@Yahoo.com>
	<2ca799770707312105h7eb778f2l78c6b6e2885652e1@mail.gmail.com>
Message-ID: <60tzrjbdky.fsf@dba2.int.libertyrms.com>

"Mikko Partio" <mpartio@gmail.com> writes:
> On 7/29/07, Jan Wieck <[[JanWieck@yahoo.com]]> wrote:
>
>           On 7/24/2007 12:29 AM, Mikko Partio wrote:
>      >
>      >???? What I meant is that it'd be good to get enough detail information about
>      >???? the specific actions that lead to this problem in order to create a
>      >???? standalone test that can reproduce it.
>      >
>      >
>      > Ok here comes:
>      
>      This one played quite a bit hide and seek with me. But I think I found
>      and fixed the bug.
>      
>      The problem occurred when some action (like STORE_SET) caused the
>      subscriber slon to perform an internal restart. During that, the current
>      setsync tracking in the pset structure is reinitialized. However, since
>      the sl_setsync table is not updated on events other than SYNC, this
>      would lead to the wrong (too low) old sync expected if the last event(s)
>      processed from that node where no SYNC events.
>      
>      Thanks for the detailed example.
>      
>
>
> Great that you got it fixed! Will the patch be included in the 1.2.11 release?
> Regards
> MP

Yes, it's in what will be 1.2.11.

I have not been able to get the log shipping test in the
tests/testlogship directory in the code base to exercise the problem.
Now, the patch is applied in CVS, so that either a checkout of the 1.2
branch, or application of the patch to a copy of source that you may
have would allow you to deploy it for testing, at least.

I'd be more than happy to make a tarball available for you, if that
would help you run a test to verify that this fixes the problem for
you.
-- 
output = reverse("ofni.sesabatadxunil" "@" "enworbbc")
http://linuxdatabases.info/info/wp.html
"Consistency requires you to be as  ignorant today as  you were a year
ago."  -- Bernard Berenson
From laurent at over-blog.com  Wed Aug  1 09:30:10 2007
From: laurent at over-blog.com (Laurent Raufaste)
Date: Wed Aug  1 09:30:30 2007
Subject: [Slony1-general] Slony lag times
Message-ID: <46B0B512.1090404@over-blog.com>

Hi,

We are using Slony on a production environment and are very pleased by it.

Our cluster is made of 1 master, 4 slaves that needs to be replicated
fast, and 2 slaves for which the replication speed isn't a problem.

Here's our issue: In the sl_status view I notice that the st_lag_time is
always between 1 and many seconds: it goes up to 10 seconds regularly,
and approximatively one time a day, there is always a slave reaching 1
min, for example while vacuuming.

I tried playing with the folllowing options:
     -s <milliseconds>     SYNC check interval (default 10000)
     -t <milliseconds>     SYNC interval timeout (default 60000)
     -o <milliseconds>     desired subscriber SYNC processing time
     -g <num>              maximum SYNC group size (default 6)

Now on the master I have:
-s 1000 -g 50
On the fast slaves I have:
-s 1000
And on the slow slaves:
-s 10000 -g 10

I tried lowering the SYNC check interval to 500ms with no real effect,
and the master is already loaded enough anyway ;)

Is there an effective way to shorten the replication lag time ?

A Slony noob.

-- 
Laurent Raufaste
JFG Networks
<http://www.over-blog.com/>

From jeff at frostconsultingllc.com  Wed Aug  1 10:22:48 2007
From: jeff at frostconsultingllc.com (Jeff Frost)
Date: Wed Aug  1 10:22:56 2007
Subject: [Slony1-general] problems with slony1-1.2.10 and postgresql-8.2.4
Message-ID: <Pine.LNX.4.64.0708011022360.2605@glacier.frostconsultingllc.com>

Hi folks,

In an effort to upgrade a cluster from slony1-1.2.6 and postgresql-8.1.8, I 
dumped the DB, upgraded to postgresql-8.2.4, comiled and installed 
slony1-1.2.10 and then tried to restore the DB on the master.  The restore 
crashed the backend every time when trying to restore our slony_test table. So 
I opted to go a different route and installed 8.1.9, moved the old data 
directory in, dropped the slony schema cascade and dumped the db.  Then I 
restored that into 8.2.4 successfully.  After upgrading the slave to 8.2.4 and 
1.2.10, I tried to subscribe the slave, but the slonik command errored out and 
left the following in the postgresql log:

Jul 29 15:48:49 testdb1 postgres[1173]: [1-1] ERROR:  could not access file
"$libdir/xxid": No such file or directory
Jul 29 15:48:49 testdb1 postgres[1173]: [1-2] STATEMENT:  load
'$libdir/xxid';

This is what slonik complained about:

<stdin>:17: PGRES_FATAL_ERROR load '$libdir/xxid'; - ERROR: incompatible 
library "/usr/lib64/pgsql/xxid.so": missing magic block

Except, I don't know why it's looking in /usr/lib64/pgsql because this is a 32 
bit CentOS 4.3 machine.  I double checked that the i686 versions of postgres 
are installed, slony was compiled from source against /usr/bin/pg_config which 
correctly outputs that libdir is /usr/lib/pgsql:
PKGLIBDIR = /usr/lib/pgsql

What am I missing?  Is there a special procedure for using Postgresql-8.2.4?

It yielded the same results with slony 1.2.8 and 1.2.9.  But, 1.2.10 is working 
fine with postgresql-8.1.9 which we reverted to.

-- 
Jeff Frost, Owner 	<jeff@frostconsultingllc.com>
Frost Consulting, LLC 	http://www.frostconsultingllc.com/
Phone: 650-780-7908	FAX: 650-649-1954
From mpartio at gmail.com  Wed Aug  1 11:05:10 2007
From: mpartio at gmail.com (Mikko Partio)
Date: Wed Aug  1 11:05:18 2007
Subject: [Slony1-general] Re: log shipping gone wrong
In-Reply-To: <60tzrjbdky.fsf@dba2.int.libertyrms.com>
References: <2ca799770707200605j1bb37c13o98c86a21834db2ab@mail.gmail.com>
	<2ca799770707222327y5e5939bg6ccee843d0ef0097@mail.gmail.com>
	<46A4AE4F.4080304@Yahoo.com>
	<2ca799770707230728h3e3afa3auefdc1ae8dd429156@mail.gmail.com>
	<46A4C3E7.1020107@Yahoo.com>
	<2ca799770707232129p27822251v9947c748d2395630@mail.gmail.com>
	<46ACCF3A.9050005@Yahoo.com>
	<2ca799770707312105h7eb778f2l78c6b6e2885652e1@mail.gmail.com>
	<60tzrjbdky.fsf@dba2.int.libertyrms.com>
Message-ID: <2ca799770708011105t4e9ac03dp542960e8b4daed65@mail.gmail.com>

On 8/1/07, Christopher Browne <cbbrowne@ca.afilias.info> wrote:
>
>
> I'd be more than happy to make a tarball available for you, if that
> would help you run a test to verify that this fixes the problem for
> you.



Yes sure if you're willing to roll out a pre-release I can try it out.

regards

MP
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070801/=
16c6e8ae/attachment.htm
From cbbrowne at ca.afilias.info  Wed Aug  1 12:54:54 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Wed Aug  1 12:55:03 2007
Subject: [Slony1-general] Slony lag times
In-Reply-To: <46B0B512.1090404@over-blog.com>
References: <46B0B512.1090404@over-blog.com>
Message-ID: <46B0E50E.2080604@ca.afilias.info>

Laurent Raufaste wrote:
> Hi,
>
> We are using Slony on a production environment and are very pleased by 
> it.
>
> Our cluster is made of 1 master, 4 slaves that needs to be replicated
> fast, and 2 slaves for which the replication speed isn't a problem.
>
> Here's our issue: In the sl_status view I notice that the st_lag_time is
> always between 1 and many seconds: it goes up to 10 seconds regularly,
> and approximatively one time a day, there is always a slave reaching 1
> min, for example while vacuuming.
>
If the problem is essentially that the master is overloaded, then there 
isn't any configuration change likely to help.  There is no guaranteeing 
that subscribers will be Right Up To Date.
> I tried playing with the folllowing options:
>     -s <milliseconds>     SYNC check interval (default 10000)
>     -t <milliseconds>     SYNC interval timeout (default 60000)
>     -o <milliseconds>     desired subscriber SYNC processing time
>     -g <num>              maximum SYNC group size (default 6)
>
> Now on the master I have:
> -s 1000 -g 50
> On the fast slaves I have:
> -s 1000
> And on the slow slaves:
> -s 10000 -g 10
>
> I tried lowering the SYNC check interval to 500ms with no real effect,
> and the master is already loaded enough anyway ;)
There are seeming misconceptions in how you're configuring it...

- On the origin node, the "-g" option is pretty much irrelevant.  -g 
affects how *subscribers* group together SYNCs into groups; since the 
origin does not apply any SYNCs coming from subscribers, it is 
irrelevant to do any grouping there.

- On the other hand, the main node where the "-s" (and -t) options have 
meaningful effect is on an origin node, as that is the option which 
controls how often SYNCs are generated.  (SYNCs get generated on 
non-origin nodes, but those SYNCs don't lead to any replication work 
being done, so they're very uninteresting.)  Thus, setting "-s 1000" 
versus "-s 10000" on subscriber nodes is pretty much irrelevant.
> Is there an effective way to shorten the replication lag time ?
>
> A Slony noob.
>
Speed is an "emergent property," falling from how much work is being 
thrown at the system (e.g. - what are you doing to overload it) and how 
much hardware there is to do replication work.

Tuning the DBMS, tuning OS, tuning hardware, and such, will have some 
effect.  In the long run, though, the main way is to get faster network 
and disk hardware...

From drees76 at gmail.com  Wed Aug  1 17:23:26 2007
From: drees76 at gmail.com (David Rees)
Date: Wed Aug  1 17:23:37 2007
Subject: [Slony1-general] problems with slony1-1.2.10 and postgresql-8.2.4
In-Reply-To: <Pine.LNX.4.64.0708011022360.2605@glacier.frostconsultingllc.com>
References: <Pine.LNX.4.64.0708011022360.2605@glacier.frostconsultingllc.com>
Message-ID: <72dbd3150708011723qb80ef8fydae4dd5f75fa1292@mail.gmail.com>

On 8/1/07, Jeff Frost <jeff@frostconsultingllc.com> wrote:
> <stdin>:17: PGRES_FATAL_ERROR load '$libdir/xxid'; - ERROR: incompatible
> library "/usr/lib64/pgsql/xxid.so": missing magic block
>
> Except, I don't know why it's looking in /usr/lib64/pgsql because this is a 32
> bit CentOS 4.3 machine.  I double checked that the i686 versions of postgres
> are installed, slony was compiled from source against /usr/bin/pg_config which
> correctly outputs that libdir is /usr/lib/pgsql:
> PKGLIBDIR = /usr/lib/pgsql
>
> What am I missing?  Is there a special procedure for using Postgresql-8.2.4?
>
> It yielded the same results with slony 1.2.8 and 1.2.9.  But, 1.2.10 is working
> fine with postgresql-8.1.9 which we reverted to.

Weird. I haven't seen that before, but I haven't been using slony for
that long, either. I have multiple servers running a combination of
CentOS 4.5 (32bit & 64bit), CentOS 5 and Fedora Core 6 using
PostgreSQL 8.2.4 and Slony 1.2.10.

I've also upgraded PostgreSQL from a previous 8.2.x version as well as
Slony from a previous 1.2.x version on them without any issues.

When you upgrade, are you recompiling/reinstalling both Postgres and
also Slony against the upgraded Postgres? I suspect that you may be
missing the Slony modules in your Postgres install.

When I upgrade I put Postgres / Slony into a unique directory for each
build (for example /usr/local/pgsql-8.2.4-2007080101 and
/usr/local/slony-1.2.10-2007080101) and then symlink that folder to
the same folder name without the version so I don't have to bother
updating paths and startup scripts.

When updating a minor version of pgsql I haven't had to
recompile/reinstall slony as long as I remember to copy the slony
modules over to the new pgsql directory.

I also notice that you're not fully updated with CentOS, is there a
reason you're not fully updated to CentOS 4.5? I doubt this has
anything to do with your issue, but it can't hurt.

-Dave
From jeff at frostconsultingllc.com  Wed Aug  1 18:07:10 2007
From: jeff at frostconsultingllc.com (Jeff Frost)
Date: Wed Aug  1 18:07:30 2007
Subject: [Slony1-general] problems with slony1-1.2.10 and postgresql-8.2.4
In-Reply-To: <72dbd3150708011723qb80ef8fydae4dd5f75fa1292@mail.gmail.com>
References: <Pine.LNX.4.64.0708011022360.2605@glacier.frostconsultingllc.com>
	<72dbd3150708011723qb80ef8fydae4dd5f75fa1292@mail.gmail.com>
Message-ID: <Pine.LNX.4.64.0708011802500.1940@discord.home.frostconsultingllc.com>

On Wed, 1 Aug 2007, David Rees wrote:

> On 8/1/07, Jeff Frost <jeff@frostconsultingllc.com> wrote:
>> <stdin>:17: PGRES_FATAL_ERROR load '$libdir/xxid'; - ERROR: incompatible
>> library "/usr/lib64/pgsql/xxid.so": missing magic block
>>
>> Except, I don't know why it's looking in /usr/lib64/pgsql because this is a 32
>> bit CentOS 4.3 machine.  I double checked that the i686 versions of postgres
>> are installed, slony was compiled from source against /usr/bin/pg_config which
>> correctly outputs that libdir is /usr/lib/pgsql:
>> PKGLIBDIR = /usr/lib/pgsql
>>
>> What am I missing?  Is there a special procedure for using Postgresql-8.2.4?
>>
>> It yielded the same results with slony 1.2.8 and 1.2.9.  But, 1.2.10 is working
>> fine with postgresql-8.1.9 which we reverted to.
>
> Weird. I haven't seen that before, but I haven't been using slony for
> that long, either. I have multiple servers running a combination of
> CentOS 4.5 (32bit & 64bit), CentOS 5 and Fedora Core 6 using
> PostgreSQL 8.2.4 and Slony 1.2.10.

Great to hear it's working for someone!  I'm sure we have something odd going 
on with that particular machine but couldn't leave it broken any longer to 
figure it out.

>
> I've also upgraded PostgreSQL from a previous 8.2.x version as well as
> Slony from a previous 1.2.x version on them without any issues.
>
> When you upgrade, are you recompiling/reinstalling both Postgres and
> also Slony against the upgraded Postgres? I suspect that you may be
> missing the Slony modules in your Postgres install.
>

Yes, though I am installing postgresql from the community RPMs and compiling 
slony from source.  I even manually specific the pg_config binary for slony to 
use during ./configure.  I also went through /usr/share/pgsql and 
/usr/lib/pgsql and manually removed all the old slony files, did a find for 
them across the filesystem and then reinstalled and made sure they really 
showed up where I expected them.  But, no love.


> When I upgrade I put Postgres / Slony into a unique directory for each
> build (for example /usr/local/pgsql-8.2.4-2007080101 and
> /usr/local/slony-1.2.10-2007080101) and then symlink that folder to
> the same folder name without the version so I don't have to bother
> updating paths and startup scripts.
>

I do that as well for the slony installs, but again, postgres is installed via 
rpm.

> When updating a minor version of pgsql I haven't had to
> recompile/reinstall slony as long as I remember to copy the slony
> modules over to the new pgsql directory.
>

Same for me, but we were going from 8.1.8 to 8.2.4 in this case and thus the 
fun.


> I also notice that you're not fully updated with CentOS, is there a
> reason you're not fully updated to CentOS 4.5? I doubt this has
> anything to do with your issue, but it can't hurt.
>

That server is slated to go straight to CentOS 5 during the next update cycle.

We'll be creating a test environment like this setup to try and reproduce the 
problem sometime this week.  Hopefully that'll provide some clues.

-- 
Jeff Frost, Owner 	<jeff@frostconsultingllc.com>
Frost Consulting, LLC 	http://www.frostconsultingllc.com/
Phone: 650-780-7908	FAX: 650-649-1954
From drees76 at gmail.com  Wed Aug  1 18:38:21 2007
From: drees76 at gmail.com (David Rees)
Date: Wed Aug  1 18:38:33 2007
Subject: [Slony1-general] Slony lag times
In-Reply-To: <46B0B512.1090404@over-blog.com>
References: <46B0B512.1090404@over-blog.com>
Message-ID: <72dbd3150708011838y5ef2f545i342ed0d8e6b12277@mail.gmail.com>

On 8/1/07, Laurent Raufaste <laurent@over-blog.com> wrote:
> Here's our issue: In the sl_status view I notice that the st_lag_time is
> always between 1 and many seconds: it goes up to 10 seconds regularly,
> and approximatively one time a day, there is always a slave reaching 1
> min, for example while vacuuming.
>
> I tried playing with the folllowing options:
>      -s <milliseconds>     SYNC check interval (default 10000)
>      -t <milliseconds>     SYNC interval timeout (default 60000)
>      -o <milliseconds>     desired subscriber SYNC processing time
>      -g <num>              maximum SYNC group size (default 6)
>
> Now on the master I have:
> -s 1000 -g 50
> On the fast slaves I have:
> -s 1000
> And on the slow slaves:
> -s 10000 -g 10
>
> I tried lowering the SYNC check interval to 500ms with no real effect,
> and the master is already loaded enough anyway ;)
>
> Is there an effective way to shorten the replication lag time ?

As Chris mentioned, in terms of reducing replication lag time using
slony configuration options, setting -s (sync check interval) lower on
the set origin servers is the only way to reduce replication lag.

My understanding is if there is no database insert/update activity on
the master, no syncs will be generated no matter how low the sync
check interval is set until the sync interval timeout is reached. This
means that your sl_lag_time will be higher than your actual
replication lag time (unless of course you hit the race condition
mentioned in the docs related to the sync interval timeout setting).

So on your slaves where there is no insert/update activity, the
st_lag_time will always run up to your sync interval timeout before
going to zero.

On your masters sl_lag_time will increase until slon processes a sync
while polling at the sync check interval or until a sync is generated
because of the sync interval timeout.

You can verify this by setting your sync interval timeout to a large
value. If your database is consistently updated st_lag_time will
remain low, otherwise it will increase until a sync is generated.

IMO a better indication of how far back the slave is to compare
st_last_event, st_last_received_event (they should match up or be
close) and st_last_received_ts and st_last_received_event_ts (this
should be appx how long it took the last received event to get
replicated and for the slave to notify the master).

Perhaps renaming st_lag_time to st_sync_lag_time and making
st_lag_time (st_last_received_ts - st_last_received_event_ts) would be
more intuitive.

I use a sync check interval of 250 and a sync interval timeout of
10000. The higher timeout setting increases the risk of the race
condition mentioned in the docs resulting in occasional sync intervals
which are longer, but that's OK for my case and I'd rather have fewer
syncs generated during idle periods. If you want to be sure that you
get replication events processed as quickly as possible set the check
interval and interval timeout low for the master slon process.

I'm still pretty new to Slony, too so if I am incorrect in any of my
understandings, please correct me!

-Dave
From drees76 at gmail.com  Wed Aug  1 20:03:38 2007
From: drees76 at gmail.com (David Rees)
Date: Wed Aug  1 20:03:52 2007
Subject: [Slony1-general] problems with slony1-1.2.10 and postgresql-8.2.4
In-Reply-To: <Pine.LNX.4.64.0708011802500.1940@discord.home.frostconsultingllc.com>
References: <Pine.LNX.4.64.0708011022360.2605@glacier.frostconsultingllc.com>
	<72dbd3150708011723qb80ef8fydae4dd5f75fa1292@mail.gmail.com>
	<Pine.LNX.4.64.0708011802500.1940@discord.home.frostconsultingllc.com>
Message-ID: <72dbd3150708012003s11bac86dk1b7c87c4a5b79625@mail.gmail.com>

On 8/1/07, Jeff Frost <jeff@frostconsultingllc.com> wrote:
> > When I upgrade I put Postgres / Slony into a unique directory for each
> > build (for example /usr/local/pgsql-8.2.4-2007080101 and
> > /usr/local/slony-1.2.10-2007080101) and then symlink that folder to
> > the same folder name without the version so I don't have to bother
> > updating paths and startup scripts.
>
> I do that as well for the slony installs, but again, postgres is installed via
> rpm.

I wonder if the 8.2.4 rpm is built on a 64bit machine? I would
recommend compiling both postgresql and slony from source.

-Dave
From jeff at frostconsultingllc.com  Wed Aug  1 20:15:23 2007
From: jeff at frostconsultingllc.com (Jeff Frost)
Date: Wed Aug  1 20:15:39 2007
Subject: [Slony1-general] problems with slony1-1.2.10 and postgresql-8.2.4
In-Reply-To: <72dbd3150708012003s11bac86dk1b7c87c4a5b79625@mail.gmail.com>
References: <Pine.LNX.4.64.0708011022360.2605@glacier.frostconsultingllc.com>
	<72dbd3150708011723qb80ef8fydae4dd5f75fa1292@mail.gmail.com> 
	<Pine.LNX.4.64.0708011802500.1940@discord.home.frostconsultingllc.com>
	<72dbd3150708012003s11bac86dk1b7c87c4a5b79625@mail.gmail.com>
Message-ID: <Pine.LNX.4.64.0708012011050.1940@discord.home.frostconsultingllc.com>

On Wed, 1 Aug 2007, David Rees wrote:

> On 8/1/07, Jeff Frost <jeff@frostconsultingllc.com> wrote:
>>> When I upgrade I put Postgres / Slony into a unique directory for each
>>> build (for example /usr/local/pgsql-8.2.4-2007080101 and
>>> /usr/local/slony-1.2.10-2007080101) and then symlink that folder to
>>> the same folder name without the version so I don't have to bother
>>> updating paths and startup scripts.
>>
>> I do that as well for the slony installs, but again, postgres is installed via
>> rpm.
>
> I wonder if the 8.2.4 rpm is built on a 64bit machine? I would
> recommend compiling both postgresql and slony from source.

Devrim,

If you're watching this thread, do you care to comment?

I don't see why it would matter as a 64-bit machine can make i386 and i686 
binaries just as well as x86_64.

If I extract the files from the postgresql-server rpm and run file against 
them, it shows them all as 32-bit executables:

initdb:         ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), for 
GNU/Linux 2.2.5, dynamically linked (uses shared libs), stripped
ipcclean:       Bourne shell script text executable
pg_controldata: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), for 
GNU/Linux 2.2.5, dynamically linked (uses shared libs), stripped
pg_ctl:         ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), for 
GNU/Linux 2.2.5, dynamically linked (uses shared libs), stripped
pg_resetxlog:   ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), for 
GNU/Linux 2.2.5, dynamically linked (uses shared libs), stripped
postgres:       ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), for 
GNU/Linux 2.2.5, dynamically linked (uses shared libs), stripped
postmaster:     symbolic link to `postgres'

The same was true of all the shared modules in /usr/lib/pgsql.

Also, "strings * |grep lib64" returned nothing whereas "strings * | grep lib" 
returns the following interesting tidbits:

/usr/lib
/usr/lib/pgsql

So it really makes no sense to me that it's looking in lib64.  More info later 
when I have another machine to test on.

-- 
Jeff Frost, Owner 	<jeff@frostconsultingllc.com>
Frost Consulting, LLC 	http://www.frostconsultingllc.com/
Phone: 650-780-7908	FAX: 650-649-1954
From laurent at over-blog.com  Wed Aug  1 09:27:10 2007
From: laurent at over-blog.com (Laurent Raufaste)
Date: Thu Aug  2 08:11:38 2007
Subject: [Slony1-general] (pas de sujet)
Message-ID: <46B0B45E.7080303@over-blog.com>


-- 
Laurent Raufaste
JFG Networks
<http://www.over-blog.com/>
From andrew.george.hammond at gmail.com  Thu Aug  2 10:47:37 2007
From: andrew.george.hammond at gmail.com (Andrew Hammond)
Date: Thu Aug  2 10:47:44 2007
Subject: [Slony1-general] Slony lag times
In-Reply-To: <46ADA5D6.3080101@over-blog.com>
References: <46ADA5D6.3080101@over-blog.com>
Message-ID: <5a0a9d6f0708021047g5f22b0e8jb4086727453dc41d@mail.gmail.com>

On 7/30/07, Laurent Raufaste <laurent@over-blog.com> wrote:
>
> Hi,
>
> We are using Slony on a production environment and are very pleased by it.
>
> Our cluster is made of 1 master, 4 slaves that needs to be replicated
> fast, and 2 slaves for which the replication speed isn't a problem.
>
> Here's our issue: In the sl_status view I notice that the st_lag_time is
> always between 1 and many seconds: it goes up to 10 seconds regularly,
> and approximatively one time a day, there is always a slave reaching 1
> min, for example while vacuuming.


1 to 10 seconds is pretty good. If there aren't any changes to tables on the
origin then SYNC events are only generated every 10 seconds (by default). Do
you have enough DML (inserts, updates and deletes) traffic to keep the syncs
flowing? Even if there are plenty of changes to record, by default, syncs
are only generated every 2 seconds, so any lag time of less than 2 seconds
is effectively as up to date as possible.

I tried playing with the folllowing options:
>      -s <milliseconds>     SYNC check interval (default 10000)
>      -t <milliseconds>     SYNC interval timeout (default 60000)
>      -o <milliseconds>     desired subscriber SYNC processing time
>      -g <num>              maximum SYNC group size (default 6)
>
> Now on the master I have:
> -s 1000 -g 50
> On the fast slaves I have:
> -s 1000
> And on the slow slaves:
> -s 10000 -g 10


Are you running slony 1.2? Those defaults look wrong. If you aren't running
1.2.latest then you should consider upgrading.


> I tried lowering the SYNC check interval to 500ms with no real effect,
> and the master is already loaded enough anyway ;)
>
> Is there an effective way to shorten the replication lag time ?


If it's because of inactivity, then you can decrease your
sync_interval_timeout, however the real effect of this is to just make the
lag time look better. (There's an edge case here involving sequences)

If you have plenty of activity then you _might_ consider lowering your
sync_interval (the rate at which slony checks to see if there's anything to
put into a new sync) on your origin. This will increase the load on your
origin, so you will want to do it incrementally and measure the effect.

As your sync interval decreases and load increases, you might need to start
throwing hardware at it. The criteria for deciding that are the same as for
any other database.

Remember that slony is an asynchronous replication system. A system designed
with a strong dependency on very low replication lag time suggests that you
may be trying to fit asynchronous replication into the role of synchronous
replication.

Andrew
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070802/=
1483be8a/attachment.htm
From dmitry at koterov.ru  Thu Aug  2 11:42:39 2007
From: dmitry at koterov.ru (Dmitry Koterov)
Date: Thu Aug  2 11:42:49 2007
Subject: [Slony1-general] Slony lag times
In-Reply-To: <5a0a9d6f0708021047g5f22b0e8jb4086727453dc41d@mail.gmail.com>
References: <46ADA5D6.3080101@over-blog.com>
	<5a0a9d6f0708021047g5f22b0e8jb4086727453dc41d@mail.gmail.com>
Message-ID: <d7df81620708021142v5f9d901fy6263ffb101113389@mail.gmail.com>

Aagrh, everybody says these words - "synchronous replication", but these
words are useless in practice. I suppose there is NO good solution of
Postgres synchronous replication for REALLY heavy-loaded systems, and saying
"you possibly need a synchronous replication" is equal to saying "you must
be reach and almighty".

Lag of 1-10 seconds is really usual. It's an unavoidable evil for slony,
unfortunately.
Try to read some data critical for time from a master.

On 8/2/07, Andrew Hammond <andrew.george.hammond@gmail.com> wrote:
>
> On 7/30/07, Laurent Raufaste <laurent@over-blog.com> wrote:
> >
> > Hi,
> >
> > We are using Slony on a production environment and are very pleased by
> > it.
> >
> > Our cluster is made of 1 master, 4 slaves that needs to be replicated
> > fast, and 2 slaves for which the replication speed isn't a problem.
> >
> > Here's our issue: In the sl_status view I notice that the st_lag_time is
> > always between 1 and many seconds: it goes up to 10 seconds regularly,
> > and approximatively one time a day, there is always a slave reaching 1
> > min, for example while vacuuming.
>
>
> 1 to 10 seconds is pretty good. If there aren't any changes to tables on
> the origin then SYNC events are only generated every 10 seconds (by
> default). Do you have enough DML (inserts, updates and deletes) traffic to
> keep the syncs flowing? Even if there are plenty of changes to record, by
> default, syncs are only generated every 2 seconds, so any lag time of less
> than 2 seconds is effectively as up to date as possible.
>
> I tried playing with the folllowing options:
> >      -s <milliseconds>     SYNC check interval (default 10000)
> >      -t <milliseconds>     SYNC interval timeout (default 60000)
> >      -o <milliseconds>     desired subscriber SYNC processing time
> >      -g <num>              maximum SYNC group size (default 6)
> >
> > Now on the master I have:
> > -s 1000 -g 50
> > On the fast slaves I have:
> > -s 1000
> > And on the slow slaves:
> > -s 10000 -g 10
>
>
> Are you running slony 1.2? Those defaults look wrong. If you aren't
> running 1.2.latest then you should consider upgrading.
>
>
> > I tried lowering the SYNC check interval to 500ms with no real effect,
> > and the master is already loaded enough anyway ;)
> >
> > Is there an effective way to shorten the replication lag time ?
>
>
> If it's because of inactivity, then you can decrease your
> sync_interval_timeout, however the real effect of this is to just make the
> lag time look better. (There's an edge case here involving sequences)
>
> If you have plenty of activity then you _might_ consider lowering your
> sync_interval (the rate at which slony checks to see if there's anything =
to
> put into a new sync) on your origin. This will increase the load on your
> origin, so you will want to do it incrementally and measure the effect.
>
> As your sync interval decreases and load increases, you might need to
> start throwing hardware at it. The criteria for deciding that are the same
> as for any other database.
>
> Remember that slony is an asynchronous replication system. A system
> designed with a strong dependency on very low replication lag time sugges=
ts
> that you may be trying to fit asynchronous replication into the role of
> synchronous replication.
>
> Andrew
>
> _______________________________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070802/=
216a2fb3/attachment.htm
From andrew.george.hammond at gmail.com  Thu Aug  2 12:17:46 2007
From: andrew.george.hammond at gmail.com (Andrew Hammond)
Date: Thu Aug  2 12:17:56 2007
Subject: [Slony1-general] Slony lag times
In-Reply-To: <d7df81620708021142v5f9d901fy6263ffb101113389@mail.gmail.com>
References: <46ADA5D6.3080101@over-blog.com>
	<5a0a9d6f0708021047g5f22b0e8jb4086727453dc41d@mail.gmail.com>
	<d7df81620708021142v5f9d901fy6263ffb101113389@mail.gmail.com>
Message-ID: <5a0a9d6f0708021217g4703fa70rb73ab86d1fcb01e4@mail.gmail.com>

On 8/2/07, Dmitry Koterov <dmitry@koterov.ru> wrote:
>
> Aagrh, everybody says these words - "synchronous replication", but these
> words are useless in practice. I suppose there is NO good solution of
> Postgres synchronous replication for REALLY heavy-loaded systems, and say=
ing
> "you possibly need a synchronous replication" is equal to saying "you must
> be reach and almighty".


No, it's more like saying "You're trying to get this tool to do something
it's not designed to do. Here is the formal term used to describe the tool
you seem to want." If you insist on using PostgreSQL then... no, such a tool
doesn't currently exist (at least not in a state that people are
recommending it for production). That is _not_ useless in practice. When
designing a system, it is valuable to know what is _not_ possible with a
given tool.


> Lag of 1-10 seconds is really usual. It's an unavoidable evil for slony,
> unfortunately.


I agree that, given the existing design, a lag is unavoidable. Hence the
term asynchronous. Exactly how is this evil? It's _exactly_ what the system
is designed to be.


Try to read some data critical for time from a master.
>
> On 8/2/07, Andrew Hammond <andrew.george.hammond@gmail.com> wrote:
>
> > On 7/30/07, Laurent Raufaste <laurent@over-blog.com> wrote:
> > >
> > > Hi,
> > >
> > > We are using Slony on a production environment and are very pleased by
> > > it.
> > >
> > > Our cluster is made of 1 master, 4 slaves that needs to be replicated
> > > fast, and 2 slaves for which the replication speed isn't a problem.
> > >
> > > Here's our issue: In the sl_status view I notice that the st_lag_time
> > > is
> > > always between 1 and many seconds: it goes up to 10 seconds regularly,
> > > and approximatively one time a day, there is always a slave reaching 1
> > >
> > > min, for example while vacuuming.
> >
> >
> > 1 to 10 seconds is pretty good. If there aren't any changes to tables on
> > the origin then SYNC events are only generated every 10 seconds (by
> > default). Do you have enough DML (inserts, updates and deletes) traffic=
 to
> > keep the syncs flowing? Even if there are plenty of changes to record, =
by
> > default, syncs are only generated every 2 seconds, so any lag time of l=
ess
> > than 2 seconds is effectively as up to date as possible.
> >
> > I tried playing with the folllowing options:
> > >      -s <milliseconds>     SYNC check interval (default 10000)
> > >      -t <milliseconds>     SYNC interval timeout (default 60000)
> > >      -o <milliseconds>     desired subscriber SYNC processing time
> > >      -g <num>              maximum SYNC group size (default 6)
> > >
> > > Now on the master I have:
> > > -s 1000 -g 50
> > > On the fast slaves I have:
> > > -s 1000
> > > And on the slow slaves:
> > > -s 10000 -g 10
> >
> >
> > Are you running slony 1.2? Those defaults look wrong. If you aren't
> > running 1.2.latest then you should consider upgrading.
> >
> >
> > > I tried lowering the SYNC check interval to 500ms with no real effect,
> > >
> > > and the master is already loaded enough anyway ;)
> > >
> > > Is there an effective way to shorten the replication lag time ?
> >
> >
> > If it's because of inactivity, then you can decrease your
> > sync_interval_timeout, however the real effect of this is to just make =
the
> > lag time look better. (There's an edge case here involving sequences)
> >
> > If you have plenty of activity then you _might_ consider lowering your
> > sync_interval (the rate at which slony checks to see if there's anythin=
g to
> > put into a new sync) on your origin. This will increase the load on your
> > origin, so you will want to do it incrementally and measure the effect.
> >
> > As your sync interval decreases and load increases, you might need to
> > start throwing hardware at it. The criteria for deciding that are the s=
ame
> > as for any other database.
> >
> > Remember that slony is an asynchronous replication system. A system
> > designed with a strong dependency on very low replication lag time sugg=
ests
> > that you may be trying to fit asynchronous replication into the role of
> > synchronous replication.
> >
> > Andrew
> >
> > _______________________________________________
> > Slony1-general mailing list
> > Slony1-general@lists.slony.info
> > http://lists.slony.info/mailman/listinfo/slony1-general
> >
> >
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070802/=
29afe025/attachment.htm
From cbbrowne at ca.afilias.info  Thu Aug  2 13:12:57 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Thu Aug  2 13:13:08 2007
Subject: [Slony1-general] Slony lag times
In-Reply-To: <5a0a9d6f0708021047g5f22b0e8jb4086727453dc41d@mail.gmail.com>
References: <46ADA5D6.3080101@over-blog.com>
	<5a0a9d6f0708021047g5f22b0e8jb4086727453dc41d@mail.gmail.com>
Message-ID: <46B23AC9.6010206@ca.afilias.info>

Andrew Hammond wrote:
> As your sync interval decreases and load increases, you might need to 
> start throwing hardware at it. The criteria for deciding that are the 
> same as for any other database.
>
> Remember that slony is an asynchronous replication system. A system 
> designed with a strong dependency on very low replication lag time 
> suggests that you may be trying to fit asynchronous replication into 
> the role of synchronous replication.
[Aside: Other comments you made were ones I agreed with such that they 
needed no further comment]

It seems like a misdirection, to me, to point at 
asynchronous-versus-synchronous as being anything of an "approach."

It is certainly fair to say that Slony-I was designed to be 
asynchronous, and that this has the *necessary implication* that, under 
heavy load, other nodes will fall behind.

The alternative, however, isn't much of an alternative, from a number of 
perspectives:

1.  There isn't any synchronous replication system for PostgreSQL to 
correspond with Slony-I.  So part of what you're saying is, in effect, 
"You should get a synchronous replication system.  Oops!  There isn't 
one!  I keed, I keed!"  (The latter in the voice of Triumph the Insult 
Comic Dog...)

2.  If there was a synchronous replication system, it wouldn't change 
the answers in any particularly useful fashion.

What you'd discover is that, under load, the need to replicate 
synchronously would lead to the *master* node, itself, trying to fall 
behind, which would express itself as the master node getting more and 
more sluggish so as to prevent replication from falling behind.

On 8/2/07, *Dmitry Koterov* <dmitry@koterov.ru 
<mailto:dmitry@koterov.ru>> wrote:

    Aagrh, everybody says these words - "synchronous replication", but
    these words are useless in practice. I suppose there is NO good
    solution of Postgres synchronous replication for REALLY heavy-loaded
    systems, and saying "you possibly need a synchronous replication" is
    equal to saying "you must be reach and almighty". 


Actually, the point runs deeper, and "synchronous replication" is 
distracting you from the real problem.

The real problem is that you have GOT to accept trade-offs.  Trade-offs 
are a given, a necessity.

Synchronous replication wouldn't eliminate the problem - it would merely 
change the way it manifests.

If you haven't got powerful enough hardware to cope with the combined 
load of:
a) Update load
b) Query load
c) Load induced by replication work
then your overall system is certain to fail, in some fashion.

If using an asynchronous replication system, we well know that the 
failure that manifests is that replication falls behind on subscriber nodes.

If there was a synchronous replication system, well, synchronicity would 
prevent the "slaves" from falling behind; if the system is being 
overloaded by the workload, you'd find that the *master* node would 
start choking on its load.  Users would start seeing phenomena such as 
queries running unacceptably long and locks building up.

There is no "tuning fairy" to magically fix any of this; unfortunately, 
there isn't much choice, at that point, than to hope that you've got a 
"hardware fairy," some 'magical' place where you can get more powerful 
hardware. 

If more powerful hardware is not an option, I'm sorry, but we have 
nothing more to offer.  There is no magical "make it faster" switch to 
turn on.  If you can't afford the hardware that your application 
requires, then evidently you have promised more than it is possible to 
accomplish. 

Heroic efforts can occasionally cover over the need for more hardware, 
but in the long run, heros either:
a) Burn out, or
b) Get better offers from organizations that *can* afford the hardware.
From drees76 at gmail.com  Thu Aug  2 15:19:45 2007
From: drees76 at gmail.com (David Rees)
Date: Thu Aug  2 15:19:57 2007
Subject: [Slony1-general] Slony lag times
In-Reply-To: <5a0a9d6f0708021047g5f22b0e8jb4086727453dc41d@mail.gmail.com>
References: <46ADA5D6.3080101@over-blog.com>
	<5a0a9d6f0708021047g5f22b0e8jb4086727453dc41d@mail.gmail.com>
Message-ID: <72dbd3150708021519y570cbef1o1f0036da2bd7cd53@mail.gmail.com>

On 8/2/07, Andrew Hammond <andrew.george.hammond@gmail.com> wrote:
> On 7/30/07, Laurent Raufaste <laurent@over-blog.com> wrote:
> > Here's our issue: In the sl_status view I notice that the st_lag_time is
> > always between 1 and many seconds: it goes up to 10 seconds regularly,
> > and approximatively one time a day, there is always a slave reaching 1
> > min, for example while vacuuming.
>
> 1 to 10 seconds is pretty good. If there aren't any changes to tables on the
> origin then SYNC events are only generated every 10 seconds (by default). Do
> you have enough DML (inserts, updates and deletes) traffic to keep the syncs
> flowing? Even if there are plenty of changes to record, by default, syncs
> are only generated every 2 seconds, so any lag time of less than 2 seconds
> is effectively as up to date as possible.

slony1-1.2.10/share/slon.conf-sample (as well as the 1.2.10
documentation has different defaults (100ms and 1000ms for
sync_interval and sync_interval_timeout which differs from the
documentation at http://slony.info/documentation/ (which appears to be
version 1.2.6 listing defaults of 10000ms and 60000ms).

> If it's because of inactivity, then you can decrease your
> sync_interval_timeout, however the real effect of this is to just make the
> lag time look better. (There's an edge case here involving sequences)

So the edge case only involve sequences? I found the explanation for
sync_interval_timeout a bit confusing...

-Dave
From andrew.george.hammond at gmail.com  Thu Aug  2 15:36:49 2007
From: andrew.george.hammond at gmail.com (Andrew Hammond)
Date: Thu Aug  2 15:37:02 2007
Subject: [Slony1-general] Slony lag times
In-Reply-To: <46B23AC9.6010206@ca.afilias.info>
References: <46ADA5D6.3080101@over-blog.com>
	<5a0a9d6f0708021047g5f22b0e8jb4086727453dc41d@mail.gmail.com>
	<46B23AC9.6010206@ca.afilias.info>
Message-ID: <5a0a9d6f0708021536k5c7ee734k487d07230def3042@mail.gmail.com>

On 8/2/07, Christopher Browne <cbbrowne@ca.afilias.info> wrote:
>
> Andrew Hammond wrote:
> > As your sync interval decreases and load increases, you might need to
> > start throwing hardware at it. The criteria for deciding that are the
> > same as for any other database.
> >
> > Remember that slony is an asynchronous replication system. A system
> > designed with a strong dependency on very low replication lag time
> > suggests that you may be trying to fit asynchronous replication into
> > the role of synchronous replication.
>
> It seems like a misdirection, to me, to point at
> asynchronous-versus-synchronous as being anything of an "approach."


My intent was to draw attention to the difference between the semantics of
synchronous and asynchronous replication. I suppose I could have said "Hey
stupid, this replication stuff is complicated and based on the question
you're asking, it seems like you Just Don't Get It yet. Go RTFM on the
difference between sync and async and then re-design your application but do
it smarter next time." However that didn't seem very friendly.

Andrew
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070802/=
d731db21/attachment.htm
From dmitry at koterov.ru  Thu Aug  2 22:21:37 2007
From: dmitry at koterov.ru (Dmitry Koterov)
Date: Thu Aug  2 22:21:57 2007
Subject: [Slony1-general] Slony lag times
In-Reply-To: <5a0a9d6f0708021217g4703fa70rb73ab86d1fcb01e4@mail.gmail.com>
References: <46ADA5D6.3080101@over-blog.com>
	<5a0a9d6f0708021047g5f22b0e8jb4086727453dc41d@mail.gmail.com>
	<d7df81620708021142v5f9d901fy6263ffb101113389@mail.gmail.com>
	<5a0a9d6f0708021217g4703fa70rb73ab86d1fcb01e4@mail.gmail.com>
Message-ID: <d7df81620708022221p4369c17q31bfa2b6800e9d2@mail.gmail.com>

On 8/2/07, Andrew Hammond <andrew.george.hammond@gmail.com> wrote:
>
>
>
> > Lag of 1-10 seconds is really usual. It's an unavoidable evil for slony,
> > unfortunately.
>
>
> I agree that, given the existing design, a lag is unavoidable. Hence the
> term asynchronous. Exactly how is this evil? It's _exactly_ what the syst=
em
> is designed to be.
>

No, "the evil" is not always "the bad" nor "very-very bad, ghrrr". The evil
is "the evil", and nothing more. We have to live with it, no more, no less.
:-)

And I wanded to say that in a lot of cases (e.g. - for realtime websites!)
the "asynchronous replication" is quite acceptable, if we read a critical
data from the origin time to time (when a replica is not ready enough). No
need to refer to non-existed "synchronous replication" in that case - it's
useless, and that is what I meant.

Instead of saying about a "synchronous replication", it is better to explain
an algorythm of checking if a replica is ready enough comparing to the
origin state in the past. I have asked this question many time (in this list
and directly), but seems people do not understand why this checking is so
needed and say common words about "synchronous replication" and
"impossibility" of such check without any detalizations. So the answer was
practically empty in these cases. I will be very glad if anybody of Slony
gurus would agree to spend a hour of his time speaking single-minded (!)
about this subject, because it is very useful for anybody who uses Slony for
heavy-loaded websites. Without fast words "impossible" and "synchronous
replication", because for this task the solution have to exist (I am pretty
sure).
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070803/=
6bca7bde/attachment-0001.htm
From ajs at crankycanuck.ca  Fri Aug  3 07:19:09 2007
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Fri Aug  3 07:19:29 2007
Subject: [Slony1-general] Slony lag times
In-Reply-To: <d7df81620708022221p4369c17q31bfa2b6800e9d2@mail.gmail.com>
References: <46ADA5D6.3080101@over-blog.com>
	<5a0a9d6f0708021047g5f22b0e8jb4086727453dc41d@mail.gmail.com>
	<d7df81620708021142v5f9d901fy6263ffb101113389@mail.gmail.com>
	<5a0a9d6f0708021217g4703fa70rb73ab86d1fcb01e4@mail.gmail.com>
	<d7df81620708022221p4369c17q31bfa2b6800e9d2@mail.gmail.com>
Message-ID: <20070803141909.GB18384@phlogiston.dyndns.org>

On Fri, Aug 03, 2007 at 09:21:37AM +0400, Dmitry Koterov wrote:
> data from the origin time to time (when a replica is not ready enough). No
> need to refer to non-existed "synchronous replication" in that case - it's

What is missing in two-phase commit that does not provide you with
synchronous replication?  Oh, wait, you want synchronous replication
with no cost?  Sorry, the magic database faeries haven't been created
yet.

> Instead of saying about a "synchronous replication", it is better to explain
> an algorythm of checking if a replica is ready enough comparing to the
> origin state in the past. 

The reason you're not getting an answer is because you keep asking
for an algorithm that never gives you an answer you don't want, _not_
because you can't do any comparisons.  

You can of course figure out roughly what your overall lag is on a
replica.  You cannot figure out what state a given tuple is in,
without looking at it.  And such cost is at least as high as just
querying from the origin anyway, so there's no point to doing it.

When you have been told that, you start in with remarks about how
useless all this is, which is the point at which everyone concludes
you want synchronous replication, because you seem to want every node
to be up to date without you having to wonder about it.  The only way
to achieve that is to do sync. replication: it's not like a replica
can know that it doesn't have data it doesn't know about.  Rumsfeld
was a fool, but he wasn't an idiot: the unknown unknowns are in fact
important.

A

-- 
Andrew Sullivan  | ajs@crankycanuck.ca
A certain description of men are for getting out of debt, yet are
against all taxes for raising money to pay it off.
		--Alexander Hamilton
From ajs at crankycanuck.ca  Fri Aug  3 07:26:29 2007
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Fri Aug  3 07:26:44 2007
Subject: [Slony1-general] Slony lag times
In-Reply-To: <46B23AC9.6010206@ca.afilias.info>
References: <46ADA5D6.3080101@over-blog.com>
	<5a0a9d6f0708021047g5f22b0e8jb4086727453dc41d@mail.gmail.com>
	<46B23AC9.6010206@ca.afilias.info>
Message-ID: <20070803142629.GC18384@phlogiston.dyndns.org>

On Thu, Aug 02, 2007 at 08:12:57PM +0000, Christopher Browne wrote:
> 1.  There isn't any synchronous replication system for PostgreSQL to 
> correspond with Slony-I.  

We don't need one, because you can do it in the application with
two-phase commit.  Of course, 2PC sucks for a large number of cases,
web sites being a fairly obvious case, I'd say.  But you can do it in
fact.

Something else is also important, though, in this discussion.  There
_is_ a proposal for asynchronous no-lag replication, which is
Postgres-R.  Postgres-R guarantees that transactions on every node
see the same data, but they don't do multi-phase commit.  This is
possible because it works in serializable mode only, with
transactions processed on all nodes in network total order.  Given
that situation, you're not going to see the wrong data.  But it ain't
cheap, and it is subject to plenty of rollbacks.  Markus
Schiltknecht says he has patches to make it work with something
recent.  He's looking for sponsorship.  If this is an area that is
important to you, I suggest talking to him.

A

-- 
Andrew Sullivan  | ajs@crankycanuck.ca
The whole tendency of modern prose is away from concreteness.
		--George Orwell
From cbbrowne at ca.afilias.info  Fri Aug  3 09:31:51 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Fri Aug  3 09:31:59 2007
Subject: [Slony1-general] Version 1.2.11 pre-release now available
Message-ID: <601weka8aw.fsf@dba2.int.libertyrms.com>

See <http://slony.info/> for linkage to the tarball for a pre-release
of 1.2.11.

I have run this through all the "new generation" tests on
Debian/Unstable with PostgreSQL versions 7.4, 8.0, 8.1, 8.2, and a
slightly-old CVS checkout of HEAD/8.3.

Note that I'll be out Monday (it's a holiday in my jurisdiction); if
things are looking positive, then I hope we can release this "for
real" on Tuesday or Wednesday next week.  

I'd be particularly interested in hearing good news or bad from Mikko
Partio (regarding the log shipping fix which I haven't been able to
usefully verify) and Dmitry Koterov (regarding the DDL SCRIPT fixes).

And it is common for Devrim Gunduz to need to touch RPM packaging a
little bit...

Here are the changes between 1.2.10 and 1.2.11:

- Add in tools/mkservice scripts previously added to CVS HEAD

- During subscription, do UPDATE to pg_class.relhasindex *after* the
  TRUNCATE because, in 8.2+, TRUNCATE resets this attribute

- Fixed a problem with the setsync tracking with Log Shipping in cases
  where slon does an internal restart (thereby rereading the
  pset.ssy_seqno) and ignoring non-SYNC events because those don't
  change the sl_setsync table.

- More explicit type casting of text objects for compatibility with
  PostgreSQL 8.3

- Fixed problem with DDL SCRIPT statement parser: it wasn't 'quoting'
  semicolons inside parentheses (this notably occurs in CREATE RULE).

- Fixed problem with DDL SCRIPT statement submission; it was
  interpreting the statement as a format string, which would have
  ill effects in the presence of things that are interpreted such
  as format strings (%d, %f, %s) and \backslashed things like \\, \n.

- Further DDL Script issue: non-terminated statement at the end
  (e.g. - without trailing semicolon ";") would get omitted.

- Typo fix: when trying to disable a node, the logs would report
  "enableNode" rather than "disableNode".  Fixed.

- Add usage/version options to help output in slon.
-- 
let name="cbbrowne" and tld="linuxfinances.info" in String.concat "@" [name;tld];;
http://cbbrowne.com/info/linuxxian.html
"When we understand knowledge-based systems, it will be as before 
-- except our fingertips will have been singed."  -- Alan J. Perlis
From andrew.george.hammond at gmail.com  Fri Aug  3 11:02:39 2007
From: andrew.george.hammond at gmail.com (Andrew Hammond)
Date: Fri Aug  3 11:02:47 2007
Subject: [Slony1-general] Slony lag times
In-Reply-To: <d7df81620708022221p4369c17q31bfa2b6800e9d2@mail.gmail.com>
References: <46ADA5D6.3080101@over-blog.com>
	<5a0a9d6f0708021047g5f22b0e8jb4086727453dc41d@mail.gmail.com>
	<d7df81620708021142v5f9d901fy6263ffb101113389@mail.gmail.com>
	<5a0a9d6f0708021217g4703fa70rb73ab86d1fcb01e4@mail.gmail.com>
	<d7df81620708022221p4369c17q31bfa2b6800e9d2@mail.gmail.com>
Message-ID: <5a0a9d6f0708031102o374a8937kf857b1496d90cf50@mail.gmail.com>

On 8/2/07, Dmitry Koterov <dmitry@koterov.ru> wrote:
>
> On 8/2/07, Andrew Hammond <andrew.george.hammond@gmail.com> wrote:
> >
> >
> >
> > > Lag of 1-10 seconds is really usual. It's an unavoidable evil for
> > > slony, unfortunately.
> >
> >
> > I agree that, given the existing design, a lag is unavoidable. Hence the
> > term asynchronous. Exactly how is this evil? It's _exactly_ what the sy=
stem
> > is designed to be.
> >
>
> No, "the evil" is not always "the bad" nor "very-very bad, ghrrr". The
> evil is "the evil", and nothing more. We have to live with it, no more, no
> less. :-)
>
> And I wanded to say that in a lot of cases (e.g. - for realtime websites!)
> the "asynchronous replication" is quite acceptable, if we read a critical
> data from the origin time to time (when a replica is not ready enough). No
> need to refer to non-existed "synchronous replication" in that case - it's
> useless, and that is what I meant.


There are a number of synchronous replication solutions that exist (Oracle
RAC for example), although none for PostgreSQL. On PostgreSQL, you can
implement the semantics of synchronous replication in application or
middleware using two-phase-commit.

And I would strongly disagree that being aware of the difference between
synchronous and asynchronous is "useless". If you are designing / building a
system that depends on "replication", it is clearly important that you be
aware of what the word means. Which is almost certainly quite different from
what you assume it means.

Instead of saying about a "synchronous replication", it is better to explain
> an algorythm of checking if a replica is ready enough comparing to the
> origin state in the past. I have asked this question many time (in this l=
ist
> and directly), but seems people do not understand why this checking is so
> needed and say common words about "synchronous replication" and
> "impossibility" of such check without any detalizations.


We assume and expect that someone would do the basic reading and research
before asking questions. If that's too much effort, sign up for the
appropriate course at your local university or hire a tutor and have it
spoon fed to you. If, on the other hand, you're willing to do some reading,
a good place to start is

http://www.postgresql.org/docs/current/interactive/high-availability.html

And then hit up wikipedia for more details as necessary. Finally, ask
informed, intelligent questions in this forum.

So the answer was practically empty in these cases. I will be very glad if
> anybody of Slony gurus would agree to spend a hour of his time speaking
> single-minded (!) about this subject,


The brief version is that an asynchronous replica gets it's data only after
it has been committed on the origin. So obviously it will be visible on the
origin before it's visible on any replica. This means there must be a window
of time where the new data is exists, but the replica doesn't know about it.
If the replica doesn't know (and again, by definition, it doesn't know)
about the new data, then how can it know how far it is behind? What you
continue to ask for is something that is, _by_definition_, impossible.
Worse, it is _obviously_ impossible. Do you now understand why there's some
frustration with your continuing to ask for it?

because it is very useful for anybody who uses Slony for heavy-loaded
> websites. Without fast words "impossible" and "synchronous replication",
> because for this task the solution have to exist (I am pretty sure).
>

I look forward to seeing your solution.

Andrew
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070803/=
b7a2a1c1/attachment.htm
From drees76 at gmail.com  Fri Aug  3 12:08:27 2007
From: drees76 at gmail.com (David Rees)
Date: Fri Aug  3 12:08:36 2007
Subject: [Slony1-general] Version 1.2.11 pre-release now available
In-Reply-To: <601weka8aw.fsf@dba2.int.libertyrms.com>
References: <601weka8aw.fsf@dba2.int.libertyrms.com>
Message-ID: <72dbd3150708031208pf6e8988scaba63074e595666@mail.gmail.com>

On 8/3/07, Christopher Browne <cbbrowne@ca.afilias.info> wrote:
> See <http://slony.info/> for linkage to the tarball for a pre-release
> of 1.2.11.

Would it be possible to get the documentation updated/fixed as I noted
in this post?
http://lists.slony.info/pipermail/slony1-general/2007-August/006417.html

Let me know if you want me to whip up some patches against CVS, I'm
happy to do so.

-Dave
From cbbrowne at ca.afilias.info  Fri Aug  3 13:55:01 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Fri Aug  3 13:55:13 2007
Subject: [Slony1-general] Version 1.2.11 pre-release now available
In-Reply-To: <72dbd3150708031208pf6e8988scaba63074e595666@mail.gmail.com>
References: <601weka8aw.fsf@dba2.int.libertyrms.com>
	<72dbd3150708031208pf6e8988scaba63074e595666@mail.gmail.com>
Message-ID: <46B39625.30301@ca.afilias.info>

David Rees wrote:
> On 8/3/07, Christopher Browne <cbbrowne@ca.afilias.info> wrote:
>   
>> See <http://slony.info/> for linkage to the tarball for a pre-release
>> of 1.2.11.
>>     
>
> Would it be possible to get the documentation updated/fixed as I noted
> in this post?
> http://lists.slony.info/pipermail/slony1-general/2007-August/006417.html
>
> Let me know if you want me to whip up some patches against CVS, I'm
> happy to do so.
>
> -Dave
>   
Sure, that's entirely reasonable.

Patches to documentation do not mandate retesting anything ;-).

And yes, by all means, whip up some patches to CVS.  I tend to be 
unapologetically "wordsmithing-happy" on such changes, but it's pretty 
ideal if you start by poking at parts of the documentation to say 
"that's where something needs to be changed."
From devrim at CommandPrompt.com  Sat Aug  4 11:35:57 2007
From: devrim at CommandPrompt.com (Devrim =?ISO-8859-1?Q?G=DCND=DCZ?=)
Date: Sat Aug  4 11:36:47 2007
Subject: [Slony1-general] problems with slony1-1.2.10 and postgresql-8.2.4
In-Reply-To: <Pine.LNX.4.64.0708012011050.1940@discord.home.frostconsultingllc.com>
References: <Pine.LNX.4.64.0708011022360.2605@glacier.frostconsultingllc.com>
	<72dbd3150708011723qb80ef8fydae4dd5f75fa1292@mail.gmail.com>
	<Pine.LNX.4.64.0708011802500.1940@discord.home.frostconsultingllc.com>
	<72dbd3150708012003s11bac86dk1b7c87c4a5b79625@mail.gmail.com>
	<Pine.LNX.4.64.0708012011050.1940@discord.home.frostconsultingllc.com>
Message-ID: <1186252557.21688.16.camel@laptop.gunduz.org>

SGksCgpPbiBXZWQsIDIwMDctMDgtMDEgYXQgMjA6MTUgLTA3MDAsIEplZmYgRnJvc3Qgd3JvdGU6
Cgo+IElmIHlvdSdyZSB3YXRjaGluZyB0aGlzIHRocmVhZCwgZG8geW91IGNhcmUgdG8gY29tbWVu
dD8KCkkgd2FzIHdhdGNoaW5nIHRoZSB0aHJlYWQ7IGhvd2V2ZXIgbXkgUlBNIGJ1aWxkIHNlcnZl
ciB3YXMgaGF2aW5nIGRpc2sKcHJvYmxlbXMgYW5kIEkgZGlkIG5vdCB3YW50IHRvIHJlc3BvbmQg
d2l0aG91dCB0ZXN0aW5nIHRoZSBiaW5hcmllcwood2hpY2ggYXJlIHg4Nl82NCkgLiAKCj4gSSBk
b24ndCBzZWUgd2h5IGl0IHdvdWxkIG1hdHRlciBhcyBhIDY0LWJpdCBtYWNoaW5lIGNhbiBtYWtl
IGkzODYgYW5kIGk2ODYgCj4gYmluYXJpZXMganVzdCBhcyB3ZWxsIGFzIHg4Nl82NC4KPiAKPiBJ
ZiBJIGV4dHJhY3QgdGhlIGZpbGVzIGZyb20gdGhlIHBvc3RncmVzcWwtc2VydmVyIHJwbSBhbmQg
cnVuIGZpbGUgYWdhaW5zdCAKPiB0aGVtLCBpdCBzaG93cyB0aGVtIGFsbCBhcyAzMi1iaXQgZXhl
Y3V0YWJsZXM6Cj4gCj4gaW5pdGRiOiAgICAgICAgIEVMRiAzMi1iaXQgTFNCIGV4ZWN1dGFibGUs
IEludGVsIDgwMzg2LCB2ZXJzaW9uIDEgKFNZU1YpLCBmb3IgCj4gR05VL0xpbnV4IDIuMi41LCBk
eW5hbWljYWxseSBsaW5rZWQgKHVzZXMgc2hhcmVkIGxpYnMpLCBzdHJpcHBlZAoKPHNuaXA+CgoK
W3Jvb3RAZXZpbSB+XSMgcnBtIC1xIC0tcXVlcnlmb3JtYXQ9IiV7QVJDSH0iIHBvc3RncmVzcWwt
c2VydmVyCng4Nl82NAoKW3Jvb3RAZXZpbSB+XSMgZmlsZSBgcnBtIC1xbCBwb3N0Z3Jlc3FsLXNl
cnZlcnxncmVwIC91c3IvYmluYAovdXNyL2Jpbi9pbml0ZGI6ICAgICAgICAgRUxGIDY0LWJpdCBM
U0IgZXhlY3V0YWJsZSwgeDg2LTY0LCB2ZXJzaW9uIDEgKFNZU1YpLCBkeW5hbWljYWxseSBsaW5r
ZWQgKHVzZXMgc2hhcmVkIGxpYnMpLCBmb3IgR05VL0xpbnV4IDIuNi45LCBzdHJpcHBlZAovdXNy
L2Jpbi9pcGNjbGVhbjogICAgICAgQm91cm5lIHNoZWxsIHNjcmlwdCB0ZXh0IGV4ZWN1dGFibGUK
L3Vzci9iaW4vcGdfY29udHJvbGRhdGE6IEVMRiA2NC1iaXQgTFNCIGV4ZWN1dGFibGUsIHg4Ni02
NCwgdmVyc2lvbiAxIChTWVNWKSwgZHluYW1pY2FsbHkgbGlua2VkICh1c2VzIHNoYXJlZCBsaWJz
KSwgZm9yIEdOVS9MaW51eCAyLjYuOSwgc3RyaXBwZWQKL3Vzci9iaW4vcGdfY3RsOiAgICAgICAg
IEVMRiA2NC1iaXQgTFNCIGV4ZWN1dGFibGUsIHg4Ni02NCwgdmVyc2lvbiAxIChTWVNWKSwgZHlu
YW1pY2FsbHkgbGlua2VkICh1c2VzIHNoYXJlZCBsaWJzKSwgZm9yIEdOVS9MaW51eCAyLjYuOSwg
c3RyaXBwZWQKL3Vzci9iaW4vcGdfcmVzZXR4bG9nOiAgIEVMRiA2NC1iaXQgTFNCIGV4ZWN1dGFi
bGUsIHg4Ni02NCwgdmVyc2lvbiAxIChTWVNWKSwgZHluYW1pY2FsbHkgbGlua2VkICh1c2VzIHNo
YXJlZCBsaWJzKSwgZm9yIEdOVS9MaW51eCAyLjYuOSwgc3RyaXBwZWQKL3Vzci9iaW4vcG9zdGdy
ZXM6ICAgICAgIEVMRiA2NC1iaXQgTFNCIGV4ZWN1dGFibGUsIHg4Ni02NCwgdmVyc2lvbiAxIChT
WVNWKSwgZHluYW1pY2FsbHkgbGlua2VkICh1c2VzIHNoYXJlZCBsaWJzKSwgZm9yIEdOVS9MaW51
eCAyLjYuOSwgc3RyaXBwZWQKL3Vzci9iaW4vcG9zdG1hc3RlcjogICAgIHN5bWJvbGljIGxpbmsg
dG8gYHBvc3RncmVzJwoKCj4gVGhlIHNhbWUgd2FzIHRydWUgb2YgYWxsIHRoZSBzaGFyZWQgbW9k
dWxlcyBpbiAvdXNyL2xpYi9wZ3NxbC4KCllvdSBrbm93LCB5b3UgKmNhbiogaW5zdGFsbCBib3Ro
IDMyIGJpdCBhbmQgNjQgYml0IHZlcnNpb25zIHRvIHRoZSBzYW1lCjY0IGJpdCBtYWNoaW5lICAt
LSBTbyBJIGRvbid0IGNhcmUgYWJvdXQgdGhlIGZpbGVzIHVuZGVyIC91c3IvbGliLyAuCldoYXQg
YWJvdXQgL3Vzci9saWI2NCA/Cgo+IEFsc28sICJzdHJpbmdzICogfGdyZXAgbGliNjQiIHJldHVy
bmVkIG5vdGhpbmcgd2hlcmVhcyAic3RyaW5ncyAqIHwgZ3JlcCBsaWIiIAo+IHJldHVybnMgdGhl
IGZvbGxvd2luZyBpbnRlcmVzdGluZyB0aWRiaXRzOgo+IAo+IC91c3IvbGliCj4gL3Vzci9saWIv
cGdzcWwKPiAKW3Jvb3RAZXZpbSB4ODZfNjRdIyBzdHJpbmdzIHBvc3RncmVzcWwtc2xvbnkxLWVu
Z2luZS1IRUFEXzIwMDcwNTA5LTFfUEc4LjIuNC5mYzcueDg2XzY0LnJwbSB8Z3JlcCAvdXNyL2xp
YgovdXNyL2xpYjY0L3Bnc3FsL3Nsb24tdG9vbHMucG0KL3Vzci9saWI2NC9wZ3NxbC8KCj8KCktp
bmQgcmVnYXJkcywKCi0tIApEZXZyaW0gR8OcTkTDnFoKUG9zdGdyZVNRTCBSZXBsaWNhdGlvbiwg
Q29uc3VsdGluZywgQ3VzdG9tIERldmVsb3BtZW50LCAyNHg3IHN1cHBvcnQKTWFuYWdlZCBTZXJ2
aWNlcywgU2hhcmVkIGFuZCBEZWRpY2F0ZWQgSG9zdGluZwpDby1BdXRob3JzOiBwbFBIUCwgT0RC
Q25nIC0gaHR0cDovL3d3dy5jb21tYW5kcHJvbXB0LmNvbS8KCgotLS0tLS0tLS0tLS0tLSBuZXh0
IHBhcnQgLS0tLS0tLS0tLS0tLS0KQSBub24tdGV4dCBhdHRhY2htZW50IHdhcyBzY3J1YmJlZC4u
LgpOYW1lOiBub3QgYXZhaWxhYmxlClR5cGU6IGFwcGxpY2F0aW9uL3BncC1zaWduYXR1cmUKU2l6
ZTogMTg5IGJ5dGVzCkRlc2M6IFRoaXMgaXMgYSBkaWdpdGFsbHkgc2lnbmVkIG1lc3NhZ2UgcGFy
dApVcmwgOiBodHRwOi8vbGlzdHMuc2xvbnkuaW5mby9waXBlcm1haWwvc2xvbnkxLWdlbmVyYWwv
YXR0YWNobWVudHMvMjAwNzA4MDQvYzFhNjZhNzEvYXR0YWNobWVudC5wZ3AK
From dmitry at koterov.ru  Sat Aug  4 12:42:00 2007
From: dmitry at koterov.ru (Dmitry Koterov)
Date: Sat Aug  4 12:42:10 2007
Subject: [Slony1-general] The order of sequential and non-overlapped
	transactions
Message-ID: <d7df81620708041242w3c56e46bk55ddee6cf4de2ebb@mail.gmail.com>

Hello.

Could you please answer three questions about Slony's transaction
serialization? (I suppose that two first answers will be "yes", but I'd like
to hear the opinions of gurus.) Unfortunately I cannot find direct answers
in the Slony documentation.

1. I have the following non-overlapped sequence of transactions in a SINGLE
(!!!) session (connection) on an origin:

BEGIN;
UPDATE tbl SET a=3D10 WHERE b=3D10;
COMMIT;
--
-- some little delay (e.g. 0.1s)
--
BEGIN;
UPDATE tbl SET a=3D20 WHERE b=3D20;
COMMIT;

The question is: if a subscriber received and processed the result of the
transaction #2, could I be sure that it had also received and committed a
result of the transaction #1? Transactions are not overlapped.


2. I have the following sequence in a SINGLE session (also not overlapped):

BEGIN;
UPDATE tbl SET c=3D10 WHERE d=3D10;
COMMIT;
--
-- some delay (e.g. 0.1s)
--
SELECT nextval('some_seq');  -- =3D> save a result to $some_seq variable

The question is: if subscriber's currval('some_seq') is greater than
$some_seq, could I be sure that the transaction #1 is also processed and
committed by this subscriber?


3. I have the following sequence in a SINGLE session (not overlapped):

BEGIN;
UPDATE tbl SET c=3D10 WHERE d=3D10;
COMMIT;
--
-- some delay (e.g. 0.1s)
--
SELECT max(sl_event.ev_seqno);  -- =3D> save a result to $seqno variable

The question is: if subscriber's max(sl_event.ev_seqno) is greater than
$seqno, could I be 100% sure that the transaction #1 is already processed
and committed by this subscriber?
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070804/=
ceaa30aa/attachment.htm
From z-saito at guitar.ocn.ne.jp  Sun Aug  5 23:31:35 2007
From: z-saito at guitar.ocn.ne.jp (Hiroshi Saito)
Date: Sun Aug  5 23:31:54 2007
Subject: [Slony1-general] Version 1.2.11 pre-release now available
References: <601weka8aw.fsf@dba2.int.libertyrms.com>
Message-ID: <02f801c7d7f3$6fff3710$c601a8c0@HP22720319231>

Hi.

This needs to be changed of windows of MinGW.
Then, tests was in the good state.:-)

Please apply it. Thanks!

Regards,
Hiroshi Saito

----- Original Message ----- =

From: "Christopher Browne"


> See <http://slony.info/> for linkage to the tarball for a pre-release
> of 1.2.11.
> =

> I have run this through all the "new generation" tests on
> Debian/Unstable with PostgreSQL versions 7.4, 8.0, 8.1, 8.2, and a
> slightly-old CVS checkout of HEAD/8.3.
> =

> Note that I'll be out Monday (it's a holiday in my jurisdiction); if
> things are looking positive, then I hope we can release this "for
> real" on Tuesday or Wednesday next week.  =

> =

> I'd be particularly interested in hearing good news or bad from Mikko
> Partio (regarding the log shipping fix which I haven't been able to
> usefully verify) and Dmitry Koterov (regarding the DDL SCRIPT fixes).
> =

> And it is common for Devrim Gunduz to need to touch RPM packaging a
> little bit...
> =

> Here are the changes between 1.2.10 and 1.2.11:
> =

> - Add in tools/mkservice scripts previously added to CVS HEAD
> =

> - During subscription, do UPDATE to pg_class.relhasindex *after* the
>  TRUNCATE because, in 8.2+, TRUNCATE resets this attribute
> =

> - Fixed a problem with the setsync tracking with Log Shipping in cases
>  where slon does an internal restart (thereby rereading the
>  pset.ssy_seqno) and ignoring non-SYNC events because those don't
>  change the sl_setsync table.
> =

> - More explicit type casting of text objects for compatibility with
>  PostgreSQL 8.3
> =

> - Fixed problem with DDL SCRIPT statement parser: it wasn't 'quoting'
>  semicolons inside parentheses (this notably occurs in CREATE RULE).
> =

> - Fixed problem with DDL SCRIPT statement submission; it was
>  interpreting the statement as a format string, which would have
>  ill effects in the presence of things that are interpreted such
>  as format strings (%d, %f, %s) and \backslashed things like \\, \n.
> =

> - Further DDL Script issue: non-terminated statement at the end
>  (e.g. - without trailing semicolon ";") would get omitted.
> =

> - Typo fix: when trying to disable a node, the logs would report
>  "enableNode" rather than "disableNode".  Fixed.
> =

> - Add usage/version options to help output in slon.
> -- =

> let name=3D"cbbrowne" and tld=3D"linuxfinances.info" in String.concat "@"=
 [name;tld];;
> http://cbbrowne.com/info/linuxxian.html
> "When we understand knowledge-based systems, it will be as before =

> -- except our fingertips will have been singed."  -- Alan J. Perlis
> _______________________________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
-------------- next part --------------
A non-text attachment was scrubbed...
Name: parsestatements_patch.tgz
Type: application/x-compressed
Size: 1498 bytes
Desc: not available
Url : http://lists.slony.info/pipermail/slony1-general/attachments/20070806=
/12bdd746/parsestatements_patch.bin
From mpartio at gmail.com  Sun Aug  5 23:39:40 2007
From: mpartio at gmail.com (Mikko Partio)
Date: Sun Aug  5 23:39:55 2007
Subject: [Slony1-general] Re: log shipping gone wrong
In-Reply-To: <46ACCF3A.9050005@Yahoo.com>
References: <2ca799770707200605j1bb37c13o98c86a21834db2ab@mail.gmail.com>
	<2ca799770707222327y5e5939bg6ccee843d0ef0097@mail.gmail.com>
	<46A4AE4F.4080304@Yahoo.com>
	<2ca799770707230728h3e3afa3auefdc1ae8dd429156@mail.gmail.com>
	<46A4C3E7.1020107@Yahoo.com>
	<2ca799770707232129p27822251v9947c748d2395630@mail.gmail.com>
	<46ACCF3A.9050005@Yahoo.com>
Message-ID: <2ca799770708052339w73818564y4ab95181505dd349@mail.gmail.com>

On 7/29/07, Jan Wieck <JanWieck@yahoo.com> wrote:
>
>
>
>
> This one played quite a bit hide and seek with me. But I think I found
> and fixed the bug.
>
> The problem occurred when some action (like STORE_SET) caused the
> subscriber slon to perform an internal restart. During that, the current
> setsync tracking in the pset structure is reinitialized. However, since
> the sl_setsync table is not updated on events other than SYNC, this
> would lead to the wrong (too low) old sync expected if the last event(s)
> processed from that node where no SYNC events.
>
> Thanks for the detailed example.



My experiments show me that the problem persists. The test-case is the same
as in the previous example (started from scratch):


>
> > 1) Create databases and some tables
> >
> > $ createdb -D data -E utf8 test3
> > $ psql test3
> >
> > test3=3D# create table a (id int primary key);
> > test3=3D# create table b (id int primary key);
> > test3=3D# create table c (id int primary key);
> >
> > $ createdb -T test3 test3_lo
> > $ createdb -T test3 test3_log
> >
> > 2) Create the replication cluster
> >
> > $ cat test3_preamble.slonik
> > cluster name =3D test3;
> >
> > node 1 admin conninfo =3D 'host=3Dlocalhost dbname=3Dtest3 user=3Dpostg=
res
> > password=3Dxxx';
> > node 2 admin conninfo =3D 'host=3Dlocalhost dbname=3Dtest3_lo user=3Dpo=
stgres
> > password=3Dxxx';
> >
> > $ cat test3_init.slonik
> > #!/bin/sh
> >
> > slonik <<_EOF_
> >
> >         include <test3_preamble.slonik>;
> >
> >         init cluster (id=3D1, comment=3D'original database');
> >
> >         store node (id=3D2, comment =3D 'dummy loopback database');
> >         store path (server=3D1, client=3D2, conninfo=3D'dbname=3Dtest3
> > host=3Dlocalhost user=3Dpostgres password=3Dxxx');
> >         store path (server=3D2, client=3D1, conninfo=3D'dbname=3Dtest3_=
lo
> > host=3Dlocalhost user=3Dpostgres password=3Dxxx');
> >         store listen (origin=3D1, provider=3D1, receiver=3D2);
> >         store listen (origin=3D2, provider=3D2, receiver=3D1);
> >
> > _EOF_
> >
> > $ ./test3_init.slonik
> >
> > $ slon test3 "dbname=3Dtest3 host=3Dlocalhost user=3Dpostgres password=
=3Dxxx"
> > $ slon -a /tmp/logshipping/test3 test3 "dbname=3Dtest3_lo host=3Dlocalh=
ost
> > user=3Dpostgres password=3Dxxx"
> >
> > $ cat test3_create_set.slonik
> > #!/bin/sh
> >
> > if [ $# -ne 3 ]; then
> >         echo "Usage: $0 SETID TABLEID TABLENAME"
> >         echo "Example: $0 3 17 public.x"
> >         exit 1
> > fi
> >
> > slonik <<_EOF_
> >
> >         include <test3_preamble.slonik>;
> >
> >         create set (id=3D$1, origin=3D1, comment=3D'Set #$1');
> >         set add table (set id =3D $1, origin =3D 1, id =3D $2, fully qu=
alified
> > name =3D '$3');
> >
> > _EOF_
> >
> > $ ./test3_create_set.slonik 1 1 public.a
> > $ cat test3_subscribe.slonik
> > #!/bin/sh
> >
> > if [ -z $1 ]; then
> >         echo "Usage: $0 SETID"
> >         exit 1;
> > fi
> >
> > slonik <<_EOF_
> >
> >         include <test3_preamble.slonik>;
> >
> >         subscribe set (id=3D$1, provider=3D1, receiver=3D2, forward=3Dn=
o);
> >
> > _EOF_
> >
> > $ ./test3_subscribe.slonik 1
> > $ psql test3_lo
> > test3_lo=3D# \d a
> >        Table " public.a"
> >  Column |  Type   | Modifiers
> > --------+---------+-----------
> >  id     | integer | not null
> > Indexes:
> >     "a_pkey" PRIMARY KEY, btree (id)
> > Triggers:
> >     _test3_denyaccess_1 BEFORE INSERT OR DELETE OR UPDATE ON a FOR EACH
> > ROW EXECUTE PROCEDURE _test3.denyaccess('_test3')
> >
> > $ psql test3
> > test3=3D# insert into a select * from generate_series(1,100);
> >
> > 3) Dump the state of the cluster to logshipping database
> >
> > $ ./slony1_dump.sh test3_lo test3 | psql test3_log
> > $ psql test3_log
> > test3_log=3D# select count(*) from a;
> >  count
> > -------
> >    100
> > (1 row)
> >
> > 4) Insert some data to origin db and see if it gets to logshipping db
> >
> > test3=3D# insert into a select * from generate_series(101,200);
> >
> > $ psql -d test3_log -f
> > /tmp/logshipping/test3/slony1_log_1_00000000000000000060.sql
> > $ psql test3_log
> > test3_log=3D# select count(*) from a;
> >  count
> > -------
> >    200
> > (1 row)
> >
> > 5) Create another replication set
> >
> > $ ./test3_create_set.slonik 10 2 public.b
> > $ ./test3_subscribe.slonik 10
> >
> > 6) Start applying logfiles to logshipping db
> >


Here's the new output:


$ psql -d test3_log -f slony1_log_1_00000000000000000053.sql
START TRANSACTION
psql:slony1_log_1_00000000000000000053.sql:6: NOTICE:  Slony-I: Process set
1 sync 53 time 2007-08-06 09:30:03.823825+03
 setsynctracking_offline
-------------------------
                      53
(1 row)

COMMIT
VACUUM

$ psql -d test3_log -f slony1_log_1_00000000000000000054.sql
START TRANSACTION
psql:slony1_log_1_00000000000000000054.sql:6: NOTICE:  Slony-I: Process set
1 sync 54 time 2007-08-06 09:30:03.823825+03
 setsynctracking_offline
-------------------------
                      54
(1 row)

DELETE 0
 finishtableaftercopy
----------------------
                    1
(1 row)

ANALYZE
INSERT 0 1
COMMIT
VACUUM


$ psql -d test3_log -f slony1_log_1_00000000000000000055.sql
START TRANSACTION
psql:slony1_log_1_00000000000000000055.sql:5: NOTICE:  Slony-I: Process set
1 sync 55 time 2007-08-06 09:30:10.843406+03
 setsynctracking_offline
-------------------------
                      55
(1 row)

psql:slony1_log_1_00000000000000000055.sql:11: ERROR:  Slony-I: set 10 is on
sync 52, this archive log expects 54


Here's the contents of the sync-files 54 and 55:

$ cat slony1_log_1_00000000000000000054.sql
-- Slony-I log shipping archive
-- Node 1, Event 54
start transaction;
-- ENABLE_SUBSCRIPTION

select "_test3".setsyncTracking_offline(1, '53', '54', '2007-08-06 09:30:
03.823825');
-- end of log archiving header
------------------------------------------------------------------
-- start of Slony-I data
------------------------------------------------------------------
delete from "public"."b";
copy "public"."b" ("id") from stdin;
\.
select "_test3".finishTableAfterCopy(2); analyze "public"."b";
insert into "_test3".sl_setsync_offline (ssy_setid, ssy_seqno) values ('10',
'52');

------------------------------------------------------------------
-- End Of Archive Log
------------------------------------------------------------------
commit;
vacuum analyze "_test3".sl_setsync_offline;



$ cat slony1_log_1_00000000000000000055.sql
-- Slony-I log shipping archive
-- Node 1, Event 55
start transaction;

select "_test3".setsyncTracking_offline(1, '54', '55', '2007-08-06 09:30:
10.843406');
-- end of log archiving header
------------------------------------------------------------------
-- start of Slony-I data
------------------------------------------------------------------

select "_test3".setsyncTracking_offline(10, '54', '55', '2007-08-06 09:30:
10.843406');
-- end of log archiving header
------------------------------------------------------------------
-- start of Slony-I data
------------------------------------------------------------------

------------------------------------------------------------------
-- End Of Archive Log
------------------------------------------------------------------
commit;
vacuum analyze "_test3".sl_setsync_offline;



Here's the contents of the setsync-table:


test3_log=3D# select * from _test3.sl_setsync_offline ;
 ssy_setid | ssy_seqno |         ssy_synctime
-----------+-----------+-------------------------------
         1 |        54 | 2007-08-06 09:30:03.823825+03
        10 |        52 |
(2 rows)



$ slon -v
slon version 1.2.11

Any more info I can provide?

Regards

Mikko
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070806/=
d4623d69/attachment.htm
From devrim at CommandPrompt.com  Mon Aug  6 00:13:31 2007
From: devrim at CommandPrompt.com (Devrim =?ISO-8859-1?Q?G=DCND=DCZ?=)
Date: Mon Aug  6 00:14:36 2007
Subject: [Slony1-general] Version 1.2.11 pre-release now available
In-Reply-To: <601weka8aw.fsf@dba2.int.libertyrms.com>
References: <601weka8aw.fsf@dba2.int.libertyrms.com>
Message-ID: <1186384411.2760.16.camel@localhost.localdomain>

SGksCgpPbiBGcmksIDIwMDctMDgtMDMgYXQgMTI6MzEgLTA0MDAsIENocmlzdG9waGVyIEJyb3du
ZSB3cm90ZToKPiBBbmQgaXQgaXMgY29tbW9uIGZvciBEZXZyaW0gR3VuZHV6IHRvIG5lZWQgdG8g
dG91Y2ggUlBNIHBhY2thZ2luZyBhCj4gbGl0dGxlIGJpdC4uLiAKCkkgY29tbWl0dGVkIGEgc21h
bGwgZml4IHRvIHNsb25pa19yZWYuc2dtbCBhbmQgYWxzbyBjb21taXR0ZWQgc29tZSBmaXhlcwp0
byBzcGVjIGZpbGUuIEZyb20gcGFja2FnaW5nIHBlcnNwZWN0aXZlLCB0aGUgdGFyYmFsbCBsb29r
cyBvayBvdGhlcgp0aGFuIHRoZSBzZ21sIGlzc3VlLgoKUmVnYXJkcywKLS0gCkRldnJpbSBHw5xO
RMOcWgpQb3N0Z3JlU1FMIFJlcGxpY2F0aW9uLCBDb25zdWx0aW5nLCBDdXN0b20gRGV2ZWxvcG1l
bnQsIDI0eDcgc3VwcG9ydApNYW5hZ2VkIFNlcnZpY2VzLCBTaGFyZWQgYW5kIERlZGljYXRlZCBI
b3N0aW5nCkNvLUF1dGhvcnM6IHBsUEhQLCBPREJDbmcgLSBodHRwOi8vd3d3LmNvbW1hbmRwcm9t
cHQuY29tLwoKCi0tLS0tLS0tLS0tLS0tIG5leHQgcGFydCAtLS0tLS0tLS0tLS0tLQpBIG5vbi10
ZXh0IGF0dGFjaG1lbnQgd2FzIHNjcnViYmVkLi4uCk5hbWU6IG5vdCBhdmFpbGFibGUKVHlwZTog
YXBwbGljYXRpb24vcGdwLXNpZ25hdHVyZQpTaXplOiAxODkgYnl0ZXMKRGVzYzogVGhpcyBpcyBh
IGRpZ2l0YWxseSBzaWduZWQgbWVzc2FnZSBwYXJ0ClVybCA6IGh0dHA6Ly9saXN0cy5zbG9ueS5p
bmZvL3BpcGVybWFpbC9zbG9ueTEtZ2VuZXJhbC9hdHRhY2htZW50cy8yMDA3MDgwNi9iOWU2ZWZl
MC9hdHRhY2htZW50LTAwMDEucGdwCg==
From drees76 at gmail.com  Mon Aug  6 00:47:53 2007
From: drees76 at gmail.com (David Rees)
Date: Mon Aug  6 00:48:10 2007
Subject: [Slony1-general] Version 1.2.11 pre-release now available
In-Reply-To: <46B39625.30301@ca.afilias.info>
References: <601weka8aw.fsf@dba2.int.libertyrms.com>
	<72dbd3150708031208pf6e8988scaba63074e595666@mail.gmail.com>
	<46B39625.30301@ca.afilias.info>
Message-ID: <72dbd3150708060047q52179eder846162f18bcc3315@mail.gmail.com>

On 8/3/07, Christopher Browne <cbbrowne@ca.afilias.info> wrote:
> David Rees wrote:
> > Would it be possible to get the documentation updated/fixed as I noted
> > in this post?
> > http://lists.slony.info/pipermail/slony1-general/2007-August/006417.html
> >
> > Let me know if you want me to whip up some patches against CVS, I'm
> > happy to do so.
>
> Sure, that's entirely reasonable.
>
> Patches to documentation do not mandate retesting anything ;-).
>
> And yes, by all means, whip up some patches to CVS.  I tend to be
> unapologetically "wordsmithing-happy" on such changes, but it's pretty
> ideal if you start by poking at parts of the documentation to say
> "that's where something needs to be changed."

OK, here's some tweaks the configuration to 1. Fix what the docs claim
are the defaults for sync interval and sync interval timeout and 2.
Synchronize the docs a bit between slon.conf-sample and the primary
documentation.

Could probably use a bit more tweaking but I wanted to at least make
sure the defaults are corrected before the next release.

-Dave
-------------- next part --------------
A non-text attachment was scrubbed...
Name: slony1-sync-docs.patch
Type: application/octet-stream
Size: 3415 bytes
Desc: not available
Url : http://lists.slony.info/pipermail/slony1-general/attachments/20070806=
/fbc35348/slony1-sync-docs.obj
From wmoran at collaborativefusion.com  Mon Aug  6 06:33:33 2007
From: wmoran at collaborativefusion.com (Bill Moran)
Date: Mon Aug  6 06:33:44 2007
Subject: [Slony1-general] The order of sequential and non-overlapped
	transactions
In-Reply-To: <d7df81620708041242w3c56e46bk55ddee6cf4de2ebb@mail.gmail.com>
References: <d7df81620708041242w3c56e46bk55ddee6cf4de2ebb@mail.gmail.com>
Message-ID: <20070806093333.0adacf3a.wmoran@collaborativefusion.com>

In response to "Dmitry Koterov" <dmitry@koterov.ru>:

> Hello.
> 
> Could you please answer three questions about Slony's transaction
> serialization? (I suppose that two first answers will be "yes", but I'd like
> to hear the opinions of gurus.) Unfortunately I cannot find direct answers
> in the Slony documentation.
> 
> 1. I have the following non-overlapped sequence of transactions in a SINGLE
> (!!!) session (connection) on an origin:
> 
> BEGIN;
> UPDATE tbl SET a=10 WHERE b=10;
> COMMIT;
> --
> -- some little delay (e.g. 0.1s)
> --
> BEGIN;
> UPDATE tbl SET a=20 WHERE b=20;
> COMMIT;
> 
> The question is: if a subscriber received and processed the result of the
> transaction #2, could I be sure that it had also received and committed a
> result of the transaction #1? Transactions are not overlapped.

I'm unsure what you mean by "non-overlapped".  The whole point to a transaction
is that it is an atomic operation, so, by design, transactions can't overlap,
since they happen within a single atom of time.

To answer your question, if you are sure that the transactions are committed
on the master in a particular order, you can then be sure that those are
committed on each of the slaves in the same order.  Otherwise, Slony wouldn't
even work.

> 2. I have the following sequence in a SINGLE session (also not overlapped):
> 
> BEGIN;
> UPDATE tbl SET c=10 WHERE d=10;
> COMMIT;
> --
> -- some delay (e.g. 0.1s)
> --
> SELECT nextval('some_seq');  -- => save a result to $some_seq variable
> 
> The question is: if subscriber's currval('some_seq') is greater than
> $some_seq, could I be sure that the transaction #1 is also processed and
> committed by this subscriber?

How is this question different than #1?

> 3. I have the following sequence in a SINGLE session (not overlapped):
> 
> BEGIN;
> UPDATE tbl SET c=10 WHERE d=10;
> COMMIT;
> --
> -- some delay (e.g. 0.1s)
> --
> SELECT max(sl_event.ev_seqno);  -- => save a result to $seqno variable
> 
> The question is: if subscriber's max(sl_event.ev_seqno) is greater than
> $seqno, could I be 100% sure that the transaction #1 is already processed
> and committed by this subscriber?

No.  That's not what that table does.  It simply replicates events to other
servers in the cluster, it doesn't guarantee that they've been processed.
Have a look at sl_confirm.

-- 
Bill Moran
Collaborative Fusion Inc.
http://people.collaborativefusion.com/~wmoran/

wmoran@collaborativefusion.com
Phone: 412-422-3463x4023
From jeff at frostconsultingllc.com  Mon Aug  6 10:29:24 2007
From: jeff at frostconsultingllc.com (Jeff Frost)
Date: Mon Aug  6 10:29:39 2007
Subject: [Slony1-general] problems with slony1-1.2.10 and postgresql-8.2.4
In-Reply-To: <1186252557.21688.16.camel@laptop.gunduz.org>
References: <Pine.LNX.4.64.0708011022360.2605@glacier.frostconsultingllc.com>
	<72dbd3150708011723qb80ef8fydae4dd5f75fa1292@mail.gmail.com> 
	<Pine.LNX.4.64.0708011802500.1940@discord.home.frostconsultingllc.com> 
	<72dbd3150708012003s11bac86dk1b7c87c4a5b79625@mail.gmail.com> 
	<Pine.LNX.4.64.0708012011050.1940@discord.home.frostconsultingllc.com>
	<1186252557.21688.16.camel@laptop.gunduz.org>
Message-ID: <Pine.LNX.4.64.0708061023230.2605@glacier.frostconsultingllc.com>

T24gU2F0LCA0IEF1ZyAyMDA3LCBEZXZyaW0gR9xORNxaIHdyb3RlOgoKPj4gSWYgeW91J3JlIHdh
dGNoaW5nIHRoaXMgdGhyZWFkLCBkbyB5b3UgY2FyZSB0byBjb21tZW50Pwo+Cj4gSSB3YXMgd2F0
Y2hpbmcgdGhlIHRocmVhZDsgaG93ZXZlciBteSBSUE0gYnVpbGQgc2VydmVyIHdhcyBoYXZpbmcg
ZGlzawo+IHByb2JsZW1zIGFuZCBJIGRpZCBub3Qgd2FudCB0byByZXNwb25kIHdpdGhvdXQgdGVz
dGluZyB0aGUgYmluYXJpZXMKPiAod2hpY2ggYXJlIHg4Nl82NCkgLgoKVGhhbmtzIERldnJpbSwg
Y29tbWVudHMgaW5saW5lOgoKPgo+PiBJIGRvbid0IHNlZSB3aHkgaXQgd291bGQgbWF0dGVyIGFz
IGEgNjQtYml0IG1hY2hpbmUgY2FuIG1ha2UgaTM4NiBhbmQgaTY4Ngo+PiBiaW5hcmllcyBqdXN0
IGFzIHdlbGwgYXMgeDg2XzY0Lgo+Pgo+PiBJZiBJIGV4dHJhY3QgdGhlIGZpbGVzIGZyb20gdGhl
IHBvc3RncmVzcWwtc2VydmVyIHJwbSBhbmQgcnVuIGZpbGUgYWdhaW5zdAo+PiB0aGVtLCBpdCBz
aG93cyB0aGVtIGFsbCBhcyAzMi1iaXQgZXhlY3V0YWJsZXM6Cj4+Cj4+IGluaXRkYjogICAgICAg
ICBFTEYgMzItYml0IExTQiBleGVjdXRhYmxlLCBJbnRlbCA4MDM4NiwgdmVyc2lvbiAxIChTWVNW
KSwgZm9yCj4+IEdOVS9MaW51eCAyLjIuNSwgZHluYW1pY2FsbHkgbGlua2VkICh1c2VzIHNoYXJl
ZCBsaWJzKSwgc3RyaXBwZWQKPgo+IDxzbmlwPgo+Cj4KPiBbcm9vdEBldmltIH5dIyBycG0gLXEg
LS1xdWVyeWZvcm1hdD0iJXtBUkNIfSIgcG9zdGdyZXNxbC1zZXJ2ZXIKPiB4ODZfNjQKPgo+IFty
b290QGV2aW0gfl0jIGZpbGUgYHJwbSAtcWwgcG9zdGdyZXNxbC1zZXJ2ZXJ8Z3JlcCAvdXNyL2Jp
bmAKPiAvdXNyL2Jpbi9pbml0ZGI6ICAgICAgICAgRUxGIDY0LWJpdCBMU0IgZXhlY3V0YWJsZSwg
eDg2LTY0LCB2ZXJzaW9uIDEgKFNZU1YpLCBkeW5hbWljYWxseSBsaW5rZWQgKHVzZXMgc2hhcmVk
IGxpYnMpLCBmb3IgR05VL0xpbnV4IDIuNi45LCBzdHJpcHBlZAo+IC91c3IvYmluL2lwY2NsZWFu
OiAgICAgICBCb3VybmUgc2hlbGwgc2NyaXB0IHRleHQgZXhlY3V0YWJsZQo+IC91c3IvYmluL3Bn
X2NvbnRyb2xkYXRhOiBFTEYgNjQtYml0IExTQiBleGVjdXRhYmxlLCB4ODYtNjQsIHZlcnNpb24g
MSAoU1lTViksIGR5bmFtaWNhbGx5IGxpbmtlZCAodXNlcyBzaGFyZWQgbGlicyksIGZvciBHTlUv
TGludXggMi42LjksIHN0cmlwcGVkCj4gL3Vzci9iaW4vcGdfY3RsOiAgICAgICAgIEVMRiA2NC1i
aXQgTFNCIGV4ZWN1dGFibGUsIHg4Ni02NCwgdmVyc2lvbiAxIChTWVNWKSwgZHluYW1pY2FsbHkg
bGlua2VkICh1c2VzIHNoYXJlZCBsaWJzKSwgZm9yIEdOVS9MaW51eCAyLjYuOSwgc3RyaXBwZWQK
PiAvdXNyL2Jpbi9wZ19yZXNldHhsb2c6ICAgRUxGIDY0LWJpdCBMU0IgZXhlY3V0YWJsZSwgeDg2
LTY0LCB2ZXJzaW9uIDEgKFNZU1YpLCBkeW5hbWljYWxseSBsaW5rZWQgKHVzZXMgc2hhcmVkIGxp
YnMpLCBmb3IgR05VL0xpbnV4IDIuNi45LCBzdHJpcHBlZAo+IC91c3IvYmluL3Bvc3RncmVzOiAg
ICAgICBFTEYgNjQtYml0IExTQiBleGVjdXRhYmxlLCB4ODYtNjQsIHZlcnNpb24gMSAoU1lTViks
IGR5bmFtaWNhbGx5IGxpbmtlZCAodXNlcyBzaGFyZWQgbGlicyksIGZvciBHTlUvTGludXggMi42
LjksIHN0cmlwcGVkCj4gL3Vzci9iaW4vcG9zdG1hc3RlcjogICAgIHN5bWJvbGljIGxpbmsgdG8g
YHBvc3RncmVzJwoKVW5mb3J0dW5hdGVseSwgSSBkb24ndCBoYXZlIHRob3NlIDMyLWJpdCA4LjIu
NCBSUE1zIGluc3RhbGxlZCBhbnl3aGVyZSBhdCB0aGUgCm1vbWVudCwgYnV0IHdpbGwgY2lyY2xl
IGJhY2sgb24gdGhpcyBhcyBzb29uIGFzIGEgMzItYml0IG1hY2hpbmUgaXMgYXZhaWxhYmxlIAph
Z2Fpbi4KCj4KPgo+PiBUaGUgc2FtZSB3YXMgdHJ1ZSBvZiBhbGwgdGhlIHNoYXJlZCBtb2R1bGVz
IGluIC91c3IvbGliL3Bnc3FsLgo+Cj4gWW91IGtub3csIHlvdSAqY2FuKiBpbnN0YWxsIGJvdGgg
MzIgYml0IGFuZCA2NCBiaXQgdmVyc2lvbnMgdG8gdGhlIHNhbWUKPiA2NCBiaXQgbWFjaGluZSAg
LS0gU28gSSBkb24ndCBjYXJlIGFib3V0IHRoZSBmaWxlcyB1bmRlciAvdXNyL2xpYi8gLgo+IFdo
YXQgYWJvdXQgL3Vzci9saWI2NCA/CgpZZXMsIHlvdSdyZSBxdWl0ZSByaWdodCwgYnV0IHlvdSBt
dXN0IGhhdmUgbWlzc2VkIGl0IHdheSBiYWNrIGF0IHRoZSBiZWdpbm5pbmcgCm9mIHRoZSB0aHJl
YWQuICBUaGUgbWFjaGluZSBpbiBxdWVzdGlvbiBpcyBhIDMyLWJpdCBtYWNoaW5lIGFuZCB0aGVy
ZSdzIG5vIAovdXNyL2xpYjY0IG9uIHRoaXMgbWFjaGluZSBhdCBhbGw6CgpscyAvdXNyL2xpYjY0
CmxzOiAvdXNyL2xpYjY0OiBObyBzdWNoIGZpbGUgb3IgZGlyZWN0b3J5CgpMaW51eCB0ZXN0ZGIx
IDIuNi45LTM0LkVMc21wICMxIFNNUCBXZWQgTWFyIDggMDA6Mjc6MDMgQ1NUIDIwMDYgaTY4NiBp
Njg2IGkzODYgR05VL0xpbnV4CgoKPiBbcm9vdEBldmltIHg4Nl82NF0jIHN0cmluZ3MgcG9zdGdy
ZXNxbC1zbG9ueTEtZW5naW5lLUhFQURfMjAwNzA1MDktMV9QRzguMi40LmZjNy54ODZfNjQucnBt
IHxncmVwIC91c3IvbGliCj4gL3Vzci9saWI2NC9wZ3NxbC9zbG9uLXRvb2xzLnBtCj4gL3Vzci9s
aWI2NC9wZ3NxbC8KPgoKSSBjb21waWxlZCBzbG9ueSBmcm9tIHNvdXJjZSBhZ2FpbnN0IHRoZSA4
LjIuNCBkZXZlbCBwYWNrYWdlIHJwbS4KCi0tIApKZWZmIEZyb3N0LCBPd25lciAJPGplZmZAZnJv
c3Rjb25zdWx0aW5nbGxjLmNvbT4KRnJvc3QgQ29uc3VsdGluZywgTExDIAlodHRwOi8vd3d3LmZy
b3N0Y29uc3VsdGluZ2xsYy5jb20vClBob25lOiA2NTAtNzgwLTc5MDgJRkFYOiA2NTAtNjQ5LTE5
NTQK
From dmitry at koterov.ru  Tue Aug  7 03:08:23 2007
From: dmitry at koterov.ru (Dmitry Koterov)
Date: Tue Aug  7 03:08:44 2007
Subject: [Slony1-general] The order of sequential and non-overlapped
	transactions
In-Reply-To: <20070806093333.0adacf3a.wmoran@collaborativefusion.com>
References: <d7df81620708041242w3c56e46bk55ddee6cf4de2ebb@mail.gmail.com>
	<20070806093333.0adacf3a.wmoran@collaborativefusion.com>
Message-ID: <d7df81620708070308o1dd70c5ekb48e88cdb2f75601@mail.gmail.com>

Thanks.
Please answer one more question - more detalized...

("Non-overlapped" - I meant that the first transaction finished strictly
before the second is started. Because they are performed in a single
session.)

> if you are sure that the transactions are committed
> on the master in a particular order, you can then be sure that those are
> committed on each of the slaves in the same order
Great! That means that if I sure that the last transaction of a session is
successfully processed by a subscriber, I have to be sure that ALL previous
transactions of this session are also processed already.

> No.  That's not what that table does.  It simply replicates events to
other
> servers in the cluster, it doesn't guarantee that they've been processed.
> Have a look at sl_confirm.
OK, so, let's transform the question with sl_confirm usage:

BEGIN;
UPDATE tbl SET c=3D10 WHERE d=3D10;
COMMIT;
--
-- some delay (e.g. 0.1s)
--
SELECT max(sl_confirm.con_seqno);  -- =3D> save a result to $seqno variable

The question is: if subscriber's max(sl_confirm.con_seqno) is greater than
$seqno, could I be 100% sure that the transaction #1 is already processed
and committed by this subscriber?



On 8/6/07, Bill Moran <wmoran@collaborativefusion.com> wrote:
>
> In response to "Dmitry Koterov" <dmitry@koterov.ru>:
>
> > Hello.
> >
> > Could you please answer three questions about Slony's transaction
> > serialization? (I suppose that two first answers will be "yes", but I'd
> like
> > to hear the opinions of gurus.) Unfortunately I cannot find direct
> answers
> > in the Slony documentation.
> >
> > 1. I have the following non-overlapped sequence of transactions in a
> SINGLE
> > (!!!) session (connection) on an origin:
> >
> > BEGIN;
> > UPDATE tbl SET a=3D10 WHERE b=3D10;
> > COMMIT;
> > --
> > -- some little delay (e.g. 0.1s)
> > --
> > BEGIN;
> > UPDATE tbl SET a=3D20 WHERE b=3D20;
> > COMMIT;
> >
> > The question is: if a subscriber received and processed the result of
> the
> > transaction #2, could I be sure that it had also received and committed
> a
> > result of the transaction #1? Transactions are not overlapped.
>
> I'm unsure what you mean by "non-overlapped".  The whole point to a
> transaction
> is that it is an atomic operation, so, by design, transactions can't
> overlap,
> since they happen within a single atom of time.
>
> To answer your question, if you are sure that the transactions are
> committed
> on the master in a particular order, you can then be sure that those are
> committed on each of the slaves in the same order.  Otherwise, Slony
> wouldn't
> even work.
>
> > 2. I have the following sequence in a SINGLE session (also not
> overlapped):
> >
> > BEGIN;
> > UPDATE tbl SET c=3D10 WHERE d=3D10;
> > COMMIT;
> > --
> > -- some delay (e.g. 0.1s)
> > --
> > SELECT nextval('some_seq');  -- =3D> save a result to $some_seq variable
> >
> > The question is: if subscriber's currval('some_seq') is greater than
> > $some_seq, could I be sure that the transaction #1 is also processed and
> > committed by this subscriber?
>
> How is this question different than #1?
>
> > 3. I have the following sequence in a SINGLE session (not overlapped):
> >
> > BEGIN;
> > UPDATE tbl SET c=3D10 WHERE d=3D10;
> > COMMIT;
> > --
> > -- some delay (e.g. 0.1s)
> > --
> > SELECT max(sl_event.ev_seqno);  -- =3D> save a result to $seqno variable
> >
> > The question is: if subscriber's max(sl_event.ev_seqno) is greater than
> > $seqno, could I be 100% sure that the transaction #1 is already
> processed
> > and committed by this subscriber?
>
> No.  That's not what that table does.  It simply replicates events to
> other
> servers in the cluster, it doesn't guarantee that they've been processed.
> Have a look at sl_confirm.
>
> --
> Bill Moran
> Collaborative Fusion Inc.
> http://people.collaborativefusion.com/~wmoran/
>
> wmoran@collaborativefusion.com
> Phone: 412-422-3463x4023
> _______________________________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070807/=
719787d5/attachment.htm
From wmoran at collaborativefusion.com  Tue Aug  7 05:04:00 2007
From: wmoran at collaborativefusion.com (Bill Moran)
Date: Tue Aug  7 05:04:26 2007
Subject: [Slony1-general] The order of sequential and non-overlapped
	transactions
In-Reply-To: <d7df81620708070308o1dd70c5ekb48e88cdb2f75601@mail.gmail.com>
References: <d7df81620708041242w3c56e46bk55ddee6cf4de2ebb@mail.gmail.com>
	<20070806093333.0adacf3a.wmoran@collaborativefusion.com>
	<d7df81620708070308o1dd70c5ekb48e88cdb2f75601@mail.gmail.com>
Message-ID: <20070807080400.a04c2539.wmoran@collaborativefusion.com>

In response to "Dmitry Koterov" <dmitry@koterov.ru>:

> Thanks.
> Please answer one more question - more detalized...
> 
> ("Non-overlapped" - I meant that the first transaction finished strictly
> before the second is started. Because they are performed in a single
> session.)
> 
> > if you are sure that the transactions are committed
> > on the master in a particular order, you can then be sure that those are
> > committed on each of the slaves in the same order
> Great! That means that if I sure that the last transaction of a session is
> successfully processed by a subscriber, I have to be sure that ALL previous
> transactions of this session are also processed already.
> 
> > No.  That's not what that table does.  It simply replicates events to other
> > servers in the cluster, it doesn't guarantee that they've been processed.
> > Have a look at sl_confirm.
> OK, so, let's transform the question with sl_confirm usage:
> 
> BEGIN;
> UPDATE tbl SET c=10 WHERE d=10;
> COMMIT;
> --
> -- some delay (e.g. 0.1s)
> --
> SELECT max(sl_confirm.con_seqno);  -- => save a result to $seqno variable
> 
> The question is: if subscriber's max(sl_confirm.con_seqno) is greater than
> $seqno, could I be 100% sure that the transaction #1 is already processed
> and committed by this subscriber?

I'm not sure I understand your question:

sl_cofirm records times that Slony events are confirmed on each subscriber
node.  As a result, a simple max(sl_confirm.con_seqno) doesn't really tell
you anything rational.

I recommend watching that table for a while to see how things occur, you'll
get a better idea of what's going on:

select * from sl_confirm order by con_seqno desc, con_timestamp desc limit 10;

I assume, from this question, that you're trying to come up with a way to monitor
Slony.  A query like the following would help:

SELECT (now() - max(con_timestamp)) < '15 sec'::interval AS nodes_synced
 FROM sl_confirm
 WHERE con_received = <node you want to monitor>;

Which will return true if the node is within 15 seconds of being synced.  That
would be good for general monitoring.

If you need to be certain that individual transactions have made it, then you're
probably using the wrong replication system.  Might I recommend 2-phase commit.
Otherwise, you best bet is to connect to the slave and query the data to see if
it looks the way you want it.

The problem is that if other transactions are running, I don't know how you're
going to reliably retrieve the Slony event ID that corresponds to your particular
transaction.

> On 8/6/07, Bill Moran <wmoran@collaborativefusion.com> wrote:
> >
> > In response to "Dmitry Koterov" <dmitry@koterov.ru>:
> >
> > > Hello.
> > >
> > > Could you please answer three questions about Slony's transaction
> > > serialization? (I suppose that two first answers will be "yes", but I'd
> > like
> > > to hear the opinions of gurus.) Unfortunately I cannot find direct
> > answers
> > > in the Slony documentation.
> > >
> > > 1. I have the following non-overlapped sequence of transactions in a
> > SINGLE
> > > (!!!) session (connection) on an origin:
> > >
> > > BEGIN;
> > > UPDATE tbl SET a=10 WHERE b=10;
> > > COMMIT;
> > > --
> > > -- some little delay (e.g. 0.1s)
> > > --
> > > BEGIN;
> > > UPDATE tbl SET a=20 WHERE b=20;
> > > COMMIT;
> > >
> > > The question is: if a subscriber received and processed the result of
> > the
> > > transaction #2, could I be sure that it had also received and committed
> > a
> > > result of the transaction #1? Transactions are not overlapped.
> >
> > I'm unsure what you mean by "non-overlapped".  The whole point to a
> > transaction
> > is that it is an atomic operation, so, by design, transactions can't
> > overlap,
> > since they happen within a single atom of time.
> >
> > To answer your question, if you are sure that the transactions are
> > committed
> > on the master in a particular order, you can then be sure that those are
> > committed on each of the slaves in the same order.  Otherwise, Slony
> > wouldn't
> > even work.
> >
> > > 2. I have the following sequence in a SINGLE session (also not
> > overlapped):
> > >
> > > BEGIN;
> > > UPDATE tbl SET c=10 WHERE d=10;
> > > COMMIT;
> > > --
> > > -- some delay (e.g. 0.1s)
> > > --
> > > SELECT nextval('some_seq');  -- => save a result to $some_seq variable
> > >
> > > The question is: if subscriber's currval('some_seq') is greater than
> > > $some_seq, could I be sure that the transaction #1 is also processed and
> > > committed by this subscriber?
> >
> > How is this question different than #1?
> >
> > > 3. I have the following sequence in a SINGLE session (not overlapped):
> > >
> > > BEGIN;
> > > UPDATE tbl SET c=10 WHERE d=10;
> > > COMMIT;
> > > --
> > > -- some delay (e.g. 0.1s)
> > > --
> > > SELECT max(sl_event.ev_seqno);  -- => save a result to $seqno variable
> > >
> > > The question is: if subscriber's max(sl_event.ev_seqno) is greater than
> > > $seqno, could I be 100% sure that the transaction #1 is already
> > processed
> > > and committed by this subscriber?
> >
> > No.  That's not what that table does.  It simply replicates events to
> > other
> > servers in the cluster, it doesn't guarantee that they've been processed.
> > Have a look at sl_confirm.
> >
> > --
> > Bill Moran
> > Collaborative Fusion Inc.
> > http://people.collaborativefusion.com/~wmoran/
> >
> > wmoran@collaborativefusion.com
> > Phone: 412-422-3463x4023
> > _______________________________________________
> > Slony1-general mailing list
> > Slony1-general@lists.slony.info
> > http://lists.slony.info/mailman/listinfo/slony1-general
> >
> 
> 
> 
> 
> 
> 
> 


-- 
Bill Moran
Collaborative Fusion Inc.
http://people.collaborativefusion.com/~wmoran/

wmoran@collaborativefusion.com
Phone: 412-422-3463x4023

****************************************************************
IMPORTANT: This message contains confidential information and is
intended only for the individual named. If the reader of this
message is not an intended recipient (or the individual
responsible for the delivery of this message to an intended
recipient), please be advised that any re-use, dissemination,
distribution or copying of this message is prohibited. Please
notify the sender immediately by e-mail if you have received
this e-mail by mistake and delete this e-mail from your system.
E-mail transmission cannot be guaranteed to be secure or
error-free as information could be intercepted, corrupted, lost,
destroyed, arrive late or incomplete, or contain viruses. The
sender therefore does not accept liability for any errors or
omissions in the contents of this message, which arise as a
result of e-mail transmission.
****************************************************************
From dmitry at koterov.ru  Tue Aug  7 05:21:55 2007
From: dmitry at koterov.ru (Dmitry Koterov)
Date: Tue Aug  7 05:21:59 2007
Subject: [Slony1-general] The order of sequential and non-overlapped
	transactions
In-Reply-To: <20070807080400.a04c2539.wmoran@collaborativefusion.com>
References: <d7df81620708041242w3c56e46bk55ddee6cf4de2ebb@mail.gmail.com>
	<20070806093333.0adacf3a.wmoran@collaborativefusion.com>
	<d7df81620708070308o1dd70c5ekb48e88cdb2f75601@mail.gmail.com>
	<20070807080400.a04c2539.wmoran@collaborativefusion.com>
Message-ID: <d7df81620708070521p7a040229paa83de26d92653bc@mail.gmail.com>

Thanks for your answers!

No, it is not for monitoring purpose, it is for optimal checking if all of
the session's transactions are processed by a subscriber or not yet.
(Insignificant false negatives are alowed here.) I do not need an
information about the whole node status, but - only about the status of a
single session executed some time ago. If all transactions of this session
were processed by a subscriber or not yet - here is the main question.

I'm not sure I understand your question: sl_cofirm records times that Slony
> events are confirmed on each subscriber
> node.  As a result, a simple max(sl_confirm.con_seqno) doesn't really tell
> you anything rational.
>

Oh, sorry! Of course, I meant the following question:

-------------
BEGIN;
UPDATE tbl SET c=3D10 WHERE d=3D10;
COMMIT;
--
-- some delay (e.g. 0.1s)
--
SELECT max(sl_event.ev_seqno);  -- =3D> save a result to $seqno variable FR=
OM
SL_EVENT!
The question is: if subscriber's max(sl_confirm.con_seqno) (check SL_CONFIRM
here!) is greater than $seqno, could I be 100% sure that the transaction #1
is already processed and committed by this subscriber?
-------------

So, we fetch & save the seqno from the origin sl_event, and compare it -
with confirmed items in sl_confirm on a subscriber.



> I recommend watching that table for a while to see how things occur,
> you'll
> get a better idea of what's going on:
>
> select * from sl_confirm order by con_seqno desc, con_timestamp desc limit
> 10;
>
> I assume, from this question, that you're trying to come up with a way to
> monitor
> Slony.  A query like the following would help:
>
> SELECT (now() - max(con_timestamp)) < '15 sec'::interval AS nodes_synced
> FROM sl_confirm
> WHERE con_received =3D <node you want to monitor>;
>
> Which will return true if the node is within 15 seconds of being
> synced.  That
> would be good for general monitoring.
>
> If you need to be certain that individual transactions have made it, then
> you're
> probably using the wrong replication system.  Might I recommend 2-phase
> commit.
> Otherwise, you best bet is to connect to the slave and query the data to
> see if
> it looks the way you want it.
>
> The problem is that if other transactions are running, I don't know how
> you're
> going to reliably retrieve the Slony event ID that corresponds to your
> particular
> transaction.
>
> > On 8/6/07, Bill Moran <wmoran@collaborativefusion.com> wrote:
> > >
> > > In response to "Dmitry Koterov" <dmitry@koterov.ru>:
> > >
> > > > Hello.
> > > >
> > > > Could you please answer three questions about Slony's transaction
> > > > serialization? (I suppose that two first answers will be "yes", but
> I'd
> > > like
> > > > to hear the opinions of gurus.) Unfortunately I cannot find direct
> > > answers
> > > > in the Slony documentation.
> > > >
> > > > 1. I have the following non-overlapped sequence of transactions in a
> > > SINGLE
> > > > (!!!) session (connection) on an origin:
> > > >
> > > > BEGIN;
> > > > UPDATE tbl SET a=3D10 WHERE b=3D10;
> > > > COMMIT;
> > > > --
> > > > -- some little delay (e.g. 0.1s)
> > > > --
> > > > BEGIN;
> > > > UPDATE tbl SET a=3D20 WHERE b=3D20;
> > > > COMMIT;
> > > >
> > > > The question is: if a subscriber received and processed the result
> of
> > > the
> > > > transaction #2, could I be sure that it had also received and
> committed
> > > a
> > > > result of the transaction #1? Transactions are not overlapped.
> > >
> > > I'm unsure what you mean by "non-overlapped".  The whole point to a
> > > transaction
> > > is that it is an atomic operation, so, by design, transactions can't
> > > overlap,
> > > since they happen within a single atom of time.
> > >
> > > To answer your question, if you are sure that the transactions are
> > > committed
> > > on the master in a particular order, you can then be sure that those
> are
> > > committed on each of the slaves in the same order.  Otherwise, Slony
> > > wouldn't
> > > even work.
> > >
> > > > 2. I have the following sequence in a SINGLE session (also not
> > > overlapped):
> > > >
> > > > BEGIN;
> > > > UPDATE tbl SET c=3D10 WHERE d=3D10;
> > > > COMMIT;
> > > > --
> > > > -- some delay (e.g. 0.1s)
> > > > --
> > > > SELECT nextval('some_seq');  -- =3D> save a result to $some_seq
> variable
> > > >
> > > > The question is: if subscriber's currval('some_seq') is greater than
> > > > $some_seq, could I be sure that the transaction #1 is also processed
> and
> > > > committed by this subscriber?
> > >
> > > How is this question different than #1?
> > >
> > > > 3. I have the following sequence in a SINGLE session (not
> overlapped):
> > > >
> > > > BEGIN;
> > > > UPDATE tbl SET c=3D10 WHERE d=3D10;
> > > > COMMIT;
> > > > --
> > > > -- some delay (e.g. 0.1s)
> > > > --
> > > > SELECT max(sl_event.ev_seqno);  -- =3D> save a result to $seqno
> variable
> > > >
> > > > The question is: if subscriber's max(sl_event.ev_seqno) is greater
> than
> > > > $seqno, could I be 100% sure that the transaction #1 is already
> > > processed
> > > > and committed by this subscriber?
> > >
> > > No.  That's not what that table does.  It simply replicates events to
> > > other
> > > servers in the cluster, it doesn't guarantee that they've been
> processed.
> > > Have a look at sl_confirm.
> > >
> > > --
> > > Bill Moran
> > > Collaborative Fusion Inc.
> > > http://people.collaborativefusion.com/~wmoran/
> > >
> > > wmoran@collaborativefusion.com
> > > Phone: 412-422-3463x4023
> > > _______________________________________________
> > > Slony1-general mailing list
> > > Slony1-general@lists.slony.info
> > > http://lists.slony.info/mailman/listinfo/slony1-general
> > >
> >
> >
> >
> >
> >
> >
> >
>
>
> --
> Bill Moran
> Collaborative Fusion Inc.
> http://people.collaborativefusion.com/~wmoran/
>
> wmoran@collaborativefusion.com
> Phone: 412-422-3463x4023
>
> ****************************************************************
> IMPORTANT: This message contains confidential information and is
> intended only for the individual named. If the reader of this
> message is not an intended recipient (or the individual
> responsible for the delivery of this message to an intended
> recipient), please be advised that any re-use, dissemination,
> distribution or copying of this message is prohibited. Please
> notify the sender immediately by e-mail if you have received
> this e-mail by mistake and delete this e-mail from your system.
> E-mail transmission cannot be guaranteed to be secure or
> error-free as information could be intercepted, corrupted, lost,
> destroyed, arrive late or incomplete, or contain viruses. The
> sender therefore does not accept liability for any errors or
> omissions in the contents of this message, which arise as a
> result of e-mail transmission.
> ****************************************************************
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070807/=
d06aa30a/attachment-0001.htm
From cbbrowne at ca.afilias.info  Wed Aug  8 08:25:57 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Wed Aug  8 08:26:08 2007
Subject: [Slony1-general] Version 1.2.11 pre-release now available
In-Reply-To: <72dbd3150708060047q52179eder846162f18bcc3315@mail.gmail.com>
References: <601weka8aw.fsf@dba2.int.libertyrms.com>	
	<72dbd3150708031208pf6e8988scaba63074e595666@mail.gmail.com>	
	<46B39625.30301@ca.afilias.info>
	<72dbd3150708060047q52179eder846162f18bcc3315@mail.gmail.com>
Message-ID: <46B9E085.1020609@ca.afilias.info>

David Rees wrote:
> On 8/3/07, Christopher Browne <cbbrowne@ca.afilias.info> wrote:
>   
>> David Rees wrote:
>>     
>>> Would it be possible to get the documentation updated/fixed as I noted
>>> in this post?
>>> http://lists.slony.info/pipermail/slony1-general/2007-August/006417.html
>>>
>>> Let me know if you want me to whip up some patches against CVS, I'm
>>> happy to do so.
>>>       
>> Sure, that's entirely reasonable.
>>
>> Patches to documentation do not mandate retesting anything ;-).
>>
>> And yes, by all means, whip up some patches to CVS.  I tend to be
>> unapologetically "wordsmithing-happy" on such changes, but it's pretty
>> ideal if you start by poking at parts of the documentation to say
>> "that's where something needs to be changed."
>>     
>
> OK, here's some tweaks the configuration to 1. Fix what the docs claim
> are the defaults for sync interval and sync interval timeout and 2.
> Synchronize the docs a bit between slon.conf-sample and the primary
> documentation.
>
> Could probably use a bit more tweaking but I wanted to at least make
> sure the defaults are corrected before the next release.
>
> -Dave
>   
Most of this seems fine; fixes consistency between defaults and what is 
documented.

I don't agree with the explanation about the "race condition;" I don't 
think that represents a race condition at all.  The timeout value is not 
germane to the things described; if is set higher or lower, that will 
not lead to data being replicated improperly.

The reason for having sync_interval_timeout isn't to avoid a race 
condition - it is to provide a way to say, with some confidence, "We 
have replicated this origin up to Time T" even when there have been no 
recent updates coming in from the application.

I have reworded this, and committed it to 1.2 and HEAD...

http://lists.slony.info/pipermail/slony1-commit/2007-August/001911.html
From drees76 at gmail.com  Wed Aug  8 11:48:52 2007
From: drees76 at gmail.com (David Rees)
Date: Wed Aug  8 11:49:01 2007
Subject: [Slony1-general] Version 1.2.11 pre-release now available
In-Reply-To: <46B9E085.1020609@ca.afilias.info>
References: <601weka8aw.fsf@dba2.int.libertyrms.com>
	<72dbd3150708031208pf6e8988scaba63074e595666@mail.gmail.com>
	<46B39625.30301@ca.afilias.info>
	<72dbd3150708060047q52179eder846162f18bcc3315@mail.gmail.com>
	<46B9E085.1020609@ca.afilias.info>
Message-ID: <72dbd3150708081148y455dc867r919dcd798f4f0eb@mail.gmail.com>

On 8/8/07, Christopher Browne <cbbrowne@ca.afilias.info> wrote:
> Most of this seems fine; fixes consistency between defaults and what is
> documented.
>
> I don't agree with the explanation about the "race condition;" I don't
> think that represents a race condition at all.  The timeout value is not
> germane to the things described; if is set higher or lower, that will
> not lead to data being replicated improperly.
>
> The reason for having sync_interval_timeout isn't to avoid a race
> condition - it is to provide a way to say, with some confidence, "We
> have replicated this origin up to Time T" even when there have been no
> recent updates coming in from the application.
>
> I have reworded this, and committed it to 1.2 and HEAD...
>
> http://lists.slony.info/pipermail/slony1-commit/2007-August/001911.html

Thanks, the updated wording is good. So just to be clear, there is no
race condition with sequences as (they used to be) described and it
would be entirely possible to disable sync_interval_timeout and never
miss data?

-Dave
From cbbrowne at ca.afilias.info  Wed Aug  8 12:46:55 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Wed Aug  8 12:47:05 2007
Subject: [Slony1-general] Version 1.2.11 pre-release now available
In-Reply-To: <72dbd3150708081148y455dc867r919dcd798f4f0eb@mail.gmail.com>
	(David Rees's message of "Wed, 8 Aug 2007 11:48:52 -0700")
References: <601weka8aw.fsf@dba2.int.libertyrms.com>
	<72dbd3150708031208pf6e8988scaba63074e595666@mail.gmail.com>
	<46B39625.30301@ca.afilias.info>
	<72dbd3150708060047q52179eder846162f18bcc3315@mail.gmail.com>
	<46B9E085.1020609@ca.afilias.info>
	<72dbd3150708081148y455dc867r919dcd798f4f0eb@mail.gmail.com>
Message-ID: <60myx1g66o.fsf@dba2.int.libertyrms.com>

"David Rees" <drees76@gmail.com> writes:
> On 8/8/07, Christopher Browne <cbbrowne@ca.afilias.info> wrote:
>> Most of this seems fine; fixes consistency between defaults and what is
>> documented.
>>
>> I don't agree with the explanation about the "race condition;" I don't
>> think that represents a race condition at all.  The timeout value is not
>> germane to the things described; if is set higher or lower, that will
>> not lead to data being replicated improperly.
>>
>> The reason for having sync_interval_timeout isn't to avoid a race
>> condition - it is to provide a way to say, with some confidence, "We
>> have replicated this origin up to Time T" even when there have been no
>> recent updates coming in from the application.
>>
>> I have reworded this, and committed it to 1.2 and HEAD...
>>
>> http://lists.slony.info/pipermail/slony1-commit/2007-August/001911.html
>
> Thanks, the updated wording is good. So just to be clear, there is no
> race condition with sequences as (they used to be) described and it
> would be entirely possible to disable sync_interval_timeout and never
> miss data?

There's not a "race condition," per se, with sequences; they
always simply get polled at the end of each SYNC.

There's a change in version 2 where sequence values are held in memory
by the slon so that the values only get updated if they have changed
lately.

You won't miss table updates, regardless.
-- 
select 'cbbrowne' || '@' || 'ca.afilias.info';
<http://dba2.int.libertyrms.com/>
Christopher Browne
(416) 673-4124 (land)
From JanWieck at Yahoo.com  Thu Aug  9 10:26:19 2007
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Thu Aug  9 10:27:31 2007
Subject: [Slony1-general] REshaping on loss of middle tier node?
In-Reply-To: <m3ps28tc9c.fsf@mama.jerrysievers.com>
References: <m3bqdsv2da.fsf@mama.jerrysievers.com>	<20070731144931.37434eee.wmoran@collaborativefusion.com>	<m33az4uyr9.fsf@mama.jerrysievers.com>	<20070731162835.afc914d6.wmoran@collaborativefusion.com>	<46AFB198.9060205@ca.afilias.info>
	<m3ps28tc9c.fsf@mama.jerrysievers.com>
Message-ID: <46BB4E3B.9010709@Yahoo.com>

On 7/31/2007 6:54 PM, Jerry Sievers wrote:
> 
> Chris, this is very helpful.  Thanks!> 
> 
> Basically, I misunderstood the documentation and believe that what I
> was trying was supported and straightforward to do.  You have affirmed
> that it is not. 

What you intended to do is well supported and was so from day one. What 
the "subscribe set" command, that is supposed to let slave2 become a 
direct subscriber, requires is a path to the master. If that didn't 
exist, the subscribe should have failed. So all you have to do is

     store path (master->slave2)
     store path (slave2->master)
     subscribe set (...)

After that subscribe set finished and slave2 is catching up again, you 
can drop slave1 and are done.

I am not sure if 1.1.5 maintained the sl_listen table automagically. So 
you might want to add the appropriate "store listen" commands in there 
as well.


Jan

-- 
#======================================================================#
# It's easier to get forgiveness for being wrong than for being right. #
# Let's break this rule - forgive me.                                  #
#================================================== JanWieck@Yahoo.com #
From simon at 2ndquadrant.com  Fri Aug 10 08:04:14 2007
From: simon at 2ndquadrant.com (Simon Riggs)
Date: Fri Aug 10 08:03:20 2007
Subject: [Slony1-general] Slony locking
Message-ID: <1186758254.5344.70.camel@ebony.site>

Can I just check my understanding?

Slony single threads access to the log tables indirectly, by making the
log triggers do a LOCK TABLE on sl_event in EXCLUSIVE mode.

So we don't actually do LOCK TABLE on sl_log in EXCLUSIVE mode, but that
is the overall effect?


-- 
  Simon Riggs
  EnterpriseDB  http://www.enterprisedb.com

From bnichols at ca.afilias.info  Fri Aug 10 08:31:07 2007
From: bnichols at ca.afilias.info (Brad Nicholson)
Date: Fri Aug 10 08:30:06 2007
Subject: [Slony1-general] REshaping on loss of middle tier node?
In-Reply-To: <46BB4E3B.9010709@Yahoo.com>
References: <m3bqdsv2da.fsf@mama.jerrysievers.com>
	<20070731144931.37434eee.wmoran@collaborativefusion.com>
	<m33az4uyr9.fsf@mama.jerrysievers.com>
	<20070731162835.afc914d6.wmoran@collaborativefusion.com>
	<46AFB198.9060205@ca.afilias.info>
	<m3ps28tc9c.fsf@mama.jerrysievers.com> <46BB4E3B.9010709@Yahoo.com>
Message-ID: <1186759867.29355.38.camel@bnicholson-desktop>

On Thu, 2007-08-09 at 13:26 -0400, Jan Wieck wrote:
> On 7/31/2007 6:54 PM, Jerry Sievers wrote:
> > 
> > Chris, this is very helpful.  Thanks!> 
> > 
> > Basically, I misunderstood the documentation and believe that what I
> > was trying was supported and straightforward to do.  You have affirmed
> > that it is not. 
> 
> What you intended to do is well supported and was so from day one. What 
> the "subscribe set" command, that is supposed to let slave2 become a 
> direct subscriber, requires is a path to the master. If that didn't 
> exist, the subscribe should have failed. So all you have to do is
> 
>      store path (master->slave2)
>      store path (slave2->master)
>      subscribe set (...)
> 
> After that subscribe set finished and slave2 is catching up again, you 
> can drop slave1 and are done.
> 
> I am not sure if 1.1.5 maintained the sl_listen table automagically. So 
> you might want to add the appropriate "store listen" commands in there 
> as well.

store listen is a no-op in 1.1.5, resubmit your store paths and it will
regenerate the correct listen entries. 
-- 
Brad Nicholson  416-673-4106
Database Administrator, Afilias Canada Corp.

From mpartio at gmail.com  Fri Aug 10 09:08:10 2007
From: mpartio at gmail.com (Mikko Partio)
Date: Fri Aug 10 09:08:17 2007
Subject: [Slony1-general] Re: log shipping gone wrong
In-Reply-To: <2ca799770708052339w73818564y4ab95181505dd349@mail.gmail.com>
References: <2ca799770707200605j1bb37c13o98c86a21834db2ab@mail.gmail.com>
	<2ca799770707222327y5e5939bg6ccee843d0ef0097@mail.gmail.com>
	<46A4AE4F.4080304@Yahoo.com>
	<2ca799770707230728h3e3afa3auefdc1ae8dd429156@mail.gmail.com>
	<46A4C3E7.1020107@Yahoo.com>
	<2ca799770707232129p27822251v9947c748d2395630@mail.gmail.com>
	<46ACCF3A.9050005@Yahoo.com>
	<2ca799770708052339w73818564y4ab95181505dd349@mail.gmail.com>
Message-ID: <2ca799770708100908h2be13857r47bb77e5f0648669@mail.gmail.com>

On 8/6/07, Mikko Partio <mpartio@gmail.com> wrote:
>
>
> On 7/29/07, Jan Wieck <JanWieck@yahoo.com> wrote:
> >
> >
> >
> >
> > This one played quite a bit hide and seek with me. But I think I found
> > and fixed the bug.
> >
> > The problem occurred when some action (like STORE_SET) caused the
> > subscriber slon to perform an internal restart. During that, the current
> >
> > setsync tracking in the pset structure is reinitialized. However, since
> > the sl_setsync table is not updated on events other than SYNC, this
> > would lead to the wrong (too low) old sync expected if the last event(s)
> >
> > processed from that node where no SYNC events.
> >
> > Thanks for the detailed example.
>
>
>
> My experiments show me that the problem persists. The test-case is the
> same as in the previous example (started from scratch):
>



Any ideas?

Regards

MP
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070810/=
86aced27/attachment.htm
From JanWieck at Yahoo.com  Fri Aug 10 09:11:32 2007
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Fri Aug 10 09:11:41 2007
Subject: [Slony1-general] Re: log shipping gone wrong
In-Reply-To: <2ca799770708052339w73818564y4ab95181505dd349@mail.gmail.com>
References: <2ca799770707200605j1bb37c13o98c86a21834db2ab@mail.gmail.com>	
	<2ca799770707222327y5e5939bg6ccee843d0ef0097@mail.gmail.com>	
	<46A4AE4F.4080304@Yahoo.com>	
	<2ca799770707230728h3e3afa3auefdc1ae8dd429156@mail.gmail.com>	
	<46A4C3E7.1020107@Yahoo.com>	
	<2ca799770707232129p27822251v9947c748d2395630@mail.gmail.com>	
	<46ACCF3A.9050005@Yahoo.com>
	<2ca799770708052339w73818564y4ab95181505dd349@mail.gmail.com>
Message-ID: <46BC8E34.7060600@Yahoo.com>

I found a couple more issues with archive logging so far. Specifically 
some related to replicating sequences (seems like this could have never 
worked).

However, I have no clue why in your case the archive log writer thinks 
that set 10 would be already on event 54, when it in fact is only on 52. 
What event types are 52, 53 and 54?


Jan

On 8/6/2007 2:39 AM, Mikko Partio wrote:
> 
> On 7/29/07, *Jan Wieck* <JanWieck@yahoo.com <mailto:JanWieck@yahoo.com>> 
> wrote:
> 
> 
> 
> 
>     This one played quite a bit hide and seek with me. But I think I found
>     and fixed the bug.
> 
>     The problem occurred when some action (like STORE_SET) caused the
>     subscriber slon to perform an internal restart. During that, the
>     current
>     setsync tracking in the pset structure is reinitialized. However, since
>     the sl_setsync table is not updated on events other than SYNC, this
>     would lead to the wrong (too low) old sync expected if the last
>     event(s)
>     processed from that node where no SYNC events.
> 
>     Thanks for the detailed example.
> 
> 
> 
> My experiments show me that the problem persists. The test-case is the 
> same as in the previous example (started from scratch):
>  
> 
>      >
>      > 1) Create databases and some tables
>      >
>      > $ createdb -D data -E utf8 test3
>      > $ psql test3
>      >
>      > test3=# create table a (id int primary key);
>      > test3=# create table b (id int primary key);
>      > test3=# create table c (id int primary key);
>      >
>      > $ createdb -T test3 test3_lo
>      > $ createdb -T test3 test3_log
>      >
>      > 2) Create the replication cluster
>      >
>      > $ cat test3_preamble.slonik
>      > cluster name = test3;
>      >
>      > node 1 admin conninfo = 'host=localhost dbname=test3 user=postgres
>      > password=xxx';
>      > node 2 admin conninfo = 'host=localhost dbname=test3_lo user=postgres
>      > password=xxx';
>      >
>      > $ cat test3_init.slonik
>      > #!/bin/sh
>      >
>      > slonik <<_EOF_
>      >
>      >         include <test3_preamble.slonik>;
>      >
>      >         init cluster (id=1, comment='original database');
>      >
>      >         store node (id=2, comment = 'dummy loopback database');
>      >         store path (server=1, client=2, conninfo='dbname=test3
>      > host=localhost user=postgres password=xxx');
>      >         store path (server=2, client=1, conninfo='dbname=test3_lo
>      > host=localhost user=postgres password=xxx');
>      >         store listen (origin=1, provider=1, receiver=2);
>      >         store listen (origin=2, provider=2, receiver=1);
>      >
>      > _EOF_
>      >
>      > $ ./test3_init.slonik
>      >
>      > $ slon test3 "dbname=test3 host=localhost user=postgres
>     password=xxx"
>      > $ slon -a /tmp/logshipping/test3 test3 "dbname=test3_lo
>     host=localhost
>      > user=postgres password=xxx"
>      >
>      > $ cat test3_create_set.slonik
>      > #!/bin/sh
>      >
>      > if [ $# -ne 3 ]; then
>      >         echo "Usage: $0 SETID TABLEID TABLENAME"
>      >         echo "Example: $0 3 17 public.x"
>      >         exit 1
>      > fi
>      >
>      > slonik <<_EOF_
>      >
>      >         include <test3_preamble.slonik>;
>      >
>      >         create set (id=$1, origin=1, comment='Set #$1');
>      >         set add table (set id = $1, origin = 1, id = $2, fully
>     qualified
>      > name = '$3');
>      >
>      > _EOF_
>      >
>      > $ ./test3_create_set.slonik 1 1 public.a
>      > $ cat test3_subscribe.slonik
>      > #!/bin/sh
>      >
>      > if [ -z $1 ]; then
>      >         echo "Usage: $0 SETID"
>      >         exit 1;
>      > fi
>      >
>      > slonik <<_EOF_
>      >
>      >         include <test3_preamble.slonik>;
>      >
>      >         subscribe set (id=$1, provider=1, receiver=2, forward=no);
>      >
>      > _EOF_
>      >
>      > $ ./test3_subscribe.slonik 1
>      > $ psql test3_lo
>      > test3_lo=# \d a
>      >        Table " public.a"
>      >  Column |  Type   | Modifiers
>      > --------+---------+-----------
>      >  id     | integer | not null
>      > Indexes:
>      >     "a_pkey" PRIMARY KEY, btree (id)
>      > Triggers:
>      >     _test3_denyaccess_1 BEFORE INSERT OR DELETE OR UPDATE ON a
>     FOR EACH
>      > ROW EXECUTE PROCEDURE _test3.denyaccess('_test3')
>      >
>      > $ psql test3
>      > test3=# insert into a select * from generate_series(1,100);
>      >
>      > 3) Dump the state of the cluster to logshipping database
>      >
>      > $ ./slony1_dump.sh test3_lo test3 | psql test3_log
>      > $ psql test3_log
>      > test3_log=# select count(*) from a;
>      >  count
>      > -------
>      >    100
>      > (1 row)
>      >
>      > 4) Insert some data to origin db and see if it gets to logshipping db
>      >
>      > test3=# insert into a select * from generate_series(101,200);
>      >
>      > $ psql -d test3_log -f
>      > /tmp/logshipping/test3/slony1_log_1_00000000000000000060.sql
>      > $ psql test3_log
>      > test3_log=# select count(*) from a;
>      >  count
>      > -------
>      >    200
>      > (1 row)
>      >
>      > 5) Create another replication set
>      >
>      > $ ./test3_create_set.slonik 10 2 public.b
>      > $ ./test3_subscribe.slonik 10
>      >
>      > 6) Start applying logfiles to logshipping db
>      >
> 
> 
> Here's the new output:
> 
> 
> $ psql -d test3_log -f slony1_log_1_00000000000000000053.sql
> START TRANSACTION
> psql:slony1_log_1_00000000000000000053.sql:6: NOTICE:  Slony-I: Process 
> set 1 sync 53 time 2007-08-06 09:30: 03.823825+03
>  setsynctracking_offline
> -------------------------
>                       53
> (1 row)
> 
> COMMIT
> VACUUM
> 
> $ psql -d test3_log -f slony1_log_1_00000000000000000054.sql
> START TRANSACTION
> psql:slony1_log_1_00000000000000000054.sql:6: NOTICE:  Slony-I: Process 
> set 1 sync 54 time 2007-08-06 09:30:03.823825+03
>  setsynctracking_offline
> -------------------------
>                       54
> (1 row)
> 
> DELETE 0
>  finishtableaftercopy
> ----------------------
>                     1
> (1 row)
> 
> ANALYZE
> INSERT 0 1
> COMMIT
> VACUUM
> 
> 
> $ psql -d test3_log -f slony1_log_1_00000000000000000055.sql
> START TRANSACTION
> psql:slony1_log_1_00000000000000000055.sql:5: NOTICE:  Slony-I: Process 
> set 1 sync 55 time 2007-08-06 09:30:10.843406+03
>  setsynctracking_offline
> -------------------------
>                       55
> (1 row)
> 
> psql:slony1_log_1_00000000000000000055.sql:11: ERROR:  Slony-I: set 10 
> is on sync 52, this archive log expects 54
> 
> 
> Here's the contents of the sync-files 54 and 55:
> 
> $ cat slony1_log_1_00000000000000000054.sql
> -- Slony-I log shipping archive
> -- Node 1, Event 54
> start transaction;
> -- ENABLE_SUBSCRIPTION
> 
> select "_test3".setsyncTracking_offline(1, '53', '54', '2007-08-06 
> 09:30:03.823825 ');
> -- end of log archiving header
> ------------------------------------------------------------------
> -- start of Slony-I data
> ------------------------------------------------------------------
> delete from "public"."b";
> copy "public"."b" ("id") from stdin;
> \.
> select "_test3".finishTableAfterCopy(2); analyze "public"."b";
> insert into "_test3".sl_setsync_offline (ssy_setid, ssy_seqno) values 
> ('10', '52');
> 
> ------------------------------------------------------------------
> -- End Of Archive Log
> ------------------------------------------------------------------
> commit;
> vacuum analyze "_test3".sl_setsync_offline;
> 
> 
> 
> $ cat slony1_log_1_00000000000000000055.sql
> -- Slony-I log shipping archive
> -- Node 1, Event 55
> start transaction;
> 
> select "_test3".setsyncTracking_offline(1, '54', '55', '2007-08-06 
> 09:30: 10.843406');
> -- end of log archiving header
> ------------------------------------------------------------------
> -- start of Slony-I data
> ------------------------------------------------------------------
> 
> select "_test3".setsyncTracking_offline(10, '54', '55', '2007-08-06 
> 09:30:10.843406');
> -- end of log archiving header
> ------------------------------------------------------------------
> -- start of Slony-I data
> ------------------------------------------------------------------
> 
> ------------------------------------------------------------------
> -- End Of Archive Log
> ------------------------------------------------------------------
> commit;
> vacuum analyze "_test3".sl_setsync_offline;
> 
> 
> 
> Here's the contents of the setsync-table:
> 
> 
> test3_log=# select * from _test3.sl_setsync_offline ;
>  ssy_setid | ssy_seqno |         ssy_synctime
> -----------+-----------+-------------------------------
>          1 |        54 | 2007-08-06 09:30:03.823825+03
>         10 |        52 |
> (2 rows)
> 
> 
> 
> $ slon -v
> slon version 1.2.11
> 
> Any more info I can provide?
> 
> Regards
> 
> Mikko
> 
> 


-- 
#======================================================================#
# It's easier to get forgiveness for being wrong than for being right. #
# Let's break this rule - forgive me.                                  #
#================================================== JanWieck@Yahoo.com #
From dba at richyen.com  Fri Aug 10 09:41:21 2007
From: dba at richyen.com (Richard Yen)
Date: Fri Aug 10 09:41:26 2007
Subject: [Slony1-general] cannot drop tables from schema after dropping
	tables from replication
Message-ID: <E05DA5F5-E097-4651-85AB-F0F9828747E0@richyen.com>

Hi All,

I've encountered this a few times before in the past, but sometimes  
after I drop a table from replication, I cannot remove them from the  
schema.  I can successfully drop them from the origin database, but  
on the subscriber databases, I encounter some errors, namely, the  
following:

mydb=# begin; drop table new_gm_qm_set;
BEGIN
NOTICE:  constraint new_gm_qm_template_qm_set_fkey on table  
new_gm_qm_template depends on table new_gm_qm_set
NOTICE:  constraint new_gm_qm_set_share_qm_set_fkey on table  
new_gm_qm_set_share depends on table new_gm_qm_set
ERROR:  "m_user_pkey" is an index
mydb=# rollback;
ROLLBACK
mydb=# begin; alter table new_gm_qm_template drop constraint  
new_gm_qm_template_qm_set_fkey;
BEGIN
ALTER TABLE
mydb=# begin; alter table new_gm_qm_set_share drop constraint  
new_gm_qm_set_share_qm_set_fkey;
WARNING:  there is already a transaction in progress
BEGIN
ALTER TABLE
mydb=# drop table new_gm_qm_set;
ERROR:  "m_user_pkey" is an index
mydb=# rollback;
ROLLBACK
mydb=# \d m_user
                                                Table "public.m_user"
         Column         |            Type              
|                          Modifiers
-----------------------+----------------------------- 
+-------------------------------------------------------------
id                    | integer                     | not null  
default nextval(('m_user_id_seq'::text)::regclass)
first_name            | text                        | not null
last_name             | text                        | not null
[blah blah blah...]
Indexes:
     "m_user_pkey" PRIMARY KEY, btree (id) CLUSTER
     "m_user_email_key" UNIQUE, btree (email)
     "m_user_first_name_search_idx" btree (lower(first_name))
     "m_user_last_name_search_idx" btree (lower(last_name))
Check constraints:
     "first_name_is_trimmed" CHECK (btrim(first_name, ' '::text) =  
first_name)
     "last_name_is_trimmed" CHECK (btrim(last_name, ' '::text) =  
last_name)
Foreign-key constraints:
     "m_user_language_fkey" FOREIGN KEY ("language") REFERENCES  
m_language(id)
     "pwd_question_fk" FOREIGN KEY (pwd_question) REFERENCES  
m_password_questions(id)
     "state_fk" FOREIGN KEY (state) REFERENCES state_province(id)
     "user_agreement_fk" FOREIGN KEY (user_agreement) REFERENCES  
m_user_agreement(id)
     "user_type_fk" FOREIGN KEY (default_user_type) REFERENCES  
m_user_type(id)
Triggers:
     _mydb_denyaccess_7 BEFORE INSERT OR DELETE OR UPDATE ON m_user  
FOR EACH ROW EXECUTE PROCEDURE _mydb.denyaccess('_mydb')
mydb=# \d new_gm_qm_set;
                              Table "public.new_gm_qm_set"
      Column     |  Type   |                         Modifiers
----------------+--------- 
+------------------------------------------------------------
id             | integer | not null default nextval 
('new_gm_qm_set_id_seq'::regclass)
owner          | integer |
[blah blah blah...]
Indexes:
     "new_gm_qm_set_pkey" PRIMARY KEY, btree (id)
Foreign-key constraints:
     "new_gm_qm_set_owner_fkey" FOREIGN KEY ("owner") REFERENCES  
m_user(id)

mydb=# begin; alter table new_gm_qm_set drop constraint  
new_gm_qm_set_owner_fkey;
BEGIN
ERROR:  "m_user_pkey" is an index
mydb=# rollback;
ROLLBACK

Not sure if this is enough detail, or if anyone would have any idea  
why this happens.  Again, I can successfully DROP TABLE from the  
origin, but I cannot do so from the subscribers.  Therefore, I  
suspect that Slony has put my subscriber nodes in a strange state.

Please let me know if you need more detail.  Any help would be  
greatly appreciated!
--Richard
From mpartio at gmail.com  Fri Aug 10 21:44:54 2007
From: mpartio at gmail.com (Mikko Partio)
Date: Fri Aug 10 21:45:11 2007
Subject: [Slony1-general] Re: log shipping gone wrong
In-Reply-To: <46BC8E34.7060600@Yahoo.com>
References: <2ca799770707200605j1bb37c13o98c86a21834db2ab@mail.gmail.com>
	<2ca799770707222327y5e5939bg6ccee843d0ef0097@mail.gmail.com>
	<46A4AE4F.4080304@Yahoo.com>
	<2ca799770707230728h3e3afa3auefdc1ae8dd429156@mail.gmail.com>
	<46A4C3E7.1020107@Yahoo.com>
	<2ca799770707232129p27822251v9947c748d2395630@mail.gmail.com>
	<46ACCF3A.9050005@Yahoo.com>
	<2ca799770708052339w73818564y4ab95181505dd349@mail.gmail.com>
	<46BC8E34.7060600@Yahoo.com>
Message-ID: <2ca799770708102144p4726a370l206e56ec664b1149@mail.gmail.com>

On 8/10/07, Jan Wieck <JanWieck@yahoo.com> wrote:
>
> I found a couple more issues with archive logging so far. Specifically
> some related to replicating sequences (seems like this could have never
> worked).
>
> However, I have no clue why in your case the archive log writer thinks
> that set 10 would be already on event 54, when it in fact is only on 52.
> What event types are 52, 53 and 54?



test3_lo=3D# select ev_seqno, ev_type from _test3.sl_event where ev_seqno in
(52, 53, 54);
 ev_seqno |       ev_type
----------+---------------------
       52 | SYNC
       53 | SUBSCRIBE_SET
       54 | ENABLE_SUBSCRIPTION
(3 rows)


Regards

MP
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070811/=
8271ebe4/attachment.htm
From mpartio at gmail.com  Sat Aug 11 12:40:31 2007
From: mpartio at gmail.com (Mikko Partio)
Date: Sat Aug 11 12:40:41 2007
Subject: [Slony1-general] cannot drop tables from schema after dropping
	tables from replication
In-Reply-To: <E05DA5F5-E097-4651-85AB-F0F9828747E0@richyen.com>
References: <E05DA5F5-E097-4651-85AB-F0F9828747E0@richyen.com>
Message-ID: <2ca799770708111240l78a88d75i96942d3f6f563d97@mail.gmail.com>

On 8/10/07, Richard Yen <dba@richyen.com> wrote:

>
> Not sure if this is enough detail, or if anyone would have any idea
> why this happens.  Again, I can successfully DROP TABLE from the
> origin, but I cannot do so from the subscribers.  Therefore, I
> suspect that Slony has put my subscriber nodes in a strange state.



You have to remove the table from replication first (see slonik and "set
drop table") before you can physically drop it. This is because Slony alters
the pgsql system catalog at the subscriber node.



Regards

MP
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070811/=
d8b7635a/attachment.htm
From cbbrowne at ca.afilias.info  Sat Aug 11 19:13:05 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Sat Aug 11 19:13:20 2007
Subject: [Slony1-general] cannot drop tables from schema after dropping
	tables from replication
In-Reply-To: <E05DA5F5-E097-4651-85AB-F0F9828747E0@richyen.com> (Richard Yen's
	message of "Fri, 10 Aug 2007 09:41:21 -0700")
References: <E05DA5F5-E097-4651-85AB-F0F9828747E0@richyen.com>
Message-ID: <60lkchts9a.fsf@dba2.int.libertyrms.com>

Richard Yen <dba@richyen.com> writes:
> Hi All,
>
> I've encountered this a few times before in the past, but sometimes
> after I drop a table from replication, I cannot remove them from the
> schema.  I can successfully drop them from the origin database, but
> on the subscriber databases, I encounter some errors, namely, the
> following:
>
> mydb=# begin; drop table new_gm_qm_set;
> BEGIN
> NOTICE:  constraint new_gm_qm_template_qm_set_fkey on table
> new_gm_qm_template depends on table new_gm_qm_set
> NOTICE:  constraint new_gm_qm_set_share_qm_set_fkey on table
> new_gm_qm_set_share depends on table new_gm_qm_set
> ERROR:  "m_user_pkey" is an index
> mydb=# rollback;

Your belief that "they are in a strange state" is indeed correct.

The constraints, on subscriber nodes, get repointed to the primary key
candidate index, and that evidently causes the phenomenon that you're
seeing.

The *right* way to drop a table from replication is to first of all
run the slonik "SET DROP TABLE" command against the table.  

When that is processed, on the origin, the "logtrigger" trigger gets
removed.

When that is processed, on subscribers, the "denyaccess" trigger gets
removed, and the constraints get fixed up.
-- 
let name="cbbrowne" and tld="acm.org" in name ^ "@" ^ tld;;
http://linuxdatabases.info/info/slony.html
Epistemology in One Lesson
Reality ruthlessly selects out creatures that embody hypotheses too
inconsistent with reality. Our only choice is whether we participate
by being selected out, or (in Popper's great phrase) by "letting our
ideas die in our stead."
-- Mark Miller
From dmitry at koterov.ru  Mon Aug 13 05:30:19 2007
From: dmitry at koterov.ru (Dmitry Koterov)
Date: Mon Aug 13 05:30:24 2007
Subject: [Slony1-general] The order of sequential and non-overlapped
	transactions
In-Reply-To: <d7df81620708070521p7a040229paa83de26d92653bc@mail.gmail.com>
References: <d7df81620708041242w3c56e46bk55ddee6cf4de2ebb@mail.gmail.com>
	<20070806093333.0adacf3a.wmoran@collaborativefusion.com>
	<d7df81620708070308o1dd70c5ekb48e88cdb2f75601@mail.gmail.com>
	<20070807080400.a04c2539.wmoran@collaborativefusion.com>
	<d7df81620708070521p7a040229paa83de26d92653bc@mail.gmail.com>
Message-ID: <d7df81620708130530r7e599529ge6df6dad0ccb3f64@mail.gmail.com>

Hmm.
Seems sl_confirm is not usable in this case, because:
1. its timestamp field holds a SUBSCRIBER time, not the master time
2. slony source code shows that insertions in sl_event and sl_confirm are
done in a single transaction, so, if something appeared in sl_confirm on a
subscriber, it is also appeared in sl_event.


On 8/7/07, Dmitry Koterov <dmitry@koterov.ru> wrote:
>
> Thanks for your answers!
>
> No, it is not for monitoring purpose, it is for optimal checking if all of
> the session's transactions are processed by a subscriber or not yet.
> (Insignificant false negatives are alowed here.) I do not need an
> information about the whole node status, but - only about the status of a
> single session executed some time ago. If all transactions of this session
> were processed by a subscriber or not yet - here is the main question.
>
> I'm not sure I understand your question: sl_cofirm records times that
> > Slony events are confirmed on each subscriber
> > node.  As a result, a simple max(sl_confirm.con_seqno) doesn't really
> > tell
> > you anything rational.
> >
>
> Oh, sorry! Of course, I meant the following question:
>
> -------------
> BEGIN;
> UPDATE tbl SET c=3D10 WHERE d=3D10;
> COMMIT;
> --
> -- some delay (e.g. 0.1s)
> --
> SELECT max(sl_event.ev_seqno);  -- =3D> save a result to $seqno variable
> FROM SL_EVENT!
> The question is: if subscriber's max(sl_confirm.con_seqno) (check
> SL_CONFIRM here!) is greater than $seqno, could I be 100% sure that the
> transaction #1 is already processed and committed by this subscriber?
> -------------
>
> So, we fetch & save the seqno from the origin sl_event, and compare it -
> with confirmed items in sl_confirm on a subscriber.
>
>
>
> > I recommend watching that table for a while to see how things occur,
> > you'll
> > get a better idea of what's going on:
> >
> > select * from sl_confirm order by con_seqno desc, con_timestamp desc
> > limit 10;
> >
> > I assume, from this question, that you're trying to come up with a way
> > to monitor
> > Slony.  A query like the following would help:
> >
> > SELECT (now() - max(con_timestamp)) < '15 sec'::interval AS nodes_synced
> >
> > FROM sl_confirm
> > WHERE con_received =3D <node you want to monitor>;
> >
> > Which will return true if the node is within 15 seconds of being
> > synced.  That
> > would be good for general monitoring.
> >
> > If you need to be certain that individual transactions have made it,
> > then you're
> > probably using the wrong replication system.  Might I recommend 2-phase
> > commit.
> > Otherwise, you best bet is to connect to the slave and query the data to
> > see if
> > it looks the way you want it.
> >
> > The problem is that if other transactions are running, I don't know how
> > you're
> > going to reliably retrieve the Slony event ID that corresponds to your
> > particular
> > transaction.
> >
> > > On 8/6/07, Bill Moran <wmoran@collaborativefusion.com > wrote:
> > > >
> > > > In response to "Dmitry Koterov" <dmitry@koterov.ru>:
> > > >
> > > > > Hello.
> > > > >
> > > > > Could you please answer three questions about Slony's transaction
> > > > > serialization? (I suppose that two first answers will be "yes",
> > but I'd
> > > > like
> > > > > to hear the opinions of gurus.) Unfortunately I cannot find direct
> > > > answers
> > > > > in the Slony documentation.
> > > > >
> > > > > 1. I have the following non-overlapped sequence of transactions in
> > a
> > > > SINGLE
> > > > > (!!!) session (connection) on an origin:
> > > > >
> > > > > BEGIN;
> > > > > UPDATE tbl SET a=3D10 WHERE b=3D10;
> > > > > COMMIT;
> > > > > --
> > > > > -- some little delay (e.g. 0.1s)
> > > > > --
> > > > > BEGIN;
> > > > > UPDATE tbl SET a=3D20 WHERE b=3D20;
> > > > > COMMIT;
> > > > >
> > > > > The question is: if a subscriber received and processed the result
> > of
> > > > the
> > > > > transaction #2, could I be sure that it had also received and
> > committed
> > > > a
> > > > > result of the transaction #1? Transactions are not overlapped.
> > > >
> > > > I'm unsure what you mean by "non-overlapped".  The whole point to a
> > > > transaction
> > > > is that it is an atomic operation, so, by design, transactions can't
> > > > overlap,
> > > > since they happen within a single atom of time.
> > > >
> > > > To answer your question, if you are sure that the transactions are
> > > > committed
> > > > on the master in a particular order, you can then be sure that those
> > are
> > > > committed on each of the slaves in the same order.  Otherwise, Slony
> > > > wouldn't
> > > > even work.
> > > >
> > > > > 2. I have the following sequence in a SINGLE session (also not
> > > > overlapped):
> > > > >
> > > > > BEGIN;
> > > > > UPDATE tbl SET c=3D10 WHERE d=3D10;
> > > > > COMMIT;
> > > > > --
> > > > > -- some delay (e.g. 0.1s)
> > > > > --
> > > > > SELECT nextval('some_seq');  -- =3D> save a result to $some_seq
> > variable
> > > > >
> > > > > The question is: if subscriber's currval('some_seq') is greater
> > than
> > > > > $some_seq, could I be sure that the transaction #1 is also
> > processed and
> > > > > committed by this subscriber?
> > > >
> > > > How is this question different than #1?
> > > >
> > > > > 3. I have the following sequence in a SINGLE session (not
> > overlapped):
> > > > >
> > > > > BEGIN;
> > > > > UPDATE tbl SET c=3D10 WHERE d=3D10;
> > > > > COMMIT;
> > > > > --
> > > > > -- some delay (e.g. 0.1s)
> > > > > --
> > > > > SELECT max(sl_event.ev_seqno);  -- =3D> save a result to $seqno
> > variable
> > > > >
> > > > > The question is: if subscriber's max(sl_event.ev_seqno) is greater
> > than
> > > > > $seqno, could I be 100% sure that the transaction #1 is already
> > > > processed
> > > > > and committed by this subscriber?
> > > >
> > > > No.  That's not what that table does.  It simply replicates events
> > to
> > > > other
> > > > servers in the cluster, it doesn't guarantee that they've been
> > processed.
> > > > Have a look at sl_confirm.
> > > >
> > > > --
> > > > Bill Moran
> > > > Collaborative Fusion Inc.
> > > > http://people.collaborativefusion.com/~wmoran/<http://people.collab=
orativefusion.com/%7Ewmoran/>
> > > >
> > > > wmoran@collaborativefusion.com
> > > > Phone: 412-422-3463x4023
> > > > _______________________________________________
> > > > Slony1-general mailing list
> > > > Slony1-general@lists.slony.info
> > > > http://lists.slony.info/mailman/listinfo/slony1-general
> > > >
> > >
> > >
> > >
> > >
> > >
> > >
> > >
> >
> >
> > --
> > Bill Moran
> > Collaborative Fusion Inc.
> > http://people.collaborativefusion.com/~wmoran/
> > <http://people.collaborativefusion.com/%7Ewmoran/>
> >
> > wmoran@collaborativefusion.com
> > Phone: 412-422-3463x4023
> >
> > ****************************************************************
> > IMPORTANT: This message contains confidential information and is
> > intended only for the individual named. If the reader of this
> > message is not an intended recipient (or the individual
> > responsible for the delivery of this message to an intended
> > recipient), please be advised that any re-use, dissemination,
> > distribution or copying of this message is prohibited. Please
> > notify the sender immediately by e-mail if you have received
> > this e-mail by mistake and delete this e-mail from your system.
> > E-mail transmission cannot be guaranteed to be secure or
> > error-free as information could be intercepted, corrupted, lost,
> > destroyed, arrive late or incomplete, or contain viruses. The
> > sender therefore does not accept liability for any errors or
> > omissions in the contents of this message, which arise as a
> > result of e-mail transmission.
> > ****************************************************************
> >
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070813/=
abd369c8/attachment.htm
From dmitry at koterov.ru  Mon Aug 13 07:38:29 2007
From: dmitry at koterov.ru (Dmitry Koterov)
Date: Mon Aug 13 07:38:36 2007
Subject: [Slony1-general] The order of sequential and non-overlapped
	transactions
In-Reply-To: <d7df81620708130530r7e599529ge6df6dad0ccb3f64@mail.gmail.com>
References: <d7df81620708041242w3c56e46bk55ddee6cf4de2ebb@mail.gmail.com>
	<20070806093333.0adacf3a.wmoran@collaborativefusion.com>
	<d7df81620708070308o1dd70c5ekb48e88cdb2f75601@mail.gmail.com>
	<20070807080400.a04c2539.wmoran@collaborativefusion.com>
	<d7df81620708070521p7a040229paa83de26d92653bc@mail.gmail.com>
	<d7df81620708130530r7e599529ge6df6dad0ccb3f64@mail.gmail.com>
Message-ID: <d7df81620708130738o465c552enff16c35edf6a99ea@mail.gmail.com>

Seems my task could be completely solved if we change Slony's schema adding:

1. a new field sl_log_*.log_timestamp (set to now() by default)
2. a new field sl_event.ev_mintimestamp (the minimum timestamp of included
modifications or, if there are no modifications, a sync creation time)

So we could check if a subscriber has already processed an event generated
strictly after the specified master time.

Of course now I could check up-to-date status relative to a session using
minxid, but the disadvanture of minxid is that it is unpredictable: I have
to perform an additional DB query to fetch the last xid from an origin at
the end of a session and cannot deduce it (in contrary, timestamps could be
deduced approximately enough based on the query start time plus the query
execution time on a client).

On 8/13/07, Dmitry Koterov <dmitry@koterov.ru> wrote:
>
> Hmm.
> Seems sl_confirm is not usable in this case, because:
> 1. its timestamp field holds a SUBSCRIBER time, not the master time
> 2. slony source code shows that insertions in sl_event and sl_confirm are
> done in a single transaction, so, if something appeared in sl_confirm on a
> subscriber, it is also appeared in sl_event.
>
>
> On 8/7/07, Dmitry Koterov <dmitry@koterov.ru> wrote:
> >
> > Thanks for your answers!
> >
> > No, it is not for monitoring purpose, it is for optimal checking if all
> > of the session's transactions are processed by a subscriber or not yet.
> > (Insignificant false negatives are alowed here.) I do not need an
> > information about the whole node status, but - only about the status of=
 a
> > single session executed some time ago. If all transactions of this sess=
ion
> > were processed by a subscriber or not yet - here is the main question.
> >
> > I'm not sure I understand your question: sl_cofirm records times that
> > > Slony events are confirmed on each subscriber
> > > node.  As a result, a simple max(sl_confirm.con_seqno) doesn't really
> > > tell
> > > you anything rational.
> > >
> >
> > Oh, sorry! Of course, I meant the following question:
> >
> > -------------
> > BEGIN;
> > UPDATE tbl SET c=3D10 WHERE d=3D10;
> > COMMIT;
> > --
> > -- some delay (e.g. 0.1s)
> > --
> > SELECT max(sl_event.ev_seqno);  -- =3D> save a result to $seqno variable
> > FROM SL_EVENT!
> > The question is: if subscriber's max(sl_confirm.con_seqno) (check
> > SL_CONFIRM here!) is greater than $seqno, could I be 100% sure that the
> > transaction #1 is already processed and committed by this subscriber?
> > -------------
> >
> > So, we fetch & save the seqno from the origin sl_event, and compare it -
> > with confirmed items in sl_confirm on a subscriber.
> >
> >
> >
> > > I recommend watching that table for a while to see how things occur,
> > > you'll
> > > get a better idea of what's going on:
> > >
> > > select * from sl_confirm order by con_seqno desc, con_timestamp desc
> > > limit 10;
> > >
> > > I assume, from this question, that you're trying to come up with a way
> > > to monitor
> > > Slony.  A query like the following would help:
> > >
> > > SELECT (now() - max(con_timestamp)) < '15 sec'::interval AS
> > > nodes_synced
> > > FROM sl_confirm
> > > WHERE con_received =3D <node you want to monitor>;
> > >
> > > Which will return true if the node is within 15 seconds of being
> > > synced.  That
> > > would be good for general monitoring.
> > >
> > > If you need to be certain that individual transactions have made it,
> > > then you're
> > > probably using the wrong replication system.  Might I recommend
> > > 2-phase commit.
> > > Otherwise, you best bet is to connect to the slave and query the data
> > > to see if
> > > it looks the way you want it.
> > >
> > > The problem is that if other transactions are running, I don't know
> > > how you're
> > > going to reliably retrieve the Slony event ID that corresponds to your
> > > particular
> > > transaction.
> > >
> > > > On 8/6/07, Bill Moran < wmoran@collaborativefusion.com > wrote:
> > > > >
> > > > > In response to "Dmitry Koterov" <dmitry@koterov.ru>:
> > > > >
> > > > > > Hello.
> > > > > >
> > > > > > Could you please answer three questions about Slony's
> > > transaction
> > > > > > serialization? (I suppose that two first answers will be "yes",
> > > but I'd
> > > > > like
> > > > > > to hear the opinions of gurus.) Unfortunately I cannot find
> > > direct
> > > > > answers
> > > > > > in the Slony documentation.
> > > > > >
> > > > > > 1. I have the following non-overlapped sequence of transactions
> > > in a
> > > > > SINGLE
> > > > > > (!!!) session (connection) on an origin:
> > > > > >
> > > > > > BEGIN;
> > > > > > UPDATE tbl SET a=3D10 WHERE b=3D10;
> > > > > > COMMIT;
> > > > > > --
> > > > > > -- some little delay (e.g. 0.1s)
> > > > > > --
> > > > > > BEGIN;
> > > > > > UPDATE tbl SET a=3D20 WHERE b=3D20;
> > > > > > COMMIT;
> > > > > >
> > > > > > The question is: if a subscriber received and processed the
> > > result of
> > > > > the
> > > > > > transaction #2, could I be sure that it had also received and
> > > committed
> > > > > a
> > > > > > result of the transaction #1? Transactions are not overlapped.
> > > > >
> > > > > I'm unsure what you mean by "non-overlapped".  The whole point to
> > > a
> > > > > transaction
> > > > > is that it is an atomic operation, so, by design, transactions
> > > can't
> > > > > overlap,
> > > > > since they happen within a single atom of time.
> > > > >
> > > > > To answer your question, if you are sure that the transactions are
> > >
> > > > > committed
> > > > > on the master in a particular order, you can then be sure that
> > > those are
> > > > > committed on each of the slaves in the same order.  Otherwise,
> > > Slony
> > > > > wouldn't
> > > > > even work.
> > > > >
> > > > > > 2. I have the following sequence in a SINGLE session (also not
> > > > > overlapped):
> > > > > >
> > > > > > BEGIN;
> > > > > > UPDATE tbl SET c=3D10 WHERE d=3D10;
> > > > > > COMMIT;
> > > > > > --
> > > > > > -- some delay (e.g. 0.1s)
> > > > > > --
> > > > > > SELECT nextval('some_seq');  -- =3D> save a result to $some_seq
> > > variable
> > > > > >
> > > > > > The question is: if subscriber's currval('some_seq') is greater
> > > than
> > > > > > $some_seq, could I be sure that the transaction #1 is also
> > > processed and
> > > > > > committed by this subscriber?
> > > > >
> > > > > How is this question different than #1?
> > > > >
> > > > > > 3. I have the following sequence in a SINGLE session (not
> > > overlapped):
> > > > > >
> > > > > > BEGIN;
> > > > > > UPDATE tbl SET c=3D10 WHERE d=3D10;
> > > > > > COMMIT;
> > > > > > --
> > > > > > -- some delay (e.g. 0.1s)
> > > > > > --
> > > > > > SELECT max(sl_event.ev_seqno);  -- =3D> save a result to $seqno
> > > variable
> > > > > >
> > > > > > The question is: if subscriber's max(sl_event.ev_seqno) is
> > > greater than
> > > > > > $seqno, could I be 100% sure that the transaction #1 is already
> > > > > processed
> > > > > > and committed by this subscriber?
> > > > >
> > > > > No.  That's not what that table does.  It simply replicates events
> > > to
> > > > > other
> > > > > servers in the cluster, it doesn't guarantee that they've been
> > > processed.
> > > > > Have a look at sl_confirm.
> > > > >
> > > > > --
> > > > > Bill Moran
> > > > > Collaborative Fusion Inc.
> > > > > http://people.collaborativefusion.com/~wmoran/<http://people.coll=
aborativefusion.com/%7Ewmoran/>
> > > > >
> > > > > wmoran@collaborativefusion.com
> > > > > Phone: 412-422-3463x4023
> > > > > _______________________________________________
> > > > > Slony1-general mailing list
> > > > > Slony1-general@lists.slony.info
> > > > > http://lists.slony.info/mailman/listinfo/slony1-general
> > > > >
> > > >
> > > >
> > > >
> > > >
> > > >
> > > >
> > > >
> > >
> > >
> > > --
> > > Bill Moran
> > > Collaborative Fusion Inc.
> > > http://people.collaborativefusion.com/~wmoran/
> > > <http://people.collaborativefusion.com/%7Ewmoran/>
> > >
> > > wmoran@collaborativefusion.com
> > > Phone: 412-422-3463x4023
> > >
> > > ****************************************************************
> > > IMPORTANT: This message contains confidential information and is
> > > intended only for the individual named. If the reader of this
> > > message is not an intended recipient (or the individual
> > > responsible for the delivery of this message to an intended
> > > recipient), please be advised that any re-use, dissemination,
> > > distribution or copying of this message is prohibited. Please
> > > notify the sender immediately by e-mail if you have received
> > > this e-mail by mistake and delete this e-mail from your system.
> > > E-mail transmission cannot be guaranteed to be secure or
> > > error-free as information could be intercepted, corrupted, lost,
> > > destroyed, arrive late or incomplete, or contain viruses. The
> > > sender therefore does not accept liability for any errors or
> > > omissions in the contents of this message, which arise as a
> > > result of e-mail transmission.
> > > ****************************************************************
> > >
> >
> >
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070813/=
c4d8049e/attachment-0001.htm
From cbbrowne at ca.afilias.info  Mon Aug 13 08:03:01 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Mon Aug 13 08:03:13 2007
Subject: [Slony1-general] The order of sequential and
	non-overlapped	transactions
In-Reply-To: <d7df81620708130738o465c552enff16c35edf6a99ea@mail.gmail.com>
References: <d7df81620708041242w3c56e46bk55ddee6cf4de2ebb@mail.gmail.com>	<20070806093333.0adacf3a.wmoran@collaborativefusion.com>	<d7df81620708070308o1dd70c5ekb48e88cdb2f75601@mail.gmail.com>	<20070807080400.a04c2539.wmoran@collaborativefusion.com>	<d7df81620708070521p7a040229paa83de26d92653bc@mail.gmail.com>	<d7df81620708130530r7e599529ge6df6dad0ccb3f64@mail.gmail.com>
	<d7df81620708130738o465c552enff16c35edf6a99ea@mail.gmail.com>
Message-ID: <46C072A5.6020609@ca.afilias.info>

Dmitry Koterov wrote:
> Seems my task could be completely solved if we change Slony's schema 
> adding:
>
> 1. a new field sl_log_*.log_timestamp (set to now() by default)
Seems like a cost to outweigh the value of the result.  This adds a 
timestamp (and evaluation of time) to every tuple that is processed, 
which will make replication more expensive and slower, to the 
application, and for what?  So that once in a while the timestamp may be 
accessed?
> 2. a new field sl_event.ev_mintimestamp (the minimum timestamp of 
> included modifications or, if there are no modifications, a sync 
> creation time)
>
Insertions to sl_event take place, at present, as a simple insert. 

To add this timestamp would require running the query that identifies 
all sl_log_* entries that are associated with a given SYNC, and 
aggregate that to find the earliest value of sl_log_*.log_timestamp.

If the addition of sl_log_*.log_timestamp adds a *bit* of work, this 
change would add in an *enormous* amount of work; this would make a SYNC 
event, on the master, merely to identify the one timestamp, as expensive 
as adding an extra replication node.
> So we could check if a subscriber has already processed an event 
> generated strictly after the specified master time.
In principle, we could, at the cost of making replication *massively* 
more expensive.

It is not obvious that people will agree that this information is of 
such value that it warrants paying that price.
From dba at richyen.com  Mon Aug 13 09:40:43 2007
From: dba at richyen.com (Richard Yen)
Date: Mon Aug 13 09:40:53 2007
Subject: [Slony1-general] cannot drop tables from schema after dropping
	tables from replication
In-Reply-To: <60lkchts9a.fsf@dba2.int.libertyrms.com>
References: <E05DA5F5-E097-4651-85AB-F0F9828747E0@richyen.com>
	<60lkchts9a.fsf@dba2.int.libertyrms.com>
Message-ID: <C2AE4208-DFB6-40C9-A5A4-D643381607DA@richyen.com>

Sorry, I think we're not on the same page re. this issue.

> The *right* way to drop a table from replication is to first of all
> run the slonik "SET DROP TABLE" command against the table.
>
I have in fact run SET DROP TABLE on the table prior to attempting to  
drop the table from schema.  The table (new_gm_qm_set) doesn't show  
up in sl_table:

mydb=# select * from _myslony.sl_table where tab_relname =  
'new_gm_qm_set';
tab_id | tab_reloid | tab_relname | tab_nspname | tab_set |  
tab_idxname | tab_altered | tab_comment
--------+------------+-------------+-------------+--------- 
+-------------+-------------+-------------
(0 rows)

> When that is processed, on the origin, the "logtrigger" trigger gets
> removed.
> When that is processed, on subscribers, the "denyaccess" trigger gets
> removed, and the constraints get fixed up.
>
The logtrigger on the desired table for deletion (new_gm_qm_set ) is  
already gone:
mydb=# \d new_gm_qm_set;
                              Table "public.new_gm_qm_set"
      Column     |  Type   |                         Modifiers
----------------+--------- 
+------------------------------------------------------------
id             | integer | not null default nextval 
('new_gm_qm_set_id_seq'::regclass)
owner          | integer |
[blah blah blah...]
Indexes:
     "new_gm_qm_set_pkey" PRIMARY KEY, btree (id)
Foreign-key constraints:
     "new_gm_qm_set_owner_fkey" FOREIGN KEY ("owner") REFERENCES  
m_user(id)

However, when I go to delete my desired table (new_gm_qm_set), it  
complains about another table:
mydb=# begin; alter table new_gm_qm_set drop constraint  
new_gm_qm_set_owner_fkey;
BEGIN
ERROR:  "m_user_pkey" is an index



--Richard


From JanWieck at Yahoo.com  Mon Aug 13 11:42:51 2007
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Mon Aug 13 11:43:09 2007
Subject: [Slony1-general] Slony locking
In-Reply-To: <1186758254.5344.70.camel@ebony.site>
References: <1186758254.5344.70.camel@ebony.site>
Message-ID: <46C0A62B.3030107@Yahoo.com>

On 8/10/2007 11:04 AM, Simon Riggs wrote:
> Can I just check my understanding?
> 
> Slony single threads access to the log tables indirectly, by making the
> log triggers do a LOCK TABLE on sl_event in EXCLUSIVE mode.
> 
> So we don't actually do LOCK TABLE on sl_log in EXCLUSIVE mode, but that
> is the overall effect?

Where does the log trigger do that? It should not!

What does lock sl_event exclusively is the code that creates events, in 
order to guarantee that events commit in the ev_seqno order and nothing 
else.


Jan

-- 
#======================================================================#
# It's easier to get forgiveness for being wrong than for being right. #
# Let's break this rule - forgive me.                                  #
#================================================== JanWieck@Yahoo.com #
From andrew.george.hammond at gmail.com  Mon Aug 13 11:48:48 2007
From: andrew.george.hammond at gmail.com (Andrew Hammond)
Date: Mon Aug 13 11:48:57 2007
Subject: [Slony1-general] cannot drop tables from schema after dropping
	tables from replication
In-Reply-To: <C2AE4208-DFB6-40C9-A5A4-D643381607DA@richyen.com>
References: <E05DA5F5-E097-4651-85AB-F0F9828747E0@richyen.com>
	<60lkchts9a.fsf@dba2.int.libertyrms.com>
	<C2AE4208-DFB6-40C9-A5A4-D643381607DA@richyen.com>
Message-ID: <5a0a9d6f0708131148x7fbce8c8ibad61fcc0d78353@mail.gmail.com>

The table(s) you are trying to drop has a FK reference to a table which is
replicated. The replicated table on the subscriber has a trigger to
implement the foreign key, but as it is a subscriber, that trigger has been
disabled and the slony "don't touch" trigger is in place instead. When you
attempt to drop the table, the database tries to remove the FK trigger,
which fires the "don't touch" trigger causing everything to break.

There are two ways you can drop the unsubscribed table(s):
1) re-add the table on the origin and use a slonik execute ddl to drop it
everywhere.
2) muck around with internal slony functions.

If you _must_ do it the second way (although I can't imagine why you'd need
to, and you certainly don't want to) then please email back to the list for
more detailed instructions.

Andrew


On 8/13/07, Richard Yen <dba@richyen.com> wrote:
>
> Sorry, I think we're not on the same page re. this issue.
>
> > The *right* way to drop a table from replication is to first of all
> > run the slonik "SET DROP TABLE" command against the table.
> >
> I have in fact run SET DROP TABLE on the table prior to attempting to
> drop the table from schema.  The table (new_gm_qm_set) doesn't show
> up in sl_table:
>
> mydb=3D# select * from _myslony.sl_table where tab_relname =3D
> 'new_gm_qm_set';
> tab_id | tab_reloid | tab_relname | tab_nspname | tab_set |
> tab_idxname | tab_altered | tab_comment
> --------+------------+-------------+-------------+---------
> +-------------+-------------+-------------
> (0 rows)
>
> > When that is processed, on the origin, the "logtrigger" trigger gets
> > removed.
> > When that is processed, on subscribers, the "denyaccess" trigger gets
> > removed, and the constraints get fixed up.
> >
> The logtrigger on the desired table for deletion (new_gm_qm_set ) is
> already gone:
> mydb=3D# \d new_gm_qm_set;
>                               Table "public.new_gm_qm_set"
>       Column     |  Type   |                         Modifiers
> ----------------+---------
> +------------------------------------------------------------
> id             | integer | not null default nextval
> ('new_gm_qm_set_id_seq'::regclass)
> owner          | integer |
> [blah blah blah...]
> Indexes:
>      "new_gm_qm_set_pkey" PRIMARY KEY, btree (id)
> Foreign-key constraints:
>      "new_gm_qm_set_owner_fkey" FOREIGN KEY ("owner") REFERENCES
> m_user(id)
>
> However, when I go to delete my desired table (new_gm_qm_set), it
> complains about another table:
> mydb=3D# begin; alter table new_gm_qm_set drop constraint
> new_gm_qm_set_owner_fkey;
> BEGIN
> ERROR:  "m_user_pkey" is an index
>
>
>
> --Richard
>
>
> _______________________________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070813/=
7becd13b/attachment.htm
From dmitry at koterov.ru  Mon Aug 13 15:50:17 2007
From: dmitry at koterov.ru (Dmitry Koterov)
Date: Mon Aug 13 15:50:31 2007
Subject: [Slony1-general] The order of sequential and non-overlapped
	transactions
In-Reply-To: <46C072A5.6020609@ca.afilias.info>
References: <d7df81620708041242w3c56e46bk55ddee6cf4de2ebb@mail.gmail.com>
	<20070806093333.0adacf3a.wmoran@collaborativefusion.com>
	<d7df81620708070308o1dd70c5ekb48e88cdb2f75601@mail.gmail.com>
	<20070807080400.a04c2539.wmoran@collaborativefusion.com>
	<d7df81620708070521p7a040229paa83de26d92653bc@mail.gmail.com>
	<d7df81620708130530r7e599529ge6df6dad0ccb3f64@mail.gmail.com>
	<d7df81620708130738o465c552enff16c35edf6a99ea@mail.gmail.com>
	<46C072A5.6020609@ca.afilias.info>
Message-ID: <d7df81620708131550l393ca4d4t5428d94df30351b1@mail.gmail.com>

I agree that the cost is high.

But seems it's the only method to check a subscriber status relative to the
origin one after the concrete session (e.g. after a web-script finish). Only
with timestamps we could deduce and then - use for checking the time of a
transaction commit without an additional query.

Now I am trying to achieve the same result without Slony schema
modification, but with the cost of additional query at the end of a session
(it is "SELECT getcurrentxid()" query). Hope it will work fine. Possibly
this method is in general much better than the method with timestamps. Will
write soon.



On 8/13/07, Christopher Browne <cbbrowne@ca.afilias.info> wrote:
>
> Dmitry Koterov wrote:
> > Seems my task could be completely solved if we change Slony's schema
> > adding:
> >
> > 1. a new field sl_log_*.log_timestamp (set to now() by default)
> Seems like a cost to outweigh the value of the result.  This adds a
> timestamp (and evaluation of time) to every tuple that is processed,
> which will make replication more expensive and slower, to the
> application, and for what?  So that once in a while the timestamp may be
> accessed?
> > 2. a new field sl_event.ev_mintimestamp (the minimum timestamp of
> > included modifications or, if there are no modifications, a sync
> > creation time)
> >
> Insertions to sl_event take place, at present, as a simple insert.
>
> To add this timestamp would require running the query that identifies
> all sl_log_* entries that are associated with a given SYNC, and
> aggregate that to find the earliest value of sl_log_*.log_timestamp.
>
> If the addition of sl_log_*.log_timestamp adds a *bit* of work, this
> change would add in an *enormous* amount of work; this would make a SYNC
> event, on the master, merely to identify the one timestamp, as expensive
> as adding an extra replication node.
> > So we could check if a subscriber has already processed an event
> > generated strictly after the specified master time.
> In principle, we could, at the cost of making replication *massively*
> more expensive.
>
> It is not obvious that people will agree that this information is of
> such value that it warrants paying that price.
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070814/=
c5bb31ac/attachment.htm
From simon at 2ndquadrant.com  Mon Aug 13 23:34:52 2007
From: simon at 2ndquadrant.com (Simon Riggs)
Date: Mon Aug 13 23:34:02 2007
Subject: [Slony1-general] Slony locking
In-Reply-To: <46C0A62B.3030107@Yahoo.com>
References: <1186758254.5344.70.camel@ebony.site> <46C0A62B.3030107@Yahoo.com>
Message-ID: <1187073292.4169.7.camel@ebony.site>

On Mon, 2007-08-13 at 14:42 -0400, Jan Wieck wrote:
> On 8/10/2007 11:04 AM, Simon Riggs wrote:
> > Can I just check my understanding?
> > 
> > Slony single threads access to the log tables indirectly, by making the
> > log triggers do a LOCK TABLE on sl_event in EXCLUSIVE mode.
> > 
> > So we don't actually do LOCK TABLE on sl_log in EXCLUSIVE mode, but that
> > is the overall effect?
> 
> Where does the log trigger do that? It should not!
> 
> What does lock sl_event exclusively is the code that creates events, in 
> order to guarantee that events commit in the ev_seqno order and nothing 
> else.

OK, thanks.

-- 
  Simon Riggs
  EnterpriseDB  http://www.enterprisedb.com

From JanWieck at Yahoo.com  Tue Aug 14 08:05:43 2007
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Tue Aug 14 08:05:53 2007
Subject: [Slony1-general] cannot drop tables from schema after dropping
	tables from replication
In-Reply-To: <5a0a9d6f0708131148x7fbce8c8ibad61fcc0d78353@mail.gmail.com>
References: <E05DA5F5-E097-4651-85AB-F0F9828747E0@richyen.com>	<60lkchts9a.fsf@dba2.int.libertyrms.com>	<C2AE4208-DFB6-40C9-A5A4-D643381607DA@richyen.com>
	<5a0a9d6f0708131148x7fbce8c8ibad61fcc0d78353@mail.gmail.com>
Message-ID: <46C1C4C7.8070809@Yahoo.com>

On 8/13/2007 2:48 PM, Andrew Hammond wrote:
> The table(s) you are trying to drop has a FK reference to a table which 
> is replicated. The replicated table on the subscriber has a trigger to 
> implement the foreign key, but as it is a subscriber, that trigger has 
> been disabled and the slony "don't touch" trigger is in place instead. 
> When you attempt to drop the table, the database tries to remove the FK 
> trigger, which fires the "don't touch" trigger causing everything to break.

Not quite.

What causes this to fail is that the foreign key triggers on the 
referenced and still replicated table are "parked" by slony on its 
index. The DROP TABLE tries to remove those triggers from the PK table 
and fails due to this system catalog corruption.

You have to perform the DROP TABLE through EXECUTE SCRIPT. In this case 
you probably want to use the EXECUTE ONLY ON option.


Jan


> 
> There are two ways you can drop the unsubscribed table(s):
> 1) re-add the table on the origin and use a slonik execute ddl to drop 
> it everywhere.
> 2) muck around with internal slony functions.
> 
> If you _must_ do it the second way (although I can't imagine why you'd 
> need to, and you certainly don't want to) then please email back to the 
> list for more detailed instructions.
> 
> Andrew
> 
> 
> On 8/13/07, *Richard Yen* <dba@richyen.com <mailto:dba@richyen.com>> wrote:
> 
>     Sorry, I think we're not on the same page re. this issue.
> 
>      > The *right* way to drop a table from replication is to first of all
>      > run the slonik "SET DROP TABLE" command against the table.
>      >
>     I have in fact run SET DROP TABLE on the table prior to attempting to
>     drop the table from schema.  The table (new_gm_qm_set) doesn't show
>     up in sl_table:
> 
>     mydb=# select * from _myslony.sl_table where tab_relname =
>     'new_gm_qm_set';
>     tab_id | tab_reloid | tab_relname | tab_nspname | tab_set |
>     tab_idxname | tab_altered | tab_comment
>     --------+------------+-------------+-------------+---------
>     +-------------+-------------+-------------
>     (0 rows)
> 
>      > When that is processed, on the origin, the "logtrigger" trigger gets
>      > removed.
>      > When that is processed, on subscribers, the "denyaccess" trigger gets
>      > removed, and the constraints get fixed up.
>      >
>     The logtrigger on the desired table for deletion (new_gm_qm_set ) is
>     already gone:
>     mydb=# \d new_gm_qm_set;
>                                   Table "public.new_gm_qm_set"
>           Column     |  Type   |                         Modifiers
>     ----------------+---------
>     +------------------------------------------------------------
>     id             | integer | not null default nextval
>     ('new_gm_qm_set_id_seq'::regclass)
>     owner          | integer |
>     [blah blah blah...]
>     Indexes:
>          "new_gm_qm_set_pkey" PRIMARY KEY, btree (id)
>     Foreign-key constraints:
>          "new_gm_qm_set_owner_fkey" FOREIGN KEY ("owner") REFERENCES
>     m_user(id)
> 
>     However, when I go to delete my desired table (new_gm_qm_set), it
>     complains about another table:
>     mydb=# begin; alter table new_gm_qm_set drop constraint
>     new_gm_qm_set_owner_fkey;
>     BEGIN
>     ERROR:  "m_user_pkey" is an index
> 
> 
> 
>     --Richard
> 
> 
>     _______________________________________________
>     Slony1-general mailing list
>     Slony1-general@lists.slony.info <mailto:Slony1-general@lists.slony.info>
>     http://lists.slony.info/mailman/listinfo/slony1-general
> 
> 
> 
> ------------------------------------------------------------------------
> 
> _______________________________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


-- 
#======================================================================#
# It's easier to get forgiveness for being wrong than for being right. #
# Let's break this rule - forgive me.                                  #
#================================================== JanWieck@Yahoo.com #
From wmoran at collaborativefusion.com  Tue Aug 14 08:30:59 2007
From: wmoran at collaborativefusion.com (Bill Moran)
Date: Tue Aug 14 08:31:08 2007
Subject: [Slony1-general] The order of sequential and non-overlapped
	transactions
In-Reply-To: <d7df81620708131550l393ca4d4t5428d94df30351b1@mail.gmail.com>
References: <d7df81620708041242w3c56e46bk55ddee6cf4de2ebb@mail.gmail.com>
	<20070806093333.0adacf3a.wmoran@collaborativefusion.com>
	<d7df81620708070308o1dd70c5ekb48e88cdb2f75601@mail.gmail.com>
	<20070807080400.a04c2539.wmoran@collaborativefusion.com>
	<d7df81620708070521p7a040229paa83de26d92653bc@mail.gmail.com>
	<d7df81620708130530r7e599529ge6df6dad0ccb3f64@mail.gmail.com>
	<d7df81620708130738o465c552enff16c35edf6a99ea@mail.gmail.com>
	<46C072A5.6020609@ca.afilias.info>
	<d7df81620708131550l393ca4d4t5428d94df30351b1@mail.gmail.com>
Message-ID: <20070814113059.34305f5a.wmoran@collaborativefusion.com>

In response to "Dmitry Koterov" <dmitry@koterov.ru>:

> I agree that the cost is high.
> 
> But seems it's the only method to check a subscriber status relative to the
> origin one after the concrete session (e.g. after a web-script finish). Only
> with timestamps we could deduce and then - use for checking the time of a
> transaction commit without an additional query.

I'm going to repeat myself: maybe Slony isn't the right system for you.

I'm not aware of any of Slony's design goals involving user programs being
able to monitor which transactions have been replicated.  In fact, one of the
nice features of Slony is that it can tolerate communication failures between
nodes, and "catch up" when communication is restored.

It sounds to me that you have some requirement that the transaction be
guaranteed complete before moving to a subsequent step.  To me, that says
you should be using 2-phase commit, no Slony.  I'd be curious to hear your
justification for spending so much effort trying to make Slony do something
it was never intended to do when you have a system that _does_ what you need.

> Now I am trying to achieve the same result without Slony schema
> modification, but with the cost of additional query at the end of a session
> (it is "SELECT getcurrentxid()" query). Hope it will work fine. Possibly
> this method is in general much better than the method with timestamps. Will
> write soon.

In any event, I hope you find a solution that works.  I'm still completely
mystified as to why you're doing it.

> On 8/13/07, Christopher Browne <cbbrowne@ca.afilias.info> wrote:
> >
> > Dmitry Koterov wrote:
> > > Seems my task could be completely solved if we change Slony's schema
> > > adding:
> > >
> > > 1. a new field sl_log_*.log_timestamp (set to now() by default)
> > Seems like a cost to outweigh the value of the result.  This adds a
> > timestamp (and evaluation of time) to every tuple that is processed,
> > which will make replication more expensive and slower, to the
> > application, and for what?  So that once in a while the timestamp may be
> > accessed?
> > > 2. a new field sl_event.ev_mintimestamp (the minimum timestamp of
> > > included modifications or, if there are no modifications, a sync
> > > creation time)
> > >
> > Insertions to sl_event take place, at present, as a simple insert.
> >
> > To add this timestamp would require running the query that identifies
> > all sl_log_* entries that are associated with a given SYNC, and
> > aggregate that to find the earliest value of sl_log_*.log_timestamp.
> >
> > If the addition of sl_log_*.log_timestamp adds a *bit* of work, this
> > change would add in an *enormous* amount of work; this would make a SYNC
> > event, on the master, merely to identify the one timestamp, as expensive
> > as adding an extra replication node.
> > > So we could check if a subscriber has already processed an event
> > > generated strictly after the specified master time.
> > In principle, we could, at the cost of making replication *massively*
> > more expensive.
> >
> > It is not obvious that people will agree that this information is of
> > such value that it warrants paying that price.
> >
> 
> 
> 
> 
> 
> 
> 


-- 
Bill Moran
Collaborative Fusion Inc.
http://people.collaborativefusion.com/~wmoran/

wmoran@collaborativefusion.com
Phone: 412-422-3463x4023

****************************************************************
IMPORTANT: This message contains confidential information and is
intended only for the individual named. If the reader of this
message is not an intended recipient (or the individual
responsible for the delivery of this message to an intended
recipient), please be advised that any re-use, dissemination,
distribution or copying of this message is prohibited. Please
notify the sender immediately by e-mail if you have received
this e-mail by mistake and delete this e-mail from your system.
E-mail transmission cannot be guaranteed to be secure or
error-free as information could be intercepted, corrupted, lost,
destroyed, arrive late or incomplete, or contain viruses. The
sender therefore does not accept liability for any errors or
omissions in the contents of this message, which arise as a
result of e-mail transmission.
****************************************************************
From dmitry at koterov.ru  Tue Aug 14 14:05:38 2007
From: dmitry at koterov.ru (Dmitry Koterov)
Date: Tue Aug 14 14:05:51 2007
Subject: [Slony1-general] [GENERAL] Compound Indexes
In-Reply-To: <d7df81620708141405p42bce631h25dcddfa24094dc4@mail.gmail.com>
References: <e373d31e0708141235s79940657ha0d9fc120fffa49@mail.gmail.com>
	<d7df81620708141405p42bce631h25dcddfa24094dc4@mail.gmail.com>
Message-ID: <d7df81620708141405h4b94b1a4hc77dd5c0be57d434@mail.gmail.com>

1. Try it (EXPLAIN ANALYZE). If an index's first column is a column from
ORDER BY, and query planner sees that it is more efficient to scan a table
in the order specified by ORDER BY, Postgres will use that index. And if it
estimates that it is more efficient to filter rows first and then - sort
them, it uses another index. You have to use EXPLAIN ANALYZE on your real
data to see what index is most efficient (in my practice theoretical
predictions are not effective).

2. In Postgres you may create an index on a axpresseion, e.g. index on
substr(column_name, 0, 100). But, if you want to use this index, you have to
search using substr(column_name, 0, 100) =3D 'abcd', not by column_name =3D
'abcd'


On 8/14/07, Phoenix Kiula <phoenix.kiula@gmail.com> wrote:
>
> I have a table with ten columns. My queries basically one column as
> the first WHERE condition, so an index on that column is certain. But
> the columns after that one vary depending on end-user's choice (this
> is a reporting application) and so does the sorting order.
>
> In MySQL world, I had sort_buffer in the config file, and I made a
> compound index with the columns most often used in these types of
> queries. So my index looked like:
>
>   INDEX idx_trades(id, t_id, c_id, s_id,  t_brief, created_on);
>
> This has five columns in it. While reading the pgsql documentation, I
> gather than anything beyond three columns offers diminishing benefits.
>
> My queries will look like these:
>
>    SELECT * from trades where id =3D 99999
>    and c_id =3D 9999
>    ORDER by s_id;
>
>    SELECT * from trades where id =3D 99999
>    and s_id =3D 99990
>    ORDER by created_on desc ;
>
>    SELECT * from trades where id =3D 99999
>    and s_id =3D 99990
>    and t_brief ~* 'more|than|one|word'
>    ORDER by created_on desc ;
>
> So my question: how does PGSQL optimize its sorts? If I were to index
> merely the columns that are most commonly used in the reporting WHERE
> clause, would that be ok? Some ofthese columns may be "TEXT" type --
> how should I include these in the index (in MySQL, I included only the
> first 100 words in the index).
>
> TIA!
>
> ---------------------------(end of broadcast)---------------------------
> TIP 6: explain analyze is your friend
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070815/=
e96d7314/attachment.htm
From lists_slony1-general at avsupport.com  Wed Aug 15 13:52:48 2007
From: lists_slony1-general at avsupport.com (Dan Falconer)
Date: Wed Aug 15 13:53:10 2007
Subject: [Slony1-general] Determine how many items in log belong to an
	event...?
Message-ID: <200708151552.48987.lists_slony1-general@avsupport.com>

	I am in the process of rewriting our internal inventory processing script, 
which runs against slony-replicated databases, and I'm trying to come up with 
some solid statistics on what causes replication to fall so far behind.  I've 
Googled for answers and came up desperately short...

REQUIRED INFO:
	Slony-1, v1.2.10 (both servers)
	PostgreSQL v8.0.4 (both servers)
	OS: SLES 8.1

SERVER HARDWARE (both systems are identical):
	CPU: Dual Opteron 846
	RAM: 8Gigs
	HDD: 6FC 15k drives on external SAN
 
	Our inventory processor regularly handles ~4 million updates/inserts when it 
processes inventory files.  Generally, we can only run this process once a 
week, due to the time it takes for the slave server to catch up: it usually 
takes about 5 days.

	Today, I was looking through the log tables, and I was surprised at what I 
found: ~4.7M records in sl_log_1, and ~15M in in sl_log_2... I'm trying to 
determine how many records in those tables refer to individual transactions.  
I.e. I'm checking to see how many replication records are created by a single 
event, since each inventory processed runs in it's own transaction. 

	Any help or insight into this situation would be most helpful.
-- 
Best Regards,


Dan Falconer
"Head Geek", Avsupport, Inc. / Partslogistics.com
http://www.partslogistics.com
From drees76 at gmail.com  Wed Aug 15 14:33:18 2007
From: drees76 at gmail.com (David Rees)
Date: Wed Aug 15 14:33:29 2007
Subject: [Slony1-general] Determine how many items in log belong to an
	event...?
In-Reply-To: <200708151552.48987.lists_slony1-general@avsupport.com>
References: <200708151552.48987.lists_slony1-general@avsupport.com>
Message-ID: <72dbd3150708151433j2e51fd1chf8d551ff17c8a49e@mail.gmail.com>

On 8/15/07, Dan Falconer <lists_slony1-general@avsupport.com> wrote:
>
> REQUIRED INFO:
>         Slony-1, v1.2.10 (both servers)
>         PostgreSQL v8.0.4 (both servers)
>         OS: SLES 8.1

Why are you running such an old version of Pg? You should be running
8.0.13 at least...

>         Our inventory processor regularly handles ~4 million updates/inserts when it
> processes inventory files.  Generally, we can only run this process once a
> week, due to the time it takes for the slave server to catch up: it usually
> takes about 5 days.

When it's catching up, what does the load on the servers look like? Is
it CPU bound, IO bound, network bound, etc? Have a look at top and
vmstat on each machine to help determine this (and post the info as
well if you have any questions).

What settings are you running your slon daemons with? There are some
tweaks to be made to sync_group_maxsize which may help. Some
additional vacuuming of the sl_log tables may help, too. If you run
through the archives, this type of issue has come up before as well.

-Dave
From mpartio at gmail.com  Wed Aug 15 21:35:41 2007
From: mpartio at gmail.com (Mikko Partio)
Date: Wed Aug 15 21:35:57 2007
Subject: [Slony1-general] Re: log shipping gone wrong
In-Reply-To: <2ca799770708102144p4726a370l206e56ec664b1149@mail.gmail.com>
References: <2ca799770707200605j1bb37c13o98c86a21834db2ab@mail.gmail.com>
	<2ca799770707222327y5e5939bg6ccee843d0ef0097@mail.gmail.com>
	<46A4AE4F.4080304@Yahoo.com>
	<2ca799770707230728h3e3afa3auefdc1ae8dd429156@mail.gmail.com>
	<46A4C3E7.1020107@Yahoo.com>
	<2ca799770707232129p27822251v9947c748d2395630@mail.gmail.com>
	<46ACCF3A.9050005@Yahoo.com>
	<2ca799770708052339w73818564y4ab95181505dd349@mail.gmail.com>
	<46BC8E34.7060600@Yahoo.com>
	<2ca799770708102144p4726a370l206e56ec664b1149@mail.gmail.com>
Message-ID: <2ca799770708152135n398802een24f023c629e7305c@mail.gmail.com>

On 8/11/07, Mikko Partio <mpartio@gmail.com> wrote:
>
>
>
> On 8/10/07, Jan Wieck <JanWieck@yahoo.com> wrote:
> >
> > I found a couple more issues with archive logging so far. Specifically
> > some related to replicating sequences (seems like this could have never
> > worked).
> >
> > However, I have no clue why in your case the archive log writer thinks
> > that set 10 would be already on event 54, when it in fact is only on 52.
> > What event types are 52, 53 and 54?
>
>
>
> test3_lo=3D# select ev_seqno, ev_type from _test3.sl_event where ev_seqno=
 in
> (52, 53, 54);
>  ev_seqno |       ev_type
> ----------+---------------------
>        52 | SYNC
>        53 | SUBSCRIBE_SET
>        54 | ENABLE_SUBSCRIPTION
> (3 rows)
>
>
> Regards
>
> MP
>


Any progress on this problem, any more info you might need?

Regards

MP
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070816/=
a60355a4/attachment.htm
From lists_slony1-general at avsupport.com  Fri Aug 17 06:47:30 2007
From: lists_slony1-general at avsupport.com (Dan Falconer)
Date: Fri Aug 17 06:47:41 2007
Subject: [Slony1-general] Determine how many items in log belong to an
	event...?
In-Reply-To: <72dbd3150708151433j2e51fd1chf8d551ff17c8a49e@mail.gmail.com>
References: <200708151552.48987.lists_slony1-general@avsupport.com>
	<72dbd3150708151433j2e51fd1chf8d551ff17c8a49e@mail.gmail.com>
Message-ID: <200708170847.31218.lists_slony1-general@avsupport.com>

Replies in-line.

On Wednesday 15 August 2007 16:33, David Rees wrote:
> On 8/15/07, Dan Falconer <lists_slony1-general@avsupport.com> wrote:
> > REQUIRED INFO:
> >         Slony-1, v1.2.10 (both servers)
> >         PostgreSQL v8.0.4 (both servers)
> >         OS: SLES 8.1
>
> Why are you running such an old version of Pg? You should be running
> 8.0.13 at least...

Good point... I'm not a DBA, but I play one at my job.  ;) 

>
> >         Our inventory processor regularly handles ~4 million
> > updates/inserts when it processes inventory files.  Generally, we can
> > only run this process once a week, due to the time it takes for the slave
> > server to catch up: it usually takes about 5 days.
>
> When it's catching up, what does the load on the servers look like? Is
> it CPU bound, IO bound, network bound, etc? Have a look at top and
> vmstat on each machine to help determine this (and post the info as
> well if you have any questions).

The master server has a very worrisome load, running between 5-20.  I took a 
snapshot of it:
	load average: 13.18, 7.23, 4.33
There's also a fetch that's been running for a very long time (there was a 
poorly timed vacuum of the whole database that took 2 days while this was 
running; this has been formatted for your screen)::::

USER=postgres
PR=25
NI=0
VIRT=109m
RES=109m
SHR=106m
S=R
%CPU=87.1
%MEM=1.5
TIME+=722:47.39
COMMAND=postgres: postgres pl ::ffff:192.168.1.200(43262) FETCH


The slave server, however, is running at very little load (around 1).

VMSTAT FOR MASTER SERVER (sorry for the poor formatting):::

procs -----------memory---------- ---swap-- -----io---- --system-- ----cpu----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in    cs us sy id wa
 4  1  62100  28880  94372 6953044    0    0     9    36    1     1 21 10 68  
0
 3  0  62100  31592  94384 6953124    0    0    48   100  271  1765 55  3 42  
0
 5  1  62100  28392  94516 6954308    0    0   844   992  722 11378 57 12 31  
0
 2  0  62100  29072  94624 6954984    0    0   712   528  326   724 50  1 49  
0
 3  1  62100  18376  94724 6951928    0    0   872   552  663  3291 56 10 34  
0
 1  2  62100  16584  94752 6942792    0    0  1324   584  651  2507 69  5 26  
0
 1  1  62100  26716  94800 6943372    0    0   612    64  344  1256 54  2 44  
0
 2  1  62100  25916  94828 6944460    0    0   876   488  416   990 54  0 45  
0
 1  1  62100  23980  94896 6945004    0    0   472   444  391 10439 52  7 40  
0
 1  0  62100  35436  94908 6945404    0    0   360   300  603  1897 53  6 41  
0
 2  0  62100  37792  94912 6945480    0    0    28   116  237   843 52  1 46  
0
 1  0  62100  37972  94916 6945480    0    0     0    44  157   529 50  0 50  
0
 1  1  62100  35512  94936 6945752    0    0   216   168  245   921 51  4 45  
0

>
> What settings are you running your slon daemons with? There are some
> tweaks to be made to sync_group_maxsize which may help. Some
> additional vacuuming of the sl_log tables may help, too. If you run
> through the archives, this type of issue has come up before as well.
>
> -Dave


The slons aren't run with any special settings.  They're started using 
the "slon_start" bash script included with Slony (some items removed to 
protect the innocent):::

/usr/local/pgsql/bin/slon -s 5000 -d2 replication host=******* dbname=pl 
user=postgres port=5432

In the meantime, I believe I'm going to stop the slon daemons, vacuum their 
tables, and then try restarting them.  Any help for optimization on the slons 
would be cool; I hadn't even thought about trying that before posting to the 
list.

-- 
Best Regards,


Dan Falconer
"Head Geek", Avsupport, Inc. / Partslogistics.com
http://www.partslogistics.com
From wesley.bonini at gmail.com  Fri Aug 17 13:10:18 2007
From: wesley.bonini at gmail.com (Wesley Bonini)
Date: Fri Aug 17 13:10:28 2007
Subject: [Slony1-general] Error 1057 registering slon service in W2003Server
Message-ID: <c6dd49a70708171310y6613b5b0r242e056127649115@mail.gmail.com>

Hello,

I?m trying to register the slon service, but the system returns the message:

Failed to create service: 1057.

Nothing is writed in Event Log.

The user is administrator and have the "Logon as a service" and "Logon
localy" privilegies.

Can anyone help me?

Thank?s for all and best regards.

Wesley
From z-saito at guitar.ocn.ne.jp  Sat Aug 18 13:04:24 2007
From: z-saito at guitar.ocn.ne.jp (Hiroshi Saito)
Date: Sat Aug 18 13:04:34 2007
Subject: [Slony1-general] Error 1057 registering slon service in
	W2003Server
References: <c6dd49a70708171310y6613b5b0r242e056127649115@mail.gmail.com>
Message-ID: <01b401c7e1d2$f9c3f7e0$0c01a8c0@yourc3ftrhkaod>

Hi.

Umm, It is very strange....
Error number is
#define ERROR_INVALID_SERVICE_ACCOUNT  1057
The specified user account name does not exist.

Please give detailed information.

Regards,
Hiroshi Saito

----- Original Message ----- 
From: "Wesley Bonini" <wesley.bonini@gmail.com>


> Hello,
>
> I?m trying to register the slon service, but the system returns the message:
>
> Failed to create service: 1057.>
> Nothing is writed in Event Log.
>
> The user is administrator and have the "Logon as a service" and "Logon
> localy" privilegies.
>
> Can anyone help me?
>
> Thank?s for all and best regards.
>
> Wesley 

From szoradi at t-email.hu  Sat Aug 18 13:27:11 2007
From: szoradi at t-email.hu (=?ISO-8859-1?Q?Sz=F3r=E1di_Ervin?=)
Date: Sat Aug 18 13:28:22 2007
Subject: [Slony1-general] Re: Slony1-general Digest, Vol 6, Issue 22
In-Reply-To: <20070818190003.E393C290BDE@main.slony.info>
References: <20070818190003.E393C290BDE@main.slony.info>
Message-ID: <46C7561F.7060303@t-email.hu>


Hello,

The next link contain a complet example.

http://inet.winpg.jp/~saito/Slony-I-sample/

running slon
--
pgsql\bin>slon -regservice Slony-I

pgsql\bin>slon -addengine Slony-I master.conf

pgsql\bin>slon -addengine Slony-I slave.conf

pgsql\bin>slon -listengines Slony-I

--Note:Please begin service

Ervin

>
> Hello,
>
> I?m trying to register the slon service, but the system returns the message:
>
> Failed to create service: 1057.
>
> Nothing is writed in Event Log.
>
> The user is administrator and have the "Logon as a service" and "Logon
> localy" privilegies.
>
> Can anyone help me?
>
> Thank?s for all and best regards.
>
> Wesley
>
>
> ------------------------------
>
> _______________________________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
>
>
> End of Slony1-general Digest, Vol 6, Issue 22
> *********************************************
>
>   

From wesley.bonini at gmail.com  Sat Aug 18 14:04:44 2007
From: wesley.bonini at gmail.com (Wesley Bonini)
Date: Sat Aug 18 14:04:54 2007
Subject: [Slony1-general] Error 1057 registering slon service in
	W2003Server
In-Reply-To: <01b401c7e1d2$f9c3f7e0$0c01a8c0@yourc3ftrhkaod>
References: <c6dd49a70708171310y6613b5b0r242e056127649115@mail.gmail.com>
	<01b401c7e1d2$f9c3f7e0$0c01a8c0@yourc3ftrhkaod>
Message-ID: <c6dd49a70708181404g43fa6437ke20b46b6f5519751@mail.gmail.com>

Hi Hiroshi,

No, the error number is 1057, but the message is "Failed to create service".

I?m running a Win2003 without AD, logged as Administrator and with
"Logon as a service" privilege.

Wesley


2007/8/18, Hiroshi Saito <z-saito@guitar.ocn.ne.jp>:
> Hi.
>
> Umm, It is very strange....
> Error number is
> #define ERROR_INVALID_SERVICE_ACCOUNT  1057
> The specified user account name does not exist.
>
> Please give detailed information.
>
> Regards,
> Hiroshi Saito
>
> ----- Original Message -----
> From: "Wesley Bonini" <wesley.bonini@gmail.com>
>
>
> > Hello,
> >
> > I?m trying to register the slon service, but the system returns the message:
> >
> > Failed to create service: 1057.>
> > Nothing is writed in Event Log.
> >
> > The user is administrator and have the "Logon as a service" and "Logon
> > localy" privilegies.
> >
> > Can anyone help me?
> >
> > Thank?s for all and best regards.
> >
> > Wesley
>
>
From szoradi at t-email.hu  Sun Aug 19 12:47:23 2007
From: szoradi at t-email.hu (=?ISO-8859-1?Q?Sz=F3r=E1di_Ervin?=)
Date: Sun Aug 19 12:47:36 2007
Subject: [Slony1-general] Re: Slony1-general Digest, Vol 6, Issue 23
In-Reply-To: <20070819190004.68E62290C10@main.slony.info>
References: <20070819190004.68E62290C10@main.slony.info>
Message-ID: <46C89E4B.9020709@t-email.hu>

Hi,

Google->

1. To correct this problem, grant the user ID the proper authorization 
and advanced user rights.

2. Incorrect user name or password.

Regards,

Ervin Szoradi

slony1-general-request@lists.slony.info ?rta:
> Send Slony1-general mailing list submissions to
> 	slony1-general@lists.slony.info
>
> To subscribe or unsubscribe via the World Wide Web, visit
> 	http://lists.slony.info/mailman/listinfo/slony1-general
> or, via email, send a message with subject or body 'help' to
> 	slony1-general-request@lists.slony.info
>
> You can reach the person managing the list at
> 	slony1-general-owner@lists.slony.info
>
> When replying, please edit your Subject line so it is more specific
> than "Re: Contents of Slony1-general digest..."
>
>
> Today's Topics:
>
>    1. Re: Error 1057 registering slon service in	W2003Server
>       (Hiroshi Saito)
>    2. Re: Slony1-general Digest, Vol 6, Issue 22 (Sz?r?di Ervin)
>    3. Re: Error 1057 registering slon service in	W2003Server
>       (Wesley Bonini)
>
>
> ----------------------------------------------------------------------
>
> Message: 1
> Date: Sun, 19 Aug 2007 05:04:24 +0900
> From: "Hiroshi Saito" <z-saito@guitar.ocn.ne.jp>
> Subject: Re: [Slony1-general] Error 1057 registering slon service in
> 	W2003Server
> To: "Wesley Bonini" <wesley.bonini@gmail.com>,
> 	<slony1-general@lists.slony.info>
> Message-ID: <01b401c7e1d2$f9c3f7e0$0c01a8c0@yourc3ftrhkaod>
> Content-Type: text/plain; format=flowed; charset="iso-8859-1";
> 	reply-type=original
>
> Hi.
>
> Umm, It is very strange....
> Error number is
> #define ERROR_INVALID_SERVICE_ACCOUNT  1057
> The specified user account name does not exist.
>
> Please give detailed information.
>
> Regards,
> Hiroshi Saito
>
> ----- Original Message ----- 
> From: "Wesley Bonini" <wesley.bonini@gmail.com>
>
>
>   
>> Hello,
>>
>> I?m trying to register the slon service, but the system returns the message:
>>
>> Failed to create service: 1057.>
>> Nothing is writed in Event Log.
>>
>> The user is administrator and have the "Logon as a service" and "Logon
>> localy" privilegies.
>>
>> Can anyone help me?
>>
>> Thank?s for all and best regards.
>>
>> Wesley 
>>     
>
>
>
> ------------------------------
>
> Message: 2
> Date: Sat, 18 Aug 2007 22:27:11 +0200
> From: Sz?r?di Ervin <szoradi@t-email.hu>
> Subject: [Slony1-general] Re: Slony1-general Digest, Vol 6, Issue 22
> To: slony1-general@lists.slony.info
> Message-ID: <46C7561F.7060303@t-email.hu>
> Content-Type: text/plain; charset=ISO-8859-1; format=flowed
>
>
> Hello,
>
> The next link contain a complet example.
>
> http://inet.winpg.jp/~saito/Slony-I-sample/
>
> running slon
> --
> pgsql\bin>slon -regservice Slony-I
>
> pgsql\bin>slon -addengine Slony-I master.conf
>
> pgsql\bin>slon -addengine Slony-I slave.conf
>
> pgsql\bin>slon -listengines Slony-I
>
> --Note:Please begin service
>
> Ervin
>
>   
>> Hello,
>>
>> I?m trying to register the slon service, but the system returns the message:
>>
>> Failed to create service: 1057.
>>
>> Nothing is writed in Event Log.
>>
>> The user is administrator and have the "Logon as a service" and "Logon
>> localy" privilegies.
>>
>> Can anyone help me?
>>
>> Thank?s for all and best regards.
>>
>> Wesley
>>
>>
>> ------------------------------
>>
>> _______________________________________________
>> Slony1-general mailing list
>> Slony1-general@lists.slony.info
>> http://lists.slony.info/mailman/listinfo/slony1-general
>>
>>
>> End of Slony1-general Digest, Vol 6, Issue 22
>> *********************************************
>>
>>   
>>     
>
>
>
> ------------------------------
>
> Message: 3
> Date: Sat, 18 Aug 2007 18:04:44 -0300
> From: "Wesley Bonini" <wesley.bonini@gmail.com>
> Subject: Re: [Slony1-general] Error 1057 registering slon service in
> 	W2003Server
> To: "Hiroshi Saito" <z-saito@guitar.ocn.ne.jp>
> Cc: slony1-general@lists.slony.info
> Message-ID:
> 	<c6dd49a70708181404g43fa6437ke20b46b6f5519751@mail.gmail.com>
> Content-Type: text/plain; charset=ISO-8859-1
>
> Hi Hiroshi,
>
> No, the error number is 1057, but the message is "Failed to create service".
>
> I?m running a Win2003 without AD, logged as Administrator and with
> "Logon as a service" privilege.
>
> Wesley
>
>
> 2007/8/18, Hiroshi Saito <z-saito@guitar.ocn.ne.jp>:
>   
>> Hi.
>>
>> Umm, It is very strange....
>> Error number is
>> #define ERROR_INVALID_SERVICE_ACCOUNT  1057
>> The specified user account name does not exist.
>>
>> Please give detailed information.
>>
>> Regards,
>> Hiroshi Saito
>>
>> ----- Original Message -----
>> From: "Wesley Bonini" <wesley.bonini@gmail.com>
>>
>>
>>     
>>> Hello,
>>>
>>> I?m trying to register the slon service, but the system returns the message:
>>>
>>> Failed to create service: 1057.>
>>> Nothing is writed in Event Log.
>>>
>>> The user is administrator and have the "Logon as a service" and "Logon
>>> localy" privilegies.
>>>
>>> Can anyone help me?
>>>
>>> Thank?s for all and best regards.
>>>
>>> Wesley
>>>       
>>     
>
>
> ------------------------------
>
> _______________________________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
>
>
> End of Slony1-general Digest, Vol 6, Issue 23
> *********************************************
>
>   

From ajs at crankycanuck.ca  Mon Aug 20 08:49:39 2007
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Mon Aug 20 08:49:58 2007
Subject: [Slony1-general] The order of sequential and non-overlapped
	transactions
In-Reply-To: <20070814113059.34305f5a.wmoran@collaborativefusion.com>
References: <d7df81620708041242w3c56e46bk55ddee6cf4de2ebb@mail.gmail.com>
	<20070806093333.0adacf3a.wmoran@collaborativefusion.com>
	<d7df81620708070308o1dd70c5ekb48e88cdb2f75601@mail.gmail.com>
	<20070807080400.a04c2539.wmoran@collaborativefusion.com>
	<d7df81620708070521p7a040229paa83de26d92653bc@mail.gmail.com>
	<d7df81620708130530r7e599529ge6df6dad0ccb3f64@mail.gmail.com>
	<d7df81620708130738o465c552enff16c35edf6a99ea@mail.gmail.com>
	<46C072A5.6020609@ca.afilias.info>
	<d7df81620708131550l393ca4d4t5428d94df30351b1@mail.gmail.com>
	<20070814113059.34305f5a.wmoran@collaborativefusion.com>
Message-ID: <20070820154939.GC4005@phlogiston.dyndns.org>

On Tue, Aug 14, 2007 at 11:30:59AM -0400, Bill Moran wrote:
> It sounds to me that you have some requirement that the transaction be
> guaranteed complete before moving to a subsequent step.  To me, that says
> you should be using 2-phase commit, no Slony.  I'd be curious to hear your
> justification for spending so much effort trying to make Slony do something
> it was never intended to do when you have a system that _does_ what you need.

Also, I'm not convinced that the proposed alteration will achieve
what is desired: it looks to me like there are visibility issues with
the proposal.  I haven't the foggiest idea whether they'd affect its
usability, though: I haven't worked it through, on the grounds that
(as Chris already pointed out) this is an unacceptable overhead to
get a poorly-conceived feature that depends on assumptions we ought
not to be willing to make.

A

-- 
Andrew Sullivan  | ajs@crankycanuck.ca
The very definition of "news" is "something that hardly ever happens."	
		--Bruce Schneier
From cbbrowne at ca.afilias.info  Mon Aug 20 15:44:31 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Mon Aug 20 15:44:44 2007
Subject: [Slony1-general] Log shipping fix in place
Message-ID: <60wsvpvnao.fsf@dba2.int.libertyrms.com>

Jan committed a change this morning, which I revised a little further,
which substantially revises the logshipping logic so as to more
correctly coordinate SYNC numbers on subscribers with the provider.

I have run it through tests on 8.3 with success (after my 'revised a
little further' :-)).

I'll be running it through other versions tomorrow and see if I can
have a tarball of pre-1.2.11 tomorrow for Mikko to try again.

Quick precis: Jan was having trouble figuring out where the SYNC
numbers were getting discoordinated, so he dropped them out of
in-memory variables and took an entirely different approach, having
those numbers track via a new Slony-I schema table,
sl_archive_counter.  (Seems good to me; I was always suspicious of
managing that purely in memory; that seemed a flakey way to do it...)
-- 
output = reverse("ofni.secnanifxunil" "@" "enworbbc")
http://linuxdatabases.info/info/finances.html
"A 'Cape Cod Salsa' just isn't right." -- Unknown
From mpartio at gmail.com  Mon Aug 20 20:48:43 2007
From: mpartio at gmail.com (Mikko Partio)
Date: Mon Aug 20 20:49:31 2007
Subject: [Slony1-general] Log shipping fix in place
In-Reply-To: <60wsvpvnao.fsf@dba2.int.libertyrms.com>
References: <60wsvpvnao.fsf@dba2.int.libertyrms.com>
Message-ID: <2ca799770708202048y32f766d4o1a146ea1c2e62217@mail.gmail.com>

On 8/21/07, Christopher Browne <cbbrowne@ca.afilias.info> wrote:
>
> Jan committed a change this morning, which I revised a little further,
> which substantially revises the logshipping logic so as to more
> correctly coordinate SYNC numbers on subscribers with the provider.
>
> I have run it through tests on 8.3 with success (after my 'revised a
> little further' :-)).
>
> I'll be running it through other versions tomorrow and see if I can
> have a tarball of pre-1.2.11 tomorrow for Mikko to try again.
>
> Quick precis: Jan was having trouble figuring out where the SYNC
> numbers were getting discoordinated, so he dropped them out of
> in-memory variables and took an entirely different approach, having
> those numbers track via a new Slony-I schema table,
> sl_archive_counter.  (Seems good to me; I was always suspicious of
> managing that purely in memory; that seemed a flakey way to do it...)
> --



Excellent news, I'll be waiting for that tarball!

Regards

Mikko
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070821/=
16e1114c/attachment.htm
From by_pacitan at yahoo.com  Mon Aug 20 23:48:52 2007
From: by_pacitan at yahoo.com (angga erwina)
Date: Mon Aug 20 23:49:11 2007
Subject: [Slony1-general] error connection
Message-ID: <659908.35410.qm@web56603.mail.re3.yahoo.com>

hi,
i've run slon process,then rise error messages like this..whats wrong with my setup connection..help me please...
thanks,
regards,
bayu


[postgres@laptopbps ~]$ /usr/local/pgsql/bin/slon sdki "dbname=sdki user=postgres port=5432 host=laptopbps"
2007-08-20 15:53:35 UTC CONFIG main: slon version 1.2.9 starting up
2007-08-20 15:53:35 UTC DEBUG2 slon: watchdog process started
2007-08-20 15:53:35 UTC DEBUG2 slon: watchdog ready - pid = 4496
2007-08-20 15:53:35 UTC DEBUG2 slon: worker process created - pid = 4497
2007-08-20 15:53:35 UTC CONFIG main: local node id = 1
2007-08-20 15:53:35 UTC DEBUG2 main: main process started
2007-08-20 15:53:35 UTC CONFIG main: launching sched_start_mainloop
2007-08-20 15:53:35 UTC CONFIG main: loading current cluster configuration
2007-08-20 15:53:35 UTC CONFIG storeNode: no_id=2 no_comment='gb 8.0 5432'
2007-08-20 15:53:35 UTC DEBUG2 setNodeLastEvent: no_id=2 event_seq=498
2007-08-20 15:53:35 UTC CONFIG storeNode: no_id=3 no_comment='gb_replica 8.0 5430'
2007-08-20 15:53:35 UTC DEBUG2 setNodeLastEvent: no_id=3 event_seq=2
2007-08-20 15:53:35 UTC CONFIG storePath: pa_server=2 pa_client=1 pa_conninfo="dbname=sdki host=pchome port=5432 user=postgres" pa_connretry=10
2007-08-20 15:53:35 UTC CONFIG storePath: pa_server=3 pa_client=1 pa_conninfo="dbname=sdki2 host=localhost port=5432 user=postgres" pa_connretry=10
2007-08-20 15:53:35 UTC CONFIG storeListen: li_origin=2 li_receiver=1 li_provider=2
2007-08-20 15:53:35 UTC CONFIG storeListen: li_origin=3 li_receiver=1 li_provider=3
2007-08-20 15:53:35 UTC CONFIG storeSet: set_id=1 set_origin=1 set_comment='gb tables'
2007-08-20 15:53:35 UTC DEBUG2 sched_wakeup_node(): no_id=1 (0 threads + worker signaled)
2007-08-20 15:53:35 UTC DEBUG2 main: last local event sequence = 669
2007-08-20 15:53:35 UTC CONFIG main: configuration complete - starting threads
2007-08-20 15:53:35 UTC DEBUG1 localListenThread: thread starts
2007-08-20 15:53:35 UTC DEBUG4 version for "dbname=sdki user=postgres port=5432 host=laptopbps" is 80204
2007-08-20 15:53:35 UTC FATAL  localListenThread: "select "_sdki".cleanupNodelock(); insert into "_sdki".sl_nodelock values (    1, 0, "pg_catalog".pg_backend_pid()); " - ERROR:  duplicate key violates unique constraint "sl_nodelock-pkey"
2007-08-20 15:53:35 UTC FATAL  Do you already have a slon running against this node?
2007-08-20 15:53:35 UTC FATAL  Or perhaps a residual idle backend connection from a dead slon?
2007-08-20 15:53:35 UTC DEBUG2 slon_abort() from pid=4497
2007-08-20 15:53:35 UTC DEBUG1 slon: shutdown requested
2007-08-20 15:53:35 UTC DEBUG2 slon: notify worker process to shutdown
2007-08-20 15:53:55 UTC DEBUG1 slon: child termination timeout - kill child
2007-08-20 15:53:55 UTC DEBUG2 slon: child terminated status: 9; pid: 4497, current worker pid: 4497
2007-08-20 15:53:55 UTC DEBUG1 slon: done
2007-08-20 15:53:55 UTC DEBUG2 slon: exit(0)


       
---------------------------------
Sick sense of humor? Visit Yahoo! TV's Comedy with an Edge to see what's on, when. 
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070820/70fc012f/attachment.htm
From mpartio at gmail.com  Tue Aug 21 06:23:04 2007
From: mpartio at gmail.com (Mikko Partio)
Date: Tue Aug 21 06:23:08 2007
Subject: [Slony1-general] error connection
In-Reply-To: <659908.35410.qm@web56603.mail.re3.yahoo.com>
References: <659908.35410.qm@web56603.mail.re3.yahoo.com>
Message-ID: <2ca799770708210623s29ade4efheaa69126989970d5@mail.gmail.com>

On 8/21/07, angga erwina <by_pacitan@yahoo.com> wrote:
>
> hi,
> i've run slon process,then rise error messages like this..whats wrong with
> my setup connection..help me please...
> thanks,
> regards,
> bayu
>
>
> [postgres@laptopbps ~]$ /usr/local/pgsql/bin/slon sdki "dbname=3Dsdki
> user=3Dpostgres port=3D5432 host=3Dlaptopbps"
> 2007-08-20 15:53:35 UTC CONFIG main: slon version 1.2.9 starting up
> 2007-08-20 15:53:35 UTC DEBUG2 slon: watchdog process started
> 2007-08-20 15:53:35 UTC DEBUG2 slon: watchdog ready - pid =3D 4496
> 2007-08-20 15:53:35 UTC DEBUG2 slon: worker process created - pid =3D 4497
> 2007-08-20 15:53:35 UTC CONFIG main: local node id =3D 1
> 2007-08-20 15:53:35 UTC DEBUG2 main: main process started
> 2007-08-20 15:53:35 UTC CONFIG main: launching sched_start_mainloop
> 2007-08-20 15:53:35 UTC CONFIG main: loading current cluster configuration
> 2007-08-20 15:53:35 UTC CONFIG storeNode: no_id=3D2 no_comment=3D'gb 8.0 =
5432'
> 2007-08-20 15:53:35 UTC DEBUG2 setNodeLastEvent: no_id=3D2 event_seq=3D498
> 2007-08-20 15:53:35 UTC CONFIG storeNode: no_id=3D3 no_comment=3D'gb_repl=
ica
> 8.0 5430'
> 2007-08-20 15:53:35 UTC DEBUG2 setNodeLastEvent: no_id=3D3 event_seq=3D2
> 2007-08-20 15:53:35 UTC CONFIG storePath: pa_server=3D2 pa_client=3D1
> pa_conninfo=3D"dbname=3Dsdki host=3Dpchome port=3D5432 user=3Dpostgres"
> pa_connretry=3D10
> 2007-08-20 15:53:35 UTC CONFIG storePath: pa_server=3D3 pa_client=3D1
> pa_conninfo=3D"dbname=3Dsdki2 host=3Dlocalhost port=3D5432 user=3Dpostgre=
s"
> pa_connretry=3D10
> 2007-08-20 15:53:35 UTC CONFIG storeListen: li_origin=3D2 li_receiver=3D1
> li_provider=3D2
> 2007-08-20 15:53:35 UTC CONFIG storeListen: li_origin=3D3 li_receiver=3D1
> li_provider=3D3
> 2007-08-20 15:53:35 UTC CONFIG storeSet: set_id=3D1 set_origin=3D1
> set_comment=3D'gb tables'
> 2007-08-20 15:53:35 UTC DEBUG2 sched_wakeup_node(): no_id=3D1 (0 threads +
> worker signaled)
> 2007-08-20 15:53:35 UTC DEBUG2 main: last local event sequence =3D 669
> 2007-08-20 15:53:35 UTC CONFIG main: configuration complete - starting
> threads
> 2007-08-20 15:53:35 UTC DEBUG1 localListenThread: thread starts
> 2007-08-20 15:53:35 UTC DEBUG4 version for "dbname=3Dsdki user=3Dpostgres
> port=3D5432 host=3Dlaptopbps" is 80204
> 2007-08-20 15:53:35 UTC FATAL  localListenThread: "select
> "_sdki".cleanupNodelock(); insert into "_sdki".sl_nodelock values (    1,=
 0,
> "pg_catalog".pg_backend_pid()); " - ERROR:  duplicate key violates unique
> constraint "sl_nodelock-pkey"
> 2007-08-20 15:53:35 UTC FATAL  Do you already have a slon running against
> this node?
> 2007-08-20 15:53:35 UTC FATAL  Or perhaps a residual idle backend
> connection from a dead slon?
> 2007-08-20 15:53:35 UTC DEBUG2 slon_abort() from pid=3D4497
> 2007-08-20 15:53:35 UTC DEBUG1 slon: shutdown requested
> 2007-08-20 15:53:35 UTC DEBUG2 slon: notify worker process to shutdown
> 2007-08-20 15:53:55 UTC DEBUG1 slon: child termination timeout - kill
> child
> 2007-08-20 15:53:55 UTC DEBUG2 slon: child terminated status: 9; pid:
> 4497, current worker pid: 4497
> 2007-08-20 15:53:55 UTC DEBUG1 slon: done
> 2007-08-20 15:53:55 UTC DEBUG2 slon: exit(0)



You have another slon process running. Kill that before you start a new one.

Regards

Mikko
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070821/=
b554803f/attachment.htm
From cbbrowne at ca.afilias.info  Tue Aug 21 06:48:33 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Tue Aug 21 06:48:40 2007
Subject: [Slony1-general] error connection
In-Reply-To: <659908.35410.qm@web56603.mail.re3.yahoo.com> (angga erwina's
	message of "Mon, 20 Aug 2007 23:48:52 -0700 (PDT)")
References: <659908.35410.qm@web56603.mail.re3.yahoo.com>
Message-ID: <607inp577y.fsf@dba2.int.libertyrms.com>

angga erwina <by_pacitan@yahoo.com> writes:
> hi,
> i've run slon process,then rise error messages like this..whats wrong with my setup connection..help me please...
> thanks,
> regards,
> bayu
> [postgres@laptopbps ~]$ /usr/local/pgsql/bin/slon sdki "dbname=sdki user=postgres port=5432 host=laptopbps"
> 2007-08-20 15:53:35 UTC FATAL? localListenThread: "select "_sdki".cleanupNodelock(); insert into "_sdki".sl_nodelock values (??? 1, 0, "pg_catalog".pg_backend_pid());
> " - ERROR:? duplicate key violates unique constraint "sl_nodelock-pkey"
> 2007-08-20 15:53:35 UTC FATAL? Do you already have a slon running against this node?
> 2007-08-20 15:53:35 UTC FATAL? Or perhaps a residual idle backend connection from a dead slon?
> 2007-08-20 15:53:35 UTC DEBUG2 slon_abort() from pid=4497

This happens when Slony-I believes there is a second slon trying to
connect to manage a node.

The error message asks the right questions.

- Do you already have a slon running against this node?
- Or perhaps a residual idle backend connection from a dead slon?
-- 
output = ("cbbrowne" "@" "ca.afilias.info")
<http://dba2.int.libertyrms.com/>
Christopher Browne
(416) 673-4124 (land)
From cbbrowne at ca.afilias.info  Tue Aug 21 15:36:42 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Tue Aug 21 15:36:55 2007
Subject: [Slony1-general] Log shipping fix in place
In-Reply-To: <2ca799770708202048y32f766d4o1a146ea1c2e62217@mail.gmail.com>
References: <60wsvpvnao.fsf@dba2.int.libertyrms.com>
	<2ca799770708202048y32f766d4o1a146ea1c2e62217@mail.gmail.com>
Message-ID: <46CB68FA.2080504@ca.afilias.info>

Mikko Partio wrote:
>
>
> On 8/21/07, *Christopher Browne* <cbbrowne@ca.afilias.info 
> <mailto:cbbrowne@ca.afilias.info>> wrote:
>
>     Jan committed a change this morning, which I revised a little further,
>     which substantially revises the logshipping logic so as to more
>     correctly coordinate SYNC numbers on subscribers with the provider.
>
>     I have run it through tests on 8.3 with success (after my 'revised a
>     little further' :-)).
>
>     I'll be running it through other versions tomorrow and see if I can
>     have a tarball of pre-1.2.11 tomorrow for Mikko to try again.
>
>     Quick precis: Jan was having trouble figuring out where the SYNC
>     numbers were getting discoordinated, so he dropped them out of
>     in-memory variables and took an entirely different approach, having
>     those numbers track via a new Slony-I schema table,
>     sl_archive_counter.  (Seems good to me; I was always suspicious of
>     managing that purely in memory; that seemed a flakey way to do it...)
>     --
>
>
>
> Excellent news, I'll be waiting for that tarball!
>
See the front page <http://slony.info/> for link to the tarball...
From mpartio at gmail.com  Wed Aug 22 00:42:33 2007
From: mpartio at gmail.com (Mikko Partio)
Date: Wed Aug 22 00:42:50 2007
Subject: [Slony1-general] Log shipping fix in place
In-Reply-To: <46CB68FA.2080504@ca.afilias.info>
References: <60wsvpvnao.fsf@dba2.int.libertyrms.com>
	<2ca799770708202048y32f766d4o1a146ea1c2e62217@mail.gmail.com>
	<46CB68FA.2080504@ca.afilias.info>
Message-ID: <2ca799770708220042t1d8b78e7w21373fdc7bb4d89@mail.gmail.com>

On 8/22/07, Christopher Browne <cbbrowne@ca.afilias.info> wrote:
>
> Mikko Partio wrote:
> >
> >
> > On 8/21/07, *Christopher Browne* <cbbrowne@ca.afilias.info
> > <mailto:cbbrowne@ca.afilias.info>> wrote:
> >
> >     Jan committed a change this morning, which I revised a little
> further,
> >     which substantially revises the logshipping logic so as to more
> >     correctly coordinate SYNC numbers on subscribers with the provider.
> >
> >     I have run it through tests on 8.3 with success (after my 'revised a
> >     little further' :-)).
> >
> >     I'll be running it through other versions tomorrow and see if I can
> >     have a tarball of pre-1.2.11 tomorrow for Mikko to try again.
> >
> >     Quick precis: Jan was having trouble figuring out where the SYNC
> >     numbers were getting discoordinated, so he dropped them out of
> >     in-memory variables and took an entirely different approach, having
> >     those numbers track via a new Slony-I schema table,
> >     sl_archive_counter.  (Seems good to me; I was always suspicious of
> >     managing that purely in memory; that seemed a flakey way to do
> it...)
> >     --
> >
> >
> >
> > Excellent news, I'll be waiting for that tarball!
> >
> See the front page <http://slony.info/> for link to the tarball...
>


I can confirm that the problem with sync numbers and log shipping does not
exist anymore :)

Regards

Mikko
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070822/=
c988f32d/attachment.htm
From trinaths at intoto.com  Wed Aug 22 05:08:38 2007
From: trinaths at intoto.com (Trinath Somanchi)
Date: Wed Aug 22 05:08:48 2007
Subject: [Slony1-general] [Slony-I ] Dynamic DDL
Message-ID: <46CC2746.10700@intoto.com>

An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070822/2dc568e8/attachment.htm
-------------- next part --------------
A non-text attachment was scrubbed...
Name: trinaths.vcf
Type: text/x-vcard
Size: 316 bytes
Desc: not available
Url : http://lists.slony.info/pipermail/slony1-general/attachments/20070822/2dc568e8/trinaths.vcf
From ajs at crankycanuck.ca  Wed Aug 22 06:08:03 2007
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Wed Aug 22 06:08:20 2007
Subject: [Slony1-general] [Slony-I ] Dynamic DDL
In-Reply-To: <46CC2746.10700@intoto.com>
References: <46CC2746.10700@intoto.com>
Message-ID: <20070822130803.GB11506@phlogiston.dyndns.org>

First, please don't post HTML mail.

On Wed, Aug 22, 2007 at 05:38:38PM +0530, Trinath Somanchi wrote:
> created in master . All the archive tables are dynamically created with
> name archive_logs_&lt;timestamp&gt; as the table name . Is there any
> other way how to automate this process . 

No.  Slony doesn't support this sort of thing.  DDL is done via
EXECUTE SCRIPT.  Future versions of Slony might make this slightly
less painful, but I don't think dynamic DDL is on the roadmap at the
moment.  (The "less painful" part comes from fixing the catalogue
corruption problems.)

A

-- 
Andrew Sullivan  | ajs@crankycanuck.ca
In the future this spectacle of the middle classes shocking the avant-
garde will probably become the textbook definition of Postmodernism. 
                --Brad Holland
From cscetbon.ext at orange-ftgroup.com  Wed Aug 22 01:09:24 2007
From: cscetbon.ext at orange-ftgroup.com (Cyril SCETBON)
Date: Wed Aug 22 08:22:16 2007
Subject: [Slony1-general] slave of Master with virtual IP
Message-ID: <46CBEF34.8020105@orange-ftgroup.com>

Hi people,

I got a [1 Master M1 + 1 Slave S1] + Virtual IP configuration. Another 
Slave S2 points to the Master M1 and slave S1 is promoted to master if 
M1 fails. Is there a way to tell S2 to points to S1 when it's promoted 
to Master ? Is it automatic ? Can I use the Virtual IP to resolve it ?

Thanks.
-- 
Cyril SCETBON
From jamiel at istreamimaging.com  Wed Aug 22 11:24:48 2007
From: jamiel at istreamimaging.com (Jeff Amiel)
Date: Wed Aug 22 11:25:01 2007
Subject: [Slony1-general] dead node...old sl_event, log_1, log2 entries
Message-ID: <46CC7F70.6020707@istreamimaging.com>

I recently reconfigured some replication from a single node to 2 
subscribers.
One of the subscribers worked very well and is now in sync.
One of the subscribers has some network connectivity issues and has been 
working in fits and starts (never actually completing the subscription 
of the first set).
So today, I removed the node from the replication cluster via pg-admin 
(mistake?).

However, there now appears to be a LOT of stale/old entries in sl_event, 
log_1, and log_2 (and wherever else) representing that old node.
I did a delete cascade on the replication schema on that dead node in 
preparation for recreating the database from scratch, but am at a loss 
as to how to deal with this 'bloat' on the master node side.


How can I clean this up...and what SHOULD I have done to drop that node 
properly?



From jamiel at istreamimaging.com  Wed Aug 22 11:26:51 2007
From: jamiel at istreamimaging.com (Jeff Amiel)
Date: Wed Aug 22 11:27:06 2007
Subject: [Slony1-general] Re: dead node...old sl_event, log_1, log2 entries
In-Reply-To: <46CC7F70.6020707@istreamimaging.com>
References: <46CC7F70.6020707@istreamimaging.com>
Message-ID: <46CC7FEB.3050302@istreamimaging.com>

never mind...I just noticed in the logs...

# NOTICE:  Slony-I: cleanup stale sl_nodelock entry for pid=9139
CONTEXT:  SQL statement "SELECT  "_replication_cluster".cleanupNodelock()"
PL/pgSQL function "cleanupevent" line 77 at perform
NOTICE:  Slony-I: cleanup stale sl_nodelock entry for pid=9150
CONTEXT:  SQL statement "SELECT  "_replication_cluster".cleanupNodelock()"
PL/pgSQL function "cleanupevent" line 77 at perform
NOTICE:  Slony-I: log switch to sl_log_2 complete - truncate sl_log_1

and now the tables are empty/nearly empty.

Good 'ol slony!

Jeff Amiel wrote:
> I recently reconfigured some replication from a single node to 2 
> subscribers.
> One of the subscribers worked very well and is now in sync.
> One of the subscribers has some network connectivity issues and has 
> been working in fits and starts (never actually completing the 
> subscription of the first set).
> So today, I removed the node from the replication cluster via pg-admin 
> (mistake?).
>
> However, there now appears to be a LOT of stale/old entries in 
> sl_event, log_1, and log_2 (and wherever else) representing that old 
> node.
> I did a delete cascade on the replication schema on that dead node in 
> preparation for recreating the database from scratch, but am at a loss 
> as to how to deal with this 'bloat' on the master node side.
>
>
> How can I clean this up...and what SHOULD I have done to drop that 
> node properly?
>
>
>

From andrew.george.hammond at gmail.com  Wed Aug 22 16:18:08 2007
From: andrew.george.hammond at gmail.com (Andrew Hammond)
Date: Wed Aug 22 16:18:20 2007
Subject: [Slony1-general] slave of Master with virtual IP
In-Reply-To: <46CBEF34.8020105@orange-ftgroup.com>
References: <46CBEF34.8020105@orange-ftgroup.com>
Message-ID: <5a0a9d6f0708221618l6dfbbaecm523488e3802f0cea@mail.gmail.com>

On 8/22/07, Cyril SCETBON <cscetbon.ext@orange-ftgroup.com> wrote:
>
> Hi people,
>
> I got a [1 Master M1 + 1 Slave S1] + Virtual IP configuration. Another
> Slave S2 points to the Master M1 and slave S1 is promoted to master if
> M1 fails. Is there a way to tell S2 to points to S1 when it's promoted
> to Master ? Is it automatic ?


Perhaps you should read the section of the documentation about failover and
move set commands.

Can I use the Virtual IP to resolve it ?


No.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070822/=
d30fb75a/attachment.htm
From andrew.george.hammond at gmail.com  Wed Aug 22 16:30:09 2007
From: andrew.george.hammond at gmail.com (Andrew Hammond)
Date: Wed Aug 22 16:30:21 2007
Subject: [Slony1-general] [Slony-I ] Dynamic DDL
In-Reply-To: <20070822130803.GB11506@phlogiston.dyndns.org>
References: <46CC2746.10700@intoto.com>
	<20070822130803.GB11506@phlogiston.dyndns.org>
Message-ID: <5a0a9d6f0708221630g10be2670h219fd81d7599eff4@mail.gmail.com>

On 8/22/07, Andrew Sullivan <ajs@crankycanuck.ca> wrote:
>
> First, please don't post HTML mail.
>
> On Wed, Aug 22, 2007 at 05:38:38PM +0530, Trinath Somanchi wrote:
> > created in master . All the archive tables are dynamically created with
> > name archive_logs_&lt;timestamp&gt; as the table name . Is there any
> > other way how to automate this process .
>
> No.  Slony doesn't support this sort of thing.  DDL is done via
> EXECUTE SCRIPT.  Future versions of Slony might make this slightly
> less painful, but I don't think dynamic DDL is on the roadmap at the
> moment.  (The "less painful" part comes from fixing the catalogue
> corruption problems.)
>

Since your application is dynamically creating and dropping tables, if you
wanted these tables to be replicated, then you'd presumably need to change
your application so that it does it's DDL via slonik's execute script (or
directly, mimicking the functionality of slonik execute script, if you're
willing to handle that level of complexity in you code) followed by
appropriate create set and subscribe commands.

I am not aware of anyone doing this. In fact, this bring's to mind Jan's
comments about schema-modifying applications and self-modifying software...

Andrew
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070822/=
093eb4cb/attachment.htm
From ajs at crankycanuck.ca  Wed Aug 22 20:14:11 2007
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Wed Aug 22 20:14:35 2007
Subject: [Slony1-general] [Slony-I ] Dynamic DDL
In-Reply-To: <5a0a9d6f0708221630g10be2670h219fd81d7599eff4@mail.gmail.com>
References: <46CC2746.10700@intoto.com>
	<20070822130803.GB11506@phlogiston.dyndns.org>
	<5a0a9d6f0708221630g10be2670h219fd81d7599eff4@mail.gmail.com>
Message-ID: <20070823031411.GC14704@phlogiston.dyndns.org>

On Wed, Aug 22, 2007 at 04:30:09PM -0700, Andrew Hammond wrote:
> Since your application is dynamically creating and dropping tables, if you
> wanted these tables to be replicated, then you'd presumably need to change
> your application so that it does it's DDL via slonik's execute script (or
> directly, mimicking the functionality of slonik execute script, if you're
> willing to handle that level of complexity in you code) followed by
> appropriate create set and subscribe commands.

That does all sorts of nasty locking, though.  Be warned.

A
-- 
Andrew Sullivan  | ajs@crankycanuck.ca
Everything that happens in the world happens at some place.
		--Jane Jacobs 
From mpartio at gmail.com  Thu Aug 23 00:24:43 2007
From: mpartio at gmail.com (Mikko Partio)
Date: Thu Aug 23 00:25:00 2007
Subject: [Slony1-general] Re: log shipping gone wrong
In-Reply-To: <2ca799770708152135n398802een24f023c629e7305c@mail.gmail.com>
References: <2ca799770707200605j1bb37c13o98c86a21834db2ab@mail.gmail.com>
	<46A4AE4F.4080304@Yahoo.com>
	<2ca799770707230728h3e3afa3auefdc1ae8dd429156@mail.gmail.com>
	<46A4C3E7.1020107@Yahoo.com>
	<2ca799770707232129p27822251v9947c748d2395630@mail.gmail.com>
	<46ACCF3A.9050005@Yahoo.com>
	<2ca799770708052339w73818564y4ab95181505dd349@mail.gmail.com>
	<46BC8E34.7060600@Yahoo.com>
	<2ca799770708102144p4726a370l206e56ec664b1149@mail.gmail.com>
	<2ca799770708152135n398802een24f023c629e7305c@mail.gmail.com>
Message-ID: <2ca799770708230024y58a4cd55v1cf0f463c5d13c67@mail.gmail.com>

On 8/16/07, Mikko Partio <mpartio@gmail.com> wrote:
>
>
>
> On 8/11/07, Mikko Partio <mpartio@gmail.com> wrote:
> >
> >
> >
> > On 8/10/07, Jan Wieck <JanWieck@yahoo.com > wrote:
> > >
> > > I found a couple more issues with archive logging so far. Specifically
> > > some related to replicating sequences (seems like this could have
> > > never
> > > worked).
> >
> >

For the archives: the problem was fixed at slony version 1.2.11 pre 2.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070823/=
e68d349f/attachment.htm
From cbbrowne at ca.afilias.info  Thu Aug 23 06:58:20 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Thu Aug 23 06:58:24 2007
Subject: [Slony1-general] Re: log shipping gone wrong
In-Reply-To: <2ca799770708230024y58a4cd55v1cf0f463c5d13c67@mail.gmail.com>
	(Mikko Partio's message of "Thu, 23 Aug 2007 10:24:43 +0300")
References: <2ca799770707200605j1bb37c13o98c86a21834db2ab@mail.gmail.com>
	<46A4AE4F.4080304@Yahoo.com>
	<2ca799770707230728h3e3afa3auefdc1ae8dd429156@mail.gmail.com>
	<46A4C3E7.1020107@Yahoo.com>
	<2ca799770707232129p27822251v9947c748d2395630@mail.gmail.com>
	<46ACCF3A.9050005@Yahoo.com>
	<2ca799770708052339w73818564y4ab95181505dd349@mail.gmail.com>
	<46BC8E34.7060600@Yahoo.com>
	<2ca799770708102144p4726a370l206e56ec664b1149@mail.gmail.com>
	<2ca799770708152135n398802een24f023c629e7305c@mail.gmail.com>
	<2ca799770708230024y58a4cd55v1cf0f463c5d13c67@mail.gmail.com>
Message-ID: <60ir764akj.fsf@dba2.int.libertyrms.com>

"Mikko Partio" <mpartio@gmail.com> writes:
> On 8/16/07, Mikko Partio <mpartio@gmail.com> wrote:
>
>                
>      
>
>                On 8/11/07, Mikko Partio <mpartio@gmail.com> wrote:
>
>                               
>           
>
>                     On 8/10/07, Jan Wieck <JanWieck@yahoo.com> wrote:
>
>                               I found a couple more issues with archive logging so far. Specifically
>                some related to replicating sequences (seems like this could have never
>                worked).
>
>
>
>
> For the archives: the problem was fixed at slony version 1.2.11 pre 2.

And it's the changes that went in on 2007-08-20/2007-08-21 that did
the trick...

Jan's looking at one more change that should be quite straightforward,
then we'll see about 1.2.11 "for real."
-- 
let name="cbbrowne" and tld="acm.org" in name ^ "@" ^ tld;;
http://www3.sympatico.ca/cbbrowne/linuxxian.html
"The  reality of  the  software business  today  is that  if you  find
something that  can make you ridiculously rich,  then that's something
that Microsoft is going to take away from you." -- Max Metral
From drees76 at gmail.com  Thu Aug 23 11:59:01 2007
From: drees76 at gmail.com (David Rees)
Date: Thu Aug 23 11:59:09 2007
Subject: [Slony1-general] Determine how many items in log belong to an
	event...?
In-Reply-To: <200708170847.31218.lists_slony1-general@avsupport.com>
References: <200708151552.48987.lists_slony1-general@avsupport.com>
	<72dbd3150708151433j2e51fd1chf8d551ff17c8a49e@mail.gmail.com>
	<200708170847.31218.lists_slony1-general@avsupport.com>
Message-ID: <72dbd3150708231159h5adae03jb09d47b7656cceab@mail.gmail.com>

On 8/17/07, Dan Falconer <lists_slony1-general@avsupport.com> wrote:
> On Wednesday 15 August 2007 16:33, David Rees wrote:
> > Why are you running such an old version of Pg? You should be running
> > 8.0.13 at least...
>
> Good point... I'm not a DBA, but I play one at my job.  ;)

:-) Get that beast upgraded to the latest maintenance release if
possible. Many have reported that going to the latest major release is
a good idea as well.

> The master server has a very worrisome load, running between 5-20.  I took a
> snapshot of it:
>         load average: 13.18, 7.23, 4.33

The load average is fairly high for a dual-processor machine, but your
vmstat output looks very benign with the system sitting at 50% idle
and low IO wait times.

> There's also a fetch that's been running for a very long time (there was a
> poorly timed vacuum of the whole database that took 2 days while this was
> running; this has been formatted for your screen)::::

What is that process doing according to postgres? What locks are being
held and are any processes being blocked by that long running query?

> The slons aren't run with any special settings.  They're started using
> the "slon_start" bash script included with Slony (some items removed to
> protect the innocent):::
>
> /usr/local/pgsql/bin/slon -s 5000 -d2 replication host=******* dbname=pl
> user=postgres port=5432

You might want to try bumping up the maximum sync group size from the
default of 6 to something like 50-100 to see if that helps.

What about postgresql tuning itself? What do the performance related
postgresql.conf settings look like?

-Dave
From lists_slony1-general at avsupport.com  Fri Aug 24 07:54:28 2007
From: lists_slony1-general at avsupport.com (Dan Falconer)
Date: Fri Aug 24 07:55:55 2007
Subject: [Slony1-general] Determine how many items in log belong to an
	event...?
In-Reply-To: <72dbd3150708231159h5adae03jb09d47b7656cceab@mail.gmail.com>
References: <200708151552.48987.lists_slony1-general@avsupport.com>
	<200708170847.31218.lists_slony1-general@avsupport.com>
	<72dbd3150708231159h5adae03jb09d47b7656cceab@mail.gmail.com>
Message-ID: <200708240954.28516.lists_slony1-general@avsupport.com>

On Thursday 23 August 2007 13:59, David Rees wrote:
> On 8/17/07, Dan Falconer <lists_slony1-general@avsupport.com> wrote:
> > On Wednesday 15 August 2007 16:33, David Rees wrote:
> > > Why are you running such an old version of Pg? You should be running
> > > 8.0.13 at least...
> >
> > Good point... I'm not a DBA, but I play one at my job.  ;)
> >
> :-) Get that beast upgraded to the latest maintenance release if
> possible. Many have reported that going to the latest major release is
> a good idea as well.

I kinda saw that one coming.  Hopefully I can convince all the other 
cheiftains that it's a good idea.   The good news is I can then finally test 
how it works to switch master while upgrading.  Woot.
>
> > The master server has a very worrisome load, running between 5-20.  I
> > took a snapshot of it:
> >         load average: 13.18, 7.23, 4.33
>
> The load average is fairly high for a dual-processor machine, but your
> vmstat output looks very benign with the system sitting at 50% idle
> and low IO wait times.
>
> > There's also a fetch that's been running for a very long time (there was
> > a poorly timed vacuum of the whole database that took 2 days while this
> > was running; this has been formatted for your screen)::::
>
> What is that process doing according to postgres? What locks are being
> held and are any processes being blocked by that long running query?

Well, according to Postgres, it's a fetch being run by the slave server 
("FETCH 100 FROM LOG").  I couldn't really tell if there were any locks being 
held by it or what was being blocked (queries to help facilitate that would 
be cool).  The logs had a combined total of 20+ million records (5M in 
sl_log_1, 15M in sl_log_2)... it was 4 days behind, so I killed replication 
completely: dropped the replication schema on both servers, re-init, 
create/subscribe set.
>
> > The slons aren't run with any special settings.  They're started using
> > the "slon_start" bash script included with Slony (some items removed to
> > protect the innocent):::
> >
> > /usr/local/pgsql/bin/slon -s 5000 -d2 replication host=******* dbname=pl
> > user=postgres port=5432
>
> You might want to try bumping up the maximum sync group size from the
> default of 6 to something like 50-100 to see if that helps.
>
> What about postgresql tuning itself? What do the performance related
> postgresql.conf settings look like?
>
> -Dave

Any help with regards to changing options using the slon_start script would be 
great... I can't find anything in the configuration file that indicates such 
settings.

As far as performance options in postgresql.conf:::

shared_buffers = 12800
work_mem = 32768
maintenance_work_mem = 102400
max_stack_depth = 4096
max_fsm_pages = 165000
max_fsm_relations = 10000
effective_cache_size = 768000
random_page_cost = 2


I've got all the stats turned on as well, if any of that information can be 
helpful.  The "performance tuning" was all done by myself and another 
developer: we were both pretty much guessing at what we were doing, mostly 
going for maximization of memory usage.




-- 
Best Regards,


Dan Falconer
"Head Geek", Avsupport, Inc. / Partslogistics.com
http://www.partslogistics.com
From ajs at crankycanuck.ca  Fri Aug 24 09:21:40 2007
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Fri Aug 24 09:21:57 2007
Subject: [Slony1-general] Determine how many items in log belong to an
	event...?
In-Reply-To: <200708240954.28516.lists_slony1-general@avsupport.com>
References: <200708151552.48987.lists_slony1-general@avsupport.com>
	<200708170847.31218.lists_slony1-general@avsupport.com>
	<72dbd3150708231159h5adae03jb09d47b7656cceab@mail.gmail.com>
	<200708240954.28516.lists_slony1-general@avsupport.com>
Message-ID: <20070824162140.GJ19180@phlogiston.dyndns.org>

On Fri, Aug 24, 2007 at 09:54:28AM -0500, Dan Falconer wrote:

> I kinda saw that one coming.  Hopefully I can convince all the other 
> cheiftains that it's a good idea.   The good news is I can then finally test 
> how it works to switch master while upgrading.  Woot.

Upgrading to a minor release is very close to never a bad idea.  The
community thinks it is riskier to stay on an old minor release than
not to do.  See http://www.postgresql.org/support/versioning

> be cool).  The logs had a combined total of 20+ million records (5M in 
> sl_log_1, 15M in sl_log_2)... it was 4 days behind, so I killed replication 
> completely: dropped the replication schema on both servers, re-init, 
> create/subscribe set.

I don't know if that was worth doing.  Often what do _do_ need,
however, is to kill the slons and VACUUM ANALYSE the log tables. 
you'll get in trouble with long-running slony applier transactions
otherwise.

And yes, when catching up, you want to set the snapshot size _much_
larger.

A

-- 
Andrew Sullivan  | ajs@crankycanuck.ca
The fact that technology doesn't work is no bar to success in the marketplace.
		--Philip Greenspun
From drees76 at gmail.com  Fri Aug 24 12:03:11 2007
From: drees76 at gmail.com (David Rees)
Date: Fri Aug 24 12:03:21 2007
Subject: [Slony1-general] Determine how many items in log belong to an
	event...?
In-Reply-To: <200708240954.28516.lists_slony1-general@avsupport.com>
References: <200708151552.48987.lists_slony1-general@avsupport.com>
	<200708170847.31218.lists_slony1-general@avsupport.com>
	<72dbd3150708231159h5adae03jb09d47b7656cceab@mail.gmail.com>
	<200708240954.28516.lists_slony1-general@avsupport.com>
Message-ID: <72dbd3150708241203g5b305535l2a4e7903e2e75c1c@mail.gmail.com>

On 8/24/07, Dan Falconer <lists_slony1-general@avsupport.com> wrote:
> Any help with regards to changing options using the slon_start script would be
> great... I can't find anything in the configuration file that indicates such
> settings.

Hmmm, neither do I, but I use daemontools to start and watch my slon
processes. Then you can either specify the options you want to change
on the command line, but I prefer to keep a config file for each slon
daemon and use that.

> As far as performance options in postgresql.conf:::
>
> shared_buffers = 12800
> work_mem = 32768
> maintenance_work_mem = 102400
> max_stack_depth = 4096
> max_fsm_pages = 165000
> max_fsm_relations = 10000
> effective_cache_size = 768000
> random_page_cost = 2

shared_buffers seems low (~100MB) for a machine with 8GB RAM. I would
try increasing that to somewhere between 500MB-2GB to start with.

maintenance_work_mem can likely be set much higher as well. How big
are your biggest tables?

-Dave
From drees76 at gmail.com  Fri Aug 24 12:25:03 2007
From: drees76 at gmail.com (David Rees)
Date: Fri Aug 24 12:25:11 2007
Subject: [Slony1-general] slon sync_group_max_size docs inconsistent
Message-ID: <72dbd3150708241225g25f4a65ci7e4aa2be8e5b6eb5@mail.gmail.com>

On 8/24/07, Andrew Sullivan <ajs@crankycanuck.ca> wrote:
> And yes, when catching up, you want to set the snapshot size _much_
> larger.

I just found some discrepancies in the sample slon.conf, the admin
guide and what the actual default, min, max settings for
sync_group_max_size.

The sample slon.conf indicates that the settings are 6, 0, 100
(default, min, max)
But confoptions.c indicates that the settings are 20, 0, 10000
(default, min, max)
The admin guide has an incorrect default (same as slon.conf) and
doesn't mention min/max values.

Perhaps this could be corrected in CVS possibly for the next release?

-Dave
From cbbrowne at ca.afilias.info  Mon Aug 27 09:37:43 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Mon Aug 27 09:37:54 2007
Subject: [Slony1-general] News on 1.2.11
Message-ID: <60ejhpkk6g.fsf@dba2.int.libertyrms.com>

I had a bit of a scare when the log shipping test wasn't working after
Jan's latest change; that turned out to be a case where the test
required some revisions.  It's working fine now :-).

I am in the process of running 1_2_STABLE through tests on all
PostgreSQL releases right now:

- I have completed builds against 7.4, 8.0, 8.1, 8.2, and 8.3 (CVS
  HEAD), successfully, on Debian/Unstable

- I have completed runs of all the tests in tests/ against 8.3, and am
  presently running against 7.4, with the other versions to follow...

There haven't been any changes of late that would cause me to expect
any old PostgreSQL versions to break; the one thing that *does* give
me a bit of concern is the log shipping test, as it changed a fair
bit.  If someone can run it against a non-Linux platform, to find any
portability breakages, that would be a good thing.  It shouldn't be a
matter of log shipping breaking; the thing I'm concerned about is the
test itself...

At any rate, I think we can expect 1.2.11 pretty soon.
-- 
(format nil "~S@~S" "cbbrowne" "cbbrowne.com")
http://linuxdatabases.info/info/languages.html
"Suppose  you  were  an  idiot.   And  suppose you  were  a  member  of
Congress. But I repeat myself."  -- Mark Twain
From lists_slony1-general at avsupport.com  Mon Aug 27 14:00:50 2007
From: lists_slony1-general at avsupport.com (Dan Falconer)
Date: Mon Aug 27 14:01:06 2007
Subject: [Slony1-general] Determine how many items in log belong to an
	event...?
In-Reply-To: <20070824162140.GJ19180@phlogiston.dyndns.org>
References: <200708151552.48987.lists_slony1-general@avsupport.com>
	<200708240954.28516.lists_slony1-general@avsupport.com>
	<20070824162140.GJ19180@phlogiston.dyndns.org>
Message-ID: <200708271600.50734.lists_slony1-general@avsupport.com>

On Friday 24 August 2007 11:21, Andrew Sullivan wrote:
>
> > be cool).  The logs had a combined total of 20+ million records (5M in
> > sl_log_1, 15M in sl_log_2)... it was 4 days behind, so I killed
> > replication completely: dropped the replication schema on both servers,
> > re-init, create/subscribe set.
>
> I don't know if that was worth doing.  Often what do _do_ need,
> however, is to kill the slons and VACUUM ANALYSE the log tables.
> you'll get in trouble with long-running slony applier transactions
> otherwise.
>
> And yes, when catching up, you want to set the snapshot size _much_
> larger.

I'm really unclear as to what you mean by "snapshot size".  I've updated the 
maximum SYNC group size from 6 to 25, and (some time ago, apparently) the sync 
interval was changed from 1000 to 5000.  Thusfar, I haven't seen any 
improvements in how far the slave is behind. 

In fact, the most distressing part out of all of this, which could be due to 
some lack of information, is that the master thinks it's out of date with 
itself:::

pl=# select * from _pl_replication.sl_status ;
 st_origin | st_received | st_last_event |      st_last_event_ts      | 
st_last_received |    st_last_received_ts     | st_last_received_event_ts  | 
st_lag_num_events |      st_lag_time
-----------+-------------+---------------+----------------------------+------------------+----------------------------+----------------------------+-------------------+------------------------
         2 |           1 |        158891 | 2007-08-27 15:59:42.075411 |            
73386 | 2007-08-27 15:55:55.426633 | 2007-08-22 04:35:04.110386 |             
85505 | 5 days 11:24:40.374125
(1 row)

>
> A

-- 
Best Regards,


Dan Falconer
"Head Geek", Avsupport, Inc. / Partslogistics.com
http://www.partslogistics.com
From ajs at crankycanuck.ca  Mon Aug 27 14:14:01 2007
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Mon Aug 27 14:14:28 2007
Subject: [Slony1-general] Determine how many items in log belong to an
	event...?
In-Reply-To: <200708271600.50734.lists_slony1-general@avsupport.com>
References: <200708151552.48987.lists_slony1-general@avsupport.com>
	<200708240954.28516.lists_slony1-general@avsupport.com>
	<20070824162140.GJ19180@phlogiston.dyndns.org>
	<200708271600.50734.lists_slony1-general@avsupport.com>
Message-ID: <20070827211401.GA30834@phlogiston.dyndns.org>

On Mon, Aug 27, 2007 at 04:00:50PM -0500, Dan Falconer wrote:
> 
> I'm really unclear as to what you mean by "snapshot size".  I've updated the 
> maximum SYNC group size from 6 to 25, and (some time ago, apparently) the sync 

That's what I meant, yes.  Sorry for speaking imprecisely.

> In fact, the most distressing part out of all of this, which could be due to 
> some lack of information, is that the master thinks it's out of date with 
> itself:::

Hrm.  Are you sure SYNC messages are getting through everywhere?
There is some point (5 days may well be approaching it) where you
need to rebuild everything.

At the very least, I would stop everything and VACUUM ANALYSE the
slony tables, first, though.  My guess is that you're now hitting
badly messed up log tables, and you're in the dead tuple death
spiral.  

A


-- 
Andrew Sullivan  | ajs@crankycanuck.ca
The very definition of "news" is "something that hardly ever happens."	
		--Bruce Schneier
From lists_slony1-general at avsupport.com  Mon Aug 27 14:30:29 2007
From: lists_slony1-general at avsupport.com (Dan Falconer)
Date: Mon Aug 27 14:30:46 2007
Subject: [Slony1-general] Determine how many items in log belong to an
	event...?
In-Reply-To: <20070827211401.GA30834@phlogiston.dyndns.org>
References: <200708151552.48987.lists_slony1-general@avsupport.com>
	<200708271600.50734.lists_slony1-general@avsupport.com>
	<20070827211401.GA30834@phlogiston.dyndns.org>
Message-ID: <200708271630.29601.lists_slony1-general@avsupport.com>

On Monday 27 August 2007 16:14, Andrew Sullivan wrote:
> On Mon, Aug 27, 2007 at 04:00:50PM -0500, Dan Falconer wrote:
> > I'm really unclear as to what you mean by "snapshot size".  I've updated
> > the maximum SYNC group size from 6 to 25, and (some time ago, apparentl=
y)
> > the sync
>
> That's what I meant, yes.  Sorry for speaking imprecisely.
>
> > In fact, the most distressing part out of all of this, which could be d=
ue
> > to some lack of information, is that the master thinks it's out of date
> > with itself:::
>
> Hrm.  Are you sure SYNC messages are getting through everywhere?
> There is some point (5 days may well be approaching it) where you
> need to rebuild everything.
>
> At the very least, I would stop everything and VACUUM ANALYSE the
> slony tables, first, though.  My guess is that you're now hitting
> badly messed up log tables, and you're in the dead tuple death
> spiral.

Lol.  I think "dead tuple death spiral" may indeed be the problem, though I =

have no idea what causes it.  Going with the suggestions of David Rees, I =

stopped slons & ran some vacuums: on each server, I vacuumed every time I =

found within the "_pl_replication" schema.  At most, the vacuums took 30 =

seconds to run, and I saw nothing terrible in regards to the number of rows =

removed, rows that couldn't be removed, etc.

I believe that SYNCs are getting through, but some insight into the log fil=
es =

to clarify would be great.  I've attached log files for roughly the same =

period of time for both the master & slave.  Also, when I restarted the =

slons, I get notices printed to the console (instead of a log file) =

indicating that the switch from log_1 to log_2 failed... help?

>
> A

-- =

Best Regards,


Dan Falconer
"Head Geek", Avsupport, Inc. / Partslogistics.com
http://www.partslogistics.com
-------------- next part --------------
2007-08-27 16:23:14 CDT DEBUG2 localListenThread: Received event 2,159160 S=
YNC
2007-08-27 16:23:15 CDT DEBUG2 remoteListenThread_1: queue event 1,85580 SY=
NC
2007-08-27 16:23:15 CDT DEBUG2 remoteListenThread_1: UNLISTEN
2007-08-27 16:23:15 CDT DEBUG2 remoteWorkerThread_1: Received event 1,85580=
 SYNC
2007-08-27 16:23:15 CDT DEBUG2 remoteWorkerThread_1: SYNC 85580 processing
2007-08-27 16:23:15 CDT DEBUG2 remoteWorkerThread_1: no sets need syncing f=
or this event
2007-08-27 16:23:16 CDT DEBUG2 syncThread: new sl_action_seq 28123401 - SYN=
C 159161
2007-08-27 16:23:19 CDT DEBUG2 localListenThread: Received event 2,159161 S=
YNC
2007-08-27 16:23:20 CDT DEBUG2 remoteListenThread_1: LISTEN
2007-08-27 16:23:22 CDT DEBUG2 syncThread: new sl_action_seq 28123496 - SYN=
C 159162
2007-08-27 16:23:24 CDT DEBUG2 localListenThread: Received event 2,159162 S=
YNC
2007-08-27 16:23:25 CDT DEBUG2 remoteListenThread_1: queue event 1,85581 SY=
NC
2007-08-27 16:23:25 CDT DEBUG2 remoteListenThread_1: UNLISTEN
2007-08-27 16:23:25 CDT DEBUG2 remoteWorkerThread_1: Received event 1,85581=
 SYNC
2007-08-27 16:23:25 CDT DEBUG2 remoteWorkerThread_1: SYNC 85581 processing
2007-08-27 16:23:25 CDT DEBUG2 remoteWorkerThread_1: no sets need syncing f=
or this event
2007-08-27 16:23:27 CDT DEBUG2 syncThread: new sl_action_seq 28123538 - SYN=
C 159163
2007-08-27 16:23:29 CDT DEBUG2 localListenThread: Received event 2,159163 S=
YNC
2007-08-27 16:23:30 CDT DEBUG2 remoteListenThread_1: LISTEN
2007-08-27 16:23:32 CDT DEBUG2 syncThread: new sl_action_seq 28123561 - SYN=
C 159164
2007-08-27 16:23:34 CDT DEBUG2 localListenThread: Received event 2,159164 S=
YNC
2007-08-27 16:23:35 CDT DEBUG2 remoteListenThread_1: queue event 1,85582 SY=
NC
2007-08-27 16:23:35 CDT DEBUG2 remoteListenThread_1: UNLISTEN
2007-08-27 16:23:35 CDT DEBUG2 remoteWorkerThread_1: Received event 1,85582=
 SYNC
2007-08-27 16:23:35 CDT DEBUG2 remoteWorkerThread_1: SYNC 85582 processing
2007-08-27 16:23:35 CDT DEBUG2 remoteWorkerThread_1: no sets need syncing f=
or this event
2007-08-27 16:23:37 CDT DEBUG2 syncThread: new sl_action_seq 28123604 - SYN=
C 159165
2007-08-27 16:23:39 CDT DEBUG2 localListenThread: Received event 2,159165 S=
YNC
2007-08-27 16:23:40 CDT DEBUG2 remoteListenThread_1: LISTEN
2007-08-27 16:23:42 CDT DEBUG2 syncThread: new sl_action_seq 28123643 - SYN=
C 159166
2007-08-27 16:23:43 CDT DEBUG2 remoteWorkerThread_1: forward confirm 2,7339=
8 received by 1
2007-08-27 16:23:44 CDT DEBUG2 localListenThread: Received event 2,159166 S=
YNC
2007-08-27 16:23:45 CDT DEBUG2 remoteListenThread_1: queue event 1,85583 SY=
NC
2007-08-27 16:23:45 CDT DEBUG2 remoteListenThread_1: UNLISTEN
2007-08-27 16:23:45 CDT DEBUG2 remoteWorkerThread_1: Received event 1,85583=
 SYNC
2007-08-27 16:23:45 CDT DEBUG2 remoteWorkerThread_1: SYNC 85583 processing
2007-08-27 16:23:45 CDT DEBUG2 remoteWorkerThread_1: no sets need syncing f=
or this event
2007-08-27 16:23:47 CDT DEBUG2 syncThread: new sl_action_seq 28123715 - SYN=
C 159167
2007-08-27 16:23:49 CDT DEBUG2 localListenThread: Received event 2,159167 S=
YNC
2007-08-27 16:23:50 CDT DEBUG2 remoteListenThread_1: LISTEN
2007-08-27 16:23:52 CDT DEBUG2 syncThread: new sl_action_seq 28123784 - SYN=
C 159168
2007-08-27 16:23:54 CDT DEBUG2 localListenThread: Received event 2,159168 S=
YNC
2007-08-27 16:23:55 CDT DEBUG2 remoteListenThread_1: queue event 1,85584 SY=
NC
2007-08-27 16:23:55 CDT DEBUG2 remoteListenThread_1: UNLISTEN
2007-08-27 16:23:55 CDT DEBUG2 remoteWorkerThread_1: Received event 1,85584=
 SYNC
2007-08-27 16:23:55 CDT DEBUG2 remoteWorkerThread_1: SYNC 85584 processing
2007-08-27 16:23:55 CDT DEBUG2 remoteWorkerThread_1: no sets need syncing f=
or this event
2007-08-27 16:23:57 CDT DEBUG2 syncThread: new sl_action_seq 28123824 - SYN=
C 159169
2007-08-27 16:23:59 CDT DEBUG2 localListenThread: Received event 2,159169 S=
YNC
2007-08-27 16:24:00 CDT DEBUG2 remoteListenThread_1: LISTEN
2007-08-27 16:24:02 CDT DEBUG2 syncThread: new sl_action_seq 28123870 - SYN=
C 159170
2007-08-27 16:24:04 CDT DEBUG2 localListenThread: Received event 2,159170 S=
YNC
2007-08-27 16:24:05 CDT DEBUG2 remoteListenThread_1: queue event 1,85585 SY=
NC
2007-08-27 16:24:05 CDT DEBUG2 remoteListenThread_1: UNLISTEN
2007-08-27 16:24:05 CDT DEBUG2 remoteWorkerThread_1: Received event 1,85585=
 SYNC
2007-08-27 16:24:05 CDT DEBUG2 remoteWorkerThread_1: SYNC 85585 processing
2007-08-27 16:24:05 CDT DEBUG2 remoteWorkerThread_1: no sets need syncing f=
or this event
-------------- next part --------------
2007-08-27 16:23:14 CDT DEBUG2 localListenThread: Received event 1,85579 SY=
NC
2007-08-27 16:23:15 CDT DEBUG2 syncThread: new sl_action_seq 1 - SYNC 85580
2007-08-27 16:23:17 CDT DEBUG2 remoteListenThread_2: queue event 2,159161 S=
YNC
2007-08-27 16:23:19 CDT DEBUG2 localListenThread: Received event 1,85580 SY=
NC
2007-08-27 16:23:22 CDT DEBUG2 remoteListenThread_2: queue event 2,159162 S=
YNC
2007-08-27 16:23:25 CDT DEBUG2 syncThread: new sl_action_seq 1 - SYNC 85581
2007-08-27 16:23:27 CDT DEBUG2 remoteListenThread_2: queue event 2,159163 S=
YNC
2007-08-27 16:23:32 CDT DEBUG2 remoteListenThread_2: queue event 2,159164 S=
YNC
2007-08-27 16:23:34 CDT DEBUG2 localListenThread: Received event 1,85581 SY=
NC
2007-08-27 16:23:35 CDT DEBUG2 syncThread: new sl_action_seq 1 - SYNC 85582
2007-08-27 16:23:37 CDT DEBUG2 remoteListenThread_2: queue event 2,159165 S=
YNC
2007-08-27 16:23:39 CDT DEBUG2 localListenThread: Received event 1,85582 SY=
NC
2007-08-27 16:23:41 CDT DEBUG2 remoteHelperThread_2_2: 119.937 seconds dela=
y for first row
2007-08-27 16:23:41 CDT DEBUG2 remoteHelperThread_2_2: 119.939 seconds unti=
l close cursor
2007-08-27 16:23:41 CDT DEBUG2 remoteHelperThread_2_2: inserts=3D15 updates=
=3D8 deletes=3D0
2007-08-27 16:23:43 CDT DEBUG2 remoteWorkerThread_2: new sl_rowid_seq value=
: 2000000000000000
2007-08-27 16:23:43 CDT DEBUG2 remoteWorkerThread_2: SYNC 73398 done in 121=
.696 seconds
2007-08-27 16:23:43 CDT DEBUG2 remoteWorkerThread_2: Received event 2,73399=
 SYNC
2007-08-27 16:23:43 CDT DEBUG2 remoteWorkerThread_2: SYNC 73399 processing
2007-08-27 16:23:43 CDT DEBUG2 remoteWorkerThread_2: syncing set 1 with 129=
 table(s) from provider 2
2007-08-27 16:23:43 CDT DEBUG2  ssy_action_list length: 0
2007-08-27 16:23:43 CDT DEBUG2 remoteWorkerThread_2: current local log_stat=
us is 2
2007-08-27 16:23:43 CDT DEBUG2 remoteWorkerThread_2_2: current remote log_s=
tatus =3D 2
2007-08-27 16:23:43 CDT DEBUG2 remoteListenThread_2: queue event 2,159166 S=
YNC
2007-08-27 16:23:45 CDT DEBUG2 syncThread: new sl_action_seq 1 - SYNC 85583
2007-08-27 16:23:48 CDT DEBUG2 remoteListenThread_2: queue event 2,159167 S=
YNC
2007-08-27 16:23:53 CDT DEBUG2 remoteListenThread_2: queue event 2,159168 S=
YNC
2007-08-27 16:23:54 CDT DEBUG2 localListenThread: Received event 1,85583 SY=
NC
2007-08-27 16:23:55 CDT DEBUG2 syncThread: new sl_action_seq 1 - SYNC 85584
2007-08-27 16:23:59 CDT DEBUG2 remoteListenThread_2: queue event 2,159169 S=
YNC
2007-08-27 16:23:59 CDT DEBUG2 localListenThread: Received event 1,85584 SY=
NC
2007-08-27 16:24:04 CDT DEBUG2 remoteListenThread_2: queue event 2,159170 S=
YNC
2007-08-27 16:24:05 CDT DEBUG2 syncThread: new sl_action_seq 1 - SYNC 85585
2007-08-27 16:24:09 CDT DEBUG2 remoteListenThread_2: queue event 2,159171 S=
YNC
2007-08-27 16:24:14 CDT DEBUG2 remoteListenThread_2: queue event 2,159172 S=
YNC
2007-08-27 16:24:14 CDT DEBUG2 localListenThread: Received event 1,85585 SY=
NC
2007-08-27 16:24:15 CDT DEBUG2 syncThread: new sl_action_seq 1 - SYNC 85586
2007-08-27 16:24:19 CDT DEBUG2 remoteListenThread_2: queue event 2,159173 S=
YNC
2007-08-27 16:24:19 CDT DEBUG2 localListenThread: Received event 1,85586 SY=
NC
2007-08-27 16:24:24 CDT DEBUG2 remoteListenThread_2: queue event 2,159174 S=
YNC
2007-08-27 16:24:25 CDT DEBUG2 syncThread: new sl_action_seq 1 - SYNC 85587
2007-08-27 16:24:29 CDT DEBUG2 remoteListenThread_2: queue event 2,159175 S=
YNC
2007-08-27 16:24:34 CDT DEBUG2 remoteListenThread_2: queue event 2,159176 S=
YNC
2007-08-27 16:24:34 CDT DEBUG2 localListenThread: Received event 1,85587 SY=
NC
2007-08-27 16:24:35 CDT DEBUG2 syncThread: new sl_action_seq 1 - SYNC 85588
From ajs at crankycanuck.ca  Mon Aug 27 14:34:13 2007
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Mon Aug 27 14:34:29 2007
Subject: [Slony1-general] Determine how many items in log belong to an
	event...?
In-Reply-To: <200708271630.29601.lists_slony1-general@avsupport.com>
References: <200708151552.48987.lists_slony1-general@avsupport.com>
	<200708271600.50734.lists_slony1-general@avsupport.com>
	<20070827211401.GA30834@phlogiston.dyndns.org>
	<200708271630.29601.lists_slony1-general@avsupport.com>
Message-ID: <20070827213413.GC30834@phlogiston.dyndns.org>

On Mon, Aug 27, 2007 at 04:30:29PM -0500, Dan Falconer wrote:

> have no idea what causes it.  Going with the suggestions of David Rees, I 
> stopped slons & ran some vacuums: on each server, I vacuumed every time I 
> found within the "_pl_replication" schema.  At most, the vacuums took 30 
> seconds to run, and I saw nothing terrible in regards to the number of rows 
> removed, rows that couldn't be removed, etc.

Hrm.  Did it recover any dead tuples at all?  And what about the main
database?  Remember, slony has to find the rows to update and delete. 
Those are rows in the _replicated_ tables.  Are transactions running
long on your targets?

A

-- 
Andrew Sullivan  | ajs@crankycanuck.ca
When my information changes, I alter my conclusions.  What do you do sir?
		--attr. John Maynard Keynes
From ajs at crankycanuck.ca  Mon Aug 27 14:36:42 2007
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Mon Aug 27 14:36:58 2007
Subject: [Slony1-general] Determine how many items in log belong to an
	event...?
In-Reply-To: <200708271630.29601.lists_slony1-general@avsupport.com>
References: <200708151552.48987.lists_slony1-general@avsupport.com>
	<200708271600.50734.lists_slony1-general@avsupport.com>
	<20070827211401.GA30834@phlogiston.dyndns.org>
	<200708271630.29601.lists_slony1-general@avsupport.com>
Message-ID: <20070827213642.GD30834@phlogiston.dyndns.org>

Hold on,

On Mon, Aug 27, 2007 at 04:30:29PM -0500, Dan Falconer wrote:

> 2007-08-27 16:23:15 CDT DEBUG2 remoteWorkerThread_1: no sets need syncing for this event

It seems to think there's no work to do.  Something is up, but I'm
boggled as to what.

A


-- 
Andrew Sullivan  | ajs@crankycanuck.ca
A certain description of men are for getting out of debt, yet are
against all taxes for raising money to pay it off.
		--Alexander Hamilton
From drees76 at gmail.com  Mon Aug 27 14:42:44 2007
From: drees76 at gmail.com (David Rees)
Date: Mon Aug 27 14:42:55 2007
Subject: [Slony1-general] Determine how many items in log belong to an
	event...?
In-Reply-To: <200708271630.29601.lists_slony1-general@avsupport.com>
References: <200708151552.48987.lists_slony1-general@avsupport.com>
	<200708271600.50734.lists_slony1-general@avsupport.com>
	<20070827211401.GA30834@phlogiston.dyndns.org>
	<200708271630.29601.lists_slony1-general@avsupport.com>
Message-ID: <72dbd3150708271442t57ca3ab7q9f696faf7efed27b@mail.gmail.com>

On 8/27/07, Dan Falconer <lists_slony1-general@avsupport.com> wrote:
> I believe that SYNCs are getting through, but some insight into the log files
> to clarify would be great.  I've attached log files for roughly the same
> period of time for both the master & slave.

Looks like things are running, but I would expect the number of rows
synced up to be much larger. The log snippet of the slave log only
synced 23 rows, and it took it 2 minutes to do so. No wonder it's not
catching up!

Increase the max sync group size to something much larger, say 500 or
so. Also, can you get a larger snippet from the slave's log file?

> Also, when I restarted the slons, I get notices printed to the console (instead of a log file)
> indicating that the switch from log_1 to log_2 failed... help?

I believe that this is normal when you have a backlog. The logs can
only switch once you've caught up.

-Dave
From lists_slony1-general at avsupport.com  Mon Aug 27 15:14:40 2007
From: lists_slony1-general at avsupport.com (Dan Falconer)
Date: Mon Aug 27 15:14:56 2007
Subject: [Slony1-general] Determine how many items in log belong to an
	event...?
In-Reply-To: <20070827213642.GD30834@phlogiston.dyndns.org>
References: <200708151552.48987.lists_slony1-general@avsupport.com>
	<200708271630.29601.lists_slony1-general@avsupport.com>
	<20070827213642.GD30834@phlogiston.dyndns.org>
Message-ID: <200708271714.40126.lists_slony1-general@avsupport.com>

On Monday 27 August 2007 16:36, Andrew Sullivan wrote:
> Hold on,
>
> On Mon, Aug 27, 2007 at 04:30:29PM -0500, Dan Falconer wrote:
> > 2007-08-27 16:23:15 CDT DEBUG2 remoteWorkerThread_1: no sets need syncing
> > for this event
>
> It seems to think there's no work to do.  Something is up, but I'm
> boggled as to what.


As a note: on 2007-08-22 09:40:37 (during the time that inventories were being 
processed), there were 8115 SYNCs that were processed/queued.  The lines look 
like this::::

2007-08-22 09:40:37 CDT DEBUG2 remoteListenThread_2: queue event 2,68887 SYNC
...
2007-08-22 09:40:37 CDT DEBUG2 remoteListenThread_2: queue event 2,77001 SYNC

Could somebody tell me why what's causing it?
>
> A

-- 
Best Regards,


Dan Falconer
"Head Geek", Avsupport, Inc. / Partslogistics.com
http://www.partslogistics.com
From cbbrowne at ca.afilias.info  Mon Aug 27 15:23:51 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Mon Aug 27 15:24:09 2007
Subject: [Slony1-general] slon sync_group_max_size docs inconsistent
In-Reply-To: <72dbd3150708241225g25f4a65ci7e4aa2be8e5b6eb5@mail.gmail.com>
	(David Rees's message of "Fri, 24 Aug 2007 12:25:03 -0700")
References: <72dbd3150708241225g25f4a65ci7e4aa2be8e5b6eb5@mail.gmail.com>
Message-ID: <60zm0ck45k.fsf@dba2.int.libertyrms.com>

"David Rees" <drees76@gmail.com> writes:
> On 8/24/07, Andrew Sullivan <ajs@crankycanuck.ca> wrote:
>> And yes, when catching up, you want to set the snapshot size _much_
>> larger.
>
> I just found some discrepancies in the sample slon.conf, the admin
> guide and what the actual default, min, max settings for
> sync_group_max_size.
>
> The sample slon.conf indicates that the settings are 6, 0, 100
> (default, min, max)
> But confoptions.c indicates that the settings are 20, 0, 10000
> (default, min, max)
> The admin guide has an incorrect default (same as slon.conf) and
> doesn't mention min/max values.
>
> Perhaps this could be corrected in CVS possibly for the next release?

Corrected & committed...
-- 
(format nil "~S@~S" "cbbrowne" "linuxfinances.info")
http://www3.sympatico.ca/cbbrowne/emacs.html
Rules of the Evil Overlord #133.  "If I find my beautiful consort with
access to  my fortress has been  associating with the  hero, I'll have
her executed.  It's regrettable,  but new consorts  are easier  to get
than new fortresses  and maybe the next one will  pay attention at the
orientation meeting." <http://www.eviloverlord.com/>
From cbbrowne at ca.afilias.info  Mon Aug 27 15:32:32 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Mon Aug 27 15:32:47 2007
Subject: [Slony1-general] Last gasp for 1.2.11...
Message-ID: <60veb0k3r3.fsf@dba2.int.libertyrms.com>

I was able to get all the testing that I usually do done today:
- Ran it on Debian/unstable, IA-32
- Against PostgreSQL versions 7.4, 8.0, 8.1, 8.2, and 8.3, all with success

I'll see about packaging it up tomorrow, barring any failure
reports...
-- 
let name="cbbrowne" and tld="linuxfinances.info" in String.concat "@" [name;tld];;
http://linuxdatabases.info/info/multiplexor.html
Rules  of  the  Evil Overlord  #115.   "I  will  not engage  an  enemy
single-handedly  until all  my soldiers  are dead.   (Which is  a good
point at which to retreat in any case.)"
<http://www.eviloverlord.com/>
From cscetbon.ext at orange-ftgroup.com  Tue Aug 28 02:47:20 2007
From: cscetbon.ext at orange-ftgroup.com (Cyril SCETBON)
Date: Tue Aug 28 02:47:42 2007
Subject: [Slony1-general] Configuration on 2 sites
Message-ID: <46D3EF28.40108@orange-ftgroup.com>

Hi people,

My configuration did not change :-)

I got a [1 Master M1 + 1 Slave S1]. Another Slave S2 points to the 
Master M2 which is slave of M1 as follows :

                                M1(SET=1),ID=1 ------> 
S1(SET=1,ORIGIN=1),ID=2
                                 |
                                 |
                                V
                                M2(SET=1,ORIGIN=1),ID=3 ------> 
S2(SET=1,ORIGIN=3),ID=4

If M2 is down, S2 must replace it. How Can I do this ?
I thought about UNSUBSCRIBE SET=1 + SUBSCRIBE SET=1,ORIGIN=1 but I think 
it will truncate the tables and reimport all the data which will take 
time. Is there a way to tell S2 to replace M2 without retrieving again 
all the data from M1 ? FAILOVER(ID=3,BACKUP NODE=4) ?

thanks

-- 
Cyril SCETBON - Ing?nieur bases de donn?es
AUSY pour France T?l?com - SCR/HDI/DOP/HEBEX

T?l : +33 (0)4 97 12 87 60
Jabber : cscetbon@jabber.org
France Telecom - Orange
790 Avenue du Docteur Maurice Donat 
B?timent Marco Polo C2 
06250 Mougins
France

***********************************
Ce message et toutes les pieces jointes (ci-apres le 'message') sont
confidentiels et etablis a l'intention exclusive de ses destinataires.
Toute utilisation ou diffusion non autorisee est interdite.
Tout message electronique est susceptible d'alteration. Le Groupe France
Telecom decline toute responsabilite au titre de ce message s'il a ete
altere, deforme ou falsifie.
Si vous n'etes pas destinataire de ce message, merci de le detruire
immediatement et d'avertir l'expediteur.
***********************************
This message and any attachments (the 'message') are confidential and
intended solely for the addressees.
Any unauthorised use or dissemination is prohibited.
Messages are susceptible to alteration. France Telecom Group shall not be
liable for the message if altered, changed or falsified.
If you are not recipient of this message, please cancel it immediately and
inform the sender.
************************************

From ajs at crankycanuck.ca  Tue Aug 28 06:22:35 2007
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Tue Aug 28 06:22:45 2007
Subject: [Slony1-general] Configuration on 2 sites
In-Reply-To: <46D3EF28.40108@orange-ftgroup.com>
References: <46D3EF28.40108@orange-ftgroup.com>
Message-ID: <20070828132235.GA461@phlogiston.dyndns.org>

On Tue, Aug 28, 2007 at 11:47:20AM +0200, Cyril SCETBON wrote:
> 
> If M2 is down, S2 must replace it. How Can I do this ?

Just change its origin.  This feature is one of the original design
goals.

A

-- 
Andrew Sullivan  | ajs@crankycanuck.ca
The very definition of "news" is "something that hardly ever happens."	
		--Bruce Schneier
From lists_slony1-general at avsupport.com  Tue Aug 28 06:25:10 2007
From: lists_slony1-general at avsupport.com (Dan Falconer)
Date: Tue Aug 28 06:26:19 2007
Subject: [Slony1-general] Determine how many items in log belong to an
	event...?
In-Reply-To: <72dbd3150708271529w28c97abcwfa0d608c41d53909@mail.gmail.com>
References: <200708151552.48987.lists_slony1-general@avsupport.com>
	<200708271702.14086.lists_slony1-general@avsupport.com>
	<72dbd3150708271529w28c97abcwfa0d608c41d53909@mail.gmail.com>
Message-ID: <200708280825.10843.lists_slony1-general@avsupport.com>

On Monday 27 August 2007 17:29, David Rees wrote:
> On 8/27/07, Dan Falconer <lists_slony1-general@avsupport.com> wrote:
> > After grepping through the logs, I've noticed that the time it takes to
> > complete each sync grows at a fairly regular rate.  I'm not sure what the
> > problem is... here's a couple of logs, and sorry in advance for the size.
>
> If you can get these posted up somewhere where the rest of the slony
> guys can see it, they may have more insight, I'm still relatively new
> to slony myself. :-) I'll browse through the logs as soon as I can.

The logs for my slave database server are available at 
http://www.crazedsanity.com/downloads/_slony_slave.tgz for a while.  If you 
are so inclined, please download and peruse them.  It's about a 2 meg 
download.

Slony is now 6+ days behind on the slave server.  I just upped the max sync 
group size from 25 to 500.  I am hoping that has some significant impact, as 
soon I'm going to have to go through the process of dropping schema and 
re-initializing the whole thing.

For what it's worth, it seems to me that the failed log switch has a lot to do 
with the problem.  I mean, Slony is retrieving all of the events, as the 
slave's log files are fairly massive (sl_log_1=413981, sl_log_2=3935888)... 
or something.  I'm very confused as to where things are breaking down, and I 
just don't know what to look for anymore.  SYNCs are processing, seeming to 
indicate that it's TRYING to work... if somebody could shed light on what to 
look for in the logs, that would be great.  I ran the 
test_slony_state-dbi.pl, which started to give interesting information, but 
suddenly stopped with an error "sh: - : invalid option" when trying to 
show "old open connections".
>
> -Dave

-- 
Best Regards,


Dan Falconer
"Head Geek", Avsupport, Inc. / Partslogistics.com
http://www.partslogistics.com
From cscetbon.ext at orange-ftgroup.com  Tue Aug 28 08:22:23 2007
From: cscetbon.ext at orange-ftgroup.com (Cyril SCETBON)
Date: Tue Aug 28 08:22:32 2007
Subject: [Slony1-general] Configuration on 2 sites
In-Reply-To: <20070828132235.GA461@phlogiston.dyndns.org>
References: <46D3EF28.40108@orange-ftgroup.com>
	<20070828132235.GA461@phlogiston.dyndns.org>
Message-ID: <46D43DAF.5010604@orange-ftgroup.com>



Andrew Sullivan wrote:
> On Tue, Aug 28, 2007 at 11:47:20AM +0200, Cyril SCETBON wrote:
>   
>> If M2 is down, S2 must replace it. How Can I do this ?
>>     
>
> Just change its origin.  This feature is one of the original design
> goals.
>   
How do you make it ? MOVE SET can't do it cause the real Origin of SET 1 
is M1, not M2.
> A
>
>   

-- 
Cyril SCETBON - Ing?nieur bases de donn?es
AUSY pour France T?l?com - SCR/HDI/DOP/HEBEX

T?l : +33 (0)4 97 12 87 60
Jabber : cscetbon@jabber.org
France Telecom - Orange
790 Avenue du Docteur Maurice Donat 
B?timent Marco Polo C2 
06250 Mougins
France

***********************************
Ce message et toutes les pieces jointes (ci-apres le 'message') sont
confidentiels et etablis a l'intention exclusive de ses destinataires.
Toute utilisation ou diffusion non autorisee est interdite.
Tout message electronique est susceptible d'alteration. Le Groupe France
Telecom decline toute responsabilite au titre de ce message s'il a ete
altere, deforme ou falsifie.
Si vous n'etes pas destinataire de ce message, merci de le detruire
immediatement et d'avertir l'expediteur.
***********************************
This message and any attachments (the 'message') are confidential and
intended solely for the addressees.
Any unauthorised use or dissemination is prohibited.
Messages are susceptible to alteration. France Telecom Group shall not be
liable for the message if altered, changed or falsified.
If you are not recipient of this message, please cancel it immediately and
inform the sender.
************************************

From ajs at crankycanuck.ca  Tue Aug 28 08:29:19 2007
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Tue Aug 28 08:29:42 2007
Subject: [Slony1-general] Configuration on 2 sites
In-Reply-To: <46D43DAF.5010604@orange-ftgroup.com>
References: <46D3EF28.40108@orange-ftgroup.com>
	<20070828132235.GA461@phlogiston.dyndns.org>
	<46D43DAF.5010604@orange-ftgroup.com>
Message-ID: <20070828152919.GB979@phlogiston.dyndns.org>

On Tue, Aug 28, 2007 at 05:22:23PM +0200, Cyril SCETBON wrote:
> >Just change its origin.  This feature is one of the original design
> >goals.
> >  
> How do you make it ? MOVE SET can't do it cause the real Origin of SET 1 
> is M1, not M2.

You have to perform FAILOVER.  It means you abandon the node for
good (and have to rebuild it when it comes back).

A

-- 
Andrew Sullivan  | ajs@crankycanuck.ca
This work was visionary and imaginative, and goes to show that visionary
and imaginative work need not end up well. 
		--Dennis Ritchie
From cscetbon.ext at orange-ftgroup.com  Tue Aug 28 08:38:52 2007
From: cscetbon.ext at orange-ftgroup.com (Cyril SCETBON)
Date: Tue Aug 28 08:39:00 2007
Subject: [Slony1-general] Configuration on 2 sites
In-Reply-To: <20070828152919.GB979@phlogiston.dyndns.org>
References: <46D3EF28.40108@orange-ftgroup.com>	<20070828132235.GA461@phlogiston.dyndns.org>	<46D43DAF.5010604@orange-ftgroup.com>
	<20070828152919.GB979@phlogiston.dyndns.org>
Message-ID: <46D4418C.6090802@orange-ftgroup.com>



Andrew Sullivan wrote:
> On Tue, Aug 28, 2007 at 05:22:23PM +0200, Cyril SCETBON wrote:
>   
>>> Just change its origin.  This feature is one of the original design
>>> goals.
>>>  
>>>       
>> How do you make it ? MOVE SET can't do it cause the real Origin of SET 1 
>> is M1, not M2.
>>     
>
> You have to perform FAILOVER.  It means you abandon the node for
> good (and have to rebuild it when it comes back).
>   
Do I have to add path between Origin M1 and S2 too ?
> A
>
>   

-- 
Cyril SCETBON - Ing?nieur bases de donn?es
AUSY pour France T?l?com - SCR/HDI/DOP/HEBEX

T?l : +33 (0)4 97 12 87 60
Jabber : cscetbon@jabber.org
France Telecom - Orange
790 Avenue du Docteur Maurice Donat 
B?timent Marco Polo C2 
06250 Mougins
France

***********************************
Ce message et toutes les pieces jointes (ci-apres le 'message') sont
confidentiels et etablis a l'intention exclusive de ses destinataires.
Toute utilisation ou diffusion non autorisee est interdite.
Tout message electronique est susceptible d'alteration. Le Groupe France
Telecom decline toute responsabilite au titre de ce message s'il a ete
altere, deforme ou falsifie.
Si vous n'etes pas destinataire de ce message, merci de le detruire
immediatement et d'avertir l'expediteur.
***********************************
This message and any attachments (the 'message') are confidential and
intended solely for the addressees.
Any unauthorised use or dissemination is prohibited.
Messages are susceptible to alteration. France Telecom Group shall not be
liable for the message if altered, changed or falsified.
If you are not recipient of this message, please cancel it immediately and
inform the sender.
************************************

From ajs at crankycanuck.ca  Tue Aug 28 09:18:37 2007
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Tue Aug 28 09:18:48 2007
Subject: [Slony1-general] Configuration on 2 sites
In-Reply-To: <46D4418C.6090802@orange-ftgroup.com>
References: <46D3EF28.40108@orange-ftgroup.com>
	<20070828132235.GA461@phlogiston.dyndns.org>
	<46D43DAF.5010604@orange-ftgroup.com>
	<20070828152919.GB979@phlogiston.dyndns.org>
	<46D4418C.6090802@orange-ftgroup.com>
Message-ID: <20070828161837.GA1194@phlogiston.dyndns.org>

On Tue, Aug 28, 2007 at 05:38:52PM +0200, Cyril SCETBON wrote:
> >  
> Do I have to add path between Origin M1 and S2 too ?

I think so, but it may depend on what version you have.  I'd test it
out.  These procedures are ones you want to have well-baked in case
of disaster.

A

-- 
Andrew Sullivan  | ajs@crankycanuck.ca
The plural of anecdote is not data.
		--Roger Brinner
From jamiel at istreamimaging.com  Tue Aug 28 09:31:16 2007
From: jamiel at istreamimaging.com (Jeff Amiel)
Date: Tue Aug 28 09:32:21 2007
Subject: [Slony1-general] FATAL  dropListen: unknown node ID 3
Message-ID: <46D44DD4.8030109@istreamimaging.com>

 little help...I butchered my paths/listens when adding a new node...
 I removed the node/paths...
 but have stale events referring to it.
 and keep getting errors like "FATAL  dropListen: unknown node ID 3"
 any easy way to clear these events out related to the missing node?

From cbbrowne at ca.afilias.info  Tue Aug 28 12:51:52 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Tue Aug 28 12:52:03 2007
Subject: [Slony1-general] Slony-I 1.2.11 released
Message-ID: <608x7vo2sn.fsf@dba2.int.libertyrms.com>

We are pleased to announce general availability of Slony-I 1.2.11.
Note that both sources and documentation are available; see
<http://slony.info/>

Fixes are the following:

    * Add in tools/mkservice scripts previously added to CVS HEAD
    * During subscription, do UPDATE to pg_class.relhasindex *after* the TRUNCATE because, in 8.2+, TRUNCATE resets this attribute
    * Fixed a problem with the setsync tracking with Log Shipping in cases where slon does an internal restart (thereby rereading the pset.ssy_seqno) and ignoring non-SYNC events because those don't change the sl_setsync table.
    * More explicit type casting of text objects for compatibility with PostgreSQL 8.3
    * Fixed problem with DDL SCRIPT statement parser: it wasn't 'quoting' semicolons inside parentheses (this notably occurs in CREATE RULE).
    * Fixed problem with DDL SCRIPT statement submission; it was interpreting the statement as a format string, which would have ill effects in the presence of things that are interpreted such as format strings (%d, %f, %s) and \backslashed things like \\, \n.
    * Further DDL Script issue: non-terminated statement at the end (e.g. - without trailing semicolon ";") would get omitted.
    * Typo fix: when trying to disable a node, the logs would report "enableNode" rather than "disableNode". Fixed.
    * Add usage/version options to help output in slon.
    * Fix archive logging for replicated sequences.
    * Fix to log shipping - added another table, sl_archive_counter where the log writing slon simply tracks when it wrote the last offline archive file and maintains a counter. This counter is now tracked in the offline replica and must increment gap free.
    * Change the filenames of archive logs to be based on internal archive tracking number. This makes it easy for the mechanism applying archives to figure out what needs to be applied next - just look in sl_archive_tracking.
    * Fix log shipping test to accomodate the new tracking scheme, and update documentation to describe this better. 

The testing regimen included running all the tests in the test bed
against instances of Slony-I running against PostgreSQL versions 7.4,
8.0, 8.1, 8.2, as well as CVS HEAD (forthcoming as 8.3). There was
also (against 7.4) a test done to verify that UPGRADE FUNCTIONS would
bring version 1.1.x to 1.2.11.
-- 
let name="cbbrowne" and tld="cbbrowne.com" in String.concat "@" [name;tld];;
http://linuxfinances.info/info/nonrdbms.html
Why  are  they  called   buildings,  when  they're  already  finished?
Shouldn't they be called builts?
From drees76 at gmail.com  Tue Aug 28 12:59:32 2007
From: drees76 at gmail.com (David Rees)
Date: Tue Aug 28 12:59:41 2007
Subject: [Slony1-general] Determine how many items in log belong to an
	event...?
In-Reply-To: <200708280825.10843.lists_slony1-general@avsupport.com>
References: <200708151552.48987.lists_slony1-general@avsupport.com>
	<200708271702.14086.lists_slony1-general@avsupport.com>
	<72dbd3150708271529w28c97abcwfa0d608c41d53909@mail.gmail.com>
	<200708280825.10843.lists_slony1-general@avsupport.com>
Message-ID: <72dbd3150708281259u331bda2eha0048ca2a1d9d644@mail.gmail.com>

On 8/28/07, Dan Falconer <lists_slony1-general@avsupport.com> wrote:
> Slony is now 6+ days behind on the slave server.  I just upped the max sync
> group size from 25 to 500.  I am hoping that has some significant impact, as
> soon I'm going to have to go through the process of dropping schema and
> re-initializing the whole thing.
>
> For what it's worth, it seems to me that the failed log switch has a lot to do
> with the problem.  I mean, Slony is retrieving all of the events, as the
> slave's log files are fairly massive (sl_log_1=413981, sl_log_2=3935888)...
> or something.  I'm very confused as to where things are breaking down, and I
> just don't know what to look for anymore.  SYNCs are processing, seeming to
> indicate that it's TRYING to work... if somebody could shed light on what to
> look for in the logs, that would be great.

Hi Dan, we've already said what the problem is - While SYNCs are
processing, they are taking way too long to keep up with the current
rate of change.

Have you been able to up the debug level to 4 and grab a log snippet
from the slave after bumping up the sync group size?

Have you also tried stopping the slon daemons and doing a vacuum
analyze on the sl_log tables again to see if that speeds up SYNC
processing?

Have you also verified that there are no long running transactions on
the master?

-Dave
From drees76 at gmail.com  Tue Aug 28 13:04:23 2007
From: drees76 at gmail.com (David Rees)
Date: Tue Aug 28 13:04:32 2007
Subject: [Slony1-general] Slony-I 1.2.11 released
In-Reply-To: <608x7vo2sn.fsf@dba2.int.libertyrms.com>
References: <608x7vo2sn.fsf@dba2.int.libertyrms.com>
Message-ID: <72dbd3150708281304j77ae280dkc644ce37aee5a8ae@mail.gmail.com>

On 8/28/07, Christopher Browne <cbbrowne@ca.afilias.info> wrote:
> We are pleased to announce general availability of Slony-I 1.2.11.
> Note that both sources and documentation are available; see
> <http://slony.info/>

Great! Would it be possible to update the documentation on the website
with the latest docs? http://slony.info/documentation/

Thanks,
Dave
From cbbrowne at ca.afilias.info  Tue Aug 28 13:34:15 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Tue Aug 28 13:34:26 2007
Subject: [Slony1-general] Slony-I 1.2.11 released
In-Reply-To: <72dbd3150708281304j77ae280dkc644ce37aee5a8ae@mail.gmail.com>
References: <608x7vo2sn.fsf@dba2.int.libertyrms.com>
	<72dbd3150708281304j77ae280dkc644ce37aee5a8ae@mail.gmail.com>
Message-ID: <46D486C7.7010904@ca.afilias.info>

David Rees wrote:
> On 8/28/07, Christopher Browne <cbbrowne@ca.afilias.info> wrote:
>   
>> We are pleased to announce general availability of Slony-I 1.2.11.
>> Note that both sources and documentation are available; see
>> <http://slony.info/>
>>     
>
> Great! Would it be possible to update the documentation on the website
> with the latest docs? http://slony.info/documentation/
>
> Thanks,
> Dave
>   
Done!
From karl_hennig at yahoo.com  Tue Aug 28 17:16:07 2007
From: karl_hennig at yahoo.com (Karl Hennig)
Date: Tue Aug 28 17:16:20 2007
Subject: [Slony1-general] Replicating multiple schemas
Message-ID: <390954.15283.qm@web34514.mail.mud.yahoo.com>

Hello,

I'm setting up slony to replicate multiple schemas from a single master DB to a single slave DB.  I successfully got one schema to replicate but am having trouble with the second one.

Here's how it's set up:
DB Server #1 (master): holds schema A and schema B
DB Server #2 (slave): holds schema A and schema B

Schema A is replicating as expected but nothing is replicated for schema B.

I tried modifying the tutorial slonik input to add schema B as follows:

cluster name = $CLUSTERNAME;

node 1 admin conninfo = 'dbname=A host=$MASTERHOST user=$REPLICATIONUSER';

node 2 admin conninfo = 'dbname=A_slave host=$SLAVEHOST user=$REPLICATIONUSER';

# new nodes 3 and 4 added for schema B
node 3 admin conninfo = 'dbname=B host=$MASTERHOST user=$REPLICATIONUSER';

node 4 admin conninfo = 'dbname=B_slave host=$SLAVEHOST user=$REPLICATIONUSER';

# init... am I supposed to init a second cluster with the node ID for schema B?
init cluster ( id=1, comment = 'Master Node for A');
init cluster ( id=3, comment = 'Master Node for B');

create set (id=1, origin=1, comment='schema A tables');
# I put id=2 and origin=3 because schema B's set should come from node #3
create set (id=2, origin=3, comment='schema B tables');

set add table (
            set id=1, 
                origin=1, 
                id=1, 
                fully qualified name = 'public.table1', 
                comment='table1 in schema A'
        );

set add table (
            set id=2, 
                origin=3, 
                id=1, 
                fully qualified name = 'public.table1', 
                comment='table1 in schema B'
        );



store node (id=2, comment = 'Slave node for A');
store path (server = 1, client = 2, conninfo='dbname=A host=$MASTERHOST user=$REPLICATIONUSER');
store path (server = 2, client = 1, conninfo='dbname=A_slave host=$SLAVEHOST user=$REPLICATIONUSER');
store listen (origin=1, provider = 1, receiver =2);
store listen (origin=2, provider = 2, receiver =1);


store node (id=4, comment = 'Slave node for B');
store path (server = 3, client = 4, conninfo='dbname=B host=$MASTERHOST user=$REPLICATIONUSER');
store path (server = 4, client = 3, conninfo='dbname=B_slave host=$SLAVEHOST user=$REPLICATIONUSER');
store listen (origin=3, provider=3, receiver=4);
store listen (origin=4, provider=4, receiver=3);


Then I execute the following commands: 

# note I put the same cluster name for both -- I don't know what it should be
slon $CLUSTERNAME "dbname=A user=$REPLICATIONUSER host=$MASTERHOST"
slon $CLUSTERNAME "dbname=A_slave user=$REPLICATIONUSER host=$SLAVEHOST"

slon $CLUSTERNAME "dbname=B user=$REPLICATIONUSER host=$MASTERHOST"

slon $CLUSTERNAME "dbname=B_slave user=$REPLICATIONUSER host=$SLAVEHOST"


Then I start replicating with the following slonik input, modified from the tutorial:

cluster name = $CLUSTERNAME;

node 1 admin conninfo = 'dbname=A host=$MASTERHOST user=$REPLICATIONUSER';
node 2 admin conninfo = 'dbname=A_slave host=$SLAVEHOST user=$REPLICATIONUSER';

node 3 admin conninfo = 'dbname=B host=$MASTERHOST user=$REPLICATIONUSER';
node 4 admin conninfo = 'dbname=B_slave host=$SLAVEHOST user=$REPLICATIONUSER';

subscribe set ( id = 1, provider = 1, receiver = 2, forward = no);
subscribe set ( id = 2, provider = 3, receiver = 4, forward = no);


I'm obviously doing something wrong because only A is being replicated to A_slave.  Is it possible to set up multiple-schema replication?

Thanks for any help.






      ____________________________________________________________________________________
Park yourself in front of a world of choices in alternative vehicles. Visit the Yahoo! Auto Green Center.
http://autos.yahoo.com/green_center/ 
From cscetbon.ext at orange-ftgroup.com  Wed Aug 29 02:17:24 2007
From: cscetbon.ext at orange-ftgroup.com (Cyril SCETBON)
Date: Wed Aug 29 02:17:47 2007
Subject: [Slony1-general] Configuration on 2 sites
In-Reply-To: <20070828152919.GB979@phlogiston.dyndns.org>
References: <46D3EF28.40108@orange-ftgroup.com>	<20070828132235.GA461@phlogiston.dyndns.org>	<46D43DAF.5010604@orange-ftgroup.com>
	<20070828152919.GB979@phlogiston.dyndns.org>
Message-ID: <46D539A4.9020601@orange-ftgroup.com>



Andrew Sullivan wrote:
> On Tue, Aug 28, 2007 at 05:22:23PM +0200, Cyril SCETBON wrote:
>   
>>> Just change its origin.  This feature is one of the original design
>>> goals.
>>>  
>>>       
>> How do you make it ? MOVE SET can't do it cause the real Origin of SET 1 
>> is M1, not M2.
>>     
>
> You have to perform FAILOVER.  It means you abandon the node for
> good (and have to rebuild it when it comes back).
>   
In order to not break my configuration I'm reshaping subscription from 
S2 (node 4) to M1 (node 1), but
something weird is happening :

If I stop slon on node M2 and insert one line in a table on M1 before 
reshaping subscription from S2, S2 does not resync with M1 :-(

See it :

psql db1 -c 'select * from "_CLUSTER1".sl_subscribe'
 sub_set | sub_provider | sub_receiver | sub_forward | sub_active
---------+--------------+--------------+-------------+------------
       1 |            1 |            3 | t           | t
       1 |            1 |            2 | t           | t
       1 |            3 |            4 | t           | t

kill slon on M2 (provider=3)

db1=# INSERT INTO t1 
VALUES('DLJIEXKBQNMFLLTYLPYVXKFYFWXWGWIJRFNQRGIOLIDRSSNOZLWLHL');

provider=1=db1

reshaping subscriptions from s2 to M1 (with command subscribe set)

psql db1 -c 'select * from "_CLUSTER1".sl_subscribe'
 sub_set | sub_provider | sub_receiver | sub_forward | sub_active
---------+--------------+--------------+-------------+------------
       1 |            1 |            3 | t           | t
       1 |            1 |            2 | t           | t
       1 |            1 |            4 | t           | t

for i in `seq 1 4`; do echo db$i - `psql db$i -c 'select count(1) from 
t1'|grep -v [a-zA-Z]`; done
db1 - -------- 210037
db2 - -------- 210037
db3 - -------- 210036
db4 - -------- 210036

if I restart slon on node 3 everything works better :-(

for i in `seq 1 4`; do echo db$i - `psql db$i -c 'select count(1) from 
t1'|grep -v [a-zA-Z]`; donedb1 - -------- 210037
db2 - -------- 210037
db3 - -------- 210037
db4 - -------- 210037

I was thinking that as provider 1 didn't receive confirm from node 3 
(and of course from node 4) it will resend it to node 4 when node 4 
subscribe to provider 1. And if it's not, node 4 should resync with 
provider 1 to see if it missed events ?

Any explanation ? Is it a BUG ?


> A
>
>   

-- 
Cyril SCETBON - Ing?nieur bases de donn?es
AUSY pour France T?l?com - SCR/HDI/DOP/HEBEX

T?l : +33 (0)4 97 12 87 60
Jabber : cscetbon@jabber.org
France Telecom - Orange
790 Avenue du Docteur Maurice Donat 
B?timent Marco Polo C2 
06250 Mougins
France

***********************************
Ce message et toutes les pieces jointes (ci-apres le 'message') sont
confidentiels et etablis a l'intention exclusive de ses destinataires.
Toute utilisation ou diffusion non autorisee est interdite.
Tout message electronique est susceptible d'alteration. Le Groupe France
Telecom decline toute responsabilite au titre de ce message s'il a ete
altere, deforme ou falsifie.
Si vous n'etes pas destinataire de ce message, merci de le detruire
immediatement et d'avertir l'expediteur.
***********************************
This message and any attachments (the 'message') are confidential and
intended solely for the addressees.
Any unauthorised use or dissemination is prohibited.
Messages are susceptible to alteration. France Telecom Group shall not be
liable for the message if altered, changed or falsified.
If you are not recipient of this message, please cancel it immediately and
inform the sender.
************************************

From trinaths at intoto.com  Wed Aug 29 03:22:49 2007
From: trinaths at intoto.com (Trinath Somanchi)
Date: Wed Aug 29 03:23:12 2007
Subject: [Slony1-general] Version 1.2.11 now available
Message-ID: <46D548F9.2070608@intoto.com>

Hi ,

Is this release an  Release candidate or an PORDUCTION Release .

Best regards,
-- =

Trinath Somanchi .

***************************************************************************=
*****
This email message (including any attachments) is for the sole use of the i=
ntended recipient(s) =

and may contain confidential, proprietary and privileged information. Any u=
nauthorized review, =

use, disclosure or distribution is prohibited. If you are not the intended =
recipient, =

please immediately notify the sender by reply email and destroy all copies =
of the original message. =

Thank you.
 =

Intoto Inc. =


-------------- next part --------------
A non-text attachment was scrubbed...
Name: trinaths.vcf
Type: text/x-vcard
Size: 316 bytes
Desc: not available
Url : http://lists.slony.info/pipermail/slony1-general/attachments/20070829=
/3875c9d7/trinaths.vcf
From ajs at crankycanuck.ca  Wed Aug 29 07:44:22 2007
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Wed Aug 29 07:44:40 2007
Subject: [Slony1-general] Version 1.2.11 now available
In-Reply-To: <46D548F9.2070608@intoto.com>
References: <46D548F9.2070608@intoto.com>
Message-ID: <20070829144422.GK4183@phlogiston.dyndns.org>

On Wed, Aug 29, 2007 at 03:52:49PM +0530, Trinath Somanchi wrote:
> Hi ,
> 
> Is this release an  Release candidate or an PORDUCTION Release .

If it doesn't have RC in the name, it's a release.  We don't have
non-production releases.

That said, the project is young, and there is a history of nasty bugs
in it.  Please test thoroughly before deploying.

A

-- 
Andrew Sullivan  | ajs@crankycanuck.ca
Users never remark, "Wow, this software may be buggy and hard 
to use, but at least there is a lot of code underneath."
		--Damien Katz
From cbbrowne at ca.afilias.info  Wed Aug 29 08:02:49 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Wed Aug 29 08:02:58 2007
Subject: [Slony1-general] Version 1.2.11 now available
In-Reply-To: <20070829144422.GK4183@phlogiston.dyndns.org>
References: <46D548F9.2070608@intoto.com>
	<20070829144422.GK4183@phlogiston.dyndns.org>
Message-ID: <46D58A99.4070303@ca.afilias.info>

Andrew Sullivan wrote:
> On Wed, Aug 29, 2007 at 03:52:49PM +0530, Trinath Somanchi wrote:
>   
>> Hi ,
>>
>> Is this release an  Release candidate or an PORDUCTION Release .
>>     
>
> If it doesn't have RC in the name, it's a release.  We don't have
> non-production releases.
>
>   
We have fairly frequently been doing "pre-releases" with "pre" in the 
name, as opposed to having "RC" in the name.

That happened with both 1.2.10 and 1.2.11, where we knew there were some 
"sore spots," and it was actually fully expected that the "pre" versions 
would change before becoming production.

But it's fair to say three things:

- A release is a release; we don't let one out if it is known *not* to 
resolve some known bug. 

That's why there has been a fair amount of time between releases in the 
1.2 series, lately; there have been some bugs found that took some 
searching to properly "seek and destroy."

- Replication, as a distributed application, is highly susceptible to 
race conditions, and is an application of above-average complexity, with 
the result that sometimes bugs do linger for a time before being 
discovered.  If you look at the release notes in the 1.2 branch, you'll 
see that a whole lot of (generally small, often unlikely-to-bite) 
problems have been found and dealt with.

We obviously can't guarantee that there aren't still some bugs lurking 
out there.  However, there's a third thing to say...

- While we don't know that there isn't some lurking bug, 1.2.11 *does* 
have resolutions to all the issues found in earlier versions in the 
branch, and thus may be reasonably expected to be the "best" version 
that we have had, so far.
> That said, the project is young, and there is a history of nasty bugs
> in it.  Please test thoroughly before deploying.
>
> A
>
>   
I don't expect 1.2.11 to have introduced any new platform dependencies 
(caveat: except in the code that implements log shipping *testing*), but 
there weren't many reports in about how well it ran on a diverse set of 
platforms.  So if you're not running Debian (where I tested it), or 
whatever version of FreeBSD Jan is running, then the guarantees are a 
bit weaker than I'd like to offer. 

Certainly you should test it thoroughly before deploying it, as Andrew 
suggests.  That's particularly important if you're new to it; there are 
doubtless some "sharp edges" here and there that may 'bite' you, and I'm 
specifically not competent anymore to notice them ;-).  Practicing in a 
test environment can show you what to watch out for in production.

And if you notice any "sharp edges" that are not commented on in the 
documentation, let us know.  They may be:
a) Fixable problems, that don't need to be "sharp edges," or
b) Something that others ought to be aware of.
From dmitry at koterov.ru  Wed Aug 29 08:21:16 2007
From: dmitry at koterov.ru (Dmitry Koterov)
Date: Wed Aug 29 08:21:24 2007
Subject: [Slony1-general] Bug in slonik SQL parser: comments are not removed
	properly
Message-ID: <d7df81620708290821p38284405uc095f811740132c8@mail.gmail.com>

Hello.

I feed the followind DDL SQL code to slonik:

=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D
-- Execute all schema changes.
SET statement_timeout TO 0;

/*
select count(distinct person_id)
from
    person
    join dictionary on dic_category_id=3D11
    left join person_settings on ps_person_id=3Dperson_id and ps_did=3Ddic_=
id
where
    ps_person_id is null
-- only 9000!
*/

CREATE SEQUENCE "public"."obj_setting_os_id_seq"
    INCREMENT 1  MINVALUE 1
    MAXVALUE 9223372036854775807  START 1
    CACHE 1;
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D

But I see that ALL DDL code below the comment is removed, not only the
comment:

DDL Statement 0: (0,99) [
                    -- Execute all schema changes.
                    SET statement_timeout TO 0;]
Submit DDL Event to subscribers...
DDL on origin - PGRES_TUPLES_OK

Seems slonik & others parser parses SQL code incorrectly - skips everything
after a multi-line comment.
Please fix this in a new version...
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070829/=
feefc67d/attachment.htm
From dmitry at koterov.ru  Wed Aug 29 08:40:07 2007
From: dmitry at koterov.ru (Dmitry Koterov)
Date: Wed Aug 29 08:40:14 2007
Subject: [Slony1-general] Bug in remote_worker.c (typo)
Message-ID: <d7df81620708290840s6e758e13q6a013b97582d4ee1@mail.gmail.com>

Hello.

Here:

                        slon_log(SLON_ERROR, "remoteWorkerThread_%d: DDL
preparation failed - set %d - only on node %\n",
                             node->no_id, ddl_setid, ddl_only_on_node);

Seems your forgot "d" after a "%" at the end: need "%d" -

                        slon_log(SLON_ERROR, "remoteWorkerThread_%d: DDL
preparation failed - set %d - only on node %d\n",
                             node->no_id, ddl_setid, ddl_only_on_node);

Please fix it in a new version.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070829/=
9b068ea5/attachment.htm
From mpartio at gmail.com  Wed Aug 29 08:46:56 2007
From: mpartio at gmail.com (Mikko Partio)
Date: Wed Aug 29 08:47:01 2007
Subject: [Slony1-general] Replicating multiple schemas
In-Reply-To: <390954.15283.qm@web34514.mail.mud.yahoo.com>
References: <390954.15283.qm@web34514.mail.mud.yahoo.com>
Message-ID: <2ca799770708290846w6cc66ecbsde9d51789cd7d287@mail.gmail.com>

On 8/29/07, Karl Hennig <karl_hennig@yahoo.com> wrote:
>
> Hello,
>
> I'm setting up slony to replicate multiple schemas from a single master DB
> to a single slave DB.  I successfully got one schema to replicate but am
> having trouble with the second one.



You seem to have mixed up databases and schemas:

Here's how it's set up:
> DB Server #1 (master): holds schema A and schema B
> DB Server #2 (slave): holds schema A and schema B
>
> Schema A is replicating as expected but nothing is replicated for schema
> B.
>
> I tried modifying the tutorial slonik input to add schema B as follows:
>
> cluster name =3D $CLUSTERNAME;
>
> node 1 admin conninfo =3D 'dbname=3DA host=3D$MASTERHOST user=3D$REPLICAT=
IONUSER';
>
> node 2 admin conninfo =3D 'dbname=3DA_slave host=3D$SLAVEHOST
> user=3D$REPLICATIONUSER';
>
> # new nodes 3 and 4 added for schema B
> node 3 admin conninfo =3D 'dbname=3DB host=3D$MASTERHOST user=3D$REPLICAT=
IONUSER';
>
> node 4 admin conninfo =3D 'dbname=3DB_slave host=3D$SLAVEHOST
> user=3D$REPLICATIONUSER';



Nodes 3 and 4 are not needed since both schemas are in the same database.


# init... am I supposed to init a second cluster with the node ID for schema
> B?
> init cluster ( id=3D1, comment =3D 'Master Node for A');
> init cluster ( id=3D3, comment =3D 'Master Node for B');
>
> create set (id=3D1, origin=3D1, comment=3D'schema A tables');
> # I put id=3D2 and origin=3D3 because schema B's set should come from nod=
e #3
> create set (id=3D2, origin=3D3, comment=3D'schema B tables');
>
> set add table (
>             set id=3D1,
>                 origin=3D1,
>                 id=3D1,
>                 fully qualified name =3D 'public.table1',
>                 comment=3D'table1 in schema A'
>         );
>
> set add table (
>             set id=3D2,
>                 origin=3D3,
>                 id=3D1,
>                 fully qualified name =3D 'public.table1',
>                 comment=3D'table1 in schema B'
>         );



Both tables here are at the same schema (public). Just specify the schema in
the set add table, eg.

set add table (
            set id=3D1,
                origin=3D1,
                id=3D1,
                fully qualified name =3D 'schemaA.table1',
                comment=3D'table1 in schema A'
        );

and


set add table (
            set id=3D2,
                origin=3D1,
                id=3D2,
                fully qualified name =3D 'schemaB.table1',
                comment=3D'table1 in schema B'
        );


Regards

MP
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070829/=
c4bcefe0/attachment.htm
From cscetbon.ext at orange-ftgroup.com  Wed Aug 29 10:10:14 2007
From: cscetbon.ext at orange-ftgroup.com (Cyril SCETBON)
Date: Wed Aug 29 10:10:25 2007
Subject: [Slony1-general] Configuration on 2 sites
In-Reply-To: <46D539A4.9020601@orange-ftgroup.com>
References: <46D3EF28.40108@orange-ftgroup.com>	<20070828132235.GA461@phlogiston.dyndns.org>	<46D43DAF.5010604@orange-ftgroup.com>	<20070828152919.GB979@phlogiston.dyndns.org>
	<46D539A4.9020601@orange-ftgroup.com>
Message-ID: <46D5A876.6020607@orange-ftgroup.com>

any idea ?

Cyril SCETBON wrote:
>
>
> Andrew Sullivan wrote:
>> On Tue, Aug 28, 2007 at 05:22:23PM +0200, Cyril SCETBON wrote:
>>  
>>>> Just change its origin.  This feature is one of the original design
>>>> goals.
>>>>  
>>>>       
>>> How do you make it ? MOVE SET can't do it cause the real Origin of 
>>> SET 1 is M1, not M2.
>>>     
>>
>> You have to perform FAILOVER.  It means you abandon the node for
>> good (and have to rebuild it when it comes back).
>>   
> In order to not break my configuration I'm reshaping subscription from 
> S2 (node 4) to M1 (node 1), but
> something weird is happening :
>
> If I stop slon on node M2 and insert one line in a table on M1 before 
> reshaping subscription from S2, S2 does not resync with M1 :-(
>
> See it :
>
> psql db1 -c 'select * from "_CLUSTER1".sl_subscribe'
> sub_set | sub_provider | sub_receiver | sub_forward | sub_active
> ---------+--------------+--------------+-------------+------------
>       1 |            1 |            3 | t           | t
>       1 |            1 |            2 | t           | t
>       1 |            3 |            4 | t           | t
>
> kill slon on M2 (provider=3)
>
> db1=# INSERT INTO t1 
> VALUES('DLJIEXKBQNMFLLTYLPYVXKFYFWXWGWIJRFNQRGIOLIDRSSNOZLWLHL');
>
> provider=1=db1
>
> reshaping subscriptions from s2 to M1 (with command subscribe set)
>
> psql db1 -c 'select * from "_CLUSTER1".sl_subscribe'
> sub_set | sub_provider | sub_receiver | sub_forward | sub_active
> ---------+--------------+--------------+-------------+------------
>       1 |            1 |            3 | t           | t
>       1 |            1 |            2 | t           | t
>       1 |            1 |            4 | t           | t
>
> for i in `seq 1 4`; do echo db$i - `psql db$i -c 'select count(1) from 
> t1'|grep -v [a-zA-Z]`; done
> db1 - -------- 210037
> db2 - -------- 210037
> db3 - -------- 210036
> db4 - -------- 210036
>
> if I restart slon on node 3 everything works better :-(
>
> for i in `seq 1 4`; do echo db$i - `psql db$i -c 'select count(1) from 
> t1'|grep -v [a-zA-Z]`; donedb1 - -------- 210037
> db2 - -------- 210037
> db3 - -------- 210037
> db4 - -------- 210037
>
> I was thinking that as provider 1 didn't receive confirm from node 3 
> (and of course from node 4) it will resend it to node 4 when node 4 
> subscribe to provider 1. And if it's not, node 4 should resync with 
> provider 1 to see if it missed events ?
>
> Any explanation ? Is it a BUG ?
>
>
>> A
>>
>>   
>

-- 
Cyril SCETBON - Ing?nieur bases de donn?es
AUSY pour France T?l?com - SCR/HDI/DOP/HEBEX

T?l : +33 (0)4 97 12 87 60
Jabber : cscetbon@jabber.org
France Telecom - Orange
790 Avenue du Docteur Maurice Donat 
B?timent Marco Polo C2 
06250 Mougins
France

***********************************
Ce message et toutes les pieces jointes (ci-apres le 'message') sont
confidentiels et etablis a l'intention exclusive de ses destinataires.
Toute utilisation ou diffusion non autorisee est interdite.
Tout message electronique est susceptible d'alteration. Le Groupe France
Telecom decline toute responsabilite au titre de ce message s'il a ete
altere, deforme ou falsifie.
Si vous n'etes pas destinataire de ce message, merci de le detruire
immediatement et d'avertir l'expediteur.
***********************************
This message and any attachments (the 'message') are confidential and
intended solely for the addressees.
Any unauthorised use or dissemination is prohibited.
Messages are susceptible to alteration. France Telecom Group shall not be
liable for the message if altered, changed or falsified.
If you are not recipient of this message, please cancel it immediately and
inform the sender.
************************************

From ajs at crankycanuck.ca  Wed Aug 29 10:45:09 2007
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Wed Aug 29 10:45:42 2007
Subject: [Slony1-general] Configuration on 2 sites
In-Reply-To: <46D539A4.9020601@orange-ftgroup.com>
References: <46D3EF28.40108@orange-ftgroup.com>
	<20070828132235.GA461@phlogiston.dyndns.org>
	<46D43DAF.5010604@orange-ftgroup.com>
	<20070828152919.GB979@phlogiston.dyndns.org>
	<46D539A4.9020601@orange-ftgroup.com>
Message-ID: <20070829174509.GR4183@phlogiston.dyndns.org>

On Wed, Aug 29, 2007 at 11:17:24AM +0200, Cyril SCETBON wrote:
> 
> If I stop slon on node M2 and insert one line in a table on M1 before 
> reshaping subscription from S2, S2 does not resync with M1 :-(

You mean you stop the slon, insert, try to reshape?  You can't do it
that way.  The slons need to be up to reshape paths.

Have a look also at the data in sl_listen.

A

-- 
Andrew Sullivan  | ajs@crankycanuck.ca
The fact that technology doesn't work is no bar to success in the marketplace.
		--Philip Greenspun
From cscetbon.ext at orange-ftgroup.com  Wed Aug 29 10:51:18 2007
From: cscetbon.ext at orange-ftgroup.com (Cyril SCETBON)
Date: Wed Aug 29 10:51:29 2007
Subject: [Slony1-general] Configuration on 2 sites
In-Reply-To: <20070829174509.GR4183@phlogiston.dyndns.org>
References: <46D3EF28.40108@orange-ftgroup.com>	<20070828132235.GA461@phlogiston.dyndns.org>	<46D43DAF.5010604@orange-ftgroup.com>	<20070828152919.GB979@phlogiston.dyndns.org>	<46D539A4.9020601@orange-ftgroup.com>
	<20070829174509.GR4183@phlogiston.dyndns.org>
Message-ID: <46D5B216.2010708@orange-ftgroup.com>



Andrew Sullivan wrote:
> On Wed, Aug 29, 2007 at 11:17:24AM +0200, Cyril SCETBON wrote:
>   
>> If I stop slon on node M2 and insert one line in a table on M1 before 
>> reshaping subscription from S2, S2 does not resync with M1 :-(
>>     
>
> You mean you stop the slon, insert, try to reshape?  You can't do it
> that way.  The slons need to be up to reshape paths.
>   
So, How can I do if M2 is lost ? Cause I don't want S2 to resync with M1 
from scratch
> Have a look also at the data in sl_listen.
>
> A
>
>   

-- 
Cyril SCETBON - Ing?nieur bases de donn?es
AUSY pour France T?l?com - SCR/HDI/DOP/HEBEX

T?l : +33 (0)4 97 12 87 60
Jabber : cscetbon@jabber.org
France Telecom - Orange
790 Avenue du Docteur Maurice Donat 
B?timent Marco Polo C2 
06250 Mougins
France

***********************************
Ce message et toutes les pieces jointes (ci-apres le 'message') sont
confidentiels et etablis a l'intention exclusive de ses destinataires.
Toute utilisation ou diffusion non autorisee est interdite.
Tout message electronique est susceptible d'alteration. Le Groupe France
Telecom decline toute responsabilite au titre de ce message s'il a ete
altere, deforme ou falsifie.
Si vous n'etes pas destinataire de ce message, merci de le detruire
immediatement et d'avertir l'expediteur.
***********************************
This message and any attachments (the 'message') are confidential and
intended solely for the addressees.
Any unauthorised use or dissemination is prohibited.
Messages are susceptible to alteration. France Telecom Group shall not be
liable for the message if altered, changed or falsified.
If you are not recipient of this message, please cancel it immediately and
inform the sender.
************************************

From ajs at crankycanuck.ca  Wed Aug 29 11:05:50 2007
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Wed Aug 29 11:06:03 2007
Subject: [Slony1-general] Configuration on 2 sites
In-Reply-To: <46D5B216.2010708@orange-ftgroup.com>
References: <46D3EF28.40108@orange-ftgroup.com>
	<20070828132235.GA461@phlogiston.dyndns.org>
	<46D43DAF.5010604@orange-ftgroup.com>
	<20070828152919.GB979@phlogiston.dyndns.org>
	<46D539A4.9020601@orange-ftgroup.com>
	<20070829174509.GR4183@phlogiston.dyndns.org>
	<46D5B216.2010708@orange-ftgroup.com>
Message-ID: <20070829180550.GT4183@phlogiston.dyndns.org>

On Wed, Aug 29, 2007 at 07:51:18PM +0200, Cyril SCETBON wrote:
> So, How can I do if M2 is lost ? Cause I don't want S2 to resync with M1 
> from scratch

You can't.  If you can't co-ordinate a switchover, then you lose the
node.  This is discussed at length in the manual.

A

-- 
Andrew Sullivan  | ajs@crankycanuck.ca
When my information changes, I alter my conclusions.  What do you do sir?
		--attr. John Maynard Keynes
From cscetbon.ext at orange-ftgroup.com  Wed Aug 29 11:40:04 2007
From: cscetbon.ext at orange-ftgroup.com (Cyril SCETBON)
Date: Wed Aug 29 11:40:16 2007
Subject: [Slony1-general] Configuration on 2 sites
In-Reply-To: <20070829180550.GT4183@phlogiston.dyndns.org>
References: <46D3EF28.40108@orange-ftgroup.com>
	<20070828132235.GA461@phlogiston.dyndns.org>
	<46D43DAF.5010604@orange-ftgroup.com>
	<20070828152919.GB979@phlogiston.dyndns.org>
	<46D539A4.9020601@orange-ftgroup.com>
	<20070829174509.GR4183@phlogiston.dyndns.org>
	<46D5B216.2010708@orange-ftgroup.com>
	<20070829180550.GT4183@phlogiston.dyndns.org>
Message-ID: <46D5BD84.8090302@orange-ftgroup.com>



Andrew Sullivan wrote:
> On Wed, Aug 29, 2007 at 07:51:18PM +0200, Cyril SCETBON wrote:
>   
>> So, How can I do if M2 is lost ? Cause I don't want S2 to resync with M1 
>> from scratch
>>     
>
> You can't.  If you can't co-ordinate a switchover, then you lose the
> node.  This is discussed at length in the manual.
>   
Really ????
Are you really saying that losing M2 make me lose S2 ?????
If it's true I'm really disappointed by slony :-(

My config is as follows (just to remember) :

psql db1 -c 'select * from "_CLUSTER1".sl_subscribe'
sub_set | sub_provider | sub_receiver | sub_forward | sub_active
---------+--------------+--------------+-------------+------------
      1 |            1 (M1)|            3 (M2)| t           | t
      1 |            1 (M1)|            2 (S1) | t           | t
      1 |            3 (M2)|            4 (S2) | t           | t

Regards
> A
>
>   

-- 
Cyril SCETBON - Ing?nieur bases de donn?es
AUSY pour France T?l?com - SCR/HDI/DOP/HEBEX

T?l : +33 (0)4 97 12 87 60
Jabber : cscetbon@jabber.org
France Telecom - Orange
790 Avenue du Docteur Maurice Donat 
B?timent Marco Polo C2 
06250 Mougins
France

***********************************
Ce message et toutes les pieces jointes (ci-apres le 'message') sont
confidentiels et etablis a l'intention exclusive de ses destinataires.
Toute utilisation ou diffusion non autorisee est interdite.
Tout message electronique est susceptible d'alteration. Le Groupe France
Telecom decline toute responsabilite au titre de ce message s'il a ete
altere, deforme ou falsifie.
Si vous n'etes pas destinataire de ce message, merci de le detruire
immediatement et d'avertir l'expediteur.
***********************************
This message and any attachments (the 'message') are confidential and
intended solely for the addressees.
Any unauthorised use or dissemination is prohibited.
Messages are susceptible to alteration. France Telecom Group shall not be
liable for the message if altered, changed or falsified.
If you are not recipient of this message, please cancel it immediately and
inform the sender.
************************************

From dmitry at koterov.ru  Wed Aug 29 11:52:58 2007
From: dmitry at koterov.ru (Dmitry Koterov)
Date: Wed Aug 29 11:53:08 2007
Subject: [Slony1-general] Re: Bug in slonik SQL parser: comments are not
	removed properly
In-Reply-To: <d7df81620708290821p38284405uc095f811740132c8@mail.gmail.com>
References: <d7df81620708290821p38284405uc095f811740132c8@mail.gmail.com>
Message-ID: <d7df81620708291152s6d1ce8aaqe87c04be8a462af4@mail.gmail.com>

And much worse - seems such DDL with comments breaks the whole replication
(fortunately I have run it on a test server, not in production).
I watched sl_event table on a subscriber and noticed that the whole DDL
(with comments included) are passed and saved in the subscriber.


On 8/29/07, Dmitry Koterov <dmitry@koterov.ru> wrote:
>
> Hello.
>
> I feed the followind DDL SQL code to slonik:
>
> =3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D
> -- Execute all schema changes.
> SET statement_timeout TO 0;
>
> /*
> select count(distinct person_id)
> from
>     person
>     join dictionary on dic_category_id=3D11
>     left join person_settings on ps_person_id=3Dperson_id and ps_did=3Ddi=
c_id
> where
>     ps_person_id is null
> -- only 9000!
> */
>
> CREATE SEQUENCE "public"."obj_setting_os_id_seq"
>     INCREMENT 1  MINVALUE 1
>     MAXVALUE 9223372036854775807  START 1
>     CACHE 1;
> =3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D
>
> But I see that ALL DDL code below the comment is removed, not only the
> comment:
>
> DDL Statement 0: (0,99) [
>                     -- Execute all schema changes.
>                     SET statement_timeout TO 0;]
> Submit DDL Event to subscribers...
> DDL on origin - PGRES_TUPLES_OK
>
> Seems slonik & others parser parses SQL code incorrectly - skips
> everything after a multi-line comment.
> Please fix this in a new version...
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070829/=
caf6f213/attachment.htm
From wmoran at collaborativefusion.com  Wed Aug 29 13:41:03 2007
From: wmoran at collaborativefusion.com (Bill Moran)
Date: Wed Aug 29 13:41:20 2007
Subject: Packaging for FreeBSD (was Re: [Slony1-general] Slony-I 1.2.11
	released)
In-Reply-To: <608x7vo2sn.fsf@dba2.int.libertyrms.com>
References: <608x7vo2sn.fsf@dba2.int.libertyrms.com>
Message-ID: <20070829164103.979f5358.wmoran@collaborativefusion.com>


Anyone started on updating the port for FreeBSD yet?

Can we have the rc script developed by my cohort, Brian Seklecki, be
the default installed on FreeBSD.  It behaves exactly the same as
the previous rc script, unless slon_profiles is enabled, in which
case it allows the administrator to configure profiles that automatically
start multiple slons with different configurations.

-- 
Bill Moran
Collaborative Fusion Inc.
http://people.collaborativefusion.com/~wmoran/

wmoran@collaborativefusion.com
Phone: 412-422-3463x4023
From JanWieck at Yahoo.com  Thu Aug 30 08:22:52 2007
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Thu Aug 30 08:23:04 2007
Subject: [Slony1-general] Determine how many items in log belong to an
	event...?
In-Reply-To: <72dbd3150708271442t57ca3ab7q9f696faf7efed27b@mail.gmail.com>
References: <200708151552.48987.lists_slony1-general@avsupport.com>	<200708271600.50734.lists_slony1-general@avsupport.com>	<20070827211401.GA30834@phlogiston.dyndns.org>	<200708271630.29601.lists_slony1-general@avsupport.com>
	<72dbd3150708271442t57ca3ab7q9f696faf7efed27b@mail.gmail.com>
Message-ID: <46D6E0CC.3010507@Yahoo.com>

On 8/27/2007 5:42 PM, David Rees wrote:
> On 8/27/07, Dan Falconer <lists_slony1-general@avsupport.com> wrote:
>> I believe that SYNCs are getting through, but some insight into the log files
>> to clarify would be great.  I've attached log files for roughly the same
>> period of time for both the master & slave.
> 
> Looks like things are running, but I would expect the number of rows
> synced up to be much larger. The log snippet of the slave log only
> synced 23 rows, and it took it 2 minutes to do so. No wonder it's not
> catching up!
> 
> Increase the max sync group size to something much larger, say 500 or
> so. Also, can you get a larger snippet from the slave's log file?

This sounds very much like the log selection code is suffering from long 
running transactions on the origin.


Jan

-- 
#======================================================================#
# It's easier to get forgiveness for being wrong than for being right. #
# Let's break this rule - forgive me.                                  #
#================================================== JanWieck@Yahoo.com #
From JanWieck at Yahoo.com  Thu Aug 30 09:01:29 2007
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Thu Aug 30 09:01:41 2007
Subject: [Slony1-general] Re: Bug in slonik SQL parser: comments are not
	removed properly
In-Reply-To: <d7df81620708291152s6d1ce8aaqe87c04be8a462af4@mail.gmail.com>
References: <d7df81620708290821p38284405uc095f811740132c8@mail.gmail.com>
	<d7df81620708291152s6d1ce8aaqe87c04be8a462af4@mail.gmail.com>
Message-ID: <46D6E9D9.2040306@Yahoo.com>

On 8/29/2007 2:52 PM, Dmitry Koterov wrote:
> And much worse - seems such DDL with comments breaks the whole 
> replication (fortunately I have run it on a test server, not in production).
> I watched sl_event table on a subscriber and noticed that the whole DDL 
> (with comments included) are passed and saved in the subscriber.

Where in the ANSI SQL standard does it allow -- comments nested inside 
of /* ... */ comments?

Just because Postgres itself allows it doesn't mean that every piece of 
software working with Postgres must be aware of this, does it?


Jan

> 
> 
> On 8/29/07, *Dmitry Koterov* <dmitry@koterov.ru 
> <mailto:dmitry@koterov.ru>> wrote:
> 
>     Hello.
> 
>     I feed the followind DDL SQL code to slonik:
> 
>     ==============================================
>     -- Execute all schema changes.
>     SET statement_timeout TO 0;
> 
>     /*
>     select count(distinct person_id)
>     from
>         person
>         join dictionary on dic_category_id=11
>         left join person_settings on ps_person_id=person_id and
>     ps_did=dic_id
>     where
>         ps_person_id is null
>     -- only 9000!
>     */
> 
>     CREATE SEQUENCE "public"."obj_setting_os_id_seq"
>         INCREMENT 1  MINVALUE 1
>         MAXVALUE 9223372036854775807  START 1
>         CACHE 1;
>     ==============================================
> 
>     But I see that ALL DDL code below the comment is removed, not only
>     the comment:
> 
>     DDL Statement 0: (0,99) [
>                         -- Execute all schema changes.
>                         SET statement_timeout TO 0;]
>     Submit DDL Event to subscribers...
>     DDL on origin - PGRES_TUPLES_OK
> 
>     Seems slonik & others parser parses SQL code incorrectly - skips
>     everything after a multi-line comment.
>     Please fix this in a new version...
> 
> 
> 
> ------------------------------------------------------------------------
> 
> _______________________________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


-- 
#======================================================================#
# It's easier to get forgiveness for being wrong than for being right. #
# Let's break this rule - forgive me.                                  #
#================================================== JanWieck@Yahoo.com #
From cbbrowne at ca.afilias.info  Thu Aug 30 09:18:24 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Thu Aug 30 09:18:39 2007
Subject: [Slony1-general] Re: Bug in slonik SQL parser: comments are not
	removed properly
In-Reply-To: <46D6E9D9.2040306@Yahoo.com>
References: <d7df81620708290821p38284405uc095f811740132c8@mail.gmail.com>	<d7df81620708291152s6d1ce8aaqe87c04be8a462af4@mail.gmail.com>
	<46D6E9D9.2040306@Yahoo.com>
Message-ID: <46D6EDD0.5080305@ca.afilias.info>

Jan Wieck wrote:
> On 8/29/2007 2:52 PM, Dmitry Koterov wrote:
>> And much worse - seems such DDL with comments breaks the whole 
>> replication (fortunately I have run it on a test server, not in 
>> production).
>> I watched sl_event table on a subscriber and noticed that the whole 
>> DDL (with comments included) are passed and saved in the subscriber.
>
> Where in the ANSI SQL standard does it allow -- comments nested inside 
> of /* ... */ comments?
>
> Just because Postgres itself allows it doesn't mean that every piece 
> of software working with Postgres must be aware of this, does it?
>
I new have a revision to address the /* */ style comments, and something 
reasonably tortuous to test them.

I'm not going to put that in the 1.2 branch, though.

I don't think DDL scripts are a good place to put entrants for the "most 
obfuscated PostgreSQL comments contest."
From dmitry at koterov.ru  Thu Aug 30 10:49:40 2007
From: dmitry at koterov.ru (Dmitry Koterov)
Date: Thu Aug 30 10:49:49 2007
Subject: [Slony1-general] Re: Bug in slonik SQL parser: comments are not
	removed properly
In-Reply-To: <46D6EDD0.5080305@ca.afilias.info>
References: <d7df81620708290821p38284405uc095f811740132c8@mail.gmail.com>
	<d7df81620708291152s6d1ce8aaqe87c04be8a462af4@mail.gmail.com>
	<46D6E9D9.2040306@Yahoo.com> <46D6EDD0.5080305@ca.afilias.info>
Message-ID: <d7df81620708301049h614000fau9b560595289074cf@mail.gmail.com>

> Just because Postgres itself allows it doesn't mean that every piece of
> software working with Postgres must be aware of this, does it?
Possibly.

But it is too bad to completely break the replication on a syntax error in
DDL script, I suppose.
We have spent more than 3 hours to recover from this error (re-createing the
origin and all subscribers from scratch).

On 8/30/07, Christopher Browne <cbbrowne@ca.afilias.info> wrote:
>
> Jan Wieck wrote:
> > On 8/29/2007 2:52 PM, Dmitry Koterov wrote:
> >> And much worse - seems such DDL with comments breaks the whole
> >> replication (fortunately I have run it on a test server, not in
> >> production).
> >> I watched sl_event table on a subscriber and noticed that the whole
> >> DDL (with comments included) are passed and saved in the subscriber.
> >
> > Where in the ANSI SQL standard does it allow -- comments nested inside
> > of /* ... */ comments?
> >
> > Just because Postgres itself allows it doesn't mean that every piece
> > of software working with Postgres must be aware of this, does it?
> >
> I new have a revision to address the /* */ style comments, and something
> reasonably tortuous to test them.
>
> I'm not going to put that in the 1.2 branch, though.
>
> I don't think DDL scripts are a good place to put entrants for the "most
> obfuscated PostgreSQL comments contest."
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070830/=
938c5389/attachment.htm
From ajs at crankycanuck.ca  Thu Aug 30 11:46:39 2007
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Thu Aug 30 11:46:55 2007
Subject: [Slony1-general] Re: Bug in slonik SQL parser: comments are not
	removed properly
In-Reply-To: <d7df81620708301049h614000fau9b560595289074cf@mail.gmail.com>
References: <d7df81620708290821p38284405uc095f811740132c8@mail.gmail.com>
	<d7df81620708291152s6d1ce8aaqe87c04be8a462af4@mail.gmail.com>
	<46D6E9D9.2040306@Yahoo.com> <46D6EDD0.5080305@ca.afilias.info>
	<d7df81620708301049h614000fau9b560595289074cf@mail.gmail.com>
Message-ID: <20070830184639.GO7661@phlogiston.dyndns.org>

On Thu, Aug 30, 2007 at 09:49:40PM +0400, Dmitry Koterov wrote:
> > Just because Postgres itself allows it doesn't mean that every piece of
> > software working with Postgres must be aware of this, does it?
> Possibly.
> 
> But it is too bad to completely break the replication on a syntax error in
> DDL script, I suppose.

I have to agree with Dmitry here.  If the Postgres parser allows it,
I think we _do_ have to be aware of it.  Slony isn't like "every
piece of software working with Postgres", after all -- we advertise
as being a replication engine.

A


-- 
Andrew Sullivan  | ajs@crankycanuck.ca
The fact that technology doesn't work is no bar to success in the marketplace.
		--Philip Greenspun
From andrew.george.hammond at gmail.com  Thu Aug 30 11:48:36 2007
From: andrew.george.hammond at gmail.com (Andrew Hammond)
Date: Thu Aug 30 11:48:42 2007
Subject: [Slony1-general] Re: Bug in slonik SQL parser: comments are not
	removed properly
In-Reply-To: <46D6E9D9.2040306@Yahoo.com>
References: <d7df81620708290821p38284405uc095f811740132c8@mail.gmail.com>
	<d7df81620708291152s6d1ce8aaqe87c04be8a462af4@mail.gmail.com>
	<46D6E9D9.2040306@Yahoo.com>
Message-ID: <5a0a9d6f0708301148j40c047f1lac12ba4d5bb0e6f9@mail.gmail.com>

On 8/30/07, Jan Wieck <JanWieck@yahoo.com> wrote:
>
> On 8/29/2007 2:52 PM, Dmitry Koterov wrote:
> > And much worse - seems such DDL with comments breaks the whole
> > replication (fortunately I have run it on a test server, not in
> production).
> > I watched sl_event table on a subscriber and noticed that the whole DDL
> > (with comments included) are passed and saved in the subscriber.
>
> Where in the ANSI SQL standard does it allow -- comments nested inside
> of /* ... */ comments?


I can see having problems with "real" nested comments.


/*
  layer one
  /*
    layer two
  */
  I'll bet this doesn't work
*/

Or, if you want to get really stupid, like this.

-- this is a stupid place to /* start
a multi-line coment
*/

But honestly, a parser that fails because of comment characters inside a
comment... that's kinda broken.

/* this may be stupid
-- but, really it should still work. */

Just because Postgres itself allows it doesn't mean that every piece of
> software working with Postgres must be aware of this, does it?


I think that for any software which works _only_ with Postgres, it is
reasonable to assume that it will attempt to be as close to the Postgres
interpretation / implementation of SQL as possible. One of the ways to test
DDL before applying it via slonik is to run it with a rollback on each node.
If a script passes this test, then it seems to me that it's reasonable to
expect it to work via EXECUTE DDL.

Hmm, maybe that's an idea for a new feature "EXECUTE DDL DRYRUN" or
something of that nature...

Andrew
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070830/=
6f016c97/attachment.htm
From dmitry at koterov.ru  Thu Aug 30 11:57:54 2007
From: dmitry at koterov.ru (Dmitry Koterov)
Date: Thu Aug 30 11:58:02 2007
Subject: [Slony1-general] Re: Bug in slonik SQL parser: comments are not
	removed properly
In-Reply-To: <5a0a9d6f0708301148j40c047f1lac12ba4d5bb0e6f9@mail.gmail.com>
References: <d7df81620708290821p38284405uc095f811740132c8@mail.gmail.com>
	<d7df81620708291152s6d1ce8aaqe87c04be8a462af4@mail.gmail.com>
	<46D6E9D9.2040306@Yahoo.com>
	<5a0a9d6f0708301148j40c047f1lac12ba4d5bb0e6f9@mail.gmail.com>
Message-ID: <d7df81620708301157s2df280fag7b8f21738221bb00@mail.gmail.com>

The idea to test DDL on all nodes and NOT to split it before is great, but I
suppose it is quite hard to implement. And many people uses Slony as
non-realtime replication, so all changes have to be queued: by the time a
new DDL change appeared, not all previous DDL changes may be applied to a
subscriber.

But for people who uses Slony as a realtime replication (like our company),
it would be a good feature.

Frankly, I do not quite understand why Slony splits the whole DDL script to
separate queries at all. Why not to process THE WHOLE script, without any
splitting? Seems it will solve all problems with SQL parsing. Now Slony adds
the whole script as a separate event, and practically it is splitted twice:
by slonik on an admin node and by slon on a subscriber. Why should we split
it,why not to execute the whole script at once?


On 8/30/07, Andrew Hammond <andrew.george.hammond@gmail.com> wrote:
>
> On 8/30/07, Jan Wieck <JanWieck@yahoo.com> wrote:
> >
> > On 8/29/2007 2:52 PM, Dmitry Koterov wrote:
> > > And much worse - seems such DDL with comments breaks the whole
> > > replication (fortunately I have run it on a test server, not in
> > production).
> > > I watched sl_event table on a subscriber and noticed that the whole
> > DDL
> > > (with comments included) are passed and saved in the subscriber.
> >
> > Where in the ANSI SQL standard does it allow -- comments nested inside
> > of /* ... */ comments?
>
>
> I can see having problems with "real" nested comments.
>
>
> /*
>   layer one
>   /*
>     layer two
>   */
>   I'll bet this doesn't work
> */
>
> Or, if you want to get really stupid, like this.
>
> -- this is a stupid place to /* start
> a multi-line coment
> */
>
> But honestly, a parser that fails because of comment characters inside a
> comment... that's kinda broken.
>
> /* this may be stupid
> -- but, really it should still work. */
>
> Just because Postgres itself allows it doesn't mean that every piece of
> > software working with Postgres must be aware of this, does it?
>
>
> I think that for any software which works _only_ with Postgres, it is
> reasonable to assume that it will attempt to be as close to the Postgres
> interpretation / implementation of SQL as possible. One of the ways to te=
st
> DDL before applying it via slonik is to run it with a rollback on each no=
de.
> If a script passes this test, then it seems to me that it's reasonable to
> expect it to work via EXECUTE DDL.
>
> Hmm, maybe that's an idea for a new feature "EXECUTE DDL DRYRUN" or
> something of that nature...
>
> Andrew
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070830/=
d58313d4/attachment-0001.htm
From bnichols at ca.afilias.info  Thu Aug 30 12:03:15 2007
From: bnichols at ca.afilias.info (Brad Nicholson)
Date: Thu Aug 30 12:03:32 2007
Subject: [Slony1-general] Re: Bug in slonik SQL parser: comments are
	not removed properly
In-Reply-To: <5a0a9d6f0708301148j40c047f1lac12ba4d5bb0e6f9@mail.gmail.com>
References: <d7df81620708290821p38284405uc095f811740132c8@mail.gmail.com>
	<d7df81620708291152s6d1ce8aaqe87c04be8a462af4@mail.gmail.com>
	<46D6E9D9.2040306@Yahoo.com>
	<5a0a9d6f0708301148j40c047f1lac12ba4d5bb0e6f9@mail.gmail.com>
Message-ID: <1188500596.29355.202.camel@bnicholson-desktop>

On Thu, 2007-08-30 at 11:48 -0700, Andrew Hammond wrote:
> On 8/30/07, Jan Wieck <JanWieck@yahoo.com> wrote:
>         On 8/29/2007 2:52 PM, Dmitry Koterov wrote:
>         > And much worse - seems such DDL with comments breaks the
>         whole
>         > replication (fortunately I have run it on a test server, not
>         in production).
>         > I watched sl_event table on a subscriber and noticed that
>         the whole DDL 
>         > (with comments included) are passed and saved in the
>         subscriber.
>         
>         Where in the ANSI SQL standard does it allow -- comments
>         nested inside
>         of /* ... */ comments?

Nothing says it has to accept the comments.  It could detect them and throw an error.

-- 
Brad Nicholson  416-673-4106
Database Administrator, Afilias Canada Corp.

From karl_hennig at yahoo.com  Thu Aug 30 12:12:15 2007
From: karl_hennig at yahoo.com (Karl Hennig)
Date: Thu Aug 30 12:12:23 2007
Subject: [Slony1-general] Replicating multiple schemas
In-Reply-To: <2ca799770708290846w6cc66ecbsde9d51789cd7d287@mail.gmail.com>
Message-ID: <826433.4139.qm@web34510.mail.mud.yahoo.com>

Mikko,

Thanks for your help.  You're correct -- I came from the MySQL world and mixed
up the terms schema and database.

In my case, A and B are different schemas but they are ALSO in different
databases.  They are not part of the same DB.

With the help of the guys on the IRC channel, I got things working by setting
up a different cluster for each DB.  Is that the only way to do it?

Thanks again.


--- Mikko Partio <mpartio@gmail.com> wrote:

> On 8/29/07, Karl Hennig <karl_hennig@yahoo.com> wrote:
> >
> > Hello,
> >
> > I'm setting up slony to replicate multiple schemas from a single master DB
> > to a single slave DB.  I successfully got one schema to replicate but am
> > having trouble with the second one.
> 
> 
> 
> You seem to have mixed up databases and schemas:
> 
> Here's how it's set up:
> > DB Server #1 (master): holds schema A and schema B
> > DB Server #2 (slave): holds schema A and schema B
> >
> > Schema A is replicating as expected but nothing is replicated for schema
> > B.
> >
> > I tried modifying the tutorial slonik input to add schema B as follows:
> >
> > cluster name = $CLUSTERNAME;
> >
> > node 1 admin conninfo = 'dbname=A host=$MASTERHOST user=$REPLICATIONUSER';
> >
> > node 2 admin conninfo = 'dbname=A_slave host=$SLAVEHOST
> > user=$REPLICATIONUSER';
> >
> > # new nodes 3 and 4 added for schema B
> > node 3 admin conninfo = 'dbname=B host=$MASTERHOST user=$REPLICATIONUSER';
> >
> > node 4 admin conninfo = 'dbname=B_slave host=$SLAVEHOST
> > user=$REPLICATIONUSER';
> 
> 
> 
> Nodes 3 and 4 are not needed since both schemas are in the same database.
> 
> 
> # init... am I supposed to init a second cluster with the node ID for schema
> > B?
> > init cluster ( id=1, comment = 'Master Node for A');
> > init cluster ( id=3, comment = 'Master Node for B');
> >
> > create set (id=1, origin=1, comment='schema A tables');
> > # I put id=2 and origin=3 because schema B's set should come from node #3
> > create set (id=2, origin=3, comment='schema B tables');
> >
> > set add table (
> >             set id=1,
> >                 origin=1,
> >                 id=1,
> >                 fully qualified name = 'public.table1',
> >                 comment='table1 in schema A'
> >         );
> >
> > set add table (
> >             set id=2,
> >                 origin=3,
> >                 id=1,
> >                 fully qualified name = 'public.table1',
> >                 comment='table1 in schema B'
> >         );
> 
> 
> 
> Both tables here are at the same schema (public). Just specify the schema in
> the set add table, eg.
> 
> set add table (
>             set id=1,
>                 origin=1,
>                 id=1,
>                 fully qualified name = 'schemaA.table1',
>                 comment='table1 in schema A'
>         );
> 
> and
> 
> 
> set add table (
>             set id=2,
>                 origin=1,
>                 id=2,
>                 fully qualified name = 'schemaB.table1',
>                 comment='table1 in schema B'
>         );
> 
> 
> Regards
> 
> MP
> 



       
____________________________________________________________________________________
Need a vacation? Get great deals
to amazing places on Yahoo! Travel.
http://travel.yahoo.com/
From cbbrowne at ca.afilias.info  Thu Aug 30 13:32:10 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Thu Aug 30 13:32:21 2007
Subject: [Slony1-general] Re: Bug in slonik SQL parser: comments are not
	removed properly
In-Reply-To: <5a0a9d6f0708301148j40c047f1lac12ba4d5bb0e6f9@mail.gmail.com>
	(Andrew Hammond's message of "Thu, 30 Aug 2007 11:48:36 -0700")
References: <d7df81620708290821p38284405uc095f811740132c8@mail.gmail.com>
	<d7df81620708291152s6d1ce8aaqe87c04be8a462af4@mail.gmail.com>
	<46D6E9D9.2040306@Yahoo.com>
	<5a0a9d6f0708301148j40c047f1lac12ba4d5bb0e6f9@mail.gmail.com>
Message-ID: <60myw8epbp.fsf@dba2.int.libertyrms.com>

"Andrew Hammond" <andrew.george.hammond@gmail.com> writes:
> On 8/30/07, Jan Wieck <JanWieck@yahoo.com> wrote:
>           On 8/29/2007 2:52 PM, Dmitry Koterov wrote:
>      > And much worse - seems such DDL with comments breaks the whole
>      > replication (fortunately I have run it on a test server, not in production).
>      > I watched sl_event table on a subscriber and noticed that the whole DDL
>      > (with comments included) are passed and saved in the subscriber.
>      
>      Where in the ANSI SQL standard does it allow -- comments nested inside
>      of /* ... */ comments?
>
>
> I can see having problems with "real" nested comments.
> /*
> ? layer one
> ? /*
> ??? layer two
> ? */
> ? I'll bet this doesn't work
> */
> Or, if you want to get really stupid, like this.
> -- this is a stupid place to /* start
> a multi-line coment
> */

Note that PostgreSQL supports nested comments, which, I should note, C
*does not.*

That is, in C, the following comment is *broken*:

   /* Here is a comment /* that nests */ */

That comment ends, in C, after the first "*/".  In effect, in C, the
following is a single comment:

   /* Here is a comment /* that nests */ c++;

So the first comment that you describe is, as far as C, is invalid,
but PostgreSQL does accept it.

Your second example:
  -- quote to end of a line that includes /* what looks like the start of a C-style comment
   multilining
   */

is treated, by PostgreSQL, as invalid.  The "--" hides everything
until the end of the line, and that includes the "/*", so that its
parser does not recognize there being any beginning to what you
imagined was going to begin commenting line 2.

> But honestly, a parser that fails because of comment characters inside a comment... that's kinda broken.
> /* this may be stupid
> -- but, really it should still work. */

PostgreSQL recognizes this as a valid comment.  Since the parser is
already in "comment mode" when it gets to "--", that does NOT hide the
rest of the line.

>           Just because Postgres itself allows it doesn't mean that every piece of
>      software working with Postgres must be aware of this, does it?
>
> I think that for any software which works _only_ with Postgres, it
> is reasonable to assume that it will attempt to be as close to the
> Postgres interpretation / implementation of SQL as possible. One of
> the ways to test DDL before applying it via slonik is to run it with
> a rollback on each node. If a script passes this test, then it seems
> to me that it's reasonable to expect it to work via EXECUTE DDL.
> Hmm, maybe that's an idea for a new feature "EXECUTE DDL DRYRUN" or
> something of that nature...

The nature of this particular problem actually makes my head hurt.

- My first thought was, "no big deal, I'll just get the parser to
  recognize C-style comments."  I have code not yet checked in that
  does this, and which survives something of a "torture test."

Here's a pretty reasonable torture test:

select * from
/************ *foooo*   /- *
/   here is a tremendously ugly C-style comment
* * * * * /
-- **{***(***[****/
b;

However, in looking at things deeper, then comes the "ow!" part.

C doesn't support nested comments, but *PostgreSQL does*!!!

Nested /* /* */ */ comments are somewhat harder to support, and when
this actually *IS NOT* supporting a "C style comment" (as there's
demonstrably different behaviour), it frankly strikes me as silly to
head deeply into this.

There is a conspicuous bug in that the parser presently never comes
out of "C-style comment mode;" I'm happy enough to address that.

But I am also loathe to go to extremes to support functionality that
is also deviant from what people's expectations will generally be.
-- 
let name="cbbrowne" and tld="linuxfinances.info" in name ^ "@" ^ tld;;
http://cbbrowne.com/info/slony.html
"There are  three kinds  of program statements:  sequence, repetition,
and seduction."
From cbbrowne at ca.afilias.info  Thu Aug 30 13:37:08 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Thu Aug 30 13:37:21 2007
Subject: [Slony1-general] Re: Bug in slonik SQL parser: comments are not
	removed properly
In-Reply-To: <d7df81620708301157s2df280fag7b8f21738221bb00@mail.gmail.com>
	(Dmitry Koterov's message of "Thu, 30 Aug 2007 22:57:54 +0400")
References: <d7df81620708290821p38284405uc095f811740132c8@mail.gmail.com>
	<d7df81620708291152s6d1ce8aaqe87c04be8a462af4@mail.gmail.com>
	<46D6E9D9.2040306@Yahoo.com>
	<5a0a9d6f0708301148j40c047f1lac12ba4d5bb0e6f9@mail.gmail.com>
	<d7df81620708301157s2df280fag7b8f21738221bb00@mail.gmail.com>
Message-ID: <60ir6wep3f.fsf@dba2.int.libertyrms.com>

"Dmitry Koterov" <dmitry@koterov.ru> writes:
> The idea to test DDL on all nodes and NOT to split it before is great, but I suppose it is quite hard to implement. And many people uses Slony as non-realtime
> replication, so all changes have to be queued: by the time a new DDL change appeared, not all previous DDL changes may be applied to a subscriber.
> But for people who uses Slony as a realtime replication (like our company), it would be a good feature.
> Frankly, I do not quite understand why Slony splits the whole DDL script to separate queries at all. Why not to process THE WHOLE script, without any splitting? Seems it
> will solve all problems with SQL parsing. Now Slony adds the whole script as a separate event, and practically it is splitted twice: by slonik on an admin node and by
> slon on a subscriber. Why should we split it,why not to execute the whole script at once?

Perhaps you should reread the release notes, as they explain quite
clearly why it is necessary to split the DDL script into multiple
statements.

To wit, from the release notes for 1.2.0:

--------------------------------------------------------------------
- DDL scripts are broken into individual statements

  This is more a bug fix than an enhancement; it now permits DDL
  scripts to create new tables and columns, and reference them later
  in the script.

  In the past, DDL was submitted to the postmaster as a single query,
  which meant that all of them had to reference the state of
  pg_catalog as it was before the DDL ran.  So you could add as many
  columns to tables as you liked; you could NOT, then, reference those
  columns, because the query processor would discover that the new
  column didn't exist as at "before the DDL ran."

  There is now a statement parser which splits scripts into individual
  SQL statements and passes them to the database back end
  individually.
--------------------------------------------------------------------
-- 
(reverse (concatenate 'string "moc.enworbbc" "@" "enworbbc"))
http://cbbrowne.com/info/finances.html
"What's wrong with 3rd party tools? Especially if they are free?  What
the **** do you think Unix is  anyway? It's a big honkin' party of 3rd
party free tools." -- Bob Cassidy (rmcassid@uci.edu)
From drees76 at gmail.com  Thu Aug 30 14:01:24 2007
From: drees76 at gmail.com (David Rees)
Date: Thu Aug 30 14:01:34 2007
Subject: [Slony1-general] Replicating multiple schemas
In-Reply-To: <826433.4139.qm@web34510.mail.mud.yahoo.com>
References: <2ca799770708290846w6cc66ecbsde9d51789cd7d287@mail.gmail.com>
	<826433.4139.qm@web34510.mail.mud.yahoo.com>
Message-ID: <72dbd3150708301401n655d9487tdf6ac8b112f09f32@mail.gmail.com>

On 8/30/07, Karl Hennig <karl_hennig@yahoo.com> wrote:
> In my case, A and B are different schemas but they are ALSO in different
> databases.  They are not part of the same DB.
>
> With the help of the guys on the IRC channel, I got things working by setting
> up a different cluster for each DB.  Is that the only way to do it?

Yes.

-Dave
From dmitry at koterov.ru  Thu Aug 30 14:02:49 2007
From: dmitry at koterov.ru (Dmitry Koterov)
Date: Thu Aug 30 14:02:59 2007
Subject: [Slony1-general] Re: Bug in slonik SQL parser: comments are not
	removed properly
In-Reply-To: <60ir6wep3f.fsf@dba2.int.libertyrms.com>
References: <d7df81620708290821p38284405uc095f811740132c8@mail.gmail.com>
	<d7df81620708291152s6d1ce8aaqe87c04be8a462af4@mail.gmail.com>
	<46D6E9D9.2040306@Yahoo.com>
	<5a0a9d6f0708301148j40c047f1lac12ba4d5bb0e6f9@mail.gmail.com>
	<d7df81620708301157s2df280fag7b8f21738221bb00@mail.gmail.com>
	<60ir6wep3f.fsf@dba2.int.libertyrms.com>
Message-ID: <d7df81620708301402p52862848o34cca40879a949b1@mail.gmail.com>

Sorry, not quite clearly for me.
Could you please post an example where a single DLL query is wrong in
PostgreSQL 8+?

You meant that

"CREATE TABLE a(a INTEGER); ALTER TABLE a ADD COLUMN b INTEGER;"

executed as a SINGLE query would fail in postgres?

On 8/31/07, Christopher Browne <cbbrowne@ca.afilias.info> wrote:
>
>
> Perhaps you should reread the release notes, as they explain quite
> clearly why it is necessary to split the DDL script into multiple
> statements.
>
> To wit, from the release notes for 1.2.0:
>
> --------------------------------------------------------------------
> - DDL scripts are broken into individual statements
>
>   This is more a bug fix than an enhancement; it now permits DDL
>   scripts to create new tables and columns, and reference them later
>   in the script.
>
>   In the past, DDL was submitted to the postmaster as a single query,
>   which meant that all of them had to reference the state of
>   pg_catalog as it was before the DDL ran.  So you could add as many
>   columns to tables as you liked; you could NOT, then, reference those
>   columns, because the query processor would discover that the new
>   column didn't exist as at "before the DDL ran."
>
>   There is now a statement parser which splits scripts into individual
>   SQL statements and passes them to the database back end
>   individually.
> --------------------------------------------------------------------
> --
> (reverse (concatenate 'string "moc.enworbbc" "@" "enworbbc"))
> http://cbbrowne.com/info/finances.html
> "What's wrong with 3rd party tools? Especially if they are free?  What
> the **** do you think Unix is  anyway? It's a big honkin' party of 3rd
> party free tools." -- Bob Cassidy (rmcassid@uci.edu)
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070831/=
21f0b9d7/attachment.htm
From JanWieck at Yahoo.com  Thu Aug 30 17:11:25 2007
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Thu Aug 30 17:11:43 2007
Subject: [Slony1-general] Re: Bug in slonik SQL parser: comments are not
	removed properly
In-Reply-To: <20070830184639.GO7661@phlogiston.dyndns.org>
References: <d7df81620708290821p38284405uc095f811740132c8@mail.gmail.com>	<d7df81620708291152s6d1ce8aaqe87c04be8a462af4@mail.gmail.com>	<46D6E9D9.2040306@Yahoo.com>
	<46D6EDD0.5080305@ca.afilias.info>	<d7df81620708301049h614000fau9b560595289074cf@mail.gmail.com>
	<20070830184639.GO7661@phlogiston.dyndns.org>
Message-ID: <46D75CAD.9070502@Yahoo.com>

On 8/30/2007 2:46 PM, Andrew Sullivan wrote:
> On Thu, Aug 30, 2007 at 09:49:40PM +0400, Dmitry Koterov wrote:
>> > Just because Postgres itself allows it doesn't mean that every piece of
>> > software working with Postgres must be aware of this, does it?
>> Possibly.
>> 
>> But it is too bad to completely break the replication on a syntax error in
>> DDL script, I suppose.
> 
> I have to agree with Dmitry here.  If the Postgres parser allows it,
> I think we _do_ have to be aware of it.  Slony isn't like "every
> piece of software working with Postgres", after all -- we advertise
> as being a replication engine.

You forget that Slony is also supposed to replicate across different 
Postgres versions. So what are we going to do if DDL with multiple 
nesting layers of different comment styles is supported by one, but not 
all Postgres versions inside of a Slony cluster? Somehow convert it to 
something that is understood by all?

Sorry, but Postgres supporting C-style comments in the first place is 
just plain wrong. Wasting time on shit like this while we don't find the 
time to implement MERGE, what does that tell you about a project?


Jan

-- 
#======================================================================#
# It's easier to get forgiveness for being wrong than for being right. #
# Let's break this rule - forgive me.                                  #
#================================================== JanWieck@Yahoo.com #
From JanWieck at Yahoo.com  Thu Aug 30 17:15:42 2007
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Thu Aug 30 17:16:02 2007
Subject: [Slony1-general] Re: Bug in slonik SQL parser: comments are not
	removed properly
In-Reply-To: <d7df81620708301402p52862848o34cca40879a949b1@mail.gmail.com>
References: <d7df81620708290821p38284405uc095f811740132c8@mail.gmail.com>	<d7df81620708291152s6d1ce8aaqe87c04be8a462af4@mail.gmail.com>	<46D6E9D9.2040306@Yahoo.com>	<5a0a9d6f0708301148j40c047f1lac12ba4d5bb0e6f9@mail.gmail.com>	<d7df81620708301157s2df280fag7b8f21738221bb00@mail.gmail.com>	<60ir6wep3f.fsf@dba2.int.libertyrms.com>
	<d7df81620708301402p52862848o34cca40879a949b1@mail.gmail.com>
Message-ID: <46D75DAE.1080401@Yahoo.com>

On 8/30/2007 5:02 PM, Dmitry Koterov wrote:
> Sorry, not quite clearly for me.
> Could you please post an example where a single DLL query is wrong in 
> PostgreSQL 8+?
> 
> You meant that
> 
> "CREATE TABLE a(a INTEGER); ALTER TABLE a ADD COLUMN b INTEGER;"

Yes, this fails if it is executed as a single call to PQexec() because 
the parser tries to create a parsetree list of all queries before 
handing that parsetree list to the planner. It succeeds in psql because 
psql will split this into two separate PQexec() calls.


Jan

> 
> executed as a SINGLE query would fail in postgres?
> 
> On 8/31/07, *Christopher Browne* <cbbrowne@ca.afilias.info 
> <mailto:cbbrowne@ca.afilias.info>> wrote:
> 
> 
>     Perhaps you should reread the release notes, as they explain quite
>     clearly why it is necessary to split the DDL script into multiple
>     statements.
> 
>     To wit, from the release notes for 1.2.0:
> 
>     --------------------------------------------------------------------
>     - DDL scripts are broken into individual statements
> 
>       This is more a bug fix than an enhancement; it now permits DDL
>       scripts to create new tables and columns, and reference them later
>       in the script.
> 
>       In the past, DDL was submitted to the postmaster as a single query,
>       which meant that all of them had to reference the state of
>       pg_catalog as it was before the DDL ran.  So you could add as many
>       columns to tables as you liked; you could NOT, then, reference those
>       columns, because the query processor would discover that the new
>       column didn't exist as at "before the DDL ran."
> 
>       There is now a statement parser which splits scripts into individual
>       SQL statements and passes them to the database back end
>       individually.
>     --------------------------------------------------------------------
>     --
>     (reverse (concatenate 'string "moc.enworbbc" "@" "enworbbc"))
>     http://cbbrowne.com/info/finances.html
>     "What's wrong with 3rd party tools? Especially if they are free?  What
>     the **** do you think Unix is  anyway? It's a big honkin' party of 3rd
>     party free tools." -- Bob Cassidy ( rmcassid@uci.edu
>     <mailto:rmcassid@uci.edu>)
> 
> 
> 
> ------------------------------------------------------------------------
> 
> _______________________________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


-- 
#======================================================================#
# It's easier to get forgiveness for being wrong than for being right. #
# Let's break this rule - forgive me.                                  #
#================================================== JanWieck@Yahoo.com #
From JanWieck at Yahoo.com  Thu Aug 30 17:21:25 2007
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Thu Aug 30 17:21:41 2007
Subject: [Slony1-general] Replicating multiple schemas
In-Reply-To: <72dbd3150708301401n655d9487tdf6ac8b112f09f32@mail.gmail.com>
References: <2ca799770708290846w6cc66ecbsde9d51789cd7d287@mail.gmail.com>	<826433.4139.qm@web34510.mail.mud.yahoo.com>
	<72dbd3150708301401n655d9487tdf6ac8b112f09f32@mail.gmail.com>
Message-ID: <46D75F05.5050103@Yahoo.com>

On 8/30/2007 5:01 PM, David Rees wrote:
> On 8/30/07, Karl Hennig <karl_hennig@yahoo.com> wrote:
>> In my case, A and B are different schemas but they are ALSO in different
>> databases.  They are not part of the same DB.
>>
>> With the help of the guys on the IRC channel, I got things working by setting
>> up a different cluster for each DB.  Is that the only way to do it?
> 
> Yes.

Unless you move both schemas into the same DB, that is.


Jan

-- 
#======================================================================#
# It's easier to get forgiveness for being wrong than for being right. #
# Let's break this rule - forgive me.                                  #
#================================================== JanWieck@Yahoo.com #
From ajs at crankycanuck.ca  Thu Aug 30 19:34:43 2007
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Thu Aug 30 19:35:07 2007
Subject: [Slony1-general] Re: Bug in slonik SQL parser: comments are not
	removed properly
In-Reply-To: <46D75CAD.9070502@Yahoo.com>
References: <d7df81620708290821p38284405uc095f811740132c8@mail.gmail.com>
	<d7df81620708291152s6d1ce8aaqe87c04be8a462af4@mail.gmail.com>
	<46D6E9D9.2040306@Yahoo.com> <46D6EDD0.5080305@ca.afilias.info>
	<d7df81620708301049h614000fau9b560595289074cf@mail.gmail.com>
	<20070830184639.GO7661@phlogiston.dyndns.org>
	<46D75CAD.9070502@Yahoo.com>
Message-ID: <20070831023443.GA11181@phlogiston.dyndns.org>

On Thu, Aug 30, 2007 at 08:11:25PM -0400, Jan Wieck wrote:
> You forget that Slony is also supposed to replicate across different 
> Postgres versions. So what are we going to do if DDL with multiple 
> nesting layers of different comment styles is supported by one, but not 
> all Postgres versions inside of a Slony cluster? Somehow convert it to 
> something that is understood by all?

No, we're supposed to support the least common denominator.  If there
isn't one, then I agree tha the user loses.  This is more or less the
pg_dump strategy: use the latest, or die.
 
> Sorry, but Postgres supporting C-style comments in the first place is 
> just plain wrong. Wasting time on shit like this while we don't find the 
> time to implement MERGE, what does that tell you about a project?

It tells me that there are too few developers.  It's not wasting
time.  We can also decide that it's a known issue, in which case (1)
we accept patches and (2) we have a BIG FAT WARNING in the docs about
it.  Neither case seems to be true to me.  

I'm sorry, but dismissing what seems to me to be a totally legitimate
user complaint -- "My replication system breaks on legal PostgreSQL
systems" -- on the grounds that the SQL isn't what you consider "good
SQL style" is totally bogus.  This is a replication system _for
Postgres_, not for some magical sytem out there that happens to be
like Postgres, only isn't.  Postgres accepts C-style comments, with a
bunch of warts that Chris points out.  Don't like that?  Tough. 
That's the system we gots.  Either we document this as a limitation
of our system (and, ideally, provide a robust stripper to remove
offending comments -- yes, I'm brushing the rust off my sed even as
we speak), or we fix it, or we admit that we're a replication system
for PostgresPERFECT, rather than PostgreSQL.

A

-- 
Andrew Sullivan  | ajs@crankycanuck.ca
Everything that happens in the world happens at some place.
		--Jane Jacobs 
From JanWieck at Yahoo.com  Thu Aug 30 20:18:07 2007
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Thu Aug 30 20:18:27 2007
Subject: [Slony1-general] Re: Bug in slonik SQL parser: comments are not
	removed properly
In-Reply-To: <20070831023443.GA11181@phlogiston.dyndns.org>
References: <d7df81620708290821p38284405uc095f811740132c8@mail.gmail.com>
	<d7df81620708291152s6d1ce8aaqe87c04be8a462af4@mail.gmail.com>
	<46D6E9D9.2040306@Yahoo.com> <46D6EDD0.5080305@ca.afilias.info>
	<d7df81620708301049h614000fau9b560595289074cf@mail.gmail.com>
	<20070830184639.GO7661@phlogiston.dyndns.org>
	<46D75CAD.9070502@Yahoo.com>
	<20070831023443.GA11181@phlogiston.dyndns.org>
Message-ID: <46D7886F.5040902@Yahoo.com>

On 8/30/2007 10:34 PM, Andrew Sullivan wrote:
> On Thu, Aug 30, 2007 at 08:11:25PM -0400, Jan Wieck wrote:
>> You forget that Slony is also supposed to replicate across different 
>> Postgres versions. So what are we going to do if DDL with multiple 
>> nesting layers of different comment styles is supported by one, but not 
>> all Postgres versions inside of a Slony cluster? Somehow convert it to 
>> something that is understood by all?
> 
> No, we're supposed to support the least common denominator.  If there
> isn't one, then I agree tha the user loses.  This is more or less the
> pg_dump strategy: use the latest, or die.

Which means we'd have to somehow extract the Postgres backend or psql 
parser in order to do so. Without that I don't know how to keep the two 
100 percent in sync.

>  
>> Sorry, but Postgres supporting C-style comments in the first place is 
>> just plain wrong. Wasting time on shit like this while we don't find the 
>> time to implement MERGE, what does that tell you about a project?
> 
> It tells me that there are too few developers.  It's not wasting
> time.  We can also decide that it's a known issue, in which case (1)
> we accept patches and (2) we have a BIG FAT WARNING in the docs about
> it.  Neither case seems to be true to me.  

Exactly. We don't have enough developers. And I truly think that we have 
much bigger fish to fry than supporting complicated comment structures.

The way I see it is that we will change our parser to simply REJECT a 
DDL script if there is any /* style comment in there at all, document it 
that way and be done with it. At least it won't allow to break 
replication any more.


Jan

-- 
#======================================================================#
# It's easier to get forgiveness for being wrong than for being right. #
# Let's break this rule - forgive me.                                  #
#================================================== JanWieck@Yahoo.com #
From dmitry at koterov.ru  Thu Aug 30 21:17:10 2007
From: dmitry at koterov.ru (Dmitry Koterov)
Date: Thu Aug 30 21:17:26 2007
Subject: [Slony1-general] Re: Bug in slonik SQL parser: comments are not
	removed properly
In-Reply-To: <46D7886F.5040902@Yahoo.com>
References: <d7df81620708290821p38284405uc095f811740132c8@mail.gmail.com>
	<d7df81620708291152s6d1ce8aaqe87c04be8a462af4@mail.gmail.com>
	<46D6E9D9.2040306@Yahoo.com> <46D6EDD0.5080305@ca.afilias.info>
	<d7df81620708301049h614000fau9b560595289074cf@mail.gmail.com>
	<20070830184639.GO7661@phlogiston.dyndns.org>
	<46D75CAD.9070502@Yahoo.com>
	<20070831023443.GA11181@phlogiston.dyndns.org>
	<46D7886F.5040902@Yahoo.com>
Message-ID: <d7df81620708302117p3e7d68b0k6f4b0ed7cf8f754a@mail.gmail.com>

> The way I see it is that we will change our parser to simply REJECT a
> DDL script if there is any /* style comment in there at all, document it
> that way and be done with it.
I suppose it's a quite acceptable solution. And it is much better than
nothing.

>> "CREATE TABLE a(a INTEGER); ALTER TABLE a ADD COLUMN b INTEGER;"
> It succeeds in psql because psql will split this into two separate
PQexec() calls.
Now it's clean, thanks.
So, maybe extract an SQL splitting code from psql sources and use it? Seems
it contains no bugs.


On 8/31/07, Jan Wieck <JanWieck@yahoo.com> wrote:
>
> On 8/30/2007 10:34 PM, Andrew Sullivan wrote:
> > On Thu, Aug 30, 2007 at 08:11:25PM -0400, Jan Wieck wrote:
> >> You forget that Slony is also supposed to replicate across different
> >> Postgres versions. So what are we going to do if DDL with multiple
> >> nesting layers of different comment styles is supported by one, but not
> >> all Postgres versions inside of a Slony cluster? Somehow convert it to
> >> something that is understood by all?
> >
> > No, we're supposed to support the least common denominator.  If there
> > isn't one, then I agree tha the user loses.  This is more or less the
> > pg_dump strategy: use the latest, or die.
>
> Which means we'd have to somehow extract the Postgres backend or psql
> parser in order to do so. Without that I don't know how to keep the two
> 100 percent in sync.
>
> >
> >> Sorry, but Postgres supporting C-style comments in the first place is
> >> just plain wrong. Wasting time on shit like this while we don't find
> the
> >> time to implement MERGE, what does that tell you about a project?
> >
> > It tells me that there are too few developers.  It's not wasting
> > time.  We can also decide that it's a known issue, in which case (1)
> > we accept patches and (2) we have a BIG FAT WARNING in the docs about
> > it.  Neither case seems to be true to me.
>
> Exactly. We don't have enough developers. And I truly think that we have
> much bigger fish to fry than supporting complicated comment structures.
>
> The way I see it is that we will change our parser to simply REJECT a
> DDL script if there is any /* style comment in there at all, document it
> that way and be done with it. At least it won't allow to break
> replication any more.
>
>
> Jan
>
> --
> #=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D#
> # It's easier to get forgiveness for being wrong than for being right. #
> # Let's break this rule - forgive me.                                  #
> #=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D JanWieck@Yahoo.com #
> _______________________________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070831/=
01046738/attachment.htm
From trinaths at intoto.com  Thu Aug 30 23:24:54 2007
From: trinaths at intoto.com (Trinath Somanchi)
Date: Thu Aug 30 23:25:21 2007
Subject: [Slony1-general] Which is Version of slony-I to use ??
Message-ID: <46D7B436.90502@intoto.com>

Hi ,

I SLONY-I there are 2 concurrent version are released . version 1.2.11 =

and 1.1.9 .

What is the difference between these two Versions ?

I just need to maintain a master slave database model in real time =

environment  . Which version is best fit for me  ?

In my production environment , I do create some archive of data  which i =

turn creates tables . I such cases up to what level SLONY-I can be a =

best suable option for me.

Is ther any other replicator for Postgresql available now which best =

fits my environment .

Please help me with your suggestions .

Thanks in advance ,

Best Regards,
-- =

Trinath Somanchi.


***************************************************************************=
*****
This email message (including any attachments) is for the sole use of the i=
ntended recipient(s) =

and may contain confidential, proprietary and privileged information. Any u=
nauthorized review, =

use, disclosure or distribution is prohibited. If you are not the intended =
recipient, =

please immediately notify the sender by reply email and destroy all copies =
of the original message. =

Thank you.
 =

Intoto Inc. =


-------------- next part --------------
A non-text attachment was scrubbed...
Name: trinaths.vcf
Type: text/x-vcard
Size: 316 bytes
Desc: not available
Url : http://lists.slony.info/pipermail/slony1-general/attachments/20070831=
/5f8326b3/trinaths-0001.vcf
From dmitry at koterov.ru  Fri Aug 31 00:08:38 2007
From: dmitry at koterov.ru (Dmitry Koterov)
Date: Fri Aug 31 00:09:02 2007
Subject: [Slony1-general] Which is Version of slony-I to use ??
In-Reply-To: <46D7B436.90502@intoto.com>
References: <46D7B436.90502@intoto.com>
Message-ID: <d7df81620708310008n399f44e6y637c92cd2f6cfa2b@mail.gmail.com>

>
>
> What is the difference between these two Versions ?


Seems you could notice it from the changelog.
For me, 1.2.11 is newer and better.


> In my production environment , I do create some archive of data  which i
> turn creates tables . I such cases up to what level SLONY-I can be a
> best suable option for me.
>
> Is ther any other replicator for Postgresql available now which best
> fits my environment .
>
You described your environment too briefly.


>
> *************************************************************************=
*******
> This email message (including any attachments) is for the sole use of the
> intended recipient(s)


Are you sure you really need this footer in emails while posting to the
Slony mail list?
I suppose no.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070831/=
ef386ccf/attachment.htm
From trinaths at intoto.com  Fri Aug 31 01:05:59 2007
From: trinaths at intoto.com (Trinath Somanchi)
Date: Fri Aug 31 01:06:20 2007
Subject: [Slony1-general] Which is Version of slony-I to use ??
In-Reply-To: <d7df81620708310008n399f44e6y637c92cd2f6cfa2b@mail.gmail.com>
References: <46D7B436.90502@intoto.com>
	<d7df81620708310008n399f44e6y637c92cd2f6cfa2b@mail.gmail.com>
Message-ID: <46D7CBE7.4030506@intoto.com>

An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070831/06ac9b07/attachment.htm
-------------- next part --------------
A non-text attachment was scrubbed...
Name: trinaths.vcf
Type: text/x-vcard
Size: 316 bytes
Desc: not available
Url : http://lists.slony.info/pipermail/slony1-general/attachments/20070831/06ac9b07/trinaths.vcf
From cscetbon.ext at orange-ftgroup.com  Fri Aug 31 01:43:26 2007
From: cscetbon.ext at orange-ftgroup.com (Cyril SCETBON)
Date: Fri Aug 31 01:43:45 2007
Subject: [Slony1-general] Configuration on 2 sites
In-Reply-To: <46D5BD84.8090302@orange-ftgroup.com>
References: <46D3EF28.40108@orange-ftgroup.com>	<20070828132235.GA461@phlogiston.dyndns.org>	<46D43DAF.5010604@orange-ftgroup.com>	<20070828152919.GB979@phlogiston.dyndns.org>	<46D539A4.9020601@orange-ftgroup.com>	<20070829174509.GR4183@phlogiston.dyndns.org>	<46D5B216.2010708@orange-ftgroup.com>	<20070829180550.GT4183@phlogiston.dyndns.org>
	<46D5BD84.8090302@orange-ftgroup.com>
Message-ID: <46D7D4AE.6000600@orange-ftgroup.com>



Cyril SCETBON wrote:
>
>
> Andrew Sullivan wrote:
>> On Wed, Aug 29, 2007 at 07:51:18PM +0200, Cyril SCETBON wrote:
>>  
>>> So, How can I do if M2 is lost ? Cause I don't want S2 to resync 
>>> with M1 from scratch
>>>     
>>
>> You can't.  If you can't co-ordinate a switchover, then you lose the
>> node.  This is discussed at length in the manual.
>>   
> Really ????
> Are you really saying that losing M2 make me lose S2 ?????
> If it's true I'm really disappointed by slony :-(
>
> My config is as follows (just to remember) :
>
> psql db1 -c 'select * from "_CLUSTER1".sl_subscribe'
> sub_set | sub_provider | sub_receiver | sub_forward | sub_active
> ---------+--------------+--------------+-------------+------------
>      1 |            1 (M1)|            3 (M2)| t           | t
>      1 |            1 (M1)|            2 (S1) | t           | t
>      1 |            3 (M2)|            4 (S2) | t           | t
>
> Regards
Conclusion : M2 is a single point of failure for the  couple M2/S2 ?
>> A
>>
>>   
>

-- 
Cyril SCETBON - Ing?nieur bases de donn?es
AUSY pour France T?l?com - SCR/HDI/DOP/HEBEX

T?l : +33 (0)4 97 12 87 60
Jabber : cscetbon@jabber.org
France Telecom - Orange
790 Avenue du Docteur Maurice Donat 
B?timent Marco Polo C2 
06250 Mougins
France

***********************************
Ce message et toutes les pieces jointes (ci-apres le 'message') sont
confidentiels et etablis a l'intention exclusive de ses destinataires.
Toute utilisation ou diffusion non autorisee est interdite.
Tout message electronique est susceptible d'alteration. Le Groupe France
Telecom decline toute responsabilite au titre de ce message s'il a ete
altere, deforme ou falsifie.
Si vous n'etes pas destinataire de ce message, merci de le detruire
immediatement et d'avertir l'expediteur.
***********************************
This message and any attachments (the 'message') are confidential and
intended solely for the addressees.
Any unauthorised use or dissemination is prohibited.
Messages are susceptible to alteration. France Telecom Group shall not be
liable for the message if altered, changed or falsified.
If you are not recipient of this message, please cancel it immediately and
inform the sender.
************************************

From JanWieck at Yahoo.com  Fri Aug 31 04:29:42 2007
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Fri Aug 31 04:30:12 2007
Subject: [Slony1-general] Which is Version of slony-I to use ??
In-Reply-To: <46D7CBE7.4030506@intoto.com>
References: <46D7B436.90502@intoto.com>	<d7df81620708310008n399f44e6y637c92cd2f6cfa2b@mail.gmail.com>
	<46D7CBE7.4030506@intoto.com>
Message-ID: <46D7FBA6.6060108@Yahoo.com>

On 8/31/2007 4:05 AM, Trinath Somanchi wrote:
> 
>>     What is the difference between these two Versions ?
>>
>>
>> Seems you could notice it from the changelog.
>> For me, 1.2.11 is newer and better.
>  Can you  please send me the link to change log . I wanted to know why 
> two versions are maintained  .

The 1.1 branch is not maintained any more. The last version in the 
branch (1.1.9) is available for download, in case users of 1.1.x want to 
upgrade to the last release in their current branch instead of upgrading 
to 1.2.x which contains functional changes to 1.1.

>>
>>
>>     In my production environment , I do create some archive of
>>     data  which i
>>     turn creates tables . I such cases up to what level SLONY-I can be a
>>     best suable option for me.
>>
>>     Is ther any other replicator for Postgresql available now which best
>>     fits my environment .
>>
>> You described your environment too briefly.
>>
>     I have a Server , which generates more activity logs when ever a 
> user connects to it .  At a needed time , I do an archive of old data , 
> which  in turn creates a table a stores the rows of the master table 
> into it .  Hence ,Do SLONY-I support this type of environment .  and is 
> there any other replication option which is best suitable for me .

This is going to be a problem.

Slony-I was not designed to support self modifying code. It works best 
with a static schema.

Aside from that there is no mechanism in Postgres that would trigger any 
notification in case of a schema change, so how would Slony-I even be 
aware of a newly created table? And even if it could figure that out, 
how would it know which new table to add to which replication set (if at 
all)?


Jan

-- 
#======================================================================#
# It's easier to get forgiveness for being wrong than for being right. #
# Let's break this rule - forgive me.                                  #
#================================================== JanWieck@Yahoo.com #
From JanWieck at Yahoo.com  Fri Aug 31 04:40:33 2007
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Fri Aug 31 04:41:02 2007
Subject: [Slony1-general] Configuration on 2 sites
In-Reply-To: <46D7D4AE.6000600@orange-ftgroup.com>
References: <46D3EF28.40108@orange-ftgroup.com>	<20070828132235.GA461@phlogiston.dyndns.org>	<46D43DAF.5010604@orange-ftgroup.com>	<20070828152919.GB979@phlogiston.dyndns.org>	<46D539A4.9020601@orange-ftgroup.com>	<20070829174509.GR4183@phlogiston.dyndns.org>	<46D5B216.2010708@orange-ftgroup.com>	<20070829180550.GT4183@phlogiston.dyndns.org>	<46D5BD84.8090302@orange-ftgroup.com>
	<46D7D4AE.6000600@orange-ftgroup.com>
Message-ID: <46D7FE31.3080308@Yahoo.com>

On 8/31/2007 4:43 AM, Cyril SCETBON wrote:
> 
> Cyril SCETBON wrote:
>>
>>
>> Andrew Sullivan wrote:
>>> On Wed, Aug 29, 2007 at 07:51:18PM +0200, Cyril SCETBON wrote:
>>>  
>>>> So, How can I do if M2 is lost ? Cause I don't want S2 to resync 
>>>> with M1 from scratch
>>>>     
>>>
>>> You can't.  If you can't co-ordinate a switchover, then you lose the
>>> node.  This is discussed at length in the manual.
>>>   
>> Really ????
>> Are you really saying that losing M2 make me lose S2 ?????
>> If it's true I'm really disappointed by slony :-(
>>
>> My config is as follows (just to remember) :
>>
>> psql db1 -c 'select * from "_CLUSTER1".sl_subscribe'
>> sub_set | sub_provider | sub_receiver | sub_forward | sub_active
>> ---------+--------------+--------------+-------------+------------
>>      1 |            1 (M1)|            3 (M2)| t           | t
>>      1 |            1 (M1)|            2 (S1) | t           | t
>>      1 |            3 (M2)|            4 (S2) | t           | t

Since all nodes in your scenario are forwarders, you won't lose anything 
other than the failed node ever. In your configuration if you lose node 
M2 (which is a subscriber), simply issuing a new SUBSCRIBE SET for node 
S2 to use M1 or S1 as data provider will do. It will catch up from there 
without the need to sync from scratch.


Jan

-- 
#======================================================================#
# It's easier to get forgiveness for being wrong than for being right. #
# Let's break this rule - forgive me.                                  #
#================================================== JanWieck@Yahoo.com #
From trinaths at intoto.com  Fri Aug 31 05:09:48 2007
From: trinaths at intoto.com (Trinath Somanchi)
Date: Fri Aug 31 05:09:59 2007
Subject: [Slony1-general] Which is Version of slony-I to use ??
In-Reply-To: <46D7FBA6.6060108@Yahoo.com>
References: <46D7B436.90502@intoto.com>	<d7df81620708310008n399f44e6y637c92cd2f6cfa2b@mail.gmail.com>
	<46D7CBE7.4030506@intoto.com> <46D7FBA6.6060108@Yahoo.com>
Message-ID: <46D8050C.80905@intoto.com>

Skipped content of type multipart/related-------------- next part --------------
A non-text attachment was scrubbed...
Name: trinaths.vcf
Type: text/x-vcard
Size: 316 bytes
Desc: not available
Url : http://lists.slony.info/pipermail/slony1-general/attachments/20070831/df675575/trinaths-0001.vcf
From JanWieck at Yahoo.com  Fri Aug 31 06:44:37 2007
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Fri Aug 31 06:44:49 2007
Subject: [Slony1-general] Which is Version of slony-I to use ??
In-Reply-To: <46D8050C.80905@intoto.com>
References: <46D7B436.90502@intoto.com>	<d7df81620708310008n399f44e6y637c92cd2f6cfa2b@mail.gmail.com>
	<46D7CBE7.4030506@intoto.com> <46D7FBA6.6060108@Yahoo.com>
	<46D8050C.80905@intoto.com>
Message-ID: <46D81B45.8070306@Yahoo.com>

On 8/31/2007 8:09 AM, Trinath Somanchi wrote:
> 
> 
> Jan Wieck wrote:
>> On 8/31/2007 4:05 AM, Trinath Somanchi wrote:
>>>
>>>>     What is the difference between these two Versions ?
>>>>
>>>>
>>>> Seems you could notice it from the changelog.
>>>> For me, 1.2.11 is newer and better.
>>>  Can you  please send me the link to change log . I wanted to know 
>>> why two versions are maintained  .
>>
>> The 1.1 branch is not maintained any more. The last version in the 
>> branch (1.1.9) is available for download, in case users of 1.1.x want 
>> to upgrade to the last release in their current branch instead of 
>> upgrading to 1.2.x which contains functional changes to 1.1.
> Can you be more clear on what is the MAJOR difference between versions 
> 1.1.9 and 1.2.11  . why the 1.1 family stopped , is 1.1.9 is stable  @ 
> 1.1 family ........

It is all detailed in the release notes:

http://main.slony.info/viewcvs/viewvc.cgi/slony1-engine/RELEASE?revision=1.1.2.13&view=markup

Highlights would be

   - redesign of process structure (watchdog thread)
   - handling of large attributes (memory)
   - log switching
   - reduction of pg_listener use
   - splitting DDL scripts into separate statements


Jan

-- 
#======================================================================#
# It's easier to get forgiveness for being wrong than for being right. #
# Let's break this rule - forgive me.                                  #
#================================================== JanWieck@Yahoo.com #
From ajs at crankycanuck.ca  Fri Aug 31 06:51:09 2007
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Fri Aug 31 06:51:29 2007
Subject: [Slony1-general] Re: Bug in slonik SQL parser: comments are not
	removed properly
In-Reply-To: <46D7886F.5040902@Yahoo.com>
References: <d7df81620708290821p38284405uc095f811740132c8@mail.gmail.com>
	<d7df81620708291152s6d1ce8aaqe87c04be8a462af4@mail.gmail.com>
	<46D6E9D9.2040306@Yahoo.com> <46D6EDD0.5080305@ca.afilias.info>
	<d7df81620708301049h614000fau9b560595289074cf@mail.gmail.com>
	<20070830184639.GO7661@phlogiston.dyndns.org>
	<46D75CAD.9070502@Yahoo.com>
	<20070831023443.GA11181@phlogiston.dyndns.org>
	<46D7886F.5040902@Yahoo.com>
Message-ID: <20070831135109.GA12876@phlogiston.dyndns.org>

On Thu, Aug 30, 2007 at 11:18:07PM -0400, Jan Wieck wrote:
> Exactly. We don't have enough developers. And I truly think that we have 
> much bigger fish to fry than supporting complicated comment structures.

That's ok with me; my point is just that we can't dismiss this.  So.
. .

> The way I see it is that we will change our parser to simply REJECT a 
> DDL script if there is any /* style comment in there at all, document it 
> that way and be done with it. At least it won't allow to break 
> replication any more.

. . .this sounds ok to me.  The non-breaking part is what's
important.

A

-- 
Andrew Sullivan  | ajs@crankycanuck.ca
A certain description of men are for getting out of debt, yet are
against all taxes for raising money to pay it off.
		--Alexander Hamilton
From cbbrowne at ca.afilias.info  Fri Aug 31 06:58:09 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Fri Aug 31 06:58:29 2007
Subject: [Slony1-general] Which is Version of slony-I to use ??
In-Reply-To: <46D8050C.80905@intoto.com> (Trinath Somanchi's message of "Fri,
	31 Aug 2007 17:39:48 +0530")
References: <46D7B436.90502@intoto.com>
	<d7df81620708310008n399f44e6y637c92cd2f6cfa2b@mail.gmail.com>
	<46D7CBE7.4030506@intoto.com> <46D7FBA6.6060108@Yahoo.com>
	<46D8050C.80905@intoto.com>
Message-ID: <60bqcnztzi.fsf@dba2.int.libertyrms.com>

Trinath Somanchi <trinaths@intoto.com> writes:
> Can you be more clear on what is the MAJOR difference between versions 1.1.9 and 1.2.11? . why the 1.1 family stopped ,
> is 1.1.9 is stable? @ 1.1 family ........

If you examine the release notes in 1.2.11 (the file "RELEASE" in the
tarball), you will see ALL of the differences between it and 1.1.9.

Version 1.1 was the older major version; version 1.2 is the newer
major version.  See release notes in the builds to see the "major
differences."  You'll read for a long time; there are a lot of them...
-- 
"cbbrowne","@","linuxfinances.info"
http://linuxdatabases.info/info/x.html
Unix *is*  user friendly.  It's  just selective about who  its friends
are...
From cscetbon.ext at orange-ftgroup.com  Fri Aug 31 07:08:55 2007
From: cscetbon.ext at orange-ftgroup.com (Cyril SCETBON)
Date: Fri Aug 31 07:09:02 2007
Subject: [Slony1-general] Configuration on 2 sites
In-Reply-To: <46D7FE31.3080308@Yahoo.com>
References: <46D3EF28.40108@orange-ftgroup.com>	<20070828132235.GA461@phlogi	ston.dyndns.org>	<46D43DAF.5010604@orange-ftgroup.com>	<20070828152919.GB97	9@phlogiston.dyndns.org>	<46D539A4.9020601@orange-ftgroup.com>	<20070829174	509.GR4183@phlogiston.dyndns.org>	<46D5B216.2010708@orange-ftgroup.com>	<20	070829180550.GT4183@phlogiston.dyndns.org>	<46D5BD84.8090302@orange-ftgroup.com>
	<46D7D4AE.6000600@orange-ftgroup.com> <46D7FE31.3080308@Yahoo.com>
Message-ID: <46D820F7.7070904@orange-ftgroup.com>



Jan Wieck wrote:
> On 8/31/2007 4:43 AM, Cyril SCETBON wrote:
>>
>> Cyril SCETBON wrote:
>>>
>>>
>>> Andrew Sullivan wrote:
>>>> On Wed, Aug 29, 2007 at 07:51:18PM +0200, Cyril SCETBON wrote:
>>>>  
>>>>> So, How can I do if M2 is lost ? Cause I don't want S2 to resync 
>>>>> with M1 from scratch
>>>>>     
>>>>
>>>> You can't.  If you can't co-ordinate a switchover, then you lose the
>>>> node.  This is discussed at length in the manual.
>>>>   
>>> Really ????
>>> Are you really saying that losing M2 make me lose S2 ?????
>>> If it's true I'm really disappointed by slony :-(
>>>
>>> My config is as follows (just to remember) :
>>>
>>> psql db1 -c 'select * from "_CLUSTER1".sl_subscribe'
>>> sub_set | sub_provider | sub_receiver | sub_forward | sub_active
>>> ---------+--------------+--------------+-------------+------------
>>>      1 |            1 (M1)|            3 (M2)| t           | t
>>>      1 |            1 (M1)|            2 (S1) | t           | t
>>>      1 |            3 (M2)|            4 (S2) | t           | t
>
> Since all nodes in your scenario are forwarders, you won't lose 
> anything other than the failed node ever. In your configuration if you 
> lose node M2 (which is a subscriber), simply issuing a new SUBSCRIBE 
> SET for node S2 to use M1 or S1 as data provider will do. It will 
> catch up from there without the need to sync from scratch.
I tried reshaping subscription. The subscription works. But no more 
updates go to S2.


>
>
> Jan
>

-- 
Cyril SCETBON - Ing?nieur bases de donn?es
AUSY pour France T?l?com - SCR/HDI/DOP/HEBEX

T?l : +33 (0)4 97 12 87 60
Jabber : cscetbon@jabber.org
France Telecom - Orange
790 Avenue du Docteur Maurice Donat 
B?timent Marco Polo C2 
06250 Mougins
France

***********************************
Ce message et toutes les pieces jointes (ci-apres le 'message') sont
confidentiels et etablis a l'intention exclusive de ses destinataires.
Toute utilisation ou diffusion non autorisee est interdite.
Tout message electronique est susceptible d'alteration. Le Groupe France
Telecom decline toute responsabilite au titre de ce message s'il a ete
altere, deforme ou falsifie.
Si vous n'etes pas destinataire de ce message, merci de le detruire
immediatement et d'avertir l'expediteur.
***********************************
This message and any attachments (the 'message') are confidential and
intended solely for the addressees.
Any unauthorised use or dissemination is prohibited.
Messages are susceptible to alteration. France Telecom Group shall not be
liable for the message if altered, changed or falsified.
If you are not recipient of this message, please cancel it immediately and
inform the sender.
************************************

From jeff at frostconsultingllc.com  Fri Aug 31 09:10:54 2007
From: jeff at frostconsultingllc.com (Jeff Frost)
Date: Fri Aug 31 09:11:05 2007
Subject: [Slony1-general] problems with slony1-1.2.10 and postgresql-8.2.4
In-Reply-To: <Pine.LNX.4.64.0708061023230.2605@glacier.frostconsultingllc.com>
References: <Pine.LNX.4.64.0708011022360.2605@glacier.frostconsultingllc.com>
	<72dbd3150708011723qb80ef8fydae4dd5f75fa1292@mail.gmail.com> 
	<Pine.LNX.4.64.0708011802500.1940@discord.home.frostconsultingllc.com> 
	<72dbd3150708012003s11bac86dk1b7c87c4a5b79625@mail.gmail.com> 
	<Pine.LNX.4.64.0708012011050.1940@discord.home.frostconsultingllc.com>
	<1186252557.21688.16.camel@laptop.gunduz.org>
	<Pine.LNX.4.64.0708061023230.2605@glacier.frostconsultingllc.com>
Message-ID: <Pine.LNX.4.64.0708310908050.11463@discord.home.frostconsultingllc.com>

On Mon, 6 Aug 2007, Jeff Frost wrote:

>> [root@evim ~]# rpm -q --queryformat="%{ARCH}" postgresql-server
>> x86_64
>> 
>> [root@evim ~]# file `rpm -ql postgresql-server|grep /usr/bin`
>> /usr/bin/initdb:         ELF 64-bit LSB executable, x86-64, version 1 
>> (SYSV), dynamically linked (uses shared libs), for GNU/Linux 2.6.9, 
>> stripped
>> /usr/bin/ipcclean:       Bourne shell script text executable
>> /usr/bin/pg_controldata: ELF 64-bit LSB executable, x86-64, version 1 
>> (SYSV), dynamically linked (uses shared libs), for GNU/Linux 2.6.9, 
>> stripped
>> /usr/bin/pg_ctl:         ELF 64-bit LSB executable, x86-64, version 1 
>> (SYSV), dynamically linked (uses shared libs), for GNU/Linux 2.6.9, 
>> stripped
>> /usr/bin/pg_resetxlog:   ELF 64-bit LSB executable, x86-64, version 1 
>> (SYSV), dynamically linked (uses shared libs), for GNU/Linux 2.6.9, 
>> stripped
>> /usr/bin/postgres:       ELF 64-bit LSB executable, x86-64, version 1 
>> (SYSV), dynamically linked (uses shared libs), for GNU/Linux 2.6.9, 
>> stripped
>> /usr/bin/postmaster:     symbolic link to `postgres'
>
> Unfortunately, I don't have those 32-bit 8.2.4 RPMs installed anywhere at the 
> moment, but will circle back on this as soon as a 32-bit machine is available 
> again.

Finally got to circle back around on this.  It seems a different 32-bit system 
acted the same.  However, doing the maximum uptime procedure of:

* drop node
* upgrade postgresql
* subscribe node

works fine.  I'm not sure why I can't subscribe a dumped version of the 
master's database with the slony schema removed on a new 8.2.4 master, but 
this is a reasonable way to go.

Thanks to everyone for the help and suggestions!


-- 
Jeff Frost, Owner 	<jeff@frostconsultingllc.com>
Frost Consulting, LLC 	http://www.frostconsultingllc.com/
Phone: 650-780-7908	FAX: 650-649-1954
From JanWieck at Yahoo.com  Fri Aug 31 09:30:38 2007
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Fri Aug 31 09:30:49 2007
Subject: [Slony1-general] Re: Bug in slonik SQL parser: comments are not
	removed properly
In-Reply-To: <20070831135109.GA12876@phlogiston.dyndns.org>
References: <d7df81620708290821p38284405uc095f811740132c8@mail.gmail.com>
	<d7df81620708291152s6d1ce8aaqe87c04be8a462af4@mail.gmail.com>
	<46D6E9D9.2040306@Yahoo.com> <46D6EDD0.5080305@ca.afilias.info>
	<d7df81620708301049h614000fau9b560595289074cf@mail.gmail.com>
	<20070830184639.GO7661@phlogiston.dyndns.org>
	<46D75CAD.9070502@Yahoo.com>
	<20070831023443.GA11181@phlogiston.dyndns.org>
	<46D7886F.5040902@Yahoo.com>
	<20070831135109.GA12876@phlogiston.dyndns.org>
Message-ID: <46D8422E.7010203@Yahoo.com>

On 8/31/2007 9:51 AM, Andrew Sullivan wrote:
> On Thu, Aug 30, 2007 at 11:18:07PM -0400, Jan Wieck wrote:
>> Exactly. We don't have enough developers. And I truly think that we have 
>> much bigger fish to fry than supporting complicated comment structures.
> 
> That's ok with me; my point is just that we can't dismiss this.  So.
> . .
> 
>> The way I see it is that we will change our parser to simply REJECT a 
>> DDL script if there is any /* style comment in there at all, document it 
>> that way and be done with it. At least it won't allow to break 
>> replication any more.
> 
> . . .this sounds ok to me.  The non-breaking part is what's
> important.

What gets me puzzled about it is that the script apparently did execute 
on the origin (where all DDL is injected unless it is EXECUTE ONLY ON), 
but later on breaks on a subscriber. Slonik and slon use the same parser 
to split the statements. So how did that happen?


Jan

-- 
#======================================================================#
# It's easier to get forgiveness for being wrong than for being right. #
# Let's break this rule - forgive me.                                  #
#================================================== JanWieck@Yahoo.com #
From JanWieck at Yahoo.com  Fri Aug 31 09:32:23 2007
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Fri Aug 31 09:32:31 2007
Subject: [Slony1-general] Configuration on 2 sites
In-Reply-To: <46D820F7.7070904@orange-ftgroup.com>
References: <46D3EF28.40108@orange-ftgroup.com>	<20070828132235.GA461@phlogi	ston.dyndns.org>	<46D43DAF.5010604@orange-ftgroup.com>	<20070828152919.GB97	9@phlogiston.dyndns.org>	<46D539A4.9020601@orange-ftgroup.com>	<20070829174	509.GR4183@phlogiston.dyndns.org>	<46D5B216.2010708@orange-ftgroup.com>	<20	070829180550.GT4183@phlogiston.dyndns.org>	<46D5BD84.8090302@orange-ftgroup.com>
	<46D7D4AE.6000600@orange-ftgroup.com> <46D7FE31.3080308@Yahoo.com>
	<46D820F7.7070904@orange-ftgroup.com>
Message-ID: <46D84297.8010204@Yahoo.com>

On 8/31/2007 10:08 AM, Cyril SCETBON wrote:
> 
> Jan Wieck wrote:
>> On 8/31/2007 4:43 AM, Cyril SCETBON wrote:
>>>
>>> Cyril SCETBON wrote:
>>>>
>>>>
>>>> Andrew Sullivan wrote:
>>>>> On Wed, Aug 29, 2007 at 07:51:18PM +0200, Cyril SCETBON wrote:
>>>>>  
>>>>>> So, How can I do if M2 is lost ? Cause I don't want S2 to resync 
>>>>>> with M1 from scratch
>>>>>>     
>>>>>
>>>>> You can't.  If you can't co-ordinate a switchover, then you lose the
>>>>> node.  This is discussed at length in the manual.
>>>>>   
>>>> Really ????
>>>> Are you really saying that losing M2 make me lose S2 ?????
>>>> If it's true I'm really disappointed by slony :-(
>>>>
>>>> My config is as follows (just to remember) :
>>>>
>>>> psql db1 -c 'select * from "_CLUSTER1".sl_subscribe'
>>>> sub_set | sub_provider | sub_receiver | sub_forward | sub_active
>>>> ---------+--------------+--------------+-------------+------------
>>>>      1 |            1 (M1)|            3 (M2)| t           | t
>>>>      1 |            1 (M1)|            2 (S1) | t           | t
>>>>      1 |            3 (M2)|            4 (S2) | t           | t
>>
>> Since all nodes in your scenario are forwarders, you won't lose 
>> anything other than the failed node ever. In your configuration if you 
>> lose node M2 (which is a subscriber), simply issuing a new SUBSCRIBE 
>> SET for node S2 to use M1 or S1 as data provider will do. It will 
>> catch up from there without the need to sync from scratch.
> I tried reshaping subscription. The subscription works. But no more 
> updates go to S2.

Check the sl_path configuration. S2 might not have the necessary (or 
correct) information to connect to its new data provider.


Jan

-- 
#======================================================================#
# It's easier to get forgiveness for being wrong than for being right. #
# Let's break this rule - forgive me.                                  #
#================================================== JanWieck@Yahoo.com #
