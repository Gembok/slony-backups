From open at immo.ru  Fri Jun  1 00:03:29 2007
From: open at immo.ru (open)
Date: Fri Jun  1 00:04:13 2007
Subject: [Slony1-general] how can i clean sl_events?
In-Reply-To: <465EEF3E.70205@Yahoo.com>
References: <465E5E3C.1080505@immo.ru>	<20070531112950.GD19397@phlogiston.dyndns.org>	<465EB4BA.3070700@immo.ru>
	<465EC77D.1040807@Yahoo.com> <465ED13A.9030700@immo.ru>
	<465EEF3E.70205@Yahoo.com>
Message-ID: <465FC4C1.20501@immo.ru>

I see this in the master's slony log

stalingrad.xxx.xx = Node 6, it is a this truble node....

Jun  1 10:23:28 vps137 slon_mmedia[7509]: [662-1] DEBUG4 version for 
"host=stalingrad.xxx.xx dbname=multimedia user=postgres port=5432 
password=XXXX" is 80012
Jun  1 10:23:28 vps137 slon_mmedia[7509]: [663-1] ERROR  
remoteListenThread_6: db_getLocalNodeId() returned 2 - wrong database?
Jun  1 10:23:34 vps137 slon_mmedia[7509]: [664-1] DEBUG2 
remoteListenThread_2: queue event 2,133595 SYNC
Jun  1 10:23:34 vps137 slon_mmedia[7509]: [665-1] DEBUG2 
remoteListenThread_2: UNLISTEN
Jun  1 10:23:34 vps137 slon_mmedia[7509]: [666-1] DEBUG2 
remoteWorkerThread_2: Received event 2,133595 SYNC
Jun  1 10:23:34 vps137 slon_mmedia[7509]: [667-1] DEBUG3 calc sync size 
- last time: 1 last length: 9861 ideal: 20 proposed size: 3
Jun  1 10:23:34 vps137 slon_mmedia[7509]: [668-1] DEBUG2 
remoteWorkerThread_2: SYNC 133595 processing
Jun  1 10:23:34 vps137 slon_mmedia[7509]: [669-1] DEBUG2 
remoteWorkerThread_2: no sets need syncing for this event
Jun  1 10:23:34 vps137 slon_mmedia[7509]: [670-1] DEBUG2 
remoteWorkerThread_2: forward confirm 1,128662 received by 3
Jun  1 10:23:34 vps137 slon_mmedia[7509]: [671-1] DEBUG2 
remoteWorkerThread_2: forward confirm 3,134976 received by 5
Jun  1 10:23:34 vps137 slon_mmedia[7509]: [672-1] DEBUG2 
remoteListenThread_3: LISTEN
Jun  1 10:23:34 vps137 slon_mmedia[7509]: [673-1] DEBUG2 
remoteWorkerThread_3: forward confirm 2,133595 received by 3
Jun  1 10:23:38 vps137 slon_mmedia[7509]: [674-1] DEBUG4 version for 
"host=stalingrad.xxx.xx dbname=multimedia user=postgres port=5432 
password=XXXX" is 80012
Jun  1 10:23:38 vps137 slon_mmedia[7509]: [675-1] ERROR  
remoteListenThread_6: db_getLocalNodeId() returned 2 - wrong database?
Jun  1 10:23:40 vps137 slon_mmedia[7509]: [676-1] DEBUG2 
remoteListenThread_4: queue event 4,133189 SYNC
Jun  1 10:23:40 vps137 slon_mmedia[7509]: [677-1] DEBUG2 
remoteWorkerThread_4: Received event 4,133189 SYNC

I'm google' ing "getLocalNodeId() returned 2 - wrong database" and see 
to the
src/backend/slony1_funcs.c and src/slon/remote_listen.c
but i don't know WHY and WHAT does it mean "ERROR  remoteListenThread_6: 
db_getLocalNodeId() returned 2 - wrong database?"





Jan Wieck wrote:
> On 5/31/2007 9:44 AM, open wrote:
>>> Check the output of the sl_status view over a couple of minutes. If 
>>> the column st_last_event for any of your subscribers is not 
>>> advancing, the event confirmations from that node still don't make 
>>> it back to the origin and your engineer has more to fix.
>> .....bad news, sl_status looks nornally....
>> st_last_event  increases normally....
>> have you any ideas ?
>
> Ooops ... my fault ... I meant the column st_received. As it looks to 
> me, node 6 is either not replicating, or the confirmations don't make 
> it back to the origin. The origin thinks it is stuck on event 69838.
>
>
> Jan
>
>
>>
>> WBR, open.
>>
>> [root@vps135 ~]# psql multimedia postgres -c "select * from 
>> _multimedia.sl_status"
>>  st_origin | st_received | st_last_event |      st_last_event_ts      
>> | st_last_received |    st_last_received_ts     | 
>> st_last_received_event_ts  | st_lag_num_events |      
>> st_lag_time      
>> -----------+-------------+---------------+----------------------------+------------------+----------------------------+----------------------------+-------------------+------------------------ 
>>
>>          1 |           2 |        125597 | 2007-05-31 17:34:11.315586 
>> |           125596 | 2007-05-31 17:34:00.400391 | 2007-05-31 
>> 17:33:51.299999 |                 1 | 00:00:39.454171
>>          1 |           3 |        125597 | 2007-05-31 17:34:11.315586 
>> |           125597 | 2007-05-31 17:34:12.837879 | 2007-05-31 
>> 17:34:11.315586 |                 0 | 00:00:19.438584
>>          1 |           6 |        125597 | 2007-05-31 17:34:11.315586 
>> |            69838 | 2007-05-24 09:29:13.589914 | 2007-05-24 
>> 09:29:12.580015 |             55759 | 7 days 08:05:18.174155
>>          1 |           4 |        125597 | 2007-05-31 17:34:11.315586 
>> |           125597 | 2007-05-31 18:23:10.653676 | 2007-05-31 
>> 17:34:11.315586 |                 0 | 00:00:19.438584
>>          1 |           5 |        125597 | 2007-05-31 17:34:11.315586 
>> |           125597 | 2007-05-31 17:33:29.585481 | 2007-05-31 
>> 17:34:11.315586 |                 0 | 00:00:19.438584
>> (5 rows)
>>
>> [root@vps135 ~]# psql multimedia postgres -c "select * from 
>> _multimedia.sl_status"
>>  st_origin | st_received | st_last_event |      st_last_event_ts      
>> | st_last_received |    st_last_received_ts     | 
>> st_last_received_event_ts  | st_lag_num_events |        
>> st_lag_time        
>> -----------+-------------+---------------+----------------------------+------------------+----------------------------+----------------------------+-------------------+---------------------------- 
>>
>>          1 |           2 |        125598 | 2007-05-31 17:34:31.419948 
>> |           125597 | 2007-05-31 17:34:21.424266 | 2007-05-31 
>> 17:34:11.315586 |                 1 | 00:00:28.263841
>>          1 |           3 |        125598 | 2007-05-31 17:34:31.419948 
>> |           125597 | 2007-05-31 17:34:12.837879 | 2007-05-31 
>> 17:34:11.315586 |                 1 | 00:00:28.263841
>>          1 |           6 |        125598 | 2007-05-31 17:34:31.419948 
>> |            69838 | 2007-05-24 09:29:13.589914 | 2007-05-24 
>> 09:29:12.580015 |             55760 | 7 days 08:05:26.9994119999
>>          1 |           4 |        125598 | 2007-05-31 17:34:31.419948 
>> |           125598 | 2007-05-31 18:23:31.422288 | 2007-05-31 
>> 17:34:31.419948 |                 0 | 00:00:08.159479
>>          1 |           5 |        125598 | 2007-05-31 17:34:31.419948 
>> |           125597 | 2007-05-31 17:33:29.585481 | 2007-05-31 
>> 17:34:11.315586 |                 1 | 00:00:28.263841
>> (5 rows)
>>
>> [root@vps135 ~]# psql multimedia postgres -c "select * from 
>> _multimedia.sl_status"
>>  st_origin | st_received | st_last_event |      st_last_event_ts      
>> | st_last_received |    st_last_received_ts     | 
>> st_last_received_event_ts  | st_lag_num_events |      
>> st_lag_time      
>> -----------+-------------+---------------+----------------------------+------------------+----------------------------+----------------------------+-------------------+------------------------ 
>>
>>          1 |           2 |        125618 | 2007-05-31 17:41:12.190197 
>> |           125617 | 2007-05-31 17:41:01.543596 | 2007-05-31 
>> 17:40:52.162198 |                 1 | 00:00:31.501594
>>          1 |           3 |        125618 | 2007-05-31 17:41:12.190197 
>> |           125618 | 2007-05-31 17:41:04.928925 | 2007-05-31 
>> 17:41:12.190197 |                 0 | 00:00:11.473595
>>          1 |           6 |        125618 | 2007-05-31 17:41:12.190197 
>> |            69838 | 2007-05-24 09:29:13.589914 | 2007-05-24 
>> 09:29:12.580015 |             55780 | 7 days 08:12:11.083777
>>          1 |           4 |        125618 | 2007-05-31 17:41:12.190197 
>> |           125618 | 2007-05-31 18:30:16.192276 | 2007-05-31 
>> 17:41:12.190197 |                 0 | 00:00:11.473595
>>          1 |           5 |        125618 | 2007-05-31 17:41:12.190197 
>> |           125618 | 2007-05-31 17:40:31.441314 | 2007-05-31 
>> 17:41:12.190197 |                 0 | 00:00:11.473595
>> (5 rows)
>>
>>
>> _______________________________________________
>> Slony1-general mailing list
>> Slony1-general@lists.slony.info
>> http://lists.slony.info/mailman/listinfo/slony1-general
>
>

From open at immo.ru  Fri Jun  1 01:08:56 2007
From: open at immo.ru (open)
Date: Fri Jun  1 01:09:32 2007
Subject: [Slony1-general] BUG or NOT in 1.2.9 ?
Message-ID: <465FD418.2090801@immo.ru>

slonik_init_claster don't process the "parent" directive, but in oldest 
version it was OK....
but slonik_biuld_env paste by default

$parentString = ', parent=>1';

WHY slonik_init_claster DON'T USE IT???

slon version 1.2.9

From dmitry at koterov.ru  Fri Jun  1 02:41:44 2007
From: dmitry at koterov.ru (Dmitry Koterov)
Date: Fri Jun  1 02:42:01 2007
Subject: [Slony1-general] Does slonik EXECUTE SCRIPT call waits for comands
	termination?
In-Reply-To: <d7df81620706010232p5fdc61efsdcbe1efbab427f7e@mail.gmail.com>
References: <d7df81620706010232p5fdc61efsdcbe1efbab427f7e@mail.gmail.com>
Message-ID: <d7df81620706010241vd227aa7u4e4436fd9d6e472d@mail.gmail.com>

Hello.

Seems when I use EXECUTE
SCRIPT<http://slony.info/documentation/stmtddlscript.html>and slonik
reports PGRES_TUPLES_OK updates may NOT be finished yet on all
slaves.
I ran a long ALTER TABLE statement (about 3 minutes), master updated
immediately after I had seen PGRES_TUPLES_OK, but slave - 10 or more minutes
later.

So, the questions are:

1. THE MAIN question: is it possible to ask slonik to wait untill all scheme
changes were propogated to all slaves after a slonik call?

2. If slonik updates slaves not immediately, but via event creation, why
does it still need to know an information about ALL database hosts, not only
about the master database? I have to enumerate all slave hosts in slonik
calls:

cluster name =3D my_cluster;
 node 1 admin conninfo=3D'host=3Dhost1 dbname=3Dm user=3Dslony port=3D5432
password=3D**';
 node 2 admin conninfo=3D'host=3Dhost2 dbname=3Dm user=3Dslony port=3D5432
password=3D**';
 node 3 admin conninfo=3D'host=3Dhost3 dbname=3Dm user=3Dslony port=3D5432
password=3D**';
 ...
  execute script (
    set id =3D 1,
    filename =3D '/tmp/e0H7Aa03Fh',
    event node =3D 1
  );

But if a schema changes are propogated via events, theoretically we have to
know only master's address...
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070601/=
e9b1a676/attachment.htm
From open at immo.ru  Fri Jun  1 02:43:30 2007
From: open at immo.ru (open)
Date: Fri Jun  1 02:44:12 2007
Subject: [Slony1-general] if the slon daemon stop at all (on master and
 slaves) SL_NODELOCK must be empty ???
Message-ID: <465FEA42.2060208@immo.ru>

HI one more time :)
Anybody know in what moment of time slony clean SL_NODELOCK ?

if the slon daemon stop at all (on master and slaves) SL_NODELOCK must 
be empty ???

i have about 120 row( on the slave number 6), in claster consist 1 
master and 5 slave, i think that it's WRONG I'm right ?


multimedia=# SELECT * FROM _multimedia.sl_nodelock;
 nl_nodeid | nl_conncnt | nl_backendpid
-----------+------------+---------------
         2 |          0 |         25223
         1 |      94278 |          4770
         2 |      94279 |          4787
         2 |      94280 |          4794
         1 |      94281 |          4838
         2 |      94282 |          4864
         2 |      94283 |          4868
         1 |      94284 |          4878
         2 |      94285 |          4889
         2 |      94286 |          4896
         1 |      94287 |          4903
         2 |      94288 |          4922
         2 |      94289 |          4929
         1 |      94290 |          4936
         2 |      94291 |          4943
         2 |      94292 |          4950
         1 |      94293 |          4957
         2 |      94294 |          4968
         2 |      94295 |          4975
         1 |      94296 |          4982
         2 |      94297 |          4989
         2 |      94298 |          4996
         1 |      94299 |          5038
         2 |      94300 |          5049
         2 |      94301 |          5056
         1 |      94302 |          5063
         2 |      94303 |          5074
         2 |      94304 |          5081
         1 |      94305 |          5094
         2 |      94306 |          5113
         2 |      94307 |          5123
         1 |      94308 |          5130
         2 |      94309 |          5139
         2 |      94310 |          5146
         1 |      94311 |          5153
         2 |      94312 |          5164
         2 |      94313 |          5171
         1 |      94314 |          5181
         2 |      94315 |          5195
         2 |      94316 |          5230
         1 |      94317 |          5238
         2 |      94318 |          5245
         2 |      94319 |          5252
         1 |      94320 |          5259
         2 |      94321 |          5270
         2 |      94322 |          5277
         1 |      94323 |          5284
         2 |      94324 |          5303
         2 |      94325 |          5310
         1 |      94326 |          5317
         2 |      94327 |          5324
         2 |      94328 |          5332
         1 |      94329 |          5339
         2 |      94330 |          5350
         2 |      94331 |          5357
         1 |      94332 |          5364
........ <SKIP> ..........

WBR, open

From ajs at crankycanuck.ca  Fri Jun  1 04:08:37 2007
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Fri Jun  1 04:09:00 2007
Subject: [Slony1-general] Does slonik EXECUTE SCRIPT call waits for
	comands termination?
In-Reply-To: <d7df81620706010241vd227aa7u4e4436fd9d6e472d@mail.gmail.com>
References: <d7df81620706010232p5fdc61efsdcbe1efbab427f7e@mail.gmail.com>
	<d7df81620706010241vd227aa7u4e4436fd9d6e472d@mail.gmail.com>
Message-ID: <20070601110837.GG23806@phlogiston.dyndns.org>

On Fri, Jun 01, 2007 at 01:41:44PM +0400, Dmitry Koterov wrote:
> Seems when I use EXECUTE
> SCRIPT<http://slony.info/documentation/stmtddlscript.html>and slonik
> reports PGRES_TUPLES_OK updates may NOT be finished yet on all
> slaves.

Right.  If that weren't the case, we wouldn't have WAIT FOR EVENT.

> 1. THE MAIN question: is it possible to ask slonik to wait untill all scheme
> changes were propogated to all slaves after a slonik call?

See above, and http://slony.info/documentation/stmtwaitevent.html

> 2. If slonik updates slaves not immediately, but via event creation, why
> does it still need to know an information about ALL database hosts, not only
> about the master database? I have to enumerate all slave hosts in slonik
> calls:

You need this information for some cases, and unfortunately that just
means that we require it for all cases.  Slonik is indeed a little
clunky that way.  It wasn't really intended to be the last word in
administration interface for Slony-I.

A

-- 
Andrew Sullivan  | ajs@crankycanuck.ca
This work was visionary and imaginative, and goes to show that visionary
and imaginative work need not end up well. 
		--Dennis Ritchie
From open at immo.ru  Fri Jun  1 06:27:54 2007
From: open at immo.ru (open)
Date: Fri Jun  1 06:28:31 2007
Subject: [Slony1-general] how can i clean sl_events?
In-Reply-To: <5a0a9d6f0705311036k1a96defycaaf53c53fb46024@mail.gmail.com>
References: <465E5E3C.1080505@immo.ru>	
	<20070531112950.GD19397@phlogiston.dyndns.org>	
	<465EB4BA.3070700@immo.ru> <465EC77D.1040807@Yahoo.com>	
	<465ED13A.9030700@immo.ru> <465EEF3E.70205@Yahoo.com>
	<5a0a9d6f0705311036k1a96defycaaf53c53fb46024@mail.gmail.com>
Message-ID: <46601EDA.10202@immo.ru>

Sorry for your spending time, we find trouble.
the
_multimedia.sl_local_node_id (on the ) have a start value 2 
(!!!!!!!!!!!!!!) but this Node 6,
on other node all OK and sl_local_node_id = node identificator

why nobody of us don't know...
all nodes was prepared with slonik_store_node.....

good weekend all



Andrew Hammond wrote:
> On 5/31/07, *Jan Wieck* <JanWieck@yahoo.com 
> <mailto:JanWieck@yahoo.com>> wrote:
>
>     On 5/31/2007 9:44 AM, open wrote:
>     >> Check the output of the sl_status view over a couple of minutes. If
>     >> the column st_last_event for any of your subscribers is not
>     advancing,
>     >> the event confirmations from that node still don't make it back
>     to the
>     >> origin and your engineer has more to fix.
>     > .....bad news, sl_status looks nornally....
>     > st_last_event  increases normally....
>     > have you any ideas ?
>
>     Ooops ... my fault ... I meant the column st_received. As it looks to
>     me, node 6 is either not replicating, or the confirmations don't
>     make it
>     back to the origin. The origin thinks it is stuck on event 69838.
>
>
> I wonder if that has anything to do with the following.
>
> "I'm manually deleting 5-6 rows from sl_event on slave and data
> replication OK,"
>
> Did you delete these rows on node 6 and not on any other node?
> Did you keep a copy of the rows you deleted, or at least note their 
> event number?
>
> Andrew

From dmitry at koterov.ru  Fri Jun  1 06:56:54 2007
From: dmitry at koterov.ru (Dmitry Koterov)
Date: Fri Jun  1 06:57:02 2007
Subject: [Slony1-general] Does slonik EXECUTE SCRIPT call waits for
	comands termination?
In-Reply-To: <20070601110837.GG23806@phlogiston.dyndns.org>
References: <d7df81620706010232p5fdc61efsdcbe1efbab427f7e@mail.gmail.com>
	<d7df81620706010241vd227aa7u4e4436fd9d6e472d@mail.gmail.com>
	<20070601110837.GG23806@phlogiston.dyndns.org>
Message-ID: <d7df81620706010656y45e888ffl98aaafed9340db0c@mail.gmail.com>

Seems WAIT FOR EVENT doesn't help:

echo "
  cluster name =3D my_cluster;
  node 1 admin conninfo=3D'host=3D...'
  node 2 admin conninfo=3D'host=3D...'
  ...
  execute script (
    set id =3D 1,
    filename =3D '/tmp/1kLLzqFEAd',
    event node =3D 1
  );
  WAIT FOR EVENT (
    ORIGIN =3D ALL,
    CONFIRMED =3D ALL,
    WAIT ON =3D 1
  );
" | slonik

This piece of core does not force slonik to wait until all nodes are
updated.
Is there another solution (or any corrections)?

On 6/1/07, Andrew Sullivan <ajs@crankycanuck.ca> wrote:
>
> On Fri, Jun 01, 2007 at 01:41:44PM +0400, Dmitry Koterov wrote:
> > Seems when I use EXECUTE
> > SCRIPT<http://slony.info/documentation/stmtddlscript.html>and slonik
> > reports PGRES_TUPLES_OK updates may NOT be finished yet on all
> > slaves.
>
> Right.  If that weren't the case, we wouldn't have WAIT FOR EVENT.
>
> > 1. THE MAIN question: is it possible to ask slonik to wait untill all
> scheme
> > changes were propogated to all slaves after a slonik call?
>
> See above, and http://slony.info/documentation/stmtwaitevent.html
>
> > 2. If slonik updates slaves not immediately, but via event creation, why
> > does it still need to know an information about ALL database hosts, not
> only
> > about the master database? I have to enumerate all slave hosts in slonik
> > calls:
>
> You need this information for some cases, and unfortunately that just
> means that we require it for all cases.  Slonik is indeed a little
> clunky that way.  It wasn't really intended to be the last word in
> administration interface for Slony-I.
>
> A
>
> --
> Andrew Sullivan  | ajs@crankycanuck.ca
> This work was visionary and imaginative, and goes to show that visionary
> and imaginative work need not end up well.
>                 --Dennis Ritchie
> _______________________________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070601/=
7cb4c061/attachment.htm
From dmitry at koterov.ru  Fri Jun  1 07:52:58 2007
From: dmitry at koterov.ru (Dmitry Koterov)
Date: Fri Jun  1 07:53:03 2007
Subject: [Slony1-general] Does slonik EXECUTE SCRIPT call waits for
	comands termination?
In-Reply-To: <20070601110837.GG23806@phlogiston.dyndns.org>
References: <d7df81620706010232p5fdc61efsdcbe1efbab427f7e@mail.gmail.com>
	<d7df81620706010241vd227aa7u4e4436fd9d6e472d@mail.gmail.com>
	<20070601110837.GG23806@phlogiston.dyndns.org>
Message-ID: <d7df81620706010752o1511402dibbfe8a4b55e7c373@mail.gmail.com>

I also tried to use

try {
   ...
} on success {
  WAIT FOR EVENT (
      ORIGIN =3D ALL,
      CONFIRMED =3D ALL,
      WAIT ON =3D 1
  )
}

- effect is the same: no real waiting after ALTER performed.


On 6/1/07, Andrew Sullivan <ajs@crankycanuck.ca> wrote:
>
> On Fri, Jun 01, 2007 at 01:41:44PM +0400, Dmitry Koterov wrote:
> > Seems when I use EXECUTE
> > SCRIPT<http://slony.info/documentation/stmtddlscript.html>and slonik
> > reports PGRES_TUPLES_OK updates may NOT be finished yet on all
> > slaves.
>
> Right.  If that weren't the case, we wouldn't have WAIT FOR EVENT.
>
> > 1. THE MAIN question: is it possible to ask slonik to wait untill all
> scheme
> > changes were propogated to all slaves after a slonik call?
>
> See above, and http://slony.info/documentation/stmtwaitevent.html
>
> > 2. If slonik updates slaves not immediately, but via event creation, why
> > does it still need to know an information about ALL database hosts, not
> only
> > about the master database? I have to enumerate all slave hosts in slonik
> > calls:
>
> You need this information for some cases, and unfortunately that just
> means that we require it for all cases.  Slonik is indeed a little
> clunky that way.  It wasn't really intended to be the last word in
> administration interface for Slony-I.
>
> A
>
> --
> Andrew Sullivan  | ajs@crankycanuck.ca
> This work was visionary and imaginative, and goes to show that visionary
> and imaginative work need not end up well.
>                 --Dennis Ritchie
> _______________________________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070601/=
6fda548d/attachment.htm
From JanWieck at Yahoo.com  Fri Jun  1 09:26:06 2007
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Fri Jun  1 09:26:22 2007
Subject: [Slony1-general] Does slonik EXECUTE SCRIPT call waits for	comands
	termination?
In-Reply-To: <d7df81620706010752o1511402dibbfe8a4b55e7c373@mail.gmail.com>
References: <d7df81620706010232p5fdc61efsdcbe1efbab427f7e@mail.gmail.com>	<d7df81620706010241vd227aa7u4e4436fd9d6e472d@mail.gmail.com>	<20070601110837.GG23806@phlogiston.dyndns.org>
	<d7df81620706010752o1511402dibbfe8a4b55e7c373@mail.gmail.com>
Message-ID: <4660489E.8040705@Yahoo.com>

On 6/1/2007 10:52 AM, Dmitry Koterov wrote:
> I also tried to use
> 
> try {
>    ...
> } on success {
>   WAIT FOR EVENT (
>       ORIGIN = ALL,
>       CONFIRMED = ALL,
>       WAIT ON = 1
>   )
> }

Looking at the code, it seems that EXECUTE SCRIPT doesn't actually 
record the events seqno in the admin conninfo. Which means that WAIT FOR 
EVENT will wait for an earlier event, or even nothing. Unfortunately the 
same is true for SYNC in 1.2.9.


Jan


> 
> - effect is the same: no real waiting after ALTER performed.
> 
> 
> On 6/1/07, *Andrew Sullivan* <ajs@crankycanuck.ca 
> <mailto:ajs@crankycanuck.ca>> wrote:
> 
>     On Fri, Jun 01, 2007 at 01:41:44PM +0400, Dmitry Koterov wrote:
>      > Seems when I use EXECUTE
>      > SCRIPT<http://slony.info/documentation/stmtddlscript.html
>     <http://slony.info/documentation/stmtddlscript.html>>and slonik
>      > reports PGRES_TUPLES_OK updates may NOT be finished yet on all
>      > slaves.
> 
>     Right.  If that weren't the case, we wouldn't have WAIT FOR EVENT.
> 
>      > 1. THE MAIN question: is it possible to ask slonik to wait untill
>     all scheme
>      > changes were propogated to all slaves after a slonik call?
> 
>     See above, and http://slony.info/documentation/stmtwaitevent.html
> 
>      > 2. If slonik updates slaves not immediately, but via event
>     creation, why
>      > does it still need to know an information about ALL database
>     hosts, not only
>      > about the master database? I have to enumerate all slave hosts in
>     slonik
>      > calls:
> 
>     You need this information for some cases, and unfortunately that just
>     means that we require it for all cases.  Slonik is indeed a little
>     clunky that way.  It wasn't really intended to be the last word in
>     administration interface for Slony-I.
> 
>     A
> 
>     --
>     Andrew Sullivan  | ajs@crankycanuck.ca <mailto:ajs@crankycanuck.ca>
>     This work was visionary and imaginative, and goes to show that visionary
>     and imaginative work need not end up well.
>                     --Dennis Ritchie
>     _______________________________________________
>     Slony1-general mailing list
>     Slony1-general@lists.slony.info <mailto:Slony1-general@lists.slony.info>
>     http://lists.slony.info/mailman/listinfo/slony1-general
> 
> 
> 
> ------------------------------------------------------------------------
> 
> _______________________________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


-- 
#======================================================================#
# It's easier to get forgiveness for being wrong than for being right. #
# Let's break this rule - forgive me.                                  #
#================================================== JanWieck@Yahoo.com #
From ajs at crankycanuck.ca  Fri Jun  1 09:53:37 2007
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Fri Jun  1 09:53:53 2007
Subject: [Slony1-general] Does slonik EXECUTE SCRIPT call waits
	for	comands termination?
In-Reply-To: <4660489E.8040705@Yahoo.com>
References: <d7df81620706010232p5fdc61efsdcbe1efbab427f7e@mail.gmail.com>
	<d7df81620706010241vd227aa7u4e4436fd9d6e472d@mail.gmail.com>
	<20070601110837.GG23806@phlogiston.dyndns.org>
	<d7df81620706010752o1511402dibbfe8a4b55e7c373@mail.gmail.com>
	<4660489E.8040705@Yahoo.com>
Message-ID: <20070601165337.GF24299@phlogiston.dyndns.org>

On Fri, Jun 01, 2007 at 12:26:06PM -0400, Jan Wieck wrote:
> Looking at the code, it seems that EXECUTE SCRIPT doesn't actually 
> record the events seqno in the admin conninfo. Which means that WAIT FOR 
> EVENT will wait for an earlier event, or even nothing. 

This sounds like a serious bug to me.  But this. . . 

> Unfortunately the 
> same is true for SYNC in 1.2.9.

. . . sounds even worse.  Does this mean that some syncs could never
get recorded?

A

-- 
Andrew Sullivan  | ajs@crankycanuck.ca
"The year's penultimate month" is not in truth a good way of saying
November.
		--H.W. Fowler
From andrew.george.hammond at gmail.com  Fri Jun  1 10:01:24 2007
From: andrew.george.hammond at gmail.com (Andrew Hammond)
Date: Fri Jun  1 10:01:30 2007
Subject: [Slony1-general] Does slonik EXECUTE SCRIPT call waits for
	comands termination?
In-Reply-To: <20070601165337.GF24299@phlogiston.dyndns.org>
References: <d7df81620706010232p5fdc61efsdcbe1efbab427f7e@mail.gmail.com>
	<d7df81620706010241vd227aa7u4e4436fd9d6e472d@mail.gmail.com>
	<20070601110837.GG23806@phlogiston.dyndns.org>
	<d7df81620706010752o1511402dibbfe8a4b55e7c373@mail.gmail.com>
	<4660489E.8040705@Yahoo.com>
	<20070601165337.GF24299@phlogiston.dyndns.org>
Message-ID: <5a0a9d6f0706011001t4b57a1d3rf009cd47702dc444@mail.gmail.com>

On 6/1/07, Andrew Sullivan <ajs@crankycanuck.ca> wrote:
>
> On Fri, Jun 01, 2007 at 12:26:06PM -0400, Jan Wieck wrote:
> > Looking at the code, it seems that EXECUTE SCRIPT doesn't actually
> > record the events seqno in the admin conninfo. Which means that WAIT FOR
> > EVENT will wait for an earlier event, or even nothing.
>
> This sounds like a serious bug to me.  But this. . .


> Unfortunately the
> > same is true for SYNC in 1.2.9.
>
> . . . sounds even worse.  Does this mean that some syncs could never
> get recorded?



I think Jan fixed the SYNC issue in the patch on May 15th. I don't know what
the effects of the bug are, aside from breaking WAIT FOR EVENT. I'd really
like to know if there are any other effects.

Andrew
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070601/=
c5ea36c1/attachment.htm
From andrew.george.hammond at gmail.com  Fri Jun  1 10:21:58 2007
From: andrew.george.hammond at gmail.com (Andrew Hammond)
Date: Fri Jun  1 10:22:04 2007
Subject: [Slony1-general] Does slonik EXECUTE SCRIPT call waits for
	comands termination?
In-Reply-To: <4660489E.8040705@Yahoo.com>
References: <d7df81620706010232p5fdc61efsdcbe1efbab427f7e@mail.gmail.com>
	<d7df81620706010241vd227aa7u4e4436fd9d6e472d@mail.gmail.com>
	<20070601110837.GG23806@phlogiston.dyndns.org>
	<d7df81620706010752o1511402dibbfe8a4b55e7c373@mail.gmail.com>
	<4660489E.8040705@Yahoo.com>
Message-ID: <5a0a9d6f0706011021ka30abf6rae34c792aa8c0ee8@mail.gmail.com>

On 6/1/07, Jan Wieck <JanWieck@yahoo.com> wrote:
> On 6/1/2007 10:52 AM, Dmitry Koterov wrote:
> > I also tried to use
> >
> > try {
> >    ...
> > } on success {
> >   WAIT FOR EVENT (
> >       ORIGIN = ALL,
> >       CONFIRMED = ALL,
> >       WAIT ON = 1
> >   )
> > }
>
> Looking at the code, it seems that EXECUTE SCRIPT doesn't actually
> record the events seqno in the admin conninfo. Which means that WAIT FOR
> EVENT will wait for an earlier event, or even nothing. Unfortunately the
> same is true for SYNC in 1.2.9.

Hmmm, I'm looking at slonik.c under slonik_ddl_script() and I see
(starting at line 3706)

    slon_mkquery(&query,
             "select \"_%s\".ddlScript_prepare(%d, %d); ",
             stmt->hdr.script->clustername,
             stmt->ddl_setid, /* dstring_data(&script),  */
             stmt->only_on_node);

    if (db_exec_evcommand((SlonikStmt *) stmt, adminfo1, &query) < 0)

So, it looks like it's recording the event's seqno in the admin
conninfo. What am I missing?

Andrew
From jeff at frostconsultingllc.com  Fri Jun  1 10:46:35 2007
From: jeff at frostconsultingllc.com (Jeff Frost)
Date: Fri Jun  1 10:46:43 2007
Subject: [Slony1-general] Does slonik EXECUTE SCRIPT call waits for
	comands termination?
In-Reply-To: <20070601165337.GF24299@phlogiston.dyndns.org>
References: <d7df81620706010232p5fdc61efsdcbe1efbab427f7e@mail.gmail.com>
	<d7df81620706010241vd227aa7u4e4436fd9d6e472d@mail.gmail.com>
	<20070601110837.GG23806@phlogiston.dyndns.org>
	<d7df81620706010752o1511402dibbfe8a4b55e7c373@mail.gmail.com>
	<4660489E.8040705@Yahoo.com>
	<20070601165337.GF24299@phlogiston.dyndns.org>
Message-ID: <Pine.LNX.4.64.0706010957140.14506@discord.home.frostconsultingllc.com>

On Fri, 1 Jun 2007, Andrew Sullivan wrote:

> On Fri, Jun 01, 2007 at 12:26:06PM -0400, Jan Wieck wrote:
>> Looking at the code, it seems that EXECUTE SCRIPT doesn't actually
>> record the events seqno in the admin conninfo. Which means that WAIT FOR
>> EVENT will wait for an earlier event, or even nothing.
>
> This sounds like a serious bug to me.  But this. . .
>
>> Unfortunately the
>> same is true for SYNC in 1.2.9.
>
> . . . sounds even worse.  Does this mean that some syncs could never
> get recorded?

Is this what's causing this behavior that I reported a while back.  I can't 
seem to find the thread in the archives, but here's a brief recap:

>> [Slony1-general] problems with SYNC/WAIT FOR EVENT
>>
>> I've been using SYNC and WAIT FOR EVENT for some time since 1.2.x came out
>> and I've noticed that occassionally it doesn't seem to work in 1.2.6. It's
>> not every time, just occassionally.



-- 
Jeff Frost, Owner 	<jeff@frostconsultingllc.com>
Frost Consulting, LLC 	http://www.frostconsultingllc.com/
Phone: 650-780-7908	FAX: 650-649-1954
From JanWieck at Yahoo.com  Fri Jun  1 07:40:00 2007
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Fri Jun  1 12:25:22 2007
Subject: [Slony1-general] how can i clean sl_events?
In-Reply-To: <465FC4C1.20501@immo.ru>
References: <465E5E3C.1080505@immo.ru>	<20070531112950.GD19397@phlogiston.dyndns.org>	<465EB4BA.3070700@immo.ru>	<465EC77D.1040807@Yahoo.com>
	<465ED13A.9030700@immo.ru>	<465EEF3E.70205@Yahoo.com>
	<465FC4C1.20501@immo.ru>
Message-ID: <46602FC0.2040500@Yahoo.com>

On 6/1/2007 3:03 AM, open wrote:
> I see this in the master's slony log
> 
> stalingrad.xxx.xx = Node 6, it is a this truble node....

My guess on this one would be that your DNS or hosts table on the master 
returns the wrong IP address for stalingrad.xxx.xx and therefore the 
slon daemon on the master tries to connect actually to node 2 instead of 6.


Jan


> 
> Jun  1 10:23:28 vps137 slon_mmedia[7509]: [662-1] DEBUG4 version for 
> "host=stalingrad.xxx.xx dbname=multimedia user=postgres port=5432 
> password=XXXX" is 80012
> Jun  1 10:23:28 vps137 slon_mmedia[7509]: [663-1] ERROR  
> remoteListenThread_6: db_getLocalNodeId() returned 2 - wrong database?
> Jun  1 10:23:34 vps137 slon_mmedia[7509]: [664-1] DEBUG2 
> remoteListenThread_2: queue event 2,133595 SYNC
> Jun  1 10:23:34 vps137 slon_mmedia[7509]: [665-1] DEBUG2 
> remoteListenThread_2: UNLISTEN
> Jun  1 10:23:34 vps137 slon_mmedia[7509]: [666-1] DEBUG2 
> remoteWorkerThread_2: Received event 2,133595 SYNC
> Jun  1 10:23:34 vps137 slon_mmedia[7509]: [667-1] DEBUG3 calc sync size 
> - last time: 1 last length: 9861 ideal: 20 proposed size: 3
> Jun  1 10:23:34 vps137 slon_mmedia[7509]: [668-1] DEBUG2 
> remoteWorkerThread_2: SYNC 133595 processing
> Jun  1 10:23:34 vps137 slon_mmedia[7509]: [669-1] DEBUG2 
> remoteWorkerThread_2: no sets need syncing for this event
> Jun  1 10:23:34 vps137 slon_mmedia[7509]: [670-1] DEBUG2 
> remoteWorkerThread_2: forward confirm 1,128662 received by 3
> Jun  1 10:23:34 vps137 slon_mmedia[7509]: [671-1] DEBUG2 
> remoteWorkerThread_2: forward confirm 3,134976 received by 5
> Jun  1 10:23:34 vps137 slon_mmedia[7509]: [672-1] DEBUG2 
> remoteListenThread_3: LISTEN
> Jun  1 10:23:34 vps137 slon_mmedia[7509]: [673-1] DEBUG2 
> remoteWorkerThread_3: forward confirm 2,133595 received by 3
> Jun  1 10:23:38 vps137 slon_mmedia[7509]: [674-1] DEBUG4 version for 
> "host=stalingrad.xxx.xx dbname=multimedia user=postgres port=5432 
> password=XXXX" is 80012
> Jun  1 10:23:38 vps137 slon_mmedia[7509]: [675-1] ERROR  
> remoteListenThread_6: db_getLocalNodeId() returned 2 - wrong database?
> Jun  1 10:23:40 vps137 slon_mmedia[7509]: [676-1] DEBUG2 
> remoteListenThread_4: queue event 4,133189 SYNC
> Jun  1 10:23:40 vps137 slon_mmedia[7509]: [677-1] DEBUG2 
> remoteWorkerThread_4: Received event 4,133189 SYNC
> 
> I'm google' ing "getLocalNodeId() returned 2 - wrong database" and see 
> to the
> src/backend/slony1_funcs.c and src/slon/remote_listen.c
> but i don't know WHY and WHAT does it mean "ERROR  remoteListenThread_6: 
> db_getLocalNodeId() returned 2 - wrong database?"
> 
> 
> 
> 
> 
> Jan Wieck wrote:
>> On 5/31/2007 9:44 AM, open wrote:
>>>> Check the output of the sl_status view over a couple of minutes. If 
>>>> the column st_last_event for any of your subscribers is not 
>>>> advancing, the event confirmations from that node still don't make 
>>>> it back to the origin and your engineer has more to fix.
>>> .....bad news, sl_status looks nornally....
>>> st_last_event  increases normally....
>>> have you any ideas ?
>>
>> Ooops ... my fault ... I meant the column st_received. As it looks to 
>> me, node 6 is either not replicating, or the confirmations don't make 
>> it back to the origin. The origin thinks it is stuck on event 69838.
>>
>>
>> Jan
>>
>>
>>>
>>> WBR, open.
>>>
>>> [root@vps135 ~]# psql multimedia postgres -c "select * from 
>>> _multimedia.sl_status"
>>>  st_origin | st_received | st_last_event |      st_last_event_ts      
>>> | st_last_received |    st_last_received_ts     | 
>>> st_last_received_event_ts  | st_lag_num_events |      
>>> st_lag_time      
>>> -----------+-------------+---------------+----------------------------+------------------+----------------------------+----------------------------+-------------------+------------------------ 
>>>
>>>          1 |           2 |        125597 | 2007-05-31 17:34:11.315586 
>>> |           125596 | 2007-05-31 17:34:00.400391 | 2007-05-31 
>>> 17:33:51.299999 |                 1 | 00:00:39.454171
>>>          1 |           3 |        125597 | 2007-05-31 17:34:11.315586 
>>> |           125597 | 2007-05-31 17:34:12.837879 | 2007-05-31 
>>> 17:34:11.315586 |                 0 | 00:00:19.438584
>>>          1 |           6 |        125597 | 2007-05-31 17:34:11.315586 
>>> |            69838 | 2007-05-24 09:29:13.589914 | 2007-05-24 
>>> 09:29:12.580015 |             55759 | 7 days 08:05:18.174155
>>>          1 |           4 |        125597 | 2007-05-31 17:34:11.315586 
>>> |           125597 | 2007-05-31 18:23:10.653676 | 2007-05-31 
>>> 17:34:11.315586 |                 0 | 00:00:19.438584
>>>          1 |           5 |        125597 | 2007-05-31 17:34:11.315586 
>>> |           125597 | 2007-05-31 17:33:29.585481 | 2007-05-31 
>>> 17:34:11.315586 |                 0 | 00:00:19.438584
>>> (5 rows)
>>>
>>> [root@vps135 ~]# psql multimedia postgres -c "select * from 
>>> _multimedia.sl_status"
>>>  st_origin | st_received | st_last_event |      st_last_event_ts      
>>> | st_last_received |    st_last_received_ts     | 
>>> st_last_received_event_ts  | st_lag_num_events |        
>>> st_lag_time        
>>> -----------+-------------+---------------+----------------------------+------------------+----------------------------+----------------------------+-------------------+---------------------------- 
>>>
>>>          1 |           2 |        125598 | 2007-05-31 17:34:31.419948 
>>> |           125597 | 2007-05-31 17:34:21.424266 | 2007-05-31 
>>> 17:34:11.315586 |                 1 | 00:00:28.263841
>>>          1 |           3 |        125598 | 2007-05-31 17:34:31.419948 
>>> |           125597 | 2007-05-31 17:34:12.837879 | 2007-05-31 
>>> 17:34:11.315586 |                 1 | 00:00:28.263841
>>>          1 |           6 |        125598 | 2007-05-31 17:34:31.419948 
>>> |            69838 | 2007-05-24 09:29:13.589914 | 2007-05-24 
>>> 09:29:12.580015 |             55760 | 7 days 08:05:26.9994119999
>>>          1 |           4 |        125598 | 2007-05-31 17:34:31.419948 
>>> |           125598 | 2007-05-31 18:23:31.422288 | 2007-05-31 
>>> 17:34:31.419948 |                 0 | 00:00:08.159479
>>>          1 |           5 |        125598 | 2007-05-31 17:34:31.419948 
>>> |           125597 | 2007-05-31 17:33:29.585481 | 2007-05-31 
>>> 17:34:11.315586 |                 1 | 00:00:28.263841
>>> (5 rows)
>>>
>>> [root@vps135 ~]# psql multimedia postgres -c "select * from 
>>> _multimedia.sl_status"
>>>  st_origin | st_received | st_last_event |      st_last_event_ts      
>>> | st_last_received |    st_last_received_ts     | 
>>> st_last_received_event_ts  | st_lag_num_events |      
>>> st_lag_time      
>>> -----------+-------------+---------------+----------------------------+------------------+----------------------------+----------------------------+-------------------+------------------------ 
>>>
>>>          1 |           2 |        125618 | 2007-05-31 17:41:12.190197 
>>> |           125617 | 2007-05-31 17:41:01.543596 | 2007-05-31 
>>> 17:40:52.162198 |                 1 | 00:00:31.501594
>>>          1 |           3 |        125618 | 2007-05-31 17:41:12.190197 
>>> |           125618 | 2007-05-31 17:41:04.928925 | 2007-05-31 
>>> 17:41:12.190197 |                 0 | 00:00:11.473595
>>>          1 |           6 |        125618 | 2007-05-31 17:41:12.190197 
>>> |            69838 | 2007-05-24 09:29:13.589914 | 2007-05-24 
>>> 09:29:12.580015 |             55780 | 7 days 08:12:11.083777
>>>          1 |           4 |        125618 | 2007-05-31 17:41:12.190197 
>>> |           125618 | 2007-05-31 18:30:16.192276 | 2007-05-31 
>>> 17:41:12.190197 |                 0 | 00:00:11.473595
>>>          1 |           5 |        125618 | 2007-05-31 17:41:12.190197 
>>> |           125618 | 2007-05-31 17:40:31.441314 | 2007-05-31 
>>> 17:41:12.190197 |                 0 | 00:00:11.473595
>>> (5 rows)
>>>
>>>
>>> _______________________________________________
>>> Slony1-general mailing list
>>> Slony1-general@lists.slony.info
>>> http://lists.slony.info/mailman/listinfo/slony1-general
>>
>>
> 
> _______________________________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


-- 
#======================================================================#
# It's easier to get forgiveness for being wrong than for being right. #
# Let's break this rule - forgive me.                                  #
#================================================== JanWieck@Yahoo.com #
From dmitry at koterov.ru  Fri Jun  1 12:50:04 2007
From: dmitry at koterov.ru (Dmitry Koterov)
Date: Fri Jun  1 12:50:13 2007
Subject: [Slony1-general] Does slonik EXECUTE SCRIPT call waits for
	comands termination?
In-Reply-To: <20070601165337.GF24299@phlogiston.dyndns.org>
References: <d7df81620706010232p5fdc61efsdcbe1efbab427f7e@mail.gmail.com>
	<d7df81620706010241vd227aa7u4e4436fd9d6e472d@mail.gmail.com>
	<20070601110837.GG23806@phlogiston.dyndns.org>
	<d7df81620706010752o1511402dibbfe8a4b55e7c373@mail.gmail.com>
	<4660489E.8040705@Yahoo.com>
	<20070601165337.GF24299@phlogiston.dyndns.org>
Message-ID: <d7df81620706011250y2b8eade9h24981a2b7d0a00ff@mail.gmail.com>

So, is there ANY method to wait for ending of EXECUTE SCRIPT?
Let it work not over the slonik, but - any method?

E.g., if just after slonik EXECUTE SCRIPT I fetch the last ev_timestamp from
_my_cluster.sl_event and then - periodically check sl_status to wait until
all slave nodes are processed events with greater timestamps, would it work?




On 6/1/07, Andrew Sullivan <ajs@crankycanuck.ca> wrote:
>
> On Fri, Jun 01, 2007 at 12:26:06PM -0400, Jan Wieck wrote:
> > Looking at the code, it seems that EXECUTE SCRIPT doesn't actually
> > record the events seqno in the admin conninfo. Which means that WAIT FOR
> > EVENT will wait for an earlier event, or even nothing.
>
> This sounds like a serious bug to me.  But this. . .
>
> > Unfortunately the
> > same is true for SYNC in 1.2.9.
>
> . . . sounds even worse.  Does this mean that some syncs could never
> get recorded?
>
> A
>
> --
> Andrew Sullivan  | ajs@crankycanuck.ca
> "The year's penultimate month" is not in truth a good way of saying
> November.
>                 --H.W. Fowler
> _______________________________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070601/=
cec95c7d/attachment.htm
From JanWieck at Yahoo.com  Fri Jun  1 14:49:12 2007
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Fri Jun  1 14:49:27 2007
Subject: [Slony1-general] Does slonik EXECUTE SCRIPT call waits	for	comands
	termination?
In-Reply-To: <20070601165337.GF24299@phlogiston.dyndns.org>
References: <d7df81620706010232p5fdc61efsdcbe1efbab427f7e@mail.gmail.com>	<d7df81620706010241vd227aa7u4e4436fd9d6e472d@mail.gmail.com>	<20070601110837.GG23806@phlogiston.dyndns.org>	<d7df81620706010752o1511402dibbfe8a4b55e7c373@mail.gmail.com>	<4660489E.8040705@Yahoo.com>
	<20070601165337.GF24299@phlogiston.dyndns.org>
Message-ID: <46609458.3030807@Yahoo.com>

On 6/1/2007 12:53 PM, Andrew Sullivan wrote:
> On Fri, Jun 01, 2007 at 12:26:06PM -0400, Jan Wieck wrote:
>> Looking at the code, it seems that EXECUTE SCRIPT doesn't actually 
>> record the events seqno in the admin conninfo. Which means that WAIT FOR 
>> EVENT will wait for an earlier event, or even nothing. 
> 
> This sounds like a serious bug to me.  But this. . . 
> 
>> Unfortunately the 
>> same is true for SYNC in 1.2.9.
> 
> . . . sounds even worse.  Does this mean that some syncs could never
> get recorded?

No, I meant that slonik's SYNC command does not remember the event seqno 
of the SYNC it generated. Thus, SYNC+WAIT does effectively nothing. It 
is fixed in the REL_1_2_STABLE as well as HEAD.

I will fix the EXECUTE part too and then I think it is seriously time 
for 1.2.10.


Jan

-- 
#======================================================================#
# It's easier to get forgiveness for being wrong than for being right. #
# Let's break this rule - forgive me.                                  #
#================================================== JanWieck@Yahoo.com #
From JanWieck at Yahoo.com  Fri Jun  1 14:54:24 2007
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Fri Jun  1 14:54:42 2007
Subject: [Slony1-general] Does slonik EXECUTE SCRIPT call waits for comands
	termination?
In-Reply-To: <5a0a9d6f0706011021ka30abf6rae34c792aa8c0ee8@mail.gmail.com>
References: <d7df81620706010232p5fdc61efsdcbe1efbab427f7e@mail.gmail.com>	
	<d7df81620706010241vd227aa7u4e4436fd9d6e472d@mail.gmail.com>	
	<20070601110837.GG23806@phlogiston.dyndns.org>	
	<d7df81620706010752o1511402dibbfe8a4b55e7c373@mail.gmail.com>	
	<4660489E.8040705@Yahoo.com>
	<5a0a9d6f0706011021ka30abf6rae34c792aa8c0ee8@mail.gmail.com>
Message-ID: <46609590.4020008@Yahoo.com>

On 6/1/2007 1:21 PM, Andrew Hammond wrote:
> On 6/1/07, Jan Wieck <JanWieck@yahoo.com> wrote:
>> On 6/1/2007 10:52 AM, Dmitry Koterov wrote:
>> > I also tried to use
>> >
>> > try {
>> >    ...
>> > } on success {
>> >   WAIT FOR EVENT (
>> >       ORIGIN = ALL,
>> >       CONFIRMED = ALL,
>> >       WAIT ON = 1
>> >   )
>> > }
>>
>> Looking at the code, it seems that EXECUTE SCRIPT doesn't actually
>> record the events seqno in the admin conninfo. Which means that WAIT FOR
>> EVENT will wait for an earlier event, or even nothing. Unfortunately the
>> same is true for SYNC in 1.2.9.
> 
> Hmmm, I'm looking at slonik.c under slonik_ddl_script() and I see
> (starting at line 3706)
> 
>     slon_mkquery(&query,
>              "select \"_%s\".ddlScript_prepare(%d, %d); ",
>              stmt->hdr.script->clustername,
>              stmt->ddl_setid, /* dstring_data(&script),  */
>              stmt->only_on_node);
> 
>     if (db_exec_evcommand((SlonikStmt *) stmt, adminfo1, &query) < 0)
> 
> So, it looks like it's recording the event's seqno in the admin
> conninfo. What am I missing?

You're missing that it isn't ddlScript_prepare() that generates the 
event we want to wait for, but ddlScript_complete(). And that one isn't 
called via db_exec_evcommand().


Jan

-- 
#======================================================================#
# It's easier to get forgiveness for being wrong than for being right. #
# Let's break this rule - forgive me.                                  #
#================================================== JanWieck@Yahoo.com #
From cbbrowne at ca.afilias.info  Fri Jun  1 15:27:12 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Fri Jun  1 15:27:22 2007
Subject: [Slony1-general] Error Condition Found with DDL/EXECUTE SCRIPT
Message-ID: <60tztr1fb3.fsf@dba2.int.libertyrms.com>

I have noticed a scenario (whilst running DDL tests) which causes me
to want to add an extra test to the pre-processing of this...

Suppose we have 3 nodes, and subscriptions have been requested for a
set on all 3 nodes.

Regrettably, due to some error having happened (deranged slon?), the
third node hasn't yet *successfully* subscribed to the set.

If I restart the slon for node #3, soon enough, all is well, and it
subscribes successfully.

If a DDL change comes through, before that time, that can (and will)
destroy the ability to do this.

The DDL change is successfully processed, and hits nodes 1 and 2.

If, at *THAT* point, I restart the slon for node #3, it tries
processing the original SUBSCRIBE SET event, only to discover that the
COPY output from the providers (which have taken account of the
EXECUTE SCRIPT request) have different schemas than node #3.  At which
point node #3 is screwed.  No reasonable fix possible short of
toasting it and recreating the node.

I propose to check to have EXECUTE SCRIPT fail if it discovers a
subscriber from which it does not have a recent confirmation.  (I have
yet to figure out the exact nature of the sl_confirm query; I'll wait
'til Monday on the off-chance that I might get to work and discover a
solution in my inbox ;-).)
-- 
(format nil "~S@~S" "cbbrowne" "ca.afilias.info")
<http://dba2.int.libertyrms.com/>
Christopher Browne
(416) 673-4124 (land)
From darcyb at commandprompt.com  Fri Jun  1 15:33:39 2007
From: darcyb at commandprompt.com (Darcy Buskermolen)
Date: Fri Jun  1 15:33:53 2007
Subject: [Slony1-general] Error Condition Found with DDL/EXECUTE SCRIPT
In-Reply-To: <60tztr1fb3.fsf@dba2.int.libertyrms.com>
References: <60tztr1fb3.fsf@dba2.int.libertyrms.com>
Message-ID: <200706011533.39185.darcyb@commandprompt.com>

On June 1, 2007 03:27 pm, Christopher Browne wrote:
> I have noticed a scenario (whilst running DDL tests) which causes me
> to want to add an extra test to the pre-processing of this...
>
> Suppose we have 3 nodes, and subscriptions have been requested for a
> set on all 3 nodes.
>
> Regrettably, due to some error having happened (deranged slon?), the
> third node hasn't yet *successfully* subscribed to the set.
>
> If I restart the slon for node #3, soon enough, all is well, and it
> subscribes successfully.
>
> If a DDL change comes through, before that time, that can (and will)
> destroy the ability to do this.
>
> The DDL change is successfully processed, and hits nodes 1 and 2.
>
> If, at *THAT* point, I restart the slon for node #3, it tries
> processing the original SUBSCRIBE SET event, only to discover that the
> COPY output from the providers (which have taken account of the
> EXECUTE SCRIPT request) have different schemas than node #3.  At which
> point node #3 is screwed.  No reasonable fix possible short of
> toasting it and recreating the node.
>
> I propose to check to have EXECUTE SCRIPT fail if it discovers a
> subscriber from which it does not have a recent confirmation.  (I have
> yet to figure out the exact nature of the sl_confirm query; I'll wait
> 'til Monday on the off-chance that I might get to work and discover a
> solution in my inbox ;-).)

Would the easy answer not be to look to see if the subscribe event has been 
confirmed by all nodes ?




-- 
Darcy Buskermolen
Command Prompt, Inc.
+1.503.667.4564 X 102
http://www.commandprompt.com/
PostgreSQL solutions since 1997
From JanWieck at Yahoo.com  Fri Jun  1 14:51:34 2007
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Fri Jun  1 17:35:27 2007
Subject: [Slony1-general] Does slonik EXECUTE SCRIPT call waits for	comands
	termination?
In-Reply-To: <d7df81620706011250y2b8eade9h24981a2b7d0a00ff@mail.gmail.com>
References: <d7df81620706010232p5fdc61efsdcbe1efbab427f7e@mail.gmail.com>	<d7df81620706010241vd227aa7u4e4436fd9d6e472d@mail.gmail.com>	<20070601110837.GG23806@phlogiston.dyndns.org>	<d7df81620706010752o1511402dibbfe8a4b55e7c373@mail.gmail.com>	<4660489E.8040705@Yahoo.com>	<20070601165337.GF24299@phlogiston.dyndns.org>
	<d7df81620706011250y2b8eade9h24981a2b7d0a00ff@mail.gmail.com>
Message-ID: <466094E6.9030204@Yahoo.com>

On 6/1/2007 3:50 PM, Dmitry Koterov wrote:
> So, is there ANY method to wait for ending of EXECUTE SCRIPT?
> Let it work not over the slonik, but - any method?

what would currently work is a redundant STORE PATH (identical to an 
existing one) followed by a WAIT. The event for STORE PATH is always 
generated on the client node.


Jan

> 
> E.g., if just after slonik EXECUTE SCRIPT I fetch the last ev_timestamp 
> from _my_cluster.sl_event and then - periodically check sl_status to 
> wait until all slave nodes are processed events with greater timestamps, 
> would it work?
> 
> 
> 
> 
> On 6/1/07, *Andrew Sullivan* <ajs@crankycanuck.ca 
> <mailto:ajs@crankycanuck.ca>> wrote:
> 
>     On Fri, Jun 01, 2007 at 12:26:06PM -0400, Jan Wieck wrote:
>      > Looking at the code, it seems that EXECUTE SCRIPT doesn't actually
>      > record the events seqno in the admin conninfo. Which means that
>     WAIT FOR
>      > EVENT will wait for an earlier event, or even nothing.
> 
>     This sounds like a serious bug to me.  But this. . .
> 
>      > Unfortunately the
>      > same is true for SYNC in 1.2.9.
> 
>     . . . sounds even worse.  Does this mean that some syncs could never
>     get recorded?
> 
>     A
> 
>     --
>     Andrew Sullivan  | ajs@crankycanuck.ca <mailto:ajs@crankycanuck.ca>
>     "The year's penultimate month" is not in truth a good way of saying
>     November.
>                     --H.W. Fowler
>     _______________________________________________
>     Slony1-general mailing list
>     Slony1-general@lists.slony.info <mailto:Slony1-general@lists.slony.info>
>     http://lists.slony.info/mailman/listinfo/slony1-general
> 
> 
> 
> ------------------------------------------------------------------------
> 
> _______________________________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


-- 
#======================================================================#
# It's easier to get forgiveness for being wrong than for being right. #
# Let's break this rule - forgive me.                                  #
#================================================== JanWieck@Yahoo.com #
From JanWieck at Yahoo.com  Fri Jun  1 23:31:19 2007
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Fri Jun  1 23:31:42 2007
Subject: [Slony1-general] Error Condition Found with DDL/EXECUTE SCRIPT
In-Reply-To: <60tztr1fb3.fsf@dba2.int.libertyrms.com>
References: <60tztr1fb3.fsf@dba2.int.libertyrms.com>
Message-ID: <46610EB7.8000408@Yahoo.com>

On 6/1/2007 6:27 PM, Christopher Browne wrote:
> I have noticed a scenario (whilst running DDL tests) which causes me
> to want to add an extra test to the pre-processing of this...
> 
> Suppose we have 3 nodes, and subscriptions have been requested for a
> set on all 3 nodes.
> 
> Regrettably, due to some error having happened (deranged slon?), the
> third node hasn't yet *successfully* subscribed to the set.
> 
> If I restart the slon for node #3, soon enough, all is well, and it
> subscribes successfully.
> 
> If a DDL change comes through, before that time, that can (and will)
> destroy the ability to do this.
> 
> The DDL change is successfully processed, and hits nodes 1 and 2.
> 
> If, at *THAT* point, I restart the slon for node #3, it tries
> processing the original SUBSCRIBE SET event, only to discover that the
> COPY output from the providers (which have taken account of the
> EXECUTE SCRIPT request) have different schemas than node #3.  At which
> point node #3 is screwed.  No reasonable fix possible short of
> toasting it and recreating the node.
> 
> I propose to check to have EXECUTE SCRIPT fail if it discovers a
> subscriber from which it does not have a recent confirmation.  (I have
> yet to figure out the exact nature of the sl_confirm query; I'll wait
> 'til Monday on the off-chance that I might get to work and discover a
> solution in my inbox ;-).)

"... a recent confirmation" ???

If you really want to guard against this stupidity, abort all DDL script 
execution if there are ANY unconfirmed subscriptions in the system. And 
that is not the SUBSCRIBE_SET event alone, but the ENABLE_SUBSCRIPTION too.


Jan

-- 
#======================================================================#
# It's easier to get forgiveness for being wrong than for being right. #
# Let's break this rule - forgive me.                                  #
#================================================== JanWieck@Yahoo.com #
From ajs at crankycanuck.ca  Sat Jun  2 06:28:34 2007
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Sat Jun  2 06:28:48 2007
Subject: [Slony1-general] Error Condition Found with DDL/EXECUTE SCRIPT
In-Reply-To: <60tztr1fb3.fsf@dba2.int.libertyrms.com>
References: <60tztr1fb3.fsf@dba2.int.libertyrms.com>
Message-ID: <20070602132833.GB27256@phlogiston.dyndns.org>

On Fri, Jun 01, 2007 at 06:27:12PM -0400, Christopher Browne wrote:
> I have noticed a scenario (whilst running DDL tests) which causes me
> to want to add an extra test to the pre-processing of this...

Can we not add this to .10, and make this a KNOWN ISSUE when we ship? 
This is a corner case, and I want to work out exactly the
implications of your proposed change before accepting it: we've
gradually been expanding the locking behaviour of various parts of
the DDL handling, and it's starting to make the system very
inflexible.

A

-- 
Andrew Sullivan  | ajs@crankycanuck.ca
Everything that happens in the world happens at some place.
		--Jane Jacobs 
From JanWieck at Yahoo.com  Sat Jun  2 10:26:19 2007
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Sat Jun  2 10:26:36 2007
Subject: [Slony1-general] Error Condition Found with DDL/EXECUTE SCRIPT
In-Reply-To: <20070602132833.GB27256@phlogiston.dyndns.org>
References: <60tztr1fb3.fsf@dba2.int.libertyrms.com>
	<20070602132833.GB27256@phlogiston.dyndns.org>
Message-ID: <4661A83B.9030306@Yahoo.com>

On 6/2/2007 9:28 AM, Andrew Sullivan wrote:
> On Fri, Jun 01, 2007 at 06:27:12PM -0400, Christopher Browne wrote:
>> I have noticed a scenario (whilst running DDL tests) which causes me
>> to want to add an extra test to the pre-processing of this...
> 
> Can we not add this to .10, and make this a KNOWN ISSUE when we ship? 
> This is a corner case, and I want to work out exactly the
> implications of your proposed change before accepting it: we've
> gradually been expanding the locking behaviour of various parts of
> the DDL handling, and it's starting to make the system very
> inflexible.

I've been thinking about this a bit more and the proposed changes don't 
solve the problem at all, they just make the window in which this race 
condition can occur smaller.

The DDL script is injected into the system at the origin of a set and 
flows like the data out to the subscribers over their prividers. The 
subscribe however is injected at the new subscriber, travels to the 
origin which will respond with an ENABLE_SUBSCRIPTION that travels back. 
At the time the SUBSCRIBE_SET is created on the subscriber by slonik, 
the subscriber might be behind, thus hasn't processed the outstanding 
DDL script event yet and would just happily accept the subscription request.


Jan

-- 
#======================================================================#
# It's easier to get forgiveness for being wrong than for being right. #
# Let's break this rule - forgive me.                                  #
#================================================== JanWieck@Yahoo.com #
From pergesu at gmail.com  Sun Jun  3 00:31:26 2007
From: pergesu at gmail.com (Pat Maddox)
Date: Sun Jun  3 00:31:40 2007
Subject: [Slony1-general] "relation with OID ##### does not exist" after
	setting up replication again
Message-ID: <810a540e0706030031vcf96cc0gde52b200a4884b0f@mail.gmail.com>

I set up replication between two DBs and it had been working fine.  I
wanted to see what happened when I uninstalled slony and installed it
again, so I ran uninstall node on my machines.  Then I set up slony
again.  After I set it up again, my main application started having
lots of "relation with OID ##### does not exist" errors.  I found the
FAQ at http://www.postgresql.org/docs/faqs.FAQ.html#item4.19 but I
don't quite understand what I need to do.

Pat
From michal.taborsky at mall.cz  Mon Jun  4 01:20:31 2007
From: michal.taborsky at mall.cz (Michal Taborsky - Internet Mall)
Date: Mon Jun  4 01:20:59 2007
Subject: [Slony1-general] Error after EXECUTE SCRIPT
Message-ID: <4663CB4F.1010605@mall.cz>

Hello everyone.

We've run into problem with EXECUTE SCRIPT. Our configuration is two 
servers, one master, one slave. All tables are in one set. PostgreSQL 
version is 8.1.9, Slony is 1.2.9.

The problem was (probably) caused by executing a DDL script via slonik 
EXECUTE SCRIPT command. This script included BEGIN and COMMIT, which 
slony did not accept. We do not have the exact error message, unfortunately.

The slonik script is pretty simple:

EXECUTE SCRIPT ( SET ID = 1, FILENAME = 'change.sql' );

After that, all attempts to run EXECUTE SCRIPT end up with:

<stdin>:5: PGRES_FATAL_ERROR select "_T1".ddlScript_prepare(1, -1);  - 
ERROR:  Slony-I: alterTableRestore(): Table "adm"."dberror_help" is not 
in altered state
CONTEXT:  SQL statement "SELECT  "_T1".alterTableRestore(tab_id) from 
"_T1".sl_table where tab_set in (select set_id from "_T1".sl_set where 
set_origin = "_T1".getLocalNodeId('_T1'))"
PL/pgSQL function "ddlscript_prepare" line 30 at perform

The "adm"."dberror_help" is the first table in the set. We have tried 
even the most simple script, just a "SELECT 1", the result being the same.

The replication seems to be running, but of course we'd like to fix this 
as soon as possible.

Thanks for your advice.

-- 
Michal T?borsk?
chief systems architect
Internet Mall, a.s.
<http://www.MALL.cz>




-----------------------
NOVINKA - VODNI HRISTE PRO HORKE DNY! Detske nafukovaci vodni hriste Intex s bazenkem, brouzdalistem, sprchovadlem a vodnimi hrami. Dodani obratem.


http://www.ostrovpokladu.cz/nafukovaci-hracky/intex-vodni-centrum
-----------------------
From dmitry at koterov.ru  Mon Jun  4 02:01:49 2007
From: dmitry at koterov.ru (Dmitry Koterov)
Date: Mon Jun  4 02:02:05 2007
Subject: [Slony1-general] Does slonik EXECUTE SCRIPT call waits for
	comands termination?
In-Reply-To: <466094E6.9030204@Yahoo.com>
References: <d7df81620706010232p5fdc61efsdcbe1efbab427f7e@mail.gmail.com>
	<d7df81620706010241vd227aa7u4e4436fd9d6e472d@mail.gmail.com>
	<20070601110837.GG23806@phlogiston.dyndns.org>
	<d7df81620706010752o1511402dibbfe8a4b55e7c373@mail.gmail.com>
	<4660489E.8040705@Yahoo.com>
	<20070601165337.GF24299@phlogiston.dyndns.org>
	<d7df81620706011250y2b8eade9h24981a2b7d0a00ff@mail.gmail.com>
	<466094E6.9030204@Yahoo.com>
Message-ID: <d7df81620706040201t6be532b9v5d3df7eb015f50b3@mail.gmail.com>

Could I use

DROP PATH (SERVER =3D 666, CLIENT =3D 6666)

instead of STORE PATH to generate an event, where 666 and 6666 are
non-existed node IDs? It is easier than STORE PATH, because I may not
specify conninfo manually and do not depend on it.

Would it work?

On 6/2/07, Jan Wieck <JanWieck@yahoo.com> wrote:
>
> On 6/1/2007 3:50 PM, Dmitry Koterov wrote:
> > So, is there ANY method to wait for ending of EXECUTE SCRIPT?
> > Let it work not over the slonik, but - any method?
>
> what would currently work is a redundant STORE PATH (identical to an
> existing one) followed by a WAIT. The event for STORE PATH is always
> generated on the client node.
>
>
> Jan
>
> >
> > E.g., if just after slonik EXECUTE SCRIPT I fetch the last ev_timestamp
> > from _my_cluster.sl_event and then - periodically check sl_status to
> > wait until all slave nodes are processed events with greater timestamps,
> > would it work?
> >
> >
> >
> >
> > On 6/1/07, *Andrew Sullivan* <ajs@crankycanuck.ca
> > <mailto:ajs@crankycanuck.ca>> wrote:
> >
> >     On Fri, Jun 01, 2007 at 12:26:06PM -0400, Jan Wieck wrote:
> >      > Looking at the code, it seems that EXECUTE SCRIPT doesn't
> actually
> >      > record the events seqno in the admin conninfo. Which means that
> >     WAIT FOR
> >      > EVENT will wait for an earlier event, or even nothing.
> >
> >     This sounds like a serious bug to me.  But this. . .
> >
> >      > Unfortunately the
> >      > same is true for SYNC in 1.2.9.
> >
> >     . . . sounds even worse.  Does this mean that some syncs could never
> >     get recorded?
> >
> >     A
> >
> >     --
> >     Andrew Sullivan  | ajs@crankycanuck.ca <mailto:ajs@crankycanuck.ca>
> >     "The year's penultimate month" is not in truth a good way of saying
> >     November.
> >                     --H.W. Fowler
> >     _______________________________________________
> >     Slony1-general mailing list
> >     Slony1-general@lists.slony.info <mailto:
> Slony1-general@lists.slony.info>
> >     http://lists.slony.info/mailman/listinfo/slony1-general
> >
> >
> >
> > ------------------------------------------------------------------------
> >
> > _______________________________________________
> > Slony1-general mailing list
> > Slony1-general@lists.slony.info
> > http://lists.slony.info/mailman/listinfo/slony1-general
>
>
> --
> #=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D#
> # It's easier to get forgiveness for being wrong than for being right. #
> # Let's break this rule - forgive me.                                  #
> #=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D JanWieck@Yahoo.com #
> _______________________________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070604/=
99ed7963/attachment.htm
From dmitry at koterov.ru  Mon Jun  4 02:08:04 2007
From: dmitry at koterov.ru (Dmitry Koterov)
Date: Mon Jun  4 02:08:21 2007
Subject: [Slony1-general] Does slonik EXECUTE SCRIPT call waits for
	comands termination?
In-Reply-To: <d7df81620706040201t6be532b9v5d3df7eb015f50b3@mail.gmail.com>
References: <d7df81620706010232p5fdc61efsdcbe1efbab427f7e@mail.gmail.com>
	<d7df81620706010241vd227aa7u4e4436fd9d6e472d@mail.gmail.com>
	<20070601110837.GG23806@phlogiston.dyndns.org>
	<d7df81620706010752o1511402dibbfe8a4b55e7c373@mail.gmail.com>
	<4660489E.8040705@Yahoo.com>
	<20070601165337.GF24299@phlogiston.dyndns.org>
	<d7df81620706011250y2b8eade9h24981a2b7d0a00ff@mail.gmail.com>
	<466094E6.9030204@Yahoo.com>
	<d7df81620706040201t6be532b9v5d3df7eb015f50b3@mail.gmail.com>
Message-ID: <d7df81620706040208u1b445e7bg31fc6fd7bf1eadb@mail.gmail.com>

...or, better,

DROP PATH (SERVER =3D 1, CLIENT =3D 1);

where 1 is the master node ID. I think there is no side-effect of deleting
1<->1 path?

On 6/4/07, Dmitry Koterov <dmitry@koterov.ru> wrote:
>
> Could I use
>
> DROP PATH (SERVER =3D 666, CLIENT =3D 6666)
>
> instead of STORE PATH to generate an event, where 666 and 6666 are
> non-existed node IDs? It is easier than STORE PATH, because I may not
> specify conninfo manually and do not depend on it.
>
> Would it work?
>
> On 6/2/07, Jan Wieck <JanWieck@yahoo.com> wrote:
> >
> > On 6/1/2007 3:50 PM, Dmitry Koterov wrote:
> > > So, is there ANY method to wait for ending of EXECUTE SCRIPT?
> > > Let it work not over the slonik, but - any method?
> >
> > what would currently work is a redundant STORE PATH (identical to an
> > existing one) followed by a WAIT. The event for STORE PATH is always
> > generated on the client node.
> >
> >
> > Jan
> >
> > >
> > > E.g., if just after slonik EXECUTE SCRIPT I fetch the last
> > ev_timestamp
> > > from _my_cluster.sl_event and then - periodically check sl_status to
> > > wait until all slave nodes are processed events with greater
> > timestamps,
> > > would it work?
> > >
> > >
> > >
> > >
> > > On 6/1/07, *Andrew Sullivan* <ajs@crankycanuck.ca
> > > <mailto:ajs@crankycanuck.ca>> wrote:
> > >
> > >     On Fri, Jun 01, 2007 at 12:26:06PM -0400, Jan Wieck wrote:
> > >      > Looking at the code, it seems that EXECUTE SCRIPT doesn't
> > actually
> > >      > record the events seqno in the admin conninfo. Which means that
> > >     WAIT FOR
> > >      > EVENT will wait for an earlier event, or even nothing.
> > >
> > >     This sounds like a serious bug to me.  But this. . .
> > >
> > >      > Unfortunately the
> > >      > same is true for SYNC in 1.2.9.
> > >
> > >     . . . sounds even worse.  Does this mean that some syncs could
> > never
> > >     get recorded?
> > >
> > >     A
> > >
> > >     --
> > >     Andrew Sullivan  | ajs@crankycanuck.ca <mailto:ajs@crankycanuck.ca
> > >
> > >     "The year's penultimate month" is not in truth a good way of
> > saying
> > >     November.
> > >                     --H.W. Fowler
> > >     _______________________________________________
> > >     Slony1-general mailing list
> > >     Slony1-general@lists.slony.info <mailto:
> > Slony1-general@lists.slony.info>
> > >     http://lists.slony.info/mailman/listinfo/slony1-general
> > >
> > >
> > >
> > >
> > ------------------------------------------------------------------------
> > >
> > > _______________________________________________
> > > Slony1-general mailing list
> > > Slony1-general@lists.slony.info
> > > http://lists.slony.info/mailman/listinfo/slony1-general
> >
> >
> > --
> > #=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D#
> >
> > # It's easier to get forgiveness for being wrong than for being right. #
> > # Let's break this rule - forgive me.                                  #
> > #=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D JanWieck@Yahoo.com #
> > _______________________________________________
> > Slony1-general mailing list
> > Slony1-general@lists.slony.info
> > http://lists.slony.info/mailman/listinfo/slony1-general
> >
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070604/=
14adf192/attachment.htm
From michal.taborsky at mall.cz  Mon Jun  4 02:26:50 2007
From: michal.taborsky at mall.cz (Michal Taborsky - Internet Mall)
Date: Mon Jun  4 02:27:27 2007
Subject: [Slony1-general] Error after EXECUTE SCRIPT
In-Reply-To: <4663CB4F.1010605@mall.cz>
References: <4663CB4F.1010605@mall.cz>
Message-ID: <4663DADA.8040706@mall.cz>

Hello, I'm here with an update.

My conclusion, that the replication is running, was false. The DDL 
attempt seems to have dropped all triggers from tables, the replication 
is stopped, tha changes are not being recorded, and we'll have to 
reinitialize it.

Well, this particular case is closed, but maybe the developers could 
look into it, so that this would not happen in the future to some other 
poor folk.

MT.

Michal Taborsky - Internet Mall napsal(a):
> Hello everyone.
> 
> We've run into problem with EXECUTE SCRIPT. Our configuration is two 
> servers, one master, one slave. All tables are in one set. PostgreSQL 
> version is 8.1.9, Slony is 1.2.9.
> 
> The problem was (probably) caused by executing a DDL script via slonik 
> EXECUTE SCRIPT command. This script included BEGIN and COMMIT, which 
> slony did not accept. We do not have the exact error message, 
> unfortunately.
> 
> The slonik script is pretty simple:
> 
> EXECUTE SCRIPT ( SET ID = 1, FILENAME = 'change.sql' );
> 
> After that, all attempts to run EXECUTE SCRIPT end up with:
> 
> <stdin>:5: PGRES_FATAL_ERROR select "_T1".ddlScript_prepare(1, -1);  - 
> ERROR:  Slony-I: alterTableRestore(): Table "adm"."dberror_help" is not 
> in altered state
> CONTEXT:  SQL statement "SELECT  "_T1".alterTableRestore(tab_id) from 
> "_T1".sl_table where tab_set in (select set_id from "_T1".sl_set where 
> set_origin = "_T1".getLocalNodeId('_T1'))"
> PL/pgSQL function "ddlscript_prepare" line 30 at perform
> 
> The "adm"."dberror_help" is the first table in the set. We have tried 
> even the most simple script, just a "SELECT 1", the result being the same.
> 
> The replication seems to be running, but of course we'd like to fix this 
> as soon as possible.
> 
> Thanks for your advice.
> 


-- 
Michal T?borsk?
chief systems architect
Internet Mall, a.s.
<http://www.MALL.cz>
-----------------------
NOVINKA - VODNI HRISTE PRO HORKE DNY! Detske nafukovaci vodni hriste Intex s bazenkem, brouzdalistem, sprchovadlem a vodnimi hrami. Dodani obratem.


http://www.ostrovpokladu.cz/nafukovaci-hracky/intex-vodni-centrum
-----------------------
From ajs at crankycanuck.ca  Mon Jun  4 06:09:32 2007
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Mon Jun  4 06:09:46 2007
Subject: [Slony1-general] Error after EXECUTE SCRIPT
In-Reply-To: <4663DADA.8040706@mall.cz>
References: <4663CB4F.1010605@mall.cz> <4663DADA.8040706@mall.cz>
Message-ID: <20070604130932.GG32320@phlogiston.dyndns.org>

On Mon, Jun 04, 2007 at 11:26:50AM +0200, Michal Taborsky - Internet Mall wrote:
> Well, this particular case is closed, but maybe the developers could 
> look into it, so that this would not happen in the future to some other 
> poor folk.

Unfortunately, there's nothing to look at -- you said you don't have
the exact error message, and so we haven't the faintest clue what
happened.  One thing that certainly happened, however, is that your
script contained some commands that weren't supported.  In the docs,
it says, "The script must not contain transaction BEGIN or END
statements, as the script is already executed inside a transaction."

A

-- 
Andrew Sullivan  | ajs@crankycanuck.ca
A certain description of men are for getting out of debt, yet are
against all taxes for raising money to pay it off.
		--Alexander Hamilton
From michal.taborsky at mall.cz  Mon Jun  4 07:06:47 2007
From: michal.taborsky at mall.cz (Michal Taborsky - Internet Mall)
Date: Mon Jun  4 07:11:51 2007
Subject: [Slony1-general] Error after EXECUTE SCRIPT
In-Reply-To: <20070604130932.GG32320@phlogiston.dyndns.org>
References: <4663CB4F.1010605@mall.cz> <4663DADA.8040706@mall.cz>
	<20070604130932.GG32320@phlogiston.dyndns.org>
Message-ID: <46641C77.9060503@mall.cz>

Andrew Sullivan napsal(a):
> happened.  One thing that certainly happened, however, is that your
> script contained some commands that weren't supported.  In the docs,
> it says, "The script must not contain transaction BEGIN or END
> statements, as the script is already executed inside a transaction."

I'm fairly sure it was the begin-commit that broke it. The script itself 
was like this:

BEGIN;
... some DDLs ...
COMMIT;


Wouldn't it be possible to check the script for these commands 
beforehand, then? I mean, it would be real nice, if slonik produced an 
error message, instead of breaking things.

But thanks for ther reply, anyway.

-- 
Michal T?borsk?
chief systems architect
Internet Mall, a.s.
<http://www.MALL.cz>
-----------------------
NOVINKA - VODNI HRISTE PRO HORKE DNY! Detske nafukovaci vodni hriste Intex s bazenkem, brouzdalistem, sprchovadlem a vodnimi hrami. Dodani obratem.


http://www.ostrovpokladu.cz/nafukovaci-hracky/intex-vodni-centrum
-----------------------
From ajs at crankycanuck.ca  Mon Jun  4 07:44:52 2007
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Mon Jun  4 07:45:02 2007
Subject: [Slony1-general] Error after EXECUTE SCRIPT
In-Reply-To: <46641C77.9060503@mall.cz>
References: <4663CB4F.1010605@mall.cz> <4663DADA.8040706@mall.cz>
	<20070604130932.GG32320@phlogiston.dyndns.org>
	<46641C77.9060503@mall.cz>
Message-ID: <20070604144452.GO32320@phlogiston.dyndns.org>

On Mon, Jun 04, 2007 at 04:06:47PM +0200, Michal Taborsky - Internet Mall wrote:
> 
> Wouldn't it be possible to check the script for these commands 
> beforehand, then? I mean, it would be real nice, if slonik produced an 
> error message, instead of breaking things.

Which version of Postgres are you on?  It may not actually break
things under post 8.x, because there's subtransaction support in
there.  

It would indeed be nice to have a slonik script validator in place to
run through before doing things; so far, nobody has been inspired to
write one, possibly because there's a great whack of things that it
probably wouldn't be able to test without completely reproducing
your setup.  I can say that we _never_ run a DDL without first trying
out the script in a test environment, for exactly this reason.

A

-- 
Andrew Sullivan  | ajs@crankycanuck.ca
The plural of anecdote is not data.
		--Roger Brinner
From cbbrowne at ca.afilias.info  Mon Jun  4 07:49:53 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Mon Jun  4 07:49:57 2007
Subject: [Slony1-general] Error after EXECUTE SCRIPT
In-Reply-To: <46641C77.9060503@mall.cz> (Michal Taborsky's message of "Mon,
	04 Jun 2007 16:06:47 +0200")
References: <4663CB4F.1010605@mall.cz> <4663DADA.8040706@mall.cz>
	<20070604130932.GG32320@phlogiston.dyndns.org>
	<46641C77.9060503@mall.cz>
Message-ID: <60myzf22r2.fsf@dba2.int.libertyrms.com>

Michal Taborsky - Internet Mall <michal.taborsky@mall.cz> writes:
> Andrew Sullivan napsal(a):
>> happened.  One thing that certainly happened, however, is that your
>> script contained some commands that weren't supported.  In the docs,
>> it says, "The script must not contain transaction BEGIN or END
>> statements, as the script is already executed inside a transaction."
>
> I'm fairly sure it was the begin-commit that broke it. The script
> itself was like this:
>
> BEGIN;
> ... some DDLs ...
> COMMIT;
>
>
> Wouldn't it be possible to check the script for these commands
> beforehand, then? I mean, it would be real nice, if slonik produced an
> error message, instead of breaking things.

I'll put that on my TODO list, as it ought to be possible to detect
this.
-- 
output = reverse("ofni.sailifa.ac" "@" "enworbbc")
<http://dba2.int.libertyrms.com/>
Christopher Browne
(416) 673-4124 (land)
From ajs at crankycanuck.ca  Mon Jun  4 07:49:54 2007
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Mon Jun  4 07:50:03 2007
Subject: [Slony1-general] Error Condition Found with DDL/EXECUTE SCRIPT
In-Reply-To: <4661A83B.9030306@Yahoo.com>
References: <60tztr1fb3.fsf@dba2.int.libertyrms.com>
	<20070602132833.GB27256@phlogiston.dyndns.org>
	<4661A83B.9030306@Yahoo.com>
Message-ID: <20070604144954.GP32320@phlogiston.dyndns.org>

On Sat, Jun 02, 2007 at 01:26:19PM -0400, Jan Wieck wrote:
> The DDL script is injected into the system at the origin of a set and 
> flows like the data out to the subscribers over their prividers. The 
> subscribe however is injected at the new subscriber, travels to the 
> origin which will respond with an ENABLE_SUBSCRIPTION that travels back. 
> At the time the SUBSCRIBE_SET is created on the subscriber by slonik, 
> the subscriber might be behind, thus hasn't processed the outstanding 
> DDL script event yet and would just happily accept the subscription request.

This leads me to believe that the only thing to do is document this,
and move on.  It's just a limitation of async communications that
there are race conditions, and some race conditions are the sort of
thing that are going to break those async communications.

A

-- 
Andrew Sullivan  | ajs@crankycanuck.ca
In the future this spectacle of the middle classes shocking the avant-
garde will probably become the textbook definition of Postmodernism. 
                --Brad Holland
From JanWieck at Yahoo.com  Mon Jun  4 11:24:09 2007
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Mon Jun  4 14:23:55 2007
Subject: [Slony1-general] Does slonik EXECUTE SCRIPT call waits for	comands
	termination?
In-Reply-To: <d7df81620706040208u1b445e7bg31fc6fd7bf1eadb@mail.gmail.com>
References: <d7df81620706010232p5fdc61efsdcbe1efbab427f7e@mail.gmail.com>	<d7df81620706010241vd227aa7u4e4436fd9d6e472d@mail.gmail.com>	<20070601110837.GG23806@phlogiston.dyndns.org>	<d7df81620706010752o1511402dibbfe8a4b55e7c373@mail.gmail.com>	<4660489E.8040705@Yahoo.com>	<20070601165337.GF24299@phlogiston.dyndns.org>	<d7df81620706011250y2b8eade9h24981a2b7d0a00ff@mail.gmail.com>	<466094E6.9030204@Yahoo.com>	<d7df81620706040201t6be532b9v5d3df7eb015f50b3@mail.gmail.com>
	<d7df81620706040208u1b445e7bg31fc6fd7bf1eadb@mail.gmail.com>
Message-ID: <466458C9.7090205@Yahoo.com>

On 6/4/2007 5:08 AM, Dmitry Koterov wrote:
> ...or, better,
> 
> DROP PATH (SERVER = 1, CLIENT = 1);

If this works at all, you have to use the node ID of the node that you 
want the event to come from.


Jan


> 
> where 1 is the master node ID. I think there is no side-effect of 
> deleting 1<->1 path?
> 
> On 6/4/07, * Dmitry Koterov* <dmitry@koterov.ru 
> <mailto:dmitry@koterov.ru>> wrote:
> 
>     Could I use
> 
>     DROP PATH (SERVER = 666, CLIENT = 6666)
> 
>     instead of STORE PATH to generate an event, where 666 and 6666 are
>     non-existed node IDs? It is easier than STORE PATH, because I may
>     not specify conninfo manually and do not depend on it.
> 
>     Would it work?
> 
> 
>     On 6/2/07, *Jan Wieck* < JanWieck@yahoo.com
>     <mailto:JanWieck@yahoo.com>> wrote:
> 
>         On 6/1/2007 3:50 PM, Dmitry Koterov wrote:
>         >  So, is there ANY method to wait for ending of EXECUTE SCRIPT?
>         >  Let it work not over the slonik, but - any method?
> 
>         what would currently work is a redundant STORE PATH (identical
>         to an
>         existing one) followed by a WAIT. The event for STORE PATH is always
>         generated on the client node.
> 
> 
>         Jan
> 
>         >
>         >  E.g., if just after slonik EXECUTE SCRIPT I fetch the last
>         ev_timestamp
>         >  from _my_cluster.sl_event and then - periodically check
>         sl_status to
>         >  wait until all slave nodes are processed events with greater
>         timestamps,
>         >  would it work?
>         >
>         >
>         >
>         >
>         >  On 6/1/07, *Andrew Sullivan* < ajs@crankycanuck.ca
>         <mailto:ajs@crankycanuck.ca>
>         >  <mailto:ajs@crankycanuck.ca <mailto:ajs@crankycanuck.ca>>> wrote:
>         >
>         >     On Fri, Jun 01, 2007 at 12:26:06PM -0400, Jan Wieck wrote:
>         >      > Looking at the code, it seems that EXECUTE SCRIPT
>         doesn't actually
>         >      > record the events seqno in the admin conninfo. Which
>         means that
>         >     WAIT FOR
>         >      > EVENT will wait for an earlier event, or even nothing.
>         >
>         >     This sounds like a serious bug to me.  But this. . .
>         >
>         >      > Unfortunately the
>         >      > same is true for SYNC in 1.2.9.
>         >
>         >     . . . sounds even worse.  Does this mean that some syncs
>         could never
>         >     get recorded?
>         >
>         >     A
>         >
>         >     --
>         >     Andrew Sullivan  | ajs@crankycanuck.ca
>         <mailto:ajs@crankycanuck.ca> <mailto: ajs@crankycanuck.ca
>         <mailto:ajs@crankycanuck.ca>>
>         >     "The year's penultimate month" is not in truth a good way
>         of saying
>         >     November.
>         >                     --H.W. Fowler
>         >     _______________________________________________
>         >     Slony1-general mailing list
>         >     Slony1-general@lists.slony.info
>         <mailto:Slony1-general@lists.slony.info>
>         <mailto:Slony1-general@lists.slony.info
>         <mailto:Slony1-general@lists.slony.info>>
>         >     http://lists.slony.info/mailman/listinfo/slony1-general
>         <http://lists.slony.info/mailman/listinfo/slony1-general>
>         >
>         >
>         >
>         >
>         ------------------------------------------------------------------------
>         >
>         >  _______________________________________________
>         >  Slony1-general mailing list
>         >  Slony1-general@lists.slony.info
>         <mailto:Slony1-general@lists.slony.info>
>         >  http://lists.slony.info/mailman/listinfo/slony1-general
>         <http://lists.slony.info/mailman/listinfo/slony1-general>
> 
> 
>         --
>         #======================================================================#
> 
>         # It's easier to get forgiveness for being wrong than for being
>         right. #
>         # Let's break this rule - forgive
>         me.                                  #
>         #==================================================
>         JanWieck@Yahoo.com <mailto:JanWieck@Yahoo.com> #
>         _______________________________________________
>         Slony1-general mailing list
>         Slony1-general@lists.slony.info
>         <mailto:Slony1-general@lists.slony.info>
>         http://lists.slony.info/mailman/listinfo/slony1-general
> 
> 
> 
> 
> ------------------------------------------------------------------------
> 
> _______________________________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


-- 
#======================================================================#
# It's easier to get forgiveness for being wrong than for being right. #
# Let's break this rule - forgive me.                                  #
#================================================== JanWieck@Yahoo.com #
From dmitry at koterov.ru  Mon Jun  4 14:32:24 2007
From: dmitry at koterov.ru (Dmitry Koterov)
Date: Mon Jun  4 14:32:33 2007
Subject: [Slony1-general] Do we need to stop the write activity during a
	slave initialization?
Message-ID: <d7df81620706041432u5e0414f4p78daf39d01bde977@mail.gmail.com>

Hello.

Seems Slony sometimes tries to play an event created BEFORE the whole
copying process was started?
I have the following timing:

1) in 18:28:28 a row was added to the table tableName
2) in 18:28:30 we have DEBUG2 remoteWorkerThread_1: Begin COPY of table
"public"."tableName"
3) about 20 minutes later slony on the slave tried to replay an event (1)
and failed with "duplicate check" violation (because an element was already
present in the table thanks to COPY).

So, seems we have to stop any write activity during the start of a COPY
process to avoid this.

P.S.
Not a single, but 2 slave machines were copied sequentially. The first one
copied and began to replicate successfully, but the second - failed with
described symphtoms.
Slony 1.2.9.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070605/=
b9f53904/attachment.htm
From andrew.george.hammond at gmail.com  Mon Jun  4 15:43:00 2007
From: andrew.george.hammond at gmail.com (Andrew Hammond)
Date: Mon Jun  4 15:43:09 2007
Subject: [Slony1-general] Do we need to stop the write activity during a
	slave initialization?
In-Reply-To: <d7df81620706041432u5e0414f4p78daf39d01bde977@mail.gmail.com>
References: <d7df81620706041432u5e0414f4p78daf39d01bde977@mail.gmail.com>
Message-ID: <5a0a9d6f0706041543n333dfd5o989704b69b72899d@mail.gmail.com>

On 6/4/07, Dmitry Koterov <dmitry@koterov.ru> wrote:
> Hello.
>
> Seems Slony sometimes tries to play an event created BEFORE the whole
> copying process was started?
> I have the following timing:
>
> 1) in 18:28:28 a row was added to the table tableName
> 2) in 18:28:30 we have DEBUG2 remoteWorkerThread_1: Begin COPY of table
> "public"."tableName"
> 3) about 20 minutes later slony on the slave tried to replay an event (1)
> and failed with "duplicate check" violation (because an element was already
> present in the table thanks to COPY).
>
> So, seems we have to stop any write activity during the start of a COPY
> process to avoid this.

That certainly shouldn't happen. Do you have a detailed test case that
allows this error to be re-produced?

> P.S.
> Not a single, but 2 slave machines were copied sequentially. The first one
> copied and began to replicate successfully, but the second - failed with
> described symphtoms.
> Slony 1.2.9.
From dmitry at koterov.ru  Mon Jun  4 15:57:22 2007
From: dmitry at koterov.ru (Dmitry Koterov)
Date: Mon Jun  4 15:57:35 2007
Subject: [Slony1-general] Do we need to stop the write activity during a
	slave initialization?
In-Reply-To: <5a0a9d6f0706041543n333dfd5o989704b69b72899d@mail.gmail.com>
References: <d7df81620706041432u5e0414f4p78daf39d01bde977@mail.gmail.com>
	<5a0a9d6f0706041543n333dfd5o989704b69b72899d@mail.gmail.com>
Message-ID: <d7df81620706041557m50df120ese88d23224284f416@mail.gmail.com>

Skipped content of type multipart/alternative-------------- next part -----=
---------
A non-text attachment was scrubbed...
Name: bb.zip
Type: application/zip
Size: 1229 bytes
Desc: not available
Url : http://lists.slony.info/pipermail/slony1-general/attachments/20070605=
/f53e4335/bb-0001.zip
From dmitry at koterov.ru  Mon Jun  4 16:01:26 2007
From: dmitry at koterov.ru (Dmitry Koterov)
Date: Mon Jun  4 16:01:37 2007
Subject: [Slony1-general] Does slonik EXECUTE SCRIPT call waits for
	comands termination?
In-Reply-To: <466458C9.7090205@Yahoo.com>
References: <d7df81620706010232p5fdc61efsdcbe1efbab427f7e@mail.gmail.com>
	<20070601110837.GG23806@phlogiston.dyndns.org>
	<d7df81620706010752o1511402dibbfe8a4b55e7c373@mail.gmail.com>
	<4660489E.8040705@Yahoo.com>
	<20070601165337.GF24299@phlogiston.dyndns.org>
	<d7df81620706011250y2b8eade9h24981a2b7d0a00ff@mail.gmail.com>
	<466094E6.9030204@Yahoo.com>
	<d7df81620706040201t6be532b9v5d3df7eb015f50b3@mail.gmail.com>
	<d7df81620706040208u1b445e7bg31fc6fd7bf1eadb@mail.gmail.com>
	<466458C9.7090205@Yahoo.com>
Message-ID: <d7df81620706041601i325f6efdle8ffc9ad95c64aa1@mail.gmail.com>

Hmm, possibly

LOCK SET (ID =3D 1, ORIGIN =3D 1);
UNLOCK SET (ID =3D 1, ORIGIN =3D 1);

would be a better choise? I just want to explicitly wait until all schema
changes are finished on all nodes, no more... And I guarantees that there is
no reading or writing activity at that moment, I just want to sit and
wait...

On 6/4/07, Jan Wieck <JanWieck@yahoo.com> wrote:
>
> On 6/4/2007 5:08 AM, Dmitry Koterov wrote:
> > ...or, better,
> >
> > DROP PATH (SERVER =3D 1, CLIENT =3D 1);
>
> If this works at all, you have to use the node ID of the node that you
> want the event to come from.
>
>
> Jan
>
>
> >
> > where 1 is the master node ID. I think there is no side-effect of
> > deleting 1<->1 path?
> >
> > On 6/4/07, * Dmitry Koterov* <dmitry@koterov.ru
> > <mailto:dmitry@koterov.ru>> wrote:
> >
> >     Could I use
> >
> >     DROP PATH (SERVER =3D 666, CLIENT =3D 6666)
> >
> >     instead of STORE PATH to generate an event, where 666 and 6666 are
> >     non-existed node IDs? It is easier than STORE PATH, because I may
> >     not specify conninfo manually and do not depend on it.
> >
> >     Would it work?
> >
> >
> >     On 6/2/07, *Jan Wieck* < JanWieck@yahoo.com
> >     <mailto:JanWieck@yahoo.com>> wrote:
> >
> >         On 6/1/2007 3:50 PM, Dmitry Koterov wrote:
> >         >  So, is there ANY method to wait for ending of EXECUTE SCRIPT?
> >         >  Let it work not over the slonik, but - any method?
> >
> >         what would currently work is a redundant STORE PATH (identical
> >         to an
> >         existing one) followed by a WAIT. The event for STORE PATH is
> always
> >         generated on the client node.
> >
> >
> >         Jan
> >
> >         >
> >         >  E.g., if just after slonik EXECUTE SCRIPT I fetch the last
> >         ev_timestamp
> >         >  from _my_cluster.sl_event and then - periodically check
> >         sl_status to
> >         >  wait until all slave nodes are processed events with greater
> >         timestamps,
> >         >  would it work?
> >         >
> >         >
> >         >
> >         >
> >         >  On 6/1/07, *Andrew Sullivan* < ajs@crankycanuck.ca
> >         <mailto:ajs@crankycanuck.ca>
> >         >  <mailto:ajs@crankycanuck.ca <mailto:ajs@crankycanuck.ca>>>
> wrote:
> >         >
> >         >     On Fri, Jun 01, 2007 at 12:26:06PM -0400, Jan Wieck wrote:
> >         >      > Looking at the code, it seems that EXECUTE SCRIPT
> >         doesn't actually
> >         >      > record the events seqno in the admin conninfo. Which
> >         means that
> >         >     WAIT FOR
> >         >      > EVENT will wait for an earlier event, or even nothing.
> >         >
> >         >     This sounds like a serious bug to me.  But this. . .
> >         >
> >         >      > Unfortunately the
> >         >      > same is true for SYNC in 1.2.9.
> >         >
> >         >     . . . sounds even worse.  Does this mean that some syncs
> >         could never
> >         >     get recorded?
> >         >
> >         >     A
> >         >
> >         >     --
> >         >     Andrew Sullivan  | ajs@crankycanuck.ca
> >         <mailto:ajs@crankycanuck.ca> <mailto: ajs@crankycanuck.ca
> >         <mailto:ajs@crankycanuck.ca>>
> >         >     "The year's penultimate month" is not in truth a good way
> >         of saying
> >         >     November.
> >         >                     --H.W. Fowler
> >         >     _______________________________________________
> >         >     Slony1-general mailing list
> >         >     Slony1-general@lists.slony.info
> >         <mailto:Slony1-general@lists.slony.info>
> >         <mailto:Slony1-general@lists.slony.info
> >         <mailto:Slony1-general@lists.slony.info>>
> >         >     http://lists.slony.info/mailman/listinfo/slony1-general
> >         <http://lists.slony.info/mailman/listinfo/slony1-general>
> >         >
> >         >
> >         >
> >         >
> >
> ------------------------------------------------------------------------
> >         >
> >         >  _______________________________________________
> >         >  Slony1-general mailing list
> >         >  Slony1-general@lists.slony.info
> >         <mailto:Slony1-general@lists.slony.info>
> >         >  http://lists.slony.info/mailman/listinfo/slony1-general
> >         <http://lists.slony.info/mailman/listinfo/slony1-general>
> >
> >
> >         --
> >
> #=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D#
> >
> >         # It's easier to get forgiveness for being wrong than for being
> >         right. #
> >         # Let's break this rule - forgive
> >         me.                                  #
> >         #=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D
> >         JanWieck@Yahoo.com <mailto:JanWieck@Yahoo.com> #
> >         _______________________________________________
> >         Slony1-general mailing list
> >         Slony1-general@lists.slony.info
> >         <mailto:Slony1-general@lists.slony.info>
> >         http://lists.slony.info/mailman/listinfo/slony1-general
> >
> >
> >
> >
> > ------------------------------------------------------------------------
> >
> > _______________________________________________
> > Slony1-general mailing list
> > Slony1-general@lists.slony.info
> > http://lists.slony.info/mailman/listinfo/slony1-general
>
>
> --
> #=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D#
> # It's easier to get forgiveness for being wrong than for being right. #
> # Let's break this rule - forgive me.                                  #
> #=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D JanWieck@Yahoo.com #
> _______________________________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070605/=
77c9ebab/attachment.htm
From drees76 at gmail.com  Mon Jun  4 16:14:13 2007
From: drees76 at gmail.com (David Rees)
Date: Mon Jun  4 16:14:31 2007
Subject: [Slony1-general] Re: Bug in cleanupNodelock prevents slony startup
In-Reply-To: <72dbd3150705161831n559d161al7ee2c60c59db25bb@mail.gmail.com>
References: <72dbd3150705161831n559d161al7ee2c60c59db25bb@mail.gmail.com>
Message-ID: <72dbd3150706041614g695f7bc8mb29607bbe5d4dace@mail.gmail.com>

I saw that there was some talk of 1.2.10 coming real soon now, has
anyone looked at this issue which I posted about a couple weeks ago?

Let me know if I can provide any more information.

-Dave

On 5/16/07, David Rees <drees76@gmail.com> wrote:
> I upgraded my dev setup from pg 8.2.3 to pg 8.2.4 and slony 1.2.8 to
> 1.2.9 today and it went smoothly, except that one slony node failed to
> come up with the messages:
>
> FATAL  localListenThread: "select "_rep1".cleanupNodelock(); insert
> into "_rep1".sl_nodelock values (    1, 0, "pg_catalog".
> pg_backend_pid()); " - ERROR:  duplicate key violates unique
> constraint "sl_nodelock-pkey"
> FATAL  Do you already have a slon running against this node?
> FATAL  Or perhaps a residual idle backend connection from a dead slon?
>
> I checked the process list and found no extra slon daemons or residual
> backend connections, so then I took a look at the sl_nodelock table
> for the affected node and noticed that the nl_backendpid listed for
> that node happened to be the same as the pid for the currently running
> pg daemon itself so the cleanupnodelock function wasn't cleaning up
> the entry.
>
> After restarting postgres the affected slon node came up normally. I
> suspect I could have manually cleaned out the sl_nodelock table as
> well.
>
> I don't know enough about the _Slony_I_killBackend function, but
> perhaps it could be improved to detect this situation.
>
> -Dave
From andrew.george.hammond at gmail.com  Mon Jun  4 17:03:21 2007
From: andrew.george.hammond at gmail.com (Andrew Hammond)
Date: Mon Jun  4 17:03:34 2007
Subject: [Slony1-general] Re: Bug in cleanupNodelock prevents slony startup
In-Reply-To: <72dbd3150706041614g695f7bc8mb29607bbe5d4dace@mail.gmail.com>
References: <72dbd3150705161831n559d161al7ee2c60c59db25bb@mail.gmail.com>
	<72dbd3150706041614g695f7bc8mb29607bbe5d4dace@mail.gmail.com>
Message-ID: <5a0a9d6f0706041703o4265c691q912df1c3a6fb3f37@mail.gmail.com>

I haven't seen any patch to address this. It seems like a pretty
unlikely corner case and not one that causes data loss. As you note,
there are (at least) two workarounds; either restart the database
(ugly, but probably something that a newbie would try), or manually
delete the entry from sl_nodelock (the "trust me, I know what I'm
doing" approach). So, while it'd be nice to fix it, but I don't think
it's terribly high priority.

If you're keen enough to do the work, a patch would be welcome. :)

A


On 6/4/07, David Rees <drees76@gmail.com> wrote:
> I saw that there was some talk of 1.2.10 coming real soon now, has
> anyone looked at this issue which I posted about a couple weeks ago?
>
> Let me know if I can provide any more information.
>
> -Dave
>
> On 5/16/07, David Rees <drees76@gmail.com> wrote:
> > I upgraded my dev setup from pg 8.2.3 to pg 8.2.4 and slony 1.2.8 to
> > 1.2.9 today and it went smoothly, except that one slony node failed to
> > come up with the messages:
> >
> > FATAL  localListenThread: "select "_rep1".cleanupNodelock(); insert
> > into "_rep1".sl_nodelock values (    1, 0, "pg_catalog".
> > pg_backend_pid()); " - ERROR:  duplicate key violates unique
> > constraint "sl_nodelock-pkey"
> > FATAL  Do you already have a slon running against this node?
> > FATAL  Or perhaps a residual idle backend connection from a dead slon?
> >
> > I checked the process list and found no extra slon daemons or residual
> > backend connections, so then I took a look at the sl_nodelock table
> > for the affected node and noticed that the nl_backendpid listed for
> > that node happened to be the same as the pid for the currently running
> > pg daemon itself so the cleanupnodelock function wasn't cleaning up
> > the entry.
> >
> > After restarting postgres the affected slon node came up normally. I
> > suspect I could have manually cleaned out the sl_nodelock table as
> > well.
> >
> > I don't know enough about the _Slony_I_killBackend function, but
> > perhaps it could be improved to detect this situation.
> >
> > -Dave
> _______________________________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
>
From JanWieck at Yahoo.com  Mon Jun  4 18:05:54 2007
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Mon Jun  4 18:06:13 2007
Subject: [Slony1-general] Does slonik EXECUTE SCRIPT call waits for comands
	termination?
In-Reply-To: <d7df81620706041601i325f6efdle8ffc9ad95c64aa1@mail.gmail.com>
References: <d7df81620706010232p5fdc61efsdcbe1efbab427f7e@mail.gmail.com>	
	<20070601110837.GG23806@phlogiston.dyndns.org>	
	<d7df81620706010752o1511402dibbfe8a4b55e7c373@mail.gmail.com>	
	<4660489E.8040705@Yahoo.com>	
	<20070601165337.GF24299@phlogiston.dyndns.org>	
	<d7df81620706011250y2b8eade9h24981a2b7d0a00ff@mail.gmail.com>	
	<466094E6.9030204@Yahoo.com>	
	<d7df81620706040201t6be532b9v5d3df7eb015f50b3@mail.gmail.com>	
	<d7df81620706040208u1b445e7bg31fc6fd7bf1eadb@mail.gmail.com>	
	<466458C9.7090205@Yahoo.com>
	<d7df81620706041601i325f6efdle8ffc9ad95c64aa1@mail.gmail.com>
Message-ID: <4664B6F2.5010900@Yahoo.com>

On 6/4/2007 7:01 PM, Dmitry Koterov wrote:
> Hmm, possibly
> 
> LOCK SET (ID = 1, ORIGIN = 1);
> UNLOCK SET (ID = 1, ORIGIN = 1);
> 
> would be a better choise? I just want to explicitly wait until all 
> schema changes are finished on all nodes, no more... And I guarantees 
> that there is no reading or writing activity at that moment, I just want 
> to sit and wait...

I just committed the fix for the original problem. Check out the CVS 
branch REL_1_2_STABLE and look at src/ducttape/test_5_... it includes 
tests for SYNC as well as for EXECUTE SCRIPT followed by WAIT FOR EVENT. 
As soon as we have that tested enough we will release 1.2.10 and you 
will have a real solution. Please run your test cases and let us know if 
it fixes your problems. If everything goes well and no more serious bugs 
show up in the next few days, we will have 1.2.10 out this week.


Jan

> 
> On 6/4/07, *Jan Wieck* <JanWieck@yahoo.com <mailto:JanWieck@yahoo.com>> 
> wrote:
> 
>     On 6/4/2007 5:08 AM, Dmitry Koterov wrote:
>      > ...or, better,
>      >
>      > DROP PATH (SERVER = 1, CLIENT = 1);
> 
>     If this works at all, you have to use the node ID of the node that you
>     want the event to come from.
> 
> 
>     Jan
> 
> 
>      >
>      > where 1 is the master node ID. I think there is no side-effect of
>      > deleting 1<->1 path?
>      >
>      > On 6/4/07, * Dmitry Koterov* < dmitry@koterov.ru
>     <mailto:dmitry@koterov.ru>
>      > <mailto:dmitry@koterov.ru <mailto:dmitry@koterov.ru>>> wrote:
>      >
>      >     Could I use
>      >
>      >     DROP PATH (SERVER = 666, CLIENT = 6666)
>      >
>      >     instead of STORE PATH to generate an event, where 666 and
>     6666 are
>      >     non-existed node IDs? It is easier than STORE PATH, because I may
>      >     not specify conninfo manually and do not depend on it.
>      >
>      >     Would it work?
>      >
>      >
>      >     On 6/2/07, *Jan Wieck* < JanWieck@yahoo.com
>     <mailto:JanWieck@yahoo.com>
>      >     <mailto:JanWieck@yahoo.com <mailto:JanWieck@yahoo.com>>> wrote:
>      >
>      >         On 6/1/2007 3:50 PM, Dmitry Koterov wrote:
>      >         >  So, is there ANY method to wait for ending of EXECUTE
>     SCRIPT?
>      >         >  Let it work not over the slonik, but - any method?
>      >
>      >         what would currently work is a redundant STORE PATH
>     (identical
>      >         to an
>      >         existing one) followed by a WAIT. The event for STORE
>     PATH is always
>      >         generated on the client node.
>      >
>      >
>      >         Jan
>      >
>      >         >
>      >         >  E.g., if just after slonik EXECUTE SCRIPT I fetch the last
>      >         ev_timestamp
>      >         >  from _my_cluster.sl_event and then - periodically check
>      >         sl_status to
>      >         >  wait until all slave nodes are processed events with
>     greater
>      >         timestamps,
>      >         >  would it work?
>      >         >
>      >         >
>      >         >
>      >         >
>      >         >  On 6/1/07, *Andrew Sullivan* < ajs@crankycanuck.ca
>     <mailto:ajs@crankycanuck.ca>
>      >         <mailto:ajs@crankycanuck.ca <mailto:ajs@crankycanuck.ca>>
>      >         >  <mailto:ajs@crankycanuck.ca
>     <mailto:ajs@crankycanuck.ca> <mailto: ajs@crankycanuck.ca
>     <mailto:ajs@crankycanuck.ca>>>> wrote:
>      >         >
>      >         >     On Fri, Jun 01, 2007 at 12:26:06PM -0400, Jan Wieck
>     wrote:
>      >         >      > Looking at the code, it seems that EXECUTE SCRIPT
>      >         doesn't actually
>      >         >      > record the events seqno in the admin conninfo. Which
>      >         means that
>      >         >     WAIT FOR
>      >         >      > EVENT will wait for an earlier event, or even
>     nothing.
>      >         >
>      >         >     This sounds like a serious bug to me.  But this. . .
>      >         >
>      >         >      > Unfortunately the
>      >         >      > same is true for SYNC in 1.2.9.
>      >         >
>      >         >     . . . sounds even worse.  Does this mean that some
>     syncs
>      >         could never
>      >         >     get recorded?
>      >         >
>      >         >     A
>      >         >
>      >         >     --
>      >         >     Andrew Sullivan  | ajs@crankycanuck.ca
>     <mailto:ajs@crankycanuck.ca>
>      >         <mailto:ajs@crankycanuck.ca <mailto:ajs@crankycanuck.ca>>
>     <mailto: ajs@crankycanuck.ca <mailto:ajs@crankycanuck.ca>
>      >         <mailto:ajs@crankycanuck.ca <mailto:ajs@crankycanuck.ca>>>
>      >         >     "The year's penultimate month" is not in truth a
>     good way
>      >         of saying
>      >         >     November.
>      >         >                     --H.W. Fowler
>      >         >     _______________________________________________
>      >         >     Slony1-general mailing list
>      >         >     Slony1-general@lists.slony.info
>     <mailto:Slony1-general@lists.slony.info>
>      >         <mailto:Slony1-general@lists.slony.info
>     <mailto:Slony1-general@lists.slony.info> >
>      >         <mailto:Slony1-general@lists.slony.info
>     <mailto:Slony1-general@lists.slony.info>
>      >         <mailto:Slony1-general@lists.slony.info
>     <mailto:Slony1-general@lists.slony.info>>>
>      >         >     http://lists.slony.info/mailman/listinfo/slony1-general
>      >         < http://lists.slony.info/mailman/listinfo/slony1-general>
>      >         >
>      >         >
>      >         >
>      >         >
>      >        
>     ------------------------------------------------------------------------
> 
>      >         >
>      >         >  _______________________________________________
>      >         >  Slony1-general mailing list
>      >         >  Slony1-general@lists.slony.info
>     <mailto:Slony1-general@lists.slony.info>
>      >         <mailto:Slony1-general@lists.slony.info
>     <mailto:Slony1-general@lists.slony.info>>
>      >        
>      >  http://lists.slony.info/mailman/listinfo/slony1-general
>     <http://lists.slony.info/mailman/listinfo/slony1-general>
>      >         <http://lists.slony.info/mailman/listinfo/slony1-general>
>      >
>      >
>      >         --
>      >        
>     #======================================================================#
> 
>      >
>      >         # It's easier to get forgiveness for being wrong than for
>     being
>      >         right. #
>      >         # Let's break this rule - forgive
>      >         me.                                  #
>      >         #==================================================
>      >         JanWieck@Yahoo.com <mailto:JanWieck@Yahoo.com>
>     <mailto:JanWieck@Yahoo.com <mailto:JanWieck@Yahoo.com>> #
>      >         _______________________________________________
>      >         Slony1-general mailing list
>      >         Slony1-general@lists.slony.info
>     <mailto:Slony1-general@lists.slony.info>
>      >         <mailto: Slony1-general@lists.slony.info
>     <mailto:Slony1-general@lists.slony.info>>
>      >         http://lists.slony.info/mailman/listinfo/slony1-general
>     <http://lists.slony.info/mailman/listinfo/slony1-general>
>      >
>      >
>      >
>      >
>      >
>     ------------------------------------------------------------------------
>      >
>      > _______________________________________________
>      > Slony1-general mailing list
>      > Slony1-general@lists.slony.info
>     <mailto:Slony1-general@lists.slony.info>
>      > http://lists.slony.info/mailman/listinfo/slony1-general
> 
> 
>     --
>     #======================================================================#
>     # It's easier to get forgiveness for being wrong than for being right. #
>     # Let's break this rule - forgive
>     me.                                  #
>     #==================================================
>     JanWieck@Yahoo.com <mailto:JanWieck@Yahoo.com> #
>     _______________________________________________
>     Slony1-general mailing list
>     Slony1-general@lists.slony.info <mailto:Slony1-general@lists.slony.info>
>     http://lists.slony.info/mailman/listinfo/slony1-general
> 
> 


-- 
#======================================================================#
# It's easier to get forgiveness for being wrong than for being right. #
# Let's break this rule - forgive me.                                  #
#================================================== JanWieck@Yahoo.com #
From JanWieck at Yahoo.com  Mon Jun  4 19:29:46 2007
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Mon Jun  4 20:14:40 2007
Subject: [Slony1-general] Error after EXECUTE SCRIPT
In-Reply-To: <20070604144452.GO32320@phlogiston.dyndns.org>
References: <4663CB4F.1010605@mall.cz>
	<4663DADA.8040706@mall.cz>	<20070604130932.GG32320@phlogiston.dyndns.org>	<46641C77.9060503@mall.cz>
	<20070604144452.GO32320@phlogiston.dyndns.org>
Message-ID: <4664CA9A.3010905@Yahoo.com>

On 6/4/2007 10:44 AM, Andrew Sullivan wrote:
> On Mon, Jun 04, 2007 at 04:06:47PM +0200, Michal Taborsky - Internet Mall wrote:
>> 
>> Wouldn't it be possible to check the script for these commands 
>> beforehand, then? I mean, it would be real nice, if slonik produced an 
>> error message, instead of breaking things.
> 
> Which version of Postgres are you on?  It may not actually break
> things under post 8.x, because there's subtransaction support in
> there.  

No, the subtransactions use different syntax. However, at some point (I 
don't recall when) Postgres changed from an ERROR to a WARNING in the 
case of BEGIN inside of a transaction and COMMIT outside of one. What 
therefore has happened is that the code for EXECUTE restored the 
original table state without slony triggers but with all user triggers 
in place and ran the script. Somewhere in the script it hit the BEGIN, 
issuing a WARNING, continued until COMMIT and of course, did that. From 
then on every single statement following (in the script or by slony) was 
outside a transaction block and the first one to fail would probably 
cause slonik to terminate whatever it was doing before putting the 
tables back into replicated state.

> 
> It would indeed be nice to have a slonik script validator in place to
> run through before doing things; so far, nobody has been inspired to
> write one, possibly because there's a great whack of things that it
> probably wouldn't be able to test without completely reproducing
> your setup.  I can say that we _never_ run a DDL without first trying
> out the script in a test environment, for exactly this reason.

Agreed.


Jan

-- 
#======================================================================#
# It's easier to get forgiveness for being wrong than for being right. #
# Let's break this rule - forgive me.                                  #
#================================================== JanWieck@Yahoo.com #
From JanWieck at Yahoo.com  Mon Jun  4 19:43:26 2007
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Mon Jun  4 21:35:03 2007
Subject: [Slony1-general] Do we need to stop the write activity during
	a	slave initialization?
In-Reply-To: <d7df81620706041557m50df120ese88d23224284f416@mail.gmail.com>
References: <d7df81620706041432u5e0414f4p78daf39d01bde977@mail.gmail.com>	<5a0a9d6f0706041543n333dfd5o989704b69b72899d@mail.gmail.com>
	<d7df81620706041557m50df120ese88d23224284f416@mail.gmail.com>
Message-ID: <4664CDCE.4000108@Yahoo.com>

On 6/4/2007 6:57 PM, Dmitry Koterov wrote:
> No test cases, but I have some log lines, hope they would help.
> I also attach this logs to the mail.

What really would be interesting in this case is the sl_setsync for the 
failing subscriber together with the log row (below). That setsync 
should be the still the one created by the copy_set() and have an active 
xip vector showing transaction 264185 in progress and thus, not included 
in the COPY data.


Jan


> 
> -- From the slave log:
> 2007-06-04 18:28:28 GMT DEBUG2 localListenThread: Received event 3,1178 SYNC
> 2007-06-04 18:28:28 GMT DEBUG2 localListenThread: Received event 3,1179 
> SYNC
> 2007-06-04 18:28:28 GMT DEBUG2 remoteListenThread_1: queue event 1,2685 SYNC
> 2007-06-04 18:28:28 GMT DEBUG2 remoteListenThread_1: UNLISTEN
> 2007-06-04 18:28:28 GMT DEBUG2 remoteWorkerThread_4: forward confirm 
> 3,1179 received by 4
> 2007-06-04 18:28:28 GMT DEBUG2 remoteListenThread_2: LISTEN
> 2007-06-04 18:28:28 GMT DEBUG2 remoteWorkerThread_2: forward confirm 
> 1,2685 received by 2
> 2007-06-04 18:28:28 GMT DEBUG2 remoteWorkerThread_2: forward confirm 
> 2,2330 received by 1
> 2007-06-04 18:28:28 GMT DEBUG2 remoteWorkerThread_2: forward confirm 
> 4,1164 received by 1
> 2007-06-04 18:28:28 GMT DEBUG2 remoteWorkerThread_2: forward confirm 
> 4,1164 received by 2
> 2007-06-04 18:28:28 GMT DEBUG2 remoteListenThread_4: queue event 4,1165 
> SYNC
> 2007-06-04 18:28:28 GMT DEBUG2 remoteListenThread_4: UNLISTEN
> 2007-06-04 18:28:28 GMT DEBUG2 remoteWorkerThread_4: Received event 
> 4,1165 SYNC
> 2007-06-04 18:28:28 GMT DEBUG2 remoteWorkerThread_4: SYNC 1165 processing
> 2007-06-04 18:28:28 GMT DEBUG2 remoteWorkerThread_4: no sets need 
> syncing for this event
> 2007-06-04 18:28:28 GMT DEBUG2 remoteWorkerThread_2: forward confirm 
> 3,1179 received by 2
> 2007-06-04 18:28:28 GMT DEBUG2 remoteListenThread_1: LISTEN
> 2007-06-04 18:28:28 GMT DEBUG2 remoteWorkerThread_2: forward confirm 
> 3,1179 received by 1
> 2007-06-04 18:28:28 GMT DEBUG2 remoteListenThread_1: queue event 1,2686 SYNC
> 2007-06-04 18:28:28 GMT DEBUG2 remoteListenThread_1: UNLISTEN
> 2007-06-04 18:28:29 GMT DEBUG2 remoteListenThread_2: queue event 2,2331 SYNC
> 2007-06-04 18:28:29 GMT DEBUG2 remoteWorkerThread_2: Received event 
> 2,2331 SYNC
> 2007-06-04 18:28:29 GMT DEBUG2 remoteWorkerThread_2: SYNC 2331 processing
> 2007-06-04 18:28:29 GMT DEBUG2 remoteWorkerThread_2: no sets need 
> syncing for this event
> 2007-06-04 18:28:29 GMT DEBUG2 syncThread: new sl_action_seq 1 - SYNC 1180
> 2007-06-04 18:28:29 GMT DEBUG2 remoteListenThread_4: LISTEN
> 2007-06-04 18:28:29 GMT DEBUG2 remoteWorkerThread_4: forward confirm 
> 2,2331 received by 4
> 2007-06-04 18:28:29 GMT DEBUG2 remoteWorkerThread_2: forward confirm 
> 3,1180 received by 2
> 2007-06-04 18:28:29 GMT DEBUG2 remoteWorkerThread_2: forward confirm 
> 4,1165 received by 2
> 2007-06-04 18:28:29 GMT DEBUG2 remoteWorkerThread_2: forward confirm 
> 1,2686 received by 2
> 2007-06-04 18:28:29 GMT DEBUG2 remoteWorkerThread_2: forward confirm 
> 4,1165 received by 1
> 2007-06-04 18:28:29 GMT DEBUG1 copy_set 1
> 2007-06-04 18:28:29 GMT DEBUG1 remoteWorkerThread_1: connected to 
> provider DB
> 2007-06-04 18:28:29 GMT DEBUG2 remoteWorkerThread_4: forward confirm 
> 3,1180 received by 4
> 2007-06-04 18:28:29 GMT DEBUG2 remoteWorkerThread_1: prepare to copy 
> table "public"."***"
> 
> 
> -- An operation which fails:
> 2007-06-04 20:28:28 GMT ERROR  remoteWorkerThread_1: "
> insert into "public"."edge" 
> (obj_id,obj_comments_count,obj_last_commented,obj_marks_sum_sign,obj_marks_rating,obj_created,obj_type_did,edge_pid1,edge_pid2,edge_created,edge_status_did) 
> 
> values ('668066978','0',NULL,'0','0','2007-06-04 
> 18:28:28.674814','45892','149931528','899581307','2007-06-04 
> 18:28:28.674814','1');
> 
> 
> -- A corresponding event on Master
> =# select * from _m_cluster.sl_log_1 where log_cmddata like 
> '%edge_pid1%668066978%' order by log_actionseq limit 60;
>  log_origin | log_xid | log_tableid | log_actionseq | log_cmdtype 
> |                                                                                                                                           
> log_cmddata                                
> ------------+---------+-------------+---------------+-------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 
> 
>           1 | 264185  |           7 |          3424 | I           | 
> (obj_id,obj_comments_count,obj_last_commented,obj_marks_sum_sign,obj_marks_rating,obj_created,obj_type_did,edge_pid1,edge_pid2,edge_created,edge_status_did) 
> values ('668066978','0',NULL,'0','0','2007-06-04 18:28: 
> 28.674814','45892','149931528','899581307','2007-06-04 18:28:28.674814','1')
> 
> 
> -- Related events from Master:
> =# select * from _m_cluster.sl_event where ev_minxid=264185;
>  ev_origin | ev_seqno |        ev_timestamp        | ev_minxid | 
> ev_maxxid |                    ev_xip                    | ev_type | 
> ev_data1 | ev_data2 | ev_data3 | ev_data4 | ev_data5 | ev_data6 | 
> ev_data7 | ev_data8
> -----------+----------+----------------------------+-----------+-----------+----------------------------------------------+---------+----------+----------+----------+----------+----------+----------+----------+---------- 
> 
>          1 |     2686 | 2007-06-04 18:28:28.895215 | 264185    | 
> 264202    | '264185'                                     | SYNC    
> |          |          |          |          |          |          
> |          |
>          1 |     2687 | 2007-06-04 18:28:29.194165 | 264185    | 
> 264272    | '264269','264185','264270','264266','264263' | SYNC    
> |          |          |          |          |          |          
> |          |
> 
> 
> 
> 
> On 6/5/07, *Andrew Hammond* <andrew.george.hammond@gmail.com 
> <mailto:andrew.george.hammond@gmail.com>> wrote:
> 
>     On 6/4/07, Dmitry Koterov <dmitry@koterov.ru
>     <mailto:dmitry@koterov.ru>> wrote:
>      > Hello.
>      >
>      > Seems Slony sometimes tries to play an event created BEFORE the whole
>      > copying process was started?
>      > I have the following timing:
>      >
>      > 1) in 18:28:28 a row was added to the table tableName
>      > 2) in 18:28:30 we have DEBUG2 remoteWorkerThread_1: Begin COPY of
>     table
>      > "public"."tableName"
>      > 3) about 20 minutes later slony on the slave tried to replay an
>     event (1)
>      > and failed with "duplicate check" violation (because an element
>     was already
>      > present in the table thanks to COPY).
>      >
>      > So, seems we have to stop any write activity during the start of
>     a COPY
>      > process to avoid this.
> 
>     That certainly shouldn't happen. Do you have a detailed test case that
>     allows this error to be re-produced?
> 
>      > P.S.
>      > Not a single, but 2 slave machines were copied sequentially. The
>     first one
>      > copied and began to replicate successfully, but the second -
>     failed with
>      > described symphtoms.
>      > Slony 1.2.9.
> 
> 
> 
> ------------------------------------------------------------------------
> 
> _______________________________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


-- 
#======================================================================#
# It's easier to get forgiveness for being wrong than for being right. #
# Let's break this rule - forgive me.                                  #
#================================================== JanWieck@Yahoo.com #
From dmitry at koterov.ru  Tue Jun  5 01:40:38 2007
From: dmitry at koterov.ru (Dmitry Koterov)
Date: Tue Jun  5 01:40:59 2007
Subject: [Slony1-general] Does slonik EXECUTE SCRIPT call waits for
	comands termination?
In-Reply-To: <4664B6F2.5010900@Yahoo.com>
References: <d7df81620706010232p5fdc61efsdcbe1efbab427f7e@mail.gmail.com>
	<4660489E.8040705@Yahoo.com>
	<20070601165337.GF24299@phlogiston.dyndns.org>
	<d7df81620706011250y2b8eade9h24981a2b7d0a00ff@mail.gmail.com>
	<466094E6.9030204@Yahoo.com>
	<d7df81620706040201t6be532b9v5d3df7eb015f50b3@mail.gmail.com>
	<d7df81620706040208u1b445e7bg31fc6fd7bf1eadb@mail.gmail.com>
	<466458C9.7090205@Yahoo.com>
	<d7df81620706041601i325f6efdle8ffc9ad95c64aa1@mail.gmail.com>
	<4664B6F2.5010900@Yahoo.com>
Message-ID: <d7df81620706050140q2244bc13n6a2e1b25c09cb9f2@mail.gmail.com>

Thanks!

Could I update only the slonik processor to the new version, not touching
all slon processes on other machines (1.2.9)?
Would slonik-1.2.10 conflict with slon-1.2.9 or not in such case?


On 6/5/07, Jan Wieck <JanWieck@yahoo.com> wrote:
>
> On 6/4/2007 7:01 PM, Dmitry Koterov wrote:
> > Hmm, possibly
> >
> > LOCK SET (ID =3D 1, ORIGIN =3D 1);
> > UNLOCK SET (ID =3D 1, ORIGIN =3D 1);
> >
> > would be a better choise? I just want to explicitly wait until all
> > schema changes are finished on all nodes, no more... And I guarantees
> > that there is no reading or writing activity at that moment, I just want
> > to sit and wait...
>
> I just committed the fix for the original problem. Check out the CVS
> branch REL_1_2_STABLE and look at src/ducttape/test_5_... it includes
> tests for SYNC as well as for EXECUTE SCRIPT followed by WAIT FOR EVENT.
> As soon as we have that tested enough we will release 1.2.10 and you
> will have a real solution. Please run your test cases and let us know if
> it fixes your problems. If everything goes well and no more serious bugs
> show up in the next few days, we will have 1.2.10 out this week.
>
>
> Jan
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070605/=
4c75b4a6/attachment-0001.htm
From cbbrowne at ca.afilias.info  Tue Jun  5 09:19:53 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Tue Jun  5 09:20:03 2007
Subject: [Slony1-general] Version 1.2.10 ready for testing
Message-ID: <604plm1ihi.fsf@dba2.int.libertyrms.com>

Here are the release notes as they stand now; with Jan's commits over
the last day, it looks like we have everything committed to resolve
issues with EXECUTE SCRIPT and log shipping.

I'll be doing some testing on my "platforms of interest" over the next
couple of days; if others can run tests they care about, that would be
a great thing.

I plan to tag and release 1.2.10 by the end of the week; the hope is
that this will be the final version in the 1.2 branch, as work now
progresses on an 8.3-oriented "2.0" branch on HEAD.

RELEASE 1.2.10

- Fixed problem with EXECUTE SCRIPT (EXECUTE ONLY ON = <node>)

  - The script was being executed on too many nodes...

- Added a test script for log shipping

  ... And alter it to add invocation of a DDL script.  This
  allows testing for an event-counting problem in log shipping.

- Changes to support PostgreSQL 8.3 as VARATT_SIZEP has been deprecated

- in xxid.c, changes to support PostgreSQL 8.3 as tuple compression has
  more extensive support

  VARDATA_ANY(PG_DETOAST_DATUM_PACKED((PG_GETARG_DATUM(0))))
  tends to replace
  PG_GETARG_VARLENA(0)

- Slonik's SYNC command never recorded the new seqno in the admin
  conninfo, with potential wacky results for WAIT FOR EVENT

- Fix rpm build problem when the system has pg_config in both under
  /usr/local/pgsql/bin and /usr/bin

- Add init script for Red Hat / Fedora

- Fix archive log ship tracking. Slon now tracks the setsync status in
  memory and generates a void archive with the correct old,new event
  seqno for all events.

- EXECUTE SCRIPT wasn't setting sl_setsync, which broke WAIT FOR EVENT
  on these events

- Ducttape test #5 (which performs DDL changes) augmented to test use
  of WAIT FOR EVENT
-- 
(reverse (concatenate 'string "ofni.sailifa.ac" "@" "enworbbc"))
<http://dba2.int.libertyrms.com/>
Christopher Browne
(416) 673-4124 (land)
From vivek at khera.org  Tue Jun  5 11:08:03 2007
From: vivek at khera.org (Vivek Khera)
Date: Tue Jun  5 11:08:13 2007
Subject: [Slony1-general] "relation with OID ##### does not exist" after
	setting up replication again
In-Reply-To: <810a540e0706030031vcf96cc0gde52b200a4884b0f@mail.gmail.com>
References: <810a540e0706030031vcf96cc0gde52b200a4884b0f@mail.gmail.com>
Message-ID: <0011265B-7240-4EBD-B374-2B8606406DD5@khera.org>


On Jun 3, 2007, at 3:31 AM, Pat Maddox wrote:

> lots of "relation with OID ##### does not exist" errors.  I found the
> FAQ at http://www.postgresql.org/docs/faqs.FAQ.html#item4.19 but I
> don't quite understand what I need to do.

quit/restart your application so it opens new connections to the  
database and won't try to use old execution plans which are now invalid.

From pgsql at j-davis.com  Tue Jun  5 11:20:14 2007
From: pgsql at j-davis.com (Jeff Davis)
Date: Tue Jun  5 11:20:28 2007
Subject: [Slony1-general] "relation with OID ##### does not exist"
	after setting up replication again
In-Reply-To: <0011265B-7240-4EBD-B374-2B8606406DD5@khera.org>
References: <810a540e0706030031vcf96cc0gde52b200a4884b0f@mail.gmail.com>
	<0011265B-7240-4EBD-B374-2B8606406DD5@khera.org>
Message-ID: <1181067614.7660.119.camel@dogma.v10.wvs>

On Tue, 2007-06-05 at 14:08 -0400, Vivek Khera wrote:
> On Jun 3, 2007, at 3:31 AM, Pat Maddox wrote:
> 
> > lots of "relation with OID ##### does not exist" errors.  I found the
> > FAQ at http://www.postgresql.org/docs/faqs.FAQ.html#item4.19 but I
> > don't quite understand what I need to do.
> 
> quit/restart your application so it opens new connections to the  
> database and won't try to use old execution plans which are now invalid.
> 

I'd like to add that this problem will be fixed in PostgreSQL 8.3.

Regards,
	Jeff Davis

From cbbrowne at ca.afilias.info  Tue Jun  5 11:24:43 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Tue Jun  5 11:24:54 2007
Subject: [Slony1-general] "relation with OID ##### does not exist"	after
	setting up replication again
In-Reply-To: <1181067614.7660.119.camel@dogma.v10.wvs>
References: <810a540e0706030031vcf96cc0gde52b200a4884b0f@mail.gmail.com>	<0011265B-7240-4EBD-B374-2B8606406DD5@khera.org>
	<1181067614.7660.119.camel@dogma.v10.wvs>
Message-ID: <4665AA6B.6000000@ca.afilias.info>

Jeff Davis wrote:
> On Tue, 2007-06-05 at 14:08 -0400, Vivek Khera wrote:
>   
>> On Jun 3, 2007, at 3:31 AM, Pat Maddox wrote:
>>
>>     
>>> lots of "relation with OID ##### does not exist" errors.  I found the
>>> FAQ at http://www.postgresql.org/docs/faqs.FAQ.html#item4.19 but I
>>> don't quite understand what I need to do.
>>>       
>> quit/restart your application so it opens new connections to the  
>> database and won't try to use old execution plans which are now invalid.
>>
>>     
>
> I'd like to add that this problem will be fixed in PostgreSQL 8.3.
>   
That's interesting.

I'd been hearing vague comments about "real soon now" during both 8.1
and 8.2 branches; is there some pointer yet to document what is
resolving this?
From andrew.george.hammond at gmail.com  Tue Jun  5 12:00:09 2007
From: andrew.george.hammond at gmail.com (Andrew Hammond)
Date: Tue Jun  5 12:00:16 2007
Subject: [Slony1-general] "relation with OID ##### does not exist" after
	setting up replication again
In-Reply-To: <4665AA6B.6000000@ca.afilias.info>
References: <810a540e0706030031vcf96cc0gde52b200a4884b0f@mail.gmail.com>
	<0011265B-7240-4EBD-B374-2B8606406DD5@khera.org>
	<1181067614.7660.119.camel@dogma.v10.wvs>
	<4665AA6B.6000000@ca.afilias.info>
Message-ID: <5a0a9d6f0706051200r54b38b09kd767ab207364ca71@mail.gmail.com>

On 6/5/07, Christopher Browne <cbbrowne@ca.afilias.info> wrote:
> Jeff Davis wrote:
> > On Tue, 2007-06-05 at 14:08 -0400, Vivek Khera wrote:
> >
> >> On Jun 3, 2007, at 3:31 AM, Pat Maddox wrote:
> >>
> >>
> >>> lots of "relation with OID ##### does not exist" errors.  I found the
> >>> FAQ at http://www.postgresql.org/docs/faqs.FAQ.html#item4.19 but I
> >>> don't quite understand what I need to do.
> >>>
> >> quit/restart your application so it opens new connections to the
> >> database and won't try to use old execution plans which are now invalid.
> >>
> >>
> >
> > I'd like to add that this problem will be fixed in PostgreSQL 8.3.
> >
> That's interesting.
>
> I'd been hearing vague comments about "real soon now" during both 8.1
> and 8.2 branches; is there some pointer yet to document what is
> resolving this?

The design discussion

http://groups.google.com/group/pgsql.hackers/browse_thread/thread/5fd6a9e09a6b3946/541168104f524348?lnk=gst&rnum=2#541168104f524348

The first time is saw a "hey, this is now done".

http://groups.google.com/group/pgsql.hackers/browse_thread/thread/eb387cca4c2a3127/c26caab2c36d2aad?lnk=gst&q=invalidation&rnum=3#c26caab2c36d2aad


Andrew
From cbbrowne at ca.afilias.info  Tue Jun  5 14:03:38 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Tue Jun  5 14:03:50 2007
Subject: [Slony1-general] "relation with OID ##### does not exist" after
	setting up replication again
In-Reply-To: <5a0a9d6f0706051200r54b38b09kd767ab207364ca71@mail.gmail.com>
	(Andrew Hammond's message of "Tue, 5 Jun 2007 12:00:09 -0700")
References: <810a540e0706030031vcf96cc0gde52b200a4884b0f@mail.gmail.com>
	<0011265B-7240-4EBD-B374-2B8606406DD5@khera.org>
	<1181067614.7660.119.camel@dogma.v10.wvs>
	<4665AA6B.6000000@ca.afilias.info>
	<5a0a9d6f0706051200r54b38b09kd767ab207364ca71@mail.gmail.com>
Message-ID: <60myzeyuz9.fsf@dba2.int.libertyrms.com>

"Andrew Hammond" <andrew.george.hammond@gmail.com> writes:
> On 6/5/07, Christopher Browne <cbbrowne@ca.afilias.info> wrote:
>> Jeff Davis wrote:
>> > On Tue, 2007-06-05 at 14:08 -0400, Vivek Khera wrote:
>> >
>> >> On Jun 3, 2007, at 3:31 AM, Pat Maddox wrote:
>> >>
>> >>
>> >>> lots of "relation with OID ##### does not exist" errors.  I found the
>> >>> FAQ at http://www.postgresql.org/docs/faqs.FAQ.html#item4.19 but I
>> >>> don't quite understand what I need to do.
>> >>>
>> >> quit/restart your application so it opens new connections to the
>> >> database and won't try to use old execution plans which are now invalid.
>> >>
>> >>
>> >
>> > I'd like to add that this problem will be fixed in PostgreSQL 8.3.
>> >
>> That's interesting.
>>
>> I'd been hearing vague comments about "real soon now" during both 8.1
>> and 8.2 branches; is there some pointer yet to document what is
>> resolving this?
>
> The design discussion
>
> http://groups.google.com/group/pgsql.hackers/browse_thread/thread/5fd6a9e09a6b3946/541168104f524348?lnk=gst&rnum=2#541168104f524348
>
> The first time is saw a "hey, this is now done".
>
> http://groups.google.com/group/pgsql.hackers/browse_thread/thread/eb387cca4c2a3127/c26caab2c36d2aad?lnk=gst&q=invalidation&rnum=3#c26caab2c36d2aad

Excellent.  I'll add a note to the FAQ that this is believed to be
resolved in v8.3.
-- 
let name="cbbrowne" and tld="ca.afilias.info" in String.concat "@" [name;tld];;
<http://dba2.int.libertyrms.com/>
Christopher Browne
(416) 673-4124 (land)
From alex.minenko at gmail.com  Wed Jun  6 17:22:36 2007
From: alex.minenko at gmail.com (Alex Minenko)
Date: Wed Jun  6 17:22:42 2007
Subject: [Slony1-general] slon process do not start if two nodes in claster
 share hostname and common prefix in database name
Message-ID: <46674FCC.10904@gmail.com>

I have setup with two nodes located on the same host, so the connection 
strings look like

1:  'host=dbserver dbname=production_main port=5432'
2:  'host=dbserver dbname=production port=5432'

Slon process for node 1 start with no problems. However, slon process 
for node 2 will not start if node 1 is already running. I traced the
problem to get_pid()  in /slony1-engine/tools/altperl/slon-tools.pm. It 
appears that the regular expresion in the following line matches 
connections string for both node 1 and node 2 when invoked for node 2.

*my* $command =  ps_args() . *"| egrep \"[s]lon .*$CLUSTER_NAME\" | egrep \"host=$dbhost dbname=$dbname.*port=$dbport\" | sort -n | awk '{print \$2}'"*;

I guess it could be fixed by changing egrep regexp to something like

**\"host=$dbhost dbname=$dbname[ \t].*port=$dbport\"**



From francesco.dandrea at telecomitalia.it  Tue Jun  5 03:54:59 2007
From: francesco.dandrea at telecomitalia.it (Dandrea Francesco)
Date: Thu Jun  7 08:18:07 2007
Subject: [Slony1-general] A problem with the locatioon of the share dir
Message-ID: <48C49CA807312F4C9C5C1DCE87632E350158C063@PTPEVS109RM001.idc.cww.telecomitalia.it>

 
Hi all, I have to install slony in 2 servers (that I don't control).
On this 2 servers the postgres DB is installed in 2 different places. 
If possible I don't want to compile slony 2 times.

There is a problem: when I run the slonik command "init cluster" it
complains about the missing file
<DIR_WHERE_POSTGRES_WAS_ON_THE_MACHINE_SLONY_WAS_COMPILED>/share/xxid.v8
0.sql. The file is in the dir <PGHOME>/share.

I saw that in slonik.c there is this one:
#ifndef WIN32
        strcpy(share_path, PGSHARE);
#else
	/*
	 * We need to find a share directory like PostgreSQL. 
	 */
	if (find_my_exec(argv[0],myfull_path) < 0)
	{
		printf("full path was unacquirable. '%s'\n", argv[0]);
		return -1;
	}
	else
	{
		get_share_path(myfull_path, share_path);
	}
#endif

PGSHARE is defined in makefile somewhere and it's the place where
postgreSQL is at compile time.
 
Removing the ifndef and leaving only the else side (plus some other
relate small changes) did the trick, and if I put slonik in the bin dir
of postgreSQL all seems to work ok. 

To me it seems that all works ok, in your opinion is there some trouble
in doing so?

Thanks a lot
--------------------------------------------------------------------

CONFIDENTIALITY NOTICE

This message and its attachments are addressed solely to the persons above and may contain confidential information. If you have received the message in error, be informed that any use of the content hereof is prohibited. Please return it immediately to the sender and delete the message. Should you have any questions, please contact us by replying to webmaster@telecomitalia.it.

        Thank you

                                        www.telecomitalia.it

--------------------------------------------------------------------
                        
From wmoran at collaborativefusion.com  Thu Jun  7 11:46:02 2007
From: wmoran at collaborativefusion.com (Bill Moran)
Date: Thu Jun  7 11:46:11 2007
Subject: [Slony1-general] How to determine if the node I'm connecting to is
	the master
Message-ID: <20070607144602.83956148.wmoran@collaborativefusion.com>


I have a need to connect to a database, and quickly and easily determine
whether it is the slony master or a slony slave.  Currently, I do a 
"BEGIN; DELETE FROM <replicated_table>; ROLLBACK", and test to see if the
DELETE query succeeds or not.

Unfortunately, this causes a bit more transaction traffic than I'm
comfortable with.  Is there a better way to get the same information?

-- 
Bill Moran
Collaborative Fusion Inc.
http://people.collaborativefusion.com/~wmoran/

wmoran@collaborativefusion.com
Phone: 412-422-3463x4023

****************************************************************
IMPORTANT: This message contains confidential information and is
intended only for the individual named. If the reader of this
message is not an intended recipient (or the individual
responsible for the delivery of this message to an intended
recipient), please be advised that any re-use, dissemination,
distribution or copying of this message is prohibited. Please
notify the sender immediately by e-mail if you have received
this e-mail by mistake and delete this e-mail from your system.
E-mail transmission cannot be guaranteed to be secure or
error-free as information could be intercepted, corrupted, lost,
destroyed, arrive late or incomplete, or contain viruses. The
sender therefore does not accept liability for any errors or
omissions in the contents of this message, which arise as a
result of e-mail transmission.
****************************************************************
From ajs at crankycanuck.ca  Thu Jun  7 11:57:35 2007
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Thu Jun  7 11:57:56 2007
Subject: [Slony1-general] How to determine if the node I'm connecting to
	is the master
In-Reply-To: <20070607144602.83956148.wmoran@collaborativefusion.com>
References: <20070607144602.83956148.wmoran@collaborativefusion.com>
Message-ID: <20070607185735.GM14087@phlogiston.dyndns.org>

On Thu, Jun 07, 2007 at 02:46:02PM -0400, Bill Moran wrote:
> 
> I have a need to connect to a database, and quickly and easily determine
> whether it is the slony master or a slony slave.  Currently, I do a 

There's no way to check that, because it's not a meaningful question. 
If you want to know whether a given _table_ is a replica or not, you
can find that out by looking in the _slony schema.  Look for the
tab_set in _slony.sl_table for your table, then look in the sl_set
table for that set number, and look at the set_origin.  Finally,
select last_value from sl_local_node_id.  Note that this is a
sequence, so be careful with it!

A

-- 
Andrew Sullivan  | ajs@crankycanuck.ca
Unfortunately reformatting the Internet is a little more painful 
than reformatting your hard drive when it gets out of whack.
		--Scott Morris
From julian at avbrief.com  Thu Jun  7 12:03:21 2007
From: julian at avbrief.com (Julian Scarfe)
Date: Thu Jun  7 12:01:37 2007
Subject: [Slony1-general] How to determine if the node I'm connecting to
	isthe master
References: <20070607144602.83956148.wmoran@collaborativefusion.com>
Message-ID: <062901c7a936$857601a0$0600a8c0@Wilbur>

> I have a need to connect to a database, and quickly and easily determine
> whether it is the slony master or a slony slave.

I use (for cluster _T1)

select "_T1".getlocalnodeid('_T1') = (select set_origin from "_T1".sl_set 
limit 1);

which presumes that all sets have the same origin -- otherwise you can 
specify the set in the query.

Julian 


From wmoran at collaborativefusion.com  Thu Jun  7 12:17:09 2007
From: wmoran at collaborativefusion.com (Bill Moran)
Date: Thu Jun  7 12:17:20 2007
Subject: [Slony1-general] How to determine if the node I'm connecting to
	is the master
In-Reply-To: <20070607185735.GM14087@phlogiston.dyndns.org>
References: <20070607144602.83956148.wmoran@collaborativefusion.com>
	<20070607185735.GM14087@phlogiston.dyndns.org>
Message-ID: <20070607151709.d4925581.wmoran@collaborativefusion.com>

In response to Andrew Sullivan <ajs@crankycanuck.ca>:

> On Thu, Jun 07, 2007 at 02:46:02PM -0400, Bill Moran wrote:
> > 
> > I have a need to connect to a database, and quickly and easily determine
> > whether it is the slony master or a slony slave.  Currently, I do a 
> 
> There's no way to check that, because it's not a meaningful question. 
> If you want to know whether a given _table_ is a replica or not, you
> can find that out by looking in the _slony schema.  Look for the
> tab_set in _slony.sl_table for your table, then look in the sl_set
> table for that set number, and look at the set_origin.  Finally,
> select last_value from sl_local_node_id.  Note that this is a
> sequence, so be careful with it!

Thanks.  In our case, all the tables have the same origin, so that's
a safe assumption to make.

-- 
Bill Moran
Collaborative Fusion Inc.
http://people.collaborativefusion.com/~wmoran/

wmoran@collaborativefusion.com
Phone: 412-422-3463x4023
From wmoran at collaborativefusion.com  Thu Jun  7 12:18:07 2007
From: wmoran at collaborativefusion.com (Bill Moran)
Date: Thu Jun  7 12:18:14 2007
Subject: [Slony1-general] How to determine if the node I'm connecting to
	isthe master
In-Reply-To: <062901c7a936$857601a0$0600a8c0@Wilbur>
References: <20070607144602.83956148.wmoran@collaborativefusion.com>
	<062901c7a936$857601a0$0600a8c0@Wilbur>
Message-ID: <20070607151807.7cb8407a.wmoran@collaborativefusion.com>

In response to "Julian Scarfe" <julian@avbrief.com>:

> > I have a need to connect to a database, and quickly and easily determine
> > whether it is the slony master or a slony slave.
> 
> I use (for cluster _T1)
> 
> select "_T1".getlocalnodeid('_T1') = (select set_origin from "_T1".sl_set 
> limit 1);
> 
> which presumes that all sets have the same origin -- otherwise you can 
> specify the set in the query.

Thanks, Julian.  That's exactly the trick I needed!

-- 
Bill Moran
Collaborative Fusion Inc.
http://people.collaborativefusion.com/~wmoran/

wmoran@collaborativefusion.com
Phone: 412-422-3463x4023

****************************************************************
IMPORTANT: This message contains confidential information and is
intended only for the individual named. If the reader of this
message is not an intended recipient (or the individual
responsible for the delivery of this message to an intended
recipient), please be advised that any re-use, dissemination,
distribution or copying of this message is prohibited. Please
notify the sender immediately by e-mail if you have received
this e-mail by mistake and delete this e-mail from your system.
E-mail transmission cannot be guaranteed to be secure or
error-free as information could be intercepted, corrupted, lost,
destroyed, arrive late or incomplete, or contain viruses. The
sender therefore does not accept liability for any errors or
omissions in the contents of this message, which arise as a
result of e-mail transmission.
****************************************************************
From marlonpetry at gmail.com  Thu Jun  7 14:10:09 2007
From: marlonpetry at gmail.com (Marlon Petry)
Date: Thu Jun  7 14:10:17 2007
Subject: [Slony1-general] Tutorial HeartBeat + slony
Message-ID: <917b114a0706071410y651df988n36e8c50996837eca@mail.gmail.com>

Hi lists, is needing a tutorial one on heartbeat + slony. Somebody could
help me

-- =

Marlon

No xadrez existem precisamente 169.518.829.100.544 quatrilh=F5es (15 zeros)=
 de
maneiras de jogar apenas os dez primeiros lances. Para os 40 lances
seguintes de um jogo inteiro, o n=FAmero =E9 estimado em 25 x 10 elevado a =
115
pot=EAncia. O n=FAmero inteiro de =E1tomos em todo o universo =E9 apenas um=
a pequena
fra=E7=E3o desse resultado.
E na vida!
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070607/=
67f0551b/attachment.html
From andrew.george.hammond at gmail.com  Thu Jun  7 16:23:12 2007
From: andrew.george.hammond at gmail.com (Andrew Hammond)
Date: Thu Jun  7 16:23:21 2007
Subject: [Slony1-general] Tutorial HeartBeat + slony
In-Reply-To: <917b114a0706071410y651df988n36e8c50996837eca@mail.gmail.com>
References: <917b114a0706071410y651df988n36e8c50996837eca@mail.gmail.com>
Message-ID: <5a0a9d6f0706071623kb1c88c1k5f45f9f9aaef28c4@mail.gmail.com>

On 6/7/07, Marlon Petry <marlonpetry@gmail.com> wrote:
>
> Hi lists, is needing a tutorial one on heartbeat + slony. Somebody could
> help me

Are you talking about using heartbeat (or some other automated system)
to trigger a slony failover? The docs talk about that. Have you read
the following?

http://linuxfinances.info/info/failover.html#AEN42680

Andrew
From htomeh at firstam.com  Thu Jun  7 16:48:25 2007
From: htomeh at firstam.com (Tomeh, Husam)
Date: Thu Jun  7 16:48:40 2007
Subject: [Slony1-general] Tutorial HeartBeat + slony
In-Reply-To: <917b114a0706071410y651df988n36e8c50996837eca@mail.gmail.com>
References: <917b114a0706071410y651df988n36e8c50996837eca@mail.gmail.com>
Message-ID: <F1B0F9305B343E43A1C3EECE48B853D5F948E5@CITGSNA01SXCH02.ana.firstamdata.com>

Linux-HA heartbeat can be used with Slony-I. Here's a link to get you start=
ed: http://www.linux-ha.org/GettingStarted
 =

 =

--
  Husam
 =

 =

________________________________

From: slony1-general-bounces@lists.slony.info [mailto:slony1-general-bounce=
s@lists.slony.info] On Behalf Of Marlon Petry
Sent: Thursday, June 07, 2007 2:10 PM
To: slony1-general@lists.slony.info
Subject: [Slony1-general] Tutorial HeartBeat + slony



Hi lists, is needing a tutorial one on heartbeat + slony. Somebody could he=
lp me

-- =

Marlon

No xadrez existem precisamente 169.518.829.100.544 quatrilh=F5es (15 zeros)=
 de maneiras de jogar apenas os dez primeiros lances. Para os 40 lances seg=
uintes de um jogo inteiro, o n=FAmero =E9 estimado em 25 x 10 elevado a 115=
 pot=EAncia. O n=FAmero inteiro de =E1tomos em todo o universo =E9 apenas u=
ma pequena fra=E7=E3o desse resultado. =

E na vida! =


**********************************************************************
This message contains confidential information intended only for the use of=
 the addressee(s) named above and may contain information that is legally p=
rivileged.  If you are not the addressee, or the person responsible for del=
ivering it to the addressee, you are hereby notified that reading, dissemin=
ating, distributing or copying this message is strictly prohibited.  If you=
 have received this message by mistake, please immediately notify us by rep=
lying to the message and delete the original message immediately thereafter.

Thank you.

                                   FADLD Tag
**********************************************************************
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070607/=
dec13126/attachment.htm
From ssinger_pg at sympatico.ca  Thu Jun  7 17:11:13 2007
From: ssinger_pg at sympatico.ca (Steve Singer)
Date: Thu Jun  7 17:11:28 2007
Subject: [Slony1-general] Tutorial HeartBeat + slony
In-Reply-To: <917b114a0706071410y651df988n36e8c50996837eca@mail.gmail.com>
References: <917b114a0706071410y651df988n36e8c50996837eca@mail.gmail.com>
Message-ID: <Pine.LNX.4.62.0706072008140.23569@mini.atlantida.localdomain>

On Thu, 7 Jun 2007, Marlon Petry wrote:

I posted some instructions on this to the list a while back including a =

config file (attached to the second post)
You can get them at:

http://lists.slony.info/pipermail/slony1-general/2006-September/004845.html
http://lists.slony.info/pipermail/slony1-general/2006-September/004924.html

Steve


> Hi lists, is needing a tutorial one on heartbeat + slony. Somebody could
> help me
>
> -- =

> Marlon
>
> No xadrez existem precisamente 169.518.829.100.544 quatrilh=F5es (15 zero=
s) de
> maneiras de jogar apenas os dez primeiros lances. Para os 40 lances
> seguintes de um jogo inteiro, o n=FAmero =E9 estimado em 25 x 10 elevado =
a 115
> pot=EAncia. O n=FAmero inteiro de =E1tomos em todo o universo =E9 apenas =
uma pequena
> fra=E7=E3o desse resultado.
> E na vida!
>
From muniswamy.g at renaissance-it.com  Thu Jun  7 23:25:18 2007
From: muniswamy.g at renaissance-it.com (G Muniswamy)
Date: Thu Jun  7 23:24:33 2007
Subject: [Slony1-general] Adding one more slave node
Message-ID: <585C7AB730180C4CB3D086B7256531FB8C8B03@srit_mail.renaissance-it.com>

 

Dear Slony Users.

 

I am having slony setup of master and 2 slave setup and it is working
fine.Now I want add one more slave.Please 

tell me the steps and how to modify the configuration file.

  

 

 

G.Muniswamy | Associate Senior DBA-Delivery

E-mail: muniswamy.g@renaissance-it.com | Extn: 1618

 


Sobha Renaissance Information Technology (P) Ltd.


An SEI-CMM, P-CMM & SSE-CMM Level 5 Company | BS ISO/IEC 27001:2005 &
ISO 9001:2000 Certified

A Top 50 Fast Growing Technology Company (Deloitte, 2006) | A Six Sigma
Practice Company 

 

Phone: + 91 80 41951999 | Fax: + 91 80 41523300

URL: www.renaissance-it.com | Video Conference: + 91 80 41252222

 

The information transmitted is intended only for the person or entity to
which it is addressed and may contain confidential and/or privileged
material. Any review, retransmission, dissemination or other use of, or
taking of any action in reliance upon, this information by persons or
entities other than the intended recipient is prohibited. If you
received this in error, please contact the sender and delete all copies
from any computer.

 

 

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070608/d4cbb776/attachment-0001.htm
From andrew.george.hammond at gmail.com  Fri Jun  8 10:17:48 2007
From: andrew.george.hammond at gmail.com (Andrew Hammond)
Date: Fri Jun  8 10:17:54 2007
Subject: [Slony1-general] Adding one more slave node
In-Reply-To: <585C7AB730180C4CB3D086B7256531FB8C8B03@srit_mail.renaissance-it.com>
References: <585C7AB730180C4CB3D086B7256531FB8C8B03@srit_mail.renaissance-it.com>
Message-ID: <5a0a9d6f0706081017q37626fe1p99b15fa61de483a9@mail.gmail.com>

Step 1: Read the friendly manual, at least enough that you know the
terminology so that you can ask reasonable questions.
Step 2: Ask questions about specific issues you are having instead of
broad questions which are already covered in the documentation.

The following document has an attitude problem, but it does make some
valid points.

http://www.catb.org/~esr/faqs/smart-questions.html

Andrew


On 6/7/07, G Muniswamy <muniswamy.g@renaissance-it.com> wrote:
>
> Dear Slony Users.
>
> I am having slony setup of master and 2 slave setup and it is working
> fine.Now I want add one more slave.Please
>
> tell me the steps and how to modify the configuration file.
From cbbrowne at ca.afilias.info  Fri Jun  8 12:04:55 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Fri Jun  8 12:05:07 2007
Subject: [Slony1-general] PG 8.1 crash when testing UPGRADE FUNCTIONS on
	8.1.1
Message-ID: <4669A857.6050100@ca.afilias.info>

I ran into a PG backend crash when running UPGRADE FUNCTIONS on a
PostgreSQL 8.1.1 instance.

I upgraded to something newer (8.1.9) and that seemed to alleviate things.

Looking at release notes, I think I can locate a seeming cause for this:

http://www.postgresql.org/docs/8.2/static/release-8-1-4.html

"Fix crash from using and modifying a plpgsql function in the same
transaction"

UPGRADE FUNCTIONS obviously does this; it, within the same transaction,
loads (modifies) ALL the Slony-I stored functions, including the one for
doing function upgrades, and runs the one function, near the end.

I suppose I'll add a "gotcha" to the FAQ on this one.

I had been hoping to get the 1.2.10 release out today; I still have some
more testing I want to do, so I think it'll have to wait until Monday. 
FYI, I haven't heard any test reports, positive or negative, from anyone
other than Jan Wieck about 1.2.10...

From dba at richyen.com  Fri Jun  8 14:09:40 2007
From: dba at richyen.com (Richard Yen)
Date: Fri Jun  8 14:09:56 2007
Subject: [Slony1-general] Adding one more slave node
In-Reply-To: <585C7AB730180C4CB3D086B7256531FB8C8B03@srit_mail.renaissance-it.com>
References: <585C7AB730180C4CB3D086B7256531FB8C8B03@srit_mail.renaissance-it.com>
Message-ID: <8EEFCC5D-E45B-4432-BECA-D45F986616CA@richyen.com>

It really depends on how you want to configure the new node.  You can  
either cascade off an existing slave, or make it subscribe directly  
to the master.

In latter case (which is what I'm assuming you want), you just need  
do the following slonik commands:

1.  STORE NODE (for the new node)
2.  STORE PATH (one call for each direction from the new node, which  
would be, for example) 1->4, 2->4, 3->4, 4->3, 4->2, 4->1)
3.  STORE LISTEN (again, one for each direction)
4.  SUBSCRIBE SET

I don't think you need to do anything in terms of a configuration  
file.  You just need to start a slon daemon on the new node between  
steps 3 and 4

Hope this helps somewhat...

--Richard



On Jun 7, 2007, at 11:25 PM, G Muniswamy wrote:

>
>
> Dear Slony Users.
>
>
>
> I am having slony setup of master and 2 slave setup and it is  
> working fine.Now I want add one more slave.Please
>
> tell me the steps and how to modify the configuration file.
>
>
>
>
>
>
>
> G.Muniswamy | Associate Senior DBA-Delivery
>
> E-mail: muniswamy.g@renaissance-it.com | Extn: 1618
>
>
>
> Sobha Renaissance Information Technology (P) Ltd.
> An SEI-CMM, P-CMM & SSE-CMM Level 5 Company | BS ISO/IEC 27001:2005  
> & ISO 9001:2000 Certified
>
> A Top 50 Fast Growing Technology Company (Deloitte, 2006) | A Six  
> Sigma Practice Company
>
>
>
> Phone: + 91 80 41951999 | Fax: + 91 80 41523300
>
> URL: www.renaissance-it.com | Video Conference: + 91 80 41252222
>
>
>
> The information transmitted is intended only for the person or  
> entity to which it is addressed and may contain confidential and/or  
> privileged material. Any review, retransmission, dissemination or  
> other use of, or taking of any action in reliance upon, this  
> information by persons or entities other than the intended  
> recipient is prohibited. If you received this in error, please  
> contact the sender and delete all copies from any computer.
>
>
>
> _______________________________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general

From cbbrowne at ca.afilias.info  Fri Jun  8 14:12:51 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Fri Jun  8 14:12:59 2007
Subject: [Slony1-general] Readying 1.2.10
Message-ID: <60myzaf8vg.fsf@dba2.int.libertyrms.com>

I've got a power outage here, so when my UPS goes, I do :-(.

Apparently the storms hitting the region are having some negative
impact on power.

I have had success running tests of Slony-I 1.2.10 on all the
supported PostgreSQL releases; I believe we'll have to drop 8.1.0 thru
8.1.3 from the "supported list" because of the "sig 11" issue I
observed; apparently they do not cope well with updating *and running*
a stored function in the same transaction.

I have not seen any results of other peoples' testing yet; would
appreciate hearing that others were trying out 1.2.10 from CVS with
some success (lack thereof is also useful).
-- 
(format nil "~S@~S" "cbbrowne" "ca.afilias.info")
<http://dba2.int.libertyrms.com/>
Christopher Browne
(416) 673-4124 (land)
From drees76 at gmail.com  Fri Jun  8 14:18:12 2007
From: drees76 at gmail.com (David Rees)
Date: Fri Jun  8 14:18:21 2007
Subject: [Slony1-general] Version 1.2.10 ready for testing
In-Reply-To: <604plm1ihi.fsf@dba2.int.libertyrms.com>
References: <604plm1ihi.fsf@dba2.int.libertyrms.com>
Message-ID: <72dbd3150706081418t6db305dfrd88568a17f43f2a5@mail.gmail.com>

On 6/5/07, Christopher Browne <cbbrowne@ca.afilias.info> wrote:
> I'll be doing some testing on my "platforms of interest" over the next
> couple of days; if others can run tests they care about, that would be
> a great thing.
>
> I plan to tag and release 1.2.10 by the end of the week; the hope is
> that this will be the final version in the 1.2 branch, as work now
> progresses on an 8.3-oriented "2.0" branch on HEAD.

Is the best way to grab what will be 1.2.10 to check it out from the
REL_1_2_STABLE CVS branch? You may entice more testers if there was an
easy to grab tarball somewhere.

-Dave
From JanWieck at Yahoo.com  Fri Jun  8 15:46:12 2007
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Fri Jun  8 15:46:30 2007
Subject: [Slony1-general] Readying 1.2.10
In-Reply-To: <60myzaf8vg.fsf@dba2.int.libertyrms.com>
References: <60myzaf8vg.fsf@dba2.int.libertyrms.com>
Message-ID: <4669DC34.7080603@Yahoo.com>

On 6/8/2007 5:12 PM, Christopher Browne wrote:
> I've got a power outage here, so when my UPS goes, I do :-(.
> 
> Apparently the storms hitting the region are having some negative
> impact on power.
> 
> I have had success running tests of Slony-I 1.2.10 on all the
> supported PostgreSQL releases; I believe we'll have to drop 8.1.0 thru
> 8.1.3 from the "supported list" because of the "sig 11" issue I
> observed; apparently they do not cope well with updating *and running*
> a stored function in the same transaction.

Sorry, we have to rerun all those tests. The recent 8.3devel commit that 
dropped the implicit casting from various types (like int4 etc.) to text 
required to explicitly cast every single call the createEvent() in the 
slony1_funcs.sql.

> I have not seen any results of other peoples' testing yet; would
> appreciate hearing that others were trying out 1.2.10 from CVS with
> some success (lack thereof is also useful).

Me too. Maybe we should put a snapshot tarball somewhere on the 
slony.info site? It appears that grabbing a CVS tree poses some barrier.


Jan

-- 
#======================================================================#
# It's easier to get forgiveness for being wrong than for being right. #
# Let's break this rule - forgive me.                                  #
#================================================== JanWieck@Yahoo.com #
From andrew.george.hammond at gmail.com  Fri Jun  8 17:35:41 2007
From: andrew.george.hammond at gmail.com (Andrew Hammond)
Date: Fri Jun  8 17:35:51 2007
Subject: [Slony1-general] PG 8.1 crash when testing UPGRADE FUNCTIONS on
	8.1.1
In-Reply-To: <4669A857.6050100@ca.afilias.info>
References: <4669A857.6050100@ca.afilias.info>
Message-ID: <5a0a9d6f0706081735u392e7266ld84ef1bdb0e4d878@mail.gmail.com>

The configure.sh script was missing it's execute permission as checked
out from CVS. It'd be nice to fix this if possible.

I started working on FreeBSD 6.2 / AMD64 tests, but got distracted by
$JOB_SPECIFIC stuff. I'll do a bunch-o-tests on Monday.

Andrew


On 6/8/07, Christopher Browne <cbbrowne@ca.afilias.info> wrote:
> I ran into a PG backend crash when running UPGRADE FUNCTIONS on a
> PostgreSQL 8.1.1 instance.
>
> I upgraded to something newer (8.1.9) and that seemed to alleviate things.
>
> Looking at release notes, I think I can locate a seeming cause for this:
>
> http://www.postgresql.org/docs/8.2/static/release-8-1-4.html
>
> "Fix crash from using and modifying a plpgsql function in the same
> transaction"
>
> UPGRADE FUNCTIONS obviously does this; it, within the same transaction,
> loads (modifies) ALL the Slony-I stored functions, including the one for
> doing function upgrades, and runs the one function, near the end.
>
> I suppose I'll add a "gotcha" to the FAQ on this one.
>
> I had been hoping to get the 1.2.10 release out today; I still have some
> more testing I want to do, so I think it'll have to wait until Monday.
> FYI, I haven't heard any test reports, positive or negative, from anyone
> other than Jan Wieck about 1.2.10...
>
> _______________________________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
>
From ssinger_pg at sympatico.ca  Sat Jun  9 21:24:14 2007
From: ssinger_pg at sympatico.ca (Steven Singer)
Date: Sat Jun  9 21:24:29 2007
Subject: [Slony1-general] Readying 1.2.10
In-Reply-To: <60myzaf8vg.fsf@dba2.int.libertyrms.com>
References: <60myzaf8vg.fsf@dba2.int.libertyrms.com>
Message-ID: <Pine.LNX.4.62.0706092339510.2953@mini.atlantida.localdomain>

On Fri, 8 Jun 2007, Christopher Browne wrote:

I've been trying 1.2.10 from CVS against 8.2 on a Linux PowerPC(mac) and

I've been occasional failures of the testddl unit test with

<stdin>:5: sleep a couple seconds
<stdin>:9: timeout exceeded while waiting for event confirmation

Which appears to be from a:wait for event (origin=1, confirmed=2);

Most of the time testddl passes fine but it failed at least once when I 
tried running it. I am still trying to reproduce the failure.

So far the other unit tests seem to work as expected.

I also noticed the permission issue with configure that Andrew mentioned.


> I've got a power outage here, so when my UPS goes, I do :-(.
>
> Apparently the storms hitting the region are having some negative
> impact on power.
>
> I have had success running tests of Slony-I 1.2.10 on all the
> supported PostgreSQL releases; I believe we'll have to drop 8.1.0 thru
> 8.1.3 from the "supported list" because of the "sig 11" issue I
> observed; apparently they do not cope well with updating *and running*
> a stored function in the same transaction.
>
> I have not seen any results of other peoples' testing yet; would
> appreciate hearing that others were trying out 1.2.10 from CVS with
> some success (lack thereof is also useful).
> -- 
> (format nil "~S@~S" "cbbrowne" "ca.afilias.info")
> <http://dba2.int.libertyrms.com/>
> Christopher Browne
> (416) 673-4124 (land)
> _______________________________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
>

From devrim at CommandPrompt.com  Sun Jun 10 23:06:48 2007
From: devrim at CommandPrompt.com (Devrim =?ISO-8859-1?Q?G=DCND=DCZ?=)
Date: Sun Jun 10 23:07:11 2007
Subject: [Slony1-general] Readying 1.2.10
In-Reply-To: <60myzaf8vg.fsf@dba2.int.libertyrms.com>
References: <60myzaf8vg.fsf@dba2.int.libertyrms.com>
Message-ID: <1181542008.13733.55.camel@laptop.gunduz.org>

SGVsbG8sCgpPbiBGcmksIDIwMDctMDYtMDggYXQgMTc6MTIgLTA0MDAsIENocmlzdG9waGVyIEJy
b3duZSB3cm90ZToKPiBJIGhhdmUgbm90IHNlZW4gYW55IHJlc3VsdHMgb2Ygb3RoZXIgcGVvcGxl
cycgdGVzdGluZyB5ZXQ7IHdvdWxkCj4gYXBwcmVjaWF0ZSBoZWFyaW5nIHRoYXQgb3RoZXJzIHdl
cmUgdHJ5aW5nIG91dCAxLjIuMTAgZnJvbSBDVlMgd2l0aAo+IHNvbWUgc3VjY2VzcyAobGFjayB0
aGVyZW9mIGlzIGFsc28gdXNlZnVsKS4gCgpJIHdvdWxkIGxpa2UgdG8gY29tbWl0IG15IHNwZWMg
ZmlsZSAqYWZ0ZXIqIDEuMi4xMCBpcyByZWFkeSBpbiBDVlMgKGFuZAp0aGVyZSBpcyBhIHRlc3Qg
dGFyYmFsbCBhcm91bmQpLiBQbGVhc2UgZG8gbm90IHJlbGVhc2UgMS4yLjEwIGJlZm9yZSBJCmNv
bW1pdCBpdCAtLSBTbG9ueS1JIGlzIHVuZGVyIHJldmlldyBieSBGZWRvcmEgcGVvcGxlIGFuZCBJ
IGV4cGVjdCB0bwpzZWUgaXQgaW4gRmVkb3JhIFJTTi4KClJlZ2FyZHMsCi0tIApEZXZyaW0gR8Oc
TkTDnFoKUG9zdGdyZVNRTCBSZXBsaWNhdGlvbiwgQ29uc3VsdGluZywgQ3VzdG9tIERldmVsb3Bt
ZW50LCAyNHg3IHN1cHBvcnQKTWFuYWdlZCBTZXJ2aWNlcywgU2hhcmVkIGFuZCBEZWRpY2F0ZWQg
SG9zdGluZwpDby1BdXRob3JzOiBwbFBIUCwgT0RCQ25nIC0gaHR0cDovL3d3dy5jb21tYW5kcHJv
bXB0LmNvbS8KCgotLS0tLS0tLS0tLS0tLSBuZXh0IHBhcnQgLS0tLS0tLS0tLS0tLS0KQSBub24t
dGV4dCBhdHRhY2htZW50IHdhcyBzY3J1YmJlZC4uLgpOYW1lOiBub3QgYXZhaWxhYmxlClR5cGU6
IGFwcGxpY2F0aW9uL3BncC1zaWduYXR1cmUKU2l6ZTogMTg5IGJ5dGVzCkRlc2M6IFRoaXMgaXMg
YSBkaWdpdGFsbHkgc2lnbmVkIG1lc3NhZ2UgcGFydApVcmwgOiBodHRwOi8vbGlzdHMuc2xvbnku
aW5mby9waXBlcm1haWwvc2xvbnkxLWdlbmVyYWwvYXR0YWNobWVudHMvMjAwNzA2MTEvMmNlOTE1
YWMvYXR0YWNobWVudC5wZ3AK
From cbbrowne at ca.afilias.info  Mon Jun 11 15:57:46 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Mon Jun 11 15:58:00 2007
Subject: [Slony1-general] Testing going well
Message-ID: <466DD36A.8050700@ca.afilias.info>

I have had good success with testing on all versions of PostgreSQL; I'll
see about generating a tarball in the morning for others to test with so
we can get any permission gripes dealt with ASAP...
From dbarthel at usedeverywhere.com  Mon Jun 11 17:39:24 2007
From: dbarthel at usedeverywhere.com (Don Barthel)
Date: Mon Jun 11 17:39:36 2007
Subject: [Slony1-general] Issue Compiling Slony 1.1.5
Message-ID: <93f47c720706111739q6b6a00bev5e2f89625ea643f8@mail.gmail.com>

I'm getting the exact same compiler error with 1.1.5 as here:
http://gborg.postgresql.org/pipermail/slony1-general/2007-January/005678.html

<<confoptions.c:115: undefined reference to `pg_qsort'>>

I tried the suggested fix there and got the same negative result as
the original poster.

Any suggestions to get 1.1.5 to compile? I don't want to upgrade the
version of Slony on the existing servers.

I'm using FreeBSD 6.1 and Postgres 8.2.4.

- Don Barthel
From devrim at CommandPrompt.com  Mon Jun 11 23:39:10 2007
From: devrim at CommandPrompt.com (Devrim =?ISO-8859-1?Q?G=DCND=DCZ?=)
Date: Mon Jun 11 23:39:47 2007
Subject: [Slony1-general] Issue Compiling Slony 1.1.5
In-Reply-To: <93f47c720706111739q6b6a00bev5e2f89625ea643f8@mail.gmail.com>
References: <93f47c720706111739q6b6a00bev5e2f89625ea643f8@mail.gmail.com>
Message-ID: <1181630350.6105.2.camel@localhost.localdomain>

SGVsbG8sCgpPbiBNb24sIDIwMDctMDYtMTEgYXQgMTk6MzkgLTA1MDAsIERvbiBCYXJ0aGVsIHdy
b3RlOgo+IEFueSBzdWdnZXN0aW9ucyB0byBnZXQgMS4xLjUgdG8gY29tcGlsZT8gSSBkb24ndCB3
YW50IHRvIHVwZ3JhZGUgdGhlCj4gdmVyc2lvbiBvZiBTbG9ueSBvbiB0aGUgZXhpc3Rpbmcgc2Vy
dmVycy4KPiAKPiBJJ20gdXNpbmcgRnJlZUJTRCA2LjEgYW5kIFBvc3RncmVzIDguMi40LiAKCkkg
ZG9uJ3QgdGhpbmsgdGhhdCB5b3UgY2FuIGNvbXBpbGUgU2xvbnktMS4xLjUgYWdhaW5zdCBQb3N0
Z3JlU1FMIDguMi40LgpUaW1lIHRvIHVwZ3JhZGUuLi4KClJlZ2FyZHMsIAotLSAKRGV2cmltIEfD
nE5Ew5xaClBvc3RncmVTUUwgUmVwbGljYXRpb24sIENvbnN1bHRpbmcsIEN1c3RvbSBEZXZlbG9w
bWVudCwgMjR4NyBzdXBwb3J0Ck1hbmFnZWQgU2VydmljZXMsIFNoYXJlZCBhbmQgRGVkaWNhdGVk
IEhvc3RpbmcKQ28tQXV0aG9yczogcGxQSFAsIE9EQkNuZyAtIGh0dHA6Ly93d3cuY29tbWFuZHBy
b21wdC5jb20vCgoKLS0tLS0tLS0tLS0tLS0gbmV4dCBwYXJ0IC0tLS0tLS0tLS0tLS0tCkEgbm9u
LXRleHQgYXR0YWNobWVudCB3YXMgc2NydWJiZWQuLi4KTmFtZTogbm90IGF2YWlsYWJsZQpUeXBl
OiBhcHBsaWNhdGlvbi9wZ3Atc2lnbmF0dXJlClNpemU6IDE4OSBieXRlcwpEZXNjOiBUaGlzIGlz
IGEgZGlnaXRhbGx5IHNpZ25lZCBtZXNzYWdlIHBhcnQKVXJsIDogaHR0cDovL2xpc3RzLnNsb255
LmluZm8vcGlwZXJtYWlsL3Nsb255MS1nZW5lcmFsL2F0dGFjaG1lbnRzLzIwMDcwNjEyLzBmNzJm
ODE5L2F0dGFjaG1lbnQucGdwCg==
From cbbrowne at ca.afilias.info  Wed Jun 13 08:53:16 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Wed Jun 13 08:53:26 2007
Subject: [Slony1-general] Readying 1.2.10
In-Reply-To: <1181542008.13733.55.camel@laptop.gunduz.org>
References: <60myzaf8vg.fsf@dba2.int.libertyrms.com>
	<1181542008.13733.55.camel@laptop.gunduz.org>
Message-ID: <467012EC.9060905@ca.afilias.info>

Devrim G?ND?Z wrote:
> Hello,
>
> On Fri, 2007-06-08 at 17:12 -0400, Christopher Browne wrote:
>   
>> I have not seen any results of other peoples' testing yet; would
>> appreciate hearing that others were trying out 1.2.10 from CVS with
>> some success (lack thereof is also useful). 
>>     
>
> I would like to commit my spec file *after* 1.2.10 is ready in CVS (and
> there is a test tarball around). Please do not release 1.2.10 before I
> commit it -- Slony-I is under review by Fedora people and I expect to
> see it in Fedora RSN.
>
> Regards,
>   
I have seen commits on the spec file even though I haven't yet generated
a test tarball; have you made the changes you need?  Or is there still a
need to wait?

I'm thinking I should tag now, and generate a tarball, now, marked as
being "pre-1.2.10", to ease more testing even before Jan gets to the log
shipping fix that is presently O/S...  I can't do any work this
afternoon, so we might as well have something that's more testable for
now...
From devrim at CommandPrompt.com  Wed Jun 13 09:03:32 2007
From: devrim at CommandPrompt.com (Devrim =?ISO-8859-1?Q?G=DCND=DCZ?=)
Date: Wed Jun 13 09:04:08 2007
Subject: [Slony1-general] Readying 1.2.10
In-Reply-To: <467012EC.9060905@ca.afilias.info>
References: <60myzaf8vg.fsf@dba2.int.libertyrms.com>
	<1181542008.13733.55.camel@laptop.gunduz.org>
	<467012EC.9060905@ca.afilias.info>
Message-ID: <1181750612.2878.4.camel@laptop.gunduz.org>

SGksCgpPbiBXZWQsIDIwMDctMDYtMTMgYXQgMTU6NTMgKzAwMDAsIENocmlzdG9waGVyIEJyb3du
ZSB3cm90ZToKPiBJJ20gdGhpbmtpbmcgSSBzaG91bGQgdGFnIG5vdywgYW5kIGdlbmVyYXRlIGEg
dGFyYmFsbCwgbm93LCBtYXJrZWQgYXMKPiBiZWluZyAicHJlLTEuMi4xMCIsIHRvIGVhc2UgbW9y
ZSB0ZXN0aW5nIGV2ZW4gYmVmb3JlIEphbiBnZXRzIHRvIHRoZQo+IGxvZyBzaGlwcGluZyBmaXgg
dGhhdCBpcyBwcmVzZW50bHkgTy9TLi4uICAKClllcywgcGxlYXNlIGRvIHNvLiBJIGNhbiB0ZXN0
IHRoZSAicHJlIiB0YXJiYWxsLgoKT1RPSCwgdGhlIHNwZWMgZmlsZSBzZWVtcyB0byBiZSByZWFk
eSwgSSB0aGluay4gQnV0IEkgbmVlZCB0byB0ZXN0LgoKUmVnYXJkcywKLS0gCkRldnJpbSBHw5xO
RMOcWgpQb3N0Z3JlU1FMIFJlcGxpY2F0aW9uLCBDb25zdWx0aW5nLCBDdXN0b20gRGV2ZWxvcG1l
bnQsIDI0eDcgc3VwcG9ydApNYW5hZ2VkIFNlcnZpY2VzLCBTaGFyZWQgYW5kIERlZGljYXRlZCBI
b3N0aW5nCkNvLUF1dGhvcnM6IHBsUEhQLCBPREJDbmcgLSBodHRwOi8vd3d3LmNvbW1hbmRwcm9t
cHQuY29tLwoKCi0tLS0tLS0tLS0tLS0tIG5leHQgcGFydCAtLS0tLS0tLS0tLS0tLQpBIG5vbi10
ZXh0IGF0dGFjaG1lbnQgd2FzIHNjcnViYmVkLi4uCk5hbWU6IG5vdCBhdmFpbGFibGUKVHlwZTog
YXBwbGljYXRpb24vcGdwLXNpZ25hdHVyZQpTaXplOiAxODkgYnl0ZXMKRGVzYzogVGhpcyBpcyBh
IGRpZ2l0YWxseSBzaWduZWQgbWVzc2FnZSBwYXJ0ClVybCA6IGh0dHA6Ly9saXN0cy5zbG9ueS5p
bmZvL3BpcGVybWFpbC9zbG9ueTEtZ2VuZXJhbC9hdHRhY2htZW50cy8yMDA3MDYxMy80ZTUyNTg1
My9hdHRhY2htZW50LnBncAo=
From cbbrowne at ca.afilias.info  Wed Jun 13 09:28:47 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Wed Jun 13 09:28:52 2007
Subject: [Slony1-general] Readying 1.2.10
In-Reply-To: <1181750612.2878.4.camel@laptop.gunduz.org>
References: <60myzaf8vg.fsf@dba2.int.libertyrms.com>	
	<1181542008.13733.55.camel@laptop.gunduz.org>	
	<467012EC.9060905@ca.afilias.info>
	<1181750612.2878.4.camel@laptop.gunduz.org>
Message-ID: <46701B3F.4060607@ca.afilias.info>

Devrim G?ND?Z wrote:
> Hi,
>
> On Wed, 2007-06-13 at 15:53 +0000, Christopher Browne wrote:
>   
>> I'm thinking I should tag now, and generate a tarball, now, marked as
>> being "pre-1.2.10", to ease more testing even before Jan gets to the
>> log shipping fix that is presently O/S...  
>>     
>
> Yes, please do so. I can test the "pre" tarball.
>
> OTOH, the spec file seems to be ready, I think. But I need to test.
>
> Regards,
>   
OK.  I have put a tarball in place here:

http://lists.slony.info/downloads/1.2/slony1-1.2.10-pre.tar.bz2

========================
PLEASE NOTE!!!!!!!!!!!!!!!!!

This is a pre-release tarball of 1.2.10, for use by testers. There is a
known bug in log shipping that we expect to fix before the final relase
of 1.2.10.  The software is obviously BSD-licensed, so people are, in a
sense, free to do as they will with it, but in view of the pre-release
standpoint, we implore people NOT to release binaries of this lest
anyone should get confused that this is a final 1.2.10 release.
========================

Aside:  xfade is the only one at present who can write in the
subdirectories under 1.2:

cbbrowne@main:/home/community/slony/htdocs/downloads/1.2$ ls -alt
total 856
drwxrwxrwx 5 cbbrowne slony   4096 Jun 13 09:18 .
-rw-r--r-- 1 cbbrowne slony 848080 Jun 13 09:17 slony1-1.2.10-pre.tar.bz2
drwxr-xr-x 2 xfade    slony   4096 Mar 27 04:11 rpm
drwxr-xr-x 2 xfade    slony   4096 Mar 27 04:03 win32
drwxr-xr-x 2 xfade    slony   4096 Mar 27 03:52 source
drwxrwxr-x 5 cbbrowne slony   4096 Feb 28 11:20 ..

Could the permissions be opened so that the slony group has write
perms?  Thanks!
From devrim at CommandPrompt.com  Wed Jun 13 09:32:45 2007
From: devrim at CommandPrompt.com (Devrim =?ISO-8859-1?Q?G=DCND=DCZ?=)
Date: Wed Jun 13 09:33:17 2007
Subject: [Slony1-general] Readying 1.2.10
In-Reply-To: <46701B3F.4060607@ca.afilias.info>
References: <60myzaf8vg.fsf@dba2.int.libertyrms.com>
	<1181542008.13733.55.camel@laptop.gunduz.org>
	<467012EC.9060905@ca.afilias.info>
	<1181750612.2878.4.camel@laptop.gunduz.org>
	<46701B3F.4060607@ca.afilias.info>
Message-ID: <1181752365.2878.11.camel@laptop.gunduz.org>

SGksCgpPbiBXZWQsIDIwMDctMDYtMTMgYXQgMTY6MjggKzAwMDAsIENocmlzdG9waGVyIEJyb3du
ZSB3cm90ZToKICAgCj4gT0suICBJIGhhdmUgcHV0IGEgdGFyYmFsbCBpbiBwbGFjZSBoZXJlOgo+
IAo+IGh0dHA6Ly9saXN0cy5zbG9ueS5pbmZvL2Rvd25sb2Fkcy8xLjIvc2xvbnkxLTEuMi4xMC1w
cmUudGFyLmJ6MiAKCkknbSBnZXR0aW5nIDQwNCBoZXJlPwoKUmVnYXJkcywKLS0gCkRldnJpbSBH
w5xORMOcWgpQb3N0Z3JlU1FMIFJlcGxpY2F0aW9uLCBDb25zdWx0aW5nLCBDdXN0b20gRGV2ZWxv
cG1lbnQsIDI0eDcgc3VwcG9ydApNYW5hZ2VkIFNlcnZpY2VzLCBTaGFyZWQgYW5kIERlZGljYXRl
ZCBIb3N0aW5nCkNvLUF1dGhvcnM6IHBsUEhQLCBPREJDbmcgLSBodHRwOi8vd3d3LmNvbW1hbmRw
cm9tcHQuY29tLwoKCi0tLS0tLS0tLS0tLS0tIG5leHQgcGFydCAtLS0tLS0tLS0tLS0tLQpBIG5v
bi10ZXh0IGF0dGFjaG1lbnQgd2FzIHNjcnViYmVkLi4uCk5hbWU6IG5vdCBhdmFpbGFibGUKVHlw
ZTogYXBwbGljYXRpb24vcGdwLXNpZ25hdHVyZQpTaXplOiAxODkgYnl0ZXMKRGVzYzogVGhpcyBp
cyBhIGRpZ2l0YWxseSBzaWduZWQgbWVzc2FnZSBwYXJ0ClVybCA6IGh0dHA6Ly9saXN0cy5zbG9u
eS5pbmZvL3BpcGVybWFpbC9zbG9ueTEtZ2VuZXJhbC9hdHRhY2htZW50cy8yMDA3MDYxMy85ZDI1
NWFlNS9hdHRhY2htZW50LnBncAo=
From devrim at CommandPrompt.com  Wed Jun 13 09:51:22 2007
From: devrim at CommandPrompt.com (Devrim =?ISO-8859-1?Q?G=DCND=DCZ?=)
Date: Wed Jun 13 09:51:59 2007
Subject: [Slony1-general] Readying 1.2.10
In-Reply-To: <46701B3F.4060607@ca.afilias.info>
References: <60myzaf8vg.fsf@dba2.int.libertyrms.com>
	<1181542008.13733.55.camel@laptop.gunduz.org>
	<467012EC.9060905@ca.afilias.info>
	<1181750612.2878.4.camel@laptop.gunduz.org>
	<46701B3F.4060607@ca.afilias.info>
Message-ID: <1181753482.2878.13.camel@laptop.gunduz.org>

SGVsbG9pCgpPbiBXZWQsIDIwMDctMDYtMTMgYXQgMTY6MjggKzAwMDAsIENocmlzdG9waGVyIEJy
b3duZSB3cm90ZToKPiAKPiBDb3VsZCB0aGUgcGVybWlzc2lvbnMgYmUgb3BlbmVkIHNvIHRoYXQg
dGhlIHNsb255IGdyb3VwIGhhcyB3cml0ZQo+IHBlcm1zPyAKCkRvbmUuCgpSZWdhcmRzLAotLSAK
RGV2cmltIEfDnE5Ew5xaClBvc3RncmVTUUwgUmVwbGljYXRpb24sIENvbnN1bHRpbmcsIEN1c3Rv
bSBEZXZlbG9wbWVudCwgMjR4NyBzdXBwb3J0Ck1hbmFnZWQgU2VydmljZXMsIFNoYXJlZCBhbmQg
RGVkaWNhdGVkIEhvc3RpbmcKQ28tQXV0aG9yczogcGxQSFAsIE9EQkNuZyAtIGh0dHA6Ly93d3cu
Y29tbWFuZHByb21wdC5jb20vCgoKLS0tLS0tLS0tLS0tLS0gbmV4dCBwYXJ0IC0tLS0tLS0tLS0t
LS0tCkEgbm9uLXRleHQgYXR0YWNobWVudCB3YXMgc2NydWJiZWQuLi4KTmFtZTogbm90IGF2YWls
YWJsZQpUeXBlOiBhcHBsaWNhdGlvbi9wZ3Atc2lnbmF0dXJlClNpemU6IDE4OSBieXRlcwpEZXNj
OiBUaGlzIGlzIGEgZGlnaXRhbGx5IHNpZ25lZCBtZXNzYWdlIHBhcnQKVXJsIDogaHR0cDovL2xp
c3RzLnNsb255LmluZm8vcGlwZXJtYWlsL3Nsb255MS1nZW5lcmFsL2F0dGFjaG1lbnRzLzIwMDcw
NjEzL2NjNDgxMDA1L2F0dGFjaG1lbnQucGdwCg==
From cbbrowne at ca.afilias.info  Wed Jun 13 14:59:35 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Wed Jun 13 14:59:44 2007
Subject: [Slony1-general] Readying 1.2.10
In-Reply-To: <1181752365.2878.11.camel@laptop.gunduz.org>
References: <60myzaf8vg.fsf@dba2.int.libertyrms.com>	
	<1181542008.13733.55.camel@laptop.gunduz.org>	
	<467012EC.9060905@ca.afilias.info>	
	<1181750612.2878.4.camel@laptop.gunduz.org>	
	<46701B3F.4060607@ca.afilias.info>
	<1181752365.2878.11.camel@laptop.gunduz.org>
Message-ID: <467068C7.8030209@ca.afilias.info>

Devrim G?ND?Z wrote:
> Hi,
>
> On Wed, 2007-06-13 at 16:28 +0000, Christopher Browne wrote:
>    
>   
>> OK.  I have put a tarball in place here:
>>
>> http://lists.slony.info/downloads/1.2/slony1-1.2.10-pre.tar.bz2 
>>     
>
> I'm getting 404 here?
>
> Regards,
>   
It was *sort of* there; apparently something funky about the PHP web
site code that I'll choose not to understand.

I have shifted it into the sources subdirectory, where it properly
belongs; thanks for the perms update...

The URL that works:
<http://lists.slony.info/downloads/1.2/source/slony1-1.2.10-pre.tar.bz2>

I'll update the URLs on the news page accordingly.
From ssinger_pg at sympatico.ca  Wed Jun 13 16:55:08 2007
From: ssinger_pg at sympatico.ca (Steven Singer)
Date: Wed Jun 13 16:55:23 2007
Subject: [Slony1-general] Readying 1.2.10
In-Reply-To: <467012EC.9060905@ca.afilias.info>
References: <60myzaf8vg.fsf@dba2.int.libertyrms.com>
	<1181542008.13733.55.camel@laptop.gunduz.org>
	<467012EC.9060905@ca.afilias.info>
Message-ID: <Pine.LNX.4.62.0706131948100.2953@mini.atlantida.localdomain>

On Wed, 13 Jun 2007, Christopher Browne wrote:


I've downloaded the tarball can compiled against a 8.3 snapshot on Linux an=
d =

I'm still getting periodic failures of the testddl unit test.

Usually its a <stdin>:9: timeout exceeded while waiting for event confirmat=
ion

I keep seeing messages along the line in the slon.2.log like:
2007-06-13 19:25:20 EDT WARN   remoteWorkerThread_1: copy set: data provide=
r =

1 only on sync -1 - sleep 5 seconds

Is this the problem Jan is working on or is it something else?
Has anyone else tried to run the testddl unit test a handful of times with =

better luck?




> Devrim G=DCND=DCZ wrote:
>> Hello,
>>
>> On Fri, 2007-06-08 at 17:12 -0400, Christopher Browne wrote:
>>
>>> I have not seen any results of other peoples' testing yet; would
>>> appreciate hearing that others were trying out 1.2.10 from CVS with
>>> some success (lack thereof is also useful).
>>>
>>
>> I would like to commit my spec file *after* 1.2.10 is ready in CVS (and
>> there is a test tarball around). Please do not release 1.2.10 before I
>> commit it -- Slony-I is under review by Fedora people and I expect to
>> see it in Fedora RSN.
>>
>> Regards,
>>
> I have seen commits on the spec file even though I haven't yet generated
> a test tarball; have you made the changes you need?  Or is there still a
> need to wait?
>
> I'm thinking I should tag now, and generate a tarball, now, marked as
> being "pre-1.2.10", to ease more testing even before Jan gets to the log
> shipping fix that is presently O/S...  I can't do any work this
> afternoon, so we might as well have something that's more testable for
> now...
> _______________________________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
>
From devrim at CommandPrompt.com  Thu Jun 14 06:55:08 2007
From: devrim at CommandPrompt.com (Devrim =?ISO-8859-1?Q?G=DCND=DCZ?=)
Date: Thu Jun 14 06:55:58 2007
Subject: [Slony1-general] Readying 1.2.10
In-Reply-To: <467068C7.8030209@ca.afilias.info>
References: <60myzaf8vg.fsf@dba2.int.libertyrms.com>
	<1181542008.13733.55.camel@laptop.gunduz.org>
	<467012EC.9060905@ca.afilias.info>
	<1181750612.2878.4.camel@laptop.gunduz.org>
	<46701B3F.4060607@ca.afilias.info>
	<1181752365.2878.11.camel@laptop.gunduz.org>
	<467068C7.8030209@ca.afilias.info>
Message-ID: <1181829308.3230.15.camel@localhost.localdomain>

SGVsbG8sCgpPbiBXZWQsIDIwMDctMDYtMTMgYXQgMjE6NTkgKzAwMDAsIENocmlzdG9waGVyIEJy
b3duZSB3cm90ZToKCj4gVGhlIFVSTCB0aGF0IHdvcmtzOgo+IDxodHRwOi8vbGlzdHMuc2xvbnku
aW5mby9kb3dubG9hZHMvMS4yL3NvdXJjZS9zbG9ueTEtMS4yLjEwLXByZS50YXIuYnoyPgo+IAoK
VGhhbmtzLiBIZXJlIGFyZSB0aGUgaXNzdWVzIHRoYXQgSSBmb3VuZCBpbiB0aGUgdGFyYmFsbDoK
CjEuIC5jdnNpZ25vcmUgZmlsZXM6CgouL2RvYy9pbXBsZW1lbnRhdGlvbi8uY3ZzaWdub3JlCi4v
ZG9jL2NvbmNlcHQvLmN2c2lnbm9yZQouL3NyYy9kdWN0dGFwZS8uY3ZzaWdub3JlCi4vc3JjL3h4
aWQvLmN2c2lnbm9yZQouL3NyYy9zbG9uLy5jdnNpZ25vcmUKLi9zcmMvc2xvbmlrLy5jdnNpZ25v
cmUKLi9zcmMvYmFja2VuZC8uY3ZzaWdub3JlCi4vLmN2c2lnbm9yZQoKMi4gVW5uZWVkZWQgZmls
ZSBpbiB0aGUgdGFyYmFsbDoKCi4vLiNwb3N0Z3Jlc3FsLXNsb255MS1lbmdpbmUuc3BlYy5pbi4x
LjMxLjIuNgoKMy4gUGVybWlzc2lvbiBpc3N1ZXMKClRoZXJlIGFyZSB2YXJpb3VzIHBlcm1pc3Np
b24gaXNzdWVzIGluIHRoZSB0YXJiYWxsLiBJIGhhdmUgcmVwb3J0ZWQgdGhlbQpiZWZvcmUuIEhl
cmUgaXMgd2hhdCBJIGN1cnJlbnRseSBkbyBpbiBteSBzcGVjIGZpbGU6CmNobW9kIC1SIDY0NCBk
b2MvKgoKSSdtIGN1cnJlbnRseSB0ZXN0aW5nIHRoZSB0YXJiYWxsLCB3aWxsIHJlcG9ydCBtb3Jl
IChpZiBJIGNhbiBmaW5kCm1vcmUgOikgKQoKUmVnYXJkcywKLS0gCkRldnJpbSBHw5xORMOcWgpQ
b3N0Z3JlU1FMIFJlcGxpY2F0aW9uLCBDb25zdWx0aW5nLCBDdXN0b20gRGV2ZWxvcG1lbnQsIDI0
eDcgc3VwcG9ydApNYW5hZ2VkIFNlcnZpY2VzLCBTaGFyZWQgYW5kIERlZGljYXRlZCBIb3N0aW5n
CkNvLUF1dGhvcnM6IHBsUEhQLCBPREJDbmcgLSBodHRwOi8vd3d3LmNvbW1hbmRwcm9tcHQuY29t
LwoKCgotLS0tLS0tLS0tLS0tLSBuZXh0IHBhcnQgLS0tLS0tLS0tLS0tLS0KQSBub24tdGV4dCBh
dHRhY2htZW50IHdhcyBzY3J1YmJlZC4uLgpOYW1lOiBub3QgYXZhaWxhYmxlClR5cGU6IGFwcGxp
Y2F0aW9uL3BncC1zaWduYXR1cmUKU2l6ZTogMTg5IGJ5dGVzCkRlc2M6IFRoaXMgaXMgYSBkaWdp
dGFsbHkgc2lnbmVkIG1lc3NhZ2UgcGFydApVcmwgOiBodHRwOi8vbGlzdHMuc2xvbnkuaW5mby9w
aXBlcm1haWwvc2xvbnkxLWdlbmVyYWwvYXR0YWNobWVudHMvMjAwNzA2MTQvY2Q2YTVlNjIvYXR0
YWNobWVudC5wZ3AK
From z-saito at guitar.ocn.ne.jp  Thu Jun 14 07:52:18 2007
From: z-saito at guitar.ocn.ne.jp (Hiroshi Saito)
Date: Thu Jun 14 07:52:15 2007
Subject: [Slony1-general] Readying 1.2.10
References: <60myzaf8vg.fsf@dba2.int.libertyrms.com>	<1181542008.13733.55.camel@laptop.gunduz.org>	<467012EC.9060905@ca.afilias.info>	<1181750612.2878.4.camel@laptop.gunduz.org>	<46701B3F.4060607@ca.afilias.info><1181752365.2878.11.camel@laptop.gunduz.org>
	<467068C7.8030209@ca.afilias.info>
Message-ID: <02ea01c7ae93$9b148fb0$c701a8c0@HP22720319231>

Hi.

Sorry very late reaction...
I desire to have not missed the opportunity.
This is required of MinGW+gcc. please apply it.
I'm continuing the  tests/run_test.sh  now after the patch.

P.S)
I'm still holding the proposal of construction by VC+8.
However, It will still preserve.

Thanks!

Regards,
Hiroshi Saito

----- Original Message ----- =

From: "Christopher Browne" >


> Devrim G=DCND=DCZ wrote:
>> Hi,
>>
>> On Wed, 2007-06-13 at 16:28 +0000, Christopher Browne wrote:
>>
>>
>>> OK.  I have put a tarball in place here:
>>>
>>> http://lists.slony.info/downloads/1.2/slony1-1.2.10-pre.tar.bz2
>>>
>>
>> I'm getting 404 here?
>>
>> Regards,
>>
> It was *sort of* there; apparently something funky about the PHP web
> site code that I'll choose not to understand.
>
> I have shifted it into the sources subdirectory, where it properly
> belongs; thanks for the perms update...
>
> The URL that works:
> <http://lists.slony.info/downloads/1.2/source/slony1-1.2.10-pre.tar.bz2>
>
> I'll update the URLs on the news page accordingly.
> _______________________________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general =

-------------- next part --------------
A non-text attachment was scrubbed...
Name: slon_win32_patch
Type: application/octet-stream
Size: 247 bytes
Desc: not available
Url : http://lists.slony.info/pipermail/slony1-general/attachments/20070614=
/ca2d1367/slon_win32_patch.obj
From cbbrowne at ca.afilias.info  Thu Jun 14 07:59:30 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Thu Jun 14 07:59:37 2007
Subject: [Slony1-general] Readying 1.2.10
In-Reply-To: <02ea01c7ae93$9b148fb0$c701a8c0@HP22720319231> (Hiroshi Saito's
	message of "Thu, 14 Jun 2007 23:52:18 +0900")
References: <60myzaf8vg.fsf@dba2.int.libertyrms.com>
	<1181542008.13733.55.camel@laptop.gunduz.org>
	<467012EC.9060905@ca.afilias.info>
	<1181750612.2878.4.camel@laptop.gunduz.org>
	<46701B3F.4060607@ca.afilias.info>
	<1181752365.2878.11.camel@laptop.gunduz.org>
	<467068C7.8030209@ca.afilias.info>
	<02ea01c7ae93$9b148fb0$c701a8c0@HP22720319231>
Message-ID: <60lkeminu5.fsf@dba2.int.libertyrms.com>

"Hiroshi Saito" <z-saito@guitar.ocn.ne.jp> writes:
> Hi.
>
> Sorry very late reaction...
> I desire to have not missed the opportunity.
> This is required of MinGW+gcc. please apply it.
> I'm continuing the  tests/run_test.sh  now after the patch.

Thanks for the patch; I have applied it to 1.2 and to HEAD, and added
it to release notes.  It will be in 1.2.10.
-- 
(reverse (concatenate 'string "ofni.sailifa.ac" "@" "enworbbc"))
<http://dba2.int.libertyrms.com/>
Christopher Browne
(416) 673-4124 (land)
From z-saito at guitar.ocn.ne.jp  Thu Jun 14 08:06:14 2007
From: z-saito at guitar.ocn.ne.jp (Hiroshi Saito)
Date: Thu Jun 14 08:06:10 2007
Subject: [Slony1-general] Readying 1.2.10
References: <60myzaf8vg.fsf@dba2.int.libertyrms.com><1181542008.13733.55.camel@laptop.gunduz.org><467012EC.9060905@ca.afilias.info><1181750612.2878.4.camel@laptop.gunduz.org><46701B3F.4060607@ca.afilias.info><1181752365.2878.11.camel@laptop.gunduz.org><467068C7.8030209@ca.afilias.info><02ea01c7ae93$9b148fb0$c701a8c0@HP22720319231>
	<60lkeminu5.fsf@dba2.int.libertyrms.com>
Message-ID: <030001c7ae95$8d031ca0$c701a8c0@HP22720319231>

Hi.

From: "Christopher Browne" 

> Thanks for the patch; I have applied it to 1.2 and to HEAD, and added
> it to release notes.  It will be in 1.2.10.

Oh, sound good to me! Thanks:-)

Regards,
Hiroshi Saito
From cbbrowne at ca.afilias.info  Thu Jun 14 08:25:05 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Thu Jun 14 08:25:10 2007
Subject: [Slony1-general] Problem where subscription fails to start (was re:
	1.2.10 preparations)
In-Reply-To: <Pine.LNX.4.62.0706092339510.2953@mini.atlantida.localdomain>
	(Steven Singer's message of "Sun,
	10 Jun 2007 00:24:14 -0400 (EDT)")
References: <60myzaf8vg.fsf@dba2.int.libertyrms.com>
	<Pine.LNX.4.62.0706092339510.2953@mini.atlantida.localdomain>
Message-ID: <60hcpaimni.fsf_-_@dba2.int.libertyrms.com>

Steven Singer <ssinger_pg@sympatico.ca> writes:
> On Fri, 8 Jun 2007, Christopher Browne wrote:
>
> I've been trying 1.2.10 from CVS against 8.2 on a Linux PowerPC(mac) and
>
> I've been occasional failures of the testddl unit test with
>
> <stdin>:5: sleep a couple seconds
> <stdin>:9: timeout exceeded while waiting for event confirmation
>
> Which appears to be from a:wait for event (origin=1, confirmed=2);
>
> Most of the time testddl passes fine but it failed at least once when
> I tried running it. I am still trying to reproduce the failure.

I'm not entirely sure why this happens; it has occasionally happened
to me too.

In the slon logs, the slon for the subscriber node has fallen into the
following "pit":

When node #2 tries to process the subscription...

2007-06-14 15:06:21 UTC DEBUG2 remoteWorkerThread_1: Received event 1,17 ENABLE_SUBSCRIPTION
2007-06-14 15:06:21 UTC WARN   remoteWorkerThread_1: copy set: data provider 1 only on sync -1 - sleep 5 seconds

This is normally the result of node 2's slon not properly listening to
node #1.

If you restart the slon for node #2 (e.g. - kill the slon, run it
again, by hand), it picks itself up out of the "pit" and subscribes
and runs fine.

I figure there must be some race condition surrounding the events that
is taking place here...

I just ran the DDL test three times in a row; twice, it failed with
the above problem; the third time it worked.

I grabbed the logs from the three iterations, and chopped them off
immediately after the ENABLE_SUBSCRIPTION message, which is clearly
the point at which the behaviour is diverging.  I then chopped off
timestamps to make them look temporally similar, and did a sort + diff
to see what the differences look like.

Here's one of the diffs; if we can identify what it is that isn't
being processed properly in the case where it failed (which will
involve the entries marked ">"), then maybe there's a bug to be
stomped :-).

I'm seeing one oddity, that in the "succeeding" slon, the events are
associated with remoteWorkerThread_1, whereas on the other, they're on
remoteListenThread_3.

slony-regress.ks8357/slon_log.2.sorted-diff
::::::::::::::
20d19
< DEBUG1 copy_set 1
39,41c38
< DEBUG2 remoteListenThread_1: queue event 1,16 SUBSCRIBE_SET
< DEBUG2 remoteListenThread_1: queue event 1,17 ENABLE_SUBSCRIPTION
< DEBUG2 remoteListenThread_1: queue event 1,18 SYNC
---
> DEBUG2 remoteListenThread_1: queue event 1,19 SYNC
44,46d40
< DEBUG2 remoteListenThread_1: queue event 3,1 STORE_PATH
< DEBUG2 remoteListenThread_1: queue event 3,2 STORE_PATH
< DEBUG2 remoteListenThread_1: queue event 3,3 SYNC
48a43,48
> DEBUG2 remoteListenThread_3: queue event 1,16 SUBSCRIBE_SET
> DEBUG2 remoteListenThread_3: queue event 1,17 ENABLE_SUBSCRIPTION
> DEBUG2 remoteListenThread_3: queue event 1,18 SYNC
> DEBUG2 remoteListenThread_3: queue event 3,1 STORE_PATH
> DEBUG2 remoteListenThread_3: queue event 3,2 STORE_PATH
> DEBUG2 remoteListenThread_3: queue event 3,3 SYNC
50a51
> DEBUG2 remoteListenThread_3: stop listening for event origin 1
63,64d63
< DEBUG2 remoteWorkerThread_1: forward confirm 1,9 received by 3
< DEBUG2 remoteWorkerThread_1: forward confirm 2,0 received by 3
68d66
< DEBUG2 remoteWorkerThread_1: forward confirm 3,3 received by 1
74a73,76
> DEBUG2 remoteWorkerThread_3: forward confirm 1,18 received by 3
> DEBUG2 remoteWorkerThread_3: forward confirm 1,9 received by 3
> DEBUG2 remoteWorkerThread_3: forward confirm 2,0 received by 1
> DEBUG2 remoteWorkerThread_3: forward confirm 2,0 received by 3
75a78,79
> DEBUG2 remoteWorkerThread_3: forward confirm 3,0 received by 1
> DEBUG2 remoteWorkerThread_3: forward confirm 3,3 received by 1
82,83c86,87
< DEBUG2 slon: watchdog ready - pid = 8471
< DEBUG2 slon: worker process created - pid = 8473
---
> DEBUG2 slon: watchdog ready - pid = 8279
> DEBUG2 slon: worker process created - pid = 8280
84a89
> WARN   remoteWorkerThread_1: copy set: data provider 1 only on sync -1 - sleep 5 seconds

Jan just IM'ed me that he just committed a change that evidently
affects this, so this may already be fixed :-).
-- 
output = reverse("ofni.sailifa.ac" "@" "enworbbc")
<http://dba2.int.libertyrms.com/>
Christopher Browne
(416) 673-4124 (land)
From cbbrowne at ca.afilias.info  Thu Jun 14 08:40:16 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Thu Jun 14 08:40:22 2007
Subject: [Slony1-general] Readying 1.2.10
In-Reply-To: <1181829308.3230.15.camel@localhost.localdomain> (Devrim
	=?iso-8859-1?Q?G=DCND=DCZ's?= message of "Thu,
	14 Jun 2007 16:55:08 +0300")
References: <60myzaf8vg.fsf@dba2.int.libertyrms.com>
	<1181542008.13733.55.camel@laptop.gunduz.org>
	<467012EC.9060905@ca.afilias.info>
	<1181750612.2878.4.camel@laptop.gunduz.org>
	<46701B3F.4060607@ca.afilias.info>
	<1181752365.2878.11.camel@laptop.gunduz.org>
	<467068C7.8030209@ca.afilias.info>
	<1181829308.3230.15.camel@localhost.localdomain>
Message-ID: <60abv2ily7.fsf@dba2.int.libertyrms.com>

Devrim G?ND?Z <devrim@CommandPrompt.com> writes:
> Hello,
>
> On Wed, 2007-06-13 at 21:59 +0000, Christopher Browne wrote:
>
>> The URL that works:
>> <http://lists.slony.info/downloads/1.2/source/slony1-1.2.10-pre.tar.bz2>
>> 
>
> Thanks. Here are the issues that I found in the tarball:
>
> 1. .cvsignore files:
>
> ./doc/implementation/.cvsignore
> ./doc/concept/.cvsignore
> ./src/ducttape/.cvsignore
> ./src/xxid/.cvsignore
> ./src/slon/.cvsignore
> ./src/slonik/.cvsignore
> ./src/backend/.cvsignore
> ./.cvsignore

I'm inclined to add a rule to "make distclean" to clean this out.

> 2. Unneeded file in the tarball:
>
> ./.#postgresql-slony1-engine.spec.in.1.31.2.6

That seems extremely odd.

cbbrowne@dba2:/opt/OXRS/sources> tar tfvj slony1-1.2.10-pre.tar.bz2 | grep postgres
-rw-r--r-- cbbrowne/users   9151 2007-06-12 21:49 slony1-1.2.10-pre/postgresql-slony1-engine.spec.in
-rwxr-xr-x cbbrowne/users   2749 2007-06-05 18:25 slony1-1.2.10-pre/redhat/postgresql-slony1-engine.init
-rwxr-xr-x cbbrowne/users   8929 2007-06-11 05:54 slony1-1.2.10-pre/redhat/postgresql-slony1-engine.specfile
-rw-r--r-- cbbrowne/users   5518 2005-10-22 16:02 slony1-1.2.10-pre/suse/postgresql-slony1-engine.specfile
cbbrowne@dba2:/opt/OXRS/sources> 

There are all of the files in the tarball that contain the string
'postgres'; the file you're referring to isn't there at all.  That
smells like a file that CVS would leave lying around locally; could
you have extracted the sources into a not-fresh directory?

> 3. Permission issues
>
> There are various permission issues in the tarball. I have reported them
> before. Here is what I currently do in my spec file:
> chmod -R 644 doc/*
>
> I'm currently testing the tarball, will report more (if I can find
> more :) )

I'll look back at Peter Eisentraut's permission complaints, too, and
see about a "make distclean" rule to fix this.

If you see more borken permissions, I'd appreciate if you bounce them
to the list (whether -general or -bugs, I don't care); if I catch the
issues multiple times, that's not a bad thing.
-- 
(reverse (concatenate 'string "ofni.sailifa.ac" "@" "enworbbc"))
<http://dba2.int.libertyrms.com/>
Christopher Browne
(416) 673-4124 (land)
From JanWieck at Yahoo.com  Thu Jun 14 08:03:11 2007
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Thu Jun 14 14:51:01 2007
Subject: [Slony1-general] Readying 1.2.10
In-Reply-To: <Pine.LNX.4.62.0706131948100.2953@mini.atlantida.localdomain>
References: <60myzaf8vg.fsf@dba2.int.libertyrms.com>	<1181542008.13733.55.camel@laptop.gunduz.org>	<467012EC.9060905@ca.afilias.info>
	<Pine.LNX.4.62.0706131948100.2953@mini.atlantida.localdomain>
Message-ID: <467158AF.3080907@Yahoo.com>

On 6/13/2007 7:55 PM, Steven Singer wrote:
> On Wed, 13 Jun 2007, Christopher Browne wrote:
> 
> 
> I've downloaded the tarball can compiled against a 8.3 snapshot on Linux and 
> I'm still getting periodic failures of the testddl unit test.
> 
> Usually its a <stdin>:9: timeout exceeded while waiting for event confirmation

Not sure where this one is coming from. There seems to be only one case 
of using WAIT FOR EVENT in that test and that does not have a timeout (I 
must obviously be missing something).

> 
> I keep seeing messages along the line in the slon.2.log like:
> 2007-06-13 19:25:20 EDT WARN   remoteWorkerThread_1: copy set: data provider 
> 1 only on sync -1 - sleep 5 seconds
> 
> Is this the problem Jan is working on or is it something else?
> Has anyone else tried to run the testddl unit test a handful of times with 
> better luck?

I wasn't up to now ;-)

The problem here seems to be that the sl_listen is entirely messed up 
which as a side effect triggers what appears to be a bug.

Why rebuildListenEntries() generates 10 entries for a 3 node setup for 
sure needs some investigation. The real underlying problem is that slon 
at copy_set() time looks from where it got the event and if that node is 
not the one providing the data, it checks if it has seen a confirmation 
of the ENABLE_SUBSCRIPTION from the data provider. The thing here is 
that data provider is actually the event origin and nodes don't confirm 
their own events. So the check needs to exclude the case where the event 
origin is the data provider.


Jan

-- 
#======================================================================#
# It's easier to get forgiveness for being wrong than for being right. #
# Let's break this rule - forgive me.                                  #
#================================================== JanWieck@Yahoo.com #
From JanWieck at Yahoo.com  Thu Jun 14 19:00:37 2007
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Fri Jun 15 10:25:15 2007
Subject: [Slony1-general] Readying 1.2.10
In-Reply-To: <467158AF.3080907@Yahoo.com>
References: <60myzaf8vg.fsf@dba2.int.libertyrms.com>	<1181542008.13733.55.camel@laptop.gunduz.org>	<467012EC.9060905@ca.afilias.info>
	<Pine.LNX.4.62.0706131948100.2953@mini.atlantida.localdomain>
	<467158AF.3080907@Yahoo.com>
Message-ID: <4671F2C5.1040004@Yahoo.com>

On 6/14/2007 11:03 AM, Jan Wieck wrote:
> On 6/13/2007 7:55 PM, Steven Singer wrote:
>> On Wed, 13 Jun 2007, Christopher Browne wrote:
>> 
>> 
>> I've downloaded the tarball can compiled against a 8.3 snapshot on Linux and 
>> I'm still getting periodic failures of the testddl unit test.
>> 
>> Usually its a <stdin>:9: timeout exceeded while waiting for event confirmation
> 
> Not sure where this one is coming from. There seems to be only one case 
> of using WAIT FOR EVENT in that test and that does not have a timeout (I 
> must obviously be missing something).

Yepp, I was missing something. WAIT FOR EVENT has a timeout default of 
600 seconds. Which of course means that if node 3 never starts to 
subscribe because of having received the ENABLE_SUBSCRIPTION from node 2 
instead of node 1 (which depends on a race condition), then this is 
exactly what is going to happen.

I have fixed the bug in the copy_set() logic but still need to fix the 
rebuildListenEntries() madness.


Jan

> 
>> 
>> I keep seeing messages along the line in the slon.2.log like:
>> 2007-06-13 19:25:20 EDT WARN   remoteWorkerThread_1: copy set: data provider 
>> 1 only on sync -1 - sleep 5 seconds
>> 
>> Is this the problem Jan is working on or is it something else?
>> Has anyone else tried to run the testddl unit test a handful of times with 
>> better luck?
> 
> I wasn't up to now ;-)
> 
> The problem here seems to be that the sl_listen is entirely messed up 
> which as a side effect triggers what appears to be a bug.
> 
> Why rebuildListenEntries() generates 10 entries for a 3 node setup for 
> sure needs some investigation. The real underlying problem is that slon 
> at copy_set() time looks from where it got the event and if that node is 
> not the one providing the data, it checks if it has seen a confirmation 
> of the ENABLE_SUBSCRIPTION from the data provider. The thing here is 
> that data provider is actually the event origin and nodes don't confirm 
> their own events. So the check needs to exclude the case where the event 
> origin is the data provider.
> 
> 
> Jan
> 


-- 
#======================================================================#
# It's easier to get forgiveness for being wrong than for being right. #
# Let's break this rule - forgive me.                                  #
#================================================== JanWieck@Yahoo.com #
From z-saito at guitar.ocn.ne.jp  Mon Jun 18 00:15:42 2007
From: z-saito at guitar.ocn.ne.jp (Hiroshi Saito)
Date: Mon Jun 18 00:15:56 2007
Subject: [Slony1-general] Readying 1.2.10
Message-ID: <036e01c7b178$7b2a2560$c701a8c0@HP22720319231>

Hi Christopher-san.

I'm checking operation by windows by some tests. Then,  tests/run_test.sh  
is equipped now has imposed big load.... My test machine has somewhat 
few resources. Can the test be made a little lighter? 

-My test machine-:
ThinkPad i Series s30
Pentium III 600MHz
Memory 256MB
HDD-20GB

I tested the script 3 times....All were moving for 12 hours.:-(
http://winpg.jp/~saito/Slony-I-sample/slony1-1.2.10-pg8.1.9-test.txt
It may stop at diff of DB repeatedly.......
I predict that a problem is in MinGW instead of Slony.
However, I consider making the run_test.sh script light by necessity.

What do you think? Or have I missed something? 

Regards,
Hiroshi Saito



From jamiel at istreamimaging.com  Mon Jun 18 06:18:59 2007
From: jamiel at istreamimaging.com (Jeff Amiel)
Date: Mon Jun 18 06:19:13 2007
Subject: [Slony1-general] Re-sync a single node
Message-ID: <46768643.5020009@istreamimaging.com>

I have 2 nodes subscribed to a single master.
One of them had some issues at one point, and while new events appear to 
be replicating at the moment, there are somehow gaps in the dataset.

What's the easiest way to bring this rougue node back in line?
I assume there is no way to have slony 'analyze' the master node and 
generate events for the missing data from the subscriber.

Should I just unsubscribe the node, clear the data (back to the schema 
only) and then re-subscribe it?  (I shudder to think how long that might 
take).
Is that the right approach or is their a special slony/slon 
function/script I should be using to 're-synch' a node?

Thanks in advance.





From ajs at crankycanuck.ca  Mon Jun 18 07:32:38 2007
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Mon Jun 18 07:32:57 2007
Subject: [Slony1-general] Re-sync a single node
In-Reply-To: <46768643.5020009@istreamimaging.com>
References: <46768643.5020009@istreamimaging.com>
Message-ID: <20070618143238.GD15962@phlogiston.dyndns.org>

On Mon, Jun 18, 2007 at 08:18:59AM -0500, Jeff Amiel wrote:
> I have 2 nodes subscribed to a single master.
> One of them had some issues at one point, and while new events appear to 
> be replicating at the moment, there are somehow gaps in the dataset.

The situation you describe should be _impossible_.  If it has
happened, we sure want to know why.  Did you do anything else during
these issues?  What were the issues anyway?

> Should I just unsubscribe the node, clear the data (back to the schema 
> only) and then re-subscribe it?  (I shudder to think how long that might 
> take).

I'm afraid that's the only thing to do, yes.  If some sets were lost,
then there's effectively no way to know what's good and bad on the
replica.  It'd be cheaper just to rebuild it than to try to compare
everything.

A

-- 
Andrew Sullivan  | ajs@crankycanuck.ca
In the future this spectacle of the middle classes shocking the avant-
garde will probably become the textbook definition of Postmodernism. 
                --Brad Holland
From jamiel at istreamimaging.com  Mon Jun 18 08:14:16 2007
From: jamiel at istreamimaging.com (Jeff Amiel)
Date: Mon Jun 18 08:14:28 2007
Subject: [Slony1-general] Re-sync a single node
In-Reply-To: <20070618143238.GD15962@phlogiston.dyndns.org>
References: <46768643.5020009@istreamimaging.com>
	<20070618143238.GD15962@phlogiston.dyndns.org>
Message-ID: <4676A148.60807@istreamimaging.com>


Andrew Sullivan wrote:
> On Mon, Jun 18, 2007 at 08:18:59AM -0500, Jeff Amiel wrote:
>   =

>> I have 2 nodes subscribed to a single master.
>> One of them had some issues at one point, and while new events appear to =

>> be replicating at the moment, there are somehow gaps in the dataset.
>>     =

>
> The situation you describe should be _impossible_.  If it has
> happened, we sure want to know why.  Did you do anything else during
> these issues?  What were the issues anyway?
>   =

I would agree...but I am sure this is MY fault either through neglect =

(old slony version slony1-1.1.5_1  ) or blatent mis-use  (I was in a =

particularly harried state at the time)

Back then this started, had an issue with the site hosting the second =

subscriber node (couldn't access it) ....and every 30 minutes or so, the =

master node slony would crash/restart because it couldn't communicate =

with the subscriber node...which was no good (old version of slony =

probably didn't help here)
I removed the node from replication (but I don't remember how...either =

by dropping the node (via the "Replication' item in pgadmin) or some =

other means)  Once our remote site access was restored, I re-added the =

node (via slon script to set up the subscriptions properly).  I remember =

this being only a few hours later.  I apparently didn't check to see if =

it was properly replicating.

On this part Friday, however, we noticed that it appeared that =

replication to the DR site was not occurring at all (and probably hadn't =

been since the incident)....and realized that the sl_node table had =

no_active set to 'false' for that node.  I then used a couple of slony =

functions to re-enable the node....and replication begin again.

I know I made mistakes here....and having a concrete course of action to =

take a node offline and bring it back online would be helpful.  What IS =

the proper way to temporarily drop a node and then re-enable it later?



Jeff
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070618/=
639c4d02/attachment.htm
From ajs at crankycanuck.ca  Mon Jun 18 09:37:45 2007
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Mon Jun 18 09:38:05 2007
Subject: [Slony1-general] Re-sync a single node
In-Reply-To: <4676A148.60807@istreamimaging.com>
References: <46768643.5020009@istreamimaging.com>
	<20070618143238.GD15962@phlogiston.dyndns.org>
	<4676A148.60807@istreamimaging.com>
Message-ID: <20070618163745.GL15962@phlogiston.dyndns.org>

On Mon, Jun 18, 2007 at 10:14:16AM -0500, Jeff Amiel wrote:

> I removed the node from replication (but I don't remember how...either 
> by dropping the node (via the "Replication' item in pgadmin) or some 
> other means)  Once our remote site access was restored, I re-added the 
> node (via slon script to set up the subscriptions properly).  I remember 
> this being only a few hours later.  I apparently didn't check to see if 
> it was properly replicating.

Well, if you unsubscribed and then later resubscribed, AFAIK the
whole dump-restore business would have happened, so you wouldn't be
missing anything.  So I have a feeling. . .

> no_active set to 'false' for that node.  I then used a couple of slony 
> functions to re-enable the node....and replication begin again.

. . .that when you did this you re-enabled the subscription of
someone who had been completely unsubscribed on the origin.  Or
something.  Remember, you have to run these functions on both ends of
the connection.  Perhaps your origin still actually has the data
destined for that node (but I doubt it, or else you wouldn't have a
gap, since it'd all get applied in order).

> take a node offline and bring it back online would be helpful.  What IS 
> the proper way to temporarily drop a node and then re-enable it later?

Stop the slon.  That's what sends the data.  The data will just build
up at the origin, and all get applied when it's time to do so.

A

-- 
Andrew Sullivan  | ajs@crankycanuck.ca
Unfortunately reformatting the Internet is a little more painful 
than reformatting your hard drive when it gets out of whack.
		--Scott Morris
From csar at 123.com.sv  Mon Jun 18 11:19:07 2007
From: csar at 123.com.sv (=?ISO-8859-1?Q?C=E9sar_Amaya?=)
Date: Mon Jun 18 11:13:42 2007
Subject: [Slony1-general] slony log rotate
Message-ID: <4676CC9B.7010808@123.com.sv>

Hi guys!!! I?m newbie in Slony. I was wandering if is good idea rotate 
slony logs with another tool different from Apache?s rotatelogs. I plan 
to use logrotate.

Can anyone give some light here please.

Thanks guys!!!
From vivek at khera.org  Mon Jun 18 11:40:13 2007
From: vivek at khera.org (Vivek Khera)
Date: Mon Jun 18 11:40:25 2007
Subject: [Slony1-general] Re-sync a single node
In-Reply-To: <20070618143238.GD15962@phlogiston.dyndns.org>
References: <46768643.5020009@istreamimaging.com>
	<20070618143238.GD15962@phlogiston.dyndns.org>
Message-ID: <3FAB915D-E38A-4855-AB85-03E033FEC91D@khera.org>


On Jun 18, 2007, at 10:32 AM, Andrew Sullivan wrote:

> The situation you describe should be _impossible_.  If it has
> happened, we sure want to know why.  Did you do anything else during
> these issues?  What were the issues anyway?

I had similar happen with a hardware failure -- one of the disks on  
the RAID was reporing bad sectors (now, why wouldn't the idiotic  
Adaptec RAID hardware controller remap them automagically and just  
keep on chugging along?!?!?!?!?!!?!?!?!?1111111).  I ended up with  
duplicate rows of the same PK on some table.

I had to rebuild the whole node from scratch, since I couldn't prove  
the data was identical to the origin, and it changes so fast.
From bwillits at cox.net  Mon Jun 18 11:46:02 2007
From: bwillits at cox.net (Bill Willits)
Date: Mon Jun 18 11:46:18 2007
Subject: [Slony1-general] slony log rotate
References: <4676CC9B.7010808@123.com.sv>
Message-ID: <00fd01c7b1d8$ec30ec70$b601a8c0@bwlaptop>

Yes, logrotate will work fine.  Make sure to use the 'copytruncate' option

~Bill Willits

----- Original Message ----- 
From: "C?sar Amaya" <csar@123.com.sv>
To: <slony1-general@lists.slony.info>
Sent: Monday, June 18, 2007 11:19 AM
Subject: [Slony1-general] slony log rotate


Hi guys!!! I?m newbie in Slony. I was wandering if is good idea rotate
slony logs with another tool different from Apache?s rotatelogs. I plan
to use logrotate.

Can anyone give some light here please.

Thanks guys!!!
_______________________________________________
Slony1-general mailing list
Slony1-general@lists.slony.info
http://lists.slony.info/mailman/listinfo/slony1-general 

From andrew.george.hammond at gmail.com  Mon Jun 18 12:05:37 2007
From: andrew.george.hammond at gmail.com (Andrew Hammond)
Date: Mon Jun 18 12:05:44 2007
Subject: [Slony1-general] slony log rotate
In-Reply-To: <00fd01c7b1d8$ec30ec70$b601a8c0@bwlaptop>
References: <4676CC9B.7010808@123.com.sv>
	<00fd01c7b1d8$ec30ec70$b601a8c0@bwlaptop>
Message-ID: <5a0a9d6f0706181205p5617f258i8ea54feee56d78c@mail.gmail.com>

There are plenty of options for handling log rotation. Apache's
rotatelogs works well. Personally I use DJB's multilog (as part of a
daemontools approach). If you're interested in using daemontools,
check out the tools/slon-mkservice.sh script (currently only in CVS /
the 1.2.10 pre-release tarballs).

If you're already using logrotate, then I guess I could see sticking
with it. I don't see any good reason to pick it over the alternatives
for a first install though. I think that any solution that requires
copytruncate is poorly conceived, since the algorithm wastes IO. If
you must use logrotate, I'd consider simply killing and restarting the
slon as part of your rotation process.

Andrew


On 6/18/07, Bill Willits <bwillits@cox.net> wrote:
> Yes, logrotate will work fine.  Make sure to use the 'copytruncate' option
>
> ~Bill Willits
>
> ----- Original Message -----
> From: "C?sar Amaya" <csar@123.com.sv>
> To: <slony1-general@lists.slony.info>
> Sent: Monday, June 18, 2007 11:19 AM
> Subject: [Slony1-general] slony log rotate
>
>
> Hi guys!!! I?m newbie in Slony. I was wandering if is good idea rotate
> slony logs with another tool different from Apache?s rotatelogs. I plan
> to use logrotate.
>
> Can anyone give some light here please.
>
> Thanks guys!!!
> _______________________________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
>
> _______________________________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
>
From ajs at crankycanuck.ca  Mon Jun 18 12:41:24 2007
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Mon Jun 18 12:41:48 2007
Subject: [Slony1-general] Re-sync a single node
In-Reply-To: <3FAB915D-E38A-4855-AB85-03E033FEC91D@khera.org>
References: <46768643.5020009@istreamimaging.com>
	<20070618143238.GD15962@phlogiston.dyndns.org>
	<3FAB915D-E38A-4855-AB85-03E033FEC91D@khera.org>
Message-ID: <20070618194124.GM16665@phlogiston.dyndns.org>

On Mon, Jun 18, 2007 at 02:40:13PM -0400, Vivek Khera wrote:
> the RAID was reporing bad sectors (now, why wouldn't the idiotic  
> Adaptec RAID hardware controller remap them automagically and just  
> keep on chugging along?!?!?!?!?!!?!?!?!?1111111).  I ended up with  

I thought that's what RAID was for?  Sigh.  So, ok, it shouldn't be
possible without additional breakage.

Anyway, in such cases, you still just have to rebuild.  There'd be no
way for us to rebuild partially, because how would we know what parts
to rebuild?  (If we knew it was breaking all along, we woulda caught
the error.  Not for us this thing "oh, we know that breaks sometimes. 
Run this cleanup command from cron nightly." ;-)

A

-- 
Andrew Sullivan  | ajs@crankycanuck.ca
Unfortunately reformatting the Internet is a little more painful 
than reformatting your hard drive when it gets out of whack.
		--Scott Morris
From csar at 123.com.sv  Mon Jun 18 13:43:15 2007
From: csar at 123.com.sv (=?ISO-8859-1?Q?C=E9sar_Amaya?=)
Date: Mon Jun 18 13:36:20 2007
Subject: [Slony1-general] slony log rotate
In-Reply-To: <5a0a9d6f0706181205p5617f258i8ea54feee56d78c@mail.gmail.com>
References: <4676CC9B.7010808@123.com.sv>	
	<00fd01c7b1d8$ec30ec70$b601a8c0@bwlaptop>
	<5a0a9d6f0706181205p5617f258i8ea54feee56d78c@mail.gmail.com>
Message-ID: <4676EE63.8020704@123.com.sv>

Andrew Hammond wrote:
> There are plenty of options for handling log rotation. Apache's
> rotatelogs works well. Personally I use DJB's multilog (as part of a
> daemontools approach). If you're interested in using daemontools,
> check out the tools/slon-mkservice.sh script (currently only in CVS /
> the 1.2.10 pre-release tarballs).
>
> If you're already using logrotate, then I guess I could see sticking
> with it. I don't see any good reason to pick it over the alternatives
> for a first install though. I think that any solution that requires
> copytruncate is poorly conceived, since the algorithm wastes IO. If
> you must use logrotate, I'd consider simply killing and restarting the
> slon as part of your rotation process.
>
> Andrew
>
>
> On 6/18/07, Bill Willits <bwillits@cox.net> wrote:
>> Yes, logrotate will work fine.  Make sure to use the 'copytruncate' 
>> option
>>
>> ~Bill Willits
>>
>> ----- Original Message -----
>> From: "C?sar Amaya" <csar@123.com.sv>
>> To: <slony1-general@lists.slony.info>
>> Sent: Monday, June 18, 2007 11:19 AM
>> Subject: [Slony1-general] slony log rotate
>>
>>
>> Hi guys!!! I?m newbie in Slony. I was wandering if is good idea rotate
>> slony logs with another tool different from Apache?s rotatelogs. I plan
>> to use logrotate.
>>
>> Can anyone give some light here please.
>>
>> Thanks guys!!!
>> _______________________________________________
>> Slony1-general mailing list
>> Slony1-general@lists.slony.info
>> http://lists.slony.info/mailman/listinfo/slony1-general
>>
>> _______________________________________________
>> Slony1-general mailing list
>> Slony1-general@lists.slony.info
>> http://lists.slony.info/mailman/listinfo/slony1-general
>>
>
Could you send me an example of your configurations files?

Regards!!
From andrew.george.hammond at gmail.com  Mon Jun 18 14:38:46 2007
From: andrew.george.hammond at gmail.com (Andrew Hammond)
Date: Mon Jun 18 14:38:55 2007
Subject: [Slony1-general] slony log rotate
In-Reply-To: <4676EE63.8020704@123.com.sv>
References: <4676CC9B.7010808@123.com.sv>
	<00fd01c7b1d8$ec30ec70$b601a8c0@bwlaptop>
	<5a0a9d6f0706181205p5617f258i8ea54feee56d78c@mail.gmail.com>
	<4676EE63.8020704@123.com.sv>
Message-ID: <5a0a9d6f0706181438y67a86feft898659abbb05377e@mail.gmail.com>

On 6/18/07, C?sar Amaya <csar@123.com.sv> wrote:
> Andrew Hammond wrote:
> > There are plenty of options for handling log rotation. Apache's
> > rotatelogs works well. Personally I use DJB's multilog (as part of a
> > daemontools approach). If you're interested in using daemontools,
> > check out the tools/slon-mkservice.sh script (currently only in CVS /
> > the 1.2.10 pre-release tarballs).
> >
> > If you're already using logrotate, then I guess I could see sticking
> > with it. I don't see any good reason to pick it over the alternatives
> > for a first install though. I think that any solution that requires
> > copytruncate is poorly conceived, since the algorithm wastes IO. If
> > you must use logrotate, I'd consider simply killing and restarting the
> > slon as part of your rotation process.
> >
> > Andrew
> >
> >
> > On 6/18/07, Bill Willits <bwillits@cox.net> wrote:
> >> Yes, logrotate will work fine.  Make sure to use the 'copytruncate'
> >> option
> >>
> >> ~Bill Willits
> >>
> >> ----- Original Message -----
> >> From: "C?sar Amaya" <csar@123.com.sv>
> >> To: <slony1-general@lists.slony.info>
> >> Sent: Monday, June 18, 2007 11:19 AM
> >> Subject: [Slony1-general] slony log rotate
> >>
> >>
> >> Hi guys!!! I?m newbie in Slony. I was wandering if is good idea rotate
> >> slony logs with another tool different from Apache?s rotatelogs. I plan
> >> to use logrotate.
> >>
> >> Can anyone give some light here please.
> >>
> >> Thanks guys!!!
> >> _______________________________________________
> >> Slony1-general mailing list
> >> Slony1-general@lists.slony.info
> >> http://lists.slony.info/mailman/listinfo/slony1-general
> >>
> >> _______________________________________________
> >> Slony1-general mailing list
> >> Slony1-general@lists.slony.info
> >> http://lists.slony.info/mailman/listinfo/slony1-general
> >>
> >
> Could you send me an example of your configurations files?

slon-mkservice.sh writes the configuration files for you. I've written
some documentation for it, and the defaults are, I think, reasonable
(at least on FreeBSD). Please try it out and let me know if you have
questions so I can improve the documentation.

Andrew
From vivek at khera.org  Tue Jun 19 10:47:51 2007
From: vivek at khera.org (Vivek Khera)
Date: Tue Jun 19 10:47:59 2007
Subject: [Slony1-general] Re-sync a single node
In-Reply-To: <20070618194124.GM16665@phlogiston.dyndns.org>
References: <46768643.5020009@istreamimaging.com>
	<20070618143238.GD15962@phlogiston.dyndns.org>
	<3FAB915D-E38A-4855-AB85-03E033FEC91D@khera.org>
	<20070618194124.GM16665@phlogiston.dyndns.org>
Message-ID: <09EE88C0-4FDD-4719-BA8D-300040B5C050@khera.org>


On Jun 18, 2007, at 3:41 PM, Andrew Sullivan wrote:

> On Mon, Jun 18, 2007 at 02:40:13PM -0400, Vivek Khera wrote:
>> the RAID was reporing bad sectors (now, why wouldn't the idiotic
>> Adaptec RAID hardware controller remap them automagically and just
>> keep on chugging along?!?!?!?!?!!?!?!?!?1111111).  I ended up with
>
> I thought that's what RAID was for?  Sigh.  So, ok, it shouldn't be
> possible without additional breakage.

Put it this way: Adaptec is no longer on my list of approved RAID  
vendors. ;-(


From tamba.tahir at courrier.uqam.ca  Tue Jun 19 12:21:08 2007
From: tamba.tahir at courrier.uqam.ca (Tahir Tamba)
Date: Tue Jun 19 12:25:30 2007
Subject: [Slony1-general] Slony1 error message issue
Message-ID: <b55f196e2eb4.4677f464@courrier.uqam.ca>

An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070619/0455f5ca/attachment.htm
-------------- next part --------------
A non-text attachment was scrubbed...
Name: tamba.tahir.vcf
Type: text/x-vcard
Size: 226 bytes
Desc: Card for Tahir Tamba <tamba.tahir@courrier.uqam.ca>
Url : http://lists.slony.info/pipermail/slony1-general/attachments/20070619/0455f5ca/tamba.tahir.vcf
From cbbrowne at ca.afilias.info  Tue Jun 19 13:44:11 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Tue Jun 19 13:44:22 2007
Subject: [Slony1-general] Increasing automation of running Slony-I tests
Message-ID: <60myyvd690.fsf@dba2.int.libertyrms.com>

Aside: Good news!  Jan committed a change to log shipping code that is
successfully handling my (fairly pathological!) test case in
tests/testlogship.  So I'm running regression tests of the 1.2 branch
against the various supported PostgreSQL versions in preparation for
letting out a pre-1.2.10-#2 tarball, preparatory to letting 1.2.10 out
into the wild hopefully later this week.

I have run thru all the tests on PG 8.3 (beta), and am currently
working on 7.4...

But I'm now realizing that these tests don't collect results in any
particularly easily, well, collectible fashion.

I'm thinking that the Right Answer is probably to add some functions
to tests/support_funcs.sh that collect data about each test and then
stow it [somewhere].  I figure I'd better do some brainstorming as to
what data we ought to look for, and perhaps how we ought to collect
it.

Things we obviously need to capture:

- when did the test run?  (grab UNIX timestamp - `date`)
- what version of Slony-I?  (select version info)
- what version of PostgreSQL?  (select version info)
- what platform?  (grab `uname` and `uname -a` to get less and more detail)
- which test?
- test start time, end time (`date` captured twice)
- user info (whoami)
- probably ought to do some summary query about the summary data
- test status (success, failure, maybe what it failed on)

This information ought to get stowed [somewhere] in machine parsable
form.  Indeed, I imagine it might be a good idea to have it as some
set of SQL statements so that we could more or less blindly load it
into a database with a particular schema.

Should we pass in an environment variable to indicate a file to
populate with SQL statements?  Or perhaps a directory?

Do we need some GUID-like identifier for each test?  That might make a
good filename to stow some SQL statements in...

Am I missing things?

I'm sort of brain-dumping the obvious questions that are coming to
mind; am I missing any obvious things?
-- 
let name="cbbrowne" and tld="ca.afilias.info" in String.concat "@" [name;tld];;
<http://dba2.int.libertyrms.com/>
Christopher Browne
(416) 673-4124 (land)
From z-saito at guitar.ocn.ne.jp  Tue Jun 19 18:01:25 2007
From: z-saito at guitar.ocn.ne.jp (Hiroshi Saito)
Date: Tue Jun 19 18:01:25 2007
Subject: [Slony1-general] Slony1 error message issue
References: <b55f196e2eb4.4677f464@courrier.uqam.ca>
Message-ID: <010101c7b2d6$86dfae20$c701a8c0@HP22720319231>

Hi.

Umm,  What situation's is the problem message?
Could registration do slevent.exe in regsvr32.exe?

Regards,
Hiroshi Saito

----- Original Message ----- 
From: Tahir Tamba
To: slony1-general@lists.slony.info
Sent: Wednesday, June 20, 2007 4:21 AM
Subject: [Slony1-general] Slony1 error message issue


Hi all,
I'm trying to istall Slony1 Version 1.2.9 on Windows XP Pro and I get the following error 
message: "Could notr set the eventy message file". I'm using PostgreSQL 8.2.4

Tahir Tamba
MSc. G?ographie
Am?nagement du territoire et SIG/ Gestion et conservation des ressources naturelles
T?l?d?tection-cartographie ?cologique, caract?risation des milieux humides
Tel: (514) 526-7543
Courriel: tamba.tahir@courrier.uqam.ca
--------------------------------------------------------- 
Tahir Tamba
MSc. Geography
Urban planning and GIS specialist/Natural resources management and conservation
Remote-sensing-ecological mapping and wetland monitoring and Characterization
Tel: (514) 526-7543
E-mail: tamba.tahir@courrier.uqam.ca

From jamiel at istreamimaging.com  Wed Jun 20 06:59:35 2007
From: jamiel at istreamimaging.com (Jeff Amiel)
Date: Wed Jun 20 06:59:48 2007
Subject: [Slony1-general] new subscriber node...indexes much smaller
Message-ID: <467932C7.1040007@istreamimaging.com>

Just added a new subscriber node to my slony replication instance.....
while all the data is now synched, I was surprised to find my subscriber 
database utilizing significantly less space than the master node.

In researching (I just assumed I had forgotten to subscribe a specific 
set or had neglected a particular table) I found that the tables 
themselves were nearly identical in size.....but the indexes in some 
cases were significantly different (in one case, the master node disk 
size for index for a specific table was 6 gigabytes...on the subscriber 
node, it was only 1 gig).

I would have understood if the tables themselves were smaller (dead 
tuples in the master node causing bloat)......but in the indexes?
I run autovacuum on the master node...and I assume it is doing it's 
job......

I am assuming that  empty index entries are not reused and that only a 
re-index on the indexes (on the master node) will recreate (and 
shrink)....but this requires a lock on the entire index, correct?

These are all btree indexes (under postgresql v 8.1X).
 




From ajs at crankycanuck.ca  Wed Jun 20 07:28:13 2007
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Wed Jun 20 07:28:34 2007
Subject: [Slony1-general] new subscriber node...indexes much smaller
In-Reply-To: <467932C7.1040007@istreamimaging.com>
References: <467932C7.1040007@istreamimaging.com>
Message-ID: <20070620142813.GM31426@phlogiston.dyndns.org>

On Wed, Jun 20, 2007 at 08:59:35AM -0500, Jeff Amiel wrote:
> themselves were nearly identical in size.....but the indexes in some 
> cases were significantly different (in one case, the master node disk 
> size for index for a specific table was 6 gigabytes...on the subscriber 
> node, it was only 1 gig).

There remain some cases where indexes don't get compacted
appropriately.  I believe that some of this is addressed in 8.2 and
yet some more in 8.3.

> I am assuming that  empty index entries are not reused and that only a 
> re-index on the indexes (on the master node) will recreate (and 
> shrink)....but this requires a lock on the entire index, correct?

Right.  In later versions than 8.1, you can do indexing on the side,
which is incredibly cool and would solve your problem.  But it won't
help you in this case.  It isn't an exclusive lock -- you can read --
but it does block writes.

A

-- 
Andrew Sullivan  | ajs@crankycanuck.ca
However important originality may be in some fields, restraint and 
adherence to procedure emerge as the more significant virtues in a 
great many others.   --Alain de Botton
From mark at mitsein.net  Wed Jun 20 08:21:35 2007
From: mark at mitsein.net (Mark)
Date: Wed Jun 20 08:21:41 2007
Subject: [Slony1-general] rollbacks
Message-ID: <1dab01330706200821r74fe3621v565378d969dd688f@mail.gmail.com>

Is it normal to have rollbacks going pretty often?
Jun 20 11:18:01 sourceforge postgres[22285]: [3591365-2]
"_status_reportscluster".sl_action_seq;
Jun 20 11:18:01 sourceforge postgres[22294]: [4019490] LOG:  query:
rollback transaction;
Jun 20 11:18:01 sourceforge postgres[22285]: [3591366] LOG:  duration:
0.000318 sec
Jun 20 11:18:01 sourceforge postgres[22285]: [3591367] LOG:  query:
rollback transaction;
Jun 20 11:18:01 sourceforge postgres[22294]: [4019491] LOG:  duration:
0.000222 sec
Jun 20 11:18:01 sourceforge postgres[22285]: [3591368] LOG:  duration:
0.000209 sec


-- 
Mark
"Blessed is he who finds happiness in his own foolishness, for he will
always be happy."
From cbbrowne at ca.afilias.info  Wed Jun 20 08:34:01 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Wed Jun 20 08:34:11 2007
Subject: [Slony1-general] rollbacks
In-Reply-To: <1dab01330706200821r74fe3621v565378d969dd688f@mail.gmail.com>
References: <1dab01330706200821r74fe3621v565378d969dd688f@mail.gmail.com>
Message-ID: <467948E9.7000106@ca.afilias.info>

Mark wrote:
> Is it normal to have rollbacks going pretty often?
> Jun 20 11:18:01 sourceforge postgres[22285]: [3591365-2]
> "_status_reportscluster".sl_action_seq;
> Jun 20 11:18:01 sourceforge postgres[22294]: [4019490] LOG:  query:
> rollback transaction;
> Jun 20 11:18:01 sourceforge postgres[22285]: [3591366] LOG:  duration:
> 0.000318 sec
> Jun 20 11:18:01 sourceforge postgres[22285]: [3591367] LOG:  query:
> rollback transaction;
> Jun 20 11:18:01 sourceforge postgres[22294]: [4019491] LOG:  duration:
> 0.000222 sec
> Jun 20 11:18:01 sourceforge postgres[22285]: [3591368] LOG:  duration:
> 0.000209 sec
>
>
Absolutely.  There's a ROLLBACK for the read transaction each and every
SYNC that gets processed.
From cbbrowne at ca.afilias.info  Thu Jun 21 12:58:47 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Thu Jun 21 12:58:59 2007
Subject: [Slony1-general] Automating Testing - SQL Data Collection
Message-ID: <604pl16pvs.fsf@dba2.int.libertyrms.com>

Earlier in the week, I sent out a message suggesting that we should
try to come up with a more automated way of collecting test results
from Slony-I testing.

I did a bit of rummaging around to see what the BuildFarm does; here's
a (perhaps overly flat) schema that captures all of what has come to
mind thus far.

-----------------------------------------------------------------------------
create table slony_tests (
  id serial,

  -- Preface with a whole bunch of versioning information
  smoduleversion text NOT NULL,    -- populate via @NAMESPACE@.getModuleversion();
  sv_major integer NOT NULL,       -- populate via @NAMESPACE@.slonyVersionMajor();
  sv_minor integer NOT NULL,       -- populate via @NAMESPACE@.slonyVersionMinor();
  sv_patch integer NOT NULL,       -- populate via @NAMESPACE@.slonyVersionPatchlevel();

  pg_version text NOT NULL,        -- populate via version();

  uname_m text NOT NULL,             -- output of `uname -m` - uname -m = ia64
  uname_r text NOT NULL,             -- output of `uname -r` - uname -r = 2.6.18.6
  uname_s text NOT NULL,             -- output of `uname -s` - uname -s = Linux
  uname_v text NOT NULL,             -- output of `uname -v` - uname -v = #1 SMP Fri Feb 9 20:10:44 MSK 2007

  hostname text NOT NULL,          -- output of `hostname -f`
  username text NOT NULL,          -- output of `whoami`

  tester_identity text NOT NULL,   -- email address of the tester, from getenv("SLONYTESTER")

  -- Now, test-specific data
  testname text NOT NULL,          -- which test was run?
  start_time timestamptz NOT NULL,
  end_time timestamptz NOT NULL,

  successful boolean NOT NULL,     -- was the test totally successful?
  failure_desc text,               -- A description of the failure noticed
  
  primary key(id)
);

create index st_slversion on slony_tests (sv_major, sv_minor, sv_patch);
create index st_host on slony_tests(tester_identity);
create index st_start on slony_tests(start_time);
-----------------------------------------------------------------------------
-- 
"cbbrowne","@","ca.afilias.info"
<http://dba2.int.libertyrms.com/>
Christopher Browne
(416) 673-4124 (land)
From cbbrowne at ca.afilias.info  Thu Jun 21 15:18:30 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Thu Jun 21 15:18:40 2007
Subject: [Slony1-general] Tarball for 1.2.10-pre2 released
Message-ID: <60vedh54uh.fsf@dba2.int.libertyrms.com>

I have uploaded a tarball for 1.2.10 based on the fixes that have come
in this week to fix log shipping problems.

I have run tests of this build on Debian/Unstable on the IA-32
architecture against each of PostgreSQL 7.4, 8.0, 8.1, 8.2, and a
recent copy of CVS HEAD (e.g. - 8.3).

Indeed, my tests were thus...

For each build:

for test in test1  testdatestyles testddl testinherit testlargetuples testlogship testmultiplemoves testschemanames testseqnames testtabnames testutf8 ; do
./run_test.sh $test
done

If there are no negative reports about it, I anticipate that a
checkout insignificantly different from this will become the 1.2.10
release later this week.

Please do not release binaries based on this tarball; that could lead
to the regrettable situation of people downloading something that
isn't the true final release of 1.2.10.  The license permits such
things, but please wait until we call this final...
-- 
select 'cbbrowne' || '@' || 'ca.afilias.info';
<http://dba2.int.libertyrms.com/>
Christopher Browne
(416) 673-4124 (land)
From devrim at CommandPrompt.com  Thu Jun 21 15:26:48 2007
From: devrim at CommandPrompt.com (Devrim =?ISO-8859-1?Q?G=DCND=DCZ?=)
Date: Thu Jun 21 15:28:54 2007
Subject: [Slony1-general] Tarball for 1.2.10-pre2 released
In-Reply-To: <60vedh54uh.fsf@dba2.int.libertyrms.com>
References: <60vedh54uh.fsf@dba2.int.libertyrms.com>
Message-ID: <1182464808.13300.6.camel@laptop.gunduz.org>

SGksCgpPbiBUaHUsIDIwMDctMDYtMjEgYXQgMTg6MTggLTA0MDAsIENocmlzdG9waGVyIEJyb3du
ZSB3cm90ZToKCj4gSSBoYXZlIHVwbG9hZGVkIGEgdGFyYmFsbCBmb3IgMS4yLjEwIAoKR3JlYXQu
IEknbGwgdGVzdCBpdCB0b21vcnJvdyBtb3JuaW5nLi4uCgpSZWdhcmRzLAotLSAKRGV2cmltIEfD
nE5Ew5xaClBvc3RncmVTUUwgUmVwbGljYXRpb24sIENvbnN1bHRpbmcsIEN1c3RvbSBEZXZlbG9w
bWVudCwgMjR4NyBzdXBwb3J0Ck1hbmFnZWQgU2VydmljZXMsIFNoYXJlZCBhbmQgRGVkaWNhdGVk
IEhvc3RpbmcKQ28tQXV0aG9yczogcGxQSFAsIE9EQkNuZyAtIGh0dHA6Ly93d3cuY29tbWFuZHBy
b21wdC5jb20vCgoKLS0tLS0tLS0tLS0tLS0gbmV4dCBwYXJ0IC0tLS0tLS0tLS0tLS0tCkEgbm9u
LXRleHQgYXR0YWNobWVudCB3YXMgc2NydWJiZWQuLi4KTmFtZTogbm90IGF2YWlsYWJsZQpUeXBl
OiBhcHBsaWNhdGlvbi9wZ3Atc2lnbmF0dXJlClNpemU6IDE4OSBieXRlcwpEZXNjOiBUaGlzIGlz
IGEgZGlnaXRhbGx5IHNpZ25lZCBtZXNzYWdlIHBhcnQKVXJsIDogaHR0cDovL2xpc3RzLnNsb255
LmluZm8vcGlwZXJtYWlsL3Nsb255MS1nZW5lcmFsL2F0dGFjaG1lbnRzLzIwMDcwNjIyLzkxZTI0
MzY4L2F0dGFjaG1lbnQucGdwCg==
From z-saito at guitar.ocn.ne.jp  Thu Jun 21 20:24:00 2007
From: z-saito at guitar.ocn.ne.jp (Hiroshi Saito)
Date: Thu Jun 21 20:24:01 2007
Subject: [Slony1-general] Tarball for 1.2.10-pre2 released
References: <60vedh54uh.fsf@dba2.int.libertyrms.com>
Message-ID: <01c801c7b47c$c66e24c0$c701a8c0@HP22720319231>

Hi.

In the MinGW environment of Windows,
http://winpg.jp/~saito/Slony-I-sample/slony1-1.2.10-pg8.1.9-test.txt
It looks good wonderfully. seems it was ready.:-)

Thanks!!

Regards,
Hiroshi Saito

----- Original Message ----- 
From: "Christopher Browne"

>I have uploaded a tarball for 1.2.10 based on the fixes that have come
> in this week to fix log shipping problems.
>
> I have run tests of this build on Debian/Unstable on the IA-32
> architecture against each of PostgreSQL 7.4, 8.0, 8.1, 8.2, and a
> recent copy of CVS HEAD (e.g. - 8.3).
>
> Indeed, my tests were thus...
>
> For each build:
>
> for test in test1  testdatestyles testddl testinherit testlargetuples testlogship 
> testmultiplemoves testschemanames testseqnames testtabnames testutf8 ; do
> ./run_test.sh $test
> done
>
> If there are no negative reports about it, I anticipate that a
> checkout insignificantly different from this will become the 1.2.10
> release later this week.
>
> Please do not release binaries based on this tarball; that could lead
> to the regrettable situation of people downloading something that
> isn't the true final release of 1.2.10.  The license permits such
> things, but please wait until we call this final...
> -- 
> select 'cbbrowne' || '@' || 'ca.afilias.info';
> <http://dba2.int.libertyrms.com/>
> Christopher Browne
> (416) 673-4124 (land)
> _______________________________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general 

From craig_james at emolecules.com  Fri Jun 22 11:26:49 2007
From: craig_james at emolecules.com (Craig James)
Date: Fri Jun 22 11:22:51 2007
Subject: [Slony1-general] Is "Node 1" special? Failover and Switchover
Message-ID: <467C1469.2070201@emolecules.com>

When you create a cluster, it appears that "Node 1" is special -- there doesn't seem to be a "store node 1" command to create "node 1" in the first place, whereas for subsequent nodes, you have to issue "store node N".  Now, suppose node 1 happens to crash and burn, and I use "failover" to make Node 2 the master.  Questions:

Does Node 2 stay node 2, or does it become node 1?  (I'm pretty sure it stays node 2, but I want to be certain).

If I get node 1's server back online, discard its database, and recreate the schema, can I use add it to the cluster as "node 1" again, or do I need to pick a different node number?

Thanks,
Craig

From wmoran at collaborativefusion.com  Fri Jun 22 11:29:13 2007
From: wmoran at collaborativefusion.com (Bill Moran)
Date: Fri Jun 22 11:29:23 2007
Subject: [Slony1-general] Is "Node 1" special? Failover and Switchover
In-Reply-To: <467C1469.2070201@emolecules.com>
References: <467C1469.2070201@emolecules.com>
Message-ID: <20070622142913.47bd37f0.wmoran@collaborativefusion.com>

In response to Craig James <craig_james@emolecules.com>:

> When you create a cluster, it appears that "Node 1" is special

It isn't.  Sure seems that way, though, doesn't it.  We went round and
round with this.  One thing that creates this illusion is the fact that
many commands assume that node 1 is the master if you don't specify
otherwise.

> -- there
> doesn't seem to be a "store node 1" command to create "node 1" in the
> first place, whereas for subsequent nodes, you have to issue "store node
> N".  Now, suppose node 1 happens to crash and burn, and I use "failover"
> to make Node 2 the master.  Questions:

The first node has an implied "store node" so that command isn't explicitly
used.  You can make the first node be any valid # though.

> Does Node 2 stay node 2, or does it become node 1?  (I'm pretty sure
> it stays node 2, but I want to be certain).

Node #s never change.

> If I get node 1's server back online, discard its database, and recreate
> the schema, can I use add it to the cluster as "node 1" again, or do I
> need to pick a different node number?

AFAIK, as long as you've dropped that node from all other nodes, you can
add it back in with the same #.

-- 
Bill Moran
Collaborative Fusion Inc.
http://people.collaborativefusion.com/~wmoran/

wmoran@collaborativefusion.com
Phone: 412-422-3463x4023
From andrew.george.hammond at gmail.com  Fri Jun 22 13:10:52 2007
From: andrew.george.hammond at gmail.com (Andrew Hammond)
Date: Fri Jun 22 13:11:03 2007
Subject: [Slony1-general] Is "Node 1" special? Failover and Switchover
In-Reply-To: <20070622142913.47bd37f0.wmoran@collaborativefusion.com>
References: <467C1469.2070201@emolecules.com>
	<20070622142913.47bd37f0.wmoran@collaborativefusion.com>
Message-ID: <5a0a9d6f0706221310o1975f2bci5d8b063c144ff2be@mail.gmail.com>

On 6/22/07, Bill Moran <wmoran@collaborativefusion.com> wrote:
> In response to Craig James <craig_james@emolecules.com>:
>
> > When you create a cluster, it appears that "Node 1" is special
>
> It isn't.  Sure seems that way, though, doesn't it.  We went round and
> round with this.  One thing that creates this illusion is the fact that
> many commands assume that node 1 is the master if you don't specify
> otherwise.

Node 1 is the default for commands that need a node. I've often
thought that it'd be better to have no default since there's no reason
to believe that node 1 is the correct node to connect to in many
cases. If we _must_ have a default, then the lowest node number should
be default since there's no reason to believe that node 1 will always
exist.

I actually think that this is a good argument for avoiding having a
node 1 in clusters in general.

> > -- there
> > doesn't seem to be a "store node 1" command to create "node 1" in the
> > first place, whereas for subsequent nodes, you have to issue "store node
> > N".  Now, suppose node 1 happens to crash and burn, and I use "failover"
> > to make Node 2 the master.  Questions:
>
> The first node has an implied "store node" so that command isn't explicitly
> used.  You can make the first node be any valid # though.
>
> > Does Node 2 stay node 2, or does it become node 1?  (I'm pretty sure
> > it stays node 2, but I want to be certain).
>
> Node #s never change.

Unless you're dangerously crazy. Speaking of dangerously crazy, has
anyone written a script to change node numbers yet?

> > If I get node 1's server back online, discard its database, and recreate
> > the schema, can I use add it to the cluster as "node 1" again, or do I
> > need to pick a different node number?
>
> AFAIK, as long as you've dropped that node from all other nodes, you can
> add it back in with the same #.

While this should theoretically be possible, why would you want to?
Being lazy about defaults to node 1 seems a poor reason. I would not
recommend doing it in practice. It can cause very big, nasty problems
if the previously dropped node's cruft is not completely purged before
you create the new node. If your scripts are so fragile that they hard
code some node number then fix your scripts.

Andrew
From sthomas at leapfrogonline.com  Fri Jun 22 13:18:47 2007
From: sthomas at leapfrogonline.com (Shaun Thomas)
Date: Fri Jun 22 13:18:57 2007
Subject: [Slony1-general] Huge database remote sync issue.  Ideas?
Message-ID: <200706221518.48138.sthomas@leapfrogonline.com>

Howdy folks,

We're in the middle of a migration / upgrade, and I've got a giant slony 
set in place, and I get no errors on anything, and syncing starts up 
just great.  But something seems to be weird here:

2007-06-21 19:08:44 CDT FATAL  cleanupThread: "delete 
from "_replication".sl_log_1 where log_origin = '10' and log_xid 
< '757377'; delete from "_replication".sl_log_2 where log_origin = '10' 
and log_xid < '757377'; delete from "_replication".sl_seqlog where 
seql_origin = '10' and seql_ev_seqno < '2'; 
select "_replication".logswitch_finish(); " - server closed the 
connection unexpectedly

After it copies a huge amount, say 15-17GB of our 40-45GB total, the 
pace slows from about 300MB per minute to 5MB / minute, then to almost 
nothing.  The remote system we're mirroring to has an idle disconnect 
which is likely killing the connection in question, causing a giant 
rollback of current progress.  The FATAL error above, tells me it's 
doing a log switch on Node 10, which makes no sense, since Node 10 is a 
slave, and should have no events.  This is also the same error I get, 
every single time, even though the log_xid number itself may change.

So my questions:

1. Why is log switching on node 10, instead of node 1, which is 
providing the data?

2. Why is this mysterious log switch stalling the data copy, so our idle 
timer slaughters the initial table COPY commands mid-progress.

3. Is there some way the initial copy can *not* be an "all or nothing" 
proposition?  45GB seems an awfully huge first-bite, and it seems 
unfair that not a single error or disconnect may occur during the 
entire process of copying that much data.  Checkpoints?  Something? 
Maybe a configuration for a heartbeat, anything I missed?

4. Is it possible to somehow... bootstrap the mirror?  Make an exact 
data copy of the current database and have slony only copy updates 
after a certain point?  I mean, I could probably do a dump/restore and 
let slony keep everything up to date, before our systems launch the 
nightly insert jobs.

5. Something else I didn't consider?

Thanks in advance.  This is driving me nuts and I've scanned through 
various documentation without much luck.  We're working with our vendor 
to temporarily disable to idle kickoff, but there's a chance that may 
not be the issue, considering that weird error I pasted always having 
the same contents; I'd think the error would be different if it were 
just an idle disconnect.

-- 

Shaun Thomas
Database Administrator

Leapfrog Online 
807 Greenwood Street 
Evanston, IL 60201 
Tel. 847-440-8253
Fax. 847-570-5750
www.leapfrogonline.com
From jpfletch at ca.afilias.info  Fri Jun 22 13:39:43 2007
From: jpfletch at ca.afilias.info (JP Fletcher)
Date: Fri Jun 22 13:39:52 2007
Subject: [Slony1-general] Tarball for 1.2.10-pre2 released
In-Reply-To: <60vedh54uh.fsf@dba2.int.libertyrms.com>
References: <60vedh54uh.fsf@dba2.int.libertyrms.com>
Message-ID: <467C338F.60400@ca.afilias.info>

I've run the suite of tests against a 8.1.8 build on AIX 5.3, and 
everything went smoothly.  I'll run it against 8.2.4 if I can get it 
compiled today.  Otherwise I'll report back next week.


Christopher Browne wrote:
> I have uploaded a tarball for 1.2.10 based on the fixes that have come
> in this week to fix log shipping problems.
>
> I have run tests of this build on Debian/Unstable on the IA-32
> architecture against each of PostgreSQL 7.4, 8.0, 8.1, 8.2, and a
> recent copy of CVS HEAD (e.g. - 8.3).
>
> Indeed, my tests were thus...
>
> For each build:
>
> for test in test1  testdatestyles testddl testinherit testlargetuples testlogship testmultiplemoves testschemanames testseqnames testtabnames testutf8 ; do
> ./run_test.sh $test
> done
>
> If there are no negative reports about it, I anticipate that a
> checkout insignificantly different from this will become the 1.2.10
> release later this week.
>
> Please do not release binaries based on this tarball; that could lead
> to the regrettable situation of people downloading something that
> isn't the true final release of 1.2.10.  The license permits such
> things, but please wait until we call this final...
>   


-- 
JP Fletcher
Database Administrator
Afilias Canada
voice: 416.646.3304 ext. 4123
fax: 416.646.3305
mobile: 416.561.4763
jpfletch@ca.afilias.info


From andrew.george.hammond at gmail.com  Fri Jun 22 13:58:09 2007
From: andrew.george.hammond at gmail.com (Andrew Hammond)
Date: Fri Jun 22 13:58:17 2007
Subject: [Slony1-general] Huge database remote sync issue. Ideas?
In-Reply-To: <200706221518.48138.sthomas@leapfrogonline.com>
References: <200706221518.48138.sthomas@leapfrogonline.com>
Message-ID: <5a0a9d6f0706221358l774fc36dvd761e7364eaa0b24@mail.gmail.com>

On 6/22/07, Shaun Thomas <sthomas@leapfrogonline.com> wrote:
> Howdy folks,
>
> We're in the middle of a migration / upgrade, and I've got a giant slony
> set in place, and I get no errors on anything, and syncing starts up
> just great.  But something seems to be weird here:
>
> 2007-06-21 19:08:44 CDT FATAL  cleanupThread: "delete
> from "_replication".sl_log_1 where log_origin = '10' and log_xid
> < '757377'; delete from "_replication".sl_log_2 where log_origin = '10'
> and log_xid < '757377'; delete from "_replication".sl_seqlog where
> seql_origin = '10' and seql_ev_seqno < '2';
> select "_replication".logswitch_finish(); " - server closed the
> connection unexpectedly
>
> After it copies a huge amount, say 15-17GB of our 40-45GB total, the
> pace slows from about 300MB per minute to 5MB / minute, then to almost
> nothing.  The remote system we're mirroring to has an idle disconnect
> which is likely killing the connection in question, causing a giant
> rollback of current progress.  The FATAL error above, tells me it's
> doing a log switch on Node 10, which makes no sense, since Node 10 is a
> slave, and should have no events.  This is also the same error I get,
> every single time, even though the log_xid number itself may change.
>
> So my questions:
>
> 1. Why is log switching on node 10, instead of node 1, which is
> providing the data?
>
> 2. Why is this mysterious log switch stalling the data copy, so our idle
> timer slaughters the initial table COPY commands mid-progress.

Why do you have an "idle timer" running during a subscribe? Killing
slons during subscribe is an outright bad idea.

> 3. Is there some way the initial copy can *not* be an "all or nothing"
> proposition?  45GB seems an awfully huge first-bite, and it seems
> unfair that not a single error or disconnect may occur during the
> entire process of copying that much data.  Checkpoints?  Something?
> Maybe a configuration for a heartbeat, anything I missed?

Slony doesn't replicate databases. It replicates sets of tables and
sequences. To smooth your initial subscribe, have you considered
breaking it into a number of small sets (say with a single table and
related sequences in each set) and subscribing them piece by piece?

Otherwise, the answer is no.

Also, you will want to VACUUM (if not TRUNCATE) those tables to get
those dead rows out before restarting your slon to try again.

> 4. Is it possible to somehow... bootstrap the mirror?  Make an exact
> data copy of the current database and have slony only copy updates
> after a certain point?  I mean, I could probably do a dump/restore and
> let slony keep everything up to date, before our systems launch the
> nightly insert jobs.

No. Unless you intend to use log shipped replication.

> 5. Something else I didn't consider?
>
> Thanks in advance.  This is driving me nuts and I've scanned through
> various documentation without much luck.  We're working with our vendor
> to temporarily disable to idle kickoff, but there's a chance that may
> not be the issue, considering that weird error I pasted always having
> the same contents; I'd think the error would be different if it were
> just an idle disconnect.

Mixing vendors and replication is like putting de lime in de coconut.
Good luck with that.

Andrew
From craig_james at emolecules.com  Fri Jun 22 14:12:01 2007
From: craig_james at emolecules.com (Craig James)
Date: Fri Jun 22 14:08:05 2007
Subject: [Slony1-general] Is "Node 1" special? Failover and Switchover
In-Reply-To: <5a0a9d6f0706221310o1975f2bci5d8b063c144ff2be@mail.gmail.com>
References: <467C1469.2070201@emolecules.com>	
	<20070622142913.47bd37f0.wmoran@collaborativefusion.com>
	<5a0a9d6f0706221310o1975f2bci5d8b063c144ff2be@mail.gmail.com>
Message-ID: <467C3B21.9090006@emolecules.com>

Andrew Hammond wrote:
>> AFAIK, as long as you've dropped that node from all other nodes, you can
>> add it back in with the same #.
> 
> While this should theoretically be possible, why would you want to?
> Being lazy about defaults to node 1 seems a poor reason.

It has more to do with source-code management than good cluster practices.  I'd like to have an INCLUDE file for Slony that might be something like this:

  # Cluster 1, lives in Hoboken
  DEFINE alpha    1;
  DEFINE beta     2;

  # Cluster 2, lives in Kalamazoo
  DEFINE delta    3;
  DEFINE gamma    4;

We use Subversion for all source code (scripts), and it's distributed to all sites.  It would be nice to have a single INCLUDE file that defined all nodes.

If a node goes down, I just want to blow off the database, clean it out of Slony, and rebuild it as though it had never existed in the first place.  If I have to tell the administrator, "Well, you have to edit this source code INCLUDE file, pick a new node number, save it, and check it in to Subversion, before you can rebuild the Slony node," well, that makes life more complicated!

Thanks,
Craig

 
From cbbrowne at ca.afilias.info  Fri Jun 22 14:46:56 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Fri Jun 22 14:47:05 2007
Subject: [Slony1-general] Huge database remote sync issue.  Ideas?
In-Reply-To: <200706221518.48138.sthomas@leapfrogonline.com>
References: <200706221518.48138.sthomas@leapfrogonline.com>
Message-ID: <467C4350.4050604@ca.afilias.info>

Shaun Thomas wrote:
> Howdy folks,
>
> We're in the middle of a migration / upgrade, and I've got a giant slony 
> set in place, and I get no errors on anything, and syncing starts up 
> just great.  But something seems to be weird here:
>
> 2007-06-21 19:08:44 CDT FATAL  cleanupThread: "delete 
> from "_replication".sl_log_1 where log_origin = '10' and log_xid 
> < '757377'; delete from "_replication".sl_log_2 where log_origin = '10' 
> and log_xid < '757377'; delete from "_replication".sl_seqlog where 
> seql_origin = '10' and seql_ev_seqno < '2'; 
> select "_replication".logswitch_finish(); " - server closed the 
> connection unexpectedly
>
> After it copies a huge amount, say 15-17GB of our 40-45GB total, the 
> pace slows from about 300MB per minute to 5MB / minute, then to almost 
> nothing.  The remote system we're mirroring to has an idle disconnect 
> which is likely killing the connection in question, causing a giant 
> rollback of current progress.  The FATAL error above, tells me it's 
> doing a log switch on Node 10, which makes no sense, since Node 10 is a 
> slave, and should have no events.  This is also the same error I get, 
> every single time, even though the log_xid number itself may change.
>
> So my questions:
>
> 1. Why is log switching on node 10, instead of node 1, which is 
> providing the data?
>   
That'll take place routinely on all nodes; slony needs to switch between
sl_log_1 and sl_log_2 periodically, and does so on every node.

There's something odd about the problem with logswitch_finish(); can you
check your logs to see if the DBMS saw a Signal 11 or such at 19:08:44? 
If node 1 is the origin, that set of queries should trivially run
quickly with no muss and fuss on node 10, as there shouldn't be *any*
data in sl_log_1/2 on node 10.

It seems as though there may be something funky happening at the network
level, not particularly diagnosable (nor controllable) at the DBMS level...
> 2. Why is this mysterious log switch stalling the data copy, so our idle 
> timer slaughters the initial table COPY commands mid-progress.
>
>   
The log switch shouldn't be having that effect; it doesn't make sense
for it to break things.
> 3. Is there some way the initial copy can *not* be an "all or nothing" 
> proposition?  45GB seems an awfully huge first-bite, and it seems 
> unfair that not a single error or disconnect may occur during the 
> entire process of copying that much data.  Checkpoints?  Something? 
> Maybe a configuration for a heartbeat, anything I missed?
>
>   
If you have multiple tables, you could set up a replication set per
table, and subscribe one table at a time.  In practice, you probably
have five tables that are bigger than all the others put together; if
you set up a set for each of those 5, and a set for "the rest," that's
probably about as good as it can get.
> 4. Is it possible to somehow... bootstrap the mirror?  Make an exact 
> data copy of the current database and have slony only copy updates 
> after a certain point?  I mean, I could probably do a dump/restore and 
> let slony keep everything up to date, before our systems launch the 
> nightly insert jobs.
>
>   
Jan's thinking about having a way to do this with Slony-I 2.x with PG
8.3; it's still a glimmer in the eye, at this point...
From cbbrowne at ca.afilias.info  Fri Jun 22 14:50:49 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Fri Jun 22 14:51:02 2007
Subject: [Slony1-general] Is "Node 1" special? Failover and Switchover
In-Reply-To: <5a0a9d6f0706221310o1975f2bci5d8b063c144ff2be@mail.gmail.com>
References: <467C1469.2070201@emolecules.com>	<20070622142913.47bd37f0.wmoran@collaborativefusion.com>
	<5a0a9d6f0706221310o1975f2bci5d8b063c144ff2be@mail.gmail.com>
Message-ID: <467C4439.6050603@ca.afilias.info>

Andrew Hammond wrote:
> On 6/22/07, Bill Moran <wmoran@collaborativefusion.com> wrote:
>> In response to Craig James <craig_james@emolecules.com>:
>>
>> > When you create a cluster, it appears that "Node 1" is special
>>
>> It isn't.  Sure seems that way, though, doesn't it.  We went round and
>> round with this.  One thing that creates this illusion is the fact that
>> many commands assume that node 1 is the master if you don't specify
>> otherwise.
>
> Node 1 is the default for commands that need a node. I've often
> thought that it'd be better to have no default since there's no reason
> to believe that node 1 is the correct node to connect to in many
> cases. If we _must_ have a default, then the lowest node number should
> be default since there's no reason to believe that node 1 will always
> exist.
>
> I actually think that this is a good argument for avoiding having a
> node 1 in clusters in general.
>
I tend to agree.

The behaviour tends to be that events are submitted to node #1 if there
is no obvious default for that command and if no event node is specified.

I make sure that tests include cases where there is no node #1.
>> > -- there
>> > doesn't seem to be a "store node 1" command to create "node 1" in the
>> > first place, whereas for subsequent nodes, you have to issue "store
>> node
>> > N".  Now, suppose node 1 happens to crash and burn, and I use
>> "failover"
>> > to make Node 2 the master.  Questions:
>>
>> The first node has an implied "store node" so that command isn't
>> explicitly
>> used.  You can make the first node be any valid # though.
>>
>> > Does Node 2 stay node 2, or does it become node 1?  (I'm pretty sure
>> > it stays node 2, but I want to be certain).
>>
>> Node #s never change.
>
> Unless you're dangerously crazy. Speaking of dangerously crazy, has
> anyone written a script to change node numbers yet?

I thought I had sent something over to the list quite a while back in
support of a "CLONE NODE" command; Jan thinks he'll try to have
something like that in Slony-I 2.x...

>> > If I get node 1's server back online, discard its database, and
>> recreate
>> > the schema, can I use add it to the cluster as "node 1" again, or do I
>> > need to pick a different node number?
>>
>> AFAIK, as long as you've dropped that node from all other nodes, you can
>> add it back in with the same #.
>
> While this should theoretically be possible, why would you want to?
> Being lazy about defaults to node 1 seems a poor reason. I would not
> recommend doing it in practice. It can cause very big, nasty problems
> if the previously dropped node's cruft is not completely purged before
> you create the new node. If your scripts are so fragile that they hard
> code some node number then fix your scripts.
I'd not be keen on recreating a node number previously used within the
same day as its deletion...
From sthomas at leapfrogonline.com  Fri Jun 22 14:54:43 2007
From: sthomas at leapfrogonline.com (Shaun Thomas)
Date: Fri Jun 22 14:54:52 2007
Subject: [Slony1-general] Huge database remote sync issue. Ideas?
In-Reply-To: <5a0a9d6f0706221358l774fc36dvd761e7364eaa0b24@mail.gmail.com>
References: <200706221518.48138.sthomas@leapfrogonline.com>
	<5a0a9d6f0706221358l774fc36dvd761e7364eaa0b24@mail.gmail.com>
Message-ID: <200706221654.43676.sthomas@leapfrogonline.com>

On Friday 22 June 2007 03:58:09 pm Andrew Hammond wrote:

> Why do you have an "idle timer" running during a subscribe? Killing
> slons during subscribe is an outright bad idea.

Who said anything about killing slons?  The remote system is a a colo 
where they have a firewall which periodically disconnects things it 
perceives as idle.  There isn't anything we can do about this.  This is 
all part of our migration plan - mirror to the new remote data store, 
do some tests and checks, then switch the master and we're done.

> To smooth your initial subscribe, have you considered breaking it
> into a number of small sets (say with a single table and 
> related sequences in each set) and subscribing them piece by piece?

I was considering that.  I may have to go that direction anyway, but I 
was kinda hoping for another answer. Heh.  This is a huge legacy 
database spanning over 200 tables... but maybe I'll put the three 
largest ones in their own set just for that reason.  The beefy guys are 
about 40M-rows (5-8GB) each, while the little ones probably aren't 
impacting the sync.

> Also, you will want to VACUUM (if not TRUNCATE) those tables to get
> those dead rows out before restarting your slon to try again.

I watched the slony logs.  It's doing a truncate before the initial COPY 
anyway.

> No. Unless you intend to use log shipped replication.

Which you can only do from a primary slave, so no.

I'll experiment with pulling out the larger tables and letting them sync 
on their own.  If that works, we're cool.  If our current server 
weren't 80% full on the disk, I'd just do an on-site convert to 
postgres-8.2 and put the slave in PITR mode until we thought things 
looked good.  Ah well.

-- 

Shaun Thomas
Database Administrator

Leapfrog Online 
807 Greenwood Street 
Evanston, IL 60201 
Tel. 847-440-8253
Fax. 847-570-5750
www.leapfrogonline.com
From sthomas at leapfrogonline.com  Fri Jun 22 15:07:32 2007
From: sthomas at leapfrogonline.com (Shaun Thomas)
Date: Fri Jun 22 15:07:42 2007
Subject: [Slony1-general] Huge database remote sync issue.  Ideas?
In-Reply-To: <467C4350.4050604@ca.afilias.info>
References: <200706221518.48138.sthomas@leapfrogonline.com>
	<467C4350.4050604@ca.afilias.info>
Message-ID: <200706221707.32567.sthomas@leapfrogonline.com>

On Friday 22 June 2007 04:46:56 pm Christopher Browne wrote:


> That'll take place routinely on all nodes; slony
> needs to switch between sl_log_1 and sl_log_2 periodically,
> and does so on every node. 

I was wondering about that.  I was mostly suspicious because it copies 
like mad until about 15-17G, and then slows to a crawl before erupting 
with those errors and aborting the sync.  The logswitch was just where 
it kept dying, so I kept it as a possible candidate.

> There's something odd about the problem with logswitch_finish();
> can you check your logs to see if the DBMS saw a Signal 11 or
> such at 19:08:44?  

I didn't see any Sig-11, but postgres *did* whine about the client 
unexpectedly closing the connection.  But considering the slony client 
was just as confused about the connection drop, that's what made me 
think of the Savvis firewall getting pissy.

> If you have multiple tables, you could set up a replication set per
> table, and subscribe one table at a time.  In practice, you probably
> have five tables that are bigger than all the others put together;

That's exactly the case.  Not counting indexes, I have 1 5GB table with 
44M rows, a 4GB table with 50M rows, and a 2.5G table with 10M rows.  
If I put those in their own sets, the rest would have no problem being 
in the remainder.

But I wonder about something - does slony turn off indexes to facilitate 
the data copy, and then reenable them so they're all created after the 
copy is done?  If that's the case, that could be my problem.  17G is 
about the size of all the tables with no indexes, fully vacuumed.  If 
slony is waiting around forever for the indexes to finish generating 
before committing and declaring the initial copy successful, that could 
account for my idle time.

I'm still going to assume it's just Savvis and their finicky firewall.  
I've got our sysadmin operating under that assumption, and hope if 
multiple sets don't work, we can get them to, at least temporarily, 
turn off whatever is killing my slons.

Thanks for the help!

-- 

Shaun Thomas
Database Administrator

Leapfrog Online 
807 Greenwood Street 
Evanston, IL 60201 
Tel. 847-440-8253
Fax. 847-570-5750
www.leapfrogonline.com
From andrew.george.hammond at gmail.com  Fri Jun 22 16:04:17 2007
From: andrew.george.hammond at gmail.com (Andrew Hammond)
Date: Fri Jun 22 16:04:29 2007
Subject: [Slony1-general] Huge database remote sync issue. Ideas?
In-Reply-To: <200706221707.32567.sthomas@leapfrogonline.com>
References: <200706221518.48138.sthomas@leapfrogonline.com>
	<467C4350.4050604@ca.afilias.info>
	<200706221707.32567.sthomas@leapfrogonline.com>
Message-ID: <5a0a9d6f0706221604v3c51b087ne06be8a27240eeac@mail.gmail.com>

> I'm still going to assume it's just Savvis and their finicky firewall.
> I've got our sysadmin operating under that assumption, and hope if
> multiple sets don't work, we can get them to, at least temporarily,
> turn off whatever is killing my slons.

Have you considered subscribing through an ssh tunnel with ssh keep-alives?

Andrew
From cbbrowne at ca.afilias.info  Fri Jun 22 20:02:04 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Fri Jun 22 20:02:17 2007
Subject: [Slony1-general] Huge database remote sync issue.  Ideas?
In-Reply-To: <200706221707.32567.sthomas@leapfrogonline.com> (Shaun Thomas's
	message of "Fri, 22 Jun 2007 17:07:32 -0500")
References: <200706221518.48138.sthomas@leapfrogonline.com>
	<467C4350.4050604@ca.afilias.info>
	<200706221707.32567.sthomas@leapfrogonline.com>
Message-ID: <603b0j5q6r.fsf@dba2.int.libertyrms.com>

Shaun Thomas <sthomas@leapfrogonline.com> writes:
> I'm still going to assume it's just Savvis and their finicky firewall.  
> I've got our sysadmin operating under that assumption, and hope if 
> multiple sets don't work, we can get them to, at least temporarily, 
> turn off whatever is killing my slons.

As details have emerged about your situation, I am concluding that
that's *exactly* the problem.

Splitting the data into multiple sets will help get *most* of the
tables subscribed, but unless you can do something to help that
biggest table, I think you'll find that the problem is the amount of
time it takes to do the longest reindex.  

Note: It doesn't index them all at once; the methodology is to loop
thus:

  for each table:
     truncate table on subscriber
     shut off indices (catalog hack)
     COPY to pipe on provider / COPY from pipe on subscriber
     turn indices back on (unhack catalog)
     reindex table

[Aside: We've got a theory that in 2.x we might get a win out of doing
this in parallel.  Thus, we might open, say, 4 threads/8 threads, and
try to keep them all busy.  As soon as one table finishes copying and
starts reindexing, we could start another COPY against that
thread/connection...  It wouldn't take many threads/connections to
maximize the benefits.  That likely won't be in 2.0, though...]

There may *still* be a way around the problem; supposing the
troublesome table has 4 indexes on it, you could, on the subscriber
node, drop the 3 that aren't the candidate primary key, which
hopefully helps cut REINDEX time enough, and then, afterwards,
recreate the 3 indexes.  

If you're on PG 8.2, you may be able to re-add them in the background,
which would be slick :-).

If not, you'll have to do them in the foreground, and will find that
replication will fall behind because inserts into that table on the
subscriber are being blocked by the lock for the transaction.  Life...
Eventually the node should catch up...

FYI, you should probably let the subscriber catch up before redoing
such indexes; there is, at present, an inefficiency in handling the
*later* data when the system has fallen behind due to having a really
enormous transaction running (e.g. - like the initial subscription
that runs many hours).  The early catchup isn't bad; it gets bad
later.

It looks like the Skype people noticed this issue and did something
about for their replication system; I was talking with Jan about it
last week, and he seems to think he can have an improvement for it for
Slony-I 2.0.  Won't help yet, but someday...
-- 
"cbbrowne","@","ca.afilias.info"
<http://dba2.int.libertyrms.com/>
Christopher Browne
(416) 673-4124 (land)
From ajs at crankycanuck.ca  Sun Jun 24 09:32:07 2007
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Sun Jun 24 09:32:25 2007
Subject: [Slony1-general] Huge database remote sync issue.  Ideas?
In-Reply-To: <200706221707.32567.sthomas@leapfrogonline.com>
References: <200706221518.48138.sthomas@leapfrogonline.com>
	<467C4350.4050604@ca.afilias.info>
	<200706221707.32567.sthomas@leapfrogonline.com>
Message-ID: <20070624163207.GA15628@phlogiston.dyndns.org>

On Fri, Jun 22, 2007 at 05:07:32PM -0500, Shaun Thomas wrote:
> But I wonder about something - does slony turn off indexes to facilitate 
> the data copy, and then reenable them so they're all created after the 
> copy is done?  If that's the case, that could be my problem.  17G is 
> about the size of all the tables with no indexes, fully vacuumed.  If 
> slony is waiting around forever for the indexes to finish generating 
> before committing and declaring the initial copy successful, that could 
> account for my idle time.

Yes, that's how Slony (at least in the versions you're using, IIRC)
does it, so it probably is that problem.  I think you need to tell
your vendor that they need to stop fiddling with connections that
might be open in a database.  (A lot of what passes for network
security is nothing but snake oil, and this would be one example, I
think.)

A

-- 
Andrew Sullivan  | ajs@crankycanuck.ca
However important originality may be in some fields, restraint and 
adherence to procedure emerge as the more significant virtues in a 
great many others.   --Alain de Botton
From cbbrowne at ca.afilias.info  Mon Jun 25 06:54:57 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Mon Jun 25 06:55:02 2007
Subject: [Slony1-general] Just about ready for 1.2.10?
Message-ID: <60vedc2l72.fsf@dba2.int.libertyrms.com>

I have heard about positive test results on Windows and AIX, and
between Jan and I, Linux and FreeBSD also have "test successes."

The "pre2" test tarball has been out for a few days; haven't heard any
negative reports in a while.

In the absence of negative reports, I think it's getting time for a
release...  Last calls???
-- 
output = ("cbbrowne" "@" "ca.afilias.info")
<http://dba2.int.libertyrms.com/>
Christopher Browne
(416) 673-4124 (land)
From sthomas at leapfrogonline.com  Mon Jun 25 07:24:32 2007
From: sthomas at leapfrogonline.com (Shaun Thomas)
Date: Mon Jun 25 07:24:39 2007
Subject: [Slony1-general] Huge database remote sync issue. Ideas?
In-Reply-To: <5a0a9d6f0706221604v3c51b087ne06be8a27240eeac@mail.gmail.com>
References: <200706221518.48138.sthomas@leapfrogonline.com>
	<200706221707.32567.sthomas@leapfrogonline.com>
	<5a0a9d6f0706221604v3c51b087ne06be8a27240eeac@mail.gmail.com>
Message-ID: <200706250924.32978.sthomas@leapfrogonline.com>

On Friday 22 June 2007 06:04:17 pm Andrew Hammond wrote:

> Have you considered subscribing through an ssh
> tunnel with ssh keep-alives? 

I didn't think about that.  I think I'll take Christopher's advice 
first, as it's slightly easier to manage and won't add network 
overhead.  If that doesn't work, an SSH tunnel may be my last 
choice. :)

Thanks everyone!

-- 

Shaun Thomas
Database Administrator

Leapfrog Online 
807 Greenwood Street 
Evanston, IL 60201 
Tel. 847-440-8253
Fax. 847-570-5750
www.leapfrogonline.com
From JanWieck at Yahoo.com  Mon Jun 25 07:30:34 2007
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Mon Jun 25 07:30:45 2007
Subject: [Slony1-general] Huge database remote sync issue.  Ideas?
In-Reply-To: <200706221707.32567.sthomas@leapfrogonline.com>
References: <200706221518.48138.sthomas@leapfrogonline.com>	<467C4350.4050604@ca.afilias.info>
	<200706221707.32567.sthomas@leapfrogonline.com>
Message-ID: <467FD18A.7020904@Yahoo.com>

On 6/22/2007 6:07 PM, Shaun Thomas wrote:
> On Friday 22 June 2007 04:46:56 pm Christopher Browne wrote:
> 
> 
>> That'll take place routinely on all nodes; slony
>> needs to switch between sl_log_1 and sl_log_2 periodically,
>> and does so on every node. 
> 
> I was wondering about that.  I was mostly suspicious because it copies 
> like mad until about 15-17G, and then slows to a crawl before erupting 
> with those errors and aborting the sync.  The logswitch was just where 
> it kept dying, so I kept it as a possible candidate.

Any error on any DB connection will usually cause slon to restart 
everything internally. Do you by any chance run the slon serving the 
node behind the firewall from the outside? In that case, you will have 
trouble because the cleanup thread is idle most of its life and when it 
tries to do its work, your firewall has pulled the plugs. So that's not 
going to work ever. You will have to run the slon on the remote site.

The slowdown you experience might be related to how slony does the 
initial copy. Per table it disables index maintenance, copies the data, 
then enables indexes and issues a reindex for that table. So if at that 
time it is copying medium size tables with many indexes, this would be 
what I'd expect to happen.

> 
>> There's something odd about the problem with logswitch_finish();
>> can you check your logs to see if the DBMS saw a Signal 11 or
>> such at 19:08:44?  
> 
> I didn't see any Sig-11, but postgres *did* whine about the client 
> unexpectedly closing the connection.  But considering the slony client 
> was just as confused about the connection drop, that's what made me 
> think of the Savvis firewall getting pissy.

Slon itself never does a proper PQfinish() call to close the 
connections. So whenever slon is stopped or internally restarted, you 
will see those messages about clients disconnecting. However, the 
firewall is still the source of your troubles. It is just plain wrong to 
kill a perfectly healthy TCP connection just because it wasn't used for 
a while. You might want to try using the tcp_keepalives_* config options 
in the postgresql.conf file of the poor server behind that stupid flamewall.

> 
>> If you have multiple tables, you could set up a replication set per
>> table, and subscribe one table at a time.  In practice, you probably
>> have five tables that are bigger than all the others put together;
> 
> That's exactly the case.  Not counting indexes, I have 1 5GB table with 
> 44M rows, a 4GB table with 50M rows, and a 2.5G table with 10M rows.  
> If I put those in their own sets, the rest would have no problem being 
> in the remainder.
> 
> But I wonder about something - does slony turn off indexes to facilitate 
> the data copy, and then reenable them so they're all created after the 
> copy is done?  If that's the case, that could be my problem.  17G is 
> about the size of all the tables with no indexes, fully vacuumed.  If 
> slony is waiting around forever for the indexes to finish generating 
> before committing and declaring the initial copy successful, that could 
> account for my idle time.

It does that table by table.


Jan

-- 
#======================================================================#
# It's easier to get forgiveness for being wrong than for being right. #
# Let's break this rule - forgive me.                                  #
#================================================== JanWieck@Yahoo.com #
From cbbrowne at ca.afilias.info  Mon Jun 25 08:28:46 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Mon Jun 25 08:28:55 2007
Subject: [Slony1-general] Proposal to revise debugging levels a bit
Message-ID: <60ps3k2gup.fsf@dba2.int.libertyrms.com>

As a side-effect of seeing complaints about logging on other systems
(not related to Slony-I :-)), I thought I'd take a look at the
messages being generated by Slony-I with a view to promoting/demoting
them so that:

 - Informational things would be logged at level INFO
 - Configuration logs  would be logged at level CONFIG

The principle being that people ought to be able to run at debugging
level "-d 0" and get most of the interesting stuff.

Things in DEBUG1-DEBUG4 should be messages specifically relating to
debugging problems, and it ought to be safe to omit those without
losing interesting log information.

Here's the patch to that end, against CVS HEAD:

<http://lists.slony.info/pipermail/slony1-patches/2007-June/000020.html>

Comments?  Disagreements?
-- 
"cbbrowne","@","ca.afilias.info"
<http://dba2.int.libertyrms.com/>
Christopher Browne
(416) 673-4124 (land)
From craig_james at emolecules.com  Mon Jun 25 10:14:13 2007
From: craig_james at emolecules.com (Craig James)
Date: Mon Jun 25 10:09:58 2007
Subject: [Slony1-general] Can't drop/recreate slave node
In-Reply-To: <467C3B21.9090006@emolecules.com>
References: <467C1469.2070201@emolecules.com>		<20070622142913.47bd37f0.wmoran@collaborativefusion.com>	<5a0a9d6f0706221310o1975f2bci5d8b063c144ff2be@mail.gmail.com>
	<467C3B21.9090006@emolecules.com>
Message-ID: <467FF7E5.20304@emolecules.com>

I'm having trouble dropping and re-creating a node.  I'm trying to develop some scripts that will handle a failover situation and the subsequent cleanup.  When dropping a node, here's what I'm doing:

    slonik <<_EOF_
    cluster name = global_cluster;
    node 1 admin conninfo = 'dbname=global host=host1 user=postgres';
    node 2 admin conninfo = 'dbname=global host=host2 user=postgres';
    uninstall node (id = 2);
    _EOF_

    ... drop the slave database
    ... recreate the slave database schema

    slonik <<_EOF_
    cluster name = global_cluster;
    node 1 admin conninfo = 'dbname=global host=host1 user=postgres';
    node 2 admin conninfo = 'dbname=global host=host2 user=postgres';
    store node (id=2, comment = '$SLAVE_NAME');
    store path (server = 1, client = 2, conninfo='dbname=global  host=$MASTER_NAME user=postgres');
    store path (server = 2, client = 1, conninfo='dbname=global  host=$SLAVE_NAME   user=postgres');
    subscribe set ( id = 1, provider = 1, receiver = 2, forward = no);
    _EOF_

When I do this, I get the following error message:

<stdin>:4: PGRES_FATAL_ERROR select "_global_cluster".storeNode(2, 'subversion', 'f'); select "_global_cluster".enableNode(2);  - ERROR:  Slony-I: node 2 is already active

What step am I missing?  The only way I've been able to drop/recreate a node is to destroy and recreate the entire Slony cluster (i.e. drop node 1 also, and recreate it).  I'm sure there's a better way!

Thanks,
Craig




From darcyb at commandprompt.com  Mon Jun 25 10:15:12 2007
From: darcyb at commandprompt.com (Darcy Buskermolen)
Date: Mon Jun 25 10:15:28 2007
Subject: [Slony1-general] Proposal to revise debugging levels a bit
In-Reply-To: <60ps3k2gup.fsf@dba2.int.libertyrms.com>
References: <60ps3k2gup.fsf@dba2.int.libertyrms.com>
Message-ID: <200706251015.12423.darcyb@commandprompt.com>

On June 25, 2007 08:28 am, Christopher Browne wrote:
> As a side-effect of seeing complaints about logging on other systems
> (not related to Slony-I :-)), I thought I'd take a look at the
> messages being generated by Slony-I with a view to promoting/demoting
> them so that:
>
>  - Informational things would be logged at level INFO
>  - Configuration logs  would be logged at level CONFIG
>
> The principle being that people ought to be able to run at debugging
> level "-d 0" and get most of the interesting stuff.
>
> Things in DEBUG1-DEBUG4 should be messages specifically relating to
> debugging problems, and it ought to be safe to omit those without
> losing interesting log information.
>
> Here's the patch to that end, against CVS HEAD:
>
> <http://lists.slony.info/pipermail/slony1-patches/2007-June/000020.html>
>
> Comments?  Disagreements?

No general objections regarding this from my end.


-- 
Darcy Buskermolen
Command Prompt, Inc.
+1.503.667.4564 X 102
http://www.commandprompt.com/
PostgreSQL solutions since 1997
From andrew.george.hammond at gmail.com  Mon Jun 25 10:38:43 2007
From: andrew.george.hammond at gmail.com (Andrew Hammond)
Date: Mon Jun 25 10:38:52 2007
Subject: [Slony1-general] Can't drop/recreate slave node
In-Reply-To: <467FF7E5.20304@emolecules.com>
References: <467C1469.2070201@emolecules.com>
	<20070622142913.47bd37f0.wmoran@collaborativefusion.com>
	<5a0a9d6f0706221310o1975f2bci5d8b063c144ff2be@mail.gmail.com>
	<467C3B21.9090006@emolecules.com> <467FF7E5.20304@emolecules.com>
Message-ID: <5a0a9d6f0706251038s65289e7fm9eeb99c284815f41@mail.gmail.com>

On 6/25/07, Craig James <craig_james@emolecules.com> wrote:
> I'm having trouble dropping and re-creating a node.  I'm trying to develop some scripts that will handle a failover situation and the subsequent cleanup.  When dropping a node, here's what I'm doing:
>
>     slonik <<_EOF_
>     cluster name = global_cluster;
>     node 1 admin conninfo = 'dbname=global host=host1 user=postgres';
>     node 2 admin conninfo = 'dbname=global host=host2 user=postgres';
>     uninstall node (id = 2);
>     _EOF_
>
>     ... drop the slave database
>     ... recreate the slave database schema

Are you waiting for this event to propagate? Because it looks like
you're just running this second script immediately.

>     slonik <<_EOF_
>     cluster name = global_cluster;
>     node 1 admin conninfo = 'dbname=global host=host1 user=postgres';
>     node 2 admin conninfo = 'dbname=global host=host2 user=postgres';
>     store node (id=2, comment = '$SLAVE_NAME');
>     store path (server = 1, client = 2, conninfo='dbname=global  host=$MASTER_NAME user=postgres');
>     store path (server = 2, client = 1, conninfo='dbname=global  host=$SLAVE_NAME   user=postgres');
>     subscribe set ( id = 1, provider = 1, receiver = 2, forward = no);
>     _EOF_
>
> When I do this, I get the following error message:
>
> <stdin>:4: PGRES_FATAL_ERROR select "_global_cluster".storeNode(2, 'subversion', 'f'); select "_global_cluster".enableNode(2);  - ERROR:  Slony-I: node 2 is already active
>
From craig_james at emolecules.com  Mon Jun 25 14:01:56 2007
From: craig_james at emolecules.com (Craig James)
Date: Mon Jun 25 13:57:44 2007
Subject: [Slony1-general] Can't drop/recreate slave node
In-Reply-To: <5a0a9d6f0706251038s65289e7fm9eeb99c284815f41@mail.gmail.com>
References: <467C1469.2070201@emolecules.com>	
	<20070622142913.47bd37f0.wmoran@collaborativefusion.com>	
	<5a0a9d6f0706221310o1975f2bci5d8b063c144ff2be@mail.gmail.com>	
	<467C3B21.9090006@emolecules.com> <467FF7E5.20304@emolecules.com>
	<5a0a9d6f0706251038s65289e7fm9eeb99c284815f41@mail.gmail.com>
Message-ID: <46802D44.3070509@emolecules.com>

Oops!  Sorry about that last message, I sent from the wrong email, then resent the reply rather than this!  Mea culpa.  Here's what I should have sent...

Andrew Hammond wrote:
> On 6/25/07, Craig James <craig_james@emolecules.com> wrote:
>> I'm having trouble dropping and re-creating a node.  I'm trying to 
>> develop some scripts that will handle a failover situation and the 
>> subsequent cleanup.  When dropping a node, here's what I'm doing:
>>
>>     slonik <<_EOF_
>>     cluster name = global_cluster;
>>     node 1 admin conninfo = 'dbname=global host=host1 user=postgres';
>>     node 2 admin conninfo = 'dbname=global host=host2 user=postgres';
>>     uninstall node (id = 2);
>>     _EOF_
>>
>>     ... drop the slave database
>>     ... recreate the slave database schema
> 
> Are you waiting for this event to propagate? Because it looks like
> you're just running this second script immediately.

Yes, I am waiting.  The "script" I showed is actually four separate steps: Drop the node, destroy the database, recreate the schema, and recreate the node.  Just to be sure, I ran the first step, waited, and watched the slon(1) daemon's log.  When it showed, "cannot get sl_local_node_id - ERROR:  schema "_global_cluster" does not exist", I figured the event had propagated.

Thanks,
Craig



From devrim at CommandPrompt.com  Mon Jun 25 14:31:33 2007
From: devrim at CommandPrompt.com (Devrim =?ISO-8859-1?Q?G=DCND=DCZ?=)
Date: Mon Jun 25 14:34:22 2007
Subject: [Slony1-general] Just about ready for 1.2.10?
In-Reply-To: <60vedc2l72.fsf@dba2.int.libertyrms.com>
References: <60vedc2l72.fsf@dba2.int.libertyrms.com>
Message-ID: <1182807093.3171.27.camel@laptop.gunduz.org>

SGVsbG8sCgpPbiBNb24sIDIwMDctMDYtMjUgYXQgMDk6NTQgLTA0MDAsIENocmlzdG9waGVyIEJy
b3duZSB3cm90ZToKCj4gSW4gdGhlIGFic2VuY2Ugb2YgbmVnYXRpdmUgcmVwb3J0cywgSSB0aGlu
ayBpdCdzIGdldHRpbmcgdGltZSBmb3IgYQo+IHJlbGVhc2UuLi4gIExhc3QgY2FsbHM/Pz8gCgpQ
bGVhc2UgZ2l2ZSBtZSBzb21lIHRpbWUgdW50aWwgdG9tb3Jyb3cgZm9yIHBhY2thZ2luZyBzdHVm
ZiAtLSBJJ2xsCnBhY2thZ2UgaXQgdG9tb3Jyb3csIGFzIHNvb24gYXMgSSB3YWtlIHVwLgoKUmVn
YXJkcywKLS0gCkRldnJpbSBHw5xORMOcWgpQb3N0Z3JlU1FMIFJlcGxpY2F0aW9uLCBDb25zdWx0
aW5nLCBDdXN0b20gRGV2ZWxvcG1lbnQsIDI0eDcgc3VwcG9ydApNYW5hZ2VkIFNlcnZpY2VzLCBT
aGFyZWQgYW5kIERlZGljYXRlZCBIb3N0aW5nCkNvLUF1dGhvcnM6IHBsUEhQLCBPREJDbmcgLSBo
dHRwOi8vd3d3LmNvbW1hbmRwcm9tcHQuY29tLwoKCi0tLS0tLS0tLS0tLS0tIG5leHQgcGFydCAt
LS0tLS0tLS0tLS0tLQpBIG5vbi10ZXh0IGF0dGFjaG1lbnQgd2FzIHNjcnViYmVkLi4uCk5hbWU6
IG5vdCBhdmFpbGFibGUKVHlwZTogYXBwbGljYXRpb24vcGdwLXNpZ25hdHVyZQpTaXplOiAxODkg
Ynl0ZXMKRGVzYzogVGhpcyBpcyBhIGRpZ2l0YWxseSBzaWduZWQgbWVzc2FnZSBwYXJ0ClVybCA6
IGh0dHA6Ly9saXN0cy5zbG9ueS5pbmZvL3BpcGVybWFpbC9zbG9ueTEtZ2VuZXJhbC9hdHRhY2ht
ZW50cy8yMDA3MDYyNi8wNzQ5YjQwMS9hdHRhY2htZW50LnBncAo=
From jpfletch at ca.afilias.info  Mon Jun 25 14:49:35 2007
From: jpfletch at ca.afilias.info (JP Fletcher)
Date: Mon Jun 25 14:50:02 2007
Subject: [Slony1-general] Just about ready for 1.2.10?
In-Reply-To: <60vedc2l72.fsf@dba2.int.libertyrms.com>
References: <60vedc2l72.fsf@dba2.int.libertyrms.com>
Message-ID: <4680386F.6090703@ca.afilias.info>

Just finished successful tests on AIX 5.3, pg8.2.4, FWIW.

JP


Christopher Browne wrote:
> I have heard about positive test results on Windows and AIX, and
> between Jan and I, Linux and FreeBSD also have "test successes."
>
> The "pre2" test tarball has been out for a few days; haven't heard any
> negative reports in a while.
>
> In the absence of negative reports, I think it's getting time for a
> release...  Last calls???
>   


-- 
JP Fletcher
Database Administrator
Afilias Canada
voice: 416.646.3304 ext. 4123
fax: 416.646.3305
mobile: 416.561.4763
jpfletch@ca.afilias.info


From cbbrowne at ca.afilias.info  Mon Jun 25 14:51:34 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Mon Jun 25 14:51:44 2007
Subject: [Slony1-general] Just about ready for 1.2.10?
In-Reply-To: <1182807093.3171.27.camel@laptop.gunduz.org>
References: <60vedc2l72.fsf@dba2.int.libertyrms.com>
	<1182807093.3171.27.camel@laptop.gunduz.org>
Message-ID: <468038E6.2060301@ca.afilias.info>

Devrim G?ND?Z wrote:
> Hello,
>
> On Mon, 2007-06-25 at 09:54 -0400, Christopher Browne wrote:
>
>   
>> In the absence of negative reports, I think it's getting time for a
>> release...  Last calls??? 
>>     
>
> Please give me some time until tomorrow for packaging stuff -- I'll
> package it tomorrow, as soon as I wake up.
>   
I'll hold for that...

I have heard more positive test reports concerning AIX, FreeBSD, so
that's all tending in the right direction...
From z-saito at guitar.ocn.ne.jp  Mon Jun 25 19:57:56 2007
From: z-saito at guitar.ocn.ne.jp (Hiroshi Saito)
Date: Mon Jun 25 19:57:55 2007
Subject: [Slony1-general] Just about ready for 1.2.10?
References: <60vedc2l72.fsf@dba2.int.libertyrms.com><1182807093.3171.27.camel@laptop.gunduz.org>
	<468038E6.2060301@ca.afilias.info>
Message-ID: <01df01c7b79d$cc2eb4f0$c701a8c0@HP22720319231>

Hi.

As for windows(MinGW). The additional Ver8.2.4 test finished safely.!
http://winpg.jp/~saito/Slony-I-sample/slony1-1.2.10-pg8.2.4-test.txt

Regards,
Hiroshi Saito

> Devrim G?ND?Z wrote:
>> Hello,
>>
>> On Mon, 2007-06-25 at 09:54 -0400, Christopher Browne wrote:
>>
>>
>>> In the absence of negative reports, I think it's getting time for a
>>> release...  Last calls???
>>>
>>
>> Please give me some time until tomorrow for packaging stuff -- I'll
>> package it tomorrow, as soon as I wake up.
>>
> I'll hold for that...
>
> I have heard more positive test reports concerning AIX, FreeBSD, so
> that's all tending in the right direction...
> _______________________________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general 

From vivek at khera.org  Mon Jun 25 20:04:58 2007
From: vivek at khera.org (Vivek Khera)
Date: Mon Jun 25 20:05:26 2007
Subject: [Slony1-general] Proposal to revise debugging levels a bit
In-Reply-To: <60ps3k2gup.fsf@dba2.int.libertyrms.com>
References: <60ps3k2gup.fsf@dba2.int.libertyrms.com>
Message-ID: <A23CB849-8E49-47D3-9B1E-6315925513E8@khera.org>


On Jun 25, 2007, at 11:28 AM, Christopher Browne wrote:

>  - Informational things would be logged at level INFO
>  - Configuration logs  would be logged at level CONFIG
>

I like this idea too.  Personally, I think that all events up to  
current DEBUG3 that happen on the replica during subscribe should be  
logged at INFO level.
From darcyb at commandprompt.com  Mon Jun 25 20:35:20 2007
From: darcyb at commandprompt.com (Darcy Buskermolen)
Date: Mon Jun 25 20:35:44 2007
Subject: [Slony1-general] Proposal to revise debugging levels a bit
In-Reply-To: <A23CB849-8E49-47D3-9B1E-6315925513E8@khera.org>
References: <60ps3k2gup.fsf@dba2.int.libertyrms.com>
	<A23CB849-8E49-47D3-9B1E-6315925513E8@khera.org>
Message-ID: <200706252035.20719.darcyb@commandprompt.com>

On June 25, 2007 08:04 pm, Vivek Khera wrote:
> On Jun 25, 2007, at 11:28 AM, Christopher Browne wrote:
> >  - Informational things would be logged at level INFO
> >  - Configuration logs  would be logged at level CONFIG
>
> I like this idea too.  Personally, I think that all events up to
> current DEBUG3 that happen on the replica during subscribe should be
> logged at INFO level.
I still have a number of pet peeves about the subscription process, namely 
it's lack of a way to guess your progress on large dataset subscribes.  There 
is a bit of background on an implementation idea regarding this in the to-do 
section of the wiki.
> __________________  _____________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general

-- 
Darcy Buskermolen
Command Prompt, Inc.
+1.503.667.4564 X 102
http://www.commandprompt.com/
PostgreSQL solutions since 1997
From devrim at CommandPrompt.com  Mon Jun 25 22:34:45 2007
From: devrim at CommandPrompt.com (Devrim =?ISO-8859-1?Q?G=DCND=DCZ?=)
Date: Mon Jun 25 22:37:51 2007
Subject: [Slony1-general] Just about ready for 1.2.10?
In-Reply-To: <468038E6.2060301@ca.afilias.info>
References: <60vedc2l72.fsf@dba2.int.libertyrms.com>
	<1182807093.3171.27.camel@laptop.gunduz.org>
	<468038E6.2060301@ca.afilias.info>
Message-ID: <1182836085.8251.2.camel@laptop.gunduz.org>

SGVsbG8sCgpPbiBNb24sIDIwMDctMDYtMjUgYXQgMjE6NTEgKzAwMDAsIENocmlzdG9waGVyIEJy
b3duZSB3cm90ZToKCj4gPiBQbGVhc2UgZ2l2ZSBtZSBzb21lIHRpbWUgdW50aWwgdG9tb3Jyb3cg
Zm9yIHBhY2thZ2luZyBzdHVmZiAtLSBJJ2xsCj4gPiBwYWNrYWdlIGl0IHRvbW9ycm93LCBhcyBz
b29uIGFzIEkgd2FrZSB1cC4KPiA+ICAgCj4gSSdsbCBob2xkIGZvciB0aGF0Li4uIAoKT2ssIEkg
aGF2ZSBzb21lIHByb2JsZW1zIHdpdGggcGVybWlzc2lvbnMgb2YgZG9jcywgYnV0IEkgY2FuIHNv
bHZlIHRoYXQKaW4gc3BlYyBmaWxlLiBZb3UgbWF5IHJlbGVhc2UgdGhlIGhvbGQ6KQoKSSB3aWxs
IG5vdCBiZSBhYmxlIHRvIHRlc3QgaXQgdGhpcyB3ZWVrIG9uIEZlZG9yYS9SZWQgSGF0LCBzaW5j
ZSBJJ20gYXQKYSBSSENFIHRyYWluaW5nIHRoaXMgd2Vlay4KClRoYW5rcywKClJlZ2FyZHMsCi0t
IApEZXZyaW0gR8OcTkTDnFoKUG9zdGdyZVNRTCBSZXBsaWNhdGlvbiwgQ29uc3VsdGluZywgQ3Vz
dG9tIERldmVsb3BtZW50LCAyNHg3IHN1cHBvcnQKTWFuYWdlZCBTZXJ2aWNlcywgU2hhcmVkIGFu
ZCBEZWRpY2F0ZWQgSG9zdGluZwpDby1BdXRob3JzOiBwbFBIUCwgT0RCQ25nIC0gaHR0cDovL3d3
dy5jb21tYW5kcHJvbXB0LmNvbS8KCgotLS0tLS0tLS0tLS0tLSBuZXh0IHBhcnQgLS0tLS0tLS0t
LS0tLS0KQSBub24tdGV4dCBhdHRhY2htZW50IHdhcyBzY3J1YmJlZC4uLgpOYW1lOiBub3QgYXZh
aWxhYmxlClR5cGU6IGFwcGxpY2F0aW9uL3BncC1zaWduYXR1cmUKU2l6ZTogMTg5IGJ5dGVzCkRl
c2M6IFRoaXMgaXMgYSBkaWdpdGFsbHkgc2lnbmVkIG1lc3NhZ2UgcGFydApVcmwgOiBodHRwOi8v
bGlzdHMuc2xvbnkuaW5mby9waXBlcm1haWwvc2xvbnkxLWdlbmVyYWwvYXR0YWNobWVudHMvMjAw
NzA2MjYvZTE5NmZlN2EvYXR0YWNobWVudC5wZ3AK
From JanWieck at Yahoo.com  Tue Jun 26 10:23:02 2007
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Tue Jun 26 10:23:22 2007
Subject: [Slony1-general] Can't drop/recreate slave node
In-Reply-To: <46802D44.3070509@emolecules.com>
References: <467C1469.2070201@emolecules.com>		<20070622142913.47bd37f0.wmoran@collaborativefusion.com>		<5a0a9d6f0706221310o1975f2bci5d8b063c144ff2be@mail.gmail.com>		<467C3B21.9090006@emolecules.com>
	<467FF7E5.20304@emolecules.com>	<5a0a9d6f0706251038s65289e7fm9eeb99c284815f41@mail.gmail.com>
	<46802D44.3070509@emolecules.com>
Message-ID: <46814B76.50208@Yahoo.com>

On 6/25/2007 5:01 PM, Craig James wrote:
> Oops!  Sorry about that last message, I sent from the wrong email, then resent the reply rather than this!  Mea culpa.  Here's what I should have sent...
> 
> Andrew Hammond wrote:
>> On 6/25/07, Craig James <craig_james@emolecules.com> wrote:
>>> I'm having trouble dropping and re-creating a node.  I'm trying to 
>>> develop some scripts that will handle a failover situation and the 
>>> subsequent cleanup.  When dropping a node, here's what I'm doing:
>>>
>>>     slonik <<_EOF_
>>>     cluster name = global_cluster;
>>>     node 1 admin conninfo = 'dbname=global host=host1 user=postgres';
>>>     node 2 admin conninfo = 'dbname=global host=host2 user=postgres';
>>>     uninstall node (id = 2);
>>>     _EOF_
>>>
>>>     ... drop the slave database
>>>     ... recreate the slave database schema
>> 
>> Are you waiting for this event to propagate? Because it looks like
>> you're just running this second script immediately.
> 
> Yes, I am waiting.  The "script" I showed is actually four separate steps: Drop the node, destroy the database, recreate the schema, and recreate the node.  Just to be sure, I ran the first step, waited, and watched the slon(1) daemon's log.  When it showed, "cannot get sl_local_node_id - ERROR:  schema "_global_cluster" does not exist", I figured the event had propagated.

Doesn't matter. UNINSTALL NODE only cleans up the schema of node 2 in 
this case. It does not implicitly do a DROP NODE.


Jan

-- 
#======================================================================#
# It's easier to get forgiveness for being wrong than for being right. #
# Let's break this rule - forgive me.                                  #
#================================================== JanWieck@Yahoo.com #
From cbbrowne at ca.afilias.info  Tue Jun 26 11:44:40 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Tue Jun 26 11:44:53 2007
Subject: [Slony1-general] Slony-I 1.2.10 Released
Message-ID: <60tzsu1ron.fsf@dba2.int.libertyrms.com>

After a considerable fix+test+refix+retest(+++) period, we are pleased
to announce the availability of version 1.2.10 of the Slony-I
replication system for PostgreSQL.  Listed below are the release notes
indicating the changes made since 1.2.10.

Thanks to all that reported issues, fixed bugs, and helped validate
things by running regression tests.

RELEASE 1.2.10

- Fixed problem with EXECUTE SCRIPT (EXECUTE ONLY ON = <node>)

  - The script was being executed on too many nodes...

- Added a test script for log shipping

  ... And alter it to add invocation of a DDL script.  This
  allows testing for an event-counting problem in log shipping.

- Changes to support PostgreSQL 8.3 as VARATT_SIZEP has been deprecated

- in xxid.c, changes to support PostgreSQL 8.3 as tuple compression has
  more extensive support

  VARDATA_ANY(PG_DETOAST_DATUM_PACKED((PG_GETARG_DATUM(0))))
  tends to replace
  PG_GETARG_VARLENA(0)

- Slonik's SYNC command never recorded the new seqno in the admin
  conninfo, with potential wacky results for WAIT FOR EVENT

- Fix rpm build problem when the system has pg_config in both under
  /usr/local/pgsql/bin and /usr/bin

- Add init script for Red Hat / Fedora

- Fix archive log ship tracking. Slon now tracks the setsync status in
  memory and generates a void archive with the correct old,new event
  seqno for all events.

- EXECUTE SCRIPT wasn't setting sl_setsync, which broke WAIT FOR EVENT
  on these events

- Ducttape test #5 (which performs DDL changes) augmented to test use
  of WAIT FOR EVENT

- Backpatch fixes for restricted text casts in 8.3

  create_event() calls (notably, but they're not alone) need to be
  augmented to cast data types expressly.

- PostgreSQL 8.3 is now a supported version for 1.2.10

  The hope/intent is that 1.2.10 will be the last version of Slony-I
  in the "1.x" series, and will permit upgrades to PostgreSQL 8.3.
  The subsequent Slony-I 2.x series will require PostgreSQL 8.3.

- Discovered and documented a problem with UPDATE FUNCTIONS on
  versions 8.1.[0-3].

- Fixes to log shipping test

- Win32 fix for MinGW+gcc

- cvs distclean changed to clean the build up more...

- On copy_set() check that we have forwarded the confirmation of
  ENABLE_SUBSCRIPTION by the data provider only if the data provider
  is not the origin of the set.

- For logshipping we need to use the internally tracked ssy_seqno for
  SYNC events as well.  

  This allows "run_test.sh testlogship" to run successfully!
-- 
select 'cbbrowne' || '@' || 'linuxdatabases.info';
http://www3.sympatico.ca/cbbrowne/advocacy.html
Rules of the  Evil Overlord #187. "I will not  hold lavish banquets in
the middle of  a famine. The good PR among the  guests doesn't make up
for the bad PR among the masses."  <http://www.eviloverlord.com/>
From jerry at jerrysievers.com  Tue Jun 26 11:53:38 2007
From: jerry at jerrysievers.com (Jerry Sievers)
Date: Tue Jun 26 11:53:50 2007
Subject: [Slony1-general] Cann all of this be batched? 
Message-ID: <m3sl8ea6od.fsf@mama.jerrysievers.com>

Hello;

Existing cluster with 1 set; 1 provider and 3 subscribers.  Adding
several new tables and sequences.

Slony 1.1.5

-- begin;
storeset(2, 'foo');
setaddtable(...);
...
setaddsequence(...);
...
subscribeset(...);
subscribeset(...);
subscribeset(...);
mergeset(1,2);   <-- is this OK?
commit;

Please advise.  I'm curious and assume the merge will happen at the
right time when all subscribers reach the subscribed state?

Or do I need to verify completed subscriptions first before issuing
the merge command? 

Thanks


-------------------------------------------------------------------------------
Jerry Sievers   732 365-2844 (work)     Production Database Administrator
                305 321-1144 (mobil	WWW E-Commerce Consultant
From bnichols at ca.afilias.info  Tue Jun 26 12:00:27 2007
From: bnichols at ca.afilias.info (Brad Nicholson)
Date: Tue Jun 26 12:00:17 2007
Subject: [Slony1-general] Cann all of this be batched?
In-Reply-To: <m3sl8ea6od.fsf@mama.jerrysievers.com>
References: <m3sl8ea6od.fsf@mama.jerrysievers.com>
Message-ID: <1182884427.8543.5.camel@bnicholson-desktop>

On Tue, 2007-06-26 at 14:53 -0400, Jerry Sievers wrote:
> Hello;
> 
> Existing cluster with 1 set; 1 provider and 3 subscribers.  Adding
> several new tables and sequences.
> 
> Slony 1.1.5
> 
> -- begin;
> storeset(2, 'foo');
> setaddtable(...);
> ...
> setaddsequence(...);
> ...
> subscribeset(...);
> subscribeset(...);
> subscribeset(...);
> mergeset(1,2);   <-- is this OK?
> commit;
> 
> Please advise.  I'm curious and assume the merge will happen at the
> right time when all subscribers reach the subscribed state?
> 
> Or do I need to verify completed subscriptions first before issuing
> the merge command? 


I don't know what checks are in place against this, but if it was me,
I'd wait until the subs were done before merging.

Brad

From emailqstis at gmail.com  Tue Jun 26 19:12:31 2007
From: emailqstis at gmail.com (Dewi Andriyanti)
Date: Tue Jun 26 19:12:46 2007
Subject: [Slony1-general] Replication System via VPN
Message-ID: <a68bc3110706261912y6ac88d75u1b4b09cce29ba676@mail.gmail.com>

I intend to build a replication system via VPN using Slony but I need more
reference. Is Slony good in data integrity, consistency, reliability and
response time? Is Slony better than PGCluster? What is drawbacks of Slony?
Would anybody help me to share stable configuration for replication system
via VPN using Slony?

Best Regard,
Dewi Andriyanti
Jakarta
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070627/=
3e82f348/attachment.htm
From JMatthewKelly at gmail.com  Wed Jun 27 02:19:17 2007
From: JMatthewKelly at gmail.com (Matthew Kelly)
Date: Wed Jun 27 02:19:37 2007
Subject: [Slony1-general] Cant replicate database
Message-ID: <8e74e4880706270219i41187bb2ib5fa082be485b646@mail.gmail.com>

Hi

Please can someone assist me? Im trying to replicate a database to another
machine. All the scripts and commands run without any errors but no data
gets copied over. Here is the script I use to prepare the databases, :


#--
# define the namespace the replication system uses in our example it is
# slony_example
#--

cluster name =3D sloncluster;

#--
# admin conninfo's are used by slonik to connect to the nodes one for each
# node on each side of the cluster, the syntax is that of PQconnectdb in
# the C-API
# --

node 1 admin conninfo =3D 'dbname=3Dmaster host=3D192.168.10.1 port=3D5432
user=3Dpostgres';
node 2 admin conninfo =3D 'dbname=3Dslave host=3D192.168.10.2 port=3D5432
user=3Dpostgres';

#--
# init the first node.  Its id MUST be 1.  This creates the schema
# _$CLUSTERNAME containing all replication system specific database
# objects.
#--

init cluster ( id=3D1, comment =3D 'Master Node');

#--
# Because the history table does not have a primary key or other unique
# constraint that could be used to identify a row, we need to add one.
# The following command adds a bigint column named
# _Slony-I_$CLUSTERNAME_rowID to the table.  It will have a default value
# of nextval('_$CLUSTERNAME.s1_rowid_seq'), and have UNIQUE and NOT NULL
# constraints applied.  All existing rows will be initialized with a
# number
#--

table add key (node id =3D 1, fully qualified name =3D 'public.mims');
table add key (node id =3D 1, fully qualified name =3D 'public.manufacturer=
');
table add key (node id =3D 1, fully qualified name =3D 'public.temppatient'=
);
table add key (node id =3D 1, fully qualified name =3D 'public.medpraxtomim=
s');
table add key (node id =3D 1, fully qualified name =3D 'public.possiblealia=
sfor
');

#--
# Slony-I organizes tables into sets.  The smallest unit a node can
# subscribe is a set.  The following commands create one set containing
# all 4 pgbench tables.  The master or origin of the set is node 1.
#--

create set (id=3D1, origin=3D1, comment=3D'All Tables and Sequences');
set add table (set id=3D1, origin=3D1, id=3D1, fully qualified name =3D '
public.address', comment=3D'address table');
set add table (set id=3D1, origin=3D1, id=3D2, fully qualified name =3D '
public.contactdetails', comment=3D'contactdetails table');
set add table (set id=3D1, origin=3D1, id=3D3, fully qualified name =3D '
public.correspondence', comment=3D'correspondence table');
set add table (set id=3D1, origin=3D1, id=3D4, fully qualified name =3D '
public.diary', comment=3D'diary table');
set add table (set id=3D1, origin=3D1, id=3D5, fully qualified name =3D '
public.diarydispatch', comment=3D'diarydispatch table');
set add table (set id=3D1, origin=3D1, id=3D6, fully qualified name =3D '
public.diaryfollowup', comment=3D'diaryfollowup table');
set add table (set id=3D1, origin=3D1, id=3D7, fully qualified name =3D '
public.diarypredispense', comment=3D'diarypredispense table');
set add table (set id=3D1, origin=3D1, id=3D8, fully qualified name =3D '
public.doctor', comment=3D'doctor table');
set add table (set id=3D1, origin=3D1, id=3D9, fully qualified name =3D '
public.event', comment=3D'event table');
set add table (set id=3D1, origin=3D1, id=3D10, fully qualified name =3D '
public.feedline', comment=3D'feedline table');
set add table (set id=3D1, origin=3D1, id=3D11, fully qualified name =3D '
public.feedlineerror', comment=3D'feedlineerror table');
set add table (set id=3D1, origin=3D1, id=3D12, fully qualified name =3D '
public.manufacturer', comment=3D'manufacturer table', key =3D serial);
set add table (set id=3D1, origin=3D1, id=3D13, fully qualified name =3D '
public.medprax', comment=3D'medprax table');
set add table (set id=3D1, origin=3D1, id=3D14, fully qualified name =3D '
public.medpraxtomims', comment=3D'medpraxtomims table', key =3D serial);
set add table (set id=3D1, origin=3D1, id=3D15, fully qualified name =3D '
public.messagetemplate', comment=3D'messagetemplate table');
set add table (set id=3D1, origin=3D1, id=3D16, fully qualified name =3D '
public.mims', comment=3D'mims table', key =3D serial);
set add table (set id=3D1, origin=3D1, id=3D17, fully qualified name =3D '
public.operator', comment=3D'operator table');
set add table (set id=3D1, origin=3D1, id=3D18, fully qualified name =3D '
public.patient', comment=3D'patient table');
set add table (set id=3D1, origin=3D1, id=3D19, fully qualified name =3D '
public.patientflag', comment=3D'patientflag table');
set add table (set id=3D1, origin=3D1, id=3D20, fully qualified name =3D '
public.patientmedicalaiddetails', comment=3D'patientmedicalaiddetails table=
');
set add table (set id=3D1, origin=3D1, id=3D21, fully qualified name =3D '
public.pharmacies', comment=3D'pharmacies table');
set add table (set id=3D1, origin=3D1, id=3D22, fully qualified name =3D '
public.pharmacy', comment=3D'pharmacy table');
set add table (set id=3D1, origin=3D1, id=3D23, fully qualified name =3D '
public.possiblealiasfor', comment=3D'possiblealiasfor table', key =3D seria=
l);
set add table (set id=3D1, origin=3D1, id=3D24, fully qualified name =3D '
public.prescription', comment=3D'prescription table');
set add table (set id=3D1, origin=3D1, id=3D25, fully qualified name =3D '
public.product', comment=3D'product table');
set add table (set id=3D1, origin=3D1, id=3D26, fully qualified name =3D '
public.temppatient', comment=3D'temppatient table', key =3D serial);
set add sequence (set id =3D 1, origin =3D 1, id =3D 27, full qualified nam=
e =3D '
public.hibernate_sequence', comment =3D 'Sequence hibernate_sequence');

#--
# Create the second node (the slave) tell the 2 nodes how to connect to
# each other and how they should listen for events.
#--

store node (id=3D2, comment =3D 'Slave node');
store path (server =3D 1, client =3D 2, conninfo=3D'dbname=3Dmaster
host=3D192.168.0.1port=3D5432 user=3Dpostgres');
store path (server =3D 2, client =3D 1, conninfo=3D'dbname=3Dslave
host=3D192.168.0.2port=3D5432 user=3Dpostgres');
store listen (origin=3D1, provider =3D 1, receiver =3D2);
store listen (origin=3D2, provider =3D 2, receiver =3D1);



Then to initialize the replication I use:

# ----
# This defines which namespace the replication system uses
# ----

cluster name =3D sloncluster;

# ----
# Admin conninfo's are used by the slonik program to connect
# to the node databases.  So these are the PQconnectdb arguments
# that connect from the administrators workstation (where
# slonik is executed).
# ----

node 1 admin conninfo =3D 'dbname=3Dmaster host=3D192.168.0.1 port=3D5432
user=3Dpostgres';
node 2 admin conninfo =3D 'dbname=3Dslave host=3D192.168.0.2 port=3D5432
user=3Dpostgres';

# ----
# Node 2 subscribes set 1
# ----

subscribe set ( id =3D 1, provider =3D 1, receiver =3D 2, forward =3D no);



Regards,

Matthew
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070627/=
085a90c0/attachment.htm
From stephane.schildknecht at postgresqlfr.org  Wed Jun 27 03:35:35 2007
From: stephane.schildknecht at postgresqlfr.org (=?ISO-8859-1?Q?St=E9phane_Schildknecht?=)
Date: Wed Jun 27 03:36:10 2007
Subject: [Slony1-general] Slony-I 1.2.10 Released
In-Reply-To: <60tzsu1ron.fsf@dba2.int.libertyrms.com>
References: <60tzsu1ron.fsf@dba2.int.libertyrms.com>
Message-ID: <46823D77.7030608@postgresqlfr.org>

Christopher Browne a ?crit :
> After a considerable fix+test+refix+retest(+++) period, we are pleased
> to announce the availability of version 1.2.10 of the Slony-I
> replication system for PostgreSQL.  Listed below are the release notes
> indicating the changes made since 1.2.10.
>   
Hi,

I was wondering where I could find up to date RPM packages, as it seems
the ones on the website are still 1.2.2-1. Am I wrong ?

Thanks.

Regards,

SAS

-- 
St?phane SCHILDKNECHT
Pr?sident de PostgreSQLFr
06 13 60 37 44 - 09 53 69 97 12
http://www.PostgreSQLFr.org

From vivek at khera.org  Wed Jun 27 07:54:35 2007
From: vivek at khera.org (Vivek Khera)
Date: Wed Jun 27 07:54:41 2007
Subject: [Slony1-general] Replication System via VPN
In-Reply-To: <a68bc3110706261912y6ac88d75u1b4b09cce29ba676@mail.gmail.com>
References: <a68bc3110706261912y6ac88d75u1b4b09cce29ba676@mail.gmail.com>
Message-ID: <CF623B8A-2A45-4453-96A6-CEB329BEED5C@khera.org>


On Jun 26, 2007, at 10:12 PM, Dewi Andriyanti wrote:

> Would anybody help me to share stable configuration for replication  
> system via VPN using Slony?

The only difference I would imagine from running nodes locally would  
be latency and bandwidth of the network.  Latency won't be much of a  
problem, but bandwidth may be.  If you push more changes to your  
origin then you can transfer over the network (via the VPN) over the  
same time period you'll keep falling behind on your replication.

But in terms of configuration, you should not have anything different  
just because of the VPN.

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070627/22f4cd7f/attachment.htm
From craig_james at emolecules.com  Wed Jun 27 08:31:13 2007
From: craig_james at emolecules.com (Craig James)
Date: Wed Jun 27 08:26:44 2007
Subject: [Slony1-general] Cant replicate database
In-Reply-To: <8e74e4880706270219i41187bb2ib5fa082be485b646@mail.gmail.com>
References: <8e74e4880706270219i41187bb2ib5fa082be485b646@mail.gmail.com>
Message-ID: <468282C1.1000101@emolecules.com>

Matthew Kelly wrote:
> Please can someone assist me? Im trying to replicate a database to 
> another machine. All the scripts and commands run without any errors but 
> no data gets copied over. Here is the script I use to prepare the 
> databases, :

You don't say whether or not you started the slon(1) daemon programs.  If they're not started, nothing will happen.  On my system, they're started like this (once per server):

  slon -d 0 global_cluster "dbname=global user=postgres" >/tmp/slon.log 2>&1 &

Once it starts, you should see considerable activity in the /tmp/slon.log file.

Craig
From mdavidson at cctus.com  Wed Jun 27 09:34:33 2007
From: mdavidson at cctus.com (Melvin Davidson)
Date: Wed Jun 27 09:34:16 2007
Subject: [Slony1-general] RE: Cant replicate database
In-Reply-To: <20070627152646.65D4C290C17@main.slony.info>
Message-ID: <2CC69F840555CB43B04195F218CCB57F9A102E@COENGEX01.cctus.com>

>#--
>init cluster ( id=3D1, comment =3D 'Master Node');

>create set (id=3D1, origin=3D1, comment=3D'All Tables and Sequences'); 

Actually, I'm surprised this works at all.

id's must be numeric.
>From the slony documentation:

http://main.slony.info/documentation/stmtstorenode.html

http://main.slony.info/documentation/stmtcreateset.html

http://main.slony.info/documentation/stmtsetaddtable.html


"ID = ival

    The unique, numeric ID number of the new node.


 SET ID = ival

    ID of the set to which the table is to be added. 
"

  ival in all cases means INTEGER VALUE

Perhaps if you assigned numeric integer values to nodes & sets,
it would start working?

Melvin Davidson
Database Developer
Computer & Communication Technologies, Inc.
6 Inverness Court East, Suite 220
Englewood, CO  80112
-------------- next part --------------
A non-text attachment was scrubbed...
Name: Melvin Davidson.vcf
Type: text/x-vcard
Size: 407 bytes
Desc: Melvin Davidson.vcf
Url : http://lists.slony.info/pipermail/slony1-general/attachments/20070627/2764f830/MelvinDavidson.vcf
From ajs at crankycanuck.ca  Wed Jun 27 12:20:14 2007
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Wed Jun 27 12:20:37 2007
Subject: [Slony1-general] Replication System via VPN
In-Reply-To: <a68bc3110706261912y6ac88d75u1b4b09cce29ba676@mail.gmail.com>
References: <a68bc3110706261912y6ac88d75u1b4b09cce29ba676@mail.gmail.com>
Message-ID: <20070627192014.GA27069@phlogiston.dyndns.org>

On Wed, Jun 27, 2007 at 10:12:31AM +0800, Dewi Andriyanti wrote:
> I intend to build a replication system via VPN using Slony but I need more
> reference. Is Slony good in data integrity, consistency, reliability and
> response time? Is Slony better than PGCluster? What is drawbacks of Slony?
> Would anybody help me to share stable configuration for replication system
> via VPN using Slony?

What's the bandwidth available inside the VPN?  You need to make sure
you can propagate the changes fast enough.  I don't believe PGCluster
can work over wide areas -- I think it has to be local.

A

-- 
Andrew Sullivan  | ajs@crankycanuck.ca
The fact that technology doesn't work is no bar to success in the marketplace.
		--Philip Greenspun
From stephane.schildknecht at postgresqlfr.org  Wed Jun 27 14:00:37 2007
From: stephane.schildknecht at postgresqlfr.org (=?ISO-8859-1?Q?St=E9phane_Schildknecht?=)
Date: Wed Jun 27 14:01:03 2007
Subject: [Slony1-general] RE: Cant replicate database
In-Reply-To: <2CC69F840555CB43B04195F218CCB57F9A102E@COENGEX01.cctus.com>
References: <2CC69F840555CB43B04195F218CCB57F9A102E@COENGEX01.cctus.com>
Message-ID: <4682CFF5.8050103@postgresqlfr.org>

Melvin Davidson a ?crit :
>> #--
>> init cluster ( id=3D1, comment =3D 'Master Node');
>>     
>
>   
>> create set (id=3D1, origin=3D1, comment=3D'All Tables and Sequences'); 
>>     
>
> Actually, I'm surprised this works at all.
>
> id's must be numeric.
> >From the slony documentation:
>
>   
Seems like you took misinterpretation of your mail client for an error
which had not even been thought !

In the original message I got, 3D stands for a whitespace.

Cheers,

SAS
From vivek at khera.org  Thu Jun 28 06:55:30 2007
From: vivek at khera.org (Vivek Khera)
Date: Thu Jun 28 06:55:43 2007
Subject: [Slony1-general] RE: Cant replicate database
In-Reply-To: <4682CFF5.8050103@postgresqlfr.org>
References: <2CC69F840555CB43B04195F218CCB57F9A102E@COENGEX01.cctus.com>
	<4682CFF5.8050103@postgresqlfr.org>
Message-ID: <CE69E23D-CF15-4344-B546-18047ACBEEF8@khera.org>


On Jun 27, 2007, at 5:00 PM, St?phane Schildknecht wrote:

> In the original message I got, 3D stands for a whitespace.

Actually, no. The =3D three-character string is the quoted-printable  
representation of the = symbol.  The = symbol is used to introduce  
the QP characters, so it has to be encoded itself.

From JanWieck at Yahoo.com  Thu Jun 28 09:26:40 2007
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Thu Jun 28 09:26:52 2007
Subject: [Slony1-general] Replication System via VPN
In-Reply-To: <20070627192014.GA27069@phlogiston.dyndns.org>
References: <a68bc3110706261912y6ac88d75u1b4b09cce29ba676@mail.gmail.com>
	<20070627192014.GA27069@phlogiston.dyndns.org>
Message-ID: <4683E140.1080607@Yahoo.com>

On 6/27/2007 3:20 PM, Andrew Sullivan wrote:
> On Wed, Jun 27, 2007 at 10:12:31AM +0800, Dewi Andriyanti wrote:
>> I intend to build a replication system via VPN using Slony but I need more
>> reference. Is Slony good in data integrity, consistency, reliability and
>> response time? Is Slony better than PGCluster? What is drawbacks of Slony?
>> Would anybody help me to share stable configuration for replication system
>> via VPN using Slony?
> 
> What's the bandwidth available inside the VPN?  You need to make sure
> you can propagate the changes fast enough.  I don't believe PGCluster
> can work over wide areas -- I think it has to be local.

On a connection with limited bandwidth (like Internet) I experienced 
that using a VPN with data compression will actually increase the Slony 
communication. There is definitely a turning point where the overhead of 
compression doesn't keep up with the network bandwidth. Where exactly 
that is depends on the speed of whatever does the compression and of 
course the bandwidth. As with all benchmarks, you have to test YOUR case 
yourself.


Jan

-- 
#======================================================================#
# It's easier to get forgiveness for being wrong than for being right. #
# Let's break this rule - forgive me.                                  #
#================================================== JanWieck@Yahoo.com #
From JanWieck at Yahoo.com  Thu Jun 28 09:43:24 2007
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Thu Jun 28 09:43:47 2007
Subject: [Slony1-general] Cann all of this be batched?
In-Reply-To: <1182884427.8543.5.camel@bnicholson-desktop>
References: <m3sl8ea6od.fsf@mama.jerrysievers.com>
	<1182884427.8543.5.camel@bnicholson-desktop>
Message-ID: <4683E52C.5030406@Yahoo.com>

On 6/26/2007 3:00 PM, Brad Nicholson wrote:
> On Tue, 2007-06-26 at 14:53 -0400, Jerry Sievers wrote:
>> Hello;
>> 
>> Existing cluster with 1 set; 1 provider and 3 subscribers.  Adding
>> several new tables and sequences.
>> 
>> Slony 1.1.5
>> 
>> -- begin;
>> storeset(2, 'foo');
>> setaddtable(...);
>> ...
>> setaddsequence(...);
>> ...
>> subscribeset(...);
>> subscribeset(...);
>> subscribeset(...);
>> mergeset(1,2);   <-- is this OK?
>> commit;
>> 
>> Please advise.  I'm curious and assume the merge will happen at the
>> right time when all subscribers reach the subscribed state?
>> 
>> Or do I need to verify completed subscriptions first before issuing
>> the merge command? 
> 
> 
> I don't know what checks are in place against this, but if it was me,
> I'd wait until the subs were done before merging.

It is possible ... with 1.2.10, which has finally a working SYNC and 
WAIT FOR EVENT. The merge set must NOT be issued before all the 
subscribers are completely done with their subscriptions. No cascaded 
subscribe set commands should be issued before their data providers are 
done with their subscriptions either. Note that waiting for a subscribe 
set is a sequence of waiting for the subscribe itself being confirmed by 
the set origin, then issuing a slonik SYNC and waiting on the origin for 
that to be confirmed by the new subscriber.


Jan

-- 
#======================================================================#
# It's easier to get forgiveness for being wrong than for being right. #
# Let's break this rule - forgive me.                                  #
#================================================== JanWieck@Yahoo.com #
From dmitry at koterov.ru  Thu Jun 28 12:02:41 2007
From: dmitry at koterov.ru (Dmitry Koterov)
Date: Thu Jun 28 12:02:50 2007
Subject: [Slony1-general] Backslashes inside an update statement for slonik
	are stripped
Message-ID: <d7df81620706281202h10ac8986h45d31cffbcdf6a78@mail.gmail.com>

Hello.

I feed the slonik with the following SQL:

DDL Statement 2: (299,471) [

CREATE UNIQUE INDEX "i_dictionary_uni_abbr" ON "static"."dictionary"
  USING btree ((substring(dic_russian, E'^([^(]*[^( ]) *\\('::text)))
  WHERE (dic_category_id =3D 26);

] DDL Statement failed - PGRES_FATAL_ERROR


You see, it generates an error. Here is a portion of postgres logs:

2007-06-28 18:56:55 GMT 87.250.244.99(55965)ERROR:  invalid regular
expression: parentheses () not balanced
2007-06-28 18:56:55 GMT 87.250.244.99(55965)STATEMENT:
        CREATE UNIQUE INDEX "i_dictionary_uni_abbr" ON "static"."dictionary"
          USING btree ((substring(dic_russian, E'^([^(]*[^( ]) *\('::text)))
          WHERE (dic_category_id =3D 26);


Note the \\( part above: it is sent to the server as \(.
Seems slonik replaces \\ by \ before sending it to postgres?
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070628/=
4b159cf2/attachment.htm
From devrim at CommandPrompt.com  Thu Jun 28 12:27:07 2007
From: devrim at CommandPrompt.com (Devrim =?ISO-8859-1?Q?G=DCND=DCZ?=)
Date: Thu Jun 28 12:30:49 2007
Subject: [Slony1-general] Slony-I 1.2.10 Released
In-Reply-To: <46823D77.7030608@postgresqlfr.org>
References: <60tzsu1ron.fsf@dba2.int.libertyrms.com>
	<46823D77.7030608@postgresqlfr.org>
Message-ID: <1183058827.6214.11.camel@laptop.gunduz.org>

SGVsbG8sCgpPbiBXZWQsIDIwMDctMDYtMjcgYXQgMTI6MzUgKzAyMDAsIFN0w6lwaGFuZSBTY2hp
bGRrbmVjaHQgd3JvdGU6Cj4gSSB3YXMgd29uZGVyaW5nIHdoZXJlIEkgY291bGQgZmluZCB1cCB0
byBkYXRlIFJQTSBwYWNrYWdlcywgYXMgaXQKPiBzZWVtcyB0aGUgb25lcyBvbiB0aGUgd2Vic2l0
ZSBhcmUgc3RpbGwgMS4yLjItMS4gQW0gSSB3cm9uZyA/IAoKUGxlYXNlIHJ1bgoKLi9jb25maWd1
cmUKbWFrZSBycG0KCmZvciBjcmVhdGluZyBSUE1TLiBJIGFtIHRyeWluZyB0byBwdXNoIFNsb255
LUkgdG8gRmVkb3JhICsgUkhFTC4gSWYgSQpjYW4gc3VjY2VlZCwgeW91IHdpbGwgYmUgYWJsZSB0
byBkb3dubG9hZCBSUE1zIHZpYSB5dW0gYW5kIHRoYXQgd2lsbAptYWtlIG91ciBsaXZlcyBlYXNp
ZXIgLS0gYW5kIEkgcGxhbiB0byBzdG9wIHVwbG9hZGluZyBSUE1zIHRvIHNsb255LUkKc2l0ZS4K
ClJlZ2FyZHMsCi0tIApEZXZyaW0gR8OcTkTDnFoKUG9zdGdyZVNRTCBSZXBsaWNhdGlvbiwgQ29u
c3VsdGluZywgQ3VzdG9tIERldmVsb3BtZW50LCAyNHg3IHN1cHBvcnQKTWFuYWdlZCBTZXJ2aWNl
cywgU2hhcmVkIGFuZCBEZWRpY2F0ZWQgSG9zdGluZwpDby1BdXRob3JzOiBwbFBIUCwgT0RCQ25n
IC0gaHR0cDovL3d3dy5jb21tYW5kcHJvbXB0LmNvbS8KCgotLS0tLS0tLS0tLS0tLSBuZXh0IHBh
cnQgLS0tLS0tLS0tLS0tLS0KQSBub24tdGV4dCBhdHRhY2htZW50IHdhcyBzY3J1YmJlZC4uLgpO
YW1lOiBub3QgYXZhaWxhYmxlClR5cGU6IGFwcGxpY2F0aW9uL3BncC1zaWduYXR1cmUKU2l6ZTog
MTg5IGJ5dGVzCkRlc2M6IFRoaXMgaXMgYSBkaWdpdGFsbHkgc2lnbmVkIG1lc3NhZ2UgcGFydApV
cmwgOiBodHRwOi8vbGlzdHMuc2xvbnkuaW5mby9waXBlcm1haWwvc2xvbnkxLWdlbmVyYWwvYXR0
YWNobWVudHMvMjAwNzA2MjgvN2JiNGMzYTkvYXR0YWNobWVudC5wZ3AK
From cbbrowne at ca.afilias.info  Thu Jun 28 12:45:51 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Thu Jun 28 12:45:59 2007
Subject: [Slony1-general] Slony-I 1.2.10 Released
In-Reply-To: <1183058827.6214.11.camel@laptop.gunduz.org>
References: <60tzsu1ron.fsf@dba2.int.libertyrms.com>	
	<46823D77.7030608@postgresqlfr.org>
	<1183058827.6214.11.camel@laptop.gunduz.org>
Message-ID: <46840FEF.7090602@ca.afilias.info>

Devrim G?ND?Z wrote:
> Hello,
>
> On Wed, 2007-06-27 at 12:35 +0200, St?phane Schildknecht wrote:
>   
>> I was wondering where I could find up to date RPM packages, as it
>> seems the ones on the website are still 1.2.2-1. Am I wrong ? 
>>     
>
> Please run
>
> ./configure
> make rpm
>
> for creating RPMS. I am trying to push Slony-I to Fedora + RHEL. If I
> can succeed, you will be able to download RPMs via yum and that will
> make our lives easier -- and I plan to stop uploading RPMs to slony-I
> site.
>   
I'll see about adding that to the news page...
From ch.nolte at noltec.org  Wed Jun 20 00:26:25 2007
From: ch.nolte at noltec.org (Christian Nolte)
Date: Thu Jun 28 16:31:42 2007
Subject: [Slony1-general] Extension for the xxid data type cannot be loaded:
 please extend documentation/firstdb.html
Message-ID: <4678D6A1.5020409@noltec.org>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Hi!

I've played around with Slony-I today and followed the steps mentioned
in the documentation (2. Replicating Your First Database). I've made a
mistake in specifying the $PGBENCHUSER instead of $REPLICATIONUSER in
the node-conninfo of the slonik-script and the following error message
came up:

<stdin>:21: PGRES_FATAL_ERROR load '$libdir/xxid';  - FEHLER:  Zugriff
auf Bibliothek ?$libdir/xxid? ist nicht erlaubt
<stdin>:21: Error: the extension for the xxid data type cannot be loaded
in database 'dbname=pgbench host=localhost user=pgbench'
<stdin>:21: ERROR: no admin conninfo for node 158081320

I could not find anything using my favorite search-engine which
mentioned the access rights of the user who makes the connection.
Instead there only were mentioned missing installations of slony on the
cluster-nodes or wrong versions of postgresql.

Perhaps you could add this information in the same style as the warning
in the documentation (2. Replicating Your First Database). I guess this
makes a lot of headaches go away.

Best regards
Christian

- --

Christian Nolte

mailto:ch.nolte@noltec.org

key : http://www.noltec.org/christian-nolte.asc
or  : www.keyserver.net

      GPG-fingerprint:
      1088 6C2D 1496 0A34 D159 1108 08D8 C0D2 77E1 5BBC
- ----------------------------------------------------------------------
For more than 4 generations the IT Professionals were the guardians
of quality and stability in software. Before the dark times.
Before Microsoft...
- ----------------------------------------------------------------------
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.7 (GNU/Linux)
Comment: Using GnuPG with Fedora - http://enigmail.mozdev.org

iD8DBQFGeNagCNjA0nfhW7wRAtTbAJ4j2A6Na/7b2s7G6G6bluU0u7K/SwCgu/bD
Z8Iq/egYzyqKwGPj7HcjMXM=
=GEUx
-----END PGP SIGNATURE-----
From cbbrowne at mail.libertyrms.com  Wed Jun 27 13:05:28 2007
From: cbbrowne at mail.libertyrms.com (Christopher Browne)
Date: Thu Jun 28 16:31:43 2007
Subject: [Slony1-general] Replication System via VPN
In-Reply-To: <20070627192014.GA27069@phlogiston.dyndns.org> (Andrew Sullivan's
	message of "Wed, 27 Jun 2007 15:20:14 -0400")
References: <a68bc3110706261912y6ac88d75u1b4b09cce29ba676@mail.gmail.com>
	<20070627192014.GA27069@phlogiston.dyndns.org>
Message-ID: <601wfx88on.fsf@dba2.int.libertyrms.com>

Andrew Sullivan <ajs@crankycanuck.ca> writes:
> On Wed, Jun 27, 2007 at 10:12:31AM +0800, Dewi Andriyanti wrote:
>> I intend to build a replication system via VPN using Slony but I need more
>> reference. Is Slony good in data integrity, consistency, reliability and
>> response time? Is Slony better than PGCluster? What is drawbacks of Slony?
>> Would anybody help me to share stable configuration for replication system
>> via VPN using Slony?
>
> What's the bandwidth available inside the VPN?  You need to make sure
> you can propagate the changes fast enough.  I don't believe PGCluster
> can work over wide areas -- I think it has to be local.

I haven't seen any discussion of PGCluster in a while; the thing that
has been discussed a lot more of late has been PGCluster-2.

That's a system which shares parts of PostgreSQL shared memory across
the network; I would expect that to perform extraordinarily badly
across a WAN.  If PGCluster uses a similar architecture, then the same
would presumably be true.  I'm not sure they are identical that way,
though...
-- 
select 'cbbrowne' || '@' || 'ca.afilias.info';
<http://dba2.int.libertyrms.com/>
Christopher Browne
(416) 673-4124 (land)
From cbbrowne at mail.libertyrms.com  Wed Jun 27 15:34:03 2007
From: cbbrowne at mail.libertyrms.com (Christopher Browne)
Date: Thu Jun 28 16:31:45 2007
Subject: [Slony1-general] A "drafty" start at logging test runs
Message-ID: <60hcot6n8k.fsf@dba2.int.libertyrms.com>

I have started doing some instrumentation with the following results:

I'm not sure I'm keen about the tester's identity :-) but the rest is
looking pretty good thus far...

cbb@[local]:5834=# select * from slony_tests;
-[ RECORD 1 ]---+------------------------------------------------------------------------------------------------------------------
id              | 10
smoduleversion  | 2.0.0
sv_major        | 2
sv_minor        | 0
sv_patch        | 0
pg_version      | PostgreSQL 8.3devel on i686-pc-linux-gnu, compiled by GCC gcc (GCC) 4.1.3 20070601 (prerelease) (Debian 4.1.2-12)
uname_m         | i686
uname_r         | 2.6.20-1-686
uname_s         | Linux
uname_v         | #1 SMP Tue Apr 24 21:52:11 UTC 2007
hostname        | dba2.int.libertyrms.com
tester_identity | j.random.luser@example.net
testname        | test1
start_time      | 2007-06-27 22:21:02+00
end_time        | 2007-06-27 22:22:32+00
successful      | t
failure_desc    | 
-[ RECORD 2 ]---+------------------------------------------------------------------------------------------------------------------
id              | 11
smoduleversion  | 2.0.0
sv_major        | 2
sv_minor        | 0
sv_patch        | 0
pg_version      | PostgreSQL 8.3devel on i686-pc-linux-gnu, compiled by GCC gcc (GCC) 4.1.3 20070601 (prerelease) (Debian 4.1.2-12)
uname_m         | i686
uname_r         | 2.6.20-1-686
uname_s         | Linux
uname_v         | #1 SMP Tue Apr 24 21:52:11 UTC 2007
hostname        | dba2.int.libertyrms.com
tester_identity | j.random.luser@example.net
testname        | testdatestyles
start_time      | 2007-06-27 22:22:33+00
end_time        | 2007-06-27 22:23:33+00
successful      | t
failure_desc    | 
-[ RECORD 3 ]---+------------------------------------------------------------------------------------------------------------------
id              | 12
smoduleversion  | 2.0.0
sv_major        | 2
sv_minor        | 0
sv_patch        | 0
pg_version      | PostgreSQL 8.3devel on i686-pc-linux-gnu, compiled by GCC gcc (GCC) 4.1.3 20070601 (prerelease) (Debian 4.1.2-12)
uname_m         | i686
uname_r         | 2.6.20-1-686
uname_s         | Linux
uname_v         | #1 SMP Tue Apr 24 21:52:11 UTC 2007
hostname        | dba2.int.libertyrms.com
tester_identity | j.random.luser@example.net
testname        | testinherit
start_time      | 2007-06-27 22:27:03+00
end_time        | 2007-06-27 22:28:19+00
successful      | t
failure_desc    | 
-[ RECORD 4 ]---+------------------------------------------------------------------------------------------------------------------
id              | 13
smoduleversion  | 2.0.0
sv_major        | 2
sv_minor        | 0
sv_patch        | 0
pg_version      | PostgreSQL 8.3devel on i686-pc-linux-gnu, compiled by GCC gcc (GCC) 4.1.3 20070601 (prerelease) (Debian 4.1.2-12)
uname_m         | i686
uname_r         | 2.6.20-1-686
uname_s         | Linux
uname_v         | #1 SMP Tue Apr 24 21:52:11 UTC 2007
hostname        | dba2.int.libertyrms.com
tester_identity | j.random.luser@example.net
testname        | testlargetuples
start_time      | 2007-06-27 22:28:20+00
end_time        | 2007-06-27 22:32:49+00
successful      | t
failure_desc    | 


-- 
output = reverse("ofni.sailifa.ac" "@" "enworbbc")
<http://dba2.int.libertyrms.com/>
Christopher Browne
(416) 673-4124 (land)
From cbbrowne at mail.libertyrms.com  Thu Jun 28 15:17:25 2007
From: cbbrowne at mail.libertyrms.com (Christopher Browne)
Date: Thu Jun 28 16:31:46 2007
Subject: [Slony1-general] Soliciting ideas for v2.0
Message-ID: <60tzsr67wq.fsf@dba2.int.libertyrms.com>

The v2.0 branch has already taken on the following fairly significant
changes (listed below).  Jan and I had a chat this afternoon about
some items still to do:

I'm working on: 

- getting the scripted tests to generate some SQL INSERT statements
summarizing the way the tests went; that would very much ease
collecting data about conformance

- more doc improvements on the removal of TABLE ADD KEY

Jan is looking at:

- Make some of the queries that ultimately determine which sl_log_[12]
  data needs to be replicated work better under the condition where a
  subscription runs for a very long time

Other items coming along are:

- Improving LISTEN/UNLISTEN logic to be much quieter
- better listen path generation

There's a further "wish list" we're looking at, for which it seems
timely to solicit additions:

- CANCEL SUBSCRIPTION - e.g. - cancel a failing subscription.

- Some mechanism to permit renaming tables and modifying data on the
  way in to a subscriber.

- Clone Node - to allow using pg_dump/PITR to populate a new
  subscriber node.

Are there more items we should try to add?

$Id: RELEASE-2.0,v 1.3 2007-06-27 15:54:37 cbbrowne Exp $

Differences from 1.2 stream

- Removal of TABLE ADD KEY

- It drops all support for databases prior to Postgres version 8.3.

This is required because we now make use of new functionality in
Postgres, namely the trigger and rule support for session replication
role. As of now, every node (origin/subscriber/mixed) can be dumped with
pg_dump and result in a consistent snapshot of the database.

- Still need alterTableRestore() for the upgrade from 1.2.x to 2.0.
upgradeSchema() will restore the system catalog to a consistent
state and define+configure the new versions of the log and deny_access
triggers. 

- Fix EXECUTE SCRIPT so that it records the ev_seqno for WAIT FOR EVENT
and make sure all DDL is executed in session_replication_role "local"
on the origin as well as all subscribers. This will cause the slony
triggers to ignore all DML statements while user triggers follow the
regular configuration options for ENABLE [REPLICA/ALWAYS] or DISABLE.

- Let the logshipping files also switch to session_replication_role =
"replica" or "local" (for DDL).

- Sequence tracking becomes enormously less expensive; rather than
polling *ALL* sequence values for each and every SYNC, the slon
stores the last value, and only records entries in sl_seqlog when
the value changes from that last value.  If most sequences are
relatively inactive, they won't require entries in sl_seqlog very
often.

- Change to tools/slony1_dump.sh (used to generate log shipping dump);
  change quoting of "\\\backslashes\\\" to get rid of warning

- Cleanup thread revised to push most of the logic to evaluate which
  tables are to be vacuumed into a pair of stored functions.

  This fairly massively simplifies the C code.

- Revised logging levels so that most of the interesting messages are
  spit out at SLON_CONFIG and SLON_INFO levels.  This can allow users
  to drop out the higher DEBUG levels and still have useful logs.

-- 
output = reverse("ofni.sailifa.ac" "@" "enworbbc")
<http://dba2.int.libertyrms.com/>
Christopher Browne
(416) 673-4124 (land)
From cjames at emolecules.com  Fri Jun 22 11:06:38 2007
From: cjames at emolecules.com (Craig A. James)
Date: Thu Jun 28 16:32:17 2007
Subject: [Slony1-general] Is "Node 1" special? Failover and Switchover
Message-ID: <467C0FAE.8000205@emolecules.com>

When you create a cluster, it appears that "Node 1" is special -- there doesn't seem to be a "store node 1" command to create "node 1" in the first place, whereas for subsequent nodes, you have to issue "store node N".  Now, suppose node 1 happens to crash and burn, and I use "failover" to make Node 2 the master.  Questions:

Does Node 2 stay node 2, or does it become node 1?  (I'm pretty sure it stays node 2, but I want to be certain).

If I get node 1's server back online, discard its database, and recreate the schema, can I use add it to the cluster as "node 1" again, or do I need to pick a different node number?

Thanks,
Craig
From cjames at emolecules.com  Mon Jun 25 13:54:45 2007
From: cjames at emolecules.com (Craig A. James)
Date: Thu Jun 28 16:32:18 2007
Subject: [Slony1-general] Can't drop/recreate slave node
In-Reply-To: <5a0a9d6f0706251038s65289e7fm9eeb99c284815f41@mail.gmail.com>
References: <467C1469.2070201@emolecules.com>	
	<20070622142913.47bd37f0.wmoran@collaborativefusion.com>	
	<5a0a9d6f0706221310o1975f2bci5d8b063c144ff2be@mail.gmail.com>	
	<467C3B21.9090006@emolecules.com> <467FF7E5.20304@emolecules.com>
	<5a0a9d6f0706251038s65289e7fm9eeb99c284815f41@mail.gmail.com>
Message-ID: <46802B95.4040509@emolecules.com>

Andrew Hammond wrote:
> On 6/25/07, Craig James <craig_james@emolecules.com> wrote:
>> I'm having trouble dropping and re-creating a node.  I'm trying to 
>> develop some scripts that will handle a failover situation and the 
>> subsequent cleanup.  When dropping a node, here's what I'm doing:
>>
>>     slonik <<_EOF_
>>     cluster name = global_cluster;
>>     node 1 admin conninfo = 'dbname=global host=host1 user=postgres';
>>     node 2 admin conninfo = 'dbname=global host=host2 user=postgres';
>>     uninstall node (id = 2);
>>     _EOF_
>>
>>     ... drop the slave database
>>     ... recreate the slave database schema
> 
> Are you waiting for this event to propagate? Because it looks like
> you're just running this second script immediately.

Yes, I am waiting.  The "script" I showed is actually four separate steps: Drop the node, destroy the database, recreate the schema, and recreate the node.  Just to be sure, I ran the first step, waited, and watched the slon(1) daemon's log.  When it showed, "cannot get sl_local_node_id - ERROR:  schema "_global_cluster" does not exist", I figured the event had propagated.

Thanks,
Craig


From drees76 at gmail.com  Thu Jun 28 17:26:48 2007
From: drees76 at gmail.com (David Rees)
Date: Thu Jun 28 17:26:59 2007
Subject: [Slony1-general] Slony-I 1.2.10 Released
In-Reply-To: <1183058827.6214.11.camel@laptop.gunduz.org>
References: <60tzsu1ron.fsf@dba2.int.libertyrms.com>
	<46823D77.7030608@postgresqlfr.org>
	<1183058827.6214.11.camel@laptop.gunduz.org>
Message-ID: <72dbd3150706281726i3b0f728as47043f8eca63ca30@mail.gmail.com>

On 6/28/07, Devrim G?ND?Z <devrim@commandprompt.com> wrote:
> Please run
>
> ./configure
> make rpm
>
> for creating RPMS. I am trying to push Slony-I to Fedora + RHEL. If I
> can succeed, you will be able to download RPMs via yum and that will
> make our lives easier -- and I plan to stop uploading RPMs to slony-I
> site.

This is the bug that is used for tracking the status of getting
Slony-I into Fedora/EPEL if anyone is interested in following or
helping with the process:

https://bugzilla.redhat.com/bugzilla/show_bug.cgi?id=199154

-Dave
From rod at iol.ie  Fri Jun 29 03:16:11 2007
From: rod at iol.ie (Raymond O'Donnell)
Date: Fri Jun 29 03:16:31 2007
Subject: [Slony1-general] Soliciting ideas for v2.0
In-Reply-To: <60tzsr67wq.fsf@dba2.int.libertyrms.com>
References: <60tzsr67wq.fsf@dba2.int.libertyrms.com>
Message-ID: <4684DBEB.70602@iol.ie>

On 28/06/2007 23:17, Christopher Browne wrote:

> There's a further "wish list" we're looking at, for which it seems
> timely to solicit additions:

Maybe I'm missing something blindingly obvious (I'm pretty inexperienced 
with Slony), but would it be possible to produce a tool that allows a 
dump of a replicated node *without* all the extra stuff Slony adds - the 
extra schema, triggers, etc. - in other words, output similar to that 
produced by pg_dump on an unreplicated database? - preferably a binary 
application rather than a shell script, so it can be used on Windows 
machines also.

As I say, maybe I'm missing something.....please point me in the right 
direction if I am.

Thanks,

Ray.

---------------------------------------------------------------
Raymond O'Donnell, Director of Music, Galway Cathedral, Ireland
rod@iol.ie
---------------------------------------------------------------
From plk.zuber at gmail.com  Fri Jun 29 03:58:27 2007
From: plk.zuber at gmail.com (=?UTF-8?Q?Filip_Rembia=C5=82kowski?=)
Date: Fri Jun 29 03:58:46 2007
Subject: [Slony1-general] Soliciting ideas for v2.0
In-Reply-To: <4684DBEB.70602@iol.ie>
References: <60tzsr67wq.fsf@dba2.int.libertyrms.com> <4684DBEB.70602@iol.ie>
Message-ID: <92869e660706290358l2d37b429k30bab22d55e868ae@mail.gmail.com>

2007/6/29, Raymond O'Donnell <rod@iol.ie>:
> On 28/06/2007 23:17, Christopher Browne wrote:
>
> > There's a further "wish list" we're looking at, for which it seems
> > timely to solicit additions:
>
> Maybe I'm missing something blindingly obvious (I'm pretty inexperienced
> with Slony), but would it be possible to produce a tool that allows a
> dump of a replicated node *without* all the extra stuff Slony adds - the
> extra schema, triggers, etc. - in other words, output similar to that
> produced by pg_dump on an unreplicated database?

Good point IMHO; similar need here. I guess many people need this.

To produce a "clean" dump ( that is, without Slony-I schema and
triggers ) we have to install temporary backup node, wait for it to
catch up, DROP NODE it , and dump it.  Whole process takes almost
twice longer as plain pg_dump (and is more failure-prone)


-- 
Filip Rembia?kowski
From stephane.schildknecht at postgresqlfr.org  Fri Jun 29 04:02:27 2007
From: stephane.schildknecht at postgresqlfr.org (=?ISO-8859-1?Q?St=E9phane_Schildknecht?=)
Date: Fri Jun 29 04:02:49 2007
Subject: [Slony1-general] Soliciting ideas for v2.0
In-Reply-To: <92869e660706290358l2d37b429k30bab22d55e868ae@mail.gmail.com>
References: <60tzsr67wq.fsf@dba2.int.libertyrms.com> <4684DBEB.70602@iol.ie>
	<92869e660706290358l2d37b429k30bab22d55e868ae@mail.gmail.com>
Message-ID: <4684E6C3.7060906@postgresqlfr.org>

Filip Rembia?kowski a ?crit :
> 2007/6/29, Raymond O'Donnell <rod@iol.ie>:
>> On 28/06/2007 23:17, Christopher Browne wrote:
>>
>> > There's a further "wish list" we're looking at, for which it seems
>> > timely to solicit additions:
>>
>> Maybe I'm missing something blindingly obvious (I'm pretty inexperienced
>> with Slony), but would it be possible to produce a tool that allows a
>> dump of a replicated node *without* all the extra stuff Slony adds - the
>> extra schema, triggers, etc. - in other words, output similar to that
>> produced by pg_dump on an unreplicated database?
>
> Good point IMHO; similar need here. I guess many people need this.
>
> To produce a "clean" dump ( that is, without Slony-I schema and
> triggers ) we have to install temporary backup node, wait for it to
> catch up, DROP NODE it , and dump it. Whole process takes almost
> twice longer as plain pg_dump (and is more failure-prone)
>
In order to get the schema, I personnaly use slony1_extract_schema.sh
and slony1_dump.sh to get the data.

Isn't it what you're looking for ?

Regards,

-- 
St?phane SCHILDKNECHT
Pr?sident de PostgreSQLFr
06 13 60 37 44 - 09 53 69 97 12
http://www.PostgreSQLFr.org

From rod at iol.ie  Fri Jun 29 04:14:36 2007
From: rod at iol.ie (Raymond O'Donnell)
Date: Fri Jun 29 04:14:57 2007
Subject: [Slony1-general] Soliciting ideas for v2.0
In-Reply-To: <4684E6C3.7060906@postgresqlfr.org>
References: <60tzsr67wq.fsf@dba2.int.libertyrms.com> <4684DBEB.70602@iol.ie>
	<92869e660706290358l2d37b429k30bab22d55e868ae@mail.gmail.com>
	<4684E6C3.7060906@postgresqlfr.org>
Message-ID: <4684E99C.3000805@iol.ie>

On 29/06/2007 12:02, St?phane Schildknecht wrote:

> In order to get the schema, I personnaly use slony1_extract_schema.sh
> and slony1_dump.sh to get the data.
> 
> Isn't it what you're looking for ?

I do manual backups from time to time from my Windows laptop, so 
Unix/Linux shell scripts aren't any use to me.


Ray.


---------------------------------------------------------------
Raymond O'Donnell, Director of Music, Galway Cathedral, Ireland
rod@iol.ie
---------------------------------------------------------------
From mpartio at gmail.com  Fri Jun 29 04:26:43 2007
From: mpartio at gmail.com (Mikko Partio)
Date: Fri Jun 29 04:27:02 2007
Subject: [Slony1-general] Soliciting ideas for v2.0
In-Reply-To: <92869e660706290358l2d37b429k30bab22d55e868ae@mail.gmail.com>
References: <60tzsr67wq.fsf@dba2.int.libertyrms.com> <4684DBEB.70602@iol.ie>
	<92869e660706290358l2d37b429k30bab22d55e868ae@mail.gmail.com>
Message-ID: <2ca799770706290426h41e336b6w687382a296d38fc@mail.gmail.com>

On 6/29/07, Filip Rembia=B3kowski <plk.zuber@gmail.com> wrote:
>
> 2007/6/29, Raymond O'Donnell <rod@iol.ie>:
> > On 28/06/2007 23:17, Christopher Browne wrote:
> >
> > > There's a further "wish list" we're looking at, for which it seems
> > > timely to solicit additions:
> >
> > Maybe I'm missing something blindingly obvious (I'm pretty inexperienced
> > with Slony), but would it be possible to produce a tool that allows a
> > dump of a replicated node *without* all the extra stuff Slony adds - the
> > extra schema, triggers, etc. - in other words, output similar to that
> > produced by pg_dump on an unreplicated database?
>
> Good point IMHO; similar need here. I guess many people need this.
>
> To produce a "clean" dump ( that is, without Slony-I schema and
> triggers ) we have to install temporary backup node, wait for it to
> catch up, DROP NODE it , and dump it.  Whole process takes almost
> twice longer as plain pg_dump (and is more failure-prone)
>
>
>
I think the developers have it on the "TODO" list:

----------------

Differences from 1.2 stream

- Removal of TABLE ADD KEY

- It drops all support for databases prior to Postgres version 8.3.

This is required because we now make use of new functionality in
Postgres, namely the trigger and rule support for session replication
role. As of now, every node (origin/subscriber/mixed) can be dumped with
pg_dump and result in a consistent snapshot of the database.

----------------

Regards

MP
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20070629/=
9c691aa2/attachment.htm
From cbbrowne at mail.libertyrms.com  Fri Jun 29 04:57:19 2007
From: cbbrowne at mail.libertyrms.com (Christopher Browne)
Date: Fri Jun 29 04:57:38 2007
Subject: [Slony1-general] Soliciting ideas for v2.0
In-Reply-To: <4684DBEB.70602@iol.ie> (Raymond O'Donnell's message of "Fri,
	29 Jun 2007 11:16:11 +0100")
References: <60tzsr67wq.fsf@dba2.int.libertyrms.com> <4684DBEB.70602@iol.ie>
Message-ID: <601wfv6kio.fsf@dba2.int.libertyrms.com>

Raymond O'Donnell <rod@iol.ie> writes:
> On 28/06/2007 23:17, Christopher Browne wrote:
>
>> There's a further "wish list" we're looking at, for which it seems
>> timely to solicit additions:
>
> Maybe I'm missing something blindingly obvious (I'm pretty
> inexperienced with Slony), but would it be possible to produce a tool
> that allows a dump of a replicated node *without* all the extra stuff
> Slony adds - the extra schema, triggers, etc. - in other words, output
> similar to that produced by pg_dump on an unreplicated database? -
> preferably a binary application rather than a shell script, so it can
> be used on Windows machines also.
>
> As I say, maybe I'm missing something.....please point me in the right
> direction if I am.

I think that's going to be an easily supported feature in 2.0 already.

- The dumps will be entirely consistent (e.g. - devoid of breakage due
to pg_catalog hacking) because the new 8.3 trigger handling makes it
unnecessary to "hack up" the system catalogue.

- You can use the pg_dump option "--exclude-schema" option to leave
out the extra schema, which will make triggers, functions, and such
fall away.

It won't quite be "automatic," but it will be plenty easier than it is
now...
-- 
let name="cbbrowne" and tld="ca.afilias.info" in String.concat "@" [name;tld];;
<http://dba2.int.libertyrms.com/>
Christopher Browne
(416) 673-4124 (land)
From ajs at crankycanuck.ca  Fri Jun 29 07:18:08 2007
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Fri Jun 29 07:18:26 2007
Subject: [Slony1-general] Soliciting ideas for v2.0
In-Reply-To: <4684DBEB.70602@iol.ie>
References: <60tzsr67wq.fsf@dba2.int.libertyrms.com> <4684DBEB.70602@iol.ie>
Message-ID: <20070629141808.GI32297@phlogiston.dyndns.org>

On Fri, Jun 29, 2007 at 11:16:11AM +0100, Raymond O'Donnell wrote:

> Maybe I'm missing something blindingly obvious (I'm pretty inexperienced 
> with Slony), but would it be possible to produce a tool that allows a 
> dump of a replicated node *without* all the extra stuff Slony adds 

Is there something that tools/slony1_dump.sh doesn't do that you
want?

A

-- 
Andrew Sullivan  | ajs@crankycanuck.ca
In the future this spectacle of the middle classes shocking the avant-
garde will probably become the textbook definition of Postmodernism. 
                --Brad Holland
From ajs at crankycanuck.ca  Fri Jun 29 07:19:19 2007
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Fri Jun 29 07:19:28 2007
Subject: [Slony1-general] Soliciting ideas for v2.0
In-Reply-To: <4684E99C.3000805@iol.ie>
References: <60tzsr67wq.fsf@dba2.int.libertyrms.com> <4684DBEB.70602@iol.ie>
	<92869e660706290358l2d37b429k30bab22d55e868ae@mail.gmail.com>
	<4684E6C3.7060906@postgresqlfr.org> <4684E99C.3000805@iol.ie>
Message-ID: <20070629141919.GJ32297@phlogiston.dyndns.org>

On Fri, Jun 29, 2007 at 12:14:36PM +0100, Raymond O'Donnell wrote:
> I do manual backups from time to time from my Windows laptop, so 
> Unix/Linux shell scripts aren't any use to me.

You can put a POSIX shell on your laptop ;-)  But I agree that this
is an area where the Slony Windows support lags.

A

-- 
Andrew Sullivan  | ajs@crankycanuck.ca
The fact that technology doesn't work is no bar to success in the marketplace.
		--Philip Greenspun
From rod at iol.ie  Fri Jun 29 07:36:28 2007
From: rod at iol.ie (Raymond O'Donnell)
Date: Fri Jun 29 07:36:37 2007
Subject: [Slony1-general] Soliciting ideas for v2.0
In-Reply-To: <20070629141808.GI32297@phlogiston.dyndns.org>
References: <60tzsr67wq.fsf@dba2.int.libertyrms.com> <4684DBEB.70602@iol.ie>
	<20070629141808.GI32297@phlogiston.dyndns.org>
Message-ID: <468518EC.30409@iol.ie>

On 29/06/2007 15:18, Andrew Sullivan wrote:

> Is there something that tools/slony1_dump.sh doesn't do that you
> want?

Well, I can't run it on my WinXP laptop! :-)

Ray.

---------------------------------------------------------------
Raymond O'Donnell, Director of Music, Galway Cathedral, Ireland
rod@iol.ie
---------------------------------------------------------------
From z-saito at guitar.ocn.ne.jp  Fri Jun 29 10:25:54 2007
From: z-saito at guitar.ocn.ne.jp (Hiroshi Saito)
Date: Fri Jun 29 10:26:03 2007
Subject: [Slony1-general] Soliciting ideas for v2.0
References: <60tzsr67wq.fsf@dba2.int.libertyrms.com>
	<4684DBEB.70602@iol.ie><20070629141808.GI32297@phlogiston.dyndns.org>
	<468518EC.30409@iol.ie>
Message-ID: <00bd01c7ba72$8c83e280$01324d80@hiroshi5jz7dqj>

From: "Raymond O'Donnell" <rod@iol.ie>

> On 29/06/2007 15:18, Andrew Sullivan wrote:
> 
>> Is there something that tools/slony1_dump.sh doesn't do that you
>> want?
> 
> Well, I can't run it on my WinXP laptop! :-)

Uga.., Please store as TODO for the time being. Although I want to realize it, 
I'm not spare time now.. Of course, the fact that other someone make will be 
welcomed.:-)

Regards,
Hiroshi Saito

From cbbrowne at mail.libertyrms.com  Fri Jun 29 11:04:49 2007
From: cbbrowne at mail.libertyrms.com (Christopher Browne)
Date: Fri Jun 29 11:05:01 2007
Subject: [Slony1-general] Soliciting ideas for v2.0
In-Reply-To: <00bd01c7ba72$8c83e280$01324d80@hiroshi5jz7dqj> (Hiroshi Saito's
	message of "Sat, 30 Jun 2007 02:25:54 +0900")
References: <60tzsr67wq.fsf@dba2.int.libertyrms.com> <4684DBEB.70602@iol.ie>
	<20070629141808.GI32297@phlogiston.dyndns.org> <468518EC.30409@iol.ie>
	<00bd01c7ba72$8c83e280$01324d80@hiroshi5jz7dqj>
Message-ID: <60hcoq63i6.fsf@dba2.int.libertyrms.com>

"Hiroshi Saito" <z-saito@guitar.ocn.ne.jp> writes:
> From: "Raymond O'Donnell" <rod@iol.ie>
>
>> On 29/06/2007 15:18, Andrew Sullivan wrote:
>>
>>> Is there something that tools/slony1_dump.sh doesn't do that you
>>> want?
>> Well, I can't run it on my WinXP laptop! :-)
>
> Uga.., Please store as TODO for the time being. Although I want to
> realize it, I'm not spare time now.. Of course, the fact that other
> someone make will be welcomed.:-)

I may poke at many parts of Slony-I for version 2.0; I can pretty much
guarantee that I *will not* be working on a Windows version of
slony1_dump.sh...
-- 
let name="cbbrowne" and tld="cbbrowne.com" in name ^ "@" ^ tld;;
http://linuxfinances.info/info/oses.html
Rules  of the  Evil Overlord  #61. "If  my advisors  ask "Why  are you
risking everything on such a mad  scheme?", I will not proceed until I
have a response that satisfies them." <http://www.eviloverlord.com/>
From pgsql at j-davis.com  Fri Jun 29 14:04:51 2007
From: pgsql at j-davis.com (Jeff Davis)
Date: Fri Jun 29 14:05:09 2007
Subject: [Slony1-general] Soliciting ideas for v2.0
In-Reply-To: <60tzsr67wq.fsf@dba2.int.libertyrms.com>
References: <60tzsr67wq.fsf@dba2.int.libertyrms.com>
Message-ID: <1183151091.28247.44.camel@dogma.v10.wvs>

On Thu, 2007-06-28 at 18:17 -0400, Christopher Browne wrote:
> Are there more items we should try to add?

Is there a good way to make it more efficient to do large
deletes/updates?

For instance, if the number of tuples that need to be deleted for a
transaction exceeds a certain amount, could we use a different process
for the delete on the subscriber so that it doesn't do millions of
single-tuple deletes?

I don't know exactly how that would work, perhaps by using a temporary
table on the subscriber and doing a single "DELETE FROM foo WHERE id IN
(SELECT id FROM foo_delete_tmp)" or something?

Regards,
	Jeff Davis

From cbbrowne at mail.libertyrms.com  Fri Jun 29 15:06:59 2007
From: cbbrowne at mail.libertyrms.com (Christopher Browne)
Date: Fri Jun 29 15:07:11 2007
Subject: [Slony1-general] Soliciting ideas for v2.0
In-Reply-To: <1183151091.28247.44.camel@dogma.v10.wvs> (Jeff Davis's message
	of "Fri, 29 Jun 2007 14:04:51 -0700")
References: <60tzsr67wq.fsf@dba2.int.libertyrms.com>
	<1183151091.28247.44.camel@dogma.v10.wvs>
Message-ID: <608xa25sak.fsf@dba2.int.libertyrms.com>

Jeff Davis <pgsql@j-davis.com> writes:
> On Thu, 2007-06-28 at 18:17 -0400, Christopher Browne wrote:
>> Are there more items we should try to add?
>
> Is there a good way to make it more efficient to do large
> deletes/updates?
>
> For instance, if the number of tuples that need to be deleted for a
> transaction exceeds a certain amount, could we use a different process
> for the delete on the subscriber so that it doesn't do millions of
> single-tuple deletes?
>
> I don't know exactly how that would work, perhaps by using a temporary
> table on the subscriber and doing a single "DELETE FROM foo WHERE id IN
> (SELECT id FROM foo_delete_tmp)" or something?

Ah, yes.

It would be nontrivial to improve this in the case of a multi-column
key, but if the candidate primary key consists of a single column, one
might be able to detect this.

Here's a sample, of sorts...

slonyregress1@[local]:5834=# select * from _slony_regress1.sl_log_1 where log_cmdtype = 'D' order by log_actionseq limit 10;
 log_origin | log_xid | log_tableid | log_actionseq | log_cmdtype | log_cmddata 
------------+---------+-------------+---------------+-------------+-------------
          1 | 3939096 |           2 |          9277 | D           | id='1'
          1 | 3939096 |           1 |          9278 | D           | id='1'
          1 | 3939096 |           2 |          9279 | D           | id='2'
          1 | 3939096 |           1 |          9280 | D           | id='2'
          1 | 3939096 |           2 |          9281 | D           | id='3'
          1 | 3939096 |           2 |          9282 | D           | id='4'
          1 | 3939096 |           2 |          9283 | D           | id='6'
          1 | 3939096 |           2 |          9284 | D           | id='9'
          1 | 3939096 |           2 |          9285 | D           | id='13'
          1 | 3939096 |           2 |          9286 | D           | id='18'
(10 rows)

This would normally get turned into:

delete from table2 where id = '1';
delete from table1 where id = '1';
delete from table2 where id = '2';
delete from table1 where id = '2';
... and so forth ...

It should, in principle, be possible to group together requests for one table, so that we could have the following:

delete from table2 where
   id = '3'
    or
   id = '4'
    or
   id = '6'
    or
   id = '9'
    or
   id = '13'
    or
   id = '18';

where this groups together the consecutive entries for table #2.

This actually still works for multiple-column PKs as long as we put
parentheses around each "log_cmddata" entry.  The win isn't in turning
this into a parser-challengingly-huge single query; it is in doing
several entries as one query, so I'd be inclined to let it start a new
DELETE request any time the size of the query reaches 100 tuples.

Looking at the update case...

slonyregress1@[local]:5834=# select * from _slony_regress1.sl_log_1 where log_cmdtype = 'U' order by log_actionseq limit 10; 
 log_origin | log_xid | log_tableid | log_actionseq | log_cmdtype |        log_cmddata         
------------+---------+-------------+---------------+-------------+----------------------------
          1 | 3943148 |           2 |         18633 | U           | data='foo' where id='8340'
          1 | 3943148 |           2 |         18634 | U           | data='foo' where id='8341'
          1 | 3943148 |           2 |         18635 | U           | data='foo' where id='8342'
          1 | 3943148 |           2 |         18636 | U           | data='foo' where id='8343'
          1 | 3943148 |           2 |         18637 | U           | data='foo' where id='8344'
          1 | 3943148 |           2 |         18638 | U           | data='foo' where id='8345'
          1 | 3943148 |           2 |         18639 | U           | data='foo' where id='8346'
          1 | 3943148 |           2 |         18640 | U           | data='foo' where id='8347'
          1 | 3943148 |           2 |         18641 | U           | data='foo' where id='8348'
          1 | 3943148 |           2 |         18642 | U           | data='foo' where id='8349'
(10 rows)

It would take some parsing of the log_cmddata to do this, nonetheless,
I think it ought to be possible to compress this into some smaller
number of queries.  Again, if we limited each query to process 100
tuples, at most, that would still seem like enough to call it a "win."

I'll take a look...
-- 
output = reverse("ofni.secnanifxunil" "@" "enworbbc")
http://www3.sympatico.ca/cbbrowne/rdbms.html
"When we write programs that "learn", it turns out that we do and they
don't." -- Alan J. Perlis
From bwillits at cox.net  Fri Jun 29 15:25:00 2007
From: bwillits at cox.net (Bill Willits)
Date: Fri Jun 29 15:25:27 2007
Subject: [Slony1-general] pg_dump, slony1_dump, sanity check
References: <1913126532.20070522144412@gmail.com>
	<20070522152016.GS22797@phlogiston.dyndns.org>
Message-ID: <008801c7ba9c$566bfa50$b601a8c0@bwlaptop>

> On Tue, May 22, 2007 at 02:44:12PM +0300, Konstantin Pakalenko wrote:
>>
>> pg_dump: failed sanity check, parent table OID 3441170 of pg_rewrite 
>> entry OID 55594 not found
>> pg_dump: *** aborted because of error
>
> Right.  You can't use pg_dump on a database that has any replicated
> table in it.
>

Can you explain if this is dependant on some version of PG or Slony?  Or, if 
it only occurs when dumping from the master? or slave?? I can't seem to get 
the error below when taking a dump of the database on a slave instance.  I 
also tested loading the dump file into an empty PG instance and got no 
errors.

Thanks,
Bill Willits

From andrew.george.hammond at gmail.com  Fri Jun 29 15:26:20 2007
From: andrew.george.hammond at gmail.com (Andrew Hammond)
Date: Fri Jun 29 15:26:30 2007
Subject: [Slony1-general] Slony-I 1.2.10 Released
In-Reply-To: <60tzsu1ron.fsf@dba2.int.libertyrms.com>
References: <60tzsu1ron.fsf@dba2.int.libertyrms.com>
Message-ID: <5a0a9d6f0706291526j4e6ff773o9f5cd0e52d668bd3@mail.gmail.com>

I was working on updating the FreeBSD package. I just noticed that
tools/mkservice/* isn't in the REL_1_2_STABLE branch (and hence not in
this tarball either), although it is in HEAD. Ironically, it is
slightly version dependant on 1.2 (although, the migration to 2.0
ought to be quite painless unless we change the slon.conf stuff too
much).

I was planning to use the mkservice stuff in the FreeBSD package. If I
push it into the package via the ports instead of taking it from the
tarball, that means that there are two different repositories being
used for it. Yuck.

Any ideas?

Andrew

On 6/26/07, Christopher Browne <cbbrowne@ca.afilias.info> wrote:
> After a considerable fix+test+refix+retest(+++) period, we are pleased
> to announce the availability of version 1.2.10 of the Slony-I
> replication system for PostgreSQL.  Listed below are the release notes
> indicating the changes made since 1.2.10.
>
> Thanks to all that reported issues, fixed bugs, and helped validate
> things by running regression tests.
>
> RELEASE 1.2.10
>
> - Fixed problem with EXECUTE SCRIPT (EXECUTE ONLY ON = <node>)
>
>   - The script was being executed on too many nodes...
>
> - Added a test script for log shipping
>
>   ... And alter it to add invocation of a DDL script.  This
>   allows testing for an event-counting problem in log shipping.
>
> - Changes to support PostgreSQL 8.3 as VARATT_SIZEP has been deprecated
>
> - in xxid.c, changes to support PostgreSQL 8.3 as tuple compression has
>   more extensive support
>
>   VARDATA_ANY(PG_DETOAST_DATUM_PACKED((PG_GETARG_DATUM(0))))
>   tends to replace
>   PG_GETARG_VARLENA(0)
>
> - Slonik's SYNC command never recorded the new seqno in the admin
>   conninfo, with potential wacky results for WAIT FOR EVENT
>
> - Fix rpm build problem when the system has pg_config in both under
>   /usr/local/pgsql/bin and /usr/bin
>
> - Add init script for Red Hat / Fedora
>
> - Fix archive log ship tracking. Slon now tracks the setsync status in
>   memory and generates a void archive with the correct old,new event
>   seqno for all events.
>
> - EXECUTE SCRIPT wasn't setting sl_setsync, which broke WAIT FOR EVENT
>   on these events
>
> - Ducttape test #5 (which performs DDL changes) augmented to test use
>   of WAIT FOR EVENT
>
> - Backpatch fixes for restricted text casts in 8.3
>
>   create_event() calls (notably, but they're not alone) need to be
>   augmented to cast data types expressly.
>
> - PostgreSQL 8.3 is now a supported version for 1.2.10
>
>   The hope/intent is that 1.2.10 will be the last version of Slony-I
>   in the "1.x" series, and will permit upgrades to PostgreSQL 8.3.
>   The subsequent Slony-I 2.x series will require PostgreSQL 8.3.
>
> - Discovered and documented a problem with UPDATE FUNCTIONS on
>   versions 8.1.[0-3].
>
> - Fixes to log shipping test
>
> - Win32 fix for MinGW+gcc
>
> - cvs distclean changed to clean the build up more...
>
> - On copy_set() check that we have forwarded the confirmation of
>   ENABLE_SUBSCRIPTION by the data provider only if the data provider
>   is not the origin of the set.
>
> - For logshipping we need to use the internally tracked ssy_seqno for
>   SYNC events as well.
>
>   This allows "run_test.sh testlogship" to run successfully!
> --
> select 'cbbrowne' || '@' || 'linuxdatabases.info';
> http://www3.sympatico.ca/cbbrowne/advocacy.html
> Rules of the  Evil Overlord #187. "I will not  hold lavish banquets in
> the middle of  a famine. The good PR among the  guests doesn't make up
> for the bad PR among the masses."  <http://www.eviloverlord.com/>
> _______________________________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
>
From andrew.george.hammond at gmail.com  Fri Jun 29 23:57:47 2007
From: andrew.george.hammond at gmail.com (Andrew Hammond)
Date: Fri Jun 29 23:58:04 2007
Subject: [Slony1-general] Soliciting ideas for v2.0
In-Reply-To: <608xa25sak.fsf@dba2.int.libertyrms.com>
References: <60tzsr67wq.fsf@dba2.int.libertyrms.com>
	<1183151091.28247.44.camel@dogma.v10.wvs>
	<608xa25sak.fsf@dba2.int.libertyrms.com>
Message-ID: <5a0a9d6f0706292357idf07fffpa130c1deb427d08b@mail.gmail.com>

On 6/29/07, Christopher Browne <cbbrowne@mail.libertyrms.com> wrote:
> Jeff Davis <pgsql@j-davis.com> writes:
> > On Thu, 2007-06-28 at 18:17 -0400, Christopher Browne wrote:
> >> Are there more items we should try to add?
> >
> > Is there a good way to make it more efficient to do large
> > deletes/updates?
> >
> > For instance, if the number of tuples that need to be deleted for a
> > transaction exceeds a certain amount, could we use a different process
> > for the delete on the subscriber so that it doesn't do millions of
> > single-tuple deletes?
> >
> > I don't know exactly how that would work, perhaps by using a temporary
> > table on the subscriber and doing a single "DELETE FROM foo WHERE id IN
> > (SELECT id FROM foo_delete_tmp)" or something?
>
> Ah, yes.
>
> It would be nontrivial to improve this in the case of a multi-column
> key, but if the candidate primary key consists of a single column, one
> might be able to detect this.
>
> Here's a sample, of sorts...
>
> slonyregress1@[local]:5834=# select * from _slony_regress1.sl_log_1 where log_cmdtype = 'D' order by log_actionseq limit 10;
>  log_origin | log_xid | log_tableid | log_actionseq | log_cmdtype | log_cmddata
> ------------+---------+-------------+---------------+-------------+-------------
>           1 | 3939096 |           2 |          9277 | D           | id='1'
>           1 | 3939096 |           1 |          9278 | D           | id='1'
>           1 | 3939096 |           2 |          9279 | D           | id='2'
>           1 | 3939096 |           1 |          9280 | D           | id='2'
>           1 | 3939096 |           2 |          9281 | D           | id='3'
>           1 | 3939096 |           2 |          9282 | D           | id='4'
>           1 | 3939096 |           2 |          9283 | D           | id='6'
>           1 | 3939096 |           2 |          9284 | D           | id='9'
>           1 | 3939096 |           2 |          9285 | D           | id='13'
>           1 | 3939096 |           2 |          9286 | D           | id='18'
> (10 rows)
>
> This would normally get turned into:
>
> delete from table2 where id = '1';
> delete from table1 where id = '1';
> delete from table2 where id = '2';
> delete from table1 where id = '2';
> ... and so forth ...
>
> It should, in principle, be possible to group together requests for one table, so that we could have the following:
>
> delete from table2 where
>    id = '3'
>     or
>    id = '4'
>     or
>    id = '6'
>     or
>    id = '9'
>     or
>    id = '13'
>     or
>    id = '18';
>
> where this groups together the consecutive entries for table #2.
>
> This actually still works for multiple-column PKs as long as we put
> parentheses around each "log_cmddata" entry.  The win isn't in turning
> this into a parser-challengingly-huge single query; it is in doing
> several entries as one query, so I'd be inclined to let it start a new
> DELETE request any time the size of the query reaches 100 tuples.

A really interesting win would be in detecting cases where you can go from

WHERE id IN ( a list )

to

WHERE a < id AND id < b

However I think this is only possible at the time the transaction
happens (how else will you know if your sequence is contigious. And
that suggests to me that it's not reasonable to do at this time.

Also, ISTM that the big reason we don't like statement based
replication is that SQL has many non-deterministic aspects. However,
there is probably a pretty darn big subset of SQL which is provably
non-deterministic. And for that subset, would it be any less rigorous
to transmit those statements than to transmit the per-row change
statments like we currently do?

> It would take some parsing of the log_cmddata to do this, nonetheless,
> I think it ought to be possible to compress this into some smaller
> number of queries.  Again, if we limited each query to process 100
> tuples, at most, that would still seem like enough to call it a "win."

I can see two places to find these wins. When the statement is parsed
(probably very affordable) and, as you mentioned above, by inspecting
the log tables. I think that we'd have to be pretty clever with the
log tables to avoid having it get too expensive. I wonder if full text
indexing with an "sql stemmer" might be clever way to index that data
usefully.

Two downsides of the parser approach that I can see are
1) the postgresql parser / planner is already plenty complex
2) it doesn't group stuff across multiple statements

Just some thoughts.

Andrew
From ajs at crankycanuck.ca  Sat Jun 30 06:09:58 2007
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Sat Jun 30 06:10:13 2007
Subject: [Slony1-general] pg_dump, slony1_dump, sanity check
In-Reply-To: <008801c7ba9c$566bfa50$b601a8c0@bwlaptop>
References: <1913126532.20070522144412@gmail.com>
	<20070522152016.GS22797@phlogiston.dyndns.org>
	<008801c7ba9c$566bfa50$b601a8c0@bwlaptop>
Message-ID: <20070630130958.GA3091@phlogiston.dyndns.org>

On Fri, Jun 29, 2007 at 03:25:00PM -0700, Bill Willits wrote:
> 
> Can you explain if this is dependant on some version of PG or Slony?  Or, 

PostgreSQL pg_dump prior to, I think, 8.1 (it might be 8.0) are not
quite as aggressive in checking for some of these errors, so you
don't get them when you dump the database.  Unfortunately, you get
garbage dumps.  When you restore, you run a serious risk of running
into problems you didn't know you could have.  This is because the
catalogue tables have been messed with by Slony.  So, any database
that has even _one_ replicated table in it (i.e. not the origin for
every table) should never be dumped using pg_dump.

A

-- 
Andrew Sullivan  | ajs@crankycanuck.ca
When my information changes, I alter my conclusions.  What do you do sir?
		--attr. John Maynard Keynes
From cbbrowne at mail.libertyrms.com  Sat Jun 30 07:16:11 2007
From: cbbrowne at mail.libertyrms.com (Christopher Browne)
Date: Sat Jun 30 07:16:21 2007
Subject: [Slony1-general] pg_dump, slony1_dump, sanity check
In-Reply-To: <20070630130958.GA3091@phlogiston.dyndns.org> (Andrew Sullivan's
	message of "Sat, 30 Jun 2007 09:09:58 -0400")
References: <1913126532.20070522144412@gmail.com>
	<20070522152016.GS22797@phlogiston.dyndns.org>
	<008801c7ba9c$566bfa50$b601a8c0@bwlaptop>
	<20070630130958.GA3091@phlogiston.dyndns.org>
Message-ID: <60wsxl5xzo.fsf@dba2.int.libertyrms.com>

Andrew Sullivan <ajs@crankycanuck.ca> writes:
> On Fri, Jun 29, 2007 at 03:25:00PM -0700, Bill Willits wrote:
>> 
>> Can you explain if this is dependant on some version of PG or Slony?  Or, 
>
> PostgreSQL pg_dump prior to, I think, 8.1 (it might be 8.0) are not
> quite as aggressive in checking for some of these errors, so you
> don't get them when you dump the database.  Unfortunately, you get
> garbage dumps.  When you restore, you run a serious risk of running
> into problems you didn't know you could have.  This is because the
> catalogue tables have been messed with by Slony.  So, any database
> that has even _one_ replicated table in it (i.e. not the origin for
> every table) should never be dumped using pg_dump.

There are two mods to be made to that "never"...

1.  It isn't true of the origin node.  On the origin node, the schema
isn't actually broken (because we aren't hiding triggers/rules).  You
*can*, *always*, run pg_dump successfully against the origin.

2.  The problem is with the system catalogue on the subscribers.  If
you run "pg_dump -a", to dump data only, it doesn't run into the
catalogue problem.

In Slony-I 2.0, on PG 8.3, this is all alleviated.  You can take a
pg_dump of a subscriber node and it will both work (e..g. - pg_dump
won't crash due to noticing busted catalogue info) and be consistent.
-- 
select 'cbbrowne' || '@' || 'ca.afilias.info';
<http://dba2.int.libertyrms.com/>
Christopher Browne
(416) 673-4124 (land)
From ajs at crankycanuck.ca  Sat Jun 30 11:17:18 2007
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Sat Jun 30 11:17:38 2007
Subject: [Slony1-general] pg_dump, slony1_dump, sanity check
In-Reply-To: <60wsxl5xzo.fsf@dba2.int.libertyrms.com>
References: <1913126532.20070522144412@gmail.com>
	<20070522152016.GS22797@phlogiston.dyndns.org>
	<008801c7ba9c$566bfa50$b601a8c0@bwlaptop>
	<20070630130958.GA3091@phlogiston.dyndns.org>
	<60wsxl5xzo.fsf@dba2.int.libertyrms.com>
Message-ID: <20070630181718.GA3806@phlogiston.dyndns.org>

On Sat, Jun 30, 2007 at 02:16:11PM +0000, Christopher Browne wrote:
> 
> 1.  It isn't true of the origin node.  On the origin node, the schema
> isn't actually broken (because we aren't hiding triggers/rules).  You
> *can*, *always*, run pg_dump successfully against the origin.

But there's no such thing as an origin node, purely; it's only true
of the origin node for a table; and pg_dump won't proceed if there is
even one table that is a replica, because that table has caused some
catalogue corruption.  You simply cannot pg_dump from a database that
has even _one_ replica in it, unless you are using an older pg_dump,
in which case you're missing a number of sanity checks that could
leave you with a broken dump.

> In Slony-I 2.0, on PG 8.3, this is all alleviated.  

Or will be, maybe, assuming the code arrives and works as advertised.
None of it exists yet.  (And I'd caution people against being too
keen to rush 2.0 into production. The .0 releases of Slony have so
far been plagued with really nasty bugs.  That's not surprising in
code as young as this, but it does nobody any good to pretend
otherwise.)

A

-- 
Andrew Sullivan  | ajs@crankycanuck.ca
Everything that happens in the world happens at some place.
		--Jane Jacobs 
