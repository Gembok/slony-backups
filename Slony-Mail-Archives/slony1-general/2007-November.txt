From stephen.hindmarch at bt.com  Thu Nov  1 04:30:13 2007
From: stephen.hindmarch at bt.com (stephen.hindmarch@bt.com)
Date: Thu Nov  1 04:31:15 2007
Subject: [Slony1-general] Bugs in configure-replication.sh
Message-ID: <614CEAAF10695543B87ED664C03A5DB204EFF744@E03MVX1-UKDY.domain1.systemhost.net>

I've been using configure-replication.sh to make my life easier
preparing slony installation script and I've fixed up a couple of bugs
along the way. I have been using version 1.2.6 but have just checked CVS
and the bugs are still in trunk.
 
Both bugs are to do with missing new lines, one in the store_paths
function, the other in the code that generates "add sequence" lines.

I have create a patch file which is here.

===BEGIN===
--- slony1-1.2.6/tools/configure-replication.sh	2006-12-14
22:31:19.000000000 +0000
+++ slony1-patch/tools/configure-replication.sh	2007-11-01
10:57:42.000000000 +0000
@@ -55,7 +55,8 @@
           eval buser=\$USER${j}
           eval bport=\$PORT${j}
           if [ -n "${bdb}" -a "${bhost}" -a "${buser}" -a "${bport}" ];
then
-            echo "STORE PATH (SERVER=${i}, CLIENT=${j},
CONNINFO='dbname=${db} host=${host} user=${user} port=${port}');" >>
$mktmp/store_paths.slonik          else
+            echo "STORE PATH (SERVER=${i}, CLIENT=${j},
CONNINFO='dbname=${db} host=${host} user=${user} port=${port}');" >>
$mktmp/store_paths.slonik
+          else
             echo "STORE PATH (SERVER=${i}, CLIENT=${j},
CONNINFO='dbname=${db} host=${host} user=${user} port=${port}');" >>
$mktmp/store_paths.slonik
           fi
         fi
@@ -139,7 +140,6 @@
 echo "create set (id=1, origin=1, comment='${CLUSTER} Tables and
Sequences');" >> $SETUPSET
 
 tnum=1
-
 for table in `echo $TABLES`; do
     echo "set add table (id=${tnum}, set id=1, origin=1, fully
qualified name='${table}', comment='${CLUSTER} table ${table}');" >>
$SETUPSET
     tnum=`expr ${tnum} + 1`
@@ -147,7 +147,8 @@
 
 snum=1
 for seq in `echo $SEQUENCES`; do
-    echo "set add sequence (id=${snum}, set id=1, origin=1, fully
qualified name='${seq}', comment='${CLUSTER} sequence ${seq}');" >>
$SETUPSET    snum=`expr ${snum} + 1`
+    echo "set add sequence (id=${snum}, set id=1, origin=1, fully
qualified name='${seq}', comment='${CLUSTER} sequence ${seq}');" >>
$SETUPSET
+    snum=`expr ${snum} + 1`
 done
 
 NODEINIT=$mktmp/create_nodes.slonik
===END===

configure-replication.sh is a great script BTW. Speeds up installation
of test environments and makes sure each one is reproducable.

Steve Hindmarch
BT Design - iBridge Development


From lists at serioustechnology.com  Thu Nov  1 05:48:49 2007
From: lists at serioustechnology.com (Geoffrey)
Date: Thu Nov  1 05:48:56 2007
Subject: [Slony1-general] questions about our slony solution
Message-ID: <4729CB31.7000900@serioustechnology.com>

I probably should have posted this a long while ago.  We are in the 
process of setting up a single slony slave for the sake of disaster 
recovery.  Our set up is relatively complex, and I thought I'd throw out 
some questions regarding it, in the hope that anyone here on the list 
might point out issues that may stop us from completing this process 
successfully.  My apologies for the length of this post in advance.

Our current production setup has two boxes that share a data silo.  A 
hot-hot scenario where roughly half the postmasters run from one 
machine, the other half from the other.  In the event of one machine 
failure, the live box picks up all the databases.

We are running Red Hat Advance Server 4, postgresql 7.4.18.

Our plan is to replicate all existing databases to another box, for the 
short term, it will reside in the same location as the master boxes. 
Long term, it will be moved to a data center in Nashville, TN, we are in 
Gainesville GA.

We currently have 9 postmasters running on one machine, 8 on the other. 
  This number will likely grow.

My plan is to 'turn on' slony for each database one at a time, in order 
to reduce the initial hit on the servers as slony performs the initial 
replication of the data in each database. The existing databases' 
directories range from 407M to 8.5G, most of which are in the 1.5G range.

The majority of the databases have identical schemas.  Will I be 
configuring separate instances of slony per database, or will a single 
instance handle multiple databases?

Thanks for any assistance and feedback on this scenario.

-- 
Until later, Geoffrey

Those who would give up essential Liberty, to purchase a little
temporary Safety, deserve neither Liberty nor Safety.
  - Benjamin Franklin
From cbbrowne at ca.afilias.info  Thu Nov  1 06:47:12 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Thu Nov  1 06:47:17 2007
Subject: [Slony1-general] trace the path of replicated data
In-Reply-To: <17587634.16921193896321439.JavaMail.root@zimbra.greatschools.net>
	(Dane Miller's message of "Wed, 31 Oct 2007 22:52:01 -0700 (PDT)")
References: <17587634.16921193896321439.JavaMail.root@zimbra.greatschools.net>
Message-ID: <60tzo6qdr3.fsf@dba2.int.libertyrms.com>

Dane Miller <dane@greatschools.net> writes:

> Hi Slony folks,
>
> I've been reading docs trying to understand how Slony works.  I've tried to outline below my understanding of how an INSERT into the origin gets replicated to the subscriber.  Do I get the gist of it here?  If not, could someone be so kind as to correct me?  I hope this isn't too much of a newbie question, but I didn't find an answer in the admin guide on slony.info.
>
> Tracing an insert from the origin to a subscriber (2 node cluster)
>
> 1. INSERT into the origin
> 2. AFTER ROW trigger executes logtrigger which inserts into sl_log_{1,2}
> 3. origin's slon checks sl_log_{1,2}, inserts event into sl_event, generates NOTIFY
> 4. subscriber receives NOTIFY, inserts event into its sl_event table, inserts confirmation into its local sl_confirm table.
> 5. subscriber inserts event into origin's sl_confirm table
> 6. subscriber queries origin's sl_log_{1,2} using event info
> 7. Subscriber applies result of #6 to its local tables.
>
> whew!  If this has been covered elsewhere, please point me in the right direction.  I got this far by reading Slony-I-concept.pdf, but it seemed to cover more complex setups, and I got a bit lost in the detail.

That's about right.

It's worth noting that the NOTIFY isn't run for each update to a
replicated table - it happens more on a cronological basis.
-- 
let name="cbbrowne" and tld="linuxdatabases.info" in String.concat "@" [name;tld];;
http://linuxdatabases.info/info/nonrdbms.html
Have you ever considered beating yourself with a cluestick?
From cyril.scetbon at free.fr  Fri Nov  2 02:32:27 2007
From: cyril.scetbon at free.fr (Cyril SCETBON)
Date: Fri Nov  2 02:32:47 2007
Subject: [Slony1-general] Move SET seems not to work properly
In-Reply-To: <4728B052.30303@free.fr>
References: <4728B052.30303@free.fr>
Message-ID: <472AEEAB.1090001@free.fr>



Cyril SCETBON wrote:

> Hi,
>
>
>
> I get the following configuration :
>
>
> select * from "_CLUSTER1".sl_subscribe;
> sub_set | sub_provider | sub_receiver | sub_forward | sub_active
> ---------+--------------+--------------+-------------+------------
>       1 |            1 |            2 | t           | t
>       1 |            1 |            3 | t           | t
>       1 |            3 |            4 | t           | t
>
>
> I used the following slonik script to make node 2 the new provider :
>
>
> CLUSTER NAME = CLUSTER1;
> NODE 1 ADMIN CONNINFO = 'dbname=dbrep host=host1 user=postgres 
> port=5433';
> NODE 2 ADMIN CONNINFO = 'dbname=dbrep host=host2 user=postgres 
> port=5434';
> NODE 3 ADMIN CONNINFO = 'dbname=dbrep host=host3 user=postgres 
> port=5435';
> NODE 4 ADMIN CONNINFO = 'dbname=dbrep host=host4 user=postgres 
> port=5436';
> LOCK SET (ID = 1, ORIGIN = 1);
> MOVE SET (ID = 1, OLD ORIGIN = 1, NEW ORIGIN = 2);
>
>
> But the new configuration is :
>
>
> select * from "_CLUSTER1".sl_subscribe;
> sub_set | sub_provider | sub_receiver | sub_forward | sub_active
> ---------+--------------+--------------+-------------+------------
>       1 |            1 |            3 | t           | t
>       1 |            3 |            4 | t           | t
>       1 |            2 |            1 | t           | t
>
>
> on nodes 1,2,3 but not on node 3 :
>
>
> select * from "_CLUSTER1".sl_subscribe;
> sub_set | sub_provider | sub_receiver | sub_forward | sub_active
> ---------+--------------+--------------+-------------+------------
>       1 |            1 |            2 | t           | t
>       1 |            1 |            3 | t           | t
>       1 |            3 |            4 | t           | t
>
>
> I was thinking that the one node 4 is displaying would be the new
> configuration.
>
>
> On node 3, I see ACCEPT_SET - MOVE_SET or FAILOVER_SET exists -
> adjusting setsync status in slon.log, while on node 4, I get ACCEPT_SET
> - MOVE_SET or FAILOVER_SET not received yet - sleep
After having test a lot it seems that event ACCEPT_SET is received on 
node 3 et 4 but not the FAILOVER_SET and they are both waiting this 
event that never come :-(
>
>
>
> Thanks for you help.
>
>
From cbbrowne at ca.afilias.info  Fri Nov  2 08:38:57 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Fri Nov  2 08:39:03 2007
Subject: [Slony1-general] Bugs in configure-replication.sh
In-Reply-To: <614CEAAF10695543B87ED664C03A5DB204EFF744@E03MVX1-UKDY.domain1.systemhost.net>
	(stephen hindmarch's message of "Thu, 1 Nov 2007 11:30:13 -0000")
References: <614CEAAF10695543B87ED664C03A5DB204EFF744@E03MVX1-UKDY.domain1.systemhost.net>
Message-ID: <60lk9gr71q.fsf@dba2.int.libertyrms.com>

<stephen.hindmarch@bt.com> writes:
> I've been using configure-replication.sh to make my life easier
> preparing slony installation script and I've fixed up a couple of bugs
> along the way. I have been using version 1.2.6 but have just checked CVS
> and the bugs are still in trunk.
>  
> Both bugs are to do with missing new lines, one in the store_paths
> function, the other in the code that generates "add sequence" lines.
>
> I have create a patch file which is here.

Oddly, I was unable to use the patch.  There was something odd about
the format of it.

At any rate, I have checked this change into HEAD.  I'd like to hold
it off in 1.2 until AFTER the 1.2.12 release, just so that we can say
"Yup, 1.2.12 is baked, and has had no changes all week."

I need to add a further option to this to allow the Gentle User to
specify a path for the slonik scripts to live in, that way I could
actually use this to help set up some of the regression tests, and
therefore draw this script into the set of "things tested."  That
change will definitely only take place in HEAD...

I wrote this script up last year while on a flight to Ohio (I spoke at
their annual "LinuxFest"), and initially set it up as a contribution
to the LedgerSMB project, to help make it easy for their users to
configure replication of their tables.  I was pretty happy with it.
I'm glad you like it.
-- 
let name="cbbrowne" and tld="linuxfinances.info" in name ^ "@" ^ tld;;
http://linuxfinances.info/info/lisp.html
How do I type "for i in  *.dvi do xdvi $i done" in a GUI?  (Discussion
in comp.os.linux.misc on the intuitiveness of interfaces.)
From cyril.scetbon at free.fr  Tue Nov  6 01:39:10 2007
From: cyril.scetbon at free.fr (Cyril SCETBON)
Date: Tue Nov  6 01:39:31 2007
Subject: [Slony1-general] Move SET seems not to work properly
In-Reply-To: <4728B052.30303@free.fr>
References: <4728B052.30303@free.fr>
Message-ID: <4730363E.7020508@free.fr>

How is it possible that node 1 is the provider of node 2 and in the same 
time node 2 is the provider of node 1 ??


Has someone played with this feature ?


thanks.


Cyril SCETBON wrote:

> Hi,
>
>
>
> I get the following configuration :
>
>
> select * from "_CLUSTER1".sl_subscribe;
> sub_set | sub_provider | sub_receiver | sub_forward | sub_active
> ---------+--------------+--------------+-------------+------------
>       1 |            1 |            2 | t           | t
>       1 |            1 |            3 | t           | t
>       1 |            3 |            4 | t           | t
>
>
> I used the following slonik script to make node 2 the new provider :
>
>
> CLUSTER NAME = CLUSTER1;
> NODE 1 ADMIN CONNINFO = 'dbname=dbrep host=host1 user=postgres 
> port=5433';
> NODE 2 ADMIN CONNINFO = 'dbname=dbrep host=host2 user=postgres 
> port=5434';
> NODE 3 ADMIN CONNINFO = 'dbname=dbrep host=host3 user=postgres 
> port=5435';
> NODE 4 ADMIN CONNINFO = 'dbname=dbrep host=host4 user=postgres 
> port=5436';
> LOCK SET (ID = 1, ORIGIN = 1);
> MOVE SET (ID = 1, OLD ORIGIN = 1, NEW ORIGIN = 2);
>
>
> But the new configuration is :
>
>
> select * from "_CLUSTER1".sl_subscribe;
> sub_set | sub_provider | sub_receiver | sub_forward | sub_active
> ---------+--------------+--------------+-------------+------------
>       1 |            1 |            3 | t           | t
>       1 |            3 |            4 | t           | t
>       1 |            2 |            1 | t           | t
>
>
> on nodes 1,2,3 but not on node 4 :
>
>
> select * from "_CLUSTER1".sl_subscribe;
> sub_set | sub_provider | sub_receiver | sub_forward | sub_active
> ---------+--------------+--------------+-------------+------------
>       1 |            1 |            2 | t           | t
>       1 |            1 |            3 | t           | t
>       1 |            3 |            4 | t           | t
>
>
> I was thinking that the one node 4 is displaying would be the new
> configuration.
>
> Thanks for you help.
>
>
From lists at serioustechnology.com  Tue Nov  6 04:38:20 2007
From: lists at serioustechnology.com (Geoffrey)
Date: Tue Nov  6 04:38:43 2007
Subject: [Slony1-general] matching versions of Postgresql on both master and
	slave necessary?
Message-ID: <4730603C.3000207@serioustechnology.com>

Is it absolutely necessary to have the same versions of Postgres on both 
the master and slave?  Point is, we are currently running 7.4.16 on the 
machines I plan to replicate, but thought I'd go with the lastest 7.4 
version (18).  My ignorant assumption is that if you're going to have a 
mis-match in versions, it's best to have the slave newer then the master.

-- 
Until later, Geoffrey

Those who would give up essential Liberty, to purchase a little
temporary Safety, deserve neither Liberty nor Safety.
  - Benjamin Franklin
From lists at serioustechnology.com  Tue Nov  6 05:10:26 2007
From: lists at serioustechnology.com (Geoffrey)
Date: Tue Nov  6 05:10:32 2007
Subject: [Slony1-general] custom functions necessary on the slave machine?
Message-ID: <473067C2.5010300@serioustechnology.com>

We have some custom functions built into the Postgresql backend that are 
used by our application.  I'm assuming that it's not necessary to have 
these installed on the slave until such time as we may need to use it 
for a replacement of the master.

-- 
Until later, Geoffrey

Those who would give up essential Liberty, to purchase a little
temporary Safety, deserve neither Liberty nor Safety.
  - Benjamin Franklin
From honza at jyxo.com  Tue Nov  6 06:16:15 2007
From: honza at jyxo.com (Jan Matousek)
Date: Tue Nov  6 06:16:20 2007
Subject: [Slony1-general] matching versions of Postgresql on both master
	and slave necessary?
In-Reply-To: <4730603C.3000207@serioustechnology.com>
References: <4730603C.3000207@serioustechnology.com>
Message-ID: <c14eaebb0711060616u673d1926n4274db4a48b581ee@mail.gmail.com>

Hi,

I believe that the cross-version replication is possible.
I have experience with 8.1 (master) and 8.2 (slave) replication, and
it works fine.

j.

On Nov 6, 2007 1:38 PM, Geoffrey <lists@serioustechnology.com> wrote:
> Is it absolutely necessary to have the same versions of Postgres on both
> the master and slave?  Point is, we are currently running 7.4.16 on the
> machines I plan to replicate, but thought I'd go with the lastest 7.4
> version (18).  My ignorant assumption is that if you're going to have a
> mis-match in versions, it's best to have the slave newer then the master.
>
> --
> Until later, Geoffrey
>
> Those who would give up essential Liberty, to purchase a little
> temporary Safety, deserve neither Liberty nor Safety.
>   - Benjamin Franklin
> _______________________________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
>
From andrew.george.hammond at gmail.com  Tue Nov  6 10:56:59 2007
From: andrew.george.hammond at gmail.com (Andrew Hammond)
Date: Tue Nov  6 10:57:05 2007
Subject: [Slony1-general] matching versions of Postgresql on both master
	and slave necessary?
In-Reply-To: <c14eaebb0711060616u673d1926n4274db4a48b581ee@mail.gmail.com>
References: <4730603C.3000207@serioustechnology.com>
	<c14eaebb0711060616u673d1926n4274db4a48b581ee@mail.gmail.com>
Message-ID: <5a0a9d6f0711061056v2c4be754jd0ee7ac9a3704901@mail.gmail.com>

It's not only possible, it's a core feature of slony. A large use case for
slony is upgrades which would otherwise require a dump / initdb / reload,
and in doing so require an unacceptably long outage. Just make sure your
slony versions match.

However for the upgrade you're talking about below, 7.4.16 to 7.4.18, you
don't need an initdb cycle, you can simply replace the binaries. I'd also
note that 7.4 is pretty long in the tooth at this point. You should consider
upgrading, although at this point I'd wait for 8.3 to come out and go in
that direction.

Andrew

On 11/6/07, Jan Matousek <honza@jyxo.com> wrote:
>
> Hi,
>
> I believe that the cross-version replication is possible.
> I have experience with 8.1 (master) and 8.2 (slave) replication, and
> it works fine.
>
> j.
>
> On Nov 6, 2007 1:38 PM, Geoffrey <lists@serioustechnology.com> wrote:
> > Is it absolutely necessary to have the same versions of Postgres on both
> > the master and slave?  Point is, we are currently running 7.4.16 on the
> > machines I plan to replicate, but thought I'd go with the lastest 7.4
> > version (18).  My ignorant assumption is that if you're going to have a
> > mis-match in versions, it's best to have the slave newer then the
> master.
> >
> > --
> > Until later, Geoffrey
> >
> > Those who would give up essential Liberty, to purchase a little
> > temporary Safety, deserve neither Liberty nor Safety.
> >   - Benjamin Franklin
> > _______________________________________________
> > Slony1-general mailing list
> > Slony1-general@lists.slony.info
> > http://lists.slony.info/mailman/listinfo/slony1-general
> >
> _______________________________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20071106/=
0ddeccde/attachment.htm
From cbbrowne at ca.afilias.info  Tue Nov  6 12:05:40 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Tue Nov  6 12:05:57 2007
Subject: [Slony1-general] Ready for 1.2.12?
Message-ID: <60ve8fp2az.fsf@dba2.int.libertyrms.com>

There have been no further patches in the past week, so I'm looking at
a "going, going, ... "  (soon to be ... gone.)

Anyone have a problem with unleashing 1.2.12 tomorrow?
-- 
(reverse (concatenate 'string "ofni.secnanifxunil" "@" "enworbbc"))
http://linuxdatabases.info/info/x.html
When they ship styrofoam, what do they pack it in?
From devrim at CommandPrompt.com  Tue Nov  6 12:36:10 2007
From: devrim at CommandPrompt.com (Devrim =?ISO-8859-1?Q?G=DCND=DCZ?=)
Date: Tue Nov  6 12:36:23 2007
Subject: [Slony1-general] Ready for 1.2.12?
In-Reply-To: <60ve8fp2az.fsf@dba2.int.libertyrms.com>
References: <60ve8fp2az.fsf@dba2.int.libertyrms.com>
Message-ID: <1194381370.25098.18.camel@localhost.localdomain>

SGksCgpPbiBUdWUsIDIwMDctMTEtMDYgYXQgMTU6MDUgLTA1MDAsIENocmlzdG9waGVyIEJyb3du
ZSB3cm90ZToKPiBUaGVyZSBoYXZlIGJlZW4gbm8gZnVydGhlciBwYXRjaGVzIGluIHRoZSBwYXN0
IHdlZWssIHNvIEknbSBsb29raW5nIGF0Cj4gYSAiZ29pbmcsIGdvaW5nLCAuLi4gIiAgKHNvb24g
dG8gYmUgLi4uIGdvbmUuKQo+IAo+IEFueW9uZSBoYXZlIGEgcHJvYmxlbSB3aXRoIHVubGVhc2hp
bmcgMS4yLjEyIHRvbW9ycm93PwoKSUlSQywgRGFyY3kgaGFzIGZvdW5kIGEgYnVnIHdpdGggRVhF
Q1VURSBTQ1JJUFQgYW5kIHdvdWxkIHN1Ym1pdCBhCnBhdGNoLiBEYXJjeT8KClJlZ2FyZHMsCi0t
IApEZXZyaW0gR8OcTkTDnFoKUG9zdGdyZVNRTCBSZXBsaWNhdGlvbiwgQ29uc3VsdGluZywgQ3Vz
dG9tIERldmVsb3BtZW50LCAyNHg3IHN1cHBvcnQKTWFuYWdlZCBTZXJ2aWNlcywgU2hhcmVkIGFu
ZCBEZWRpY2F0ZWQgSG9zdGluZwpDby1BdXRob3JzOiBwbFBIUCwgT0RCQ25nIC0gaHR0cDovL3d3
dy5jb21tYW5kcHJvbXB0LmNvbS8KCi0tLS0tLS0tLS0tLS0tIG5leHQgcGFydCAtLS0tLS0tLS0t
LS0tLQpBIG5vbi10ZXh0IGF0dGFjaG1lbnQgd2FzIHNjcnViYmVkLi4uCk5hbWU6IG5vdCBhdmFp
bGFibGUKVHlwZTogYXBwbGljYXRpb24vcGdwLXNpZ25hdHVyZQpTaXplOiAxODkgYnl0ZXMKRGVz
YzogVGhpcyBpcyBhIGRpZ2l0YWxseSBzaWduZWQgbWVzc2FnZSBwYXJ0ClVybCA6IGh0dHA6Ly9s
aXN0cy5zbG9ueS5pbmZvL3BpcGVybWFpbC9zbG9ueTEtZ2VuZXJhbC9hdHRhY2htZW50cy8yMDA3
MTEwNi80Nzg2MjdmNS9hdHRhY2htZW50LnBncAo=
From darcyb at commandprompt.com  Tue Nov  6 12:44:48 2007
From: darcyb at commandprompt.com (Darcy Buskermolen)
Date: Tue Nov  6 12:44:38 2007
Subject: [Slony1-general] Ready for 1.2.12?
In-Reply-To: <1194381370.25098.18.camel@localhost.localdomain>
References: <60ve8fp2az.fsf@dba2.int.libertyrms.com>
	<1194381370.25098.18.camel@localhost.localdomain>
Message-ID: <200711061244.49265.darcyb@commandprompt.com>

On Tuesday 06 November 2007 12:36:10 Devrim G?ND?Z wrote:
> Hi,
>
> On Tue, 2007-11-06 at 15:05 -0500, Christopher Browne wrote:
> > There have been no further patches in the past week, so I'm looking at
> > a "going, going, ... "  (soon to be ... gone.)
> >
> > Anyone have a problem with unleashing 1.2.12 tomorrow?
>
> IIRC, Darcy has found a bug with EXECUTE SCRIPT and would submit a
> patch. Darcy?

No it's not with EXECUTE SCRIPT, it is instead with slonik_execute_script

specificaly when called slonik_execute_script -c /full/path/to/file 1 this 
results in a 0 byte file being passed to EXECUTE SCRIPT.  however the other 
syntax slonik_execute_script 1 /path/to/script works fine.  I do not consider 
this a showstoper for 1.2.12 but would be nice if I could get the cycles to 
get a patch in for it before it's shipped.



>
> Regards,


From devrim at CommandPrompt.com  Tue Nov  6 15:30:24 2007
From: devrim at CommandPrompt.com (Devrim =?ISO-8859-1?Q?G=DCND=DCZ?=)
Date: Tue Nov  6 15:30:42 2007
Subject: [Slony1-general] matching versions of Postgresql on both
	master and slave necessary?
In-Reply-To: <4730603C.3000207@serioustechnology.com>
References: <4730603C.3000207@serioustechnology.com>
Message-ID: <1194391824.25098.38.camel@localhost.localdomain>

SGksCgpPbiBUdWUsIDIwMDctMTEtMDYgYXQgMDc6MzggLTA1MDAsIEdlb2ZmcmV5IHdyb3RlOgo+
IElzIGl0IGFic29sdXRlbHkgbmVjZXNzYXJ5IHRvIGhhdmUgdGhlIHNhbWUgdmVyc2lvbnMgb2Yg
UG9zdGdyZXMgb24KPiBib3RoICB0aGUgbWFzdGVyIGFuZCBzbGF2ZT8KCk5vLiBUaGlzIGlzIG9u
ZSBvZiB0aGUgbWFpbiBkZXNpZ24gZ29hbHMgb2YgU2xvbnktSSwgSUlSQy4gWW91IGNhbiB1c2UK
U2xvbnkgZm9yIHVwZ3JhZGluZyBvciBkb3duZ3JhZGluZywgc2F5IGZyb20gNy40IHRvIDguMi4g
TWlub3IgdmVyc2lvbnMKd2lsbCBzdXJlbHkgd29yay4KClJlZ2FyZHMsCi0tIApEZXZyaW0gR8Oc
TkTDnFoKUG9zdGdyZVNRTCBSZXBsaWNhdGlvbiwgQ29uc3VsdGluZywgQ3VzdG9tIERldmVsb3Bt
ZW50LCAyNHg3IHN1cHBvcnQKTWFuYWdlZCBTZXJ2aWNlcywgU2hhcmVkIGFuZCBEZWRpY2F0ZWQg
SG9zdGluZwpDby1BdXRob3JzOiBwbFBIUCwgT0RCQ25nIC0gaHR0cDovL3d3dy5jb21tYW5kcHJv
bXB0LmNvbS8KCi0tLS0tLS0tLS0tLS0tIG5leHQgcGFydCAtLS0tLS0tLS0tLS0tLQpBIG5vbi10
ZXh0IGF0dGFjaG1lbnQgd2FzIHNjcnViYmVkLi4uCk5hbWU6IG5vdCBhdmFpbGFibGUKVHlwZTog
YXBwbGljYXRpb24vcGdwLXNpZ25hdHVyZQpTaXplOiAxODkgYnl0ZXMKRGVzYzogVGhpcyBpcyBh
IGRpZ2l0YWxseSBzaWduZWQgbWVzc2FnZSBwYXJ0ClVybCA6IGh0dHA6Ly9saXN0cy5zbG9ueS5p
bmZvL3BpcGVybWFpbC9zbG9ueTEtZ2VuZXJhbC9hdHRhY2htZW50cy8yMDA3MTEwNi9lMzk5NTYz
Ni9hdHRhY2htZW50LnBncAo=
From cbbrowne at ca.afilias.info  Wed Nov  7 09:27:45 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Wed Nov  7 09:27:52 2007
Subject: [Slony1-general] Ready for 1.2.12?
In-Reply-To: <200711061244.49265.darcyb@commandprompt.com> (Darcy
	Buskermolen's message of "Tue, 6 Nov 2007 12:44:48 -0800")
References: <60ve8fp2az.fsf@dba2.int.libertyrms.com>
	<1194381370.25098.18.camel@localhost.localdomain>
	<200711061244.49265.darcyb@commandprompt.com>
Message-ID: <60mytqotim.fsf@dba2.int.libertyrms.com>

Darcy Buskermolen <darcyb@commandprompt.com> writes:
> On Tuesday 06 November 2007 12:36:10 Devrim G?ND?Z wrote:
>> Hi,
>>
>> On Tue, 2007-11-06 at 15:05 -0500, Christopher Browne wrote:
>> > There have been no further patches in the past week, so I'm looking at
>> > a "going, going, ... "  (soon to be ... gone.)
>> >
>> > Anyone have a problem with unleashing 1.2.12 tomorrow?
>>
>> IIRC, Darcy has found a bug with EXECUTE SCRIPT and would submit a
>> patch. Darcy?
>
> No it's not with EXECUTE SCRIPT, it is instead with slonik_execute_script
>
> specificaly when called slonik_execute_script -c /full/path/to/file 1 this 
> results in a 0 byte file being passed to EXECUTE SCRIPT.  however the other 
> syntax slonik_execute_script 1 /path/to/script works fine.  I do not consider 
> this a showstoper for 1.2.12 but would be nice if I could get the cycles to 
> get a patch in for it before it's shipped.

I'd like to kick 1.2.12 out ASAP; this seems like something that is
easy to work around, so I'm not terribly keen on holding up terribly
long for it...
-- 
select 'cbbrowne' || '@' || 'cbbrowne.com';
http://linuxfinances.info/info/sap.html
Rules of the Evil Overlord  #142. "If I have children and subsequently
grandchildren, I will keep  my three-year-old granddaughter near me at
all times. When  the hero enters to  kill me, I will ask  him to first
explain to her  why it is necessary to kill  her beloved grandpa. When
the hero launches  into an explanation of morality  way over her head,
that will be  her cue to pull the  lever and send him into  the pit of
crocodiles. After  all, small children like crocodiles  almost as much
as Evil Overlords  and it's important to spend  quality time with your
grandkids. <http://www.eviloverlord.com/>
From nagy at ecircle-ag.com  Thu Nov  8 04:55:20 2007
From: nagy at ecircle-ag.com (Csaba Nagy)
Date: Thu Nov  8 04:55:43 2007
Subject: [Slony1-general] Is it OK to rename a replicated table ?
Message-ID: <1194526520.21614.57.camel@PCD12478>

Hi all,

I wonder if replication will still work if I rename a replicated table ?
The structure of it stays the same, I just want to rename it... or I
must do it via EXECUTE SCRIPT ?

If I think a bit about it, the answer must be I must do it via execute
script...

Cheers,
Csaba.


From cbbrowne at ca.afilias.info  Thu Nov  8 06:22:12 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Thu Nov  8 06:22:18 2007
Subject: [Slony1-general] Is it OK to rename a replicated table ?
In-Reply-To: <1194526520.21614.57.camel@PCD12478> (Csaba Nagy's message of
	"Thu, 08 Nov 2007 13:55:20 +0100")
References: <1194526520.21614.57.camel@PCD12478>
Message-ID: <60mytoizqj.fsf@dba2.int.libertyrms.com>

Csaba Nagy <nagy@ecircle-ag.com> writes:
> I wonder if replication will still work if I rename a replicated table ?
> The structure of it stays the same, I just want to rename it... or I
> must do it via EXECUTE SCRIPT ?
>
> If I think a bit about it, the answer must be I must do it via execute
> script...

Yes, you do need to use EXECUTE SCRIPT to do this.

All should work afterwards.

I used this in production quite a long time ago.
-- 
let name="cbbrowne" and tld="linuxfinances.info" in String.concat "@" [name;tld];;
http://cbbrowne.com/info/advocacy.html
"You'll be  rid of most of us  when BSD-detox or GNU  comes out, which
should happen in the next few months (yeah, right)." -- Richard Tobin,
1992. [BSD did follow within a year]
From JanWieck at Yahoo.com  Thu Nov  8 02:03:00 2007
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Thu Nov  8 20:08:31 2007
Subject: [Slony1-general] matching versions of Postgresql on both master
	and slave necessary?
In-Reply-To: <c14eaebb0711060616u673d1926n4274db4a48b581ee@mail.gmail.com>
References: <4730603C.3000207@serioustechnology.com>
	<c14eaebb0711060616u673d1926n4274db4a48b581ee@mail.gmail.com>
Message-ID: <4732DED4.3020109@Yahoo.com>

On 11/6/2007 9:16 AM, Jan Matousek wrote:
> Hi,
> 
> I believe that the cross-version replication is possible.
> I have experience with 8.1 (master) and 8.2 (slave) replication, and
> it works fine.

Actually, one of the design goals of Slony-I was to be able to use it 
for the purpose of Postgres version upgrades with minimal downtime by 
using switchover.


Jan


> 
> j.
> 
> On Nov 6, 2007 1:38 PM, Geoffrey <lists@serioustechnology.com> wrote:
>> Is it absolutely necessary to have the same versions of Postgres on both
>> the master and slave?  Point is, we are currently running 7.4.16 on the
>> machines I plan to replicate, but thought I'd go with the lastest 7.4
>> version (18).  My ignorant assumption is that if you're going to have a
>> mis-match in versions, it's best to have the slave newer then the master.
>>
>> --
>> Until later, Geoffrey
>>
>> Those who would give up essential Liberty, to purchase a little
>> temporary Safety, deserve neither Liberty nor Safety.
>>   - Benjamin Franklin
>> _______________________________________________
>> Slony1-general mailing list
>> Slony1-general@lists.slony.info
>> http://lists.slony.info/mailman/listinfo/slony1-general
>>
> _______________________________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


-- 
#======================================================================#
# It's easier to get forgiveness for being wrong than for being right. #
# Let's break this rule - forgive me.                                  #
#================================================== JanWieck@Yahoo.com #

From WCoole at aperiogroup.com  Fri Nov  9 18:11:51 2007
From: WCoole at aperiogroup.com (Walter Coole)
Date: Fri Nov  9 18:12:18 2007
Subject: [Slony1-general] Windows as master, Linux as slave
Message-ID: <4292CEA5F4927248979C701CA83500BB67F85C@SERVER.aperiogroup.local>

Has anyone gotten replication from Windows to Linux running?  If so, can
you help a newby out?

 

Having gotten replication between Linux hosts working, I thought I knew
what I was doing.  When I tried to configure the cluster with Windows as
the master, I got errors like:

 

PGRES_FATAL_ERROR load '$libdir/xxid';  - ERROR:  access to library
"$libdir/xxid" is not allowed

 

Eventually, it sunk in that I needed to install Slony on the Windows
host.  I downloaded the installer at
http://developer.pgadmin.org/~hiroshi/Slony-I/slony-I-1.2.11R-pg82.zip .
It throws the error:

 

Module C:\Program Files\PostgreSQL\8.2\lib\slevent.dll failed to
register.  HRESULT -2147023898.  Contact your support personnel.

 

Being my own "support personnel", I'm stuck.

 

Thanks for any help you can offer.

 

Walter Coole

 

Aperio Group, LLC

Three Harbor Drive Suite 315

Sausalito, CA 94965

(415)339-4308 Direct

(415)339-4301 Fax

www.aperiogroup.com <http://www.aperiogroup.com> 

 

Aperio v. [Latin] to make clear, to reveal the truth

The information contained in this e-mail may be privileged and/or
confidential, and is intended only for the use of the person to whom it
is addressed. If you are not the named addressee (or such recipient's
employee or agent), you should not disseminate, distribute, alter or
copy this e-mail. Please notify the sender immediately by e-mail if you
have received this e-mail by mistake and delete this e-mail from your
system. E-mail transmissions cannot be guaranteed to be secure or
error-free as information could be intercepted, corrupted, lost,
destroyed, arrive late or incomplete, or contain viruses. The sender,
therefore, does not accept liability for any errors or omissions in the
contents of this message, which may arise during or as a result of
e-mail transmission. Communication of any portfolio changes, cash
additions or withdrawals must always be confirmed or verified by verbal
and/or hard copy version. In compliance with regulatory requirements,
all messages sent to or from this server are archived and may be read by
someone other than the recipient. This message is provided for
information purposes and has been obtained from sources which we believe
to be reliable, but we do not guarantee its accuracy or completeness and
it should not be construed as a solicitation or offer to buy or sell any
securities or related financial instruments in any jurisdiction. Aperio
Group LLC provides neither tax nor legal advice to its clients, and all
investors are strongly urged to consult with their legal and tax
advisors regarding any potential investment or strategy.

 

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20071109/b5435782/attachment.htm
From z-saito at guitar.ocn.ne.jp  Sun Nov 11 17:51:44 2007
From: z-saito at guitar.ocn.ne.jp (Hiroshi Saito)
Date: Sun Nov 11 17:51:56 2007
Subject: [Slony1-general] Windows as master, Linux as slave
References: <4292CEA5F4927248979C701CA83500BB67F85C@SERVER.aperiogroup.local>
Message-ID: <00cf01c824ce$9464dc40$c601a8c0@HP22720319231>


Hi.

Sorry, late reaction..

> ----- Original Message ----- 
> From: Walter Coole
> To: slony1-general@lists.slony.info
> Sent: Saturday, November 10, 2007 11:11 AM
> Subject: [Slony1-general] Windows as master, Linux as slave
>
>
> Has anyone gotten replication from Windows to Linux running?  If so, can you help a newby
> out?

Yes, The form can be used without a problem.!
However, you need to be conscious of ENCODING. And both of time must not be different.

>
> Having gotten replication between Linux hosts working, I thought I knew what I was doing.
> When I tried to configure the cluster with Windows as the master, I got errors like:
>
> PGRES_FATAL_ERROR load '$libdir/xxid';  - ERROR:  access to library "$libdir/xxid" is not
> allowed

Does xxid.so (lib) exist in the lib directory of Linux and Windows of you?

>
> Eventually, it sunk in that I needed to install Slony on the Windows host.  I downloaded 
> the
> installer at http://developer.pgadmin.org/~hiroshi/Slony-I/slony-I-1.2.11R-pg82.zip .  It
> throws the error:
>
> Module C:\Program Files\PostgreSQL\8.2\lib\slevent.dll failed to register.
> HRESULT -2147023898.  Contact your support personnel.

Um, I don't reproduce the problem....:-(
The new windows installer of 8.2 contained Slony. Then, Did you already register Slony into
the registry, before installing again?

>
> Being my own "support personnel", I'm stuck.
>
> Thanks for any help you can offer.
>
> Walter Coole

I want in detail the procedure and environment which you performed.

Regards,
Hiroshi Saito

From wooh at wooh.hu  Mon Nov 12 03:30:00 2007
From: wooh at wooh.hu (Adam PAPAI)
Date: Mon Nov 12 03:30:36 2007
Subject: [Slony1-general] "resume" replication without truncating the tables
Message-ID: <47383938.4070208@wooh.hu>

Hello List,

I have a few question on the method of starting/stopping/resuming 
replications.

I have a replication, which is running at the moment.

The steps I took:

1. Created the database on the slave host.
2. Copied the schema from the original.
3. Created the plpgsql language on the slave db.
4. defined the nodes with these scripts:

# Cluster internal ID
cluster name = $CLUSTER;

# Connection data
node 1 admin conninfo = 'dbname=$DBNAME1 host=$HOST1 user=$SLONY_USER';
node 2 admin conninfo = 'dbname=$DBNAME2 host=$HOST2 user=$SLONY_USER';

init cluster ( id = 1, comment = 'Node 1' );
create set ( id = 1, origin = 1, comment = 'All tables' );

*snip* table definitions

store node ( id = 2, comment = 'Node 2' );

store path ( server = 1, client = 2, conninfo = 'dbname=$DBNAME1 
host=$HOST1 user=$SLONY_USER');

store path ( server = 2, client = 1, conninfo = 'dbname=$DBNAME2 
host=$HOST2 user=$SLONY_USER');

store listen ( origin = 1, provider = 1, receiver = 2 );
store listen ( origin = 2, provider = 2, receiver = 1 );


5. Started the slon on both hosts:

master: slon $CLUSTERNAME "dbname=$MASTER_DATABASENAME 
user=$MASTER_SLON_USER"

slave: slon $CLUSTERNAME "dbanme=$SLAVE_DATABASENAME user=$SLAVE_SLONY_USER"

6. Run my start_slony_replication.sh which does the following

cluster name = $CLUSTER;
node 1 admin conninfo = 'dbname=$DBNAME1 host=$HOST1 user=$SLONY_USER';
node 2 admin conninfo = 'dbname=$DBNAME2 host=$HOST2 user=$SLONY_USER';
subscribe set ( id = 1, provider = 1, receiver = 2, forward = no);



At this point, the tables are truncated on the slave machine. Even if 
the two database is synced.

So if I run this script to stop the replication

cluster name = $CLUSTER;
node 1 admin conninfo = 'dbname=$DBNAME1 host=$HOST1 user=$SLONY_USER';
node 2 admin conninfo = 'dbname=$DBNAME2 host=$HOST2 user=$SLONY_USER';
unsubscribe set ( id = 1,  receiver = 2 );

and start replication again mentioned in point 6. then all of my tables 
will be truncated.

I'd like to awoid this truncate process. I want to move my server to 
another place, so I have to stop the replication itself for a few hours. 
But the size of the database is greater than 60GB and it takes too much 
time to sync again from scratch via pppoe connection and does not make 
sense.

Is it possible to make such a "resume" replication without deleting all 
of my data on the slave machine? I want to copy only the "newly changed 
  data between the stop-restart time interval.".

Or do I have to use another tool/application which is out of my sight?

Thanks in advance, any comments are welcome.


-- 
Adam PAPAI
D i g i t a l Influence
http://www.digitalinfluence.hu
E-mail: wooh@wooh.hu
Phone: +36 30 33-55-735 (Hungary)
From stephane.schildknecht at postgresqlfr.org  Mon Nov 12 04:14:19 2007
From: stephane.schildknecht at postgresqlfr.org (=?ISO-8859-1?Q?=22St=E9phane_A=2E_Schildknecht=22?=)
Date: Mon Nov 12 04:15:23 2007
Subject: [Slony1-general] "resume" replication without truncating the
	tables
In-Reply-To: <47383938.4070208@wooh.hu>
References: <47383938.4070208@wooh.hu>
Message-ID: <4738439B.3090501@postgresqlfr.org>

Adam PAPAI a ?crit :
> Hello List,
>
> I have a few question on the method of starting/stopping/resuming
> replications.
>
> I have a replication, which is running at the moment.
>
> The steps I took:
>
> 1. Created the database on the slave host.
> 2. Copied the schema from the original.
> 3. Created the plpgsql language on the slave db.
> 4. defined the nodes with these scripts:
>
> # Cluster internal ID
> cluster name = $CLUSTER;
>
> # Connection data
> node 1 admin conninfo = 'dbname=$DBNAME1 host=$HOST1 user=$SLONY_USER';
> node 2 admin conninfo = 'dbname=$DBNAME2 host=$HOST2 user=$SLONY_USER';
>
> init cluster ( id = 1, comment = 'Node 1' );
> create set ( id = 1, origin = 1, comment = 'All tables' );
>
> *snip* table definitions
>
> store node ( id = 2, comment = 'Node 2' );
>
> store path ( server = 1, client = 2, conninfo = 'dbname=$DBNAME1
> host=$HOST1 user=$SLONY_USER');
>
> store path ( server = 2, client = 1, conninfo = 'dbname=$DBNAME2
> host=$HOST2 user=$SLONY_USER');
>
> store listen ( origin = 1, provider = 1, receiver = 2 );
> store listen ( origin = 2, provider = 2, receiver = 1 );
>
>
> 5. Started the slon on both hosts:
>
> master: slon $CLUSTERNAME "dbname=$MASTER_DATABASENAME
> user=$MASTER_SLON_USER"
>
> slave: slon $CLUSTERNAME "dbanme=$SLAVE_DATABASENAME
> user=$SLAVE_SLONY_USER"
>
> 6. Run my start_slony_replication.sh which does the following
>
> cluster name = $CLUSTER;
> node 1 admin conninfo = 'dbname=$DBNAME1 host=$HOST1 user=$SLONY_USER';
> node 2 admin conninfo = 'dbname=$DBNAME2 host=$HOST2 user=$SLONY_USER';
> subscribe set ( id = 1, provider = 1, receiver = 2, forward = no);
>
>
>
> At this point, the tables are truncated on the slave machine. Even if
> the two database is synced.
>
> So if I run this script to stop the replication
>
> cluster name = $CLUSTER;
> node 1 admin conninfo = 'dbname=$DBNAME1 host=$HOST1 user=$SLONY_USER';
> node 2 admin conninfo = 'dbname=$DBNAME2 host=$HOST2 user=$SLONY_USER';
> unsubscribe set ( id = 1,  receiver = 2 );
>
> and start replication again mentioned in point 6. then all of my
> tables will be truncated.
>
> I'd like to awoid this truncate process. I want to move my server to
> another place, so I have to stop the replication itself for a few
> hours. But the size of the database is greater than 60GB and it takes
> too much time to sync again from scratch via pppoe connection and does
> not make sense.
>
> Is it possible to make such a "resume" replication without deleting
> all of my data on the slave machine? I want to copy only the "newly
> changed  data between the stop-restart time interval.".
>
> Or do I have to use another tool/application which is out of my sight?
>
> Thanks in advance, any comments are welcome.
>
>
Hi,

I wonder why you unsubscribe the set. To stop the replication, you
should only stop the slon processes. Restarting them will apply events
occured while the slave was stoppped.

What's more, there is no way, at the moment, to tell a slave and a
master there are in sync prior to run the subscribe set part of the
script, i.e. to initiate the replication.

Hope that could help.

Regards,

-- 
St?phane SCHILDKNECHT
Pr?sident de PostgreSQLFr
http://www.postgresqlfr.org

From wooh at wooh.hu  Mon Nov 12 06:07:31 2007
From: wooh at wooh.hu (Adam PAPAI)
Date: Mon Nov 12 06:07:36 2007
Subject: [Slony1-general] "resume" replication without truncating the
	tables [SOLVED]
In-Reply-To: <4738439B.3090501@postgresqlfr.org>
References: <47383938.4070208@wooh.hu> <4738439B.3090501@postgresqlfr.org>
Message-ID: <47385E23.3080104@wooh.hu>

St?phane A. Schildknecht wrote:

> I wonder why you unsubscribe the set. To stop the replication, you
> should only stop the slon processes. Restarting them will apply events
> occured while the slave was stoppped.
> 
> What's more, there is no way, at the moment, to tell a slave and a
> master there are in sync prior to run the subscribe set part of the
> script, i.e. to initiate the replication.
> 
> Hope that could help.


Thanks a lot. You're right. If I don't unsubscribe the node, it well 
copy only the changed data from the stored logfiles in the replication 
schema after starting slon.

It's working. I'm happy now.


-- 
Adam PAPAI
D i g i t a l Influence
http://www.digitalinfluence.hu
E-mail: wooh@wooh.hu
Phone: +36 30 33-55-735 (Hungary)
From cbbrowne at ca.afilias.info  Mon Nov 12 15:04:54 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Mon Nov 12 15:05:05 2007
Subject: [Slony1-general] Version 1.2.12 released
Message-ID: <601wavf4kp.fsf@dba2.int.libertyrms.com>

After a pretty considerable test and release cycle, version 1.2.12 of
the Slony-I replication system has been released.

There is a pretty considerable set of changes:

- Fixed problem with DDL SCRIPT parser where C-style comments were
  not being processed properly

- Added stored functions and documentation for adding empty tables
  (notably *partitions*) to replication.  Note these functions
  do no work when not specifically requested.

  CAVEAT:  This functionality may not work as expected on versions
  of PostgreSQL earlier than 8.1.  Mind you, partitioning tends
  to function pretty poorly in earlier versions of PostgreSQL as
  there were substantial enhancements in 8.1 and following versions.

- Added a fairly substantial partitioning test to exercise the
  new stored functions above.

- Backport "listen path" generator function from CVS HEAD (2.0) to
  1.2 branch.

- Fixed a problem with "EXECUTE SCRIPT" (introduced in remote_worker.c
  version 1.124.2.13) where moving the relevant code into a subroutine
  at the end led to losing the "BEGIN; SET TRANSACTION ISOLATION LEVEL
  SERIALIZABLE;" query that needs to be the first thing run...

- Fixing the archive sequence generations (in log shipping).  All
  non-SYNC events must start the local transaction before creating the
  archive as well, so that the lock on the archive counter table
  serializes archive creation.

- Fixed logging done in local_listener.c - various places, there was
  no '\n' in some cases, which would lead to entries being folded
  together.

- Fix launch_slons.sh - was not stripping quotes from PID file name

- Error handling for "ERROR: could not serialize access due to
  concurrent update"

  If this error is encountered when starting processing of
  sl_archive_counter, then two threads are fighting over access to
  this counter, and at least one has just failed.

  Rather than waiting, we ask to restart the node immediately.

- Fixes to slonik_build_env script - it wasn't properly handling
  cases where there was just 1 table or 1 sequence, and had a
  problem with the -schema option - thanks, Bernd Helmle

- Don't bother building slony_logshipper on Win32 as it doesn't work
  there at this point.

- If slonik connects as other than a superuser, then generate error
  message indicating this to the user.
-- 
"cbbrowne","@","linuxdatabases.info"
http://www3.sympatico.ca/cbbrowne/multiplexor.html
Incrementally extended heuristic algorithms tend inexorably toward the
incomprehensible.
From WCoole at aperiogroup.com  Mon Nov 12 18:07:35 2007
From: WCoole at aperiogroup.com (Walter Coole)
Date: Mon Nov 12 18:08:16 2007
Subject: [Slony1-general] Windows as master, Linux as slave
In-Reply-To: <00cf01c824ce$9464dc40$c601a8c0@HP22720319231>
References: <4292CEA5F4927248979C701CA83500BB67F85C@SERVER.aperiogroup.local>
	<00cf01c824ce$9464dc40$c601a8c0@HP22720319231>
Message-ID: <4292CEA5F4927248979C701CA83500BB67F8B4@SERVER.aperiogroup.local>

I appreciate your help.  I realize that you may have other responsibilities, so doubly appreciate it.

All of my databases use UTF8 encoding, so that shouldn't be a problem.

I don't understand what you mean by "both of time must not be different".  Perhaps you meant that they should be the same version; the Windows host is running "PostgeSQL 8.2.4 on i686-pc-mingw32, compiled by GCC gcc.exe (GCC) 3.4.2 (mingw-special)", the Linux host is running "PostgeSQL 8.2.4 on i686-redhat-linux-gnu, compiled by GCC gcc (GCC) 4.1.1 (Red Hat 4.1.1-51)".  This seems like as close to the same version as is feasible for Windows/Linux, so I hope it's close enough.

The linux host has:

ll /usr/lib/pgsql/xxid.so
-rwxr-xr-x 1 root root 30059 Oct 17 15:01 /usr/lib/pgsql/xxid.so

The windows host doesn't have an xxid.so file.  I don't understand why it would be desirable for the Windows host to have a .so file.  It does have quite a few .dll files in C:\Program Files\PostgreSQL\8.2\lib, but there is no xxid.dll file among them.  I had assumed that the install package would include it.

The installation of PostgreSQL on Windows was updated from an earlier version.  There was no attempt to install Slony as part of that, but it might have been part of the package.  The update was done from a file named postgresql-8.2.msi that came in a package labeled postgresql-8.2.4-1 .  I didn't make any changes to the registry, but the installer might have.

I got the installer from http://developer.pgadmin.org/~hiroshi/Slony-I/slony-I-1.2.11R-pg82.zip and was following the screen shots at http://developer.pgadmin.org/~hiroshi/Slony-I/ .  Things looked pretty much like the screen shots until I got to the sixth one ("Installation Complete").  My screen had " Module C:\Program Files\PostgreSQL\8.2\lib\slevent.dll failed to register.", instead.

Just now, I installed the Slony-I feature from the postgresql-8.2.msi script.  That installs without error and does deliver an xxid.dll file to C:\Program Files\PostgreSQL\8.2\lib, but the Slony msi still throws an "slevent.dll failed" error and initializing the cluster from Linux still throws an "access to library" error.

I had assumed that I would be able to initialize the cluster and run the slons on a Linux host; please correct me if I've made a mistaken assumption.

Thank you

Walter Coole
?
Aperio Group, LLC
Three Harbor Drive Suite 315
Sausalito, CA 94965
(415)339-4308 Direct
(415)339-4301 Fax
www.aperiogroup.com
?
Aperio v. [Latin] to make clear, to reveal the truth
The information contained in this e-mail may be privileged and/or confidential, and is intended only for the use of the person to whom it is addressed. If you are not the named addressee (or such recipient's employee or agent), you should not disseminate, distribute, alter or copy this e-mail. Please notify the sender immediately by e-mail if you have received this e-mail by mistake and delete this e-mail from your system. E-mail transmissions cannot be guaranteed to be secure or error-free as information could be intercepted, corrupted, lost, destroyed, arrive late or incomplete, or contain viruses. The sender, therefore, does not accept liability for any errors or omissions in the contents of this message, which may arise during or as a result of e-mail transmission. Communication of any portfolio changes, cash additions or withdrawals must always be confirmed or verified by verbal and/or hard copy version. In compliance with regulatory requirements, all messages sent to or from this server are archived and may be read by someone other than the recipient. This message is provided for information purposes and has been obtained from sources which we believe to be reliable, but we do not guarantee its accuracy or completeness and it should not be construed as a solicitation or offer to buy or sell any securities or related financial instruments in any jurisdiction. Aperio Group LLC provides neither tax nor legal advice to its clients, and all investors are strongly urged to consult with their legal and tax advisors regarding any potential investment or strategy.

-----Original Message-----
From: Hiroshi Saito [mailto:z-saito@guitar.ocn.ne.jp] 
Sent: Sunday, November 11, 2007 5:52 PM
To: Walter Coole
Cc: slony1-general@lists.slony.info
Subject: Re: [Slony1-general] Windows as master, Linux as slave


Hi.

Sorry, late reaction..

> ----- Original Message ----- 
> From: Walter Coole
> To: slony1-general@lists.slony.info
> Sent: Saturday, November 10, 2007 11:11 AM
> Subject: [Slony1-general] Windows as master, Linux as slave
>
>
> Has anyone gotten replication from Windows to Linux running?  If so, can you help a newby
> out?

Yes, The form can be used without a problem.!
However, you need to be conscious of ENCODING. And both of time must not be different.

>
> Having gotten replication between Linux hosts working, I thought I knew what I was doing.
> When I tried to configure the cluster with Windows as the master, I got errors like:
>
> PGRES_FATAL_ERROR load '$libdir/xxid';  - ERROR:  access to library "$libdir/xxid" is not
> allowed

Does xxid.so (lib) exist in the lib directory of Linux and Windows of you?

>
> Eventually, it sunk in that I needed to install Slony on the Windows host.  I downloaded 
> the
> installer at http://developer.pgadmin.org/~hiroshi/Slony-I/slony-I-1.2.11R-pg82.zip .  It
> throws the error:
>
> Module C:\Program Files\PostgreSQL\8.2\lib\slevent.dll failed to register.
> HRESULT -2147023898.  Contact your support personnel.

Um, I don't reproduce the problem....:-(
The new windows installer of 8.2 contained Slony. Then, Did you already register Slony into
the registry, before installing again?

>
> Being my own "support personnel", I'm stuck.
>
> Thanks for any help you can offer.
>
> Walter Coole

I want in detail the procedure and environment which you performed.

Regards,
Hiroshi Saito

From z-saito at guitar.ocn.ne.jp  Mon Nov 12 21:05:05 2007
From: z-saito at guitar.ocn.ne.jp (Hiroshi Saito)
Date: Mon Nov 12 21:05:20 2007
Subject: [Slony1-general] Windows as master, Linux as slave
References: <4292CEA5F4927248979C701CA83500BB67F85C@SERVER.aperiogroup.local>
	<00cf01c824ce$9464dc40$c601a8c0@HP22720319231>
	<4292CEA5F4927248979C701CA83500BB67F8B4@SERVER.aperiogroup.local>
Message-ID: <015d01c825b2$c1811dd0$c601a8c0@HP22720319231>

Hi.

> ----- Original Message ----- 
> From: "Walter Coole" <WCoole@aperiogroup.com>
> To: "Hiroshi Saito" <z-saito@guitar.ocn.ne.jp>
> Cc: <slony1-general@lists.slony.info>
> Sent: Tuesday, November 13, 2007 11:07 AM
> Subject: RE: [Slony1-general] Windows as master, Linux as slave
>
>
> I appreciate your help.  I realize that you may have other responsibilities, so doubly
> appreciate it.

no problem.:-)

>
> All of my databases use UTF8 encoding, so that shouldn't be a problem.

Ah yes. I regard it as desirable.

>
> I don't understand what you mean by "both of time must not be different".  Perhaps you 
> meant
> that they should be the same version; the Windows host is running "PostgeSQL 8.2.4 on
> i686-pc-mingw32, compiled by GCC gcc.exe (GCC) 3.4.2 (mingw-special)", the Linux host is
> running "PostgeSQL 8.2.4 on i686-redhat-linux-gnu, compiled by GCC gcc (GCC) 4.1.1 (Red 
> Hat
> 4.1.1-51)".  This seems like as close to the same version as is feasible for 
> Windows/Linux,
> so I hope it's close enough.

It means that it is necessary to unite each other machine time as notes in the case of 
running.
However, It is desirable to unify the version of Slony. Then, I think that it is 
satisfactory by
your environment...

>
> The linux host has:
>
> ll /usr/lib/pgsql/xxid.so
> -rwxr-xr-x 1 root root 30059 Oct 17 15:01 /usr/lib/pgsql/xxid.so
>
> The windows host doesn't have an xxid.so file.  I don't understand why it would be 
> desirable
> for the Windows host to have a .so file.  It does have quite a few .dll files in 
> C:\Program
> Files\PostgreSQL\8.2\lib, but there is no xxid.dll file among them.  I had assumed that 
> the
> install package would include it.

Oh sorry, I made the mistake in guidance. Yes, It is xxid.dll.

>
> The installation of PostgreSQL on Windows was updated from an earlier version.  There was 
> no
> attempt to install Slony as part of that, but it might have been part of the package.  The
> update was done from a file named postgresql-8.2.msi that came in a package labeled
> postgresql-8.2.4-1 .  I didn't make any changes to the registry, but the installer might
> have.
>
> I got the installer from
> http://developer.pgadmin.org/~hiroshi/Slony-I/slony-I-1.2.11R-pg82.zip and was following 
> the
> screen shots at http://developer.pgadmin.org/~hiroshi/Slony-I/ .  Things looked pretty 
> much
> like the screen shots until I got to the sixth one ("Installation Complete").  My screen 
> had
> " Module C:\Program Files\PostgreSQL\8.2\lib\slevent.dll failed to register.", instead.
>
> Just now, I installed the Slony-I feature from the postgresql-8.2.msi script.  That 
> installs
> without error and does deliver an xxid.dll file to C:\Program Files\PostgreSQL\8.2\lib, 
> but
> the Slony msi still throws an "slevent.dll failed" error and initializing the cluster from
> Linux still throws an "access to library" error.
>
> I had assumed that I would be able to initialize the cluster and run the slons on a Linux
> host; please correct me if I've made a mistaken assumption.

Um, There was the before same report. However, The problem was not reproduced in the
environment of Dave with me. It was very strange. So, I wish to check one.
Here is a new version.
http://developer.pgadmin.org/~hiroshi/Slony-I/
And if a problem still reappears, please use this. (This is VC8 compile module)
http://developer.pgadmin.org/~hiroshi/Slony-I/slevent.dll
MinGW (GCC) will be suspected if it operates well.

Regards,
Hiroshi Saito 

From cyril.scetbon at free.fr  Tue Nov 13 01:29:07 2007
From: cyril.scetbon at free.fr (Cyril SCETBON)
Date: Tue Nov 13 01:29:32 2007
Subject: [Slony1-general] Version 1.2.12 released
In-Reply-To: <601wavf4kp.fsf@dba2.int.libertyrms.com>
References: <601wavf4kp.fsf@dba2.int.libertyrms.com>
Message-ID: <47396E63.8080106@free.fr>

Hi,

I think it would be better to be able to modify SLON_DATA_FETCH_SIZE by 
using a parameter on the slon command line. For example, we got a lot of 
updates (400 per second) between far geographical sites. I had to modify 
this variable and to recompile the slon binary cause I didn't find 
another way until now.

Regards.

Christopher Browne wrote:
> After a pretty considerable test and release cycle, version 1.2.12 of
> the Slony-I replication system has been released.
>
> There is a pretty considerable set of changes:
>
> - Fixed problem with DDL SCRIPT parser where C-style comments were
>   not being processed properly
>
> - Added stored functions and documentation for adding empty tables
>   (notably *partitions*) to replication.  Note these functions
>   do no work when not specifically requested.
>
>   CAVEAT:  This functionality may not work as expected on versions
>   of PostgreSQL earlier than 8.1.  Mind you, partitioning tends
>   to function pretty poorly in earlier versions of PostgreSQL as
>   there were substantial enhancements in 8.1 and following versions.
>
> - Added a fairly substantial partitioning test to exercise the
>   new stored functions above.
>
> - Backport "listen path" generator function from CVS HEAD (2.0) to
>   1.2 branch.
>
> - Fixed a problem with "EXECUTE SCRIPT" (introduced in remote_worker.c
>   version 1.124.2.13) where moving the relevant code into a subroutine
>   at the end led to losing the "BEGIN; SET TRANSACTION ISOLATION LEVEL
>   SERIALIZABLE;" query that needs to be the first thing run...
>
> - Fixing the archive sequence generations (in log shipping).  All
>   non-SYNC events must start the local transaction before creating the
>   archive as well, so that the lock on the archive counter table
>   serializes archive creation.
>
> - Fixed logging done in local_listener.c - various places, there was
>   no '\n' in some cases, which would lead to entries being folded
>   together.
>
> - Fix launch_slons.sh - was not stripping quotes from PID file name
>
> - Error handling for "ERROR: could not serialize access due to
>   concurrent update"
>
>   If this error is encountered when starting processing of
>   sl_archive_counter, then two threads are fighting over access to
>   this counter, and at least one has just failed.
>
>   Rather than waiting, we ask to restart the node immediately.
>
> - Fixes to slonik_build_env script - it wasn't properly handling
>   cases where there was just 1 table or 1 sequence, and had a
>   problem with the -schema option - thanks, Bernd Helmle
>
> - Don't bother building slony_logshipper on Win32 as it doesn't work
>   there at this point.
>
> - If slonik connects as other than a superuser, then generate error
>   message indicating this to the user.
>   
From cbbrowne at ca.afilias.info  Tue Nov 13 07:48:32 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Tue Nov 13 07:48:39 2007
Subject: [Slony1-general] Version 1.2.12 released
In-Reply-To: <47396E63.8080106@free.fr> (Cyril SCETBON's message of "Tue,
	13 Nov 2007 10:29:07 +0100")
References: <601wavf4kp.fsf@dba2.int.libertyrms.com> <47396E63.8080106@free.fr>
Message-ID: <60ejeucfjj.fsf@dba2.int.libertyrms.com>

Cyril SCETBON <cyril.scetbon@free.fr> writes:
> I think it would be better to be able to modify SLON_DATA_FETCH_SIZE
> by using a parameter on the slon command line. For example, we got a
> lot of updates (400 per second) between far geographical sites. I had
> to modify this variable and to recompile the slon binary cause I
> didn't find another way until now.

That would definitely complicate things, as that value is, in fact,
used at compile time.

remote_worker.c:4299:	WorkerGroupLine *data_line[SLON_DATA_FETCH_SIZE];

Mind you, when it gets defined, the definition is a leetle bit odd:

#undef    SLON_CHECK_CMDTUPLES

#ifdef    SLON_CHECK_CMDTUPLES
#define SLON_COMMANDS_PER_LINE  1
#define SLON_DATA_FETCH_SIZE    100
#define SLON_WORKLINES_PER_HELPER       (SLON_DATA_FETCH_SIZE * 4)
#else
#define SLON_COMMANDS_PER_LINE  10
#define SLON_DATA_FETCH_SIZE    10
#define SLON_WORKLINES_PER_HELPER       (SLON_DATA_FETCH_SIZE * 5)
#endif

The OLD definition involved doing 1 query "per line" (well, "per query
submitted").  That changed, over time, to submitting 10 commands per
line, and evidently we still have the old definition sitting there
inactive.

This is probably worth taking a peek at for the 2.0 release...
-- 
select 'cbbrowne' || '@' || 'cbbrowne.com';
http://www3.sympatico.ca/cbbrowne/x.html
What do little birdies see when they get knocked unconscious?
From cbbrowne at ca.afilias.info  Tue Nov 13 08:55:38 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Tue Nov 13 08:55:44 2007
Subject: [Slony1-general] SLON_DATA_FETCH_SIZE possibly set too low
In-Reply-To: <47396E63.8080106@free.fr> (Cyril SCETBON's message of "Tue,
	13 Nov 2007 10:29:07 +0100")
References: <601wavf4kp.fsf@dba2.int.libertyrms.com> <47396E63.8080106@free.fr>
Message-ID: <60wssmaxv9.fsf_-_@dba2.int.libertyrms.com>

Cyril SCETBON <cyril.scetbon@free.fr> writes:
> I think it would be better to be able to modify SLON_DATA_FETCH_SIZE
> by using a parameter on the slon command line. For example, we got a
> lot of updates (400 per second) between far geographical sites. I had
> to modify this variable and to recompile the slon binary cause I
> didn't find another way until now.

FYI, I have added this as a bug in the present instantiation of the
Slony-I Bugzilla...

<http://www.slony.info/bugzilla/show_bug.cgi?id=8>

The Bugzilla instance may get scrubbed again before it gets officially
released; we'll just have to make sure this bug gets added back if it
disappears...
-- 
(reverse (concatenate 'string "ofni.sesabatadxunil" "@" "enworbbc"))
http://www3.sympatico.ca/cbbrowne/emacs.html
"Bother," said Pooh as he struggled with sendmail.cf.
"It never does quite what I want."
"I wish Christopher Robin were here.". 
From cyril.scetbon at free.fr  Tue Nov 13 09:28:04 2007
From: cyril.scetbon at free.fr (Cyril SCETBON)
Date: Tue Nov 13 09:28:11 2007
Subject: [Slony1-general] SLON_DATA_FETCH_SIZE possibly set too low
In-Reply-To: <60wssmaxv9.fsf_-_@dba2.int.libertyrms.com>
References: <601wavf4kp.fsf@dba2.int.libertyrms.com> <47396E63.8080106@free.fr>
	<60wssmaxv9.fsf_-_@dba2.int.libertyrms.com>
Message-ID: <4739DEA4.3050208@free.fr>



Christopher Browne wrote:

> Cyril SCETBON <cyril.scetbon@free.fr> writes:
>   
>> I think it would be better to be able to modify SLON_DATA_FETCH_SIZE
>> by using a parameter on the slon command line. For example, we got a
>> lot of updates (400 per second) between far geographical sites. I had
>> to modify this variable and to recompile the slon binary cause I
>> didn't find another way until now.
>>     
>
> FYI, I have added this as a bug in the present instantiation of the
> Slony-I Bugzilla...
>
> <http://www.slony.info/bugzilla/show_bug.cgi?id=8>
>
> The Bugzilla instance may get scrubbed again before it gets officially
> released; we'll just have to make sure this bug gets added back if it
> disappears...
>   
thanks for your work.
From dmitry at koterov.ru  Tue Nov 13 09:49:31 2007
From: dmitry at koterov.ru (Dmitry Koterov)
Date: Tue Nov 13 09:49:40 2007
Subject: [Slony1-general] Seems WAIT FOR EVENT does not work with SUBSCRIBE
	SET even with SYNC usage
Message-ID: <d7df81620711130949h50b19024r19ea01a8ae62e920@mail.gmail.com>

Hello.

I need to automate teble creation operations. So I created the following
script:

cluster name =3D ...;
node 1 admin conninfo=3D'...';
node 2 admin conninfo=3D'...';
try {
  DEFINE TMP_SET_ID      667;
  DEFINE MASTER_SET_ID   1;
  DEFINE MASTER_NODE_ID  1;
  CREATE SET (id =3D @TMP_SET_ID, origin =3D @MASTER_NODE_ID, comment =3D
'Temporary set');
  INCLUDE <a.slnk>;
}
ECHO 'Subscribing node 2 to set...';
SUBSCRIBE SET (id =3D @TMP_SET_ID, provider =3D @MASTER_NODE_ID, receiver =
=3D 2,
forward =3D yes);
ECHO 'Wait for event A...';
WAIT FOR EVENT (ORIGIN =3D 2, CONFIRMED =3D @MASTER_NODE_ID);
SYNC (ID =3D @MASTER_NODE_ID);
ECHO 'Wait for event B...';
WAIT FOR EVENT (ORIGIN =3D @MASTER_NODE_ID, CONFIRMED =3D 2);
try {
  MERGE SET (id =3D @MASTER_SET_ID, add id =3D @TMP_SET_ID, origin =3D
@MASTER_NODE_ID);
}

But seems WAIT FOR EVENT does not wait for a node subscription, because the
result is:

<stdin>:14: Subscribing node 2 to set...
<stdin>:16: Wait for event A...
<stdin>:19: Wait for event B...
<stdin>:21: PGRES_FATAL_ERROR select "_moikrug_cluster".mergeSet(1, 667);  -
ERROR:  Slony-I: set 667 has subscriptions in progress - cannot merge

The question is: how to wait for a subscription finish.

Slony documentation is quite conflicting:
a) http://slony.info/documentation/stmtwaitevent.html says "There is no
reliable way, at present, to monitor from within a
slonik<http://slony.info/documentation/slonik.html>script that
SUBSCRIBE
SET <http://slony.info/documentation/stmtsubscribeset.html> is complete."
b) http://slony.info/documentation/stmtmergeset.html gives us an example of
such waiting (but in this example SYNC and WAIT FOR EVENT are seems to be
wrongly ordered)
c) http://slony.info/documentation/stmtsubscribeset.html says "This means
that WAIT FOR EVENT cannot directly wait for completion of a subscription.
If you need to wait for completion of a subscription, then what you need to
do instead is to submit a SYNC request, and wait for that event.", but it
does not work too (slonik version 1.2.9).

Possibly the new slony version (1.2.12) solves all these problems? If yes,
what should we do with all that conflicts in documentation?
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20071113/=
45f19d34/attachment.htm
From andrew.george.hammond at gmail.com  Tue Nov 13 10:04:36 2007
From: andrew.george.hammond at gmail.com (Andrew Hammond)
Date: Tue Nov 13 10:04:42 2007
Subject: [Slony1-general] Windows as master, Linux as slave
In-Reply-To: <4292CEA5F4927248979C701CA83500BB67F8B4@SERVER.aperiogroup.local>
References: <4292CEA5F4927248979C701CA83500BB67F85C@SERVER.aperiogroup.local>
	<00cf01c824ce$9464dc40$c601a8c0@HP22720319231>
	<4292CEA5F4927248979C701CA83500BB67F8B4@SERVER.aperiogroup.local>
Message-ID: <5a0a9d6f0711131004j154ce595hbbcb4b2808249556@mail.gmail.com>

> I don't understand what you mean by "both of time must not be different".
>  Perhaps you meant that they should be the same version; the Windows host=
 is
> running "PostgeSQL 8.2.4 on i686-pc-mingw32, compiled by GCC gcc.exe (GCC)
> 3.4.2 (mingw-special)", the Linux host is running "PostgeSQL 8.2.4 on
> i686-redhat-linux-gnu, compiled by GCC gcc (GCC) 4.1.1 (Red Hat 4.1.1-51)=
".
>  This seems like as close to the same version as is feasible for
> Windows/Linux, so I hope it's close enough.


The version of PostgreSQL doesn't matter terribly much (one of the design
goals of slony was to provide a smooth upgrade path between PostgreSQL major
revisions). However the version of slony must match exactly between all
nodes in your cluster.

Aperio v. [Latin] to make clear, to reveal the truth
> The information contained in this e-mail may be privileged and/or
> confidential, and is intended only for the use of the person to whom it is
> addressed. If you are not the named addressee (or such recipient's employ=
ee
> or agent), you should not disseminate, distribute, alter or copy this
> e-mail. Please notify the sender immediately by e-mail if you have receiv=
ed
> this e-mail by mistake and delete this e-mail from your system. E-mail
> transmissions cannot be guaranteed to be secure or error-free as informat=
ion
> could be intercepted, corrupted, lost, destroyed, arrive late or incomple=
te,
> or contain viruses. The sender, therefore, does not accept liability for =
any
> errors or omissions in the contents of this message, which may arise duri=
ng
> or as a result of e-mail transmission. Communication of any portfolio
> changes, cash additions or withdrawals must always be confirmed or verifi=
ed
> by verbal and/or hard copy version. In compliance with regulatory
> requirements, all messages sent to or from this server are archived and m=
ay
> be read by someone other than the recipient. This message is provided for
> information purposes and has been obtained from sources which we believe =
to
> be reliable, but we do not guarantee its accuracy or completeness and it
> should not be construed as a solicitation or offer to buy or sell any
> securities or related financial instruments in any jurisdiction. Aperio
> Group LLC provides neither tax nor legal advice to its clients, and all
> investors are strongly urged to consult with their legal and tax advisors
> regarding any potential investment or strategy.
>

This kind of legal boiler-plate isn't appropriate to a public mailing list.
There can be no reasonable expectation of privacy. I realize that you may
not have control over this, but it seems to be something that gets some
members of the PostgreSQL community all riled up.

Andrew
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20071113/=
f2bc7b2c/attachment.htm
From WCoole at aperiogroup.com  Tue Nov 13 12:54:26 2007
From: WCoole at aperiogroup.com (Walter Coole)
Date: Tue Nov 13 12:55:01 2007
Subject: [Slony1-general] Windows as master, Linux as slave
In-Reply-To: <5a0a9d6f0711131004j154ce595hbbcb4b2808249556@mail.gmail.com>
References: <4292CEA5F4927248979C701CA83500BB67F85C@SERVER.aperiogroup.local>
	<00cf01c824ce$9464dc40$c601a8c0@HP22720319231>
	<4292CEA5F4927248979C701CA83500BB67F8B4@SERVER.aperiogroup.local>
	<5a0a9d6f0711131004j154ce595hbbcb4b2808249556@mail.gmail.com>
Message-ID: <4292CEA5F4927248979C701CA83500BB67F900@SERVER.aperiogroup.local>

I got slony for the Linux hosts from from slony1-1.2.10.tar, the Windows
hosts from slony-I-1.2.11R-pg82.zip
<http://developer.pgadmin.org/%7Ehiroshi/Slony-I/slony-I-1.2.11R-pg82.zi
p>  , so that might be the problem.

 

I tried installing PostgeSQL 8.2.4 and slony-I-1.2.10R-pg82 on a new
Windows host (not previously installed with PostgreSQL or Slony) and got
the same "Module C:\Program Files\PostgreSQL\8.2\lib\slevent.dll failed
to register. HRESULT -2147023898.  Contact your support personnel."
error.

 

Since this error is being thrown prior to interacting with the Linux
host, it looks like there is more to my difficulty than simply
incompatible versions of Slony.  Either there is something that I don't
understand about the installation procedure or there must be something
about these hosts that is incompatible with the Slony installation.

 

I tried changing the selected features and this error happens if (and
only if) I select the feature "Slony-I server module".  Guessing by the
name, I think I need this feature.

 

As an experiment, I tried installing the various versions from
http://developer.pgadmin.org/~hiroshi/Slony-I/

slony-I-1.2.9R-pg82.zip
<http://developer.pgadmin.org/%7Ehiroshi/Slony-I/slony-I-1.2.9R-pg82.zip
>     didn't throw the HRESULT error the first time I ran it, but
subsequently did.

slony-I-1.2.8R-pg82.zip
<http://developer.pgadmin.org/%7Ehiroshi/Slony-I/slony-I-1.2.8R-pg82.zip
>     , slony-I-1.2.7R-pg82.zip
<http://developer.pgadmin.org/%7Ehiroshi/Slony-I/slony-I-1.2.7R-pg82.zip
>  , and slony-I-1.2.6R-pg82.zip
<http://developer.pgadmin.org/%7Ehiroshi/Slony-I/slony-I-1.2.6R-pg82.zip
>           did throw the error.

 

It seems as though I've mangled something on my computer that prevents
the install script from working correctly, despite cancelling or
uninstalling each time.  I'm inclined to assume the registry as the item
mangled, but am fairly ignorant of how to go about repairing it without
making things worse.

 

I'm running Microsoft Windows XP Professional Version 5.1.2600 Service
Pack 2 Build 2600 .

 

HR Plus decodes the HRESULT as coming from FACILITY_WIN32, defined as
ERROR_NOACCESS, with the text "Invalid access to memory location.".
This makes it sound as though something was trying to access an
inappropriate memory location.

 

Any suggestions would be appreciated.

 

Walter

 

From: Andrew Hammond [mailto:andrew.george.hammond@gmail.com] 
Sent: Tuesday, November 13, 2007 10:05 AM
To: Walter Coole
Cc: Hiroshi Saito; slony1-general@lists.slony.info
Subject: Re: [Slony1-general] Windows as master, Linux as slave

 

 

	I don't understand what you mean by "both of time must not be
different".  Perhaps you meant that they should be the same version; the
Windows host is running "PostgeSQL 8.2.4 on i686-pc-mingw32, compiled by
GCC gcc.exe (GCC) 3.4.2 (mingw-special)", the Linux host is running
"PostgeSQL 8.2.4 on i686-redhat-linux-gnu, compiled by GCC gcc (GCC)
4.1.1 (Red Hat 4.1.1-51)".  This seems like as close to the same version
as is feasible for Windows/Linux, so I hope it's close enough. 


The version of PostgreSQL doesn't matter terribly much (one of the
design goals of slony was to provide a smooth upgrade path between
PostgreSQL major revisions). However the version of slony must match
exactly between all nodes in your cluster. 

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20071113/5dd47cae/attachment.htm
From andrew.george.hammond at gmail.com  Tue Nov 13 13:32:32 2007
From: andrew.george.hammond at gmail.com (Andrew Hammond)
Date: Tue Nov 13 13:32:41 2007
Subject: [Slony1-general] Windows as master, Linux as slave
In-Reply-To: <4292CEA5F4927248979C701CA83500BB67F900@SERVER.aperiogroup.local>
References: <4292CEA5F4927248979C701CA83500BB67F85C@SERVER.aperiogroup.local>
	<00cf01c824ce$9464dc40$c601a8c0@HP22720319231>
	<4292CEA5F4927248979C701CA83500BB67F8B4@SERVER.aperiogroup.local>
	<5a0a9d6f0711131004j154ce595hbbcb4b2808249556@mail.gmail.com>
	<4292CEA5F4927248979C701CA83500BB67F900@SERVER.aperiogroup.local>
Message-ID: <5a0a9d6f0711131332w4358fadfx7d01685c64faf9df@mail.gmail.com>

On Nov 13, 2007 12:54 PM, Walter Coole <WCoole@aperiogroup.com> wrote:

>  I got slony for the Linux hosts from from slony1-1.2.10.tar, the Windows
> hosts from *slony-I-1.2.11R-pg82.zip<http://developer.pgadmin.org/%7Ehiro=
shi/Slony-I/slony-I-1.2.11R-pg82.zip>
> *, so that might be the problem.
>
Well, that's not gonna work. :)

> I tried installing PostgeSQL 8.2.4 and slony-I-1.2.10R-pg82 on a new
> Windows host (not previously installed with PostgreSQL or Slony) and got =
the
> same "Module C:\Program Files\PostgreSQL\8.2\lib\slevent.dll failed to
> register. HRESULT -2147023898.  Contact your support personnel." error.
>
I don't know enough about the windows install to help you with this, but
Hiroshi probably can. Saito-san?

> I tried changing the selected features and this error happens if (and only
> if) I select the feature "Slony-I server module".  Guessing by the name, I
> think I need this feature.
>
I suspect this is talking about the slons. In which case, you don't need to
run a slon on the windows machine. You can run both slons on the linux box.
However I would suggest that you run the slons for each machine from the
machine it is managing (unless you have dedicated management servers on the
same LAN, in which case, run them there).

> As an experiment, I tried installing the various versions from
> http://developer.pgadmin.org/~hiroshi/Slony-I/<http://developer.pgadmin.o=
rg/%7Ehiroshi/Slony-I/>
>
I assume that you already know this but I'll reiterate to be sure: please do
not run ancient versions of the software. You are almost always better off
running the latest 1.2.x release since there are very few features being
added to 1.2 anymore, but plenty of bug-fixes have gone in.

Andrew
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20071113/=
d60458b5/attachment.htm
From z-saito at guitar.ocn.ne.jp  Tue Nov 13 16:06:01 2007
From: z-saito at guitar.ocn.ne.jp (Hiroshi Saito)
Date: Tue Nov 13 16:06:10 2007
Subject: [Slony1-general] Windows as master, Linux as slave
References: <4292CEA5F4927248979C701CA83500BB67F85C@SERVER.aperiogroup.local>
	<00cf01c824ce$9464dc40$c601a8c0@HP22720319231>
	<4292CEA5F4927248979C701CA83500BB67F8B4@SERVER.aperiogroup.local>
	<5a0a9d6f0711131004j154ce595hbbcb4b2808249556@mail.gmail.com>
	<4292CEA5F4927248979C701CA83500BB67F900@SERVER.aperiogroup.local>
	<5a0a9d6f0711131332w4358fadfx7d01685c64faf9df@mail.gmail.com>
Message-ID: <079101c82652$24272ca0$c601a8c0@HP22720319231>

Hi.

Did you try the following?
--
Um, There was the before same report. However, The problem was not reproduced in the
environment of Dave with me. It was very strange. So, I wish to check one.
Here is a new version.
http://developer.pgadmin.org/~hiroshi/Slony-I/
And if a problem still reappears, please use this. (This is VC8 compile module)
http://developer.pgadmin.org/~hiroshi/Slony-I/slevent.dll
MinGW (GCC) will be suspected if it operates well.
--

Regards,
Hiroshi Saito

----- Original Message ----- 
From: Andrew Hammond
To: Walter Coole
Cc: Hiroshi Saito ; slony1-general@lists.slony.info
Sent: Wednesday, November 14, 2007 6:32 AM
Subject: Re: [Slony1-general] Windows as master, Linux as slave


On Nov 13, 2007 12:54 PM, Walter Coole <WCoole@aperiogroup.com> wrote:

I got slony for the Linux hosts from from slony1-1.2.10.tar, the Windows hosts from 
slony-I-1.2.11R-pg82.zip , so that might be the problem.
Well, that's not gonna work. :)

I tried installing PostgeSQL 8.2.4 and slony-I-1.2.10R-pg82 on a new Windows host (not 
previously installed with PostgreSQL or Slony) and got the same "Module C:\Program 
Files\PostgreSQL\8.2\lib\slevent.dll failed to register. HRESULT -2147023898.  Contact your 
support personnel." error.
I don't know enough about the windows install to help you with this, but Hiroshi probably 
can. Saito-san?
I tried changing the selected features and this error happens if (and only if) I select the 
feature "Slony-I server module".  Guessing by the name, I think I need this feature.
I suspect this is talking about the slons. In which case, you don't need to run a slon on 
the windows machine. You can run both slons on the linux box. However I would suggest that 
you run the slons for each machine from the machine it is managing (unless you have 
dedicated management servers on the same LAN, in which case, run them there).

As an experiment, I tried installing the various versions from 
http://developer.pgadmin.org/~hiroshi/Slony-I/
I assume that you already know this but I'll reiterate to be sure: please do not run ancient 
versions of the software. You are almost always better off running the latest 1.2.x release 
since there are very few features being added to 1.2 anymore, but plenty of bug-fixes have 
gone in.

Andrew 

From WCoole at aperiogroup.com  Tue Nov 13 16:51:58 2007
From: WCoole at aperiogroup.com (Walter Coole)
Date: Tue Nov 13 16:52:39 2007
Subject: [Slony1-general] Windows as master, Linux as slave
In-Reply-To: <079101c82652$24272ca0$c601a8c0@HP22720319231>
References: <4292CEA5F4927248979C701CA83500BB67F85C@SERVER.aperiogroup.local>
	<00cf01c824ce$9464dc40$c601a8c0@HP22720319231>
	<4292CEA5F4927248979C701CA83500BB67F8B4@SERVER.aperiogroup.local>
	<5a0a9d6f0711131004j154ce595hbbcb4b2808249556@mail.gmail.com>
	<4292CEA5F4927248979C701CA83500BB67F900@SERVER.aperiogroup.local>
	<5a0a9d6f0711131332w4358fadfx7d01685c64faf9df@mail.gmail.com>
	<079101c82652$24272ca0$c601a8c0@HP22720319231>
Message-ID: <4292CEA5F4927248979C701CA83500BB67F926@SERVER.aperiogroup.local>

Today, I installed the slony-I-1.2.10R-pg82 package from
http://developer.pgadmin.org/~hiroshi/Slony-I/ ; there was no change in
behavior.  I put
http://developer.pgadmin.org/~hiroshi/Slony-I/slevent.dll into
C:\Program Files\PostgreSQL\8.2\lib ; still no luck.

Following Andrew's suggestion, I tried setting up with all the slons
running from a linux host (this is what I had planned on doing all
along).  The install without "Slony-I server module" doesn't throw any
errors, but when I try to configure the cluster (from linux), I still
get the "PGRES_FATAL_ERROR load '$libdir/xxid';  - ERROR:  access to
library "$libdir/xxid" is not allowed" error.

I'm guessing that slonik is asking the PostgreSQL server to load a
library (C:\Program Files\PostgreSQL\8.2\lib\xxid.dll) and getting a
response that indicates that that isn't allowed.  I don't see any
obvious reason why that shouldn't be allowed, but please don't assume I
know what I'm doing; there are several places where configuration lives
and I could easily have mucked them up.
 
Walter

-----Original Message-----
From: Hiroshi Saito [mailto:z-saito@guitar.ocn.ne.jp] 
Sent: Tuesday, November 13, 2007 4:06 PM
To: Andrew Hammond; Walter Coole
Cc: slony1-general@lists.slony.info
Subject: Re: [Slony1-general] Windows as master, Linux as slave

Hi.

Did you try the following?
--
Um, There was the before same report. However, The problem was not
reproduced in the
environment of Dave with me. It was very strange. So, I wish to check
one.
Here is a new version.
http://developer.pgadmin.org/~hiroshi/Slony-I/
And if a problem still reappears, please use this. (This is VC8 compile
module)
http://developer.pgadmin.org/~hiroshi/Slony-I/slevent.dll
MinGW (GCC) will be suspected if it operates well.
--

Regards,
Hiroshi Saito

----- Original Message ----- 
From: Andrew Hammond
To: Walter Coole
Cc: Hiroshi Saito ; slony1-general@lists.slony.info
Sent: Wednesday, November 14, 2007 6:32 AM
Subject: Re: [Slony1-general] Windows as master, Linux as slave


On Nov 13, 2007 12:54 PM, Walter Coole <WCoole@aperiogroup.com> wrote:

I got slony for the Linux hosts from from slony1-1.2.10.tar, the Windows
hosts from 
slony-I-1.2.11R-pg82.zip , so that might be the problem.
Well, that's not gonna work. :)

I tried installing PostgeSQL 8.2.4 and slony-I-1.2.10R-pg82 on a new
Windows host (not 
previously installed with PostgreSQL or Slony) and got the same "Module
C:\Program 
Files\PostgreSQL\8.2\lib\slevent.dll failed to register. HRESULT
-2147023898.  Contact your 
support personnel." error.
I don't know enough about the windows install to help you with this, but
Hiroshi probably 
can. Saito-san?
I tried changing the selected features and this error happens if (and
only if) I select the 
feature "Slony-I server module".  Guessing by the name, I think I need
this feature.
I suspect this is talking about the slons. In which case, you don't need
to run a slon on 
the windows machine. You can run both slons on the linux box. However I
would suggest that 
you run the slons for each machine from the machine it is managing
(unless you have 
dedicated management servers on the same LAN, in which case, run them
there).

As an experiment, I tried installing the various versions from 
http://developer.pgadmin.org/~hiroshi/Slony-I/
I assume that you already know this but I'll reiterate to be sure:
please do not run ancient 
versions of the software. You are almost always better off running the
latest 1.2.x release 
since there are very few features being added to 1.2 anymore, but plenty
of bug-fixes have 
gone in.

Andrew 

From z-saito at guitar.ocn.ne.jp  Tue Nov 13 22:06:10 2007
From: z-saito at guitar.ocn.ne.jp (Hiroshi Saito)
Date: Tue Nov 13 22:06:28 2007
Subject: [Slony1-general] Windows as master, Linux as slave
References: <4292CEA5F4927248979C701CA83500BB67F85C@SERVER.aperiogroup.local><00cf01c824ce$9464dc40$c601a8c0@HP22720319231><4292CEA5F4927248979C701CA83500BB67F8B4@SERVER.aperiogroup.local><5a0a9d6f0711131004j154ce595hbbcb4b2808249556@mail.gmail.com><4292CEA5F4927248979C701CA83500BB67F900@SERVER.aperiogroup.local><5a0a9d6f0711131332w4358fadfx7d01685c64faf9df@mail.gmail.com>
	<079101c82652$24272ca0$c601a8c0@HP22720319231>
Message-ID: <093201c82684$774e2e10$c601a8c0@HP22720319231>

Hi.

This is Windows-XP SP2 to OpenSUSE 10.3 replication.!!
http://winpg.jp/~saito/Slony-I-sample/WindowsToOpenSUSE/
It should prove that what it is satisfactory.:-)

Regards,
Hiroshi Saito

----- Original Message ----- 
From: "Hiroshi Saito" <z-saito@guitar.ocn.ne.jp>
> Hi.
>
> Did you try the following?
> --
> Um, There was the before same report. However, The problem was not reproduced in the
> environment of Dave with me. It was very strange. So, I wish to check one.
> Here is a new version.
> http://developer.pgadmin.org/~hiroshi/Slony-I/
> And if a problem still reappears, please use this. (This is VC8 compile module)
> http://developer.pgadmin.org/~hiroshi/Slony-I/slevent.dll
> MinGW (GCC) will be suspected if it operates well.
> --
>
> Regards,
> Hiroshi Saito
>
> ----- Original Message ----- 
> From: Andrew Hammond
> To: Walter Coole
> Cc: Hiroshi Saito ; slony1-general@lists.slony.info
> Sent: Wednesday, November 14, 2007 6:32 AM
> Subject: Re: [Slony1-general] Windows as master, Linux as slave
>
>
> On Nov 13, 2007 12:54 PM, Walter Coole <WCoole@aperiogroup.com> wrote:
>
> I got slony for the Linux hosts from from slony1-1.2.10.tar, the Windows hosts from 
> slony-I-1.2.11R-pg82.zip , so that might be the problem.
> Well, that's not gonna work. :)
>
> I tried installing PostgeSQL 8.2.4 and slony-I-1.2.10R-pg82 on a new Windows host (not 
> previously installed with PostgreSQL or Slony) and got the same "Module C:\Program 
> Files\PostgreSQL\8.2\lib\slevent.dll failed to register. HRESULT -2147023898.  Contact 
> your support personnel." error.
> I don't know enough about the windows install to help you with this, but Hiroshi probably 
> can. Saito-san?
> I tried changing the selected features and this error happens if (and only if) I select 
> the feature "Slony-I server module".  Guessing by the name, I think I need this feature.
> I suspect this is talking about the slons. In which case, you don't need to run a slon on 
> the windows machine. You can run both slons on the linux box. However I would suggest that 
> you run the slons for each machine from the machine it is managing (unless you have 
> dedicated management servers on the same LAN, in which case, run them there).
>
> As an experiment, I tried installing the various versions from 
> http://developer.pgadmin.org/~hiroshi/Slony-I/
> I assume that you already know this but I'll reiterate to be sure: please do not run 
> ancient versions of the software. You are almost always better off running the latest 
> 1.2.x release since there are very few features being added to 1.2 anymore, but plenty of 
> bug-fixes have gone in.
>
> Andrew
> _______________________________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general 

From WCoole at aperiogroup.com  Wed Nov 14 11:40:09 2007
From: WCoole at aperiogroup.com (Walter Coole)
Date: Wed Nov 14 11:40:42 2007
Subject: [Slony1-general] Windows as master, Linux as slave
In-Reply-To: <093201c82684$774e2e10$c601a8c0@HP22720319231>
References: <4292CEA5F4927248979C701CA83500BB67F85C@SERVER.aperiogroup.local><00cf01c824ce$9464dc40$c601a8c0@HP22720319231><4292CEA5F4927248979C701CA83500BB67F8B4@SERVER.aperiogroup.local><5a0a9d6f0711131004j154ce595hbbcb4b2808249556@mail.gmail.com><4292CEA5F4927248979C701CA83500BB67F900@SERVER.aperiogroup.local><5a0a9d6f0711131332w4358fadfx7d01685c64faf9df@mail.gmail.com>
	<079101c82652$24272ca0$c601a8c0@HP22720319231>
	<093201c82684$774e2e10$c601a8c0@HP22720319231>
Message-ID: <4292CEA5F4927248979C701CA83500BB67F96D@SERVER.aperiogroup.local>

It appears that both hosts are running PostgreSQL 8.2.5.  I'm running
8.2.4 (on both); does that seem like a plausible cause of difficulty?

It appears that the cluster initialization is being done from the
Windows host.  I was attempting to do it from the Linux host.  If I get
the chance, I'll try to figure out how to do it that way.

It looks like the screen shots show replication from SUSE
(192.168.1.125) to Windows (192.168.1.133).  That may turn out to be a
useful data point, but isn't a configuration that I have a use for.

I was hoping someone could point me to complete instructions on how to
set up a cluster, but it seems that such instructions aren't available.
I'm getting increasing pressure from my project manager to "stop messing
around and get on with it", so I may have to give up on Slony from
Windows soon, but I appreciate your help so far and hope you will have
much success in continuing your work.

Walter

-----Original Message-----
From: Hiroshi Saito [mailto:z-saito@guitar.ocn.ne.jp] 
Sent: Tuesday, November 13, 2007 10:06 PM
To: Andrew Hammond; Walter Coole
Cc: slony1-general@lists.slony.info
Subject: Re: [Slony1-general] Windows as master, Linux as slave

Hi.

This is Windows-XP SP2 to OpenSUSE 10.3 replication.!!
http://winpg.jp/~saito/Slony-I-sample/WindowsToOpenSUSE/
It should prove that what it is satisfactory.:-)

Regards,
Hiroshi Saito

----- Original Message ----- 
From: "Hiroshi Saito" <z-saito@guitar.ocn.ne.jp>
> Hi.
>
> Did you try the following?
> --
> Um, There was the before same report. However, The problem was not
reproduced in the
> environment of Dave with me. It was very strange. So, I wish to check
one.
> Here is a new version.
> http://developer.pgadmin.org/~hiroshi/Slony-I/
> And if a problem still reappears, please use this. (This is VC8
compile module)
> http://developer.pgadmin.org/~hiroshi/Slony-I/slevent.dll
> MinGW (GCC) will be suspected if it operates well.
> --
>
> Regards,
> Hiroshi Saito
>
> ----- Original Message ----- 
> From: Andrew Hammond
> To: Walter Coole
> Cc: Hiroshi Saito ; slony1-general@lists.slony.info
> Sent: Wednesday, November 14, 2007 6:32 AM
> Subject: Re: [Slony1-general] Windows as master, Linux as slave
>
>
> On Nov 13, 2007 12:54 PM, Walter Coole <WCoole@aperiogroup.com> wrote:
>
> I got slony for the Linux hosts from from slony1-1.2.10.tar, the
Windows hosts from 
> slony-I-1.2.11R-pg82.zip , so that might be the problem.
> Well, that's not gonna work. :)
>
> I tried installing PostgeSQL 8.2.4 and slony-I-1.2.10R-pg82 on a new
Windows host (not 
> previously installed with PostgreSQL or Slony) and got the same
"Module C:\Program 
> Files\PostgreSQL\8.2\lib\slevent.dll failed to register. HRESULT
-2147023898.  Contact 
> your support personnel." error.
> I don't know enough about the windows install to help you with this,
but Hiroshi probably 
> can. Saito-san?
> I tried changing the selected features and this error happens if (and
only if) I select 
> the feature "Slony-I server module".  Guessing by the name, I think I
need this feature.
> I suspect this is talking about the slons. In which case, you don't
need to run a slon on 
> the windows machine. You can run both slons on the linux box. However
I would suggest that 
> you run the slons for each machine from the machine it is managing
(unless you have 
> dedicated management servers on the same LAN, in which case, run them
there).
>
> As an experiment, I tried installing the various versions from 
> http://developer.pgadmin.org/~hiroshi/Slony-I/
> I assume that you already know this but I'll reiterate to be sure:
please do not run 
> ancient versions of the software. You are almost always better off
running the latest 
> 1.2.x release since there are very few features being added to 1.2
anymore, but plenty of 
> bug-fixes have gone in.
>
> Andrew
> _______________________________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general 

From WCoole at aperiogroup.com  Wed Nov 14 18:16:23 2007
From: WCoole at aperiogroup.com (Walter Coole)
Date: Wed Nov 14 18:16:59 2007
Subject: [Slony1-general] Windows as master, Linux as slave
References: <4292CEA5F4927248979C701CA83500BB67F85C@SERVER.aperiogroup.local><00cf01c824ce$9464dc40$c601a8c0@HP22720319231><4292CEA5F4927248979C701CA83500BB67F8B4@SERVER.aperiogroup.local><5a0a9d6f0711131004j154ce595hbbcb4b2808249556@mail.gmail.com><4292CEA5F4927248979C701CA83500BB67F900@SERVER.aperiogroup.local><5a0a9d6f0711131332w4358fadfx7d01685c64faf9df@mail.gmail.com>
	<079101c82652$24272ca0$c601a8c0@HP22720319231>
	<093201c82684$774e2e10$c601a8c0@HP22720319231> 
Message-ID: <4292CEA5F4927248979C701CA83500BB67F9A2@SERVER.aperiogroup.local>

So I'm trying to initialize the cluster from the Windows host; I have a
config file (Slonik1.txt) that looks like:

CLUSTER NAME = replica;
NODE 1 ADMIN CONNINFO = 'host=192.168.1.111 dbname=aperio user=slony';
NODE 2 ADMIN CONNINFO = 'host=192.168.1.117 dbname=aperio user=slony';
#INIT CLUSTER (ID = 1, COMMENT = 'Master Database');
echo '';

(I know it isn't complete, but I'm trying to isolate where the issue is
coming from).

I run the command "slonik Slonik1.txt" with no complaints, but if I
uncomment the INIT line, I get 

Slonik1.txt:4: could not open file C:/Program
Files/PostgreSQL/8.2/share/xxid.v81.sql
Slonik1.txt:4: ERROR: no admin conninfo for node 4014272

The error message is reasonable, since there is no file named C:/Program
Files/PostgreSQL/8.2/share/xxid.v81.sql , I do find a C:/Program
Files/PostgreSQL/8.2/share/xxid.v80.sql file.

Without having any better idea, I copied xxid.v80.sql to xxid.v81.sql
(and similarly a couple of other files) slonik is no longer complaining.

That's all I have time to do today, but this looks as though it might
lead to something that would work, so I'll plug away at it until someone
tells me I'm barking up the wrong tree.

Walter


-----Original Message-----
From: Walter Coole 
Sent: Wednesday, November 14, 2007 11:40 AM
To: 'Hiroshi Saito'; Andrew Hammond
Cc: slony1-general@lists.slony.info
Subject: RE: [Slony1-general] Windows as master, Linux as slave

It appears that both hosts are running PostgreSQL 8.2.5.  I'm running
8.2.4 (on both); does that seem like a plausible cause of difficulty?

It appears that the cluster initialization is being done from the
Windows host.  I was attempting to do it from the Linux host.  If I get
the chance, I'll try to figure out how to do it that way.

It looks like the screen shots show replication from SUSE
(192.168.1.125) to Windows (192.168.1.133).  That may turn out to be a
useful data point, but isn't a configuration that I have a use for.

I was hoping someone could point me to complete instructions on how to
set up a cluster, but it seems that such instructions aren't available.
I'm getting increasing pressure from my project manager to "stop messing
around and get on with it", so I may have to give up on Slony from
Windows soon, but I appreciate your help so far and hope you will have
much success in continuing your work.

Walter

-----Original Message-----
From: Hiroshi Saito [mailto:z-saito@guitar.ocn.ne.jp] 
Sent: Tuesday, November 13, 2007 10:06 PM
To: Andrew Hammond; Walter Coole
Cc: slony1-general@lists.slony.info
Subject: Re: [Slony1-general] Windows as master, Linux as slave

Hi.

This is Windows-XP SP2 to OpenSUSE 10.3 replication.!!
http://winpg.jp/~saito/Slony-I-sample/WindowsToOpenSUSE/
It should prove that what it is satisfactory.:-)

Regards,
Hiroshi Saito

----- Original Message ----- 
From: "Hiroshi Saito" <z-saito@guitar.ocn.ne.jp>
> Hi.
>
> Did you try the following?
> --
> Um, There was the before same report. However, The problem was not
reproduced in the
> environment of Dave with me. It was very strange. So, I wish to check
one.
> Here is a new version.
> http://developer.pgadmin.org/~hiroshi/Slony-I/
> And if a problem still reappears, please use this. (This is VC8
compile module)
> http://developer.pgadmin.org/~hiroshi/Slony-I/slevent.dll
> MinGW (GCC) will be suspected if it operates well.
> --
>
> Regards,
> Hiroshi Saito
>
> ----- Original Message ----- 
> From: Andrew Hammond
> To: Walter Coole
> Cc: Hiroshi Saito ; slony1-general@lists.slony.info
> Sent: Wednesday, November 14, 2007 6:32 AM
> Subject: Re: [Slony1-general] Windows as master, Linux as slave
>
>
> On Nov 13, 2007 12:54 PM, Walter Coole <WCoole@aperiogroup.com> wrote:
>
> I got slony for the Linux hosts from from slony1-1.2.10.tar, the
Windows hosts from 
> slony-I-1.2.11R-pg82.zip , so that might be the problem.
> Well, that's not gonna work. :)
>
> I tried installing PostgeSQL 8.2.4 and slony-I-1.2.10R-pg82 on a new
Windows host (not 
> previously installed with PostgreSQL or Slony) and got the same
"Module C:\Program 
> Files\PostgreSQL\8.2\lib\slevent.dll failed to register. HRESULT
-2147023898.  Contact 
> your support personnel." error.
> I don't know enough about the windows install to help you with this,
but Hiroshi probably 
> can. Saito-san?
> I tried changing the selected features and this error happens if (and
only if) I select 
> the feature "Slony-I server module".  Guessing by the name, I think I
need this feature.
> I suspect this is talking about the slons. In which case, you don't
need to run a slon on 
> the windows machine. You can run both slons on the linux box. However
I would suggest that 
> you run the slons for each machine from the machine it is managing
(unless you have 
> dedicated management servers on the same LAN, in which case, run them
there).
>
> As an experiment, I tried installing the various versions from 
> http://developer.pgadmin.org/~hiroshi/Slony-I/
> I assume that you already know this but I'll reiterate to be sure:
please do not run 
> ancient versions of the software. You are almost always better off
running the latest 
> 1.2.x release since there are very few features being added to 1.2
anymore, but plenty of 
> bug-fixes have gone in.
>
> Andrew
> _______________________________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general 

From trinaths at intoto.com  Wed Nov 14 20:03:40 2007
From: trinaths at intoto.com (Trinath Somanchi)
Date: Wed Nov 14 20:04:04 2007
Subject: [Slony1-general] SLONY -1 Portability options
Message-ID: <473BC51C.1010703@intoto.com>

Hi all,

I have configured SLONY - 1 (1.2.11) , in an FC6 machine .

Now , I want to the move the same replica on another Ubuntu machine .

Can it be possible that just move the slony directory or I need to =

install SLONY- 1 from the beginning in Ubuntu machine also so that only =

slony config needs changes . =


I'm trying to make an Installed slony Portable , so that rather than =

Installing it every time I can Use it by simply configuring .

Please help me in this regard ,



Best Regards,
-- =

Trinath Somanchi.

***************************************************************************=
*****
This email message (including any attachments) is for the sole use of the i=
ntended recipient(s) =

and may contain confidential, proprietary and privileged information. Any u=
nauthorized review, =

use, disclosure or distribution is prohibited. If you are not the intended =
recipient, =

please immediately notify the sender by reply email and destroy all copies =
of the original message. =

Thank you.
 =

Intoto Inc. =


-------------- next part --------------
A non-text attachment was scrubbed...
Name: trinaths.vcf
Type: text/x-vcard
Size: 316 bytes
Desc: not available
Url : http://lists.slony.info/pipermail/slony1-general/attachments/20071115=
/ca30a7c7/trinaths.vcf
From z-saito at guitar.ocn.ne.jp  Wed Nov 14 20:33:52 2007
From: z-saito at guitar.ocn.ne.jp (Hiroshi Saito)
Date: Wed Nov 14 20:34:03 2007
Subject: [Slony1-general] Windows as master, Linux as slave
References: <4292CEA5F4927248979C701CA83500BB67F85C@SERVER.aperiogroup.local><00cf01c824ce$9464dc40$c601a8c0@HP22720319231><4292CEA5F4927248979C701CA83500BB67F8B4@SERVER.aperiogroup.local><5a0a9d6f0711131004j154ce595hbbcb4b2808249556@mail.gmail.com><4292CEA5F4927248979C701CA83500BB67F900@SERVER.aperiogroup.local><5a0a9d6f0711131332w4358fadfx7d01685c64faf9df@mail.gmail.com>
	<079101c82652$24272ca0$c601a8c0@HP22720319231>
	<093201c82684$774e2e10$c601a8c0@HP22720319231>
	<4292CEA5F4927248979C701CA83500BB67F9A2@SERVER.aperiogroup.local>
Message-ID: <067201c82740$b9c22dc0$c601a8c0@HP22720319231>

Hi.

> 
> ----- Original Message ----- 
> From: "Walter Coole" <WCoole@aperiogroup.com>
> 
(snip)
> I run the command "slonik Slonik1.txt" with no complaints, but if I
> uncomment the INIT line, I get
> 
> Slonik1.txt:4: could not open file C:/Program
> Files/PostgreSQL/8.2/share/xxid.v81.sql
> Slonik1.txt:4: ERROR: no admin conninfo for node 4014272
> 
> The error message is reasonable, since there is no file named C:/Program
> Files/PostgreSQL/8.2/share/xxid.v81.sql , I do find a C:/Program
> Files/PostgreSQL/8.2/share/xxid.v80.sql file.

Error, It can't have firm belief of operation.:-(
Ooops sorry, It forgets to attach by pginstaller. fixed now.
Please use this.
http://developer.pgadmin.org/~hiroshi/Slony-I/

Regards,
Hiroshi Saito
From lukas at fmf.vtu.lt  Thu Nov 15 06:04:16 2007
From: lukas at fmf.vtu.lt (Lukas)
Date: Thu Nov 15 06:09:10 2007
Subject: [Slony1-general] 2 problems
Message-ID: <38605.217.117.29.29.1195135456.squirrel@fmf.vtu.lt>

Hello,

 I am running PostgreSQL 8.1.0 on Gentoo Linux, DB is replicated with Slon
version 1.2.0.
 Fist problem started with one node, with stopped to replicate with such
error:

2007-11-15 13:17:21 EET ERROR  remoteWorkerThread_1: "insert into
"public"."kainos"
(paslaugos,laikai,abonimentas,kaina,pastaba,rodyti,tipas,vienkartinis,gal
ioja_nuo,galioja_iki,id,pradine_imoka,intervalas,intervalas_paskutinis,imoku_skaicius,viso_sumoketi,periodine_imoka,max_pirkiniu_suma,padalinys,padaliniu_gru
pe) values ('baseinas+treniruokliai                  ','Visos dienos  
','1 m<EB>nesio                               ','284.00','Bendra korta    
   ','t','V
isi','f',NULL,NULL,'1110',NULL,NULL,NULL,NULL,NULL,NULL,'50.00','0','201');
" ERROR:  insert or update on table "kainos" violates foreign key
constraint "fk_kainos_padaliniu_grupe"
DETAIL:  Key (padaliniu_grupe)=(201) is not present in table
"padaliniu_grupes".

 Note that table "kainos" and table "padaliniu_grupes" are replicated!
only in two different sets.

 Then I wanted to drop FK constraint "fk_kainos_padaliniu_grupe" to let
replication goon, and then create it back, but I got error:

ERROR: "padaliniu_grupes_pkey" is an index
SQL state: 42809
(SQL was ALTER TABLE kainos DROP CONSTRAINT fk_kainos_padaliniu_grupe;)

 Why?
 "padaliniu_grupes_pkey" is not an index!! and I do not want to drop it...
"padaliniu_grupes_pkey" is a PK on table "padaliniu_grupes":
ALTER TABLE padaliniu_grupes ADD CONSTRAINT padaliniu_grupes_pkey PRIMARY
KEY(pg_id);


 Can anyone help us?

thx
Lukas






-- 
This message has been scanned for viruses and
dangerous content by OpenProtect(http://www.openprotect.com), and is
believed to be clean.

From ajs at crankycanuck.ca  Thu Nov 15 06:41:22 2007
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Thu Nov 15 06:41:35 2007
Subject: [Slony1-general] SLONY -1 Portability options
In-Reply-To: <473BC51C.1010703@intoto.com>
References: <473BC51C.1010703@intoto.com>
Message-ID: <20071115144122.GB20228@crankycanuck.ca>

On Thu, Nov 15, 2007 at 09:33:40AM +0530, Trinath Somanchi wrote:
> I have configured SLONY - 1 (1.2.11) , in an FC6 machine .
> 
> Now , I want to the move the same replica on another Ubuntu machine .
> 
> Can it be possible that just move the slony directory or I need to 
> install SLONY- 1 from the beginning in Ubuntu machine also so that only 
> slony config needs changes . 

If the libc, maybe the kernel, and the hardware architecture (e.g. 32 bit
x86 to 32 bit x86) are the same, this should be no problem.

If you have different versions of C libraries and such like, I wouldn't do
this.  What's so hard about ./configure; make; make install, anyway?

A

-- 
Andrew Sullivan
Old sigs will return after re-constitution of blue smoke
From threshar at torgo.978.org  Thu Nov 15 07:42:38 2007
From: threshar at torgo.978.org (Jeff Trout)
Date: Thu Nov 15 07:42:44 2007
Subject: [Slony1-general] Slony & High Volume Updates
Message-ID: <83F238DD-8389-4E5E-8150-6BDCC6F9BE2F@torgo.978.org>

Hey folks, I'm running slony 1.2.9 and in general it is working  
fantastic (THANKS!!)

I'm noticing in my pgfouine reports and by watching the db often the  
slony queries are taking up a lot of time.  This may be due to the  
high update volume of some of the replicated tables (One table in  
paticular gets about 6k-8k updates every 5 minutes. I suppose you  
could say 1k updates a minute).

I've run some of the queries that show up in explain, which seem to  
be coming out sane.  I'm just wondering if there is something I  
should be looking into about speeding it up, or if I should  
investigate something like log shipping.  (I've got a master and 3  
slaves.  2 of the slaves can lag a bit, 1 of the slaves should be  
about <=1s )

Examples (times in seconds):

3,556.72s
DELETE FROM "_replication".sl_log_1 WHERE log_origin = '2' AND  
log_xid < '4074411134'; DELETE FROM "_replication".sl_log_2 WHERE  
log_origin = '2' AND log_xid < '4074411134'; DELETE FROM  
"_replication".sl_seqlog WHERE seql_origin = '2' AND seql_ev_seqno <  
'1296696'; SELECT "_replication".logswitch_finish();


57.73s | notify "_replication_Event"; notify "_replication_Confirm";  
INSERT INTO "_replication".sl_event (ev_origin, ev_seqno,  
ev_timestamp, ev_minxid, ev_maxxid, ev_xip, ev_type ) VALUES ('4',  
'2049054', '2007-11-14 04:50:10.063141', '59155951', '59156428',  
'''59156426'',''59155951''', 'SYNC'); INSERT INTO  
"_replication".sl_confirm (con_origin, con_received, con_seqno,  
con_timestamp) VALUES (4, 3, '2049054', now()); COMMIT transaction;
57.72s | notify "_replication_Event"; notify "_replication_Confirm";  
INSERT INTO "_replication".sl_event (ev_origin, ev_seqno,  
ev_timestamp, ev_minxid, ev_maxxid, ev_xip, ev_type ) VALUES ('4',  
'2049054', '2007-11-14 04:50:10.063141', '59155951', '59156428',  
'''59156426'',''59155951''', 'SYNC'); INSERT INTO  
"_replication".sl_confirm (con_origin, con_received, con_seqno,  
con_timestamp) VALUES (4, 1, '2049054', now()); COMMIT transaction;
34.33s | notify "_replication_Event"; notify "_replication_Confirm";  
INSERT INTO "_replication".sl_event (ev_origin, ev_seqno,  
ev_timestamp, ev_minxid, ev_maxxid, ev_xip, ev_type ) VALUES ('4',  
'2040322', '2007-11-14 02:21:41.311908', '58935882', '58935883', '',  
'SYNC'); INSERT INTO "_replication".sl_confirm (con_origin,  
con_received, con_seqno, con_timestamp) VALUES (4, 3, '2040322', now 
()); COMMIT transaction;

105.57s | fetch 100 FROM LOG;
102.80s | fetch 100 FROM LOG;
80.58s | fetch 100 FROM LOG;


I'm going to turn on duration logging for all queries tonight to make  
sure I get a more accurate picture of where time is being spent.    
But like I said, I suppose this could be the nature of the beast with  
that crazy update table.

Should I look into perhaps seeing if those slow notify... queries  
were trying to run at the same time as that log switch?

thanks!


--
Jeff Trout <jeff@jefftrout.com>
http://www.dellsmartexitin.com/
http://www.stuarthamm.net/



From hsn at sendmail.cz  Thu Nov 15 08:48:50 2007
From: hsn at sendmail.cz (Radim Kolar SF.NET)
Date: Thu Nov 15 08:48:58 2007
Subject: [Slony1-general] how to remove failed node with set origin
In-Reply-To: <mailman.36.1195144543.3991.slony1-general@lists.slony.info>
References: <mailman.36.1195144543.3991.slony1-general@lists.slony.info>
Message-ID: <20071115164850.GA91228@sanatana.dharma>

i need to remove dead node from cluster. 

I cannot use failover because no other node is subscribed to set with
origin on failed node and i can not use drop node also because
Node 1 is still origin of one or more sets.

Can you give me hints how to edit slony catalog directly?
From dba at richyen.com  Thu Nov 15 09:27:04 2007
From: dba at richyen.com (Richard Yen)
Date: Thu Nov 15 09:27:13 2007
Subject: [Slony1-general] slony_logshipper
Message-ID: <7D8808C2-1DAB-4D2D-BA24-F28BA96F1068@richyen.com>

Hi guys,

I'm trying to find documentation on slony_logshipper.c and  
slony_logshipper.h...would anyone be able to explain what it does?

Is it something that will ship and replay my logs to a remote  
machine?  Or is it just the engine in the slon binary that generates  
the logs?  A cursory glance at it looks like it'll actually ship and  
replay logs...am I wrong?

Thanks!
--Richard
From ajs at crankycanuck.ca  Thu Nov 15 09:30:16 2007
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Thu Nov 15 09:30:28 2007
Subject: [Slony1-general] slony_logshipper
In-Reply-To: <7D8808C2-1DAB-4D2D-BA24-F28BA96F1068@richyen.com>
References: <7D8808C2-1DAB-4D2D-BA24-F28BA96F1068@richyen.com>
Message-ID: <20071115173016.GN20228@crankycanuck.ca>

On Thu, Nov 15, 2007 at 09:27:04AM -0800, Richard Yen wrote:
> Is it something that will ship and replay my logs to a remote  
> machine?  Or is it just the engine in the slon binary that generates  
> the logs?  A cursory glance at it looks like it'll actually ship and  
> replay logs...am I wrong?

Nope, you're not wrong.  It was always part of the design of Slony that you
should be able to ship logs with it.  (But v1.0 didn't include that.)

A

-- 
Andrew Sullivan
Old sigs will return after re-constitution of blue smoke
From andrew.george.hammond at gmail.com  Thu Nov 15 10:33:18 2007
From: andrew.george.hammond at gmail.com (Andrew Hammond)
Date: Thu Nov 15 10:33:25 2007
Subject: [Slony1-general] 2 problems
In-Reply-To: <38605.217.117.29.29.1195135456.squirrel@fmf.vtu.lt>
References: <38605.217.117.29.29.1195135456.squirrel@fmf.vtu.lt>
Message-ID: <5a0a9d6f0711151033l2656f64vfa7d160eb888c157@mail.gmail.com>

On Nov 15, 2007 6:04 AM, Lukas <lukas@fmf.vtu.lt> wrote:

> Hello,
>
>  I am running PostgreSQL 8.1.0


Bad idea, if you want to use the 8.1 series, use the latest, 8.1.10


> on Gentoo Linux,


I don't know how you decided on Gentoo as a platform for your database. It
strikes me as a stupid choice.


> DB is replicated with Slon version 1.2.0.


Once again, bad idea. For new clusters, you should always use the latest
stable release, currently that is 1.2.12.


> Fist problem started with one node, with stopped to replicate with such
> error:
>
> 2007-11-15 13:17:21 EET ERROR  remoteWorkerThread_1: "insert into
> "public"."kainos"
> (paslaugos,laikai,abonimentas,kaina,pastaba,rodyti,tipas,vienkartinis,gal
>
> ioja_nuo,galioja_iki,id,pradine_imoka,intervalas,intervalas_paskutinis,im=
oku_skaicius,viso_sumoketi,periodine_imoka,max_pirkiniu_suma,padalinys,pada=
liniu_gru
> pe) values ('baseinas+treniruokliai                  ','Visos dienos
> ','1 m<EB>nesio                               ','284.00','Bendra korta
>   ','t','V
> isi','f',NULL,NULL,'1110',NULL,NULL,NULL,NULL,NULL,NULL,'50.00
> ','0','201');
> " ERROR:  insert or update on table "kainos" violates foreign key
> constraint "fk_kainos_padaliniu_grupe"
> DETAIL:  Key (padaliniu_grupe)=3D(201) is not present in table
> "padaliniu_grupes".
>
>  Note that table "kainos" and table "padaliniu_grupes" are replicated!
> only in two different sets.


That's probably a bad idea. Unless you have a very good reason to put them
in different sets, you should keep stuff that inter-relates together in a
single set. Are both sets subscribed on your replica?


> Then I wanted to drop FK constraint "fk_kainos_padaliniu_grupe" to let
> replication goon, and then create it back, but I got error:
>
> ERROR: "padaliniu_grupes_pkey" is an index
> SQL state: 42809
> (SQL was ALTER TABLE kainos DROP CONSTRAINT fk_kainos_padaliniu_grupe;)


There are two things obviously wrong with this.

1) You're trying to drop a different constraint than the one that's
complaining.
2) You're messing around with your schema when slony expects and require
them to be identical. There can be exceptions to this rule, but to start out
with you'd better just follow it.


> Why?
>  "padaliniu_grupes_pkey" is not an index!! and I do not want to drop it...
> "padaliniu_grupes_pkey" is a PK on table "padaliniu_grupes":
> ALTER TABLE padaliniu_grupes ADD CONSTRAINT padaliniu_grupes_pkey PRIMARY
> KEY(pg_id);


PostgreSQL uses unique indexes to implement primary keys. But as I mentioned
before, making changes to your schema is probably not the right way to solve
your problem.

Andrew
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20071115/=
1fff7aeb/attachment.htm
From lukas at fmf.vtu.lt  Thu Nov 15 11:00:14 2007
From: lukas at fmf.vtu.lt (Lukas)
Date: Thu Nov 15 11:04:11 2007
Subject: [Slony1-general] 2 problems
In-Reply-To: <5a0a9d6f0711151033l2656f64vfa7d160eb888c157@mail.gmail.com>
References: <38605.217.117.29.29.1195135456.squirrel@fmf.vtu.lt>
	<5a0a9d6f0711151033l2656f64vfa7d160eb888c157@mail.gmail.com>
Message-ID: <62155.217.117.29.29.1195153214.squirrel@fmf.vtu.lt>

Hello, and thanks for answer,


>> on Gentoo Linux,

> I don't know how you decided on Gentoo as a platform for your database. It
> strikes me as a stupid choice.

In two sentences, why?


>> DB is replicated with Slon version 1.2.0.
> Once again, bad idea. For new clusters, you should always use the latest
> stable release, currently that is 1.2.12.

Yes, I agree. One question: can I use different slon versions on different
nodes in one replica?


>
>
>> Fist problem started with one node, with stopped to replicate with such
>> error:
>>
>> 2007-11-15 13:17:21 EET ERROR  remoteWorkerThread_1: "insert into
>> "public"."kainos"
>> (paslaugos,laikai,abonimentas,kaina,pastaba,rodyti,tipas,vienkartinis,gal
>>
>> ioja_nuo,galioja_iki,id,pradine_imoka,intervalas,intervalas_paskutinis,imoku_skaicius,viso_sumoketi,periodine_imoka,max_pirkiniu_suma,padalinys,padaliniu_gru
>> pe) values ('baseinas+treniruokliai                  ','Visos dienos
>> ','1 m<EB>nesio                               ','284.00','Bendra korta
>>   ','t','V
>> isi','f',NULL,NULL,'1110',NULL,NULL,NULL,NULL,NULL,NULL,'50.00
>> ','0','201');
>> " ERROR:  insert or update on table "kainos" violates foreign key
>> constraint "fk_kainos_padaliniu_grupe"
>> DETAIL:  Key (padaliniu_grupe)=(201) is not present in table
>> "padaliniu_grupes".
>>
>>  Note that table "kainos" and table "padaliniu_grupes" are replicated!
>> only in two different sets.
>
>
> That's probably a bad idea. Unless you have a very good reason to put them
> in different sets, you should keep stuff that inter-relates together in a
> single set. Are both sets subscribed on your replica?

Yes, all sets are on my replica.


> PostgreSQL uses unique indexes to implement primary keys. But as I
> mentioned
> before, making changes to your schema is probably not the right way to
> solve
> your problem.
Yes, I agree, it just a try for work around.. Can you suggest something?


Lukas


-- 
This message has been scanned for viruses and
dangerous content by OpenProtect(http://www.openprotect.com), and is
believed to be clean.

From vivek at khera.org  Thu Nov 15 13:38:58 2007
From: vivek at khera.org (Vivek Khera)
Date: Thu Nov 15 13:39:08 2007
Subject: [Slony1-general] 1.2.12 success + error
Message-ID: <B2FFC89A-56A9-4CCE-B175-6F94C81D27A2@khera.org>

I updated my cluster to 1.2.12 today.  All machines are running  
FreeBSD 6.1/i386 or 6.2/amd64.  It upgraded very nicely on all boxes  
except one.

On one box, I happend to have bison 1.75 installed.  This caused slony  
compile to fail miserably when it tried to regenerate the parser for  
the log shipper, as shown below.  Simply uninstalling bison allowed it  
to build to completion and successful deployment.

What's the minimum version of bison this will work with?  If possible,  
the configure script should check for that.


cc -I/usr/local/include -I/usr/local/include/postgresql/server  -O2 - 
fno-strict-aliasing -pipe  -Wall -Wmissing-prototypes -Wmissing- 
declarations -I../.. -DPGSHARE="\"/usr/local/share/postgresql\""  -c - 
o ipcutil.o ipcutil.c
bison -y -d  parser.y
parser.y:358.20: parse error, unexpected ":", expecting ";" or "|"
parser.y:359.6-366.8: $$ of `arch_tracking' has no declared type
parser.y:526.15: parse error, unexpected ":", expecting ";" or "|"
parser.y:527.6-533.26: $4 of `arch_upd_set' has no declared type
parser.y:527.6-534.26: invalid $ value
parser.y:527.6-534.26: $6 of `arch_upd_set' has no declared type
parser.y:527.6-536.29: invalid $ value
parser.y:527.6-536.29: $7 of `arch_upd_set' has no declared type
parser.y:724.19-736.11: type clash (`att_elem' `str') on default action
parser.y:736.15: parse error, unexpected ":", expecting ";" or "|"
parser.y:737.6-742.30: $5 of `arch_ident_eq_lit' has no declared type
parser.y:737.6-746.15: $5 of `arch_ident_eq_lit' has no declared type
parser.y:737.6-748.14: $5 of `arch_ident_eq_lit' has no declared type
parser.y:737.6-760.14: $5 of `arch_ident_eq_lit' has no declared type
parser.y:811.18: parse error, unexpected ":", expecting ";" or "|"
parser.y:812.6-819.8: $$ of `arch_finishtable' has no declared type
parser.y:841.21: parse error, unexpected ":", expecting ";" or "|"
parser.y:842.6-849.8: $$ of `arch_seqsetval' has no declared type
parser.y:872.20: parse error, unexpected ":", expecting ";" or "|"
parser.y:873.6-880.8: $$ of `arch_pgsetval' has no declared type
parser.y:1057.15-1062.13: type clash (`str' `') on default action
parser.y:1062.16: parse error, unexpected ":", expecting ";" or "|"
gmake[3]: *** [parser.c] Error 1
gmake[3]: Leaving directory `/var/tmp/n/lorax1/usr/ports/databases/ 
slony1/work/slony1-1.2.12/src/slony_logshipper'
gmake[2]: *** [all] Error 2




From cbbrowne at ca.afilias.info  Thu Nov 15 19:07:21 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Thu Nov 15 19:07:36 2007
Subject: [Slony1-general] Slony & High Volume Updates
In-Reply-To: <83F238DD-8389-4E5E-8150-6BDCC6F9BE2F@torgo.978.org> (Jeff
	Trout's message of "Thu, 15 Nov 2007 10:42:38 -0500")
References: <83F238DD-8389-4E5E-8150-6BDCC6F9BE2F@torgo.978.org>
Message-ID: <60fxz6c2hi.fsf@dba2.int.libertyrms.com>

Jeff Trout <threshar@torgo.978.org> writes:
> I've run some of the queries that show up in explain, which seem to
> be coming out sane.  I'm just wondering if there is something I
> should be looking into about speeding it up, or if I should
> investigate something like log shipping.  (I've got a master and 3
> slaves.  2 of the slaves can lag a bit, 1 of the slaves should be
> about <=1s )

I don't think log shipping would help anything here, from two perspectives:

1.  It still requires having a regular subscriber around; all it
therefore buys you is the ability for *EXTRA* copies to be made more
cheaply.

2.  There shouldn't be anything about log shipping itself that would
provide any extra efficiencies.

> Should I look into perhaps seeing if those slow notify... queries
> were trying to run at the same time as that log switch?

If things are too slow, about the only thing that has been observed (I
can't call it verified) that is argued to make a difference is to
increase the number of tuples processed at a time.

You *might* get a benefit by increasing the parameter
"SLON_DATA_FETCH_SIZE", presently set to 10, in slon.h, to some
moderately larger number.  

I would expect it to be a Bad Thing to increase it to >> 1000, as this
would seem likely to make memory usage increase, with little
concommittant potential for improvement. 

Assuming that fiddling with this *does* provide potential for
improvement for heavy-update sites, I would expect increasing it to
something like 50 to be the "conservative" approach...

However, that assumes that this could be a fruitful improvement, which
has yet to be verified...

For the most part, if you are finding things "too slow," then I would
be more inclined to point firstly at the ideas of:

 - Tune Thy Database
  and
 - If Thine Database Be Tuned, then Upgrade Thine Hardware.

Performance of replication is mostly an emergent property falling from
how heavily loaded your systems are, and whether they actually have
the "bandwidth" free to cope with replication.

There isn't any obvious "Go Faster" flag - if there were, we'd have either:
a) Set it as a default, or
b) Noticed that it was a significant config parameter worth fiddling with.
-- 
(format nil "~S@~S" "cbbrowne" "acm.org")
http://cbbrowne.com/info/spiritual.html
"There  is no  psychiatrist in  the world  like a  puppy  licking your
face."  -- Ben Williams
From cbbrowne at ca.afilias.info  Thu Nov 15 19:14:45 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Thu Nov 15 19:14:57 2007
Subject: [Slony1-general] 2 problems
In-Reply-To: <62155.217.117.29.29.1195153214.squirrel@fmf.vtu.lt>
	(lukas@fmf.vtu.lt's message of "Thu,
	15 Nov 2007 21:00:14 +0200 (EET)")
References: <38605.217.117.29.29.1195135456.squirrel@fmf.vtu.lt>
	<5a0a9d6f0711151033l2656f64vfa7d160eb888c157@mail.gmail.com>
	<62155.217.117.29.29.1195153214.squirrel@fmf.vtu.lt>
Message-ID: <60bq9uc256.fsf@dba2.int.libertyrms.com>

"Lukas" <lukas@fmf.vtu.lt> writes:
> Hello, and thanks for answer,
>
>
>>> on Gentoo Linux,
>
>> I don't know how you decided on Gentoo as a platform for your database. It
>> strikes me as a stupid choice.
>
> In two sentences, why?

I daresay I don't understand what Gentoo is supposed to actually be
good for.

At one time, it seemed to be a version of Linux intended for use by
people with some sort of "micro-optimization via GCC flags" fetish.
Alas, the "Gentoo is for Ricers" web page has been taken down :-(.

Absent of that, I don't grasp what the strength is supposed to be.

In the absence of clear control over precisely what is being compiled,
it seems like not quite the stablest kind of platform to me; absent of
the "microoptimization" thing, I don't know what the benefits are
supposed to be.

>>> DB is replicated with Slon version 1.2.0.
>> Once again, bad idea. For new clusters, you should always use the latest
>> stable release, currently that is 1.2.12.
>
> Yes, I agree. One question: can I use different slon versions on different
> nodes in one replica?

No, you cannot.

All nodes in the cluster MUST use the same version of Slony-I at all
times.  Any mismatch will cause the slon to fall over.
-- 
output = ("cbbrowne" "@" "linuxfinances.info")
http://linuxdatabases.info/info/unix.html
"Linux!  Guerrilla Unix Development     Venimus, Vidimus, Dolavimus."
-- <mah@ka4ybr.com> Mark A. Horton KA4YBR
From stephane.schildknecht at postgresqlfr.org  Thu Nov 15 06:17:15 2007
From: stephane.schildknecht at postgresqlfr.org (=?ISO-8859-1?Q?=22St=E9phane_A=2E_Schildknecht=22?=)
Date: Thu Nov 15 23:04:10 2007
Subject: [Slony1-general] Version 1.2.12 released
In-Reply-To: <47396E63.8080106@free.fr>
References: <601wavf4kp.fsf@dba2.int.libertyrms.com> <47396E63.8080106@free.fr>
Message-ID: <473C54EB.7060904@postgresqlfr.org>

Cyril SCETBON a ?crit :
> Hi,
>
> I think it would be better to be able to modify SLON_DATA_FETCH_SIZE
> by using a parameter on the slon command line. For example, we got a
> lot of updates (400 per second) between far geographical sites. I had
> to modify this variable and to recompile the slon binary cause I
> didn't find another way until now.
>
> Regards.
>

Hi,

How did you modify this variable? Increase or decrease ? What was the
problem you encountered ?

Best reagrds,

-- 
St?phane SCHILDKNECHT
Pr?sident de PostgreSQLFr
http://www.postgresqlfr.org


From depesz at depesz.com  Fri Nov 16 01:00:48 2007
From: depesz at depesz.com (hubert depesz lubaczewski)
Date: Fri Nov 16 01:01:07 2007
Subject: [Slony1-general] deadlock in "execute script"?
In-Reply-To: <20071029165300.GU15327@crankycanuck.ca>
References: <20071026004647.GA8979@depesz.com>
	<20071026135451.GD4717@crankycanuck.ca>
	<20071028111046.GA19183@depesz.com>
	<20071029165300.GU15327@crankycanuck.ca>
Message-ID: <20071116090048.GA4162@depesz.com>

On Mon, Oct 29, 2007 at 12:53:00PM -0400, Andrew Sullivan wrote:
> > after all - insert/update/delete happens trigger *knows* the structure
> > of the table the event took place on.
> No, it doesn't.  That's exactly the problem.  It looks like it to a

ok, sorry for refreshing the thread, but i just checked sl_log_* (for
different reason) and column names *are* there.
so - since they are inserted by trigger - it means trigger knows them!

example:
# select * from _friendnet.sl_log_2 limit 3;
-[ RECORD 1 ]-+----------------------------------------------------------------------------
log_origin    | 1
log_xid       | 732269653
log_tableid   | 202
log_actionseq | 34868612
log_cmdtype   | U
log_cmddata   | count='1',cover='391396' where id='263780'
-[ RECORD 2 ]-+----------------------------------------------------------------------------
log_origin    | 1
log_xid       | 732269849
log_tableid   | 69
log_actionseq | 34868617
log_cmdtype   | I
log_cmddata   | (a,b,added) values ('1151711','1072820','2007-11-16 09:44:15.003328+01')
-[ RECORD 3 ]-+----------------------------------------------------------------------------
log_origin    | 1
log_xid       | 732269849
log_tableid   | 69
log_actionseq | 34868618
log_cmdtype   | I
log_cmddata   | (a,b,added) values ('1072820','1151711','2007-11-16 09:44:15.003328+01')

so, the question is - what am i missing?

best regards,

depesz

-- 
quicksil1er: "postgres is excellent, but like any DB it requires a
highly paid DBA.  here's my CV!" :)
http://www.depesz.com/ - blog dla ciebie (i moje CV)
From cedric.villemain at dalibo.com  Fri Nov 16 01:15:20 2007
From: cedric.villemain at dalibo.com (=?ISO-8859-1?Q?C=E9dric_Villemain?=)
Date: Fri Nov 16 01:15:45 2007
Subject: [Slony1-general] Slony & High Volume Updates
In-Reply-To: <60fxz6c2hi.fsf@dba2.int.libertyrms.com>
References: <83F238DD-8389-4E5E-8150-6BDCC6F9BE2F@torgo.978.org>
	<60fxz6c2hi.fsf@dba2.int.libertyrms.com>
Message-ID: <473D5FA8.10909@dalibo.com>

Christopher Browne a ?crit :
> Jeff Trout <threshar@torgo.978.org> writes:
>   
>> I've run some of the queries that show up in explain, which seem to
>> be coming out sane.  I'm just wondering if there is something I
>> should be looking into about speeding it up, or if I should
>> investigate something like log shipping.  (I've got a master and 3
>> slaves.  2 of the slaves can lag a bit, 1 of the slaves should be
>> about <=1s )
>>     
>
> I don't think log shipping would help anything here, from two perspectives:
>
> 1.  It still requires having a regular subscriber around; all it
> therefore buys you is the ability for *EXTRA* copies to be made more
> cheaply.
>
> 2.  There shouldn't be anything about log shipping itself that would
> provide any extra efficiencies.
>
>   
>> Should I look into perhaps seeing if those slow notify... queries
>> were trying to run at the same time as that log switch?
>>     
>
> If things are too slow, about the only thing that has been observed (I
> can't call it verified) that is argued to make a difference is to
> increase the number of tuples processed at a time.
>
> You *might* get a benefit by increasing the parameter
> "SLON_DATA_FETCH_SIZE", presently set to 10, in slon.h, to some
> moderately larger number.  
>   

I played a time with that, and also with removing the 'seqscan off' from 
slony source. 
The seqscan off come probably from long time ago ? Is it still necessary ?

> I would expect it to be a Bad Thing to increase it to >> 1000, as this
> would seem likely to make memory usage increase, with little
> concommittant potential for improvement. 
>
> Assuming that fiddling with this *does* provide potential for
> improvement for heavy-update sites, I would expect increasing it to
> something like 50 to be the "conservative" approach...
>
> However, that assumes that this could be a fruitful improvement, which
> has yet to be verified...
>
> For the most part, if you are finding things "too slow," then I would
> be more inclined to point firstly at the ideas of:
>
>  - Tune Thy Database
>   and
>  - If Thine Database Be Tuned, then Upgrade Thine Hardware.
>
> Performance of replication is mostly an emergent property falling from
> how heavily loaded your systems are, and whether they actually have
> the "bandwidth" free to cope with replication.
>
> There isn't any obvious "Go Faster" flag - if there were, we'd have either:
> a) Set it as a default, or
> b) Noticed that it was a significant config parameter worth fiddling with.
>   

From ajs at crankycanuck.ca  Fri Nov 16 07:57:25 2007
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Fri Nov 16 07:57:44 2007
Subject: [Slony1-general] deadlock in "execute script"?
In-Reply-To: <20071116090048.GA4162@depesz.com>
References: <20071026004647.GA8979@depesz.com>
	<20071026135451.GD4717@crankycanuck.ca>
	<20071028111046.GA19183@depesz.com>
	<20071029165300.GU15327@crankycanuck.ca>
	<20071116090048.GA4162@depesz.com>
Message-ID: <20071116155725.GH24718@crankycanuck.ca>

On Fri, Nov 16, 2007 at 10:00:48AM +0100, hubert depesz lubaczewski wrote:
> ok, sorry for refreshing the thread, but i just checked sl_log_* (for
> different reason) and column names *are* there.

Yes they are.

> so - since they are inserted by trigger - it means trigger knows them!

Only sort of.  Not the way you think.  If you look at the trigger
definitions on the tables, you'll see that there are funny little symbols
there.  That's how the columns get represented.

A

-- 
Andrew Sullivan
Old sigs will return after re-constitution of blue smoke
From depesz at depesz.com  Fri Nov 16 08:05:01 2007
From: depesz at depesz.com (hubert depesz lubaczewski)
Date: Fri Nov 16 08:05:08 2007
Subject: [Slony1-general] deadlock in "execute script"?
In-Reply-To: <20071116155725.GH24718@crankycanuck.ca>
References: <20071026004647.GA8979@depesz.com>
	<20071026135451.GD4717@crankycanuck.ca>
	<20071028111046.GA19183@depesz.com>
	<20071029165300.GU15327@crankycanuck.ca>
	<20071116090048.GA4162@depesz.com>
	<20071116155725.GH24718@crankycanuck.ca>
Message-ID: <20071116160501.GA13303@depesz.com>

On Fri, Nov 16, 2007 at 10:57:25AM -0500, Andrew Sullivan wrote:
> Yes they are.
> > so - since they are inserted by trigger - it means trigger knows them!
> Only sort of.  Not the way you think.  If you look at the trigger
> definitions on the tables, you'll see that there are funny little symbols
> there.  That's how the columns get represented.

ok, but the trigger inserts column names to sl_log_x tables.

inserted data contains *real* column names.

so - combining these two statements would generate "trigger knows *real*
column names".

knowing this - why can't we/slony abandon these "funny little symbols"
and store key-column-names directly?

please do not take this question as offensive. i'm merely asking because
i dont udnerstand, and in my understanding this would lead to much
easier working with slony (i.e. no "execute script" neccessity for
adding columns).

depesz

-- 
quicksil1er: "postgres is excellent, but like any DB it requires a
highly paid DBA.  here's my CV!" :)
http://www.depesz.com/ - blog dla ciebie (i moje CV)
From jc at oxado.com  Fri Nov 16 08:12:22 2007
From: jc at oxado.com (Jacques Caron)
Date: Fri Nov 16 08:12:45 2007
Subject: [Slony1-general] deadlock in "execute script"?
In-Reply-To: <20071116160501.GA13303@depesz.com>
References: <20071026004647.GA8979@depesz.com>
	<20071026135451.GD4717@crankycanuck.ca>
	<20071028111046.GA19183@depesz.com>
	<20071029165300.GU15327@crankycanuck.ca>
	<20071116090048.GA4162@depesz.com>
	<20071116155725.GH24718@crankycanuck.ca>
	<20071116160501.GA13303@depesz.com>
Message-ID: <20071116161236.8480D1165961@zeus.directinfos.com>

At 17:05 16/11/2007, hubert depesz lubaczewski wrote:
>so - combining these two statements would generate "trigger knows *real*
>column names".

It actually finds them, yes (reading the list of attributes of the 
table in pg_attributes, IIRC).

>knowing this - why can't we/slony abandon these "funny little symbols"
>and store key-column-names directly?

They're actually used to find which columns are part of the key used 
for replication (the PK usually) and which are not. This is necessary 
for UPDATE statements (non-key columns go into the SET clause, key 
columns go into the WHERE clause) and DELETE statements (only key 
columns are used in the WHERE clause).

>please do not take this question as offensive. i'm merely asking because
>i dont udnerstand, and in my understanding this would lead to much
>easier working with slony (i.e. no "execute script" neccessity for
>adding columns).

As stated in an earlier post, you don't really need to, as long as 
your new column doesn't have a constraint, default value, or anything 
like that (just a simple "name type" and nothing else). Just add the 
column on the slaves, then add a "v" to the trigger as explained in 
that post, then add the column on the source. Et voila.

Indeed a quick patch would remove the requirement to update the 
trigger, but that's another story.

In any other situation (default values, constraints...), it is (very 
often) important that at least the change be done at the same point 
in the event stream on all machines in the set, and it is therefore 
necessary to use the EXECUTE SCRIPT system.

Hope that helps,

Jacques.

From ajs at crankycanuck.ca  Fri Nov 16 08:26:54 2007
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Fri Nov 16 08:27:12 2007
Subject: [Slony1-general] deadlock in "execute script"?
In-Reply-To: <20071116160501.GA13303@depesz.com>
References: <20071026004647.GA8979@depesz.com>
	<20071026135451.GD4717@crankycanuck.ca>
	<20071028111046.GA19183@depesz.com>
	<20071029165300.GU15327@crankycanuck.ca>
	<20071116090048.GA4162@depesz.com>
	<20071116155725.GH24718@crankycanuck.ca>
	<20071116160501.GA13303@depesz.com>
Message-ID: <20071116162654.GK24718@crankycanuck.ca>

On Fri, Nov 16, 2007 at 05:05:01PM +0100, hubert depesz lubaczewski wrote:
> 
> ok, but the trigger inserts column names to sl_log_x tables.

Right.  Based on you telling the trigger that the columns are there.

The trigger uses an SPI function, so that it doesn't have to look all this
stuff up all the time.  So it's cached.

But none of this is why you have to use execute script to add columns.

You have to use execute script to add columns so that the system can ensure
that the visibility rules are followed across all nodes.  This is explained
in the concepts document, which is available from the web site.  It's a
subtle problem, but one that results from the combination of async
replication, no direct back-end hooks, and MVCC.  Please go and read that
concepts document before raising this thread again.  If you show evidence of
having read it, maybe Jan will reply to you instead, because he's in a
better position to explain much of this than I am.

A

-- 
Andrew Sullivan
Old sigs will return after re-constitution of blue smoke
From andrew.george.hammond at gmail.com  Fri Nov 16 10:38:42 2007
From: andrew.george.hammond at gmail.com (Andrew Hammond)
Date: Fri Nov 16 10:38:50 2007
Subject: [Slony1-general] 2 problems
In-Reply-To: <62155.217.117.29.29.1195153214.squirrel@fmf.vtu.lt>
References: <38605.217.117.29.29.1195135456.squirrel@fmf.vtu.lt>
	<5a0a9d6f0711151033l2656f64vfa7d160eb888c157@mail.gmail.com>
	<62155.217.117.29.29.1195153214.squirrel@fmf.vtu.lt>
Message-ID: <5a0a9d6f0711161038s2fada05r8b82a45ce89ec1a2@mail.gmail.com>

On Nov 15, 2007 11:00 AM, Lukas <lukas@fmf.vtu.lt> wrote:

> Hello, and thanks for answer,
>
>
> >> on Gentoo Linux,
>
> > I don't know how you decided on Gentoo as a platform for your database.
> It
> > strikes me as a stupid choice.
>
> In two sentences, why?


1) While it may be possible to use Gentoo in some fashion to achieve
stability, it will always be associated with ricer performance tweaking via
the random application of experimental CFLAGs, particularly when contrasted
with for example debian or RHEL (if you want to stay in the Linux world).

1) People who are serious about running databases care a great deal about
consistency, Gentoo fosters to opposite with their "tweak it yourself".

>> DB is replicated with Slon version 1.2.0.
> > Once again, bad idea. For new clusters, you should always use the latest
> > stable release, currently that is 1.2.12.
>
> Yes, I agree. One question: can I use different slon versions on different
> nodes in one replica?


No. It may be possible with some non-trivial hacking, but if you care about
your data enough to replicate it, then you should probably care enough to
schedule appropriate downtimes to do maintenance correctly.

>> Fist problem started with one node, with stopped to replicate with such
> >> error:
> >>
> >> 2007-11-15 13:17:21 EET ERROR  remoteWorkerThread_1: "insert into
> >> "public"."kainos"
> >>
> (paslaugos,laikai,abonimentas,kaina,pastaba,rodyti,tipas,vienkartinis,gal
> >>
> >>
> ioja_nuo,galioja_iki,id,pradine_imoka,intervalas,intervalas_paskutinis,im=
oku_skaicius,viso_sumoketi,periodine_imoka,max_pirkiniu_suma,padalinys,pada=
liniu_gru
> >> pe) values ('baseinas+treniruokliai                  ','Visos dienos
> >> ','1 m<EB>nesio                               ','284.00','Bendra korta
> >>   ','t','V
> >> isi','f',NULL,NULL,'1110',NULL,NULL,NULL,NULL,NULL,NULL,'50.00
> >> ','0','201');
> >> " ERROR:  insert or update on table "kainos" violates foreign key
> >> constraint "fk_kainos_padaliniu_grupe"
> >> DETAIL:  Key (padaliniu_grupe)=3D(201) is not present in table
> >> "padaliniu_grupes".
> >>
> >>  Note that table "kainos" and table "padaliniu_grupes" are replicated!
> >> only in two different sets.
> >
> >
> > That's probably a bad idea. Unless you have a very good reason to put
> them
> > in different sets, you should keep stuff that inter-relates together in
> a
> > single set. Are both sets subscribed on your replica?
>
> Yes, all sets are on my replica.


I'm curious how you can get a foreign key error from a subscribed table.
That should be impossible since the triggers which implement foreign keys
are "deactivated" by slony upon subscription. On the subscriber, using psql,
please do \d+ kainos then same for padaliniu_grupes.


> > PostgreSQL uses unique indexes to implement primary keys. But as I
> > mentioned
> > before, making changes to your schema is probably not the right way to
> > solve
> > your problem.
> Yes, I agree, it just a try for work around.. Can you suggest something?


Did you have replication working correctly at some point?  If so, please
detail everything you've done (slonik scripts, any ddl) since your last
known-good baseline.

Andrew
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20071116/=
21caf44e/attachment.htm
From threshar at torgo.978.org  Fri Nov 16 11:47:29 2007
From: threshar at torgo.978.org (Jeff Trout)
Date: Fri Nov 16 11:47:39 2007
Subject: [Slony1-general] Slony & High Volume Updates
In-Reply-To: <60fxz6c2hi.fsf@dba2.int.libertyrms.com>
References: <83F238DD-8389-4E5E-8150-6BDCC6F9BE2F@torgo.978.org>
	<60fxz6c2hi.fsf@dba2.int.libertyrms.com>
Message-ID: <C43DC02B-041C-4A18-AC49-547DC6631037@torgo.978.org>


On Nov 15, 2007, at 10:07 PM, Christopher Browne wrote:

>
> You *might* get a benefit by increasing the parameter
> "SLON_DATA_FETCH_SIZE", presently set to 10, in slon.h, to some
> moderately larger number.
>
Well, in the logs I see lots of  "fetch 100 FROM LOG;" coming out of  
it.  I didn't change the source, so I guess it changed from the 10 to  
100 (it is set to 100 in that header).

> For the most part, if you are finding things "too slow," then I would
> be more inclined to point firstly at the ideas of:
>
I'm just wondering if it is normal for those things - such as the log  
switch, to take so long.
The DB is pretty tuned.  Its got 2x4 core xeons for cpu, plugged into  
an msa70 with 8 15k sas disks in a raid6. IO shouldn't be much of a  
problem.

I guess I'll dig in more and see what else is happening when it tries  
to switch the logs. I'm also not sure how much of htat time is spent  
waiting for locks and whatnot.  like I said, I just noticed the  
queries popping up in the "queries sucking the most time" list.


--
Jeff Trout <jeff@jefftrout.com>
http://www.dellsmartexitin.com/
http://www.stuarthamm.net/



From honza at jyxo.com  Sat Nov 17 13:00:12 2007
From: honza at jyxo.com (Jan Matousek)
Date: Sat Nov 17 13:00:43 2007
Subject: [Slony1-general] how to remove failed node with set origin
In-Reply-To: <20071115164850.GA91228@sanatana.dharma>
References: <mailman.36.1195144543.3991.slony1-general@lists.slony.info>
	<20071115164850.GA91228@sanatana.dharma>
Message-ID: <c14eaebb0711171300w647439b1m6f1c54305a122f70@mail.gmail.com>

Hi,

the FAILOVER slonik command ran with error?
I have used FAILOVER on node, which was subscriber of single set, and
it have worked.

I think that failover has two purposes - first, switch origin of sets,
which originates on failed node (not your case), and second, tell all
other nodes, that the failed node is dead, so it is possible to drop
it without waiting for confirmation event from the failed node.

Or mabye I did not understand your problem correctly.

Jan



On Nov 15, 2007 5:48 PM, Radim Kolar SF.NET <hsn@sendmail.cz> wrote:
> i need to remove dead node from cluster.
>
> I cannot use failover because no other node is subscribed to set with
> origin on failed node and i can not use drop node also because
> Node 1 is still origin of one or more sets.
>
> Can you give me hints how to edit slony catalog directly?
From honza at jyxo.com  Sat Nov 17 13:00:12 2007
From: honza at jyxo.com (Jan Matousek)
Date: Sat Nov 17 13:30:28 2007
Subject: [Slony1-general] how to remove failed node with set origin
In-Reply-To: <20071115164850.GA91228@sanatana.dharma>
References: <mailman.36.1195144543.3991.slony1-general@lists.slony.info>
	<20071115164850.GA91228@sanatana.dharma>
Message-ID: <c14eaebb0711171300w647439b1m6f1c54305a122f70@mail.gmail.com>

Hi,

the FAILOVER slonik command ran with error?
I have used FAILOVER on node, which was subscriber of single set, and
it have worked.

I think that failover has two purposes - first, switch origin of sets,
which originates on failed node (not your case), and second, tell all
other nodes, that the failed node is dead, so it is possible to drop
it without waiting for confirmation event from the failed node.

Or mabye I did not understand your problem correctly.

Jan



On Nov 15, 2007 5:48 PM, Radim Kolar SF.NET <hsn@sendmail.cz> wrote:
> i need to remove dead node from cluster.
>
> I cannot use failover because no other node is subscribed to set with
> origin on failed node and i can not use drop node also because
> Node 1 is still origin of one or more sets.
>
> Can you give me hints how to edit slony catalog directly?
From hsn at sendmail.cz  Sat Nov 17 13:58:51 2007
From: hsn at sendmail.cz (Radim Kolar SF.NET)
Date: Sat Nov 17 13:59:03 2007
Subject: [Slony1-general] how to remove failed node with set origin
In-Reply-To: <c14eaebb0711171300w647439b1m6f1c54305a122f70@mail.gmail.com>
References: <mailman.36.1195144543.3991.slony1-general@lists.slony.info>
	<20071115164850.GA91228@sanatana.dharma>
	<c14eaebb0711171300w647439b1m6f1c54305a122f70@mail.gmail.com>
Message-ID: <20071117215851.GA43610@sanatana.dharma>

> the FAILOVER slonik command ran with error?
yes.

Setup:

Node #1 
  - origin of set 2
  - nobody else subscribed to set 2
  - machine dead, cant use slonik command like drop set
Node #2
  - Subscribed to set 1
Node #3 
  - Origin of set 1

logs are not beeing deleted now because node #1 is still in cluster.
I can not use failover because nobody else subsribed to set 2
I can not use drop node because node 1 is origin of set 2

%slonik drop2.slonik
drop2.slonik:8: PGRES_FATAL_ERROR select "_com".dropNode(1);  - ERROR:  Slony-I: Node 1 is still origin of one or more sets
%cat drop2.slonik
CLUSTER NAME = com;
drop node (id = 1, event node = 2);

i think this is bug in drop node command. if nobody else is subscribed to
set originating at dead mode, it should allow to drop that node.
From cyril.scetbon at free.fr  Mon Nov 19 06:26:15 2007
From: cyril.scetbon at free.fr (Cyril SCETBON)
Date: Mon Nov 19 06:26:20 2007
Subject: [Slony1-general] Version 1.2.12 released
In-Reply-To: <473C54EB.7060904@postgresqlfr.org>
References: <601wavf4kp.fsf@dba2.int.libertyrms.com>
	<47396E63.8080106@free.fr> <473C54EB.7060904@postgresqlfr.org>
Message-ID: <47419D07.7030605@free.fr>



St?phane A. Schildknecht wrote:

> Cyril SCETBON a ?crit :
>   
>> Hi,
>>
>> I think it would be better to be able to modify SLON_DATA_FETCH_SIZE
>> by using a parameter on the slon command line. For example, we got a
>> lot of updates (400 per second) between far geographical sites. I had
>> to modify this variable and to recompile the slon binary cause I
>> didn't find another way until now.
>>
>> Regards.
>>
>>     
>
> Hi,
>
> How did you modify this variable? Increase or decrease ? 
I've modified the value of SLON_DATA_FETCH_SIZE in src/slon/slon.h and 
rebuilt it.
I've changed it from 10 to 50 to make fetchs of 500 lines.
> What was the
> problem you encountered ?
>   
When vaccum was happening on slony tables the db rate of the replication 
decreased and slony had to get 3000 DML a few minutes later to make the 
subscriber up to date. But fetching 3000 DMLs orders by fetching 100 
lines was too slow. That's why I've increased the value to make fetchs 
of 500 lines.

Regards
> Best reagrds,
>
>   
-- 
Cyril SCETBON
From JanWieck at Yahoo.com  Mon Nov 19 09:02:46 2007
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Mon Nov 19 09:03:05 2007
Subject: [Slony1-general] 1.2.12 success + error
In-Reply-To: <B2FFC89A-56A9-4CCE-B175-6F94C81D27A2@khera.org>
References: <B2FFC89A-56A9-4CCE-B175-6F94C81D27A2@khera.org>
Message-ID: <4741C1B6.8030608@Yahoo.com>

On 11/15/2007 4:38 PM, Vivek Khera wrote:
> I updated my cluster to 1.2.12 today.  All machines are running  
> FreeBSD 6.1/i386 or 6.2/amd64.  It upgraded very nicely on all boxes  
> except one.
> 
> On one box, I happend to have bison 1.75 installed.  This caused slony  
> compile to fail miserably when it tried to regenerate the parser for  
> the log shipper, as shown below.  Simply uninstalling bison allowed it  
> to build to completion and successful deployment.
> 
> What's the minimum version of bison this will work with?  If possible,  
> the configure script should check for that.

Hmmm ... why isn't the pregenerated parser.c included in the package?


Jan

> 
> 
> cc -I/usr/local/include -I/usr/local/include/postgresql/server  -O2 - 
> fno-strict-aliasing -pipe  -Wall -Wmissing-prototypes -Wmissing- 
> declarations -I../.. -DPGSHARE="\"/usr/local/share/postgresql\""  -c - 
> o ipcutil.o ipcutil.c
> bison -y -d  parser.y
> parser.y:358.20: parse error, unexpected ":", expecting ";" or "|"
> parser.y:359.6-366.8: $$ of `arch_tracking' has no declared type
> parser.y:526.15: parse error, unexpected ":", expecting ";" or "|"
> parser.y:527.6-533.26: $4 of `arch_upd_set' has no declared type
> parser.y:527.6-534.26: invalid $ value
> parser.y:527.6-534.26: $6 of `arch_upd_set' has no declared type
> parser.y:527.6-536.29: invalid $ value
> parser.y:527.6-536.29: $7 of `arch_upd_set' has no declared type
> parser.y:724.19-736.11: type clash (`att_elem' `str') on default action
> parser.y:736.15: parse error, unexpected ":", expecting ";" or "|"
> parser.y:737.6-742.30: $5 of `arch_ident_eq_lit' has no declared type
> parser.y:737.6-746.15: $5 of `arch_ident_eq_lit' has no declared type
> parser.y:737.6-748.14: $5 of `arch_ident_eq_lit' has no declared type
> parser.y:737.6-760.14: $5 of `arch_ident_eq_lit' has no declared type
> parser.y:811.18: parse error, unexpected ":", expecting ";" or "|"
> parser.y:812.6-819.8: $$ of `arch_finishtable' has no declared type
> parser.y:841.21: parse error, unexpected ":", expecting ";" or "|"
> parser.y:842.6-849.8: $$ of `arch_seqsetval' has no declared type
> parser.y:872.20: parse error, unexpected ":", expecting ";" or "|"
> parser.y:873.6-880.8: $$ of `arch_pgsetval' has no declared type
> parser.y:1057.15-1062.13: type clash (`str' `') on default action
> parser.y:1062.16: parse error, unexpected ":", expecting ";" or "|"
> gmake[3]: *** [parser.c] Error 1
> gmake[3]: Leaving directory `/var/tmp/n/lorax1/usr/ports/databases/ 
> slony1/work/slony1-1.2.12/src/slony_logshipper'
> gmake[2]: *** [all] Error 2
> 
> 
> 
> 
> _______________________________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


-- 
#======================================================================#
# It's easier to get forgiveness for being wrong than for being right. #
# Let's break this rule - forgive me.                                  #
#================================================== JanWieck@Yahoo.com #
From vivek at khera.org  Mon Nov 19 09:47:03 2007
From: vivek at khera.org (Vivek Khera)
Date: Mon Nov 19 09:47:09 2007
Subject: [Slony1-general] 1.2.12 success + error
In-Reply-To: <4741C1B6.8030608@Yahoo.com>
References: <B2FFC89A-56A9-4CCE-B175-6F94C81D27A2@khera.org>
	<4741C1B6.8030608@Yahoo.com>
Message-ID: <AF363AB9-F83C-42BC-871C-AA89645196EE@khera.org>


On Nov 19, 2007, at 12:02 PM, Jan Wieck wrote:

> On 11/15/2007 4:38 PM, Vivek Khera wrote:
>> I updated my cluster to 1.2.12 today.  All machines are running   
>> FreeBSD 6.1/i386 or 6.2/amd64.  It upgraded very nicely on all  
>> boxes  except one.
>> On one box, I happend to have bison 1.75 installed.  This caused  
>> slony  compile to fail miserably when it tried to regenerate the  
>> parser for  the log shipper, as shown below.  Simply uninstalling  
>> bison allowed it  to build to completion and successful deployment.
>> What's the minimum version of bison this will work with?  If  
>> possible,  the configure script should check for that.
>
> Hmmm ... why isn't the pregenerated parser.c included in the package?
>
>

It is included.  However, if the configure script finds bison  
installed, it seems to want to force it to re-generate.  Once I  
deleted bison, it built just fine with a fresh tarball extraction.

From cyril.scetbon at free.fr  Tue Nov 20 08:18:28 2007
From: cyril.scetbon at free.fr (Cyril SCETBON)
Date: Tue Nov 20 08:18:32 2007
Subject: [Slony1-general] tablespace for slony objects
Message-ID: <474308D4.5020806@free.fr>

Hi,


Is it possible to force slony to create his objects in a specified 
tablespace ?

I would like to use a specified tablespace for my database and another 
one for slony's objects.


thanks.

From mailings at oopsware.de  Tue Nov 20 08:44:34 2007
From: mailings at oopsware.de (Bernd Helmle)
Date: Tue Nov 20 08:44:40 2007
Subject: [Slony1-general] tablespace for slony objects
In-Reply-To: <474308D4.5020806@free.fr>
References: <474308D4.5020806@free.fr>
Message-ID: <385EEE99E79C89E52762E103@imhotep.credativ.de>

--On Dienstag, November 20, 2007 17:18:28 +0100 Cyril SCETBON 
<cyril.scetbon@free.fr> wrote:

> Hi,
>
>
> Is it possible to force slony to create his objects in a specified
> tablespace ?
>
> I would like to use a specified tablespace for my database and another
> one for slony's objects.
>

You could try the default_tablespace parameter bound to your database 
session during slony initialization. What i've done recently was:

- create the tablespace slony
- export PGOPTIONS='-c default_tablespace=slony'
- issue your slonik scripts within this session

If you have a dedicated slony superuser, you can just bind the 
default_tablespace to the specific role.

Maybe someone uses yet a different path....

-- 
  Thanks

                    Bernd
From darcyb at commandprompt.com  Tue Nov 20 08:47:13 2007
From: darcyb at commandprompt.com (Darcy Buskermolen)
Date: Tue Nov 20 08:47:27 2007
Subject: [Slony1-general] tablespace for slony objects
In-Reply-To: <474308D4.5020806@free.fr>
References: <474308D4.5020806@free.fr>
Message-ID: <200711200847.14010.darcyb@commandprompt.com>

On Tuesday 20 November 2007 08:18:28 Cyril SCETBON wrote:
> Hi,
>
>
> Is it possible to force slony to create his objects in a specified
> tablespace ?

just use alter after the fact to move the objects to the other table space... 
IE:
ALTER TABLE _cluster.sl_log_1 SET TABLESPACE TO slony;
ALTER ............


>
> I would like to use a specified tablespace for my database and another
> one for slony's objects.
>
>
> thanks.
>
> _______________________________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general



-- 
Darcy Buskermolen
Command Prompt, Inc.
+1.503.667.4564 X 102
http://www.commandprompt.com/
PostgreSQL solutions since 1997
From tgoodair at ca.afilias.info  Tue Nov 20 10:08:55 2007
From: tgoodair at ca.afilias.info (Tim Goodaire)
Date: Tue Nov 20 10:32:49 2007
Subject: [Slony1-general] SLONY -1 Portability options
In-Reply-To: <20071115144122.GB20228@crankycanuck.ca>
References: <473BC51C.1010703@intoto.com>
	<20071115144122.GB20228@crankycanuck.ca>
Message-ID: <20071120180855.GY6396@dba6>

On Thu, Nov 15, 2007 at 09:41:22AM -0500, Andrew Sullivan wrote:
> On Thu, Nov 15, 2007 at 09:33:40AM +0530, Trinath Somanchi wrote:
> > I have configured SLONY - 1 (1.2.11) , in an FC6 machine .
> > 
> > Now , I want to the move the same replica on another Ubuntu machine .
> > 
> > Can it be possible that just move the slony directory or I need to 
> > install SLONY- 1 from the beginning in Ubuntu machine also so that only 
> > slony config needs changes . 
> 
> If the libc, maybe the kernel, and the hardware architecture (e.g. 32 bit
> x86 to 32 bit x86) are the same, this should be no problem.
> 
> If you have different versions of C libraries and such like, I wouldn't do
> this.  What's so hard about ./configure; make; make install, anyway?

Or you could build an RPM.

-- 
Tim Goodaire    416-673-4126    tgoodair@ca.afilias.info
Database Team Lead, Afilias Canada Corp.
From jeff at frostconsultingllc.com  Tue Nov 20 10:47:08 2007
From: jeff at frostconsultingllc.com (Jeff Frost)
Date: Tue Nov 20 10:47:14 2007
Subject: [Slony1-general] can you change a node's id?
Message-ID: <Pine.LNX.4.64.0711201045550.20488@discord.home.frostconsultingllc.com>

We're going to be bringing up a new master and had planned to add it to 
replication, let it sync, then do a graceful switchover.  But, that would 
leaev it with a node id of 5.  Since the old master (node id = 1) is going 
away, I'm wondering if it's possible to modify the node id of the new master?

-- 
Jeff Frost, Owner 	<jeff@frostconsultingllc.com>
Frost Consulting, LLC 	http://www.frostconsultingllc.com/
Phone: 650-780-7908	FAX: 650-649-1954
From cbbrowne at ca.afilias.info  Tue Nov 20 11:59:42 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Tue Nov 20 11:59:50 2007
Subject: [Slony1-general] can you change a node's id?
In-Reply-To: <Pine.LNX.4.64.0711201045550.20488@discord.home.frostconsultingllc.com>
References: <Pine.LNX.4.64.0711201045550.20488@discord.home.frostconsultingllc.com>
Message-ID: <47433CAE.6040506@ca.afilias.info>

Jeff Frost wrote:
> We're going to be bringing up a new master and had planned to add it 
> to replication, let it sync, then do a graceful switchover.  But, that 
> would leaev it with a node id of 5.  Since the old master (node id = 
> 1) is going away, I'm wondering if it's possible to modify the node id 
> of the new master?
>
No, there is no notion of modifying the node ID; the ID is very deeply 
intertwined into replication state across all the nodes, with the result 
that trying to alter the ID would be likely to lead to potential for 
*enormous* confusion within the replication system.

There is no reason to have a "node 1" around; many of the tests assume 
its absence, and in most of our production clusters, we use node numbers 
that are *somewhat* meaningful.

For instance, several clusters consist of nodes:
  8141
  8142
  8143
  8194

Where:

- "81" indicates that it's a PostgreSQL 8.1 instance  (we may soon have 
nodes starting with "83")
- 4 versus 9 indicates which data centre the node is at
- below all of that, we have a more-or-less serial value, 1,2,3,4

It's not quite wonderful, but it's mnemonic enough to be useful...
From jeff at frostconsultingllc.com  Tue Nov 20 12:07:21 2007
From: jeff at frostconsultingllc.com (Jeff Frost)
Date: Tue Nov 20 12:07:32 2007
Subject: [Slony1-general] can you change a node's id?
In-Reply-To: <47433CAE.6040506@ca.afilias.info>
References: <Pine.LNX.4.64.0711201045550.20488@discord.home.frostconsultingllc.com>
	<47433CAE.6040506@ca.afilias.info>
Message-ID: <Pine.LNX.4.64.0711201202220.18621@discord.home.frostconsultingllc.com>

On Tue, 20 Nov 2007, Christopher Browne wrote:

> No, there is no notion of modifying the node ID; the ID is very deeply 
> intertwined into replication state across all the nodes, with the result that 
> trying to alter the ID would be likely to lead to potential for *enormous* 
> confusion within the replication system.
>
> There is no reason to have a "node 1" around; many of the tests assume its 
> absence, and in most of our production clusters, we use node numbers that are 
> *somewhat* meaningful.
>
> For instance, several clusters consist of nodes:
> 8141
> 8142
> 8143
> 8194
>
> Where:
>
> - "81" indicates that it's a PostgreSQL 8.1 instance  (we may soon have nodes 
> starting with "83")
> - 4 versus 9 indicates which data centre the node is at
> - below all of that, we have a more-or-less serial value, 1,2,3,4
>
> It's not quite wonderful, but it's mnemonic enough to be useful...

The only reason I consider changing it, is that the event node defaults to 1. 
Is it possible to define what the default event node without changing the code 
and recompiling?

  EVENT NODE = ival
     (Optional) The ID of the current origin of the set. Default value is 1.

It just means we have to remember to specify it in the slonik scripts after 
the upgrade.

-- 
Jeff Frost, Owner 	<jeff@frostconsultingllc.com>
Frost Consulting, LLC 	http://www.frostconsultingllc.com/
Phone: 650-780-7908	FAX: 650-649-1954
From darcyb at commandprompt.com  Tue Nov 20 12:11:22 2007
From: darcyb at commandprompt.com (Darcy Buskermolen)
Date: Tue Nov 20 12:11:22 2007
Subject: [Slony1-general] can you change a node's id?
In-Reply-To: <Pine.LNX.4.64.0711201202220.18621@discord.home.frostconsultingllc.com>
References: <Pine.LNX.4.64.0711201045550.20488@discord.home.frostconsultingllc.com>
	<47433CAE.6040506@ca.afilias.info>
	<Pine.LNX.4.64.0711201202220.18621@discord.home.frostconsultingllc.com>
Message-ID: <200711201211.22968.darcyb@commandprompt.com>

On Tuesday 20 November 2007 12:07:21 Jeff Frost wrote:
> On Tue, 20 Nov 2007, Christopher Browne wrote:
> > No, there is no notion of modifying the node ID; the ID is very deeply
> > intertwined into replication state across all the nodes, with the result
> > that trying to alter the ID would be likely to lead to potential for
> > *enormous* confusion within the replication system.
> >
> > There is no reason to have a "node 1" around; many of the tests assume
> > its absence, and in most of our production clusters, we use node numbers
> > that are *somewhat* meaningful.
> >
> > For instance, several clusters consist of nodes:
> > 8141
> > 8142
> > 8143
> > 8194
> >
> > Where:
> >
> > - "81" indicates that it's a PostgreSQL 8.1 instance  (we may soon have
> > nodes starting with "83")
> > - 4 versus 9 indicates which data centre the node is at
> > - below all of that, we have a more-or-less serial value, 1,2,3,4
> >
> > It's not quite wonderful, but it's mnemonic enough to be useful...
>
> The only reason I consider changing it, is that the event node defaults to
> 1. Is it possible to define what the default event node without changing
> the code and recompiling?

well if you use altperl, you can just define the default node in the conf 
file...

>
>   EVENT NODE = ival
>      (Optional) The ID of the current origin of the set. Default value is
> 1.
>
> It just means we have to remember to specify it in the slonik scripts after
> the upgrade.



-- 
Darcy Buskermolen
Command Prompt, Inc.
+1.503.667.4564 X 102
http://www.commandprompt.com/
PostgreSQL solutions since 1997
From rlandrum at aol.net  Tue Nov 20 14:21:39 2007
From: rlandrum at aol.net (Robert Landrum)
Date: Tue Nov 20 14:21:50 2007
Subject: [Slony1-general] Slony Newbie Question
Message-ID: <47435DF3.1000902@aol.net>

I'm working with a very large database.  300 tables and about 350 
sequences.  Dumped, it's about 8GB of data.

I've read several posts that seem to indicate that I need to let slony 
sync my data between the master and the slave when I subscribe the slave 
to the master.  I would prefer to avoid this, as it'll take quite a 
while for the sync to take place.  After about 2 hours and 30 minutes, 
I'm only about 5% complete.

Is this just a limitation of slony? Or is there a workaround I've missed?

Thanks,

Rob
From stephane.schildknecht at postgresqlfr.org  Tue Nov 20 23:53:40 2007
From: stephane.schildknecht at postgresqlfr.org (=?ISO-8859-1?Q?=22St=E9phane_A=2E_Schildknecht=22?=)
Date: Tue Nov 20 23:53:53 2007
Subject: [Slony1-general] Slony Newbie Question
In-Reply-To: <47435DF3.1000902@aol.net>
References: <47435DF3.1000902@aol.net>
Message-ID: <4743E404.3070506@postgresqlfr.org>

Robert Landrum a ?crit :
> I'm working with a very large database.  300 tables and about 350
> sequences.  Dumped, it's about 8GB of data.
>
> I've read several posts that seem to indicate that I need to let slony
> sync my data between the master and the slave when I subscribe the
> slave to the master.  I would prefer to avoid this, as it'll take
> quite a while for the sync to take place.  After about 2 hours and 30
> minutes, I'm only about 5% complete.
>
> Is this just a limitation of slony? Or is there a workaround I've missed?
>
> Thanks,
>
> Rob

I'm afraid you're facing a real limitation of the actual versions. You
have to let the first synchronisation begin with an empty slave database.

Regards,

-- 
St?phane SCHILDKNECHT
Pr?sident de PostgreSQLFr
http://www.postgresqlfr.org

From tycage at aol.net  Wed Nov 21 06:23:01 2007
From: tycage at aol.net (Ty Cage Warren)
Date: Wed Nov 21 06:23:07 2007
Subject: [Slony1-general] Slony Newbie Question
In-Reply-To: <47435DF3.1000902@aol.net>
References: <47435DF3.1000902@aol.net>
Message-ID: <47443F45.3070200@aol.net>

Robert Landrum wrote:
> I'm working with a very large database.  300 tables and about 350 
> sequences.  Dumped, it's about 8GB of data.
>
> I've read several posts that seem to indicate that I need to let slony 
> sync my data between the master and the slave when I subscribe the 
> slave to the master.  I would prefer to avoid this, as it'll take 
> quite a while for the sync to take place.  After about 2 hours and 30 
> minutes, I'm only about 5% complete.
>
> Is this just a limitation of slony? Or is there a workaround I've missed?
>
> Thanks,
>
> Rob
Hey Rob,
  When I've had large databases to replicate, I've always started them 
up piece meal.  I'll add in a table at a time and once it is synced, I 
merge it into the set I intend it to be in.  This way if there is a 
problem with a table, it doesn't stop the whole process, I can just skip 
that table until I figure out what the problem is.  It also keeps me 
from having as huge a set of updates to handle once the initial sync is 
done, since it will catch up all the already subscribed tables after 
each new table finishes the initial sync.  The down side of this process 
is that it is very manual.

I hope this helps,
  --Ty
From jc at oxado.com  Wed Nov 21 06:34:44 2007
From: jc at oxado.com (Jacques Caron)
Date: Wed Nov 21 06:35:30 2007
Subject: [Slony1-general] Slony Newbie Question
In-Reply-To: <47435DF3.1000902@aol.net>
References: <47435DF3.1000902@aol.net>
Message-ID: <20071121143526.EF23B116462A@zeus.directinfos.com>

At 23:21 20/11/2007, Robert Landrum wrote:
>I'm working with a very large database.  300 tables and about 350 
>sequences.  Dumped, it's about 8GB of data.
>
>I've read several posts that seem to indicate that I need to let 
>slony sync my data between the master and the slave when I subscribe 
>the slave to the master.  I would prefer to avoid this, as it'll 
>take quite a while for the sync to take place.  After about 2 hours 
>and 30 minutes, I'm only about 5% complete.

Well, I don't quite understand how you could have a replication 
without syncing the data? Also, we have several large databases 
replicated including one where the (compressed) dump is 8GB as well, 
and it certainly didn't take 2 days to do the initial sync. Are you 
using the last versions of postgresql and slony? Is your slave 
correctly configured (both hardware- and software-wise)? Did you 
check that there are no errors during the replication which would 
cause slony to abort and restart again and again?

>Is this just a limitation of slony? Or is there a workaround I've missed?

What other option would you imagine there could be?

Jacques.

From bnichols at ca.afilias.info  Wed Nov 21 07:14:48 2007
From: bnichols at ca.afilias.info (Brad Nicholson)
Date: Wed Nov 21 07:14:53 2007
Subject: [Slony1-general] Slony Newbie Question
In-Reply-To: <47435DF3.1000902@aol.net>
References: <47435DF3.1000902@aol.net>
Message-ID: <1195658088.5504.2.camel@bnicholson-desktop>


On Tue, 2007-11-20 at 17:21 -0500, Robert Landrum wrote: 
> I'm working with a very large database.  300 tables and about 350 
> sequences.  Dumped, it's about 8GB of data.
> 
> I've read several posts that seem to indicate that I need to let slony 
> sync my data between the master and the slave when I subscribe the slave 
> to the master.  I would prefer to avoid this, as it'll take quite a 
> while for the sync to take place.  After about 2 hours and 30 minutes, 
> I'm only about 5% complete.
> 
> Is this just a limitation of slony? Or is there a workaround I've missed?


It's certainly not a limit of Slony with a data set of that size.  We've
subscribed databases 10 times the size of yours in a few hours, albiet
on very high end hardware.

First question - do your slon logs show that the tables you are copying
have been successfully truncated before copying?  If not, you may be
trying to write to a table with a lot of dead tuples left behind.  This
was a problem prior to PG 8.0 (or 8.1, I forget) where Slony had to
delete the data in the target tables instead of truncating it.  If it's
not truncating, then stop the copy, truncate the target tables on the
subscriber, and try again.

If not, it could be a limitation of your hardware and/or Postgres
configuration, or your usage.

Do some polking around your environment.  How is the IO, memory, CPU
usage?  Check all points - the server that is the provider, the server
that is the subscriber, the server that the slons are running on.  How
is you network.  Is it stable, is the bandwidth being saturated?

Is your slon running, or is it dying and starting the copy again?


-- 
Brad Nicholson  416-673-4106
Database Administrator, Afilias Canada Corp.


From pgadmin at pse-consulting.de  Wed Nov 21 07:50:04 2007
From: pgadmin at pse-consulting.de (Andreas Pflug)
Date: Wed Nov 21 07:50:13 2007
Subject: [Slony1-general] Slony Newbie Question
In-Reply-To: <1195658088.5504.2.camel@bnicholson-desktop>
References: <47435DF3.1000902@aol.net>
	<1195658088.5504.2.camel@bnicholson-desktop>
Message-ID: <474453AC.5010502@pse-consulting.de>

Brad Nicholson wrote:
> On Tue, 2007-11-20 at 17:21 -0500, Robert Landrum wrote: 
>   
>> I'm working with a very large database.  300 tables and about 350 
>> sequences.  Dumped, it's about 8GB of data.
>>
>> I've read several posts that seem to indicate that I need to let slony 
>> sync my data between the master and the slave when I subscribe the slave 
>> to the master.  I would prefer to avoid this, as it'll take quite a 
>> while for the sync to take place.  After about 2 hours and 30 minutes, 
>> I'm only about 5% complete.
>>
>> Is this just a limitation of slony? Or is there a workaround I've missed?
>>     
>
>
> If not, it could be a limitation of your hardware and/or Postgres
> configuration, or your usage.

I'd suggest checking the performance of your replication path using
COPYing some average table; this is what Slony mainly does when
subscribing. If you locate your bottleneck and improve the performance,
Slony will fly too.

Regards,
Andreas
From rlandrum at aol.net  Wed Nov 21 07:53:37 2007
From: rlandrum at aol.net (Robert Landrum)
Date: Wed Nov 21 07:53:45 2007
Subject: [Slony1-general] Slony Newbie Question
In-Reply-To: <20071121143526.EF23B116462A@zeus.directinfos.com>
References: <47435DF3.1000902@aol.net>
	<20071121143526.EF23B116462A@zeus.directinfos.com>
Message-ID: <47445481.1080008@aol.net>

Jacques Caron wrote:
>> this just a limitation of slony? Or is there a workaround I've missed?
> 
> What other option would you imagine there could be?
> 

Reject Master db connections.  Dump Master.  Load Master data onto 
Slave.  Start Master/Slave replication.  Re-allow Master DB connections.

I would imaging that there'd need to be some sort of seeding operation 
in between the data load and the starting of the master and slave 
replication, where one populates the slony tables with the sync status 
of each of the tables/sequences in the set.

Obviously that's not something that is supported, but that was kinda 
what I had in mind when I started.

Rob
From rlandrum at aol.net  Wed Nov 21 08:13:04 2007
From: rlandrum at aol.net (Robert Landrum)
Date: Wed Nov 21 08:13:12 2007
Subject: [Slony1-general] Slony Newbie Question
In-Reply-To: <47435DF3.1000902@aol.net>
References: <47435DF3.1000902@aol.net>
Message-ID: <47445910.4050007@aol.net>

Robert Landrum wrote:
> I'm working with a very large database.  300 tables and about 350 
> sequences.  Dumped, it's about 8GB of data.
> 
> I've read several posts that seem to indicate that I need to let slony 
> sync my data between the master and the slave when I subscribe the slave 
> to the master.  I would prefer to avoid this, as it'll take quite a 
> while for the sync to take place.  After about 2 hours and 30 minutes, 
> I'm only about 5% complete.
> 

As it turns out, this was caused by just some very large tables that 
appeared early in the set.  The total sync time was right around 4.5 
hours, which is about 3 times longer than it takes to load a fresh dump 
of the database.  That shouldn't be a problem...  :)

Now I've run into another mystery...

After the sync, one of our tables was missing 5 records.  The master had 
453359 records, and the slave had 453354.  I identified the 5 missing 
records, and there was nothing special or weird about them.  The records 
haven't been changed since 2003.  As of this morning, the two tables 
contain the same number of records.

Neither the master or the slave are taking traffic.  Both database were 
set up specifically to test slony.  After having read the documentation, 
I can think of no reason why the table in question would be missing 5 
records immediately after the initial sync.  :(

I'm running PG 8.2.4 and slony 1.2.10.

Rob



From jc at oxado.com  Wed Nov 21 08:28:34 2007
From: jc at oxado.com (Jacques Caron)
Date: Wed Nov 21 08:28:53 2007
Subject: [Slony1-general] Patch for shorter attkind
Message-ID: <20071121162846.ED79B1165966@zeus.directinfos.com>

Hi,

The following very quick patch (against 1.2.12) provides the following changes:
- when scanning attributes looking for key columns (in UPDATEs and 
DELETEs), stop when we reach the end of the attkind string
- when creating the triggers, final "v"s are stripped

Result:
- one can add columns (without defaults, constraints, etc.) to tables 
(destinations first, origin last) without changing the logtrigger and 
without using EXECUTE SCRIPT
- as a bonus we save a few cycles in updates and deletes

Comments welcome!

Jacque.

--- src/backend/slony1_funcs.c.orig Wed Nov 21 15:43:24 2007
+++ src/backend/slony1_funcs.c      Wed Nov 21 15:45:13 2007
@@ -821,6 +821,8 @@
                                 continue;

                         attkind_idx++;
+                       if (!attkind[attkind_idx])
+                               break;
                         if (attkind[attkind_idx] != 'k')
                                 continue;
                         col_ident = (char 
*)slon_quote_identifier(SPI_fname(tupdesc, i + 1));
@@ -888,6 +890,8 @@
                                 continue;

                         attkind_idx++;
+                       if (!attkind[attkind_idx])
+                               break;
                         if (attkind[attkind_idx] != 'k')
                                 continue;
                         col_ident = (char 
*)slon_quote_identifier(SPI_fname(tupdesc, i + 1));
--- src/backend/slony1_funcs.sql.orig       Wed Nov 21 15:45:35 2007
+++ src/backend/slony1_funcs.sql    Wed Nov 21 15:53:11 2007
@@ -5029,6 +5029,11 @@
         end loop;

         --
+       -- Strip final 'v's as these are not needed by the logtrigger
+       --
+       v_attkind := regexp_replace(v_attkind,''v*$'','''');
+
+       --
         -- Return the resulting attkind
         --
         return v_attkind;

From vivek at khera.org  Wed Nov 21 09:38:24 2007
From: vivek at khera.org (Vivek Khera)
Date: Wed Nov 21 09:38:32 2007
Subject: [Slony1-general] Slony Newbie Question
In-Reply-To: <4743E404.3070506@postgresqlfr.org>
References: <47435DF3.1000902@aol.net> <4743E404.3070506@postgresqlfr.org>
Message-ID: <BE21AA7F-298E-4B9B-98EA-068EEAC82FED@khera.org>


On Nov 21, 2007, at 2:53 AM, St?phane A. Schildknecht wrote:

> I'm afraid you're facing a real limitation of the actual versions. You
> have to let the first synchronisation begin with an empty slave  
> database.


True, but if you create your replication table by table, the pain of  
the copy is reduced.

Basically, you create your set with some small set of tables.  Start  
replication.  Then add a few more tables to another set, start that  
replicating. Once done, merge sets.  Later rinse repeat until you're  
done with all tables and have one set left.

This will of course be difficult if you need to add additional  
replicas... :-(

What I usually do is drop all indexes on the replica (except PK's) and  
add them later once the initial copy is done.  You don't need to use  
slony's execute script methods to add/delete indexes.

From cbbrowne at ca.afilias.info  Wed Nov 21 09:45:03 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Wed Nov 21 09:45:12 2007
Subject: [Slony1-general] Slony Newbie Question
In-Reply-To: <47445481.1080008@aol.net> (Robert Landrum's message of "Wed,
	21 Nov 2007 10:53:37 -0500")
References: <47435DF3.1000902@aol.net>
	<20071121143526.EF23B116462A@zeus.directinfos.com>
	<47445481.1080008@aol.net>
Message-ID: <60wssb8pcw.fsf@dba2.int.libertyrms.com>

Robert Landrum <rlandrum@aol.net> writes:
> Jacques Caron wrote:
>>> this just a limitation of slony? Or is there a workaround I've missed?
>> What other option would you imagine there could be?
>>
>
> Reject Master db connections.  Dump Master.  Load Master data onto
> Slave.  Start Master/Slave replication.  Re-allow Master DB
> connections.
>
> I would imaging that there'd need to be some sort of seeding operation
> in between the data load and the starting of the master and slave
> replication, where one populates the slony tables with the sync status
> of each of the tables/sequences in the set.
>
> Obviously that's not something that is supported, but that was kinda
> what I had in mind when I started.

That is decidedly NOT how things work...

In order for Slony-I to be certain that data has been faithfully
copied over, the "seeding operation" is that the subscription process
copies all of the data over.

As a result, if you loaded *any* data into the subscriber, that data
will be thrown away.  There is therefore no point in loading anything
onto the subscriber aside from the schema.  Pre-loading data is a
waste of time.
-- 
(format nil "~S@~S" "cbbrowne" "linuxdatabases.info")
http://linuxdatabases.info/info/wp.html
"What we need is either less corruption, or more chance to participate
in it."  -- Unknown
From ahodgson at simkin.ca  Wed Nov 21 09:50:19 2007
From: ahodgson at simkin.ca (Alan Hodgson)
Date: Wed Nov 21 09:52:30 2007
Subject: [Slony1-general] Slony Newbie Question
In-Reply-To: <BE21AA7F-298E-4B9B-98EA-068EEAC82FED@khera.org>
References: <47435DF3.1000902@aol.net> <4743E404.3070506@postgresqlfr.org>
	<BE21AA7F-298E-4B9B-98EA-068EEAC82FED@khera.org>
Message-ID: <200711210950.19201@hal.medialogik.com>

On Wednesday 21 November 2007, Vivek Khera <vivek@khera.org> wrote:
> What I usually do is drop all indexes on the replica (except PK's) and
> add them later once the initial copy is done.  

slony does this itself, now, doesn't it?

-- 
Q: Why did God create economists?
A: In order to make weather forecasters look good.

From drees76 at gmail.com  Wed Nov 21 11:40:21 2007
From: drees76 at gmail.com (David Rees)
Date: Wed Nov 21 11:40:31 2007
Subject: [Slony1-general] Slony Newbie Question
In-Reply-To: <200711210950.19201@hal.medialogik.com>
References: <47435DF3.1000902@aol.net> <4743E404.3070506@postgresqlfr.org>
	<BE21AA7F-298E-4B9B-98EA-068EEAC82FED@khera.org>
	<200711210950.19201@hal.medialogik.com>
Message-ID: <72dbd3150711211140u74622b01o6569371c543a113d@mail.gmail.com>

On Nov 21, 2007 9:50 AM, Alan Hodgson <ahodgson@simkin.ca> wrote:
> On Wednesday 21 November 2007, Vivek Khera <vivek@khera.org> wrote:
> > What I usually do is drop all indexes on the replica (except PK's) and
> > add them later once the initial copy is done.
>
> slony does this itself, now, doesn't it?

Yes, it does.

-Dave
From jc at oxado.com  Wed Nov 21 14:28:12 2007
From: jc at oxado.com (Jacques Caron)
Date: Wed Nov 21 14:28:32 2007
Subject: [Slony1-general] Slony Newbie Question
In-Reply-To: <47445481.1080008@aol.net>
References: <47435DF3.1000902@aol.net>
	<20071121143526.EF23B116462A@zeus.directinfos.com>
	<47445481.1080008@aol.net>
Message-ID: <20071121222824.CB7831165952@zeus.directinfos.com>

At 16:53 21/11/2007, Robert Landrum wrote:
>Jacques Caron wrote:
>>>this just a limitation of slony? Or is there a workaround I've missed?
>>What other option would you imagine there could be?
>
>Reject Master db connections.  Dump Master.  Load Master data onto 
>Slave.  Start Master/Slave replication.  Re-allow Master DB connections.

Well, that's basically what slony does, but without rejecting 
connections on the master nor slave. The initial replication is quite 
equivalent to a big pg_dump master | pgsql slave (a bunch of COPY TO 
STDOUT's piped into COPY FROM STDIN's), just "synchronized" with the 
start of the update collection (precisely so you can do it on a live 
database...).

Note that you're not using the latest version of slony, so you might 
have hit some instances where the replication is not as fast as it 
could be because there was an issue in index creation deferral with 
postgresql 8.2 which was fixed in 1.2.11. With the fix in, there's no 
reason for it to be any longer than a dump + a restore (actually a 
bit faster than that since the two operations are done in parallel, 
so more like max(dump,restore)).

Jacques.

From JanWieck at Yahoo.com  Wed Nov 21 09:22:54 2007
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Wed Nov 21 15:16:27 2007
Subject: [Slony1-general] can you change a node's id?
In-Reply-To: <Pine.LNX.4.64.0711201202220.18621@discord.home.frostconsultingllc.com>
References: <Pine.LNX.4.64.0711201045550.20488@discord.home.frostconsultingllc.com>	<47433CAE.6040506@ca.afilias.info>
	<Pine.LNX.4.64.0711201202220.18621@discord.home.frostconsultingllc.com>
Message-ID: <4744696E.4040601@Yahoo.com>

On 11/20/2007 3:07 PM, Jeff Frost wrote:
> On Tue, 20 Nov 2007, Christopher Browne wrote:
> 
>> No, there is no notion of modifying the node ID; the ID is very deeply 
>> intertwined into replication state across all the nodes, with the result that 
>> trying to alter the ID would be likely to lead to potential for *enormous* 
>> confusion within the replication system.
>>
>> There is no reason to have a "node 1" around; many of the tests assume its 
>> absence, and in most of our production clusters, we use node numbers that are 
>> *somewhat* meaningful.
>>
>> For instance, several clusters consist of nodes:
>> 8141
>> 8142
>> 8143
>> 8194
>>
>> Where:
>>
>> - "81" indicates that it's a PostgreSQL 8.1 instance  (we may soon have nodes 
>> starting with "83")
>> - 4 versus 9 indicates which data centre the node is at
>> - below all of that, we have a more-or-less serial value, 1,2,3,4
>>
>> It's not quite wonderful, but it's mnemonic enough to be useful...
> 
> The only reason I consider changing it, is that the event node defaults to 1. 

Which admittedly was a design mistake to begin with.


Jan


> Is it possible to define what the default event node without changing the code 
> and recompiling?
> 
>   EVENT NODE = ival
>      (Optional) The ID of the current origin of the set. Default value is 1.
> 
> It just means we have to remember to specify it in the slonik scripts after 
> the upgrade.
> 


-- 
#======================================================================#
# It's easier to get forgiveness for being wrong than for being right. #
# Let's break this rule - forgive me.                                  #
#================================================== JanWieck@Yahoo.com #
From jc at oxado.com  Wed Nov 21 15:35:14 2007
From: jc at oxado.com (Jacques Caron)
Date: Wed Nov 21 15:35:54 2007
Subject: [Slony1-general] Patch to have a defined table lock order
Message-ID: <20071121233542.C2BA1116593E@zeus.directinfos.com>

Hi,

The following patch adds a new column to sl_table: tab_lock_order, 
and modifies the order in which tables are locked during all calls 
that require extensive locking (i.e. all those that call 
alterTableForReplication or alterTableRestore on a set of tables): 
they are locked in coalesce(tab_lock_order,0),tab_id order rather 
than random order or just tab_id order.

This means that by default (tab_lock_order null for all tables), they 
are locked in tab_id order (in all those calls rather than just some 
of them), but the order can be overridden by setting tab_lock_order 
appropriately (this allow reordering the locks, as tab_id's cannot be 
easily changed).

Alternatives would be to set tab_lock_order's default value to be 
tab_id (+ not null and maybe unique + remove coalesce and maybe 
tab_id from order by), or to order by coalesce(tab_lock_order,tab_id).

Note that I'm not sure the schema upgrade is the "right way" to do 
it, maybe add_missing_table_field() should be used for this, and 
obviously the schema version needed to be bumped up, not sure what 
the best practice is for that?

Comments welcome,

Jacques.

--- slony1-1.2.12.orig/src/backend/slony1_funcs.sql     Mon Oct 22 
17:19:50 2007
+++ slony1-1.2.12/src/backend/slony1_funcs.sql  Thu Nov 22 00:19:29 2007
@@ -430,7 +430,7 @@
  returns int4
  as '
  begin
-       return 12;
+       return 13;
  end;
  ' language plpgsql;
  comment on function @NAMESPACE@.slonyVersionPatchlevel () is
@@ -1219,6 +1219,7 @@
                         if p_backup_node = 
@NAMESPACE@.getLocalNodeId(''_@CLUSTERNAME@'') then
                                 for v_row2 in select * from 
@NAMESPACE@.sl_table
                                                 where tab_set = v_row.set_id
+                                               order by 
coalesce(tab_lock_order,0),tab_id
                                 loop
                                         perform 
@NAMESPACE@.alterTableRestore(v_row2.tab_id);
                                 end loop;
@@ -1231,6 +1232,7 @@

                                 for v_row2 in select * from 
@NAMESPACE@.sl_table
                                                 where tab_set = v_row.set_id
+                                               order by 
coalesce(tab_lock_order,0),tab_id
                                 loop
                                         perform 
@NAMESPACE@.alterTableForReplication(v_row2.tab_id);
                                 end loop;
@@ -1380,6 +1382,7 @@
         if p_backup_node = @NAMESPACE@.getLocalNodeId(''_@CLUSTERNAME@'') then
                 for v_row in select * from @NAMESPACE@.sl_table
                                 where tab_set = p_set_id
+                               order by coalesce(tab_lock_order,0),tab_id
                 loop
                         perform @NAMESPACE@.alterTableRestore(v_row.tab_id);
                 end loop;
@@ -1395,6 +1398,7 @@

                 for v_row in select * from @NAMESPACE@.sl_table
                                 where tab_set = p_set_id
+                               order by coalesce(tab_lock_order,0),tab_id
                 loop
                         perform 
@NAMESPACE@.alterTableForReplication(v_row.tab_id);
                 end loop;
@@ -1484,7 +1488,7 @@
         -- This is us ... time for suicide! Restore all tables to
         -- their original status.
         -- ----
-       for v_tab_row in select * from @NAMESPACE@.sl_table loop
+       for v_tab_row in select * from @NAMESPACE@.sl_table order by 
coalesce(tab_lock_order,0),tab_id loop
                 perform @NAMESPACE@.alterTableRestore(v_tab_row.tab_id);
                 perform @NAMESPACE@.tableDropKey(v_tab_row.tab_id);
         end loop;
@@ -1984,7 +1988,7 @@
                         where T.tab_set = p_set_id
                                 and T.tab_reloid = PGC.oid
                                 and PGC.relnamespace = PGN.oid
-                       order by tab_id
+                       order by coalesce(tab_lock_order,0),tab_id
         loop
                 execute ''create trigger "_@CLUSTERNAME@_lockedset_'' ||
                                 v_tab_row.tab_id ||
@@ -2060,7 +2064,7 @@
                         where T.tab_set = p_set_id
                                 and T.tab_reloid = PGC.oid
                                 and PGC.relnamespace = PGN.oid
-                       order by tab_id
+                       order by coalesce(tab_lock_order,0),tab_id
         loop
                 execute ''drop trigger "_@CLUSTERNAME@_lockedset_'' ||
                                 v_tab_row.tab_id || ''" on '' || 
v_tab_row.tab_fqname;
@@ -2214,7 +2218,7 @@
         if v_local_node_id = p_old_origin or v_local_node_id = 
p_new_origin then
                 for v_tab_row in select tab_id from @NAMESPACE@.sl_table
                                 where tab_set = p_set_id
-                               order by tab_id
+                               order by coalesce(tab_lock_order,0),tab_id
                 loop
                         perform 
@NAMESPACE@.alterTableRestore(v_tab_row.tab_id);
                 end loop;
@@ -2362,7 +2366,7 @@
         if v_local_node_id = p_old_origin or v_local_node_id = 
p_new_origin then
                 for v_tab_row in select tab_id from @NAMESPACE@.sl_table
                                 where tab_set = p_set_id
-                               order by tab_id
+                               order by coalesce(tab_lock_order,0),tab_id
                 loop
                         perform 
@NAMESPACE@.alterTableForReplication(v_tab_row.tab_id);
                 end loop;
@@ -2441,7 +2445,7 @@
         -- ----
         for v_tab_row in select tab_id from @NAMESPACE@.sl_table
                         where tab_set = p_set_id
-                       order by tab_id
+                       order by coalesce(tab_lock_order,0),tab_id
         loop
                 perform @NAMESPACE@.alterTableRestore(v_tab_row.tab_id);
                 perform @NAMESPACE@.tableDropKey(v_tab_row.tab_id);
@@ -3711,12 +3715,12 @@
                 -- Create a SYNC event, run the script and generate 
the DDL_SCRIPT event
                 -- ----
                 perform @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', 
''SYNC'', NULL);
-               perform @NAMESPACE@.alterTableRestore(tab_id) from 
@NAMESPACE@.sl_table where tab_set in (select set_id from 
@NAMESPACE@.sl_set where set_origin = 
@NAMESPACE@.getLocalNodeId(''_@CLUSTERNAME@''));
+               perform @NAMESPACE@.alterTableRestore(tab_id) from 
@NAMESPACE@.sl_table where tab_set in (select set_id from 
@NAMESPACE@.sl_set where set_origin = 
@NAMESPACE@.getLocalNodeId(''_@CLUSTERNAME@'')) order by 
coalesce(tab_lock_order,0),tab_id;
         else
                 -- ----
                 -- If doing "only on one node" - restore ALL tables 
irrespective of set
                 -- ----
-               perform @NAMESPACE@.alterTableRestore(tab_id) from 
@NAMESPACE@.sl_table;
+               perform @NAMESPACE@.alterTableRestore(tab_id) from 
@NAMESPACE@.sl_table order by coalesce(tab_lock_order,0),tab_id;
         end if;
         return 1;
  end;
@@ -3743,12 +3747,12 @@
  begin
         perform @NAMESPACE@.updateRelname(p_set_id, p_only_on_node);
         if p_only_on_node = -1 then
-               perform @NAMESPACE@.alterTableForReplication(tab_id) 
from @NAMESPACE@.sl_table where tab_set in (select set_id from 
@NAMESPACE@.sl_set where set_origin = 
@NAMESPACE@.getLocalNodeId(''_@CLUSTERNAME@''));
+               perform @NAMESPACE@.alterTableForReplication(tab_id) 
from @NAMESPACE@.sl_table where tab_set in (select set_id from 
@NAMESPACE@.sl_set where set_origin = 
@NAMESPACE@.getLocalNodeId(''_@CLUSTERNAME@'')) order by 
coalesce(tab_lock_order,0),tab_id;

                 return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', 
''DDL_SCRIPT'',
                         p_set_id::text, p_script::text, p_only_on_node::text);
         else
-               perform @NAMESPACE@.alterTableForReplication(tab_id) 
from @NAMESPACE@.sl_table;
+               perform @NAMESPACE@.alterTableForReplication(tab_id) 
from @NAMESPACE@.sl_table order by coalesce(tab_lock_order,0),tab_id;
         end if;
         return NULL;
  end;
@@ -3812,7 +3816,7 @@
         -- ----
         -- Restore all original triggers and rules of all sets
         -- ----
-       for v_row in select * from @NAMESPACE@.sl_table
+       for v_row in select * from @NAMESPACE@.sl_table order by 
coalesce(tab_lock_order,0),tab_id
         loop
                 perform @NAMESPACE@.alterTableRestore(v_row.tab_id);
         end loop;
@@ -3843,7 +3847,7 @@
         -- ----
         -- Put all tables back into replicated mode
         -- ----
-       for v_row in select * from @NAMESPACE@.sl_table
+       for v_row in select * from @NAMESPACE@.sl_table order by 
coalesce(tab_lock_order,0),tab_id
         loop
                 perform @NAMESPACE@.alterTableForReplication(v_row.tab_id);
         end loop;
@@ -4363,7 +4367,7 @@
         -- ----
         for v_tab_row in select tab_id from @NAMESPACE@.sl_table
                         where tab_set = p_sub_set
-                       order by tab_id
+                       order by coalesce(tab_lock_order,0),tab_id
         loop
                 perform @NAMESPACE@.alterTableRestore(v_tab_row.tab_id);
                 perform @NAMESPACE@.tableDropKey(v_tab_row.tab_id);
@@ -5912,6 +5921,14 @@
                                         ) without oids'';
                 execute ''insert into @NAMESPACE@.sl_archive_counter
                                         (ac_num, ac_timestamp) 
values (0, ''''epoch''''::timestamp)'';
+       end if;
+
+       -- ----
+       -- Changes for 1.2.13
+       -- ----
+       if p_old IN (''1.0.2'', ''1.0.5'', ''1.0.6'', ''1.1.0'', 
''1.1.1'', ''1.1.2'', ''1.1.3'',''1.1.5'', ''1.1.6'', ''1.1.7'', 
''1.1.8'', ''1.1.9'', ''1.2.0'', ''1.2.1'', ''1.2.2'', ''1.2.3'', 
''1.2.4'', ''1.2.5'', ''1.2.6'', ''1.2.7'', ''1.2.8'', ''1.2.9'', 
''1.2.10'', ''1.2.11'', ''1.2.12'') then
+               -- Add new column sl_table.tab_lock_order
+               execute ''alter table @NAMESPACE@.sl_table add column 
tab_lock_order integer'';
         end if;

         -- In any version, make sure that the xxidin() functions are 
defined STRICT

From termeau at gmail.com  Thu Nov 22 04:52:05 2007
From: termeau at gmail.com (termeau sebastien)
Date: Thu Nov 22 04:52:32 2007
Subject: [Slony1-general] PB with Failover and switchover
Message-ID: <8466e51e0711220452k77e4d75bhc2814cd60ae76c48@mail.gmail.com>

Hello,

I am using Slony 1.2.12 with Postgresql 8.2.5
I have 2 nodes replicating a small database.
The replication works fine but when I try to use failover and switchover I
got an error.
Failover and switchover were working perfectly before but now I can't use
these features anymore, even I downgrade to Slony 1.2.9.
Can you please help to find the source of this error?
Thanks in advance

For the Failover, here is my script :
#########################
 cluster name =3D my_cluster;
 node 1 admin conninfo=3D'host=3Dnode1 dbname=3Dbdd user=3Dslony port=3D543=
2';
 node 2 admin conninfo=3D'host=3Dnode2 dbname=3Dbdd user=3Dslony port=3D543=
2';


try {
             failover (id =3D 1, backup node =3D 2);
         } on error {
             echo 'Failure to fail node 1 over to 2';
             exit 1;
         }
          echo 'Replication sets originating on 1 failed over to 2';
          try {
              drop node (id =3D 1, event node =3D 2);
          } on error {
              echo 'Failed to drop node 1 from cluster';
              exit 1;
          }
         echo 'dropped node 2 cluster';
#########################

And here is the error message that appears in my console ( there is nothing
in log file):

#########################
<stdin>:6: PGRES_FATAL_ERROR select "_my_cluster".failedNode(1, 2);  -
ERROR:  relation "PartInd_my_cluster_sl_log_2-" already exists
CONTEXT:  SQL statement "create index "PartInd_my_cluster_sl_log_2-node-2"
on "_my_cluster".sl_log_2 USING btree(log_xid "_my_cluster".xxid_ops) where
(log_origin =3D 2);"
PL/pgSQL function "addpartiallogindices" line 34 at execute statement
SQL statement "SELECT  "_my_cluster".addPartialLogIndices()"
PL/pgSQL function "failednode" line 158 at perform
<stdin>:8: Failure to fail node 1 over to 2
#########################


When I try to do a switchover using this script :
#########################
cluster name =3D my_cluster;
node 1 admin conninfo=3D'host=3Dnode1 dbname=3Dbdduser=3Dslony port=3D5432';
node 2 admin conninfo=3D'host=3Dnode2 dbname=3Dbdd user=3Dslony port=3D5432=
';

echo 'Moving set 1 to node 2';
lock set (id=3D1, origin=3D1);
echo 'Set locked';
wait for event (origin =3D 1, confirmed =3D 2);
echo 'Moving set';
move set (id=3D1, old origin=3D1, new origin=3D2);
echo 'Set moved - waiting for event to be confirmed by node 2';
wait for event (origin =3D 1, confirmed =3D 2);
echo 'Confirmed';
#########################

The slonik script output is locked on "<stdin>:11: Set moved - waiting for
event to be confirmed by node 2" and I got an error message equivalent to
the one I got for failover but in log file. I also

#########################
"select "_hwi06intrsifoisusgbd1_2_hwi06intrsifoisusgbd2".cleanupNodelock();
insert into "_hwi06intrsifoisusgbd1_2_hwi06intrsifoisusgbd2".sl_nodelock
values (    2, 0, "pg_catalog".pg_backend_pid()); " - ERROR:  duplicate key
violates unique constraint "sl_nodelock-pkey"
#########################


On node1, the sl_nodelock table contains :
1             0               21582
2             1               21682
2             2               21684
2             3               21865

On node2, the sl_nodelock table contains :
1             1               25103
2             0               25164
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20071122/=
fac84a21/attachment-0001.html
From simon at 2ndquadrant.com  Thu Nov 22 08:15:37 2007
From: simon at 2ndquadrant.com (Simon Riggs)
Date: Thu Nov 22 08:15:31 2007
Subject: [Slony1-general] Version 1.2.12 released
In-Reply-To: <47396E63.8080106@free.fr>
References: <601wavf4kp.fsf@dba2.int.libertyrms.com> <47396E63.8080106@free.fr>
Message-ID: <1195748137.4246.173.camel@ebony.site>

On Tue, 2007-11-13 at 10:29 +0100, Cyril SCETBON wrote:

> I think it would be better to be able to modify SLON_DATA_FETCH_SIZE by 
> using a parameter on the slon command line. For example, we got a lot of 
> updates (400 per second) between far geographical sites. I had to modify 
> this variable and to recompile the slon binary cause I didn't find 
> another way until now.

Cyril,

Could you publish your performance results? That will help everybody to
understand the benefit of this change.

Do you have results for a variety of settings? It may be that we just
make a permanent change of the #DEFINEd value, rather than making it
configurable.

-- 
  Simon Riggs
  2ndQuadrant  http://www.2ndQuadrant.com

From cyril.scetbon at free.fr  Thu Nov 22 08:19:16 2007
From: cyril.scetbon at free.fr (Cyril SCETBON)
Date: Thu Nov 22 08:19:23 2007
Subject: [Slony1-general] Problem between slonik version and slony-I version
Message-ID: <4745AC04.5020307@free.fr>

Hi,


I get the following error when I try to create a new configuration :


PkQ:2: Possible unsupported PostgreSQL version (80204) 8.2, defaulting 
to 8.0 support
PkQ:2: loading of file /usr/share/slony1/slony1_funcs.sql: 
PGRES_FATAL_ERROR ERROR:  Slonik version: 1.2.1 != Slony-I version in PG 
build 1.2.10
ERROR:  Slonik version: 1.2.1 != Slony-I version in PG build 1.2.10


what does it mean ? cause I use slonik and slony version from the last 
debian package (etch). 1.2.1-1


thanks


From cyril.scetbon at free.fr  Thu Nov 22 08:22:44 2007
From: cyril.scetbon at free.fr (Cyril SCETBON)
Date: Thu Nov 22 08:22:48 2007
Subject: [Slony1-general] Version 1.2.12 released
In-Reply-To: <1195748137.4246.173.camel@ebony.site>
References: <601wavf4kp.fsf@dba2.int.libertyrms.com>	
	<47396E63.8080106@free.fr> <1195748137.4246.173.camel@ebony.site>
Message-ID: <4745ACD4.7070808@free.fr>



Simon Riggs wrote:
> On Tue, 2007-11-13 at 10:29 +0100, Cyril SCETBON wrote:
> 
>> I think it would be better to be able to modify SLON_DATA_FETCH_SIZE by 
>> using a parameter on the slon command line. For example, we got a lot of 
>> updates (400 per second) between far geographical sites. I had to modify 
>> this variable and to recompile the slon binary cause I didn't find 
>> another way until now.
> 
> Cyril,
> 
> Could you publish your performance results? That will help everybody to
> understand the benefit of this change.
Ok Simon. I'll make it as soon as I'll have time. Actually, I'm really 
busy :-(
> 
> Do you have results for a variety of settings? It may be that we just
> make a permanent change of the #DEFINEd value, rather than making it
> configurable.
No, just before and after making that change I think. I'll check.

Regards
From ajs at crankycanuck.ca  Thu Nov 22 09:29:43 2007
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Thu Nov 22 09:30:06 2007
Subject: [Slony1-general] Problem between slonik version and slony-I
	version
In-Reply-To: <4745AC04.5020307@free.fr>
References: <4745AC04.5020307@free.fr>
Message-ID: <20071122172943.GC22277@crankycanuck.ca>

On Thu, Nov 22, 2007 at 05:19:16PM +0100, Cyril SCETBON wrote:
> ERROR:  Slonik version: 1.2.1 != Slony-I version in PG build 1.2.10
> 
> 
> what does it mean ? cause I use slonik and slony version from the last 
> debian package (etch). 1.2.1-1

It means that the slony versions don't match.  They have to.  Could be a
packaging problem.

A

-- 
Andrew Sullivan
Old sigs will return after re-constitution of blue smoke
From cbbrowne at ca.afilias.info  Thu Nov 22 09:34:44 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Thu Nov 22 09:34:51 2007
Subject: [Slony1-general] Problem between slonik version and slony-I
	version
In-Reply-To: <4745AC04.5020307@free.fr> (Cyril SCETBON's message of "Thu,
	22 Nov 2007 17:19:16 +0100")
References: <4745AC04.5020307@free.fr>
Message-ID: <601waigp57.fsf@dba2.int.libertyrms.com>

Cyril SCETBON <cyril.scetbon@free.fr> writes:
> I get the following error when I try to create a new configuration :
>
>
> PkQ:2: Possible unsupported PostgreSQL version (80204) 8.2, defaulting
> to 8.0 support
> PkQ:2: loading of file /usr/share/slony1/slony1_funcs.sql:
> PGRES_FATAL_ERROR ERROR:  Slonik version: 1.2.1 != Slony-I version in
> PG build 1.2.10
> ERROR:  Slonik version: 1.2.1 != Slony-I version in PG build 1.2.10
>
> what does it mean ? cause I use slonik and slony version from the last
> debian package (etch). 1.2.1-1

Well, clearly you have mixed together some 1.2.1 components with parts
of a 1.2.10 build, which manifestly won't work, as is clearly shown in
the transcript above.

I expect that you should remove the Debian package for Slony, or build
a replacement package based on 1.2.10 (or, better still, 1.2.12, as it
is newer, and fixes a number of problems found in 1.2.10).
-- 
let name="cbbrowne" and tld="linuxfinances.info" in name ^ "@" ^ tld;;
http://linuxfinances.info/info/finances.html
"It's a pretty rare beginner who isn't clueless.  If beginners weren't
clueless, the infamous Unix learning cliff wouldn't be a problem."
-- david parsons
From cyril.scetbon at free.fr  Thu Nov 22 09:41:53 2007
From: cyril.scetbon at free.fr (Cyril SCETBON)
Date: Thu Nov 22 09:45:39 2007
Subject: [Slony1-general] Problem between slonik version and slony-I
	version
In-Reply-To: <601waigp57.fsf@dba2.int.libertyrms.com>
References: <4745AC04.5020307@free.fr> <601waigp57.fsf@dba2.int.libertyrms.com>
Message-ID: <4745BF61.1070103@free.fr>



Christopher Browne wrote:
> Cyril SCETBON <cyril.scetbon@free.fr> writes:
>> I get the following error when I try to create a new configuration :
>>
>>
>> PkQ:2: Possible unsupported PostgreSQL version (80204) 8.2, defaulting
>> to 8.0 support
>> PkQ:2: loading of file /usr/share/slony1/slony1_funcs.sql:
>> PGRES_FATAL_ERROR ERROR:  Slonik version: 1.2.1 != Slony-I version in
>> PG build 1.2.10
>> ERROR:  Slonik version: 1.2.1 != Slony-I version in PG build 1.2.10
>>
>> what does it mean ? cause I use slonik and slony version from the last
>> debian package (etch). 1.2.1-1
> 
> Well, clearly you have mixed together some 1.2.1 components with parts
> of a 1.2.10 build, which manifestly won't work, as is clearly shown in
> the transcript above.
> 
> I expect that you should remove the Debian package for Slony, or build
> a replacement package based on 1.2.10 (or, better still, 1.2.12, as it
> is newer, and fixes a number of problems found in 1.2.10).

Ok, that's what I understood but it seemed weird. I may have mixed slony 
for 8.1 with postgresql 8.2. I'll correct it.

thanks

From termeau at gmail.com  Thu Nov 22 09:48:51 2007
From: termeau at gmail.com (termeau sebastien)
Date: Thu Nov 22 09:49:00 2007
Subject: [Slony1-general] Re: PB with Failover and switchover
In-Reply-To: <8466e51e0711220452k77e4d75bhc2814cd60ae76c48@mail.gmail.com>
References: <8466e51e0711220452k77e4d75bhc2814cd60ae76c48@mail.gmail.com>
Message-ID: <8466e51e0711220948j55bb6e19l1597aa24733fbbc1@mail.gmail.com>

2007/11/22, termeau sebastien <XXXXXXXX>:
>
> Hello,
>
> I am using Slony 1.2.12 with Postgresql 8.2.5
> I have 2 nodes replicating a small database.
> The replication works fine but when I try to use failover and switchover I
> got an error.
> Failover and switchover were working perfectly before but now I can't use
> these features anymore, even I downgrade to Slony 1.2.9.
> Can you please help to find the source of this error?
> Thanks in advance
>
> #########################
> <stdin>:6: PGRES_FATAL_ERROR select "_my_cluster".failedNode(1, 2);  -
> ERROR:  relation "PartInd_my_cluster_sl_log_2-" already exists
> CONTEXT:  SQL statement "create index "PartInd_my_cluster_sl_log_2-node-2"
> on "_my_cluster".sl_log_2 USING btree(log_xid "_my_cluster".xxid_ops) whe=
re
> (log_origin =3D 2);"
> PL/pgSQL function "addpartiallogindices" line 34 at execute statement
> SQL statement "SELECT  "_my_cluster".addPartialLogIndices()"
> PL/pgSQL function "failednode" line 158 at perform
> <stdin>:8: Failure to fail node 1 over to 2
> #########################
>


Hello again,

I am glad to be able to answer to my own question ...
It seems that my cluster name is too long ( yes I replaced the name of the
cluster in the exemples above by a fake one, for confidential purpose). Then
it takes more than 64 char to write the index name PartInd_*.
I had to rebuild postgresql with NAMEDATALEN=3D128 to solve my problem.

Thanks
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20071122/=
1edcbcde/attachment.htm
From simon at 2ndquadrant.com  Thu Nov 22 10:13:18 2007
From: simon at 2ndquadrant.com (Simon Riggs)
Date: Thu Nov 22 10:13:08 2007
Subject: [Slony1-general] Understanding Slony Cleanup
Message-ID: <1195755198.4246.229.camel@ebony.site>

I'm trying to understand what goes on during cleanupThread_main()

The code does this, in order:

1. deletes all outstanding log rows from both log tables

2. (eventually) truncates the log table

3. (allegedly) vacuums the log table 

I have a few questions on the above for 1.2.x

- SQL function logswitch_finish() says it is called after cleanup thread
has vacuumed both log tables. The code in cleanupThread_main() seems to
avoid the vacuum. Not sure whether the SQL comment is wrong, or are we
saying we allow autovacuum to do this for us, or we don't do it at all? 

- Why do we DELETE log table rows at all? We're doing it out-of-line so
it clearly isn't a necessary step for correctness (or is it?). At the
end of it all we TRUNCATE them anyway, so what was the point of all that
deletion? Or alternatively, why do we truncate and log switch at all?

- My understanding of the flip-flop design with 2 log tables was that it
would allow us to avoid VACUUM entirely, yet this doesn't seem to be the
case in 1.2. What purpose does the second log table serve?

- If we do have to DELETE, why do we do this to both log tables? Surely
changes will only be found in one? Or are we assuming that the query
will do a fast indexscan and return quickly, so why bother trying to
avoid it?

- We rely on vacuum_delay having been set elsewhere. If we do have to do
VACUUMs, then can we/should we force a non-zero vacuum_delay for the
cleanup thread?

- We ANALYZE the log tables when they are empty following the TRUNCATE.
Is that done deliberately for some reason? At that point the data values
are not available so it means later planning of SQL against the log
tables is going to be a little strange. Should weavoid re-ANALYZEing the
log table when we have just TRUNCATED it?

Anyone shed any light on these things? Thanks.

-- 
  Simon Riggs
  2ndQuadrant  http://www.2ndQuadrant.com

From postgres at dac.e4ward.com  Thu Nov 22 11:08:54 2007
From: postgres at dac.e4ward.com (postgres@dac.e4ward.com)
Date: Thu Nov 22 11:09:03 2007
Subject: [Slony1-general] Running Slonik from a server without Postgres
Message-ID: <3373193336-3284@e4ward.com>

Hi all.

I have the following network of servers:

* 2 load balanced application servers
* 1 MASTER node server running PostgreSQL 8.1.10 with Slony 1.2.12
* 1 SLAVE node server running PostgreSQL 8.1.10 with Slony 1.2.12
* I'm using the altperl admin scripts.

My concerns:

* Both slon daemons are running from the master postgres server. I
know I can run each slon from it's own server. What do you think it
would be the best approach to achieve fast failover? I suppose running
each slon on it's own maintained node.

* I need to be able to execute the admin scripts (altperls' and
slonik) from at least one of the application servers. Specially
slony_execute_script to update the schema regularly. Problem is
neither postgres or slony is installed there. Can I install slony
there without installing postgres? What would you suggest? Right now I
think my only possibility would be to execute slonik remotely from the
app server via ssh. But I'd REALLY prefer to avoid it.

I'd appreciate any advice you could give me. I've read a lot from the
documentation, but it seems slonik is always suposed to be installed
and run from the same server where postgres is installed.

Thanks.
-- 
Diego Algorta Casamayou
http://www.oboxodo.com - http://diego.algorta.net
From rod at iol.ie  Thu Nov 22 11:14:12 2007
From: rod at iol.ie (Raymond O'Donnell)
Date: Thu Nov 22 11:14:19 2007
Subject: [Slony1-general] Running Slonik from a server without Postgres
In-Reply-To: <3373193336-3284@e4ward.com>
References: <3373193336-3284@e4ward.com>
Message-ID: <4745D504.9010002@iol.ie>

On 22/11/2007 19:08, postgres@dac.e4ward.com wrote:
> documentation, but it seems slonik is always suposed to be installed
> and run from the same server where postgres is installed.

That's not my understanding....in particular, since connection strings 
passed to slon always include host and port fields, I don't see why they 
need to be on the same machine as the DB.

AFAIK Slony needs to be *compiled* on a machine where there's a Postgres 
source tree, but not necessarily run from there.

Ray.

---------------------------------------------------------------
Raymond O'Donnell, Director of Music, Galway Cathedral, Ireland
rod@iol.ie
---------------------------------------------------------------
From dpage at postgresql.org  Thu Nov 22 11:18:46 2007
From: dpage at postgresql.org (Dave Page)
Date: Thu Nov 22 11:18:56 2007
Subject: [Slony1-general] [Fwd: [Slony1-patches] Fix for PG8.3 beta3]
Message-ID: <4745D616.8020509@postgresql.org>

This didn't get any responses on -patches - is that list dead?

/D

-------- Original Message --------
Subject: [Slony1-patches] Fix for PG8.3 beta3
Date: Fri, 16 Nov 2007 14:51:12 +0000
From: Dave Page <dpage@postgresql.org>
To: slony1-patches@lists.slony.info

The attached patch fixes (against 1.2.12) Slony to build against
PostgreSQL 8.3 beta 3. I'm not 100% sure that it's the correct fix as
I'm not familiar with the affected part of PostgreSQL, but it builds
now, and seems to work OK.

Autoconf should be run to regenerate configure.

Regards, Dave


-------------- next part --------------
diff -c -r slony1-1.2.12/config/acx_libpq.m4 slony1-1.2.12.new/config/acx_l=
ibpq.m4
*** slony1-1.2.12/config/acx_libpq.m4	Wed Nov 29 18:52:14 2006
--- slony1-1.2.12.new/config/acx_libpq.m4	Fri Nov 16 13:37:08 2007
***************
*** 351,357 ****
  	AC_DEFINE(HAVE_PQFREEMEM,1,[Postgresql PQfreemem()])
  fi
  =

! =

  AC_MSG_CHECKING(for typenameTypeId)
  if test -z "$ac_cv_typenameTypeId_args"; then
    AC_TRY_COMPILE(
--- 351,364 ----
  	AC_DEFINE(HAVE_PQFREEMEM,1,[Postgresql PQfreemem()])
  fi
  =

! AC_MSG_CHECKING(for typenameTypeId)
! if test -z "$ac_cv_typenameTypeId_args"; then
!   AC_TRY_COMPILE(
!     [#include "postgres.h"
!      #include "parser/parse_type.h"],
!     [typenameTypeId(NULL, NULL, NULL); ],
!     ac_cv_typenameTypeId_args=3D3)
! fi
  AC_MSG_CHECKING(for typenameTypeId)
  if test -z "$ac_cv_typenameTypeId_args"; then
    AC_TRY_COMPILE(
***************
*** 370,376 ****
  if test -z "$ac_cv_typenameTypeId_args"; then
    AC_MSG_RESULT(no)
  else
!   if test "$ac_cv_typenameTypeId_args" =3D 2; then
      AC_DEFINE(HAVE_TYPENAMETYPEID_2)
    elif test "$ac_cv_typenameTypeId_args" =3D 1; then
      AC_DEFINE(HAVE_TYPENAMETYPEID_1)
--- 377,385 ----
  if test -z "$ac_cv_typenameTypeId_args"; then
    AC_MSG_RESULT(no)
  else
!   if test "$ac_cv_typenameTypeId_args" =3D 3; then
!     AC_DEFINE(HAVE_TYPENAMETYPEID_3)
!   elif test "$ac_cv_typenameTypeId_args" =3D 2; then
      AC_DEFINE(HAVE_TYPENAMETYPEID_2)
    elif test "$ac_cv_typenameTypeId_args" =3D 1; then
      AC_DEFINE(HAVE_TYPENAMETYPEID_1)
Only in slony1-1.2.12.new: config.h
diff -c -r slony1-1.2.12/config.h.in slony1-1.2.12.new/config.h.in
*** slony1-1.2.12/config.h.in	Tue Sep  4 21:42:14 2007
--- slony1-1.2.12.new/config.h.in	Fri Nov 16 13:44:03 2007
***************
*** 87,92 ****
--- 87,95 ----
  /* Set to 1 if typenameTypeId() takes 2 args */
  #undef HAVE_TYPENAMETYPEID_2
  =

+ /* Set to 1 if typenameTypeId() takes 3 args */
+ #undef HAVE_TYPENAMETYPEID_3
+ =

  /* Set to 1 if standard_conforming_strings available */
  #undef HAVE_STANDARDCONFORMINGSTRINGS
 =

diff -c -r slony1-1.2.12/src/backend/slony1_funcs.c slony1-1.2.12.new/src/b=
ackend/slony1_funcs.c
*** slony1-1.2.12/src/backend/slony1_funcs.c    Wed May  2 22:37:07 2007
--- slony1-1.2.12.new/src/backend/slony1_funcs.c        Fri Nov 16 13:39:30=
 2007
***************
*** 1351,1361 ****
--- 1351,1365 ----
                        lappend(lappend(NIL, makeString(NameStr(cs->cluster=
name))),
                                        makeString("xxid"));
 =

+ #ifdef HAVE_TYPENAMETYPEID_3
+               xxid_typid =3D typenameTypeId(NULL,xxid_typename,NULL);
+ #else
  #ifdef HAVE_TYPENAMETYPEID_2
                xxid_typid =3D typenameTypeId(NULL,xxid_typename);
  #else
                xxid_typid =3D typenameTypeId(xxid_typename);
  #endif
+ #endif
                plan_types[0] =3D INT4OID;
 =

                /*
***************
*** 1434,1444 ****
--- 1438,1452 ----
                xxid_typename->names =3D
                        lappend(lappend(NIL, makeString(NameStr(cs->cluster=
name))),
                                        makeString("xxid"));
+ #ifdef HAVE_TYPENAMETYPEID_3
+                 xxid_typid =3D typenameTypeId(NULL, xxid_typename,NULL);
+ #else
  #ifdef HAVE_TYPENAMETYPEID_2
                xxid_typid =3D typenameTypeId(NULL, xxid_typename);
  #else
                xxid_typid =3D typenameTypeId(xxid_typename);
  #endif
+ #endif

                /*
                 * Create the saved plan's


From postgres at dac.e4ward.com  Thu Nov 22 11:40:02 2007
From: postgres at dac.e4ward.com (postgres@dac.e4ward.com)
Date: Thu Nov 22 11:40:12 2007
Subject: [Slony1-general] Running Slonik from a server without Postgres
In-Reply-To: <3373193652-2216@e4ward.com>
References: <3373193336-3284@e4ward.com> <3373193652-2216@e4ward.com>
Message-ID: <3373195204-1073@e4ward.com>

On Nov 22, 2007 5:14 PM,  <slony1-general@lists.slony.info> wrote:
> On 22/11/2007 19:08, postgres@dac.e4ward.com wrote:
> > documentation, but it seems slonik is always suposed to be installed
> > and run from the same server where postgres is installed.
>
> That's not my understanding....in particular, since connection strings
> passed to slon always include host and port fields, I don't see why they
> need to be on the same machine as the DB.


I understand that and in fact, as I said, I'm successfully running the
slave slon daemon from the master server, remotely. BUT I happen to
have postgres installed on that server too.

My problem is not where to run slon, because I'm running it always
from servers where postgres is running too. My problem is to execute
slonik remotely from a server where I don't have neither postgres or
slon suning.

Do I explain myself?

Thanks a lot for your answer.

-- 
Diego Algorta Casamayou
http://www.oboxodo.com - http://diego.algorta.net
From rod at iol.ie  Thu Nov 22 11:44:10 2007
From: rod at iol.ie (Raymond O'Donnell)
Date: Thu Nov 22 11:44:24 2007
Subject: [Slony1-general] Running Slonik from a server without Postgres
In-Reply-To: <3373195204-1073@e4ward.com>
References: <3373193336-3284@e4ward.com> <3373193652-2216@e4ward.com>
	<3373195204-1073@e4ward.com>
Message-ID: <4745DC0A.1090306@iol.ie>

On 22/11/2007 19:40, postgres@dac.e4ward.com wrote:
> My problem is not where to run slon, because I'm running it always
> from servers where postgres is running too. My problem is to execute
> slonik remotely from a server where I don't have neither postgres or
> slon suning.

Ah, sorry - I read your post too quickly! I haven't tried it, but I 
think it ought to work....have you tried it? - I mean, copy slonik onto 
a machine where neither PG nor Slony are installed, and simply see if it 
works?

Ray.


---------------------------------------------------------------
Raymond O'Donnell, Director of Music, Galway Cathedral, Ireland
rod@iol.ie
---------------------------------------------------------------
From cbbrowne at ca.afilias.info  Thu Nov 22 14:10:42 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Thu Nov 22 14:10:53 2007
Subject: [Slony1-general] Re: PB with Failover and switchover
In-Reply-To: <8466e51e0711220948j55bb6e19l1597aa24733fbbc1@mail.gmail.com>
	(termeau sebastien's message of "Thu, 22 Nov 2007 18:48:51 +0100")
References: <8466e51e0711220452k77e4d75bhc2814cd60ae76c48@mail.gmail.com>
	<8466e51e0711220948j55bb6e19l1597aa24733fbbc1@mail.gmail.com>
Message-ID: <60wssaexst.fsf@dba2.int.libertyrms.com>

"termeau sebastien" <termeau@gmail.com> writes:
> 2007/11/22, termeau sebastien <XXXXXXXX>:
>
>           Hello,
>      
>      I am using Slony 1.2.12 with Postgresql 8.2.5
>      I have 2 nodes replicating a small database.
>      The replication works fine but when I try to use failover and switchover I got an error.
>      Failover and switchover were working perfectly before but now I can't use these features anymore, even I downgrade to Slony 1.2.9.
>      Can you please help to find the source of this error?
>      Thanks in advance
>      
>      #########################
>      <stdin>:6: PGRES_FATAL_ERROR select "_my_cluster".failedNode(1, 2);? - ERROR:? relation "PartInd_my_cluster_sl_log_2-" already exists
>      CONTEXT:? SQL statement "create index "PartInd_my_cluster_sl_log_2-node-2" on "_my_cluster".sl_log_2 USING btree(log_xid "_my_cluster".xxid_ops)
>      where (log_origin = 2);"
>      PL/pgSQL function "addpartiallogindices" line 34 at execute statement
>      SQL statement "SELECT? "_my_cluster".addPartialLogIndices()"
>      PL/pgSQL function "failednode" line 158 at perform
>      <stdin>:8: Failure to fail node 1 over to 2
>      #########################
>      
>
>
> Hello again,
> I am glad to be able to answer to my own question ...
> It seems that my cluster name is too long ( yes I replaced the name of the cluster in the exemples above by a fake one, for confidential purpose). Then it
> takes more than 64 char to write the index name PartInd_*.
> I had to rebuild postgresql with NAMEDATALEN=128 to solve my problem.

Ah, OK, I was getting worried that it might be a bug in the handling
of creation of the sl_log_N indices.

We probably ought to set up some constraint to prevent people from
creating cluster names so long that this sort of thing can happen.

I have set up a low priority bug for this...

http://www.slony.info/bugzilla/show_bug.cgi?id=15
-- 
output = ("cbbrowne" "@" "acm.org")
http://cbbrowne.com/info/wp.html
Rules of  the Evil Overlord  #149. "Ropes supporting  various fixtures
will not be  tied next to open windows  or staircases, and chandeliers
will be hung way at the top of the ceiling."
<http://www.eviloverlord.com/>
From cbbrowne at ca.afilias.info  Thu Nov 22 14:16:48 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Thu Nov 22 14:16:59 2007
Subject: [Slony1-general] Running Slonik from a server without Postgres
In-Reply-To: <3373195204-1073@e4ward.com> (postgres@dac.e4ward.com's message
	of "Thu, 22 Nov 2007 17:40:02 -0200")
References: <3373193336-3284@e4ward.com> <3373193652-2216@e4ward.com>
	<3373195204-1073@e4ward.com>
Message-ID: <60sl2yexin.fsf@dba2.int.libertyrms.com>

<postgres@dac.e4ward.com> writes:
> On Nov 22, 2007 5:14 PM,  <slony1-general@lists.slony.info> wrote:
>> On 22/11/2007 19:08, postgres@dac.e4ward.com wrote:
>> > documentation, but it seems slonik is always suposed to be installed
>> > and run from the same server where postgres is installed.
>>
>> That's not my understanding....in particular, since connection strings
>> passed to slon always include host and port fields, I don't see why they
>> need to be on the same machine as the DB.
>
>
> I understand that and in fact, as I said, I'm successfully running the
> slave slon daemon from the master server, remotely. BUT I happen to
> have postgres installed on that server too.
>
> My problem is not where to run slon, because I'm running it always
> from servers where postgres is running too. My problem is to execute
> slonik remotely from a server where I don't have neither postgres or
> slon suning.
>
> Do I explain myself?

Yes, you're explaining yourself...

You will have a difficult time running slonik on a host that doesn't
have *any* of PostgreSQL running, because it will typically be
dynamically linked to the PostgreSQL client library, libpq, and you
will therefore need to have at least that part (libpq) of PostgreSQL
installed.

If your distribution has separate packages for:
a) Server components (e.g. - postmaster)
b) Libraries (e.g. - libpq)
c) Client components (e.g. - psql, pg_dump, ...)

then you could presumably avoid installing the server components and
still be able to get Slony-I components to work.  I'd certainly want
to have PostgreSQL "client components" like psql and pg_dump handy,
though...
-- 
(reverse (concatenate 'string "moc.enworbbc" "@" "enworbbc"))
http://linuxfinances.info/info/x.html
"How can you dream the impossible dream when you can't get any sleep?"
-- Sam Robb
From cbbrowne at ca.afilias.info  Thu Nov 22 14:29:50 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Thu Nov 22 14:30:02 2007
Subject: [Slony1-general] [Fwd: [Slony1-patches] Fix for PG8.3 beta3]
In-Reply-To: <4745D616.8020509@postgresql.org> (Dave Page's message of "Thu,
	22 Nov 2007 19:18:46 +0000")
References: <4745D616.8020509@postgresql.org>
Message-ID: <60myt5gbhd.fsf@dba2.int.libertyrms.com>

Dave Page <dpage@postgresql.org> writes:
> This didn't get any responses on -patches - is that list dead?

I am taking a look at this now; I have a build ongoing right now of PG
8.3 HEAD, in order to validate that it's fixing something that's
broken.

Curiously, I suppose, I'm not seeing anything breaking right now
without the patch.  But then, the PG 8.3 build I'm using is a couple
weeks old; hopefully when I look at this tomorrow, with the newer
build, I'll find a blow-up.

It may wait to get completed until tomorrow.
-- 
let name="cbbrowne" and tld="acm.org" in name ^ "@" ^ tld;;
http://www3.sympatico.ca/cbbrowne/emacs.html
"NT 5.0 is the last nail in the Unix coffin. Interestingly, Unix isn't
in the coffin... It's wondering what the heck is sealing itself into a
wooden box 6 feet underground..." -- Jason McMullan
From cbbrowne at ca.afilias.info  Thu Nov 22 14:51:06 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Thu Nov 22 14:51:16 2007
Subject: [Slony1-general] [Fwd: [Slony1-patches] Fix for PG8.3 beta3]
In-Reply-To: <60myt5gbhd.fsf@dba2.int.libertyrms.com> (Christopher Browne's
	message of "Thu, 22 Nov 2007 17:29:50 -0500")
References: <4745D616.8020509@postgresql.org>
	<60myt5gbhd.fsf@dba2.int.libertyrms.com>
Message-ID: <60ir3tgahx.fsf@dba2.int.libertyrms.com>

Christopher Browne <cbbrowne@ca.afilias.info> writes:
> Dave Page <dpage@postgresql.org> writes:
>> This didn't get any responses on -patches - is that list dead?
>
> I am taking a look at this now; I have a build ongoing right now of PG
> 8.3 HEAD, in order to validate that it's fixing something that's
> broken.
>
> Curiously, I suppose, I'm not seeing anything breaking right now
> without the patch.  But then, the PG 8.3 build I'm using is a couple
> weeks old; hopefully when I look at this tomorrow, with the newer
> build, I'll find a blow-up.
>
> It may wait to get completed until tomorrow.

... Or not.

http://www.slony.info/bugzilla/show_bug.cgi?id=16
-- 
select 'cbbrowne' || '@' || 'ca.afilias.info';
<http://dba2.int.libertyrms.com/>
Christopher Browne
(416) 673-4124 (land)
From postgres at dac.e4ward.com  Fri Nov 23 06:21:48 2007
From: postgres at dac.e4ward.com (postgres@dac.e4ward.com)
Date: Fri Nov 23 06:21:55 2007
Subject: [Slony1-general] Working on a Rails plugin to easy slony usage
Message-ID: <3373262511-3382@e4ward.com>

Hi all.

I want to know if anyone here has any experience using slony based
replication on Ruby on Rails applications.

As you may know (or not) there's a problem doing this because of
rails' applications using rails' migrations to version and change the
database schema. So rails applications deployment normally
automatically updates the database schema based on ruby script that
generates the required DDL statements.

On top of that, it's normal practice to add a column and inmediately
initialize existing records' values for that new column. So that makes
it impossible (or at least very difficult) to separate the process of
adding the new column via an slonik EXECUTE script and populating the
new field. The rails app would issue the DDL statement directly to the
master node and then update the new column data on existing records.
Slony wouldn't replicate the schema change, but will fail when trying
to replicate the new data to the slave nodes because of the new column
not existing there yet.

So... I've implemented a new Rails plugin that would detect CREATE,
DROP and ALTER statements just before they're issued to the master
node and simply synchronously delegate it's execution to an external
script passing all needed connection data AND the DDL statement as
parameters. That external DDL handler should return an exit status 0
on success. Any other exit status would cause the plugin to raise an
exception as expected by rails when the statement is invalid.

I've managed to use this to execute that DDL statements via psql and
slonik_execute_script | slonik.

Obviously this doesn't automate the process of creating new sets and
merging them in case of new tables being created. So if the rails
migration involves a new table the new table would be automatically
created in all nodes, but it's data will not replicate until you
manually tell slony to. But at least it doesn't fail.

I'd like to know if anyone has found a better way to do this. Or for
you guys that don't use slony with rails but have more experience on
slony, maybe you could suggest me an alternative.

I'm quite happy with the result.
I'll open source it in case there's interest.

Thank you
-- 
Diego Algorta Casamayou
http://www.oboxodo.com - http://diego.algorta.net
From postgres at dac.e4ward.com  Fri Nov 23 06:33:54 2007
From: postgres at dac.e4ward.com (postgres@dac.e4ward.com)
Date: Fri Nov 23 06:34:02 2007
Subject: [Slony1-general] Running Slonik from a server without Postgres
In-Reply-To: <3373204609-3502@e4ward.com>
References: <3373193336-3284@e4ward.com> <3373193652-2216@e4ward.com>
	<3373195204-1073@e4ward.com> <3373204609-3502@e4ward.com>
Message-ID: <3373263237-3519@e4ward.com>

On Nov 22, 2007 8:16 PM,  <slony1-general@lists.slony.info> wrote:
> <postgres@dac.e4ward.com> writes:
> > On Nov 22, 2007 5:14 PM,  <slony1-general@lists.slony.info> wrote:
> >> On 22/11/2007 19:08, postgres@dac.e4ward.com wrote:
> >> > documentation, but it seems slonik is always suposed to be installed
> >> > and run from the same server where postgres is installed.
> >>
> >> That's not my understanding....in particular, since connection strings
> >> passed to slon always include host and port fields, I don't see why they
> >> need to be on the same machine as the DB.
> >
> >
> > I understand that and in fact, as I said, I'm successfully running the
> > slave slon daemon from the master server, remotely. BUT I happen to
> > have postgres installed on that server too.
> >
> > My problem is not where to run slon, because I'm running it always
> > from servers where postgres is running too. My problem is to execute
> > slonik remotely from a server where I don't have neither postgres or
> > slon suning.
> >
> > Do I explain myself?
>
> Yes, you're explaining yourself...

Thank you :)

>
> You will have a difficult time running slonik on a host that doesn't
> have *any* of PostgreSQL running, because it will typically be
> dynamically linked to the PostgreSQL client library, libpq, and you
> will therefore need to have at least that part (libpq) of PostgreSQL
> installed.
>
> If your distribution has separate packages for:
> a) Server components (e.g. - postmaster)
> b) Libraries (e.g. - libpq)
> c) Client components (e.g. - psql, pg_dump, ...)
>
> then you could presumably avoid installing the server components and
> still be able to get Slony-I components to work.  I'd certainly want
> to have PostgreSQL "client components" like psql and pg_dump handy,
> though...

Yes. I though so...
I'm using a self-compiled postgres 8.1.10 on the db servers and the
app server from where I was looking to execute slonik has RPM
installed postgresql-libs 7.4.17. Ouch! :P

Anyway, I finally setted up automatic authentication from the app
server to the db servers via ssh public keys and made a script to
execute like this:

ssh -2 $USERNAME@$HOST <<-CMD
  /usr/local/pgsql/bin/slonik_execute_script -c "$SQL_COMMAND"
$REPLICATION_SET | /usr/local/pgsql/bin/slonik
CMD

And it works. Maybe a bit slower, but works and I have no need to
install postgres libs on the app server.
-- 
Diego Algorta Casamayou
http://www.oboxodo.com - http://diego.algorta.net
From postgres at dac.e4ward.com  Fri Nov 23 10:35:16 2007
From: postgres at dac.e4ward.com (postgres@dac.e4ward.com)
Date: Fri Nov 23 10:35:30 2007
Subject: [Slony1-general] Init script to start slon using the perl tools:
	slon_start
Message-ID: <3373277722-2497@e4ward.com>

Hi there.

I want to know if anyone has any "best practice" advice on this. I'm
wanting to make sure the slon process is run whenever I start the
server. Of course I'm preferring an standard init.d script, but I'd
like it to use slon_start instead of just slon.

I've compiled from sources so it didn't installed an init script
automatically. I've seen the included redhat/postgresql-slony1.init in
the source tree, but it relies directly on slon and I want to use
slon_start.

The best init-script I've seen so far is the one included with ubuntu
(don't know if it's the same in debian) because it handles both
alternatives. But I'd have to "translate" it to redhat style in case I
want to use that.

Anybody made its own start script or has a better way to do it?

-- 
Diego Algorta Casamayou
http://www.oboxodo.com - http://diego.algorta.net
From postgres at dac.e4ward.com  Fri Nov 23 11:00:56 2007
From: postgres at dac.e4ward.com (postgres@dac.e4ward.com)
Date: Fri Nov 23 11:01:05 2007
Subject: [Slony1-general] Syncing slon_tools.conf
Message-ID: <3373279257-2230@e4ward.com>

Hi all.

By the way, I know I'm asking too many questions in different mails.
:-D But I thought it would be better this way to separate concerns.

So I have this 2 nodes in two different servers. They're correctly
replicating by means of 2 slon processes started and running both from
the server where the master node is.

So if I want to be prepared for the master node to "die" and make a
failover to the slave, this are the questions that come to my mind:

* I'll have to keep slon_tools.conf in sync in both servers so if
someday I add a new table/sequence/set, it would be available on the
failover server. What are you guys using for this? a shared mounted
resource, like NFS or someting? Syncing by hand? Not syncing at all?
* I know I have more questions... just forgot some. :-/

Thank you.
-- 
Diego Algorta Casamayou
http://www.oboxodo.com - http://diego.algorta.net
From ajs at crankycanuck.ca  Fri Nov 23 11:16:31 2007
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Fri Nov 23 11:16:51 2007
Subject: [Slony1-general] Syncing slon_tools.conf
In-Reply-To: <3373279257-2230@e4ward.com>
References: <3373279257-2230@e4ward.com>
Message-ID: <20071123191631.GN29421@crankycanuck.ca>

On Fri, Nov 23, 2007 at 05:00:56PM -0200, postgres@dac.e4ward.com wrote:
> * I'll have to keep slon_tools.conf in sync in both servers so if
> someday I add a new table/sequence/set, it would be available on the
> failover server. What are you guys using for this? a shared mounted
> resource, like NFS or someting? Syncing by hand? Not syncing at all?

Presumably, it's not going to change that often.  One way I like to make
those kinds of changes is to make a change somewhere, check it into source
control, and then check it out on all target machines.  This has the happy
effect as well that you automatically get a history of your changes, and you
can roll them back very easily.

A

-- 
Andrew Sullivan
Old sigs will return after re-constitution of blue smoke
From david at fetter.org  Sat Nov 24 11:15:58 2007
From: david at fetter.org (David Fetter)
Date: Sat Nov 24 11:16:05 2007
Subject: [Slony1-general] Working on a Rails plugin to easy slony usage
In-Reply-To: <3373262511-3382@e4ward.com>
References: <3373262511-3382@e4ward.com>
Message-ID: <20071124191558.GE15871@fetter.org>

On Fri, Nov 23, 2007 at 12:21:48PM -0200, postgres@dac.e4ward.com wrote:
> Hi all.
> 
> I want to know if anyone here has any experience using slony based
> replication on Ruby on Rails applications.

Dump Rails.  It's a piece of crap.

Cheers,
David (no, that is not a joke)
-- 
David Fetter <david@fetter.org> http://fetter.org/
Phone: +1 415 235 3778  AIM: dfetter666  Yahoo!: dfetter
Skype: davidfetter      XMPP: david.fetter@gmail.com

Remember to vote!
Consider donating to Postgres: http://www.postgresql.org/about/donate
From postgres at dac.e4ward.com  Sat Nov 24 17:31:15 2007
From: postgres at dac.e4ward.com (postgres@dac.e4ward.com)
Date: Sat Nov 24 17:31:30 2007
Subject: [Slony1-general] Working on a Rails plugin to easy slony usage
In-Reply-To: <3373366559-428@e4ward.com>
References: <3373262511-3382@e4ward.com> <3373366559-428@e4ward.com>
Message-ID: <3373389076-265@e4ward.com>

On Nov 24, 2007 5:15 PM,  <slony1-general@lists.slony.info> wrote:
> On Fri, Nov 23, 2007 at 12:21:48PM -0200, postgres@dac.e4ward.com wrote:
> > Hi all.
> >
> > I want to know if anyone here has any experience using slony based
> > replication on Ruby on Rails applications.
>
> Dump Rails.  It's a piece of crap.
>
> Cheers,
> David (no, that is not a joke)

Well... I know it has some things to improve and such... like any
piece of software. But maybe I and other's using it deserve the right
to know why you're saying that without explaining your reasons.
Specially when you use such a "superiority" tone.

Anyway... suppose I don't have the choice (which I have) and have to
work with rails + slony. Could you provide an opinion other than drop
rails?

Thank you.
-- 
Diego Algorta Casamayou
http://www.oboxodo.com - http://diego.algorta.net
From ssinger_pg at sympatico.ca  Sat Nov 24 19:33:47 2007
From: ssinger_pg at sympatico.ca (Steve Singer)
Date: Sat Nov 24 19:34:04 2007
Subject: [Slony1-general] Working on a Rails plugin to easy slony usage
In-Reply-To: <3373389076-265@e4ward.com>
References: <3373262511-3382@e4ward.com> <3373366559-428@e4ward.com>
	<3373389076-265@e4ward.com>
Message-ID: <BAYC1-PASMTP03F4A112863E8425AE39C5AC740@CEZ.ICE>

On Sat, 24 Nov 2007 postgres@dac.e4ward.com wrote:

> Anyway... suppose I don't have the choice (which I have) and have to
> work with rails + slony. Could you provide an opinion other than drop
> rails?

You could use rails but not use the rake migrations for schema updates and 
handle them manually.

I've also seen places where before they have to make a DDL change they just 
uninstall slony, make the DDL change using normal DDL on the master then 
reinstall slony and rebuild the slave.  This only works if your dataset is 
small enough that it can be copied to the slave in a 'reasonable' amount of 
time.

If you do go the route of having your migration driver redirect to a shell 
script that calls EXECUTE SCRIPT you might be able to write a program that 
detects any non-replicated tables creates a new set, adds the tables, 
replicates the data and merges the set.  I wouldn't rush ahead and make DDL 
changes in the cluster too transparent or automated, I think building steps 
into the process where DBA has to look at the schema changes and stop to 
think about their impact is a good thing.

You would want to be aware of slony locking behaviors with each of these 
approaches.


Steve

> Thank you.
> -- 
> Diego Algorta Casamayou
> http://www.oboxodo.com - http://diego.algorta.net
> _______________________________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
>

From JanWieck at Yahoo.com  Sun Nov 25 17:10:59 2007
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Sun Nov 25 21:07:49 2007
Subject: [Slony1-general] Patch to have a defined table lock order
In-Reply-To: <20071121233542.C2BA1116593E@zeus.directinfos.com>
References: <20071121233542.C2BA1116593E@zeus.directinfos.com>
Message-ID: <474A1D23.9030504@Yahoo.com>

On 11/21/2007 6:35 PM, Jacques Caron wrote:
> Hi,
> 
> The following patch adds a new column to sl_table: tab_lock_order, 
> and modifies the order in which tables are locked during all calls 
> that require extensive locking (i.e. all those that call 
> alterTableForReplication or alterTableRestore on a set of tables): 
> they are locked in coalesce(tab_lock_order,0),tab_id order rather 
> than random order or just tab_id order.

This is a very good idea and I certainly appreciate the patch. The 
problem is that as the Postgres main project, the Slony team is rather 
reluctant to accept new functionality into existing stable branches.

I do see how this change is entirely backwards compatible. But we'd 
definitely need a broad consensus on this.


Thanks again,
Jan


> 
> This means that by default (tab_lock_order null for all tables), they 
> are locked in tab_id order (in all those calls rather than just some 
> of them), but the order can be overridden by setting tab_lock_order 
> appropriately (this allow reordering the locks, as tab_id's cannot be 
> easily changed).
> 
> Alternatives would be to set tab_lock_order's default value to be 
> tab_id (+ not null and maybe unique + remove coalesce and maybe 
> tab_id from order by), or to order by coalesce(tab_lock_order,tab_id).
> 
> Note that I'm not sure the schema upgrade is the "right way" to do 
> it, maybe add_missing_table_field() should be used for this, and 
> obviously the schema version needed to be bumped up, not sure what 
> the best practice is for that?
> 
> Comments welcome,
> 
> Jacques.
> 
> --- slony1-1.2.12.orig/src/backend/slony1_funcs.sql     Mon Oct 22 
> 17:19:50 2007
> +++ slony1-1.2.12/src/backend/slony1_funcs.sql  Thu Nov 22 00:19:29 2007
> @@ -430,7 +430,7 @@
>   returns int4
>   as '
>   begin
> -       return 12;
> +       return 13;
>   end;
>   ' language plpgsql;
>   comment on function @NAMESPACE@.slonyVersionPatchlevel () is
> @@ -1219,6 +1219,7 @@
>                          if p_backup_node = 
> @NAMESPACE@.getLocalNodeId(''_@CLUSTERNAME@'') then
>                                  for v_row2 in select * from 
> @NAMESPACE@.sl_table
>                                                  where tab_set = v_row.set_id
> +                                               order by 
> coalesce(tab_lock_order,0),tab_id
>                                  loop
>                                          perform 
> @NAMESPACE@.alterTableRestore(v_row2.tab_id);
>                                  end loop;
> @@ -1231,6 +1232,7 @@
> 
>                                  for v_row2 in select * from 
> @NAMESPACE@.sl_table
>                                                  where tab_set = v_row.set_id
> +                                               order by 
> coalesce(tab_lock_order,0),tab_id
>                                  loop
>                                          perform 
> @NAMESPACE@.alterTableForReplication(v_row2.tab_id);
>                                  end loop;
> @@ -1380,6 +1382,7 @@
>          if p_backup_node = @NAMESPACE@.getLocalNodeId(''_@CLUSTERNAME@'') then
>                  for v_row in select * from @NAMESPACE@.sl_table
>                                  where tab_set = p_set_id
> +                               order by coalesce(tab_lock_order,0),tab_id
>                  loop
>                          perform @NAMESPACE@.alterTableRestore(v_row.tab_id);
>                  end loop;
> @@ -1395,6 +1398,7 @@
> 
>                  for v_row in select * from @NAMESPACE@.sl_table
>                                  where tab_set = p_set_id
> +                               order by coalesce(tab_lock_order,0),tab_id
>                  loop
>                          perform 
> @NAMESPACE@.alterTableForReplication(v_row.tab_id);
>                  end loop;
> @@ -1484,7 +1488,7 @@
>          -- This is us ... time for suicide! Restore all tables to
>          -- their original status.
>          -- ----
> -       for v_tab_row in select * from @NAMESPACE@.sl_table loop
> +       for v_tab_row in select * from @NAMESPACE@.sl_table order by 
> coalesce(tab_lock_order,0),tab_id loop
>                  perform @NAMESPACE@.alterTableRestore(v_tab_row.tab_id);
>                  perform @NAMESPACE@.tableDropKey(v_tab_row.tab_id);
>          end loop;
> @@ -1984,7 +1988,7 @@
>                          where T.tab_set = p_set_id
>                                  and T.tab_reloid = PGC.oid
>                                  and PGC.relnamespace = PGN.oid
> -                       order by tab_id
> +                       order by coalesce(tab_lock_order,0),tab_id
>          loop
>                  execute ''create trigger "_@CLUSTERNAME@_lockedset_'' ||
>                                  v_tab_row.tab_id ||
> @@ -2060,7 +2064,7 @@
>                          where T.tab_set = p_set_id
>                                  and T.tab_reloid = PGC.oid
>                                  and PGC.relnamespace = PGN.oid
> -                       order by tab_id
> +                       order by coalesce(tab_lock_order,0),tab_id
>          loop
>                  execute ''drop trigger "_@CLUSTERNAME@_lockedset_'' ||
>                                  v_tab_row.tab_id || ''" on '' || 
> v_tab_row.tab_fqname;
> @@ -2214,7 +2218,7 @@
>          if v_local_node_id = p_old_origin or v_local_node_id = 
> p_new_origin then
>                  for v_tab_row in select tab_id from @NAMESPACE@.sl_table
>                                  where tab_set = p_set_id
> -                               order by tab_id
> +                               order by coalesce(tab_lock_order,0),tab_id
>                  loop
>                          perform 
> @NAMESPACE@.alterTableRestore(v_tab_row.tab_id);
>                  end loop;
> @@ -2362,7 +2366,7 @@
>          if v_local_node_id = p_old_origin or v_local_node_id = 
> p_new_origin then
>                  for v_tab_row in select tab_id from @NAMESPACE@.sl_table
>                                  where tab_set = p_set_id
> -                               order by tab_id
> +                               order by coalesce(tab_lock_order,0),tab_id
>                  loop
>                          perform 
> @NAMESPACE@.alterTableForReplication(v_tab_row.tab_id);
>                  end loop;
> @@ -2441,7 +2445,7 @@
>          -- ----
>          for v_tab_row in select tab_id from @NAMESPACE@.sl_table
>                          where tab_set = p_set_id
> -                       order by tab_id
> +                       order by coalesce(tab_lock_order,0),tab_id
>          loop
>                  perform @NAMESPACE@.alterTableRestore(v_tab_row.tab_id);
>                  perform @NAMESPACE@.tableDropKey(v_tab_row.tab_id);
> @@ -3711,12 +3715,12 @@
>                  -- Create a SYNC event, run the script and generate 
> the DDL_SCRIPT event
>                  -- ----
>                  perform @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', 
> ''SYNC'', NULL);
> -               perform @NAMESPACE@.alterTableRestore(tab_id) from 
> @NAMESPACE@.sl_table where tab_set in (select set_id from 
> @NAMESPACE@.sl_set where set_origin = 
> @NAMESPACE@.getLocalNodeId(''_@CLUSTERNAME@''));
> +               perform @NAMESPACE@.alterTableRestore(tab_id) from 
> @NAMESPACE@.sl_table where tab_set in (select set_id from 
> @NAMESPACE@.sl_set where set_origin = 
> @NAMESPACE@.getLocalNodeId(''_@CLUSTERNAME@'')) order by 
> coalesce(tab_lock_order,0),tab_id;
>          else
>                  -- ----
>                  -- If doing "only on one node" - restore ALL tables 
> irrespective of set
>                  -- ----
> -               perform @NAMESPACE@.alterTableRestore(tab_id) from 
> @NAMESPACE@.sl_table;
> +               perform @NAMESPACE@.alterTableRestore(tab_id) from 
> @NAMESPACE@.sl_table order by coalesce(tab_lock_order,0),tab_id;
>          end if;
>          return 1;
>   end;
> @@ -3743,12 +3747,12 @@
>   begin
>          perform @NAMESPACE@.updateRelname(p_set_id, p_only_on_node);
>          if p_only_on_node = -1 then
> -               perform @NAMESPACE@.alterTableForReplication(tab_id) 
> from @NAMESPACE@.sl_table where tab_set in (select set_id from 
> @NAMESPACE@.sl_set where set_origin = 
> @NAMESPACE@.getLocalNodeId(''_@CLUSTERNAME@''));
> +               perform @NAMESPACE@.alterTableForReplication(tab_id) 
> from @NAMESPACE@.sl_table where tab_set in (select set_id from 
> @NAMESPACE@.sl_set where set_origin = 
> @NAMESPACE@.getLocalNodeId(''_@CLUSTERNAME@'')) order by 
> coalesce(tab_lock_order,0),tab_id;
> 
>                  return  @NAMESPACE@.createEvent(''_@CLUSTERNAME@'', 
> ''DDL_SCRIPT'',
>                          p_set_id::text, p_script::text, p_only_on_node::text);
>          else
> -               perform @NAMESPACE@.alterTableForReplication(tab_id) 
> from @NAMESPACE@.sl_table;
> +               perform @NAMESPACE@.alterTableForReplication(tab_id) 
> from @NAMESPACE@.sl_table order by coalesce(tab_lock_order,0),tab_id;
>          end if;
>          return NULL;
>   end;
> @@ -3812,7 +3816,7 @@
>          -- ----
>          -- Restore all original triggers and rules of all sets
>          -- ----
> -       for v_row in select * from @NAMESPACE@.sl_table
> +       for v_row in select * from @NAMESPACE@.sl_table order by 
> coalesce(tab_lock_order,0),tab_id
>          loop
>                  perform @NAMESPACE@.alterTableRestore(v_row.tab_id);
>          end loop;
> @@ -3843,7 +3847,7 @@
>          -- ----
>          -- Put all tables back into replicated mode
>          -- ----
> -       for v_row in select * from @NAMESPACE@.sl_table
> +       for v_row in select * from @NAMESPACE@.sl_table order by 
> coalesce(tab_lock_order,0),tab_id
>          loop
>                  perform @NAMESPACE@.alterTableForReplication(v_row.tab_id);
>          end loop;
> @@ -4363,7 +4367,7 @@
>          -- ----
>          for v_tab_row in select tab_id from @NAMESPACE@.sl_table
>                          where tab_set = p_sub_set
> -                       order by tab_id
> +                       order by coalesce(tab_lock_order,0),tab_id
>          loop
>                  perform @NAMESPACE@.alterTableRestore(v_tab_row.tab_id);
>                  perform @NAMESPACE@.tableDropKey(v_tab_row.tab_id);
> @@ -5912,6 +5921,14 @@
>                                          ) without oids'';
>                  execute ''insert into @NAMESPACE@.sl_archive_counter
>                                          (ac_num, ac_timestamp) 
> values (0, ''''epoch''''::timestamp)'';
> +       end if;
> +
> +       -- ----
> +       -- Changes for 1.2.13
> +       -- ----
> +       if p_old IN (''1.0.2'', ''1.0.5'', ''1.0.6'', ''1.1.0'', 
> ''1.1.1'', ''1.1.2'', ''1.1.3'',''1.1.5'', ''1.1.6'', ''1.1.7'', 
> ''1.1.8'', ''1.1.9'', ''1.2.0'', ''1.2.1'', ''1.2.2'', ''1.2.3'', 
> ''1.2.4'', ''1.2.5'', ''1.2.6'', ''1.2.7'', ''1.2.8'', ''1.2.9'', 
> ''1.2.10'', ''1.2.11'', ''1.2.12'') then
> +               -- Add new column sl_table.tab_lock_order
> +               execute ''alter table @NAMESPACE@.sl_table add column 
> tab_lock_order integer'';
>          end if;
> 
>          -- In any version, make sure that the xxidin() functions are 
> defined STRICT
> 
> _______________________________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


-- 
#======================================================================#
# It's easier to get forgiveness for being wrong than for being right. #
# Let's break this rule - forgive me.                                  #
#================================================== JanWieck@Yahoo.com #
From cbbrowne at ca.afilias.info  Mon Nov 26 07:55:51 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Mon Nov 26 07:55:58 2007
Subject: [Slony1-general] Patch to have a defined table lock order
In-Reply-To: <474A1D23.9030504@Yahoo.com> (Jan Wieck's message of "Sun,
	25 Nov 2007 20:10:59 -0500")
References: <20071121233542.C2BA1116593E@zeus.directinfos.com>
	<474A1D23.9030504@Yahoo.com>
Message-ID: <60y7cldmrc.fsf@dba2.int.libertyrms.com>

Jan Wieck <JanWieck@Yahoo.com> writes:
> On 11/21/2007 6:35 PM, Jacques Caron wrote:
>> Hi,
>> The following patch adds a new column to sl_table: tab_lock_order,
>> and modifies the order in which tables are locked during all calls
>> that require extensive locking (i.e. all those that call
>> alterTableForReplication or alterTableRestore on a set of tables):
>> they are locked in coalesce(tab_lock_order,0),tab_id order rather
>> than random order or just tab_id order.
>
> This is a very good idea and I certainly appreciate the patch. The
> problem is that as the Postgres main project, the Slony team is rather
> reluctant to accept new functionality into existing stable branches.
>
> I do see how this change is entirely backwards compatible. But we'd
> definitely need a broad consensus on this.

I agree; I think it's an interesting "possible feature," and that it
might be a good one to put in CVS HEAD.

I also think it would be a necessary thing to, *before* adding it,
have an outline of a test case where it allows things to work where,
at present, things are broken.

The downside to it, as I see it, is that it adds a fair bit of
additional complexity when we don't have clear cases (heading back to
the "test case" thing) where it is known to help.

My sense is that this may be fixing a really narrow problem, and it
would be unfortunate to add the fair bit of complexity to the codebase
to solve a truly rare problem.  I may be wrong; that's why "broad
consensus" represents more than just two opinions :-).
-- 
(format nil "~S@~S" "cbbrowne" "cbbrowne.com")
http://www3.sympatico.ca/cbbrowne/nonrdbms.html
"Suppose  you  were  an  idiot.   And  suppose you  were  a  member  of
Congress. But I repeat myself."  -- Mark Twain
From cbbrowne at ca.afilias.info  Mon Nov 26 08:30:20 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Mon Nov 26 08:30:27 2007
Subject: [Slony1-general] Patch for shorter attkind
In-Reply-To: <20071121162846.ED79B1165966@zeus.directinfos.com> (Jacques
	Caron's message of "Wed, 21 Nov 2007 17:28:34 +0100")
References: <20071121162846.ED79B1165966@zeus.directinfos.com>
Message-ID: <60abp1dl5v.fsf@dba2.int.libertyrms.com>

Jacques Caron <jc@oxado.com> writes:
> Hi,
>
> The following very quick patch (against 1.2.12) provides the following changes:
> - when scanning attributes looking for key columns (in UPDATEs and
> DELETEs), stop when we reach the end of the attkind string
> - when creating the triggers, final "v"s are stripped
>
> Result:
> - one can add columns (without defaults, constraints, etc.) to tables
> (destinations first, origin last) without changing the logtrigger and
> without using EXECUTE SCRIPT
> - as a bonus we save a few cycles in updates and deletes
>
> Comments welcome!
>
> Jacque.
>
> --- src/backend/slony1_funcs.c.orig Wed Nov 21 15:43:24 2007
> +++ src/backend/slony1_funcs.c      Wed Nov 21 15:45:13 2007
> @@ -821,6 +821,8 @@
>                                 continue;
>
>                         attkind_idx++;
> +                       if (!attkind[attkind_idx])
> +                               break;
>                         if (attkind[attkind_idx] != 'k')
>                                 continue;
>                         col_ident = (char
> *)slon_quote_identifier(SPI_fname(tupdesc, i + 1));
> @@ -888,6 +890,8 @@
>                                 continue;
>
>                         attkind_idx++;
> +                       if (!attkind[attkind_idx])
> +                               break;
>                         if (attkind[attkind_idx] != 'k')
>                                 continue;
>                         col_ident = (char
> *)slon_quote_identifier(SPI_fname(tupdesc, i + 1));
> --- src/backend/slony1_funcs.sql.orig       Wed Nov 21 15:45:35 2007
> +++ src/backend/slony1_funcs.sql    Wed Nov 21 15:53:11 2007
> @@ -5029,6 +5029,11 @@
>         end loop;
>
>         --
> +       -- Strip final 'v's as these are not needed by the logtrigger
> +       --
> +       v_attkind := regexp_replace(v_attkind,''v*$'','''');
> +
> +       --
>         -- Return the resulting attkind
>         --
>         return v_attkind;

I would be super-disinclined to put this into the 1.2 branch, because:

a) 1.2 is the "stable" branch, and adding new functionality isn't
   proper for that, anymore

b) Once the next version gets out, I want to be able to at least *think*
   about deprecating 1.2, as opposed to having new features in 1.2 that
   will continue to need support

Could you redirect this to CVS HEAD?  I'd be much more comfortable
discussing the change in that context.

I may still have some objections then, but I'd be happier discussing
it in the context of future releases...

As with the other discussion, I think it would be really useful to
have, already framed, some sort of test scenario where we know this
will fix problems that the "old way" was known to handle wrong.

Having that makes it a lot more clear whether:
  a) This is actually an improvement or not, and
  b) The problem is one that appears worth fixing.

At first glance, neither a) nor b) are presently *obviously* the case.
-- 
(format nil "~S@~S" "cbbrowne" "linuxdatabases.info")
http://linuxfinances.info/info/unix.html
"In man-machine symbiosis, it is man who must adjust: The machines
can't." -- Alan J. Perlis
From jc at oxado.com  Mon Nov 26 08:35:30 2007
From: jc at oxado.com (Jacques Caron)
Date: Mon Nov 26 08:37:56 2007
Subject: [Slony1-general] Patch to have a defined table lock order
In-Reply-To: <60y7cldmrc.fsf@dba2.int.libertyrms.com>
References: <20071121233542.C2BA1116593E@zeus.directinfos.com>
	<474A1D23.9030504@Yahoo.com>
	<60y7cldmrc.fsf@dba2.int.libertyrms.com>
Message-ID: <20071126163752.51D71116595D@zeus.directinfos.com>

At 16:55 26/11/2007, Christopher Browne wrote:
>I also think it would be a necessary thing to, *before* adding it,
>have an outline of a test case where it allows things to work where,
>at present, things are broken.

At the moment, locking order is purely random in many cases (in the 
"EXECUTE SCRIPT" case in particular), as there is no ORDER BY clause 
whatsoever. And since it takes a very a heavy-duty lock on all 
tables, anything doing a select on two or more tables while the locks 
are being taken has a 50% chance of generating a deadlock.

A simple test case is probably: define a set with two tables and a 
few lines in each, replicate them, run two scripts that continuously 
do "BEGIN; SELECT * FROM table1; SELECT * FROM table2; COMMIT" and 
"BEGIN; SELECT * FROM table2; SELECT * FROM table1; COMMIT", and 
attempt an EXECUTE SCRIPT to add a column to table1. Repeat until it 
fails. If you don't get a deadlock at some point you're pretty darn 
lucky (or I'm pretty much unlucky, and so are a few other people who 
posted the same kind of issues on the list).

The patch only makes the order be at least defined (tab_id), or 
user-definable (tab_lock_order), so that one can control it, and make 
sure it is compatible with the applications lock order (the above 
test would still fail, but the two selects in reverse order are just 
there because one can't know which of the two orders fails: only one 
is actually needed to generate the deadlock).

>The downside to it, as I see it, is that it adds a fair bit of
>additional complexity when we don't have clear cases (heading back to
>the "test case" thing) where it is known to help.

I'm not sure I understand how a bunch of "ORDER BY"s in existing 
queries represent "a fair bit of additional complexity"?

>My sense is that this may be fixing a really narrow problem, and it
>would be unfortunate to add the fair bit of complexity to the codebase
>to solve a truly rare problem.  I may be wrong; that's why "broad
>consensus" represents more than just two opinions :-).

I think anyone who has attempted to use EXECUTE SCRIPT on a fairly 
busy database (even if read-only) can testify that it's not an easy task.

One thing that would actually add more complexity, but would probably 
be quite useful: add options to EXECUTE SCRIPT to only lock (and 
un-trigger/re-trigger) specific tables (i.e. the ones that are 
actually affected, but manually specified in the options of EXECUTE 
SCRIPT). No sense locking everybody, removing and restoring trigger 
all over the place, if you only change one table with no side effects 
(no constraints, triggers, etc.).

As I understand it, the real issue is just that HEAD is geared 
towards Postgresql 8.3 which has some feature that allows slony to be 
"more intelligent" regarding how schema updates are performed (though 
I haven't quite looked at how this is done yet, I really should), and 
Jan just is a bit concerned about changing the current release branch 
which he considers "stable" and hence should not get additional features.

My concern is that I feel Postgresql 8.3 is still weeks/months away 
from being stable enough to put in critical production environments 
(those where you actually need Slony), and that not doing any further 
developments other than bug fixes in the current release branch may 
be problematic for many people in the same situation.

Also, I consider adding missing "order by"s a bug fix rather than a 
new feature :-)

Jacques.

From cbbrowne at ca.afilias.info  Mon Nov 26 09:31:04 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Mon Nov 26 09:31:13 2007
Subject: [Slony1-general] Patch to have a defined table lock order
In-Reply-To: <20071126163752.51D71116595D@zeus.directinfos.com> (Jacques
	Caron's message of "Mon, 26 Nov 2007 17:35:30 +0100")
References: <20071121233542.C2BA1116593E@zeus.directinfos.com>
	<474A1D23.9030504@Yahoo.com> <60y7cldmrc.fsf@dba2.int.libertyrms.com>
	<20071126163752.51D71116595D@zeus.directinfos.com>
Message-ID: <6063zoewx3.fsf@dba2.int.libertyrms.com>

Jacques Caron <jc@oxado.com> writes:
> At 16:55 26/11/2007, Christopher Browne wrote:
>>I also think it would be a necessary thing to, *before* adding it,
>>have an outline of a test case where it allows things to work where,
>>at present, things are broken.
>
> At the moment, locking order is purely random in many cases (in the
> "EXECUTE SCRIPT" case in particular), as there is no ORDER BY clause
> whatsoever. And since it takes a very a heavy-duty lock on all tables,
> anything doing a select on two or more tables while the locks are
> being taken has a 50% chance of generating a deadlock.

I changed this in CVS HEAD last month; I had indeed noticed the
absence of an ORDER BY clause...

http://lists.slony.info/pipermail/slony1-commit/2007-October/002059.html

http://main.slony.info/viewcvs/viewvc.cgi/slony1-engine/src/backend/slony1_funcs.sql?r1=1.121&r2=1.122

> A simple test case is probably: define a set with two tables and a few
> lines in each, replicate them, run two scripts that continuously do
> "BEGIN; SELECT * FROM table1; SELECT * FROM table2; COMMIT" and
> "BEGIN; SELECT * FROM table2; SELECT * FROM table1; COMMIT", and
> attempt an EXECUTE SCRIPT to add a column to table1. Repeat until it
> fails. If you don't get a deadlock at some point you're pretty darn
> lucky (or I'm pretty much unlucky, and so are a few other people who
> posted the same kind of issues on the list).
>
> The patch only makes the order be at least defined (tab_id), or
> user-definable (tab_lock_order), so that one can control it, and make
> sure it is compatible with the applications lock order (the above test
> would still fail, but the two selects in reverse order are just there
> because one can't know which of the two orders fails: only one is
> actually needed to generate the deadlock).

I have no disagreements with this...

>>The downside to it, as I see it, is that it adds a fair bit of
>>additional complexity when we don't have clear cases (heading back to
>>the "test case" thing) where it is known to help.
>
> I'm not sure I understand how a bunch of "ORDER BY"s in existing
> queries represent "a fair bit of additional complexity"?

Ah, but the thing is, the patch is only about 1/3 done, possibly less
than that.

-> The new column needs to be added to src/backend/slony1_base.sql so
   that a new instance gets created with the new column.

-> It's not obvious how this column is supposed to get configured.
   We presumably need to extend the slonik grammar to accomodate it in
   STORE TABLE.

-> There isn't any existing Slonik command to *alter* table
   configuration; at present, there isn't anything meaningful to do
   manipulate a table once it is replicating aside from moving the
   table from one set to another.  This seems to require a new command
   altogether.

-> It may be arguable that this could be manipulated totally via
   hand-crafted SQL, and therefore no modifications to Slonik are
   necessary.

-> Documentation?

   How the facility is intended to be used needs to be documented
   somewhere.

To some degree, I'm nit-picking on the src/backend/slony1_base.sql
part, but we can't just let half-done things into the code base.
Features do have to be sufficiently complete.  That's part of where
"peer review" comes in; the above 5 things are 5 places where I see
something missing that may be necessary.

- This is a "user-serviced" set of functionality, so we definitely do
  need to expose the functionality to users.  Gotta figure out how.

- We need to figure out whether slonik changes are necessary or not.

- And the functionality won't be visible to users until it is added to
  documentation.  I'll be "anal retentive" and claim that it's not
  done until it's documented.

>>My sense is that this may be fixing a really narrow problem, and it
>>would be unfortunate to add the fair bit of complexity to the codebase
>>to solve a truly rare problem.  I may be wrong; that's why "broad
>>consensus" represents more than just two opinions :-).
>
> I think anyone who has attempted to use EXECUTE SCRIPT on a fairly
> busy database (even if read-only) can testify that it's not an easy
> task.
>
> One thing that would actually add more complexity, but would probably
> be quite useful: add options to EXECUTE SCRIPT to only lock (and
> un-trigger/re-trigger) specific tables (i.e. the ones that are
> actually affected, but manually specified in the options of EXECUTE
> SCRIPT). No sense locking everybody, removing and restoring trigger
> all over the place, if you only change one table with no side effects
> (no constraints, triggers, etc.).

It would be a plenty interesting idea to try to make EXECUTE SCRIPT
'more intelligent' so that you could configure it to only lock/modify
those tables that need modifying.  Unfortunately, I'm not at all sure
how to describe this "intelligence," and getting from that to a usable
way of describing the necessary configuration.

The *real* answer to this is the move to PostgreSQL 8.3, with "Slony-I
CVS HEAD / Version 2," because it eliminates the need for EXECUTE
SCRIPT to drop/re-add the replication triggers.

Yes, that predicates a migration to PG 8.3, but in the absence of a
specific description of the EXECUTE SCRIPT options, it is not at all
obvious that getting to a "smart enough Slony-I" will be ready sooner
than getting to the "new, better way of Slony-I 2.0 + PG 8.3."

I don't have a good model in mind yet as to how to describe how to
control this "less-locking EXECUTE SCRIPT;" by the time we get there,
it may be way simpler to just say "let's migrate to 8.3 + 2.0."

> As I understand it, the real issue is just that HEAD is geared towards
> Postgresql 8.3 which has some feature that allows slony to be "more
> intelligent" regarding how schema updates are performed (though I
> haven't quite looked at how this is done yet, I really should), and
> Jan just is a bit concerned about changing the current release branch
> which he considers "stable" and hence should not get additional
> features.
>
> My concern is that I feel Postgresql 8.3 is still weeks/months away
> from being stable enough to put in critical production environments
> (those where you actually need Slony), and that not doing any further
> developments other than bug fixes in the current release branch may be
> problematic for many people in the same situation.

> Also, I consider adding missing "order by"s a bug fix rather than a
> new feature :-)

If you think so, then I'd call that an argument in favor of my
applying the following to the 1.2 branch...

<http://lists.slony.info/pipermail/slony1-commit/2007-October/002059.html>

I'd certainly be prepared to go that far in 1.2 :-).
-- 
let name="cbbrowne" and tld="linuxfinances.info" in String.concat "@" [name;tld];;
http://linuxfinances.info/info/sap.html
There are no "civil aviation for  dummies" books out there and most of
you would probably  be scared and spend a lot of  your time looking up
if there was one. :-) -- Jordan Hubbard in c.u.b.f.m
From ssinger_pg at sympatico.ca  Mon Nov 26 17:23:53 2007
From: ssinger_pg at sympatico.ca (Steve Singer)
Date: Mon Nov 26 17:24:11 2007
Subject: [Slony1-general] Patch to have a defined table lock order
In-Reply-To: <20071126163752.51D71116595D@zeus.directinfos.com>
References: <20071121233542.C2BA1116593E@zeus.directinfos.com>
	<474A1D23.9030504@Yahoo.com> <60y7cldmrc.fsf@dba2.int.libertyrms.com>
	<20071126163752.51D71116595D@zeus.directinfos.com>
Message-ID: <BAYC1-PASMTP086FC2AFC1A8D76095CEDFAC760@CEZ.ICE>

On Mon, 26 Nov 2007, Jacques Caron wrote:


> One thing that would actually add more complexity, but would probably be 
> quite useful: add options to EXECUTE SCRIPT to only lock (and 
> un-trigger/re-trigger) specific tables (i.e. the ones that are actually 
> affected, but manually specified in the options of EXECUTE SCRIPT). No sense 
> locking everybody, removing and restoring trigger all over the place, if you 
> only change one table with no side effects (no constraints, triggers, etc.).

I had submitted patches for this against the CVS HEAD about 11 months ago
http://lists.slony.info/pipermail/slony1-general/2006-December/005537.html
including documentation updates.  It was eventually declined because with 
8.3 it won't be needed. I doubt it would be hard for you to merge these 
into the current 1.2 branch for your own build but I'm in the school that 
frowns on adding new features in updates that only effect the third version 
number (ie 1.2.12 to 1.2.13).

I'm not sure what other features are sitting on CVS head, maybe in 
retrospect a 1.3 release that supported pre 8.3 back-ends would have been 
useful 6 months ago.  Now that 8.3 is almost out the door I don't think 
that's an efficient use of time.  I suspect most sites that are prepared to 
upgrade to a slony 1.3 would also be prepared to upgrade the back-end to 8.3 
(upgrade adverse sites won't take either)


Steve

>
> Jacques.
>
> _______________________________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
>

From pshem.k at gmail.com  Mon Nov 26 18:01:00 2007
From: pshem.k at gmail.com (Pshem Kowalczyk)
Date: Mon Nov 26 18:01:14 2007
Subject: [Slony1-general] Manually removing stuff from sl_log_1
Message-ID: <20fe625b0711261801n294439dmef8845aeeaf28f52@mail.gmail.com>

Hi All,

Some time ago I drop a table from replication. I can see that all
entries referring to table 24 (the one that we dropped)  disappeared
from sl_log_2, but in the sl_log_1 there are still almost 2 milion
rows referring table 24 (table was receiving updates/inserts up to 40
rows a sec).

Is it safe to remove those rows manually from the log, or should I
wait longer (it's been about 5h since we did the change)?

kind regards
Pshem
From rlandrum at aol.net  Tue Nov 27 13:08:05 2007
From: rlandrum at aol.net (Robert Landrum)
Date: Tue Nov 27 13:08:16 2007
Subject: [Slony1-general] A Best Practices Question
Message-ID: <474C8735.3070109@aol.net>

We have several hundred tables in our DB and all should be replicated. 
Keeping the slon tools config file up to date is a bit of a worry for 
me.  I thought that running the following sql inside the config file 
made the most sense, but wanted to get some consensus on how everyone 
manages their configs...

     SELECT
       relname
     FROM
       pg_class
     WHERE
       relkind = 'r' and
       relhaspkey is true and
       relowner = (select usesysid from pg_user where usename = 'foobar')
     ORDER BY
       relname

A similar query is set to be run for sequences.  I have only sequences 
and pkey'd tables.

Does this make sense?  Are there any pitfalls or caveats?

Rob
From pshem.k at gmail.com  Tue Nov 27 16:07:39 2007
From: pshem.k at gmail.com (Pshem Kowalczyk)
Date: Tue Nov 27 16:07:51 2007
Subject: [Slony1-general] Problem reinitialising a node
Message-ID: <20fe625b0711271607q47384350qc8db5161d9b8fbea@mail.gmail.com>

Hi All,

yestarday one of the db boxes we in our cluster died. It took the db
with it. After a fresh install I added it to the cluster (basically -
drop node 3, store node 3). And then when I tried to start slony I
got:

2007-11-28 12:55:43 NZDT ERROR  cannot get sl_local_node_id - ERROR:
schema "_radiuscluster" does not exist
2007-11-28 12:55:43 NZDT FATAL  main: Node is not initialized properly


However if I try to connect to the db with the same privileges slony
uses (postgres admin user) I can see the tables:

postgres@raddb3:~$ psql -H akl-grafton-raddb3.ihug.net -U postgres radbackend
psql: warning: extra command-line argument "radbackend" ignored
psql: FATAL:  database "akl-grafton-raddb3.ihug.net" does not exist
postgres@raddb3:~$ psql -h akl-grafton-raddb3.ihug.net -U postgres radbackend
Welcome to psql 8.1.9, the PostgreSQL interactive terminal.

Type:  \copyright for distribution terms
       \h for help with SQL commands
       \? for help with psql commands
       \g or terminate with semicolon to execute query
       \q to quit

SSL connection (cipher: DHE-RSA-AES256-SHA, bits: 256)

radbackend=# select * from _radiuscluster.sl_node

_radiuscluster.sl_node
_radiuscluster.sl_nodelock_nl_conncnt_seq
_radiuscluster.sl_nodelock
radbackend=# select * from _radiuscluster.sl_node;
 no_id | no_active |                   no_comment                    | no_spool
-------+-----------+-------------------------------------------------+----------
     3 | t         | Node 3 - radbackend@akl-grafton-raddb3 | f
     2 | t         | Node 2 - radbackend@akl-grafton-raddb2 | f
     1 | t         | Node 1 - radbackend@akl-grafton-raddb1 | f
     4 | t         | Node 4 - radbackend@akl-grafton-raddb4 | f
(4 rows)

A few days ago I re-provisioned node 4 exactly the same way and
everything seems to be fine. What might be the problem? Configuration
files (slony1.conf is set to all defaults), or something in the
database?

I use slony 1.2.1.

kind regards
Pshem
From lists at serioustechnology.com  Wed Nov 28 06:58:19 2007
From: lists at serioustechnology.com (Geoffrey)
Date: Wed Nov 28 06:58:27 2007
Subject: [Slony1-general] slony installation
In-Reply-To: <1193857329.10273.35.camel@laptop.gunduz.org>
References: <4728C227.5070600@serioustechnology.com>	
	<1193854728.10273.21.camel@laptop.gunduz.org>
	<1193857329.10273.35.camel@laptop.gunduz.org>
Message-ID: <474D820B.2070904@serioustechnology.com>

Devrim G?ND?Z wrote:
> Hi,
> 
> On Wed, 2007-10-31 at 11:18 -0700, Devrim G?ND?Z wrote:
> 
>> You don't need to compile PostgreSQL. Just download and extract
>> Slony-I tarball  first. Then run these as root:
>>
>> ./configure
>> make rpm
> 
> Err.. Please before running configure, please edit
> postgresql-slony1-engine.spec.in and set

I find the following:

./redhat/postgresql-slony1.specfile
./suse/postgresql-slony1-engine.specfile
./postgresql-slony1.spec.in

Further, ./configure complains:

checking for pg_config... configure: error: Cannot find pg_config.
     Please specify correct installation path for pg_config
     with --with-pgconfigdir=<dir>

I then tried:

./configure 
--with-pgconfigdir=/home/esoteric/postgresql-7.4.18/src/bin/pg_config

configure: error: Your version of libpq doesn't have PQunescapeBytea
      this means that your version of PostgreSQL is lower than 7.3
      and thus not supported by Slony-I.

I've got the following rpms installed:

postgresql-pl-7.4.18-1PGDG.rhel4
postgresql-server-7.4.18-1PGDG.rhel4
postgresql-libs-7.4.18-1PGDG.rhel4
postgresql-7.4.18-1PGDG.rhel4

So I know I've not got anything lower then 7.3

-- 
Until later, Geoffrey

Those who would give up essential Liberty, to purchase a little
temporary Safety, deserve neither Liberty nor Safety.
  - Benjamin Franklin
From devrim at CommandPrompt.com  Wed Nov 28 07:03:42 2007
From: devrim at CommandPrompt.com (Devrim =?ISO-8859-1?Q?G=DCND=DCZ?=)
Date: Wed Nov 28 07:03:49 2007
Subject: [Slony1-general] slony installation
In-Reply-To: <474D820B.2070904@serioustechnology.com>
References: <4728C227.5070600@serioustechnology.com>
	<1193854728.10273.21.camel@laptop.gunduz.org>
	<1193857329.10273.35.camel@laptop.gunduz.org>
	<474D820B.2070904@serioustechnology.com>
Message-ID: <1196262222.25490.139.camel@localhost.localdomain>

SGksCgpPbiBXZWQsIDIwMDctMTEtMjggYXQgMDk6NTggLTA1MDAsIEdlb2ZmcmV5IHdyb3RlOgo+
IAo+IGNvbmZpZ3VyZTogZXJyb3I6IFlvdXIgdmVyc2lvbiBvZiBsaWJwcSBkb2Vzbid0IGhhdmUg
UFF1bmVzY2FwZUJ5dGVhCj4gICAgICAgdGhpcyBtZWFucyB0aGF0IHlvdXIgdmVyc2lvbiBvZiBQ
b3N0Z3JlU1FMIGlzIGxvd2VyIHRoYW4gNy4zCj4gICAgICAgYW5kIHRodXMgbm90IHN1cHBvcnRl
ZCBieSBTbG9ueS1JLgo+IAo+IEkndmUgZ290IHRoZSBmb2xsb3dpbmcgcnBtcyBpbnN0YWxsZWQ6
Cj4gCj4gcG9zdGdyZXNxbC1wbC03LjQuMTgtMVBHREcucmhlbDQKPiBwb3N0Z3Jlc3FsLXNlcnZl
ci03LjQuMTgtMVBHREcucmhlbDQKPiBwb3N0Z3Jlc3FsLWxpYnMtNy40LjE4LTFQR0RHLnJoZWw0
Cj4gcG9zdGdyZXNxbC03LjQuMTgtMVBHREcucmhlbDQKPiAKPiBTbyBJIGtub3cgSSd2ZSBub3Qg
Z290IGFueXRoaW5nIGxvd2VyIHRoZW4gNy4zCgpJbnN0YWxsIHBvc3RncmVzcWwtZGV2ZWwgUlBN
LgoKUmVnYXJkcywKLS0gCkRldnJpbSBHw5xORMOcWiAsIFJIQ0UKUG9zdGdyZVNRTCBSZXBsaWNh
dGlvbiwgQ29uc3VsdGluZywgQ3VzdG9tIERldmVsb3BtZW50LCAyNHg3IHN1cHBvcnQKTWFuYWdl
ZCBTZXJ2aWNlcywgU2hhcmVkIGFuZCBEZWRpY2F0ZWQgSG9zdGluZwpDby1BdXRob3JzOiBwbFBI
UCwgT0RCQ25nIC0gaHR0cDovL3d3dy5jb21tYW5kcHJvbXB0LmNvbS8KLS0tLS0tLS0tLS0tLS0g
bmV4dCBwYXJ0IC0tLS0tLS0tLS0tLS0tCkEgbm9uLXRleHQgYXR0YWNobWVudCB3YXMgc2NydWJi
ZWQuLi4KTmFtZTogbm90IGF2YWlsYWJsZQpUeXBlOiBhcHBsaWNhdGlvbi9wZ3Atc2lnbmF0dXJl
ClNpemU6IDE4OSBieXRlcwpEZXNjOiBUaGlzIGlzIGEgZGlnaXRhbGx5IHNpZ25lZCBtZXNzYWdl
IHBhcnQKVXJsIDogaHR0cDovL2xpc3RzLnNsb255LmluZm8vcGlwZXJtYWlsL3Nsb255MS1nZW5l
cmFsL2F0dGFjaG1lbnRzLzIwMDcxMTI4LzRlOGJjNjE0L2F0dGFjaG1lbnQucGdwCg==
From lists at serioustechnology.com  Wed Nov 28 07:16:22 2007
From: lists at serioustechnology.com (Geoffrey)
Date: Wed Nov 28 07:16:29 2007
Subject: [Slony1-general] slony installation
In-Reply-To: <1196262222.25490.139.camel@localhost.localdomain>
References: <4728C227.5070600@serioustechnology.com>	
	<1193854728.10273.21.camel@laptop.gunduz.org>	
	<1193857329.10273.35.camel@laptop.gunduz.org>	
	<474D820B.2070904@serioustechnology.com>
	<1196262222.25490.139.camel@localhost.localdomain>
Message-ID: <474D8646.60603@serioustechnology.com>

Devrim G?ND?Z wrote:
> Hi,
> 
> On Wed, 2007-11-28 at 09:58 -0500, Geoffrey wrote:
>> configure: error: Your version of libpq doesn't have PQunescapeBytea
>>       this means that your version of PostgreSQL is lower than 7.3
>>       and thus not supported by Slony-I.
>>
>> I've got the following rpms installed:
>>
>> postgresql-pl-7.4.18-1PGDG.rhel4
>> postgresql-server-7.4.18-1PGDG.rhel4
>> postgresql-libs-7.4.18-1PGDG.rhel4
>> postgresql-7.4.18-1PGDG.rhel4
>>
>> So I know I've not got anything lower then 7.3
> 
> Install postgresql-devel RPM.

Thanks, that addressed that issue.  I'm confused about the build 
instructions though, the documentation says:

Slony-I normally needs to be built and installed by the PostgreSQL Unix 
user.

I'm assuming that the slony executables will be placed in system 
directories, therefore requiring 'make install' by root?


-- 
Until later, Geoffrey

Those who would give up essential Liberty, to purchase a little
temporary Safety, deserve neither Liberty nor Safety.
  - Benjamin Franklin
From ajs at crankycanuck.ca  Wed Nov 28 07:37:38 2007
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Wed Nov 28 07:37:52 2007
Subject: [Slony1-general] A Best Practices Question
In-Reply-To: <474C8735.3070109@aol.net>
References: <474C8735.3070109@aol.net>
Message-ID: <20071128153738.GC3680@crankycanuck.ca>

On Tue, Nov 27, 2007 at 04:08:05PM -0500, Robert Landrum wrote:
> We have several hundred tables in our DB and all should be replicated. 
> 
>     SELECT
>       relname
>     FROM
>       pg_class
>     WHERE
>       relkind = 'r' and
>       relhaspkey is true and
>       relowner = (select usesysid from pg_user where usename = 'foobar')
>     ORDER BY
>       relname
> 
> A similar query is set to be run for sequences.  I have only sequences 
> and pkey'd tables.

This will get you the tables, yes.  But it'd be nicer to write a script that
automatically updates your Slony config at the same time as your schema is
altered.  This way, you can use your source control to support both your
operations and coding. 

You will find your life goes a lot easier if you assume that replication is
one of the features of your DBMS, and is to be worked with; rather than a
sort of add-on that happens to live in there.  This approach will also make
your planning for schema changes a little less painful.

A

-- 
Andrew Sullivan
Old sigs will return after re-constitution of blue smoke
From glynastill at yahoo.co.uk  Wed Nov 28 05:54:51 2007
From: glynastill at yahoo.co.uk (Glyn Astill)
Date: Wed Nov 28 19:24:46 2007
Subject: [Slony1-general] Problem compiling slony 1.2 - scan.c ?
Message-ID: <292476.8619.qm@web25803.mail.ukl.yahoo.com>

Hi people,

When I try to compile Slony 1.2 I get the following error:P

parser.y:1090:18: error: scan.c: No such file or directory
make[2]: *** [parser.o] Error 1
make[2]: Leaving directory `/tmp/slony1-1.2.12/src/slony_logshipper'
make[1]: *** [all] Error 2
make[1]: Leaving directory `/tmp/slony1-1.2.12/src'

I've installed bison.

Anyone got any idea what I may be doing wrong?


Glyn Astill


Glyn Astill



      ___________________________________________________________ 
Want ideas for reducing your carbon footprint? Visit Yahoo! For Good  http://uk.promotions.yahoo.com/forgood/environment.html
From lavalamp at spiritual-machines.org  Wed Nov 28 21:05:56 2007
From: lavalamp at spiritual-machines.org (Brian A. Seklecki)
Date: Wed Nov 28 21:06:15 2007
Subject: [Slony1-general] Problem compiling slony 1.2 - scan.c ?
In-Reply-To: <292476.8619.qm@web25803.mail.ukl.yahoo.com>
References: <292476.8619.qm@web25803.mail.ukl.yahoo.com>
Message-ID: <1196312756.3635.24.camel@new-host.l33tsdal3.biz>




On Wed, 2007-11-28 at 13:54 +0000, Glyn Astill wrote:
> Hi people,
> 
> When I try to compile Slony 1.2 I get the following error:P


Post a URL to your config.log and your "uname -a" ?

~BAS
> 
> 
> 

From cbbrowne at ca.afilias.info  Thu Nov 29 08:24:45 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Thu Nov 29 08:24:51 2007
Subject: [Slony1-general] Patch for shorter attkind
In-Reply-To: <20071121162846.ED79B1165966@zeus.directinfos.com> (Jacques
	Caron's message of "Wed, 21 Nov 2007 17:28:34 +0100")
References: <20071121162846.ED79B1165966@zeus.directinfos.com>
Message-ID: <60r6i981f6.fsf@dba2.int.libertyrms.com>

Jacques Caron <jc@oxado.com> writes:
> The following very quick patch (against 1.2.12) provides the following changes:
> - when scanning attributes looking for key columns (in UPDATEs and
> DELETEs), stop when we reach the end of the attkind string
> - when creating the triggers, final "v"s are stripped
>
> Result:
> - one can add columns (without defaults, constraints, etc.) to tables
> (destinations first, origin last) without changing the logtrigger and
> without using EXECUTE SCRIPT
> - as a bonus we save a few cycles in updates and deletes

I have queued this up in Bugzilla...

http://bugs.slony.info/bugzilla/show_bug.cgi?id=18

It's unassigned; if you had an ID on the Bugzilla instance, I'd be
happy to assign it to you...
-- 
"cbbrowne","@","linuxfinances.info"
http://cbbrowne.com/info/sgml.html
Actually, typing random  strings in the Finder does  the equivalent of
filename  completion.    (Discussion  in  comp.os.linux.misc   on  the
intuitiveness of commands: file completion vs. the Mac Finder.)
From cbbrowne at ca.afilias.info  Thu Nov 29 08:43:00 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Thu Nov 29 08:43:07 2007
Subject: [Slony1-general] Understanding Slony Cleanup
In-Reply-To: <1195755198.4246.229.camel@ebony.site> (Simon Riggs's message of
	"Thu, 22 Nov 2007 18:13:18 +0000")
References: <1195755198.4246.229.camel@ebony.site>
Message-ID: <60mysx80kr.fsf@dba2.int.libertyrms.com>

Simon Riggs <simon@2ndquadrant.com> writes:
> I'm trying to understand what goes on during cleanupThread_main()
>
> The code does this, in order:
>
> 1. deletes all outstanding log rows from both log tables
>
> 2. (eventually) truncates the log table
>
> 3. (allegedly) vacuums the log table 

I am the one who did a lot of rehaping of this code in the 1.2 branch,
so I'll see what I can address.

> I have a few questions on the above for 1.2.x
>
> - SQL function logswitch_finish() says it is called after cleanup thread
> has vacuumed both log tables. The code in cleanupThread_main() seems to
> avoid the vacuum. Not sure whether the SQL comment is wrong, or are we
> saying we allow autovacuum to do this for us, or we don't do it at all? 

- if autovac is enabled for the table, then yes, indeed, the cleanup
  thread lets autovac do vacuum for it.

- if autovac is not enabled on the whole or for an individual table,
  then it is indeed handled by the cleanup thread.

That's neither "yes" nor "no."  :-)

> - Why do we DELETE log table rows at all? We're doing it out-of-line so
> it clearly isn't a necessary step for correctness (or is it?). At the
> end of it all we TRUNCATE them anyway, so what was the point of all that
> deletion? Or alternatively, why do we truncate and log switch at all?

The older/original logic would simply use DELETE, never TRUNCATING;
originally, we were just using the one log table, so there wasn't any
option of doing a TRUNCATE.

I was trying to be as conservative/safe as possible when I changed things
to add in periodic truncation of log tables.

Yes, you're right, we could solely use TRUNCATE, never using DELETE.
That sounds like a good further incremental change to propose.

> - My understanding of the flip-flop design with 2 log tables was that it
> would allow us to avoid VACUUM entirely, yet this doesn't seem to be the
> case in 1.2. What purpose does the second log table serve?

That's not exactly it; what it provides is that if we can periodically
TRUNCATE log tables, then we can be certain that they do not
permanently bloat to any ridiculous size.

It's not, in effect, that we can get a "best case;" instead, we get to
avoid a "worst case."

> - If we do have to DELETE, why do we do this to both log tables? Surely
> changes will only be found in one? Or are we assuming that the query
> will do a fast indexscan and return quickly, so why bother trying to
> avoid it?

During the period just after a switch, useful data will be found in
both log tables, so "making sure code is right" dictated applying the
delete logic to both tables.

Think: "Paranoid coding."

> - We rely on vacuum_delay having been set elsewhere. If we do have to do
> VACUUMs, then can we/should we force a non-zero vacuum_delay for the
> cleanup thread?

Good question.  I'm not sure.

I think the answer to that varies somewhat across PostgreSQL versions.
For 7.4, 8.0, 8.1, the vacuum_delay values make VACUUM run longer, and
VACUUM transactions are considered to be transactions that tend to
block later VACUUMS from doing any good until they complete.  That
changes in 8.2, and I think that changes how desirable (or rather, how
UNdesirable) a non-zero vacuum_delay becomes.

> - We ANALYZE the log tables when they are empty following the TRUNCATE.
> Is that done deliberately for some reason? At that point the data values
> are not available so it means later planning of SQL against the log
> tables is going to be a little strange. Should weavoid re-ANALYZEing the
> log table when we have just TRUNCATED it?

Hmm.  If it seems conspicuously unwise to do this ANALYZE, then I can
see us dropping it.  That may well be the case...
-- 
(format nil "~S@~S" "cbbrowne" "linuxdatabases.info")
http://linuxdatabases.info/info/rdbms.html
"I don't plan to maintain it, just to install it." -- Richard M. Stallman
From simon at 2ndquadrant.com  Thu Nov 29 09:06:36 2007
From: simon at 2ndquadrant.com (Simon Riggs)
Date: Thu Nov 29 09:06:25 2007
Subject: [Slony1-general] Understanding Slony Cleanup
In-Reply-To: <60mysx80kr.fsf@dba2.int.libertyrms.com>
References: <1195755198.4246.229.camel@ebony.site>
	<60mysx80kr.fsf@dba2.int.libertyrms.com>
Message-ID: <1196355996.4246.1343.camel@ebony.site>

On Thu, 2007-11-29 at 11:43 -0500, Christopher Browne wrote:
> Simon Riggs <simon@2ndquadrant.com> writes:

> > - Why do we DELETE log table rows at all? We're doing it out-of-line so
> > it clearly isn't a necessary step for correctness (or is it?). At the
> > end of it all we TRUNCATE them anyway, so what was the point of all that
> > deletion? Or alternatively, why do we truncate and log switch at all?
> 
> The older/original logic would simply use DELETE, never TRUNCATING;
> originally, we were just using the one log table, so there wasn't any
> option of doing a TRUNCATE.
> 
> I was trying to be as conservative/safe as possible when I changed things
> to add in periodic truncation of log tables.

Understood. Stability is a key strength of slony and one that makes it
very popular as a result. <action>Tip-of-the-hat</action>

> Yes, you're right, we could solely use TRUNCATE, never using DELETE.
> That sounds like a good further incremental change to propose.

Cool.

> > - My understanding of the flip-flop design with 2 log tables was that it
> > would allow us to avoid VACUUM entirely, yet this doesn't seem to be the
> > case in 1.2. What purpose does the second log table serve?
> 
> That's not exactly it; what it provides is that if we can periodically
> TRUNCATE log tables, then we can be certain that they do not
> permanently bloat to any ridiculous size.
> 
> It's not, in effect, that we can get a "best case;" instead, we get to
> avoid a "worst case."

So it sounds like we could have both:

Have the cleanup_thread measure the size of the log table. If it exceeds
a specified size then we DELETE, otherwise we just wait for TRUNCATE. If
people have enough space they can just let the table build up and let it
be truncated when we switch log tables.

So we have the worst case avoidance mechanism, but also a best case
performance gain because we avoid all that annoying DELETE and VACUUM
activity which drags down response times.

What do you think?

-- 
  Simon Riggs
  2ndQuadrant  http://www.2ndQuadrant.com

From smith.not.western at gmail.com  Thu Nov 29 14:01:18 2007
From: smith.not.western at gmail.com (Mike C)
Date: Thu Nov 29 14:01:28 2007
Subject: [Slony1-general] Is slony1 suitable for this scenario?
Message-ID: <bd0eabd0711291401q83822bu42b02ca343a91d48@mail.gmail.com>

Hi,

I'm looking at using slony1 for replicating a database between two
different hosting facilities. I've looked around the slony1
documentation and believe that what I want could work, but would
appreciate it if someone experienced with slony1 could comment:

I have a ~1GB database (< 100MB with pg_dump). It has a large
transaction volume, ~100 updates  a second and an order of magnitude
more selects per second. I wish to replicate this database to a warm
standby database located in another hosting facility. I say warm
standby because there would be manual intervention to make it the
primary database. While not the primary database, it will still be
used for reporting & scheduled job purposes. At some point in the
future, we may put the replicated database in several other hosting
facilities. The link between the different hosting facilities would be
through IPSec VPN Tunnels over the plain old Internet (5 Megabit
links).  I am going to assume a worst case scenario that the VPN links
will fail once a day, for up to 20 minutes at a time.

The biggest concern to me is the VPN links. I note the documentation
strongly suggests that using Slony over a flakey WAN is a bad idea.
So, is what I have suggested feasible with slony? Is there some other
alternative I should be investigating? (I have to rule out any
synchronous solution due to WAN reliability).

Regards,

Mike
From bhirt at mobygames.com  Thu Nov 29 14:15:35 2007
From: bhirt at mobygames.com (Brian Hirt)
Date: Thu Nov 29 14:16:09 2007
Subject: [Slony1-general] sync events failing, cannot drop table from set
Message-ID: <328AC198-05C7-4A21-A515-EB7325C4F888@mobygames.com>

Hello,

Out of the blue, I started getting an error coming from a replicated  
master / slave database, a sync is failing because of a primary key  
violation.

2007-11-21 00:27:51 CST DEBUG1 cleanupThread:    0.227 seconds for  
delete logs
2007-11-21 00:30:11 CST ERROR  remoteWorkerThread_1: "insert into  
"public"."moby_user_ranking" (moby_user_id,rank,"position",contribution_ 
rating,is_tie) values ('30979','1','1','69091','f');
..
..
a bunch of repeating similar commands for the same table.
..
..
" ERROR:  duplicate key violates unique constraint  
"moby_user_ranking_pkey"
  - qualification was: where log_origin = 1 and (  (
  log_tableid in  
(46,52,1,2,3,212,217,218,228,229,238,239,255,259,260,281,296,5,6,7,8,10, 
11,12,14,15,16,17,19,20,22,23,24,25,18,26,27,28,29,30,31,32,33,34,35,36, 
37,9,38,39,40,41,42,43,44,45,47,48,49,50,51,53,54,55,56,57,58,59,60,62,6 
3,64,65,66,67,68,69,70,71,72,73,74,75,76,77,80,81,83,85,86,87,88,89,90,9 
1,92,93,94,95,98,99,100,101,102,103,104,97,105,106,107,108,109,110,111,1 
12,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,1 
30,131,132,133,135,136,137,138,139,140,141,142,143,144,145,146,147,148,1 
49,150,151,153,155,156,152,154,157,158,159,160,13,161,162,163,164,165,16 
7,168,169,170,4,171,172,174,61,173,175,176,177,78,79,82,84,178,179,180,1 
81,182,183,184,21,96,166,185,186,187,188,189,190,192,134,191,193,194,195 
, 
196,197,198,199,200,201,203,202,204,205,206,207,208,209,210,211,213,214, 
215,216,219,220,221,222,223,224,225,226,227,230,231,232,233,234,235,236, 
237,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,256,257, 
258,261,262,263,264,265,266,267,268,269,270,271,272,273,274,275,276,277, 
278,279,280,282,283,284,285,286,287,288,289,290,291,292,293,294,295,297, 
298,299,300,301,302,303,304,305,306,307,308,309,310,311)    and  
(log_xid < '66609974' and "_mobycluster".xxid_lt_snapshot(log_xid,  
'66609954:66609974:''66609954'''))    and (log_xid >= '66609811' and  
"_mobycluster".xxid_ge_snapshot(log_xid,  
'66609811:66609819:''66609811'',''66609817'''))) )
2007-11-21 00:30:11 CST ERROR  remoteWorkerThread_1: helper 1  
finished with error
2007-11-21 00:30:11 CST ERROR  remoteWorkerThread_1: SYNC aborted

I figured I'd drop the table from the set using: SET DROP TABLE  
( ORIGIN = 1, ID = 18).  However, this did not help which is why I am  
sending this request for help.  I don't know why the original problem  
started happening   Replication had only been running for about a 14  
hours before this problem happened.  I successfully switched over  
twice while replicate was running so I could do maintenance on the  
database servers.   Other than that, no scheme changes or  
applications changes were made.

The master no longer shows the dropped table in sl_table, but the  
slave still does.   The denyaccess trigger is still on the slave  
too.   Sync events are still failing because sl_log_2 still has all  
the un-replicated data for tableid 18.      I'd rather find the cause  
of the problem over hacking things to get working, but at this point  
I think i'm shortly going to be forced to drop the whole set ditch,  
replication or at least start over.   Does anyone have any ideas on  
what might cause slony do get into a state like this?

I'm not really intimate with slony, but it seems like there should be  
a better way to drop a table from a set for situations like this.   
Maybe an option that clears pending updates from the log?

Anyway, I hope people have some suggestions on how to proceed.

Thanks,



Brian Hirt
bhirt@mobygames.com



From vivek at khera.org  Thu Nov 29 14:26:10 2007
From: vivek at khera.org (Vivek Khera)
Date: Thu Nov 29 14:26:20 2007
Subject: [Slony1-general] Is slony1 suitable for this scenario?
In-Reply-To: <bd0eabd0711291401q83822bu42b02ca343a91d48@mail.gmail.com>
References: <bd0eabd0711291401q83822bu42b02ca343a91d48@mail.gmail.com>
Message-ID: <ABFE0F61-C8D0-4CC1-883D-FA79742FBA44@khera.org>


On Nov 29, 2007, at 5:01 PM, Mike C wrote:

> I have a ~1GB database (< 100MB with pg_dump). It has a large
> transaction volume, ~100 updates  a second and an order of magnitude
> more selects per second. I wish to replicate this database to a warm
> standby database located in another hosting facility. I say warm

This will entirely depend on the size and quantity of your updates.   
Are your updates single row updates, or do they modify large numbers  
of rows?  In slony, a single update query that modifies many rows will  
be played back as an update per row on the replicas.  This causes a  
lot of traffic on the wire, plus is not as efficient on the DB itself,  
so you could potentially fall behind on your replication.

Also, are the updates changing large volume of data?  Ie, is the  
update of a row changing an integer or is it changing a multi-megabyte  
text field?  Again, this affects your over the wire bandwidth needs.

You really need to have beefy hardware to pull this off.  Remember  
that replication doesn't come for free.  You're going to pay a price  
of some % of the speed of your server to the overhead needed to manage  
it.

I have one DB that replicates across a WAN, but the volume of updates  
is trivial.  We've had it disconnected for 2 days once and it just  
caught up in a few seconds.  Our primary DB is a different story.  If  
it falls more than 4 hours behind, we just drop the node and recreate  
it.  There's no way it will ever catch up otherwise.... :-)

If I were setting this up, I'd make the master replicate to another  
host locally, then use that as the source for replicating to all the  
remote sites, so any one slow box won't cause much bloat on the master  
(I think).


From glynastill at yahoo.co.uk  Fri Nov 30 02:07:11 2007
From: glynastill at yahoo.co.uk (Glyn Astill)
Date: Fri Nov 30 02:07:34 2007
Subject: [Slony1-general] Getting started with Slony and PgAdminIII 1.8 -
	Scripts not available?
In-Reply-To: <bd0eabd0711291401q83822bu42b02ca343a91d48@mail.gmail.com>
Message-ID: <542140.78000.qm@web25807.mail.ukl.yahoo.com>

Hi People,

I'm trying to get Slony-I 1.2 up and running and I wanted to use
PgAdminIII 1.8 to create my replication cluster. However when I go to
create a new Slony-I cluster, the status bar says;

"Slony-I creation scripts not available; only joining possible"

I've installed Postgres 8.2.5 with its adminpack from source and
installed Slony-I 1.2 from source too.

My Postgres data direcroty is /usr/local/pgsql/data and Slony-I
installed the *.sql scripts in /usr/local/pgsql/share

So should PgAdmin be able to see them? Do they need to be somewhere
else or do I need some Environment variables set?

So far I just add /usr/local/pgsql/lib to my LD_LIBRARY_PATH and
/usr/local/pgsql/bin to my PATH and export in the default profile.

What I wanted to do was follow the pgAdmin guide to setting up a
cluster, but if I have to do it otherwise then I don't mind.

Any ideas, recommendations and pointers to documentation and guides
would also be appreciated.

Thanks
Glyn


      ___________________________________________________________
Yahoo! Answers - Got a question? Someone out there knows the answer. Try it
now.
http://uk.answers.yahoo.com/ 

From dpage at postgresql.org  Fri Nov 30 02:13:34 2007
From: dpage at postgresql.org (Dave Page)
Date: Fri Nov 30 02:13:59 2007
Subject: [Slony1-general] Getting started with Slony and PgAdminIII 1.8
	-	Scripts not available?
In-Reply-To: <542140.78000.qm@web25807.mail.ukl.yahoo.com>
References: <542140.78000.qm@web25807.mail.ukl.yahoo.com>
Message-ID: <474FE24E.60103@postgresql.org>

Glyn Astill wrote:
> Hi People,
> 
> I'm trying to get Slony-I 1.2 up and running and I wanted to use
> PgAdminIII 1.8 to create my replication cluster. However when I go to
> create a new Slony-I cluster, the status bar says;
> 
> "Slony-I creation scripts not available; only joining possible"
> 
> I've installed Postgres 8.2.5 with its adminpack from source and
> installed Slony-I 1.2 from source too.
> 
> My Postgres data direcroty is /usr/local/pgsql/data and Slony-I
> installed the *.sql scripts in /usr/local/pgsql/share
> 
> So should PgAdmin be able to see them? Do they need to be somewhere
> else or do I need some Environment variables set?

Under File -> Options set the Slony-I path option to point to the 
directory containing the scripts (/usr/local/pgsql/share).

Regards. Dave
From cbbrowne at ca.afilias.info  Fri Nov 30 07:56:03 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Fri Nov 30 07:56:08 2007
Subject: [Slony1-general] Is slony1 suitable for this scenario?
In-Reply-To: <bd0eabd0711291401q83822bu42b02ca343a91d48@mail.gmail.com> (Mike
	C.'s message of "Fri, 30 Nov 2007 11:01:18 +1300")
References: <bd0eabd0711291401q83822bu42b02ca343a91d48@mail.gmail.com>
Message-ID: <603aun917w.fsf@dba2.int.libertyrms.com>

"Mike C" <smith.not.western@gmail.com> writes:
> The biggest concern to me is the VPN links. I note the documentation
> strongly suggests that using Slony over a flakey WAN is a bad idea.
> So, is what I have suggested feasible with slony? Is there some other
> alternative I should be investigating? (I have to rule out any
> synchronous solution due to WAN reliability).

What you're describing sounds pretty reasonable...

The transaction mix of 10% writes versus 90% reads fits well with what
has been seen to work, elsewhere.

The trouble with flakey links is that it can lead to replication
getting some induced delays.  The specific scenario that we have seen
is thus...

 -> Slons all running at Site A.
 -> A node is at Site B, managed by slon at Site A.
 -> WAN connection falls over, cutting off all of the connection links.
 -> HOWEVER, the connection that was managing the "slon managing node
    at Site B" isn't aware that the other end of the connection is
    never coming back.

At this point, it tends to take 3h+ for TCP timeouts to take place and
allow that connection to get dropped.

During that 3h, what we would observe is that network guys would
refresh the WAN link, and...

- Slon at site A would almost immediately realize that its connection
  to site B is dead.  It would die and get restarted within minutes.
  (This on a 1.1 version of Slony-I; on 1.2, it would only be a thread
  that would get restarted.)

- Unfortunately, the attempt to reconnect would find that the existing
  connection on the "Site B" node was claiming to still be managing that
  node.

Things wouldn't clear up until the TCP timeout that would clear out the
elderly DB connection at "Site B."

We could fix this by hand, by killing off the bad DB connection, but
if this took place late at night, that required paging someone.

It happened seldom enough that we never got around to creating an
automated mechanism for this.

There was, in fact, a better solution, namely to make sure that each
slon process was running locally at the site where its database
resided, that way failed connections *wouldn't* be troublesome.  The
only kind of connection that could be left open would be read-only
feeds against remote nodes, and this wouldn't cause nearly as much
trouble.
-- 
output = reverse("ofni.secnanifxunil" "@" "enworbbc")
http://cbbrowne.com/info/languages.html
Rules of the Evil Overlord #193.  "If I am using the hero's girlfriend
as a  hostage and am holding her  at the point of  imminent death when
confronting the  hero, I will focus on  her and not him.  He won't try
anything with his true love held  hostage. On the other hand, the fact
that she has been weak, slow-witted, naive and generally useless up to
this point  has no bearing  on her actions  at the moment  of dramatic
climax."  <http://www.eviloverlord.com/>
From cbbrowne at ca.afilias.info  Fri Nov 30 08:39:08 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Fri Nov 30 08:39:15 2007
Subject: [Slony1-general] sync events failing, cannot drop table from set
In-Reply-To: <328AC198-05C7-4A21-A515-EB7325C4F888@mobygames.com> (Brian
	Hirt's message of "Thu, 29 Nov 2007 15:15:35 -0700")
References: <328AC198-05C7-4A21-A515-EB7325C4F888@mobygames.com>
Message-ID: <60wsrz7knn.fsf@dba2.int.libertyrms.com>

Brian Hirt <bhirt@mobygames.com> writes:
> I'm not really intimate with slony, but it seems like there should be
> a better way to drop a table from a set for situations like this.
> Maybe an option that clears pending updates from the log?

An "easy answer" would be to determine the table ID, and delete all
tuples relating to that table from sl_log_1 and sl_log_2.

Thus, ...

   delete from _mobycluster.sl_log_1 where log_tableid = 18;
   delete from _mobycluster.sl_log_2 where log_tableid = 18;

I would be inclined to run these two queries against *all* nodes, in
order to "nip this" completely.

That would indeed address your issue *very* quickly, as that would
drop out all replication data relating to "table 18."

How to apply that to "SET DROP TABLE" seems rather more controversial
to me...  I agree that you have described a "use case" for something
useful, but I wouldn't change existing functionality without a fair
bit more discussion.

There are essentially two ways we might have SET DROP TABLE work:

1.  As you suggest, where it is treated as an event to process as
early as possible, perhaps *before* other events that were submitted
before it, where the intent is to expunge the table from replication
without caring about the consistency of the contents of the table.

In effect, "Oops, this table's blown!  Let's drop it out of
replication ASAP, and we don't care what has or hasn't been replicated
in this table."

2.  The existing way that SET DROP TABLE works is consistent with
allowing it to be dropped out of replication in a consistent place
against all nodes.

The expectation is that the dropped table will contain identical data
across all subscribers at the time that it is dropped from
replication.

There are, indeed, uses for both of these approaches.

There is an item on my work list to create a "CANCEL SUBSCRIPTION"
command which would be somewhat similar to this.

-> Like your form of "SET DROP TABLE," it would be intended to be
   invoked with high priority, ASAP.

-> It would try to clean things up vis-a-vis the configuration
   of the subscription, but would not make any particular
   attempt to encourage consistency of data within the replicated
   tables.

Actually, I think I would want for the handling of something like what
you're asking for to be consistent with "CANCEL SUBSCRIPTION" in a
couple of ways:

  - It should use "CANCEL TABLE", and be entirely distinct from SET
    DROP TABLE

  - There might be further "CANCEL" commands; all of them should be
    consistent in the fashion that they are processed with high
    priority (e.g. - before all non-CANCEL events), and in that
    their immediacy overrides data consistency.

I think that we only really need "CANCEL SUBSCRIPTION," "CANCEL
TABLE," and, *maybe*[1], "CANCEL SEQUENCE."

Further thought suggests that there *are* more events that we should
consider processing with heightened priority.  It seems to me that
STORE PATH is quite likely to get used in an attempt to fix
configuration and that it may be preferable to make sure STORE PATH
gets run before any SYNC event goes through.

That points to a notion of evaluating our events to see which are
"high priority," and always processing them first.

Footnotes: 

[1] Maybe, because there's never more than 1 tuple to update, so that
it's not a terribly important event to be able to support at "high
priority."
-- 
select 'cbbrowne' || '@' || 'cbbrowne.com';
http://www3.sympatico.ca/cbbrowne/linuxxian.html
Real Programmers are surprised when the odometers in their cars don't
turn from 99999 to A0000.  (Competent ones, when it's not 9999A.)
From vivek at khera.org  Fri Nov 30 09:33:11 2007
From: vivek at khera.org (Vivek Khera)
Date: Fri Nov 30 09:33:19 2007
Subject: [Slony1-general] Getting started with Slony and PgAdminIII 1.8 -
	Scripts not available?
In-Reply-To: <542140.78000.qm@web25807.mail.ukl.yahoo.com>
References: <542140.78000.qm@web25807.mail.ukl.yahoo.com>
Message-ID: <8B08CBB1-DF77-4F40-8148-FFF8F87FE289@khera.org>


On Nov 30, 2007, at 5:07 AM, Glyn Astill wrote:

> Hi People,

Can we stop hijacking old threads and changing the subject line?  It  
really messes up message threading and makes discussions harder to  
follow.

From cbbrowne at ca.afilias.info  Fri Nov 30 12:44:15 2007
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Fri Nov 30 12:44:27 2007
Subject: [Slony1-general] Version 1.2.12 released
In-Reply-To: <1195748137.4246.173.camel@ebony.site> (Simon Riggs's message of
	"Thu, 22 Nov 2007 16:15:37 +0000")
References: <601wavf4kp.fsf@dba2.int.libertyrms.com>
	<47396E63.8080106@free.fr> <1195748137.4246.173.camel@ebony.site>
Message-ID: <60k5nz5uqo.fsf@dba2.int.libertyrms.com>

Simon Riggs <simon@2ndquadrant.com> writes:
> On Tue, 2007-11-13 at 10:29 +0100, Cyril SCETBON wrote:
>
>> I think it would be better to be able to modify SLON_DATA_FETCH_SIZE by 
>> using a parameter on the slon command line. For example, we got a lot of 
>> updates (400 per second) between far geographical sites. I had to modify 
>> this variable and to recompile the slon binary cause I didn't find 
>> another way until now.
>
> Cyril,
>
> Could you publish your performance results? That will help everybody to
> understand the benefit of this change.
>
> Do you have results for a variety of settings? It may be that we just
> make a permanent change of the #DEFINEd value, rather than making it
> configurable.

One of our guys is planning to try changing this value, increasing by
an order of magnitude.

I'm inclined to expect that the Right Answer may be to make a
permanent increase to the #DEFINEd value, as you suggest.

 -> It's not easily changed via configuration because the #DEFINEd
    value is used to define, at compile time, an array's size.

 -> It's not a huge array; the elements aren't particularly huge,
    except in the specific case where a tuple is Really Big.

I wouldn't be surprised if shifting from a size of 100 to a size of
1000 would be helpful, and not overly painful in any fashion.
-- 
select 'cbbrowne' || '@' || 'acm.org';
http://www3.sympatico.ca/cbbrowne/oses.html
A Plateau is the highest form of flattery.
From revoohc at gmail.com  Fri Nov 30 13:38:55 2007
From: revoohc at gmail.com (Chris Hoover)
Date: Fri Nov 30 13:39:07 2007
Subject: [Slony1-general] Version 1.2.12 released
In-Reply-To: <601wavf4kp.fsf@dba2.int.libertyrms.com>
References: <601wavf4kp.fsf@dba2.int.libertyrms.com>
Message-ID: <1d219a6f0711301338x22f552a7sda704356d9bedce8@mail.gmail.com>

Are there any binary rpms planned for this release?  I went to download them
so I can begin a replication project, and there is only a source rpm.  We
run our postgres from the official RPM's supplied by the PostgreSQL project,
and really need to be able to install Slony from "official" rpms.

Thanks,

Chris

On Nov 12, 2007 6:04 PM, Christopher Browne <cbbrowne@ca.afilias.info>
wrote:

> After a pretty considerable test and release cycle, version 1.2.12 of
> the Slony-I replication system has been released.
>
> There is a pretty considerable set of changes:
>
> - Fixed problem with DDL SCRIPT parser where C-style comments were
>  not being processed properly
>
> - Added stored functions and documentation for adding empty tables
>  (notably *partitions*) to replication.  Note these functions
>  do no work when not specifically requested.
>
>  CAVEAT:  This functionality may not work as expected on versions
>  of PostgreSQL earlier than 8.1.  Mind you, partitioning tends
>  to function pretty poorly in earlier versions of PostgreSQL as
>  there were substantial enhancements in 8.1 and following versions.
>
> - Added a fairly substantial partitioning test to exercise the
>  new stored functions above.
>
> - Backport "listen path" generator function from CVS HEAD (2.0) to
>  1.2 branch.
>
> - Fixed a problem with "EXECUTE SCRIPT" (introduced in remote_worker.c
>  version 1.124.2.13) where moving the relevant code into a subroutine
>  at the end led to losing the "BEGIN; SET TRANSACTION ISOLATION LEVEL
>  SERIALIZABLE;" query that needs to be the first thing run...
>
> - Fixing the archive sequence generations (in log shipping).  All
>  non-SYNC events must start the local transaction before creating the
>  archive as well, so that the lock on the archive counter table
>  serializes archive creation.
>
> - Fixed logging done in local_listener.c - various places, there was
>  no '\n' in some cases, which would lead to entries being folded
>  together.
>
> - Fix launch_slons.sh - was not stripping quotes from PID file name
>
> - Error handling for "ERROR: could not serialize access due to
>  concurrent update"
>
>  If this error is encountered when starting processing of
>  sl_archive_counter, then two threads are fighting over access to
>  this counter, and at least one has just failed.
>
>  Rather than waiting, we ask to restart the node immediately.
>
> - Fixes to slonik_build_env script - it wasn't properly handling
>  cases where there was just 1 table or 1 sequence, and had a
>  problem with the -schema option - thanks, Bernd Helmle
>
> - Don't bother building slony_logshipper on Win32 as it doesn't work
>  there at this point.
>
> - If slonik connects as other than a superuser, then generate error
>  message indicating this to the user.
> --
> "cbbrowne","@","linuxdatabases.info"
> http://www3.sympatico.ca/cbbrowne/multiplexor.html
> Incrementally extended heuristic algorithms tend inexorably toward the
> incomprehensible.
> _______________________________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20071130/=
2f6394f2/attachment.htm
