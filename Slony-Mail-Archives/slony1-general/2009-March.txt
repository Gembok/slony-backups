From steve at greengecko.co.nz  Sun Mar  1 22:31:09 2009
From: steve at greengecko.co.nz (Steve Holdoway)
Date: Sun Mar  1 22:31:45 2009
Subject: [Slony1-general] Slony 2.0.1 installation problems...
Message-ID: <20090302193109.ed7e3819.steve@greengecko.co.nz>

Hey folks, 

Unfortunately there's a few too many unknowns in this one, but if anyone can help I'd be really grateful.

I have a debian 64bit/postgres 8.3.6/slony 2.0.0 system up and running, and have been happily developing on this

I Installed from ubuntu hardy,
 
ii  postgresql-8.3              8.3.6-0ubuntu8.04                           
ii  postgresql-client-8.3       8.3.6-0ubuntu8.04                           
ii  postgresql-client-common    87                                          
ii  postgresql-common           87                                          
ii  postgresql-contrib-8.3      8.3.6-0ubuntu8.04                           
ii  postgresql-doc-8.3          8.3.6-0ubuntu8.04                           
ii  postgresql-server-dev-8.3   8.3.6-0ubuntu8.04                  

And built slony 2.0.0 from source. All works fine.

However, on another server, running 64bit Centos 5.2/postgres 8.3.6/slony 2.0.1, I can't get the slonik store node to run. It fails with 

 PGRES_FATAL_ERROR load '$libdir/slony1_funcs';  - ERROR:  could not access file "$libdir/slony1_funcs": No such file or directory

I've installed the following from the pgdg yum repository:
postgresql-libs-8.3.6-1PGDG.rhel5
postgresql-pltcl-8.3.6-1PGDG.rhel5
postgresql-devel-8.3.6-1PGDG.rhel5
postgresql-8.3.6-1PGDG.rhel5
postgresql-plperl-8.3.6-1PGDG.rhel5
postgresql-plpython-8.3.6-1PGDG.rhel5
postgresql-libs-8.3.6-1PGDG.rhel5
postgresql-server-8.3.6-1PGDG.rhel5
postgresql-contrib-8.3.6-1PGDG.rhel5

And built slony 2.0.1 from scratch. I see that the slony1-funcs.so is installed in /usr/lib64/pgsql, and I've added that directory into /etc/ld.so.conf.d/postgresql.conf and run ldconfig.


Has anyone got and pointers???

Cheers,

Steve
-- 
Steve Holdoway <steve@greengecko.co.nz>
http://www.greengecko.co.nz
From damien at dalibo.info  Mon Mar  2 01:08:46 2009
From: damien at dalibo.info (damien@dalibo.info)
Date: Mon Mar  2 01:09:31 2009
Subject: [Slony1-general] Can't checkout Slony1-www repository
Message-ID: <49ABA21E.5040404@dalibo.info>

hi !

One year ago, i announced on this list that some french slony users were
gathering to translate the official documentation :

http://listes.postgresql.fr/pipermail/slony-traduction/2008-February/000006.html

The good news is that we're almost done !  In a few days, we will put
online slony's french documentation for both 1.2 and 2.0 branches. The
doc will be available on  postgresql.fr website.

We also want to create slony.fr website, and as we're a bit lazy, we
only want to translate the slony.info website.

Here comes trouble : when we try to fetch the website files, we are
rejected :

$ export CVSROOT=":pserver:anonymous@main.slony.info:/slony1"
$ cvs co slony1-www/
cvs checkout: Updating slony1-www
cvs checkout: failed to create lock directory for `/slony1/slony1-www'
(/slony1/slony1-www/#cvs.lock): Permission denied
cvs checkout: failed to obtain dir lock in repository `/slony1/slony1-www'
cvs [checkout aborted]: read lock failed - giving up

It seems the server doesn't like anonymous login for the slony1-www
repository :-/

Are we doing something the wrong way ? Is there another method to access
these files ?

Regards,

--
damien clochard


From cbbrowne at ca.afilias.info  Mon Mar  2 08:13:15 2009
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Mon Mar  2 08:13:23 2009
Subject: [Slony1-general] how to sync laptop master to server slave?
In-Reply-To: <af7537690902272043m57b957bn215609fd505c0925@mail.gmail.com>
	(Niels Olson's message of "Fri, 27 Feb 2009 22:43:24 -0600")
References: <af7537690902272043m57b957bn215609fd505c0925@mail.gmail.com>
Message-ID: <874oybzyw4.fsf@dba2.int.libertyrms.com>

Niels Olson <niels.olson@gmail.com> writes:
> I'm a medical student running a wiki on my laptop for notes, it's
> critical to have access offline.
>
> book + computer = good
> book + internet = bad
>
> Offline access is more important than online access. But it would be
> awfully nice to have online access when I can't get to my laptop. I
> have identical versions of Postgres (8.3.6) and wiki software. Would
> Slony be able to help with that? Are there any problems with the
> laptop being a laptop, frequently on small local networks without
> valid NAT?
>
> Should I run it the server as master and the laptop as slave?

Unfortunately, I don't think this is likely to be a very good "use
case" for Slony-I.

As per the documentation...

   "Slony-I is a system intended for data centers and backup sites,
   where the normal mode of operation is that all nodes are available
   all the time, and where all nodes can be secured. If you have nodes
   that are likely to regularly drop onto and off of the network, or
   have nodes that cannot be kept secure, Slony-I is probably not the
   ideal replication solution for you."

The trouble with your scenario is that, with sporadic and changing
connectivity, there would be two notable "emergent problems":

 1.  There are parts of Slony-I that expect regular connectivity, and
     "sporadic" will lead to a buildup of "event crud" that will cause
     poor performance.

 2.  Replication has a certain fragility to it; it sounds likely that
     you would need regular reconfiguration in order to reconnect your
     laptop.

I wish the answers were more favourable, but I'd not want you to be
misled into thinking it would all just "work fine."  It *might* work,
but it is quite possible that it could turn out fairly badly :-(.
-- 
"cbbrowne","@","cbbrowne.com"
http://linuxdatabases.info/info/slony.html
"Consistency  is  the  single  most important  aspect  of  *ideology.*
Reality is not nearly so consistent." - <cbbrowne@hex.net>
From steve at greengecko.co.nz  Mon Mar  2 13:06:26 2009
From: steve at greengecko.co.nz (Steve Holdoway)
Date: Mon Mar  2 13:06:50 2009
Subject: [Slony1-general] Slony 2.0.1 installation problems...
In-Reply-To: <20090302193109.ed7e3819.steve@greengecko.co.nz>
References: <20090302193109.ed7e3819.steve@greengecko.co.nz>
Message-ID: <20090303100626.2f256b4c.steve@greengecko.co.nz>

Sorry, complete brain fade. Once I'd installed slony on the client node, all ran fine.

Never could get the hang of Mondays!

Steve
On Mon, 2 Mar 2009 19:31:09 +1300
Steve Holdoway <steve@greengecko.co.nz> wrote:

> Hey folks, 
> 
> Unfortunately there's a few too many unknowns in this one, but if anyone can help I'd be really grateful.
> 
> I have a debian 64bit/postgres 8.3.6/slony 2.0.0 system up and running, and have been happily developing on this
> 
> I Installed from ubuntu hardy,
>  
> ii  postgresql-8.3              8.3.6-0ubuntu8.04                           
> ii  postgresql-client-8.3       8.3.6-0ubuntu8.04                           
> ii  postgresql-client-common    87                                          
> ii  postgresql-common           87                                          
> ii  postgresql-contrib-8.3      8.3.6-0ubuntu8.04                           
> ii  postgresql-doc-8.3          8.3.6-0ubuntu8.04                           
> ii  postgresql-server-dev-8.3   8.3.6-0ubuntu8.04                  
> 
> And built slony 2.0.0 from source. All works fine.
> 
> However, on another server, running 64bit Centos 5.2/postgres 8.3.6/slony 2.0.1, I can't get the slonik store node to run. It fails with 
> 
>  PGRES_FATAL_ERROR load '$libdir/slony1_funcs';  - ERROR:  could not access file "$libdir/slony1_funcs": No such file or directory
> 
> I've installed the following from the pgdg yum repository:
> postgresql-libs-8.3.6-1PGDG.rhel5
> postgresql-pltcl-8.3.6-1PGDG.rhel5
> postgresql-devel-8.3.6-1PGDG.rhel5
> postgresql-8.3.6-1PGDG.rhel5
> postgresql-plperl-8.3.6-1PGDG.rhel5
> postgresql-plpython-8.3.6-1PGDG.rhel5
> postgresql-libs-8.3.6-1PGDG.rhel5
> postgresql-server-8.3.6-1PGDG.rhel5
> postgresql-contrib-8.3.6-1PGDG.rhel5
> 
> And built slony 2.0.1 from scratch. I see that the slony1-funcs.so is installed in /usr/lib64/pgsql, and I've added that directory into /etc/ld.so.conf.d/postgresql.conf and run ldconfig.
> 
> 
> Has anyone got and pointers???
> 
> Cheers,
> 
> Steve
> -- 
> Steve Holdoway <steve@greengecko.co.nz>
> http://www.greengecko.co.nz
> _______________________________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


-- 
Steve Holdoway <steve@greengecko.co.nz>
http://www.greengecko.co.nz
From vivek at khera.org  Mon Mar  2 13:31:16 2009
From: vivek at khera.org (Vick Khera)
Date: Mon Mar  2 13:31:32 2009
Subject: [Slony1-general] how to sync laptop master to server slave?
In-Reply-To: <af7537690902272043m57b957bn215609fd505c0925@mail.gmail.com>
References: <af7537690902272043m57b957bn215609fd505c0925@mail.gmail.com>
Message-ID: <2968dfd60903021331n1aab50ffu459aefbbaac09132@mail.gmail.com>

On Fri, Feb 27, 2009 at 11:43 PM, Niels Olson <niels.olson@gmail.com> wrote:
> I'm a medical student running a wiki on my laptop for notes, it's
> critical to have access offline.
>
> book + computer = good
> book + internet = bad
>

Check out alternate wiki software... for personal notes, I really like
TiddlyWiki as it is 100% self-contained in a single HTML + JavaScript
file.  Just copy it back and forth with your "online" version.  I
assume you don't edit it in multiple places without possibility of
syncing your changes before you move.
From lists at serioustechnology.com  Wed Mar  4 04:49:46 2009
From: lists at serioustechnology.com (Geoffrey)
Date: Wed Mar  4 04:50:24 2009
Subject: [Slony1-general] adding a field to a replicated table
In-Reply-To: <874oyq5md3.fsf@dba2.int.libertyrms.com>
References: <499C2985.8060805@serioustechnology.com>
	<874oyq5md3.fsf@dba2.int.libertyrms.com>
Message-ID: <49AE78EA.1090902@serioustechnology.com>

Christopher Browne wrote:
> Geoffrey <lists@serioustechnology.com> writes:
>> As I've noted in the past, because of our software design, I can not
>> use the 'execute script' process for adding a field to a table.  That
>> being said, I'm looking for an alternative approach.  As it stands,
>> when we need to add a table, we plan to shut slony down, create a new
>> set for that table and restart slony.
>>
>> What would be the best way to add a field to a replicated table using
>> this scenario?  That is, shutting slony down, making the change and
>> starting slony back up.  I'm assuming that I can't simply add the
>> field to both nodes and restart slony, but if that would work, that
>> would be great.
.
.
<snip>
.
.
> The amount of "surgery" you seem to want to do concerns me somewhat...
> It sounds likely to lead to an unhappy ending, and unhappy users
> aren't what we want.

After reviewing your concerns, I've come up with a different approach to 
this problem, which really is probably a whole lot better then my 
previous idea.  That being said, I'm still going to have to set the 
slony triggers to 'fire always' but I'd like some input on my solution.

The idea is that since I'm going to likely have to lock my users out of 
the database when I add a field to a table, why not simply use the 
'execute script' solution anyway.  That is:

1. lock users out
2. execute script ....
3. set slony triggers to 'fire always'
4. let users back in

Two questions about that approach.  First, will it work?  Second, if I 
add a single field to a single table is the slony trigger on that table 
the only one that is removed and re-added?


As for adding a new table is this a reasonable solution:

1. add table to master database
2. create a new set for that table
3. start replicating that set

Or, do I need to shut slony down in order to accomplish this?

Thanks for any insights.

-- 
Until later, Geoffrey

Those who would give up essential Liberty, to purchase a little
temporary Safety, deserve neither Liberty nor Safety.
  - Benjamin Franklin
From lists at serioustechnology.com  Wed Mar  4 12:53:45 2009
From: lists at serioustechnology.com (Geoffrey)
Date: Wed Mar  4 12:54:00 2009
Subject: [Slony1-general] execute script error
Message-ID: <49AEEA59.3000107@serioustechnology.com>

I'm trying to run, what I would think would be a very simple 'execute 
script' but I'm getting:

<stdin>:1: ERROR: syntax error at or near execute

Here is the relevant section of code:


SETID=2
SCRIPT=people.sql


/usr/bin/slonik <<EOF
execute script ( SET ID = $SETID, FILENAME = '$SCRIPT', EVENT NODE = 1);
EOF

What am I missing???

-- 
Until later, Geoffrey

Those who would give up essential Liberty, to purchase a little
temporary Safety, deserve neither Liberty nor Safety.
  - Benjamin Franklin
From JanWieck at Yahoo.com  Wed Mar  4 12:04:10 2009
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Wed Mar  4 12:56:16 2009
Subject: [Slony1-general] execute script error
In-Reply-To: <49AEEA59.3000107@serioustechnology.com>
References: <49AEEA59.3000107@serioustechnology.com>
Message-ID: <49AEDEBA.2070200@Yahoo.com>

On 3/4/2009 3:53 PM, Geoffrey wrote:
> I'm trying to run, what I would think would be a very simple 'execute 
> script' but I'm getting:
> 
> <stdin>:1: ERROR: syntax error at or near execute
> 
> Here is the relevant section of code:
> 
> 
> SETID=2
> SCRIPT=people.sql
> 
> 
> /usr/bin/slonik <<EOF
> execute script ( SET ID = $SETID, FILENAME = '$SCRIPT', EVENT NODE = 1);
> EOF
> 
> What am I missing???
> 

The admin conninfo statements at the beginning of the script.


Jan

-- 
Anyone who trades liberty for security deserves neither
liberty nor security. -- Benjamin Franklin

From lists at serioustechnology.com  Wed Mar  4 13:02:42 2009
From: lists at serioustechnology.com (Geoffrey)
Date: Wed Mar  4 13:02:56 2009
Subject: [Slony1-general] execute script error
In-Reply-To: <49AEEA59.3000107@serioustechnology.com>
References: <49AEEA59.3000107@serioustechnology.com>
Message-ID: <49AEEC72.7060009@serioustechnology.com>

Geoffrey wrote:
> I'm trying to run, what I would think would be a very simple 'execute 
> script' but I'm getting:
> 
> <stdin>:1: ERROR: syntax error at or near execute
> 
> Here is the relevant section of code:
> 
> 
> SETID=2
> SCRIPT=people.sql
> 
> 
> /usr/bin/slonik <<EOF
> execute script ( SET ID = $SETID, FILENAME = '$SCRIPT', EVENT NODE = 1);
> EOF
> 
> What am I missing???

No sooner then I send the message, google got friendly.  Seems I was 
missing the conn info and the cluster name.


-- 
Until later, Geoffrey

Those who would give up essential Liberty, to purchase a little
temporary Safety, deserve neither Liberty nor Safety.
  - Benjamin Franklin
From geof at serioustechnology.com  Wed Mar  4 13:05:28 2009
From: geof at serioustechnology.com (Geoffrey Myers)
Date: Wed Mar  4 13:13:25 2009
Subject: [Slony1-general] execute script question
Message-ID: <49AEED18.6060409@serioustechnology.com>

As I understand it, 'execute script' will cause the slony triggers to be 
deleted and then re-added.  If my 'execute script' only touches one 
table, are all the slony triggers on all tables deleted and re-added, or 
is it only those tables affected by the 'execute script?'

-- 
Geoffrey Myers
Myers Consulting Inc.
770.592.1651
From cbbrowne at ca.afilias.info  Wed Mar  4 15:18:07 2009
From: cbbrowne at ca.afilias.info (cbbrowne)
Date: Wed Mar  4 15:18:25 2009
Subject: [Slony1-general] execute script question
In-Reply-To: <49AEED18.6060409@serioustechnology.com>
References: <49AEED18.6060409@serioustechnology.com>
Message-ID: <49AF0C2F.4010107@ca.afilias.info>

Geoffrey Myers wrote:
> As I understand it, 'execute script' will cause the slony triggers to 
> be deleted and then re-added.  If my 'execute script' only touches one 
> table, are all the slony triggers on all tables deleted and re-added, 
> or is it only those tables affected by the 'execute script?'
>
The script has no way to communicate with slonik to say "I'm just 
touching table1 and table2", so there's no way to avoid the need to 
drop/re-add all of the triggers to all of the tables.

In version 2.0, the 8.3+ capability to alter trigger "modes" is used 
instead, so that the drop/re-add issue goes away.

-- 
output = reverse("ofni.sailifa.ac" "@" "enworbbc")
<http://dba2.int.libertyrms.com/>
Christopher Browne
(416) 673-4124 (land)
"Bother,"  said Pooh,  "Eeyore, ready  two photon  torpedoes  and lock
phasers on the Heffalump, Piglet, meet me in transporter room three"

From tam.mclaughlin at gmail.com  Thu Mar  5 01:47:05 2009
From: tam.mclaughlin at gmail.com (Tam McLaughlin)
Date: Thu Mar  5 01:47:39 2009
Subject: [Slony1-general] Still got bug 73/67 !
Message-ID: <fa4c18050903050147j5b13d35dy46c971b0725b0bf1@mail.gmail.com>

Hi,

We have been getting the error:

ERROR,XX000,"Slony-I: old key column lots_history_data.hold_name IS NULL on
UPDATE",,,,,,"update UK4628.lots_history_data set next_txid =3D 63744 where=
lot
=3D 'K0099X10' and next_txid is null",,

and after some research, this appears to be bug 73, which is a duplicate of
bug 67.

I copied the patch shown in the bugzilla page and tried to patch only for it
to fail. It seems that the reason it failed was that the code already
contained the patch as shown below. Am I missing something or there still a
problem with this bug?

Thanks.
Tam


slony1_funcs.c : line 688
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D
for (i =3D 0, attkind_idx =3D -1; i < tg->tg_relation->rd_att->natts; i++)
                {
                        /*
                         * Ignore dropped columns
                         */
                        if (tupdesc->attrs[i]->attisdropped)
                                continue;

                        attkind_idx++;
                        if (attkind[attkind_idx] !=3D 'k')
                                continue;

------------------------------------------

The versions I am using are below, where slony was downloaded on 5th Feb.

$ psql --version
psql (PostgreSQL) 8.3.3
contains support for command-line editing
$ slon -v
slon version 2.0.0

The structure of the table is:

SET default_with_oids =3D false;

CREATE TABLE lots_history_data (
    txid bigint NOT NULL,
    next_txid bigint,
    lot character varying(20) NOT NULL,
    product character varying(30),
    route character varying(20),
    operation integer,
    next_std_route character varying(20),
    next_std_oper integer,
    lot_is_parent character(1) DEFAULT 'N'::bpchar,
    qty real,
    owner character varying(20),
    due_date date,
    terminated character(1) DEFAULT 'N'::bpchar,
    hot_lot character(1) DEFAULT 'N'::bpchar,
    restricted character(1) DEFAULT 'N'::bpchar,
    in_rework character(1) DEFAULT 'N'::bpchar,
    kitt_comp character(1) DEFAULT 'N'::bpchar,
    in_transit character(1) DEFAULT 'N'::bpchar,
    in_non_seq_mode character(1) DEFAULT 'N'::bpchar,
    on_hold character(1) DEFAULT 'N'::bpchar,
    in_process character(1) DEFAULT 'Y'::bpchar,
    unit_trace character(1) DEFAULT 'N'::bpchar,
    sub_products character(1) DEFAULT 'N'::bpchar,
    allo_comp character(1) DEFAULT 'N'::bpchar,
    movein_reqd character(1) DEFAULT 'N'::bpchar,
    script_id character varying(20),
    script_ver numeric,
    script_step integer,
    next_script_id character varying(20),
    next_script_ver numeric,
    next_script_step integer,
    child_of character varying(20),
    hold_cat character varying(20),
    hold_name character varying(20),
hold_note character varying(80),
    lotname character varying(20),
    eng_owner character varying(40),
    stores character(1) DEFAULT 'N'::bpchar,
    own_entity character varying(20),
    password character varying(20),
    created timestamp without time zone,
    updated timestamp without time zone,
    main_route character varying(20),
    main_seqno integer,
    seqno integer
);

ALTER TABLE uk4628.lots_history_data OWNER TO mes;

ALTER TABLE ONLY lots_history_data
    ADD CONSTRAINT lots_history_data_pk PRIMARY KEY (txid, lot);
CREATE INDEX lot_history_data_lot_next_txid_idx ON lots_history_data
USINGbtree (lot, next_txid);

CREATE INDEX lots_history_data_next_idx ON lots_history_data USING btree
(next_txid);

CREATE TRIGGER _mesrep_denyaccess
    BEFORE INSERT OR DELETE OR UPDATE ON lots_history_data
    FOR EACH ROW
    EXECUTE PROCEDURE _mesrep.denyaccess('_mesrep');

ALTER TABLE lots_history_data DISABLE TRIGGER _mesrep_denyaccess;

CREATE TRIGGER _mesrep_logtrigger
    AFTER INSERT OR DELETE OR UPDATE ON lots_history_data
    FOR EACH ROW
    EXECUTE PROCEDURE _mesrep.logtrigger('_mesrep', '83', 'kvk');

ALTER TABLE ONLY lots_history_data
    ADD CONSTRAINT lots_history_data_lot_fkey FOREIGN KEY (lot)
REFERENCESlots(lot);

REVOKE ALL ON TABLE lots_history_data FROM PUBLIC;
REVOKE ALL ON TABLE lots_history_data FROM mes;
GRANT ALL ON TABLE lots_history_data TO mes;
GRANT SELECT ON TABLE lots_history_data TO mesview;
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20090305/=
c4249d1c/attachment.htm
From tam.mclaughlin at gmail.com  Thu Mar  5 03:02:48 2009
From: tam.mclaughlin at gmail.com (Tam McLaughlin)
Date: Thu Mar  5 03:03:25 2009
Subject: [Slony1-general] Re: Still got bug 73/67 !
In-Reply-To: <fa4c18050903050147j5b13d35dy46c971b0725b0bf1@mail.gmail.com>
References: <fa4c18050903050147j5b13d35dy46c971b0725b0bf1@mail.gmail.com>
Message-ID: <fa4c18050903050302vc21a9b0ya8cc56db97a906da@mail.gmail.com>

I have now updated to 2.0.1 so will check if this makes a difference.

On Thu, Mar 5, 2009 at 9:47 AM, Tam McLaughlin <tam.mclaughlin@gmail.com>wr=
ote:

> Hi,
>
> We have been getting the error:
>
> ERROR,XX000,"Slony-I: old key column lots_history_data.hold_name IS NULL =
on
> UPDATE",,,,,,"update UK4628.lots_history_data set next_txid =3D 63744 whe=
relot
> =3D 'K0099X10' and next_txid is null",,
>
> and after some research, this appears to be bug 73, which is a duplicate =
of
> bug 67.
>
> I copied the patch shown in the bugzilla page and tried to patch only for
> it to fail. It seems that the reason it failed was that the code already
> contained the patch as shown below. Am I missing something or there still=
 a
> problem with this bug?
>
> Thanks.
> Tam
>
>
> slony1_funcs.c : line 688
> =3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D
> for (i =3D 0, attkind_idx =3D -1; i < tg->tg_relation->rd_att->natts; i++)
>                 {
>                         /*
>                          * Ignore dropped columns
>                          */
>                         if (tupdesc->attrs[i]->attisdropped)
>                                 continue;
>
>                         attkind_idx++;
>                         if (attkind[attkind_idx] !=3D 'k')
>                                 continue;
>
> ------------------------------------------
>
> The versions I am using are below, where slony was downloaded on 5th Feb.
>
> $ psql --version
> psql (PostgreSQL) 8.3.3
> contains support for command-line editing
> $ slon -v
> slon version 2.0.0
>
> The structure of the table is:
>
> SET default_with_oids =3D false;
>
> CREATE TABLE lots_history_data (
>     txid bigint NOT NULL,
>     next_txid bigint,
>     lot character varying(20) NOT NULL,
>     product character varying(30),
>     route character varying(20),
>     operation integer,
>     next_std_route character varying(20),
>     next_std_oper integer,
>     lot_is_parent character(1) DEFAULT 'N'::bpchar,
>     qty real,
>     owner character varying(20),
>     due_date date,
>     terminated character(1) DEFAULT 'N'::bpchar,
>     hot_lot character(1) DEFAULT 'N'::bpchar,
>     restricted character(1) DEFAULT 'N'::bpchar,
>     in_rework character(1) DEFAULT 'N'::bpchar,
>     kitt_comp character(1) DEFAULT 'N'::bpchar,
>     in_transit character(1) DEFAULT 'N'::bpchar,
>     in_non_seq_mode character(1) DEFAULT 'N'::bpchar,
>     on_hold character(1) DEFAULT 'N'::bpchar,
>     in_process character(1) DEFAULT 'Y'::bpchar,
>     unit_trace character(1) DEFAULT 'N'::bpchar,
>     sub_products character(1) DEFAULT 'N'::bpchar,
>     allo_comp character(1) DEFAULT 'N'::bpchar,
>     movein_reqd character(1) DEFAULT 'N'::bpchar,
>     script_id character varying(20),
>     script_ver numeric,
>     script_step integer,
>     next_script_id character varying(20),
>     next_script_ver numeric,
>     next_script_step integer,
>     child_of character varying(20),
>     hold_cat character varying(20),
>     hold_name character varying(20),
> hold_note character varying(80),
>     lotname character varying(20),
>     eng_owner character varying(40),
>     stores character(1) DEFAULT 'N'::bpchar,
>     own_entity character varying(20),
>     password character varying(20),
>     created timestamp without time zone,
>     updated timestamp without time zone,
>     main_route character varying(20),
>     main_seqno integer,
>     seqno integer
> );
>
> ALTER TABLE uk4628.lots_history_data OWNER TO mes;
>
> ALTER TABLE ONLY lots_history_data
>     ADD CONSTRAINT lots_history_data_pk PRIMARY KEY (txid, lot);
> CREATE INDEX lot_history_data_lot_next_txid_idx ON lots_history_data
> USINGbtree (lot, next_txid);
>
> CREATE INDEX lots_history_data_next_idx ON lots_history_data USING btree
> (next_txid);
>
> CREATE TRIGGER _mesrep_denyaccess
>     BEFORE INSERT OR DELETE OR UPDATE ON lots_history_data
>     FOR EACH ROW
>     EXECUTE PROCEDURE _mesrep.denyaccess('_mesrep');
>
> ALTER TABLE lots_history_data DISABLE TRIGGER _mesrep_denyaccess;
>
> CREATE TRIGGER _mesrep_logtrigger
>     AFTER INSERT OR DELETE OR UPDATE ON lots_history_data
>     FOR EACH ROW
>     EXECUTE PROCEDURE _mesrep.logtrigger('_mesrep', '83', 'kvk');
>
> ALTER TABLE ONLY lots_history_data
>     ADD CONSTRAINT lots_history_data_lot_fkey FOREIGN KEY (lot)
> REFERENCESlots(lot);
>
> REVOKE ALL ON TABLE lots_history_data FROM PUBLIC;
> REVOKE ALL ON TABLE lots_history_data FROM mes;
> GRANT ALL ON TABLE lots_history_data TO mes;
> GRANT SELECT ON TABLE lots_history_data TO mesview;
>
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20090305/=
5e311c24/attachment-0001.htm
From threshar at torgo.978.org  Thu Mar  5 07:59:40 2009
From: threshar at torgo.978.org (Jeff)
Date: Thu Mar  5 07:59:52 2009
Subject: [Slony1-general] Cascaded Slaves & sl_log bloat prevention?
Message-ID: <E24CCC15-E45B-4F08-A3D4-380B79754D78@torgo.978.org>

I've got a situation that I've lived with for a while, but its finally  
ticked me off enough (and I've finally got time to deal with it!) to  
do something about it. I just need to confirm one tiny detail.

In my current setup I have a master and several slaves.  One of these  
slaves is for servicing the website, another is for crunching data.    
Now, the problem that is happening is the crunch box can get quite  
lagged when crunching data - we're talking 9-10 hours.  Slony is  
running, but the crunch gobbles up so much IO and CPU that it cannot  
keep up with our rather high replication loads.  This in turn causes  
lag to build up on the master as crunch is behind, it can't purge  
records from sl_log_x.  This in turn causes the web-db to lag because  
the query to fetch new data is taking a long time.   I've analyzed the  
queries used, they seem sane, but there is just so much data in sl_log  
that its cpu bound. (Right now I've got about 12M rows in sl_log, it  
ends up having to filter 10M of those through xxid_xx_snapshot()).

Now, (before you all start saying "bah, buy more disks") things are  
fine under low load or smaller crunches, its just when we fire up a  
massive job this happens.  We've got some more hardware coming in, but  
it will only lessen the problem, not cure it.

So, my current thinking is if I setup a slave off of prod, lets call  
him crunchmaster and then have the existing crunch box sync off of  
crunchmaster will that insulate prod from crunch getting lagged? (as  
in, if crunchmaster is in sync, will prod be able to purge from  
sl_log, but crunchmaster's sl_logs will continue to grow until crunch  
is caught up?)

thanks guys!

--
Jeff Trout <jeff@jefftrout.com>
http://www.stuarthamm.net/
http://www.dellsmartexitin.com/



From stuart at stuartbishop.net  Thu Mar  5 08:41:52 2009
From: stuart at stuartbishop.net (Stuart Bishop)
Date: Thu Mar  5 08:42:00 2009
Subject: [Slony1-general] Cascaded Slaves & sl_log bloat prevention?
In-Reply-To: <E24CCC15-E45B-4F08-A3D4-380B79754D78@torgo.978.org>
References: <E24CCC15-E45B-4F08-A3D4-380B79754D78@torgo.978.org>
Message-ID: <6bc73d4c0903050841u184b346cq4b314c3dbd5b35b5@mail.gmail.com>

On Thu, Mar 5, 2009 at 10:59 AM, Jeff <threshar@torgo.978.org> wrote:

> Now, (before you all start saying "bah, buy more disks") things are fine
> under low load or smaller crunches, its just when we fire up a massive job
> this happens. ?We've got some more hardware coming in, but it will only
> lessen the problem, not cure it.

If your crunching allows you do do so, you might want to poll the
current replication lag occasionally and pause the process if you are
lagged above some threshold of your choosing.

> So, my current thinking is if I setup a slave off of prod, lets call him
> crunchmaster and then have the existing crunch box sync off of crunchmaster
> will that insulate prod from crunch getting lagged? (as in, if crunchmaster
> is in sync, will prod be able to purge from sl_log, but crunchmaster's
> sl_logs will continue to grow until crunch is caught up?)

Dunno :-)


-- 
Stuart Bishop <stuart@stuartbishop.net>
http://www.stuartbishop.net/
From threshar at torgo.978.org  Thu Mar  5 08:52:13 2009
From: threshar at torgo.978.org (Jeff)
Date: Thu Mar  5 08:52:52 2009
Subject: [Slony1-general] Cascaded Slaves & sl_log bloat prevention?
In-Reply-To: <6bc73d4c0903050841u184b346cq4b314c3dbd5b35b5@mail.gmail.com>
References: <E24CCC15-E45B-4F08-A3D4-380B79754D78@torgo.978.org>
	<6bc73d4c0903050841u184b346cq4b314c3dbd5b35b5@mail.gmail.com>
Message-ID: <0F766547-2AA5-44F9-8A8C-E8C6E06FA177@torgo.978.org>


On Mar 5, 2009, at 11:41 AM, Stuart Bishop wrote:

> On Thu, Mar 5, 2009 at 10:59 AM, Jeff <threshar@torgo.978.org> wrote:
>
>> Now, (before you all start saying "bah, buy more disks") things are  
>> fine
>> under low load or smaller crunches, its just when we fire up a  
>> massive job
>> this happens.  We've got some more hardware coming in, but it will  
>> only
>> lessen the problem, not cure it.
>
> If your crunching allows you do do so, you might want to poll the
> current replication lag occasionally and pause the process if you are
> lagged above some threshold of your choosing.

Now that is an interesting idea. I'd probably put it in as a stop-gap  
measure though.
If a crunch is already taking a while, this will just extend that, but  
on the upside, it won't mess up others things as much.


--
Jeff Trout <jeff@jefftrout.com>
http://www.stuarthamm.net/
http://www.dellsmartexitin.com/



From threshar at torgo.978.org  Thu Mar  5 12:22:21 2009
From: threshar at torgo.978.org (Jeff)
Date: Thu Mar  5 12:23:04 2009
Subject: [Slony1-general] Cascaded Slaves & sl_log bloat prevention?
In-Reply-To: <E24CCC15-E45B-4F08-A3D4-380B79754D78@torgo.978.org>
References: <E24CCC15-E45B-4F08-A3D4-380B79754D78@torgo.978.org>
Message-ID: <DA9E2385-9476-4F0C-9A1C-AB648CEC4F28@torgo.978.org>


On Mar 5, 2009, at 10:59 AM, Jeff wrote:
>
> So, my current thinking is if I setup a slave off of prod, lets call  
> him crunchmaster and then have the existing crunch box sync off of  
> crunchmaster will that insulate prod from crunch getting lagged? (as  
> in, if crunchmaster is in sync, will prod be able to purge from  
> sl_log, but crunchmaster's sl_logs will continue to grow until  
> crunch is caught up?)
>

I was able to do some testing on this today.
it appears this does not occur.

So far the only way I've figured out how to do this is to run 2 slony  
instances.
One for replicating to webdb and crunchmaster, and another for  
replicating from crunchmaster to crunch.  I just tested this and sure  
enough,  even though crunch is "lagged"  (I simply shut slon off to  
simulate it being lagged) the prod sl_logs get trimmed.

anybody have any other possible solutions? this solution seems quite  
kludgey to me.



> thanks guys!
>
> --
> Jeff Trout <jeff@jefftrout.com>
> http://www.stuarthamm.net/
> http://www.dellsmartexitin.com/
>
>
>
> _______________________________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general

--
Jeff Trout <jeff@jefftrout.com>
http://www.stuarthamm.net/
http://www.dellsmartexitin.com/



From stuart at stuartbishop.net  Thu Mar  5 22:42:24 2009
From: stuart at stuartbishop.net (Stuart Bishop)
Date: Thu Mar  5 22:42:52 2009
Subject: [Slony1-general] repair config failing
Message-ID: <6bc73d4c0903052242h47a7a27fsff31235f4c2ab65f@mail.gmail.com>

Any idea what is going on here?

$ slonik << EOM
> cluster name = sl;
> node 1 admin conninfo = 'dbname=lpmain_staging_new user=slony';
> repair config (set id=1, event node=1, execute only on=1);
> EOM
<stdin>:3: PGRES_FATAL_ERROR select "_sl".updateReloid(1, 1);  -
ERROR:  duplicate key value violates unique constraint
"sl_table_tab_reloid_key"
CONTEXT:  SQL statement "update "_sl".sl_table set tab_reloid =
PGC.oid from pg_catalog.pg_class PGC, pg_catalog.pg_namespace PGN
where "_sl".slon_quote_brute("_sl".sl_table.tab_relname) =
"_sl".slon_quote_brute(PGC.relname) and PGC.relnamespace = PGN.oid and
"_sl".slon_quote_brute(PGN.nspname) =
"_sl".slon_quote_brute("_sl".sl_table.tab_nspname)"
PL/pgSQL function "updatereloid" line 39 at SQL statement


The database is a freshly restored dump of the master node.

Slony is 1.2.13

-- 
Stuart Bishop <stuart@stuartbishop.net>
http://www.stuartbishop.net/
From lists at serioustechnology.com  Fri Mar  6 02:21:35 2009
From: lists at serioustechnology.com (Geoffrey)
Date: Fri Mar  6 02:22:11 2009
Subject: [Slony1-general] successfully added a field to a replicated database
Message-ID: <49B0F92F.9090201@serioustechnology.com>

I simply want to thank the list and in particular, Christopher Browne, 
for your patience in assisting me with updating our replicated databases 
DDL.  This morning, I successfully added a field to a table on 12 
replicated databases.  It was still a relatively complex process as I 
had to reset the slony triggers on the master node once I updated the 
table via the 'execute script' mechanism.  The basic process was as such:

1. lock all users out of the database by modifying the pg_hba.conf file 
and restart the postmaster.
2. update the table via 'execute script'
3. reset the slony triggers to 'fire always'
4. allow user access by returning pg_hba.conf to it's original and 
restarting the postmaster.

Thanks again for all the input and patience of the list.

-- 
Until later, Geoffrey

Those who would give up essential Liberty, to purchase a little
temporary Safety, deserve neither Liberty nor Safety.
  - Benjamin Franklin
From post at bastian-voigt.de  Fri Mar  6 05:19:16 2009
From: post at bastian-voigt.de (Bastian Voigt)
Date: Fri Mar  6 05:19:50 2009
Subject: [Slony1-general] Some small errors in the documentation
Message-ID: <91A0DCC6-D4F3-41D7-B57A-089890EDF89F@bastian-voigt.de>

Dear list,

just getting started with Slony 2.0.1 and going through the  
documentation, so I found some small errors in the chapter "2.  
Replicating Your First Database":

1. The line:
psql -U $PGBENCH_USER -h $HOST1 -d $DBNAME1 -c "begin; alter table
history add column id serial; update history set id =
nextval('history_id_seq'); alter table history add primary key(id);
commit"

should rather be:
sql -U $PGBENCHUSER -h $MASTERHOST -d $MASTERDBNAME -c "begin; alter  
table
history add column id serial; update history set id =
nextval('history_id_seq'); alter table history add primary key(id);
commit"


2. In the slonik script, this section should be removed since 2.0 no  
longer uses "table add key":

	#--
	# Because the history table does not have a primary key or other unique
	# constraint that could be used to identify a row, we need to add one.
	# The following command adds a bigint column named
	# _Slony-I_$CLUSTERNAME_rowID to the table.  It will have a default  
value
	# of nextval('_$CLUSTERNAME.s1_rowid_seq'), and have UNIQUE and NOT  
NULL
	# constraints applied.  All existing rows will be initialized with a
	# number
	#--
	table add key (node id = 1, fully qualified name = 'public.history');


Hope this helps to keep the docu up to date ;.-)

All the best
Bastian
From post at bastian-voigt.de  Fri Mar  6 06:45:27 2009
From: post at bastian-voigt.de (Bastian Voigt)
Date: Fri Mar  6 06:46:03 2009
Subject: [Slony1-general] Another error in the slony 2.0.1 docs
Message-ID: <08D3F986-4643-4EDC-B0A7-5E667953A39E@bastian-voigt.de>

Dear list,

in slony 2.0, apparently the "EVENT NODE" parameter is required for  
"STORE EVENT" slonik commands.


The slonik script given in the documentation in chapter "2.  
Replicating Your First Database" uses this command without the "STORE  
EVENT" parameter:

	#--
	# Create the second node (the slave) tell the 2 nodes how to connect to
	# each other and how they should listen for events.
	#--

	store node (id=2, comment = 'Slave node');


  thus generating an error message:

createcluster.slonik:51: Error: require EVENT NODE
createcluster.slonik:51: Error: No admin conninfo provided for node -1


I think the command should rather be:

store node (id=2, comment = 'Slave node', event node = 1);

Pls correct me if I'm wrong.


Cheers,
Bastian
From vivek at khera.org  Fri Mar  6 06:47:51 2009
From: vivek at khera.org (Vick Khera)
Date: Fri Mar  6 06:47:57 2009
Subject: [Slony1-general] repair config failing
In-Reply-To: <6bc73d4c0903052242h47a7a27fsff31235f4c2ab65f@mail.gmail.com>
References: <6bc73d4c0903052242h47a7a27fsff31235f4c2ab65f@mail.gmail.com>
Message-ID: <2968dfd60903060647see16580l78d6056ec8160a5b@mail.gmail.com>

On Fri, Mar 6, 2009 at 1:42 AM, Stuart Bishop <stuart@stuartbishop.net> wrote:
> The database is a freshly restored dump of the master node.

I do not think you can do that.  You need to strip the slony stuff
before you do the restore (or after).  Then re-enable replication by
adding it as a node.
From cbbrowne at ca.afilias.info  Fri Mar  6 10:51:38 2009
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Fri Mar  6 10:51:50 2009
Subject: [Slony1-general] Another error in the slony 2.0.1 docs
In-Reply-To: <08D3F986-4643-4EDC-B0A7-5E667953A39E@bastian-voigt.de> (Bastian
	Voigt's message of "Fri, 6 Mar 2009 15:45:27 +0100")
References: <08D3F986-4643-4EDC-B0A7-5E667953A39E@bastian-voigt.de>
Message-ID: <87bpseqybp.fsf@dba2.int.libertyrms.com>

Bastian Voigt <post@bastian-voigt.de> writes:
> I think the command should rather be:
>
> store node (id=2, comment = 'Slave node', event node = 1);
>
> Pls correct me if I'm wrong.

Correct!

I'll commit that shortly.

Thanks for pointing it out!
-- 
output = reverse("ofni.sailifa.ac" "@" "enworbbc")
<http://dba2.int.libertyrms.com/>
Christopher Browne
(416) 673-4124 (land)
"Bother,"  said Pooh,  "Eeyore, ready  two photon  torpedoes  and lock
phasers on the Heffalump, Piglet, meet me in transporter room three"
From cbbrowne at ca.afilias.info  Fri Mar  6 10:54:46 2009
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Fri Mar  6 10:54:56 2009
Subject: [Slony1-general] Some small errors in the documentation
In-Reply-To: <91A0DCC6-D4F3-41D7-B57A-089890EDF89F@bastian-voigt.de> (Bastian
	Voigt's message of "Fri, 6 Mar 2009 14:19:16 +0100")
References: <91A0DCC6-D4F3-41D7-B57A-089890EDF89F@bastian-voigt.de>
Message-ID: <877i32qy6h.fsf@dba2.int.libertyrms.com>

Bastian Voigt <post@bastian-voigt.de> writes:
> just getting started with Slony 2.0.1 and going through the
> documentation, so I found some small errors in the chapter "2.
> Replicating Your First Database":

All committed to HEAD+2.0, so it'll be part of 2.0.2.  Thanks!
-- 
output = reverse("ofni.sailifa.ac" "@" "enworbbc")
<http://dba2.int.libertyrms.com/>
Christopher Browne
(416) 673-4124 (land)
"Bother,"  said Pooh,  "Eeyore, ready  two photon  torpedoes  and lock
phasers on the Heffalump, Piglet, meet me in transporter room three"
From dmitry at koterov.ru  Fri Mar  6 14:40:33 2009
From: dmitry at koterov.ru (Dmitry Koterov)
Date: Fri Mar  6 14:40:49 2009
Subject: [Slony1-general] EXECUTE SCRIPT and then UPDATE with logTrigger
	firing within a SINGLE transaction?
Message-ID: <d7df81620903061440n3c1068dfr98a0904adf197b4@mail.gmail.com>

Hello.

I work with Slony for about 2 years in a heavy-loaded web site. I'd like to
mix DDL and DML code to perform them in a single transaction (in deployment
procedure it would be very handy and important).

Digging the source of slonik and _schemadoc I assumed that I possibly could
do it via slonik
(for better readability I replaced FILENAME=3D'xxx' clause by the content of
xxx itself):


-- Perform my DDL modifications.
EXECUTE SCRIPT {
  ALTER TABLE tbl ADD COLUMN id_copy INTEGER;
}

EXECUTE SCRIPT {
  -- This is needed to deny execution of this SQL in other nodes.
  EXECUTE ONLY ON =3D <my_origin_node>

  -- Temporariy turn on replication mode.
  SET session_replication_role TO origin;
  -- Perform my DML operations. They will be replicated via logTrigger as
usual.
  UPDATE tbl SET id_copy =3D id;
  UPDATE tbl SET abc =3D 123;
  -- Reset replication mode back.
  SET session_replication_role TO local;
}

-- Perform any other DDL modifications.
EXECUTE SCRIPT {
  ALTER TABLE tbl ADD COLUMN c INTEGER;
}
...

Please say would this method work without side effects or not?
Thank you!

B.r.,
  Dmitry Koterov,
  chief architect at MoiKrug.Ru, Yandex, Moscow.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20090307/=
18d48973/attachment.htm
From karl at denninger.net  Fri Mar  6 19:34:50 2009
From: karl at denninger.net (Karl Denninger)
Date: Fri Mar  6 19:35:14 2009
Subject: [Slony1-general] How Do I remove all traces of a cluster? 
Message-ID: <49B1EB5A.70209@denninger.net>

I have been dorking around with setting up replication and while I seem =

to be able to remove sets and such, I have been unable to drop an entire =

cluster.

Can that be done?

Also, what tables do I query to see what slony has configured in it in a =

"total view" perspective?

Thanks in advance.

-- =

--
Karl Denninger
karl@denninger.net


-------------- next part --------------
A non-text attachment was scrubbed...
Name: karl.vcf
Type: text/x-vcard
Size: 124 bytes
Desc: not available
Url : http://lists.slony.info/pipermail/slony1-general/attachments/20090306=
/8eedc65e/karl.vcf
From very.shafrudin at gmail.com  Fri Mar  6 21:46:50 2009
From: very.shafrudin at gmail.com (shafrudin)
Date: Fri Mar  6 22:13:22 2009
Subject: [Slony1-general] adding table via slony-i execute script using pgadmin
Message-ID: <22384699.post@talk.nabble.com>


i hope there is someone can help me and i hope this forum is being useful
i create replicated table in postgresql and i using slony-I as replication
s/w but there is problem,when i want to add new tabel ... 
i read pgadmin documentation and in documentation says can execute slony ddl
execute script via pgadmin..
i follow the step but nothing work...
can anyone help me??
i want to execute slony script via pgadmin to add the tables.....
i hope documentation doesnt lie....
-- 
View this message in context: http://www.nabble.com/adding-table-via-slony-i-execute-script-using-pgadmin-tp22384699p22384699.html
Sent from the Slony-I -- General mailing list archive at Nabble.com.

From ajs at crankycanuck.ca  Sat Mar  7 06:37:13 2009
From: ajs at crankycanuck.ca (Andrew Sullivan)
Date: Sat Mar  7 06:37:22 2009
Subject: [Slony1-general] How Do I remove all traces of a cluster?
In-Reply-To: <49B1EB5A.70209@denninger.net>
References: <49B1EB5A.70209@denninger.net>
Message-ID: <20090307143713.GA15014@shinkuro.com>

On Fri, Mar 06, 2009 at 09:34:50PM -0600, Karl Denninger wrote:
> I have been dorking around with setting up replication and while I seem  
> to be able to remove sets and such, I have been unable to drop an entire  
> cluster.
>
> Can that be done?

The tools have a way (I forget the way to spell it at the moment).  If
you've broken what the tools expect, however, you can also DROP the
slony SCHEMA CASCADE, which gets rid of the trigger function which
also forces the triggers to get dropped.  It does not fix up your
tables if you've allowed Slony to add synthetic keys.

A

-- 
Andrew Sullivan
ajs@crankycanuck.ca
From karl at denninger.net  Sat Mar  7 20:02:59 2009
From: karl at denninger.net (Karl Denninger)
Date: Sat Mar  7 20:03:22 2009
Subject: [Slony1-general] Multiple databases = multiple clusters?
Message-ID: <49B34373.7070407@denninger.net>

The documentation has gotten me through replicating one database.

Ok, I now I have another one on the same machine going to the same =

destination.  Its a different database with obviously different tables.

Am I correct that I need only one "slon" process per computer (or =

Postgresql instance) but that when I set up other replication sets for =

different databases I set them up as different clusters?

-- =

--
Karl Denninger
karl@denninger.net


-------------- next part --------------
A non-text attachment was scrubbed...
Name: karl.vcf
Type: text/x-vcard
Size: 124 bytes
Desc: not available
Url : http://lists.slony.info/pipermail/slony1-general/attachments/20090307=
/4b042dd2/karl.vcf
From dmitry at koterov.ru  Sun Mar  8 15:56:20 2009
From: dmitry at koterov.ru (Dmitry Koterov)
Date: Sun Mar  8 15:56:40 2009
Subject: [Slony1-general] Re: EXECUTE SCRIPT and then UPDATE with logTrigger
	firing within a SINGLE transaction?
In-Reply-To: <d7df81620903061440n3c1068dfr98a0904adf197b4@mail.gmail.com>
References: <d7df81620903061440n3c1068dfr98a0904adf197b4@mail.gmail.com>
Message-ID: <d7df81620903081556j3c11bae2n73abae02256d2057@mail.gmail.com>

Unfortunately, this method does not work.

Because we cannot have more than one separated group of sl_log items within
a single transaction: sl_event SYNC contain information only about xid, not
about sequence of sl_log item. So, if we have

xid=3D123: (0) SYNC
xid=3D123: (1) DDL_SCRIPT
xid=3D123: (2) SYNC
xid=3D123: (3) DDL_SCRIPT

then slon cannot detect are sl_log items of (2) SYNC were performed
*before*(3) DDL_SCRIPT or
*after* it. And the following sequence becomes broken:

(1) ALTER TABLE a ADD COLUMN id_copy INTEGER;
(2) UPDATE a SET id_copy =3D id;
(3) ALTER TABLE a RENAME COLUMN id_copy TO abcd;

But, while digging the source, I have suddenly found 2 bugs. I reported them
here (with solution patches attached):
http://www.slony.info/bugzilla/show_bug.cgi?id=3D75



On Sat, Mar 7, 2009 at 1:40 AM, Dmitry Koterov <dmitry@koterov.ru> wrote:

> Hello.
>
> I work with Slony for about 2 years in a heavy-loaded web site. I'd like =
to
> mix DDL and DML code to perform them in a single transaction (in deployme=
nt
> procedure it would be very handy and important).
>
> Digging the source of slonik and _schemadoc I assumed that I possibly cou=
ld
> do it via slonik
> (for better readability I replaced FILENAME=3D'xxx' clause by the content=
 of
> xxx itself):
>
>
> -- Perform my DDL modifications.
> EXECUTE SCRIPT {
>   ALTER TABLE tbl ADD COLUMN id_copy INTEGER;
> }
>
> EXECUTE SCRIPT {
>   -- This is needed to deny execution of this SQL in other nodes.
>   EXECUTE ONLY ON =3D <my_origin_node>
>
>   -- Temporariy turn on replication mode.
>   SET session_replication_role TO origin;
>   -- Perform my DML operations. They will be replicated via logTrigger as
> usual.
>   UPDATE tbl SET id_copy =3D id;
>   UPDATE tbl SET abc =3D 123;
>   -- Reset replication mode back.
>   SET session_replication_role TO local;
> }
>
> -- Perform any other DDL modifications.
> EXECUTE SCRIPT {
>   ALTER TABLE tbl ADD COLUMN c INTEGER;
> }
> ...
>
> Please say would this method work without side effects or not?
> Thank you!
>
> B.r.,
>   Dmitry Koterov,
>   chief architect at MoiKrug.Ru, Yandex, Moscow.
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20090309/=
c7dbccdc/attachment.htm
From ashishka at synechron.com  Mon Mar  9 03:28:16 2009
From: ashishka at synechron.com (Ashish Karalkar)
Date: Mon Mar  9 03:28:55 2009
Subject: [Slony1-general] How Do I remove all traces of a cluster?
In-Reply-To: <20090307143713.GA15014@shinkuro.com>
References: <49B1EB5A.70209@denninger.net>
	<20090307143713.GA15014@shinkuro.com>
Message-ID: <49B4EF40.9040204@synechron.com>

Andrew Sullivan wrote:
> On Fri, Mar 06, 2009 at 09:34:50PM -0600, Karl Denninger wrote:
>   
>> I have been dorking around with setting up replication and while I seem  
>> to be able to remove sets and such, I have been unable to drop an entire  
>> cluster.
>>
>> Can that be done?
>>     
>
> The tools have a way (I forget the way to spell it at the moment).  If
> you've broken what the tools expect, however, you can also DROP the
> slony SCHEMA CASCADE, which gets rid of the trigger function which
> also forces the triggers to get dropped.  It does not fix up your
> tables if you've allowed Slony to add synthetic keys.
>
> A
>
>   
In one of my cases I found that  if you do a "DROP SCHEMA CASCADE" on a 
slave node then all the user defined triggers which slony parked in 
virtually disable state on a slave node will not come back.
Plz. Correct me if I am wrong. I think I did this on Slony 1.2.14 few 
months back and faced the same problem with DROP SCHEMA CASCADE.

---Ashish
 
From kevink at consistentstate.com  Mon Mar  9 05:38:32 2009
From: kevink at consistentstate.com (Kevin Kempter)
Date: Mon Mar  9 05:38:37 2009
Subject: [Slony1-general] no timestamps in the slon logs
Message-ID: <200903090638.33028.kevink@consistentstate.com>

Were running slony I 1.2.0.1 - no matter what we do we have no timestamps in 
the slon logs.

Thoughts ?

Thanks in advance
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20090309/584edc23/attachment.htm
From cbbrowne at ca.afilias.info  Mon Mar  9 08:20:54 2009
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Mon Mar  9 08:21:03 2009
Subject: [Slony1-general] How Do I remove all traces of a cluster?
In-Reply-To: <49B1EB5A.70209@denninger.net> (Karl Denninger's message of "Fri, 
	06 Mar 2009 21:34:50 -0600")
References: <49B1EB5A.70209@denninger.net>
Message-ID: <87iqmipvs9.fsf@dba2.int.libertyrms.com>

Karl Denninger <karl@denninger.net> writes:
> I have been dorking around with setting up replication and while I
> seem to be able to remove sets and such, I have been unable to drop an
> entire cluster.
>
> Can that be done?

That needs to be done by uninstalling Slony-I on each node.

The relevant Slonik command is UNINSTALL NODE:
   <http://www.slony.info/adminguide/slony1-1.2.6/doc/adminguide/stmtuninstallnode.html>

If you have 5 nodes, you'd need to run UNINSTALL NODE against each
one.

> Also, what tables do I query to see what slony has configured in it
> in a "total view" perspective?

I'm not quite sure what you mean by "total view perspective."

Each of the tables in the Slony-I schema contains some aspect of "what
is configured" *except* for those that contain history/logging
information.

 - sl_node contains the list of nodes
 - sl_table contains the list of replicated tables
 - sl_sequence contains the list of replicated sequences
 - sl_path contains configuration surrounding how slon processes
   communicate with other nodes

Those are the "heavy hitters" as far as the grand scheme of
configuration is concerned; the other tables tend to contain somewhat
less interesting information (that is nonetheless necessary :-)).
-- 
output = reverse("ofni.secnanifxunil" "@" "enworbbc")
http://cbbrowne.com/info/internet.html
Rules of  the Evil Overlord  #136. "If I  build a bomb, I  will simply
remember which wire to cut if  it has to be deactivated and make every
wire red." <http://www.eviloverlord.com/>
From cbbrowne at ca.afilias.info  Mon Mar  9 08:26:56 2009
From: cbbrowne at ca.afilias.info (Christopher Browne)
Date: Mon Mar  9 08:27:04 2009
Subject: [Slony1-general] Multiple databases = multiple clusters?
In-Reply-To: <49B34373.7070407@denninger.net> (Karl Denninger's message of
	"Sat, 07 Mar 2009 22:02:59 -0600")
References: <49B34373.7070407@denninger.net>
Message-ID: <87eix6pvi7.fsf@dba2.int.libertyrms.com>

Karl Denninger <karl@denninger.net> writes:
> The documentation has gotten me through replicating one database.
>
> Ok, I now I have another one on the same machine going to the same
> destination.  Its a different database with obviously different tables.
>
> Am I correct that I need only one "slon" process per computer (or
> Postgresql instance) but that when I set up other replication sets
> for different databases I set them up as different clusters?

You need one "slon" for each PostgreSQL database that is participating
in replication.

The edge case here would be that if a particular PostgreSQL cluster
(e.g. - an instance running on a particular host responding at a
particular port) has *two* databases involved in replication, then
*two* slons would be required, one for each database.

But if you have several replication sets that aren't particularly
similar to one another, that don't really need to interact, I'd expect
it to be wise to set them up as completely separate Slony-I clusters.
-- 
"cbbrowne","@","linuxdatabases.info"
http://cbbrowne.com/info/unix.html
"...In my phone conversation with Microsoft's lawyer I copped to the
fact that just maybe his client might see me as having been in the
past just a bit critical of their products and business
practices. This was too bad, he said with a sigh, because they were
having a very hard time finding a reporter who both knew the industry
well enough to be called an expert and who hadn't written a negative
article about Microsoft." -- Robert X. Cringely
From stuart at stuartbishop.net  Mon Mar  9 12:34:48 2009
From: stuart at stuartbishop.net (Stuart Bishop)
Date: Mon Mar  9 12:35:01 2009
Subject: [Slony1-general] repair config failing
In-Reply-To: <2968dfd60903060647see16580l78d6056ec8160a5b@mail.gmail.com>
References: <6bc73d4c0903052242h47a7a27fsff31235f4c2ab65f@mail.gmail.com>
	<2968dfd60903060647see16580l78d6056ec8160a5b@mail.gmail.com>
Message-ID: <6bc73d4c0903091234t2515b5d2v99a6162aac58305b@mail.gmail.com>

On Fri, Mar 6, 2009 at 9:47 PM, Vick Khera <vivek@khera.org> wrote:
> On Fri, Mar 6, 2009 at 1:42 AM, Stuart Bishop <stuart@stuartbishop.net> wrote:
>> The database is a freshly restored dump of the master node.
>
> I do not think you can do that. ?You need to strip the slony stuff
> before you do the restore (or after). ?Then re-enable replication by
> adding it as a node.

You can't strip the Slony stuff before the restore when doing disaster
recovery. The last time this came up on this mailing list, it seemed
this was the correct procedure (closely followed by 'just drop the
slony schema' which was the most popular mechanism, but apparently
doesn't quite do everything correctly).

We do a full dump every day, and test the restore by using the dump to
rebuild our staging server. So far, the process has worked fine. This
time... I don't know. To me it looks like I was just unlucky and hit a
case where repair config fails (which would be a bug).

-- 
Stuart Bishop <stuart@stuartbishop.net>
http://www.stuartbishop.net/
From vivek at khera.org  Mon Mar  9 12:49:49 2009
From: vivek at khera.org (Vick Khera)
Date: Mon Mar  9 12:50:03 2009
Subject: [Slony1-general] repair config failing
In-Reply-To: <6bc73d4c0903091234t2515b5d2v99a6162aac58305b@mail.gmail.com>
References: <6bc73d4c0903052242h47a7a27fsff31235f4c2ab65f@mail.gmail.com>
	<2968dfd60903060647see16580l78d6056ec8160a5b@mail.gmail.com>
	<6bc73d4c0903091234t2515b5d2v99a6162aac58305b@mail.gmail.com>
Message-ID: <2968dfd60903091249v3b2a8be8i10a2d58cc27e57c1@mail.gmail.com>

On Mon, Mar 9, 2009 at 3:34 PM, Stuart Bishop <stuart@stuartbishop.net> wrote:
> You can't strip the Slony stuff before the restore when doing disaster
> recovery. The last time this came up on this mailing list, it seemed

Dump your schema from the master; data from the replica (or master,
doesn't matter much).  Then restore the schema and data in a staggered
fashion so that you insert your FK's and indexes and triggers after
the data.
From boynagar at gmail.com  Tue Mar 10 00:28:38 2009
From: boynagar at gmail.com (Katu)
Date: Tue Mar 10 11:25:02 2009
Subject: [Slony1-general] MinGW cannot find -lpgport
Message-ID: <f0d84caa0903100028q334553c4rbe714c407cf2cd0@mail.gmail.com>

Skipped content of type multipart/alternative-------------- next part -----=
---------
A non-text attachment was scrubbed...
Name: build.log
Type: application/octet-stream
Size: 15504 bytes
Desc: not available
Url : http://lists.slony.info/pipermail/slony1-general/attachments/20090310=
/df950043/build.obj
From aleksander.kmetec at intera.si  Thu Mar 12 13:22:39 2009
From: aleksander.kmetec at intera.si (Aleksander Kmetec)
Date: Thu Mar 12 13:23:03 2009
Subject: [Slony1-general] sl_log_1/2 still not switching after upgrading to
	2.0.1
Message-ID: <49B96F0F.10107@intera.si>

Hi,

I upgraded my slony install to 2.0.1 a couple of hours ago, but I'm still getting this message:
  NOTICE:  Slony-I: log switch to sl_log_1 still in progress - sl_log_2 not truncated
  CONTEXT:  PL/pgSQL function "cleanupevent" line 99 at assignment

I used the following upgrade procedure:
- killed slon daemons on both nodes
- compiled & installed new slony
- executed "update functions" for both nodes (I checked the output of \df+ logswitch_finish and the changes from 2.0.1 
are there)
- started slon daemons

Is there anything else I should do?

test_slony_state script only complains about the size of sl_log_2 (it now contains almost 30 million rows); everything 
else seems fine. Contents of sl_confirm look up to date on both nodes.

Also, a "fetch 500 from LOG;" statement is running at all times, but its xact_start is never older than a minute.

Any help would be appreciated.

Regards,
Aleksander
From rod at iol.ie  Fri Mar 13 10:41:09 2009
From: rod at iol.ie (Raymond O'Donnell)
Date: Fri Mar 13 10:41:21 2009
Subject: [Slony1-general] Slony 2.0, PG 8.0, Windows?
Message-ID: <49BA9AB5.70501@iol.ie>

Hi all,

Is Slony-I 2.0 available for PostgreSQL 8.3 on Windows? I could only
find 1.2 for PG 8.2 in the "download" section of the web site.

Thanks,

Ray.

------------------------------------------------------------------
Raymond O'Donnell, Director of Music, Galway Cathedral, Ireland
rod@iol.ie
Galway Cathedral Recitals: http://www.galwaycathedral.org/recitals
------------------------------------------------------------------
From rod at iol.ie  Fri Mar 13 10:43:15 2009
From: rod at iol.ie (Raymond O'Donnell)
Date: Fri Mar 13 10:43:26 2009
Subject: [Slony1-general] Slony 2.0, PG 8.3, Windows? - WAS: Slony 2.0,
	PG 8.0, Windows?
In-Reply-To: <49BA9AB5.70501@iol.ie>
References: <49BA9AB5.70501@iol.ie>
Message-ID: <49BA9B33.5050602@iol.ie>

Oops, sorry - mistake in the subject.

On 13/03/2009 17:41, Raymond O'Donnell wrote:
> Hi all,
> 
> Is Slony-I 2.0 available for PostgreSQL 8.3 on Windows? I could only
> find 1.2 for PG 8.2 in the "download" section of the web site.
> 
> Thanks,
> 
> Ray.
> 
> ------------------------------------------------------------------
> Raymond O'Donnell, Director of Music, Galway Cathedral, Ireland
> rod@iol.ie
> Galway Cathedral Recitals: http://www.galwaycathedral.org/recitals
> ------------------------------------------------------------------
> _______________________________________________
> Slony1-general mailing list
> Slony1-general@lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
> 
> 


-- 
------------------------------------------------------------------
Raymond O'Donnell, Director of Music, Galway Cathedral, Ireland
rod@iol.ie
Galway Cathedral Recitals: http://www.galwaycathedral.org/recitals
------------------------------------------------------------------
From dmitry at koterov.ru  Sat Mar 14 07:12:00 2009
From: dmitry at koterov.ru (Dmitry Koterov)
Date: Sat Mar 14 07:12:07 2009
Subject: [Slony1-general] Re: EXECUTE SCRIPT and then UPDATE with logTrigger
	firing within a SINGLE transaction?
In-Reply-To: <d7df81620903081556j3c11bae2n73abae02256d2057@mail.gmail.com>
References: <d7df81620903061440n3c1068dfr98a0904adf197b4@mail.gmail.com>
	<d7df81620903081556j3c11bae2n73abae02256d2057@mail.gmail.com>
Message-ID: <d7df81620903140712q6c72f06fj2579a976316dd011@mail.gmail.com>

Now I am working to implement ability to use DDL + DML commands in the same
transaction of slonik call for fully transparent slonik usage. Seems it's
possible nevertheless, but needs some patching work (at least, log and use
txid and sl_action_seq in SYNC before and after DDL_SCRIPT).

I will email here when this work will succeed or fail.


On Mon, Mar 9, 2009 at 1:56 AM, Dmitry Koterov <dmitry@koterov.ru> wrote:

> Unfortunately, this method does not work.
>
> Because we cannot have more than one separated group of sl_log items with=
in
> a single transaction: sl_event SYNC contain information only about xid, n=
ot
> about sequence of sl_log item. So, if we have
>
> xid=3D123: (0) SYNC
> xid=3D123: (1) DDL_SCRIPT
> xid=3D123: (2) SYNC
> xid=3D123: (3) DDL_SCRIPT
>
> then slon cannot detect are sl_log items of (2) SYNC were performed *
> before* (3) DDL_SCRIPT or *after* it. And the following sequence becomes
> broken:
>
> (1) ALTER TABLE a ADD COLUMN id_copy INTEGER;
> (2) UPDATE a SET id_copy =3D id;
> (3) ALTER TABLE a RENAME COLUMN id_copy TO abcd;
>
> But, while digging the source, I have suddenly found 2 bugs. I reported
> them here (with solution patches attached):
> http://www.slony.info/bugzilla/show_bug.cgi?id=3D75
>
>
>
>
> On Sat, Mar 7, 2009 at 1:40 AM, Dmitry Koterov <dmitry@koterov.ru> wrote:
>
>> Hello.
>>
>> I work with Slony for about 2 years in a heavy-loaded web site. I'd like
>> to mix DDL and DML code to perform them in a single transaction (in
>> deployment procedure it would be very handy and important).
>>
>> Digging the source of slonik and _schemadoc I assumed that I possibly
>> could do it via slonik
>> (for better readability I replaced FILENAME=3D'xxx' clause by the content
>> of xxx itself):
>>
>>
>> -- Perform my DDL modifications.
>> EXECUTE SCRIPT {
>>   ALTER TABLE tbl ADD COLUMN id_copy INTEGER;
>> }
>>
>> EXECUTE SCRIPT {
>>   -- This is needed to deny execution of this SQL in other nodes.
>>   EXECUTE ONLY ON =3D <my_origin_node>
>>
>>   -- Temporariy turn on replication mode.
>>   SET session_replication_role TO origin;
>>   -- Perform my DML operations. They will be replicated via logTrigger as
>> usual.
>>   UPDATE tbl SET id_copy =3D id;
>>   UPDATE tbl SET abc =3D 123;
>>   -- Reset replication mode back.
>>   SET session_replication_role TO local;
>> }
>>
>> -- Perform any other DDL modifications.
>> EXECUTE SCRIPT {
>>   ALTER TABLE tbl ADD COLUMN c INTEGER;
>> }
>> ...
>>
>> Please say would this method work without side effects or not?
>> Thank you!
>>
>> B.r.,
>>   Dmitry Koterov,
>>   chief architect at MoiKrug.Ru, Yandex, Moscow.
>>
>>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20090314/=
81e19013/attachment.htm
From c_venumadhav at yahoo.com  Wed Mar 18 00:30:36 2009
From: c_venumadhav at yahoo.com (VenuMadhav)
Date: Wed Mar 18 00:31:06 2009
Subject: [Slony1-general] Slony-I Replication
Message-ID: <62410.73835.qm@web94909.mail.in2.yahoo.com>

Dear Sir,
We are using PostgreSQL and Slony-I from last 4 years.
Slony-I 1.1.5=A0is implemented with 1 master + 4=A0slaves on PostgreSQL 8.1=
 databases.
This is working fine from last one year.
Now we want to=A0increase Slaves from 4 to 10.
Is it possible with Slony-I 1.1.5 to replicate One Master with 10 slaves.
=A0Thanks & Regards
Ch Venu Madhav
STO/CR&D/ECIL=A0



      Bollywood news, movie reviews, film trailers and more! Go to http://i=
n.movies.yahoo.com/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20090318/=
5eaf3036/attachment.htm
From stuart at stuartbishop.net  Wed Mar 18 01:59:54 2009
From: stuart at stuartbishop.net (Stuart Bishop)
Date: Wed Mar 18 02:00:24 2009
Subject: [Slony1-general] Slony-I Replication
In-Reply-To: <62410.73835.qm@web94909.mail.in2.yahoo.com>
References: <62410.73835.qm@web94909.mail.in2.yahoo.com>
Message-ID: <6bc73d4c0903180159h776c6549w744acf0c2b3a2010@mail.gmail.com>

On Wed, Mar 18, 2009 at 2:30 PM, VenuMadhav <c_venumadhav@yahoo.com> wrote:
> Dear Sir,
> We are using PostgreSQL and Slony-I from last 4 years.
> Slony-I 1.1.5?is implemented with 1 master + 4?slaves on PostgreSQL 8.1
> databases.
> This is working fine from last one year.
> Now we want to?increase Slaves from 4 to 10.
> Is it possible with Slony-I 1.1.5 to replicate One Master with 10 slaves.

Current PostgreSQL and Slony-I can support 10 slaves. I don't know
about 8.1 and 1.1.5.

You should consider upgrading - the performance boost you will get
upgrading to PostgreSQL 8.3 might make the extra slaves unnecessary. I
would feel very nervous of my data running PostgreSQL 8.1 and Slony-I
1.1.5.

-- 
Stuart Bishop <stuart@stuartbishop.net>
http://www.stuartbishop.net/
From c_venumadhav at yahoo.com  Wed Mar 18 03:35:52 2009
From: c_venumadhav at yahoo.com (VenuMadhav)
Date: Wed Mar 18 03:36:27 2009
Subject: [Slony1-general] Slony-I Replication
In-Reply-To: <6bc73d4c0903180159h776c6549w744acf0c2b3a2010@mail.gmail.com>
References: <62410.73835.qm@web94909.mail.in2.yahoo.com>
	<6bc73d4c0903180159h776c6549w744acf0c2b3a2010@mail.gmail.com>
Message-ID: <739512.77019.qm@web94904.mail.in2.yahoo.com>

Dear Sir,
First of all Thank you very much for your immediate response.
Is this combination works =

=A0=A0=A0 RHEL 4.0
=A0=A0=A0 PostgreSQL 8..3
=A0=A0=A0 Slony-I 1.2.15
I will proceed based on your advise.=A0
Thanks & Regards
Ch Venu Madhav
STO/CR&D/ECIL =





________________________________
From: Stuart Bishop <stuart@stuartbishop.net>
To: VenuMadhav <c_venumadhav@yahoo.com>
Cc: slony1-general@lists.slony.info
Sent: Wednesday, 18 March, 2009 2:29:54 PM
Subject: Re: [Slony1-general] Slony-I Replication

On Wed, Mar 18, 2009 at 2:30 PM, VenuMadhav <c_venumadhav@yahoo.com> wrote:
> Dear Sir,
> We are using PostgreSQL and Slony-I from last 4 years.
> Slony-I 1.1.5=A0is implemented with 1 master + 4=A0slaves on PostgreSQL 8=
.1
> databases.
> This is working fine from last one year.
> Now we want to=A0increase Slaves from 4 to 10.
> Is it possible with Slony-I 1.1.5 to replicate One Master with 10 slaves.

Current PostgreSQL and Slony-I can support 10 slaves. I don't know
about 8.1 and 1.1.5.

You should consider upgrading - the performance boost you will get
upgrading to PostgreSQL 8.3 might make the extra slaves unnecessary. I
would feel very nervous of my data running PostgreSQL 8.1 and Slony-I
1.1.5.

-- =

Stuart Bishop <stuart@stuartbishop.net>
http://www.stuartbishop.net/



      Unlimited freedom, unlimited storage. Get it now, on http://help.yaho=
o.com/l/in/yahoo/mail/yahoomail/tools/tools-08.html/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20090318/=
15e2a150/attachment.htm
From rindahl at lrcwe.com  Thu Mar 19 11:10:44 2009
From: rindahl at lrcwe.com (Bruce Rindahl)
Date: Thu Mar 19 11:10:57 2009
Subject: [Slony1-general] Windows event log error 
Message-ID: <49C28AA4.1070801@lrcwe.com>

I have Slony running perfectly between two Windows 2003 servers, an 
Windows XP and an Amazon cloud computer (Debian).
The problem I am having is when I do not include the password in the 
connection info between nodes, an error message is sent to the Event log 
in Windows stating:
"ERROR  slon_connectdb: PQconnectdb("host=remotehost user=slony 
dbname=mydbase") failed - fe_sendauth: no password supplied"
This is not an error - the passwords are handled correctly by the pgpass 
files on each machine.  This error message is posted every 10 seconds 
and clutters up the Event logs on each machine.  Again the machines sync 
fine without the password but to stop the message I have to include it 
in the connection string (not good).
How can I disable this message?
Thanks
Bruce


From c_venumadhav at yahoo.com  Fri Mar 20 22:05:53 2009
From: c_venumadhav at yahoo.com (VenuMadhav)
Date: Fri Mar 20 22:06:18 2009
Subject: [Slony1-general] Slony-I Replication
Message-ID: <478375.83937.qm@web94915.mail.in2.yahoo.com>

Dear Sir,


We are using PostgreSQL and Slony-I on RedHat linux from last 4 years.
Slony-I 1.1.5=A0is implemented with 1 master + 4=A0slaves on PostgreSQL 8.1=
databases.
It is working fine on WAN from last year.
Now we want to=A0increase Slaves from 4 to 13.
Is it possible with below latest platform =

=A0=A0=A0 RHEL 4.0
=A0=A0=A0 PostgreSQL 8.3
=A0=A0=A0 Slony-I 1.2.15
=A0=A0=A0 PgAdmin3 1.4.3
Slaves must be 13. Is it possible to implement atleast without failover and=
 cascading.
Please guide us.
This is our requirement. We are ready to contribute some amount for this pu=
rpose.

Thanks & Regards
Ch Venu Madhav



      Get perfect Email ID for your Resume. Grab now http://in.promos.yahoo=
.com/address
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20090321/=
b0e6d747/attachment.htm
From dmitry at koterov.ru  Sat Mar 21 03:58:23 2009
From: dmitry at koterov.ru (Dmitry Koterov)
Date: Sat Mar 21 03:58:55 2009
Subject: [Slony1-general] Slony is ACID relative to data changes,
	but not ACID relative to DDL changes
Message-ID: <d7df81620903210358p7c36bad9q5c70e574a447deab@mail.gmail.com>

Hello.

Possibly this fact needs to be included in the documentation?

Steps to reproduce:

1. Create table with name "b" on slave manually (emulate an error of broken
replication, see below).
2. Check that there is no table "b" on master.
3. Run via slonik's EXECUTE DDL within TRY block (in the single
transaction):

CREATE TABLE a(id INTEGER);
CREATE TABLE b(id INTEGER);

4. On master, this query successfully finishes. On slave, only table "a" is
created (and committed!), but "b" is not (it already exists).
5. Conclustion: on master, "a" and "b" are created within the single
transaction. On slave, "a" and "b" are created within different
transactions.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20090321/=
14e9690b/attachment.htm
From cbbrowne at ca.afilias.info  Mon Mar 23 08:31:29 2009
From: cbbrowne at ca.afilias.info (cbbrowne)
Date: Mon Mar 23 08:31:37 2009
Subject: [Slony1-general] Slony is ACID relative to data changes,	but
	not ACID relative to DDL changes
In-Reply-To: <d7df81620903210358p7c36bad9q5c70e574a447deab@mail.gmail.com>
References: <d7df81620903210358p7c36bad9q5c70e574a447deab@mail.gmail.com>
Message-ID: <49C7AB51.2090707@ca.afilias.info>

Dmitry Koterov wrote:
> Hello.
>
> Possibly this fact needs to be included in the documentation?
>
> Steps to reproduce:
>
> 1. Create table with name "b" on slave manually (emulate an error of 
> broken replication, see below).
> 2. Check that there is no table "b" on master.
> 3. Run via slonik's EXECUTE DDL within TRY block (in the single 
> transaction):
>
> CREATE TABLE a(id INTEGER);
> CREATE TABLE b(id INTEGER);
>
> 4. On master, this query successfully finishes. On slave, only table 
> "a" is created (and committed!), but "b" is not (it already exists).
> 5. Conclustion: on master, "a" and "b" are created within the single 
> transaction. On slave, "a" and "b" are created within different 
> transactions.
This behaviour seems quite surprising.

What version of Slony-I did you observe this in?  There was a bug of this sort that was resolved in 1.2.12.
-- 
(format nil "~S@~S" "cbbrowne" "ca.afilias.info")
<http://dba2.int.libertyrms.com/>
Christopher Browne
(416) 673-4124 (land)
"Bother,"  said Pooh,  "Eeyore, ready  two photon  torpedoes  and lock
phasers on the Heffalump, Piglet, meet me in transporter room three"

From very.shafrudin at gmail.com  Tue Mar 24 00:55:46 2009
From: very.shafrudin at gmail.com (shafrudin)
Date: Tue Mar 24 07:16:53 2009
Subject: [Slony1-general] how execute ddl script on slony???
Message-ID: <22675573.post@talk.nabble.com>


i am using windows xp, postgresql 8.3.1 and slony 1.2.15.
i use pgadmin to create replication (slony) and theres a problem when i want
to make changes (DDL)...
i read the article but i still dont undestand,...
can anyone help me how to execute ddl script???
-- 
View this message in context: http://www.nabble.com/how-execute-ddl-script-on-slony----tp22675573p22675573.html
Sent from the Slony-I -- General mailing list archive at Nabble.com.

From rod at iol.ie  Tue Mar 24 07:47:02 2009
From: rod at iol.ie (Raymond O'Donnell)
Date: Tue Mar 24 07:47:11 2009
Subject: [Slony1-general] how execute ddl script on slony???
In-Reply-To: <22675573.post@talk.nabble.com>
References: <22675573.post@talk.nabble.com>
Message-ID: <49C8F266.9030908@iol.ie>

On 24/03/2009 07:55, shafrudin wrote:

> i read the article but i still dont undestand,...
> can anyone help me how to execute ddl script???

AIUI, you can do it like this:

* Put your DDL into a file.

* Create another script file with the EXECUTE SCRIPT command in it,
pointing to the first script (see the example at
http://www.slony.info/documentation/stmtddlscript.html).

* Submit this second script to slonik.

I haven't done it myself, but this is what I understand from scanning
the docs anyway. :-)

Ray.


------------------------------------------------------------------
Raymond O'Donnell, Director of Music, Galway Cathedral, Ireland
rod@iol.ie
Galway Cathedral Recitals: http://www.galwaycathedral.org/recitals
------------------------------------------------------------------
From karl at flightaware.com  Tue Mar 24 12:19:11 2009
From: karl at flightaware.com (Karl Lehenbauer)
Date: Tue Mar 24 12:19:30 2009
Subject: [Slony1-general] Tested DDL on master,
	pushed with slonik_execute_script, failed on slaves
In-Reply-To: <20090324190003.C63E82900F9@main.slony.info>
References: <20090324190003.C63E82900F9@main.slony.info>
Message-ID: <BC250051-F990-4EA5-88CC-30C713D87676@flightaware.com>

So we follow the best practice of testing DDL by wrapping it in a  
BEGIN...ROLLBACK and making sure it "works" on the master before  
pushing it out using slonik_execute_script.

Yesterday we got burned.  We had some DDL that included a DROP  
FUNCTION.  Problem was the function existed on the master but not on
the slaves.  (We should have used DROP FUNCTION IF EXISTS, but we  
didn't.)

So we got into the thing where the slon daemon on the slaves would die  
and then get respawned and then try to sync a ton of stuff and die  
whenever it hit the PGRES_FATAL_ERROR with the messed up DDL.  Finally  
we created the missing function on the slaves and then the DDL could  
complete and after a few minutes, everything was back to normal.

I propose that a better best practice is to test the DDL on the master  
*and every slave* in a BEGIN...ROLLBACK to make sure the DDL will  
succeed everywhere.  We've built a program to do this, try_slony_ddl,  
but it's written in Tcl.  Perhaps someone with better Perl skills than  
I could make a slonik_test_script that does the same thing but uses  
the slon_tools.conf.  (My stuff currently gets the db connect strings  
out of sl_path).

I share this in the hope that it might be useful to someone.  We feel  
like after something's been shown by try_slony_ddl to work on the  
master and all the slaves, it's a pretty dead certainty that it's  
going to work when pushed out with slonik_execute_script.

Karl
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20090324/2839fdbb/attachment.htm
From ahodgson at simkin.ca  Tue Mar 24 12:35:44 2009
From: ahodgson at simkin.ca (Alan Hodgson)
Date: Tue Mar 24 12:36:02 2009
Subject: [Slony1-general] Tested DDL on master,
	pushed with slonik_execute_script, failed on slaves
In-Reply-To: <BC250051-F990-4EA5-88CC-30C713D87676@flightaware.com>
References: <20090324190003.C63E82900F9@main.slony.info>
	<BC250051-F990-4EA5-88CC-30C713D87676@flightaware.com>
Message-ID: <200903241235.44345@hal.medialogik.com>

On Tuesday 24 March 2009, Karl Lehenbauer <karl@flightaware.com> wrote:
> I propose that a better best practice is to test the DDL on the master
> *and every slave* in a BEGIN...ROLLBACK to make sure the DDL will
> succeed everywhere.  

A lot of DDL won't succeed on the slaves unless you invoke the slony table 
restore functions first, just FYI.

-- 
Even a sixth-grader can figure out that you can?t borrow money to pay off 
your debt
From cbbrowne at ca.afilias.info  Tue Mar 24 15:19:07 2009
From: cbbrowne at ca.afilias.info (cbbrowne)
Date: Tue Mar 24 15:19:23 2009
Subject: [Slony1-general] Tested DDL on master,
	pushed with slonik_execute_script, failed on slaves
In-Reply-To: <BC250051-F990-4EA5-88CC-30C713D87676@flightaware.com>
References: <20090324190003.C63E82900F9@main.slony.info>
	<BC250051-F990-4EA5-88CC-30C713D87676@flightaware.com>
Message-ID: <49C95C5B.2010500@ca.afilias.info>

Karl Lehenbauer wrote:
> So we follow the best practice of testing DDL by wrapping it in 
> a BEGIN...ROLLBACK and making sure it "works" on the master 
> before pushing it out using slonik_execute_script.
>
> Yesterday we got burned.  We had some DDL that included a 
> DROP FUNCTION.  Problem was the function existed on the master but not on
> the slaves.  (We should have used DROP FUNCTION IF EXISTS, but we didn't.)
>
> So we got into the thing where the slon daemon on the slaves would 
> die and then get respawned and then try to sync a ton of stuff and 
> die whenever it hit the PGRES_FATAL_ERROR with the messed up DDL. 
>  Finally we created the missing function on the slaves and then the 
> DDL could complete and after a few minutes, everything was back to normal.
>
> I propose that a better best practice is to test the DDL on the master 
> *and every slave* in a BEGIN...ROLLBACK to make sure the DDL 
> will succeed everywhere.  We've built a program to do this, 
> try_slony_ddl, but it's written in Tcl.  Perhaps someone with better 
> Perl skills than I could make a slonik_test_script that does the same 
> thing but uses the slon_tools.conf.  (My stuff currently gets the db 
> connect strings out of sl_path).
>
> I share this in the hope that it might be useful to someone.  We 
> feel like after something's been shown by try_slony_ddl to work on the 
> master and all the slaves, it's a pretty dead certainty that it's 
> going to work when pushed out with slonik_execute_script.
I'm getting keener on having "comparator tools" to look for variances 
between schemas, and depending on that as a mechanism.

Our DBAs are, I believe, looking at DBSolo for this purpose.

I think it would make me feel more confident to say:
  "I ran a comparison of the schemas, and {Tool X} found that they were 
the same (modulo reconcilable differences)"
than to say:
  "I did a dry run of the upgrade and it seemed to run OK."

The former seems like a rather better test.

-- 
"cbbrowne","@","ca.afilias.info"
<http://dba2.int.libertyrms.com/>
Christopher Browne
(416) 673-4124 (land)
"Bother,"  said Pooh,  "Eeyore, ready  two photon  torpedoes  and lock
phasers on the Heffalump, Piglet, meet me in transporter room three"

From very.shafrudin at gmail.com  Tue Mar 24 22:16:33 2009
From: very.shafrudin at gmail.com (shafrudin)
Date: Tue Mar 24 22:41:29 2009
Subject: [Slony1-general] how execute ddl script on slony???
In-Reply-To: <49C8F266.9030908@iol.ie>
References: <22675573.post@talk.nabble.com> <49C8F266.9030908@iol.ie>
Message-ID: <22695435.post@talk.nabble.com>




Raymond O'Donnell wrote:
> 
> On 24/03/2009 07:55, shafrudin wrote:
> 
>> i read the article but i still dont undestand,...
>> can anyone help me how to execute ddl script???
> 
> AIUI, you can do it like this:
> 
> * Put your DDL into a file.
> 
> * Create another script file with the EXECUTE SCRIPT command in it,
> pointing to the first script (see the example at
> http://www.slony.info/documentation/stmtddlscript.html).
> 
> * Submit this second script to slonik.
> 
> I haven't done it myself, but this is what I understand from scanning
> the docs anyway. :-)
> 


in file should just write ddl cript like
create table a (id integer);
or i need to write another script??
and how to submit to slonik??
please can you explain step by step i really get suck....

-- 
View this message in context: http://www.nabble.com/how-execute-ddl-script-on-slony----tp22675573p22695435.html
Sent from the Slony-I -- General mailing list archive at Nabble.com.

From stephane.schildknecht at postgresqlfr.org  Wed Mar 25 00:57:45 2009
From: stephane.schildknecht at postgresqlfr.org (=?ISO-8859-15?Q?=22St=E9phane_A=2E_Schildknecht=22?=)
Date: Wed Mar 25 00:57:59 2009
Subject: [Slony1-general] how execute ddl script on slony???
In-Reply-To: <22695435.post@talk.nabble.com>
References: <22675573.post@talk.nabble.com> <49C8F266.9030908@iol.ie>
	<22695435.post@talk.nabble.com>
Message-ID: <49C9E3F9.5070402@postgresqlfr.org>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

shafrudin a ?crit :
> 
> 
> Raymond O'Donnell wrote:
>> On 24/03/2009 07:55, shafrudin wrote:
>>
>>> i read the article but i still dont undestand,...
>>> can anyone help me how to execute ddl script???
>> AIUI, you can do it like this:
>>
>> * Put your DDL into a file.
>>
>> * Create another script file with the EXECUTE SCRIPT command in it,
>> pointing to the first script (see the example at
>> http://www.slony.info/documentation/stmtddlscript.html).
>>
>> * Submit this second script to slonik.
>>
>> I haven't done it myself, but this is what I understand from scanning
>> the docs anyway. :-)
>>
> 
> 
> in file should just write ddl cript like
> create table a (id integer);
> or i need to write another script??
> and how to submit to slonik??
> please can you explain step by step i really get suck....
> 

There are two different things.
1. you want to add a table to a replication.
2. You want to modify already replicated objects.

In the first case, you have to create objects on every node, and then add them
to the replication. To do so, you'll have to create a new set, add objects to
that set, subscribe that set, exactly like the first set, and then merge the
two sets.

In the second case, you have to put all schema changes in a single script, and
tell some slonik script to "execute script", as said in documentation.

Regards,
SAS

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.6 (GNU/Linux)
Comment: Using GnuPG with Mozilla - http://enigmail.mozdev.org

iD8DBQFJyeP5A+REPKWGI0ERApfUAJ9HfJJ4JzJFBugU2NdN7C7NTbLzrACgxu2s
OfnjWh9TF3prABluINJMNtQ=
=Wmhx
-----END PGP SIGNATURE-----
From matthew.hempel at gmail.com  Wed Mar 25 13:26:01 2009
From: matthew.hempel at gmail.com (Matthew Hempel)
Date: Wed Mar 25 13:26:19 2009
Subject: [Slony1-general] altperl scripts
Message-ID: <49CA9359.3060809@gmail.com>


I've gone through a good bit of trial and error, but I'd like to make 
sure I have my facts straight.

Very simple configuration:  one cluster, two nodes (two servers), one 
set.    db1 is the origin.  db2 is a subscriber.
My question is very simple.  Which commands need to be run on which 
machine?

 From the docs:

$ slonik_init_cluster  | slonik

I assume that the slonik_init_cluster command only needs to be run on 
db1, the origin server.

$ slonik_create_set 1 | slonik

I assume that the slonik_create_set command needs to be run on both db1 
and db2, the subscriber.

$ slonik_subscribe_set  1 2 | slonik

I assume that the slonik_subscribe_set command only needs to be run on 
db2, the subscriber.

If my assumptions are wrong, I'd appreciate being corrected.

Thanks

Matt Hempel

From mark at summersault.com  Thu Mar 26 07:17:29 2009
From: mark at summersault.com (Mark Stosberg)
Date: Thu Mar 26 07:17:53 2009
Subject: [Slony1-general] Re: altperl scripts
References: <49CA9359.3060809@gmail.com>
Message-ID: <20090326101729.09d5f2a4@summersault.com>


> I've gone through a good bit of trial and error, but I'd like to make 
> sure I have my facts straight.

Hello Matt,

I use and prefer the 'altperl' scripts, but I do find that the
documentation is lacking. Patches welcome.

> Very simple configuration:  one cluster, two nodes (two servers), one 
> set.    db1 is the origin.  db2 is a subscriber.
> My question is very simple.  Which commands need to be run on which 
> machine?
> 
>  From the docs:
> 
> $ slonik_init_cluster  | slonik
> 
> I assume that the slonik_init_cluster command only needs to be run on 
> db1, the origin server.

Right.

Next, you are missing the step to start one 'slon' daemon for each node:

slon_start 1
slon_start 2

I made myself a simple "rc.d" style script that starts and stops the
slons I need this way.

> $ slonik_create_set 1 | slonik
> 
> I assume that the slonik_create_set command needs to be run on both db1 
> and db2, the subscriber.

You just run it once. It talks to the 'slon' daemons, and they talk to
each other, and take care of what they need to.

> $ slonik_subscribe_set  1 2 | slonik
> 
> I assume that the slonik_subscribe_set command only needs to be run on 
> db2, the subscriber.

I would run these commands on the server, where the slons are running.
The slons talks to both databases as needed. But yes, just run it once. 

I think you've got things basically right.

We've been using slony for a year (or two?) now on a business national
website and have no serious problems. The worst case scenerio is
dropping replication and rebuilding it from scratch. In our case, with
about a 1 G database, this can be done in about 10 minutes, and traffic
normally set to the slave can be set to the master for this time
(assuming the master can handle it).

    Mark


-- 
 . . . . . . . . . . . . . . . . . . . . . . . . . . . 
   Mark Stosberg            Principal Developer  
   mark@summersault.com     Summersault, LLC     
   765-939-9301 ext 202     database driven websites
 . . . . . http://www.summersault.com/ . . . . . . . .


From mark at summersault.com  Thu Mar 26 07:21:26 2009
From: mark at summersault.com (Mark Stosberg)
Date: Thu Mar 26 07:25:11 2009
Subject: [Slony1-general] PATCH: clarify docs for slonik_merge_sets
Message-ID: <20090326102126.4588634e@summersault.com>


The attached patch attempts to improve the docs of slonik_merge_set. I wanted
to make it crystal clear that the two sets involved in the merge are not 
treated equally. Notably, one of the sets is completely eliminated.

    Mark
-------------- next part --------------
A non-text attachment was scrubbed...
Name: slonik_merge_sets.improved_docs.patch
Type: text/x-patch
Size: 1088 bytes
Desc: not available
Url : http://lists.slony.info/pipermail/slony1-general/attachments/20090326/5a9816a7/slonik_merge_sets.improved_docs.bin
From mhempel at twentybricks.com  Wed Mar 25 13:22:41 2009
From: mhempel at twentybricks.com (Matthew Hempel)
Date: Thu Mar 26 08:45:52 2009
Subject: [Slony1-general] altperl scripts
Message-ID: <49CA9291.9030908@gmail.com>


I've gone through a good bit of trial and error, but I'd like to make 
sure I have my facts straight.

Very simple configuration:  one cluster, two nodes (two servers), one 
set.    db1 is the origin.  db2 is a subscriber. 

My question is very simple.  Which commands need to be run on which machine?

 From the docs:

$ slonik_init_cluster  | slonik

I assume that the slonik_init_cluster command only needs to be run on 
db1, the origin server.

$ slonik_create_set 1 | slonik

I assume that the slonik_create_set command needs to be run on both db1 
and db2, the subscriber.

$ slonik_subscribe_set  1 2 | slonik

I assume that the slonik_subscribe_set command only needs to be run on 
db2, the subscriber.

If my assumptions are wrong, I'd appreciate being corrected.

Thanks

Matt Hempel


From dmitry at koterov.ru  Sat Mar 28 15:46:51 2009
From: dmitry at koterov.ru (Dmitry Koterov)
Date: Sat Mar 28 15:47:08 2009
Subject: [Slony1-general] Re: EXECUTE SCRIPT and then UPDATE with logTrigger
	firing within a SINGLE transaction?
In-Reply-To: <d7df81620903140712q6c72f06fj2579a976316dd011@mail.gmail.com>
References: <d7df81620903061440n3c1068dfr98a0904adf197b4@mail.gmail.com>
	<d7df81620903081556j3c11bae2n73abae02256d2057@mail.gmail.com>
	<d7df81620903140712q6c72f06fj2579a976316dd011@mail.gmail.com>
Message-ID: <d7df81620903281546q4e5164f0ocee7dc59d1ea7b02@mail.gmail.com>

Seems I did it.

Now I am working on creation of standartized test suite
(slony1-2.0.1/tests/testexecutedml/).
The complete patch (with test suite) will be ready soon, I'll email it.

Here is some illustrations how I test it manually (note the new operator
"EXECUTE DML" which executes replicated DML script within the same
transaction as e.g. above "EXECUTE SCRIPT", so it is rolled back on any
errors together with other instructions):


echo "
    `./_preamble.sh`
    TRY {
        EXECUTE SCRIPT (
            SET ID =3D `./_setid.sh`,
            EVENT NODE =3D `./_masterid.sh`,
            FILENAME =3D '`
                echo 'ALTER TABLE public.a ADD COLUMN id_copy INTEGER' >
/tmp/a1;
                echo -n /tmp/a1;
            `'
        );

        EXECUTE DML (
            EVENT NODE =3D `./_masterid.sh`,
            FILENAME =3D '`
                echo 'UPDATE a SET id_copy =3D id' > /tmp/a2;
                echo -n /tmp/a2;
            `'
        );

        EXECUTE SCRIPT (
            SET ID =3D `./_setid.sh`,
            EVENT NODE =3D `./_masterid.sh`,
            FILENAME =3D '`
                echo 'ALTER TABLE public.a RENAME COLUMN id_copy TO
id_copy1' > /tmp/a4;
                echo -n /tmp/a4;
            `'
        );
    } ON ERROR {
        echo 'Failed to create the table!';
    }
" | su - postgres -c slonik




On Sat, Mar 14, 2009 at 5:12 PM, Dmitry Koterov <dmitry@koterov.ru> wrote:

> Now I am working to implement ability to use DDL + DML commands in the sa=
me
> transaction of slonik call for fully transparent slonik usage. Seems it's
> possible nevertheless, but needs some patching work (at least, log and use
> txid and sl_action_seq in SYNC before and after DDL_SCRIPT).
>
> I will email here when this work will succeed or fail.
>
>
>
> On Mon, Mar 9, 2009 at 1:56 AM, Dmitry Koterov <dmitry@koterov.ru> wrote:
>
>> Unfortunately, this method does not work.
>>
>> Because we cannot have more than one separated group of sl_log items
>> within a single transaction: sl_event SYNC contain information only about
>> xid, not about sequence of sl_log item. So, if we have
>>
>> xid=3D123: (0) SYNC
>> xid=3D123: (1) DDL_SCRIPT
>> xid=3D123: (2) SYNC
>> xid=3D123: (3) DDL_SCRIPT
>>
>> then slon cannot detect are sl_log items of (2) SYNC were performed *
>> before* (3) DDL_SCRIPT or *after* it. And the following sequence becomes
>> broken:
>>
>> (1) ALTER TABLE a ADD COLUMN id_copy INTEGER;
>> (2) UPDATE a SET id_copy =3D id;
>> (3) ALTER TABLE a RENAME COLUMN id_copy TO abcd;
>>
>> But, while digging the source, I have suddenly found 2 bugs. I reported
>> them here (with solution patches attached):
>> http://www.slony.info/bugzilla/show_bug.cgi?id=3D75
>>
>>
>>
>>
>> On Sat, Mar 7, 2009 at 1:40 AM, Dmitry Koterov <dmitry@koterov.ru> wrote:
>>
>>> Hello.
>>>
>>> I work with Slony for about 2 years in a heavy-loaded web site. I'd like
>>> to mix DDL and DML code to perform them in a single transaction (in
>>> deployment procedure it would be very handy and important).
>>>
>>> Digging the source of slonik and _schemadoc I assumed that I possibly
>>> could do it via slonik
>>> (for better readability I replaced FILENAME=3D'xxx' clause by the conte=
nt
>>> of xxx itself):
>>>
>>>
>>> -- Perform my DDL modifications.
>>> EXECUTE SCRIPT {
>>>   ALTER TABLE tbl ADD COLUMN id_copy INTEGER;
>>> }
>>>
>>> EXECUTE SCRIPT {
>>>   -- This is needed to deny execution of this SQL in other nodes.
>>>   EXECUTE ONLY ON =3D <my_origin_node>
>>>
>>>   -- Temporariy turn on replication mode.
>>>   SET session_replication_role TO origin;
>>>   -- Perform my DML operations. They will be replicated via logTrigger =
as
>>> usual.
>>>   UPDATE tbl SET id_copy =3D id;
>>>   UPDATE tbl SET abc =3D 123;
>>>   -- Reset replication mode back.
>>>   SET session_replication_role TO local;
>>> }
>>>
>>> -- Perform any other DDL modifications.
>>> EXECUTE SCRIPT {
>>>   ALTER TABLE tbl ADD COLUMN c INTEGER;
>>> }
>>> ...
>>>
>>> Please say would this method work without side effects or not?
>>> Thank you!
>>>
>>> B.r.,
>>>   Dmitry Koterov,
>>>   chief architect at MoiKrug.Ru, Yandex, Moscow.
>>>
>>>
>>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20090329/=
94037fc2/attachment.htm
From dmitry at koterov.ru  Sat Mar 28 16:44:28 2009
From: dmitry at koterov.ru (Dmitry Koterov)
Date: Sat Mar 28 16:44:45 2009
Subject: [Slony1-general] Bug in Slony-I 2.0.1 regression test suite:
	start_slon.sh.
Message-ID: <d7df81620903281644me09925fqdc8f5ce3e4597665@mail.gmail.com>

Hello.

Need "2>&1" instead of "2>>1" and "&" inside 'echo' quotes, not outside.
Else tests do not run at all.

Here is the patch to fix it.

bash-3.00# diff -U2 /usr/local/src/slony1-2.0.1-orig/tools/start_slon.sh
/usr/local/src/slony1-2.0.1-dk/tools/start_slon.sh
--- /usr/local/src/slony1-2.0.1-orig/tools/start_slon.sh        2008-08-01
23:33:24.000000000 +0400
+++ /usr/local/src/slony1-2.0.1-dk/tools/start_slon.sh  2009-03-29
03:29:14.000000000 +0400
@@ -35,6 +35,6 @@
        touch $SLON_LOG
        test -w "$SLON_LOG" || (echo "**** SLON_LOG not writable - $SLON_LOG
****"; exit 1)
-        echo "Starting slon: $SLON_BIN_PATH/slon -f ${SLON_CONF} 1>>
${SLON_LOG} 2>>1" &
-       $SLON_BIN_PATH/slon -f ${SLON_CONF} 1>> ${SLON_LOG} 2>>1 &
+        echo "Starting slon: $SLON_BIN_PATH/slon -f ${SLON_CONF} 1>>
${SLON_LOG} 2>&1 &"
+       $SLON_BIN_PATH/slon -f ${SLON_CONF} 1>> ${SLON_LOG} 2>&1 &
         ;;
   stop)



Also I propose to add something (or less danger) like

killall -9 slon 2>/dev/null
for i in `seq 1 10`; do dropdb slonyregress$i 2>/dev/null; done;

into run_test.sh, because else if I break a test via Ctrl+C, the next test
fails.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20090329/=
fd2e1502/attachment.htm
