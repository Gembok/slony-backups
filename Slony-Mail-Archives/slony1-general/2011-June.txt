From jason at daylife.com  Mon Jun  6 15:54:35 2011
From: jason at daylife.com (JasonN)
Date: Mon, 6 Jun 2011 15:54:35 -0700 (PDT)
Subject: [Slony1-general]  Verifying Data Consistency with Slony?
Message-ID: <31787795.post@talk.nabble.com>


Hello and thanks for taking the time to read my post...

I'm using Slony-I v1.2.20 and I have a simple master/slave replication
occurring between two servers.  Recently, we had a bit of an interruption to
our network and I need to verify the consistency of the data between the two
databases. I've checked the logs for any outstanding errors, but they seem
to report that everything is running fine.  

Aside form using sql queries, is there any way to check data consistency
using slony (ie ensure that the tables are in fact replicated 1:1)?

Thanks for your help in advance!

Cheers,
Jason
-- 
View this message in context: http://old.nabble.com/Verifying-Data-Consistency-with-Slony--tp31787795p31787795.html
Sent from the Slony-I -- General mailing list archive at Nabble.com.


From vivek at khera.org  Tue Jun  7 05:40:15 2011
From: vivek at khera.org (Vick Khera)
Date: Tue, 7 Jun 2011 08:40:15 -0400
Subject: [Slony1-general] Verifying Data Consistency with Slony?
In-Reply-To: <31787795.post@talk.nabble.com>
References: <31787795.post@talk.nabble.com>
Message-ID: <BANLkTi=zr6Hm2401_6JexHSQy_OJibJ4qQ@mail.gmail.com>

On Mon, Jun 6, 2011 at 6:54 PM, JasonN <jason at daylife.com> wrote:
> Aside form using sql queries, is there any way to check data consistency
> using slony (ie ensure that the tables are in fact replicated 1:1)?
>

No.  If you don't trust slony's own report that replication is
up-to-date, then you have to run queries on the DB.

From glynastill at yahoo.co.uk  Wed Jun  8 04:05:15 2011
From: glynastill at yahoo.co.uk (Glyn Astill)
Date: Wed, 8 Jun 2011 12:05:15 +0100 (BST)
Subject: [Slony1-general] Lock set doesn't generate event in 2.0.6?
Message-ID: <331907.4657.qm@web26002.mail.ukl.yahoo.com>

Hi Guys,

Last week we upgraded from 1.2.22 to 2.0.6 and today I'm trying to move a set from one node to another.? I'm using my own set of scripts that I've been using for years with 1.2.22, however when I wait for event after lock set I get the message "Error: script did not generate any event on node 1"


Below is the script I'm running:

??????? ECHO 'ATTEMPT: Lock the set and wait for the lock:';
??????? LOCK SET ( ID = 1, ORIGIN = 1);
??????? ECHO 'ATTEMPT: Waiting for confirm on all nodes:';
??????? WAIT FOR EVENT (ORIGIN = 1, CONFIRMED = ALL, WAIT ON = 1, TIMEOUT = 0);

I know we now can't run wait for event in a try block, but what's changed and what am I doing wrong here?


Thanks
Glyn
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20110608/03ba02eb/attachment.htm 

From ssinger at ca.afilias.info  Wed Jun  8 06:16:25 2011
From: ssinger at ca.afilias.info (Steve Singer)
Date: Wed, 08 Jun 2011 09:16:25 -0400
Subject: [Slony1-general] Lock set doesn't generate event in 2.0.6?
In-Reply-To: <331907.4657.qm@web26002.mail.ukl.yahoo.com>
References: <331907.4657.qm@web26002.mail.ukl.yahoo.com>
Message-ID: <4DEF7629.3080701@ca.afilias.info>

On 11-06-08 07:05 AM, Glyn Astill wrote:
> Hi Guys,
>
> Last week we upgraded from 1.2.22 to 2.0.6 and today I'm trying to move
> a set from one node to another. I'm using my own set of scripts that
> I've been using for years with 1.2.22, however when I wait for event
> after lock set I get the message "Error: script did not generate any
> event on node 1"
>
> Below is the script I'm running:
>
> ECHO 'ATTEMPT: Lock the set and wait for the lock:';
> LOCK SET ( ID = 1, ORIGIN = 1);
> ECHO 'ATTEMPT: Waiting for confirm on all nodes:';
> WAIT FOR EVENT (ORIGIN = 1, CONFIRMED = ALL, WAIT ON = 1, TIMEOUT = 0);
>
> I know we now can't run wait for event in a try block, but what's
> changed and what am I doing wrong here?

lock set does not generate an event in either 1.2.22 or 2.0.6

What has changed between them is that if you 'wait for event' in 1.2 
when no event then the 'wait for event' command is treated like a no-op, 
it continues without waiting.  In 2.0 the 'wait for event' command 
generates an error if you try to wait for an event that does not exist.




>
>
> Thanks
> Glyn
>
>
>
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


From glynastill at yahoo.co.uk  Wed Jun  8 07:52:55 2011
From: glynastill at yahoo.co.uk (Glyn Astill)
Date: Wed, 8 Jun 2011 15:52:55 +0100 (BST)
Subject: [Slony1-general] Lock set doesn't generate event in 2.0.6?
In-Reply-To: <4DEF7629.3080701@ca.afilias.info>
References: <331907.4657.qm@web26002.mail.ukl.yahoo.com>
	<4DEF7629.3080701@ca.afilias.info>
Message-ID: <411204.56783.qm@web26006.mail.ukl.yahoo.com>






> From: Steve Singer <ssinger at ca.afilias.info>

>>  I know we now can't run wait for event in a try block, but what's
>>  changed and what am I doing wrong here?
> 
> lock set does not generate an event in either 1.2.22 or 2.0.6
> 
> What has changed between them is that if you 'wait for event' in 1.2 
> when no event then the 'wait for event' command is treated like a no-op, 
> 
> it continues without waiting.? In 2.0 the 'wait for event' command 
> generates an error if you try to wait for an event that does not exist.
> 

Ah, okay.? So there's no need to wait for event after lock set and before running move set then? 

I'm pretty sure that was the way I was advised (or read somewhere) to run move set back in the day.

Looking at the function I see it's going to have done its work by the time it returns anyway.


From ssinger at ca.afilias.info  Wed Jun  8 08:20:52 2011
From: ssinger at ca.afilias.info (Steve Singer)
Date: Wed, 08 Jun 2011 11:20:52 -0400
Subject: [Slony1-general] Lock set doesn't generate event in 2.0.6?
In-Reply-To: <411204.56783.qm@web26006.mail.ukl.yahoo.com>
References: <331907.4657.qm@web26002.mail.ukl.yahoo.com>
	<4DEF7629.3080701@ca.afilias.info>
	<411204.56783.qm@web26006.mail.ukl.yahoo.com>
Message-ID: <4DEF9354.1050504@ca.afilias.info>

On 11-06-08 10:52 AM, Glyn Astill wrote:
>
>
>
>
>

> Ah, okay.  So there's no need to wait for event after lock set and before running move set then?

No there is no need to do a 'wait for event' after a LOCK SET.

>
> I'm pretty sure that was the way I was advised (or read somewhere) to run move set back in the day.
>
> Looking at the function I see it's going to have done its work by the time it returns anyway.





From vivek at khera.org  Wed Jun  8 13:31:04 2011
From: vivek at khera.org (Vick Khera)
Date: Wed, 8 Jun 2011 16:31:04 -0400
Subject: [Slony1-general] Lock set doesn't generate event in 2.0.6?
In-Reply-To: <411204.56783.qm@web26006.mail.ukl.yahoo.com>
References: <331907.4657.qm@web26002.mail.ukl.yahoo.com>
	<4DEF7629.3080701@ca.afilias.info>
	<411204.56783.qm@web26006.mail.ukl.yahoo.com>
Message-ID: <BANLkTi=Z6i7JemBKDbePMr6ONk1or7BQiA@mail.gmail.com>

On Wed, Jun 8, 2011 at 10:52 AM, Glyn Astill <glynastill at yahoo.co.uk> wrote:
> I'm pretty sure that was the way I was advised (or read somewhere) to run move set back in the day.
>

I don't remember *ever* doing a wait for event after a lock set.  it
just waits until the lock is complete.

From glynastill at yahoo.co.uk  Wed Jun  8 20:15:57 2011
From: glynastill at yahoo.co.uk (Glyn Astill)
Date: Thu, 9 Jun 2011 04:15:57 +0100 (BST)
Subject: [Slony1-general] 2.0.6 Subscribe set errors
Message-ID: <165449.30644.qm@web26004.mail.ukl.yahoo.com>

Hi Guys,

Just had an issue with subscribe set in 2.0.6.? From what I can see somehow slonik is passing parameters 
to reshapesubscription in the wrong order, instead of (sub_set, sub_provider, sub_receiver) it seems to be 
sending (sub_provider, sub_set, sub_receiver).? In turn that made slonik hang on me and borked my subscriptions. 

Here's what I submitted to slonik:

??? SUBSCRIBE SET ( ID = 1000, PROVIDER = 4, RECEIVER = 5, FORWARD = YES );

Here's the error message I get from slonik:

??? Way5b:/pgsql/slony# slonik reshape.scr
??? reshape.scr:17: ATTEMPT:? SUBSCRIBE SET
??? reshape.scr:18: NOTICE:? subscribe set: omit_copy=f
??? reshape.scr:18: NOTICE:? subscribe set: omit_copy=f
??? CONTEXT:? SQL statement "SELECT? "_main_replication".subscribeSet_int( $1 ,? $2 ,? $3 ,? $4 ,? $5 )"
??? PL/pgSQL function "subscribeset" line 77 at PERFORM
??? reshape.scr:18: PGRES_FATAL_ERROR select "_main_replication".reshapeSubscription(4,1000,5); - ERROR:? insert or update on table "sl_subscribe" violates foreign key constraint "sl_subscribe-sl_path-ref"
??? DETAIL:? Key (sub_provider,sub_receiver)=(1000,5) is not present in table "sl_path".
??? CONTEXT:? SQL statement "update "_main_replication".sl_subscribe set sub_provider= $1? WHERE sub_set= $2? AND sub_receiver= $3 "
??? PL/pgSQL function "reshapesubscription" line 11 at SQL statement
??? error reshaping subscriber

And here's what my reshapesubscription looks like:

??? CREATE OR REPLACE FUNCTION _main_replication.reshapesubscription(integer, integer, integer)
??? ? RETURNS integer AS
??? $BODY$
??? declare
??? ??? p_sub_set??? ??? ??? alias for $1;
??? ??? p_sub_provider??? ??? alias for $2;
??? ??? p_sub_receiver??? ??? alias for $3;
??? begin
??? ??? -- ----
??? ??? -- Grab the central configuration lock
??? ??? -- ----
??? ??? lock table "_main_replication".sl_config_lock;
??? 
??? ??? update "_main_replication".sl_subscribe set sub_provider=p_sub_provider
??? ??? ??? ?? WHERE sub_set=p_sub_set AND sub_receiver=p_sub_receiver;
??? ??? if found then
??? ??? ?? perform "_main_replication".RebuildListenEntries();
??? ??? ?? notify "_main_replication_Restart";
??? ??? end if;
??? ??? return 0;
??? end
??? $BODY$
??? LANGUAGE plpgsql VOLATILE;

Looking in the slonik.c starting on on line 3541 I can see the following:

??????????????? slon_mkquery(&query,
???????????????????????????????????????? "select \"_%s\".reshapeSubscription(%d,%d,%d);",
???????????????????????????????????????? stmt->hdr.script->clustername,
???????????????????????????????????????? stmt->sub_provider,stmt->sub_setid,
???????????????????????????????????????? stmt->sub_receiver);

Unless I'm going crazy (It is now 4am), that pretty much looks the wrong way around to me?

Thanks
Glyn


From JanWieck at Yahoo.com  Thu Jun  9 06:14:49 2011
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Thu, 09 Jun 2011 09:14:49 -0400
Subject: [Slony1-general] Support for EnterpriseDB version string?
In-Reply-To: <4DDE0290.4020603@mark.mielke.cc>
References: <4DDE0290.4020603@mark.mielke.cc>
Message-ID: <4DF0C749.2010705@Yahoo.com>

On 5/26/2011 3:34 AM, Mark Mielke wrote:
> Hi all:
>
> I've attached a patch against Slony-I 2.0.4 that we are currently using
> to allow our PostgreSQL 8.4.8 + Slony-I 2.0.4 work properly with
> EnterpriseDB 8.4.7.20 + EnterpriseDB's version of Slony-I 2.0.4. Please
> take a look and see whether you agree that this should be incorporated
> up stream.

After discussion with Chris and Steve I have committed this change to 
2.0 STABLE as well as master (current 2.1 BETA). It seems safe enough.

Greg's suggestion to just look for three numbers in the string involves 
a bit more dramatic changes because that may require moving from 
sscanf() to using regular expressions. A change we should consider for 
2.2, but definitely nothing we want to back patch into 2.0.


Jan


>
> It's a very trivial patch - but I guess it implies that Slony-I
> introduces recognition of EnterpriseDB's build of PostgreSQL more
> officially?
>
> I had a similar patch against Slony-I 2.0.6 that I can provide if this
> patch file isn't good enough - but due to EnterpriseDB still
> distributing Slony-I 2.0.4, we're version locked on Slony-I 2.0.4 for now...
>
> Thanks!
>
>
>
>
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


-- 
Anyone who trades liberty for security deserves neither
liberty nor security. -- Benjamin Franklin

From ssinger at ca.afilias.info  Thu Jun  9 06:26:05 2011
From: ssinger at ca.afilias.info (Steve Singer)
Date: Thu, 09 Jun 2011 09:26:05 -0400
Subject: [Slony1-general] 2.0.6 Subscribe set errors
In-Reply-To: <165449.30644.qm@web26004.mail.ukl.yahoo.com>
References: <165449.30644.qm@web26004.mail.ukl.yahoo.com>
Message-ID: <4DF0C9ED.302@ca.afilias.info>

On 11-06-08 11:15 PM, Glyn Astill wrote:
> Hi Guys,
>
> Just had an issue with subscribe set in 2.0.6.  From what I can see somehow slonik is passing parameters
> to reshapesubscription in the wrong order, instead of (sub_set, sub_provider, sub_receiver) it seems to be
> sending (sub_provider, sub_set, sub_receiver).  In turn that made slonik hang on me and borked my subscriptions.
>

Yes the parameters appear to be passed in the wrong order.

I have created a bug for this and attached a patch
http://bugs.slony.info/bugzilla/show_bug.cgi?id=220

Once Jan or Chris looks over the patch I will commit this for 2.0.7 and 
for the next 2.1 beta

Thanks for the report

> Here's what I submitted to slonik:
>
>      SUBSCRIBE SET ( ID = 1000, PROVIDER = 4, RECEIVER = 5, FORWARD = YES );
>
> Here's the error message I get from slonik:
>
>      Way5b:/pgsql/slony# slonik reshape.scr
>      reshape.scr:17: ATTEMPT:  SUBSCRIBE SET
>      reshape.scr:18: NOTICE:  subscribe set: omit_copy=f
>      reshape.scr:18: NOTICE:  subscribe set: omit_copy=f
>      CONTEXT:  SQL statement "SELECT  "_main_replication".subscribeSet_int( $1 ,  $2 ,  $3 ,  $4 ,  $5 )"
>      PL/pgSQL function "subscribeset" line 77 at PERFORM
>      reshape.scr:18: PGRES_FATAL_ERROR select "_main_replication".reshapeSubscription(4,1000,5); - ERROR:  insert or update on table "sl_subscribe" violates foreign key constraint "sl_subscribe-sl_path-ref"
>      DETAIL:  Key (sub_provider,sub_receiver)=(1000,5) is not present in table "sl_path".
>      CONTEXT:  SQL statement "update "_main_replication".sl_subscribe set sub_provider= $1  WHERE sub_set= $2  AND sub_receiver= $3 "
>      PL/pgSQL function "reshapesubscription" line 11 at SQL statement
>      error reshaping subscriber
>
> And here's what my reshapesubscription looks like:
>
>      CREATE OR REPLACE FUNCTION _main_replication.reshapesubscription(integer, integer, integer)
>        RETURNS integer AS
>      $BODY$
>      declare
>          p_sub_set            alias for $1;
>          p_sub_provider        alias for $2;
>          p_sub_receiver        alias for $3;
>      begin
>          -- ----
>          -- Grab the central configuration lock
>          -- ----
>          lock table "_main_replication".sl_config_lock;
>
>          update "_main_replication".sl_subscribe set sub_provider=p_sub_provider
>                 WHERE sub_set=p_sub_set AND sub_receiver=p_sub_receiver;
>          if found then
>             perform "_main_replication".RebuildListenEntries();
>             notify "_main_replication_Restart";
>          end if;
>          return 0;
>      end
>      $BODY$
>      LANGUAGE plpgsql VOLATILE;
>
> Looking in the slonik.c starting on on line 3541 I can see the following:
>
>                  slon_mkquery(&query,
>                                           "select \"_%s\".reshapeSubscription(%d,%d,%d);",
>                                           stmt->hdr.script->clustername,
>                                           stmt->sub_provider,stmt->sub_setid,
>                                           stmt->sub_receiver);
>
> Unless I'm going crazy (It is now 4am), that pretty much looks the wrong way around to me?
>
> Thanks
> Glyn
>
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


From glynastill at yahoo.co.uk  Thu Jun  9 08:43:19 2011
From: glynastill at yahoo.co.uk (Glyn Astill)
Date: Thu, 9 Jun 2011 16:43:19 +0100 (BST)
Subject: [Slony1-general] 2.0.6 Subscribe set errors
In-Reply-To: <4DF0C9ED.302@ca.afilias.info>
References: <165449.30644.qm@web26004.mail.ukl.yahoo.com>
	<4DF0C9ED.302@ca.afilias.info>
Message-ID: <582425.44838.qm@web26008.mail.ukl.yahoo.com>

----- Original Message -----

> From: Steve Singer <ssinger at ca.afilias.info>
> To: Glyn Astill <glynastill at yahoo.co.uk>
> Cc: slony <slony1-general at lists.slony.info>
> Sent: Thursday, 9 June 2011, 14:26
> Subject: Re: [Slony1-general] 2.0.6 Subscribe set errors
> 
> On 11-06-08 11:15 PM, Glyn Astill wrote:
>>  Hi Guys,
>> 
>>  Just had an issue with subscribe set in 2.0.6.? From what I can see somehow 
> slonik is passing parameters
>>  to reshapesubscription in the wrong order, instead of (sub_set, 
> sub_provider, sub_receiver) it seems to be
>>  sending (sub_provider, sub_set, sub_receiver).? In turn that made slonik 
> hang on me and borked my subscriptions.
>> 
> 
> Yes the parameters appear to be passed in the wrong order.
> 
> I have created a bug for this and attached a patch
> http://bugs.slony.info/bugzilla/show_bug.cgi?id=220
> 
> Once Jan or Chris looks over the patch I will commit this for 2.0.7 and 
> for the next 2.1 beta
> 

Thanks Steve, I applied the change shortly after emailing the list last night/this morning and can confirm it appears to resolve the issue.

From ssinger at ca.afilias.info  Wed Jun 15 15:06:14 2011
From: ssinger at ca.afilias.info (Steve Singer)
Date: Wed, 15 Jun 2011 18:06:14 -0400
Subject: [Slony1-general] Slony 2.0.7 RC2 released
Message-ID: <4DF92CD6.9090103@ca.afilias.info>

The Slony-I team is pleased to release the second release candidate for 
version 2.0.7 of Slony-I.

http://www.slony.info/downloads/2.0/source/slony1-2.0.7.rc2.tar.bz2
http://www.slony.info/downloads/2.0/source/slony1-2.0.7.rc2-docs.tar.bz2

Changes from the previous release candidate include:
--------------------------------------------------------
Bug #204 - Additional fixes for bug204 relating to circular entries in
            sl_subscribe following a failover to a non-direct subscriber.

Bug #217 - Execute script (ddlscript_complete_int) will now 	
	   reconfigure  the trigger arguments on the log trigger for
	   any tables that needs it.

Bug #220  Fix issue where changing the provider of an existing
            subscriber passed parameters in the wrong order to
            the stored procedure.
Bug #221  Add explicit casting to accommodate a user defined CAST



Changes since 2.0.6 include
--------------------------------
Fix for bug where slon was not properly detecting connection
  failures  when receiving events from the remote listener.

Bug #193 - vac_count not being reset to 0 (bug between 1.2 and 2.0 in
           restructure of cleanup thread), so vacuums were being done
           every time

Bug #195 - change slon_quote_* functions to IMMUTABLE

Bug #204 - Fix issue with FAILOVER to a non-direct subscriber
            introduced in 2.0.5

Support for building with Visual Studio on Win32

Bug # 214 - tools/slonikconfdump.sh was added back in


Users are requested to test 2.0.7 rc2 and report any issues they find.

