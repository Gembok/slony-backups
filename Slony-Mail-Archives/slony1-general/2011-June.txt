From jason at daylife.com  Mon Jun  6 15:54:35 2011
From: jason at daylife.com (JasonN)
Date: Mon, 6 Jun 2011 15:54:35 -0700 (PDT)
Subject: [Slony1-general]  Verifying Data Consistency with Slony?
Message-ID: <31787795.post@talk.nabble.com>


Hello and thanks for taking the time to read my post...

I'm using Slony-I v1.2.20 and I have a simple master/slave replication
occurring between two servers.  Recently, we had a bit of an interruption to
our network and I need to verify the consistency of the data between the two
databases. I've checked the logs for any outstanding errors, but they seem
to report that everything is running fine.  

Aside form using sql queries, is there any way to check data consistency
using slony (ie ensure that the tables are in fact replicated 1:1)?

Thanks for your help in advance!

Cheers,
Jason
-- 
View this message in context: http://old.nabble.com/Verifying-Data-Consistency-with-Slony--tp31787795p31787795.html
Sent from the Slony-I -- General mailing list archive at Nabble.com.


From vivek at khera.org  Tue Jun  7 05:40:15 2011
From: vivek at khera.org (Vick Khera)
Date: Tue, 7 Jun 2011 08:40:15 -0400
Subject: [Slony1-general] Verifying Data Consistency with Slony?
In-Reply-To: <31787795.post@talk.nabble.com>
References: <31787795.post@talk.nabble.com>
Message-ID: <BANLkTi=zr6Hm2401_6JexHSQy_OJibJ4qQ@mail.gmail.com>

On Mon, Jun 6, 2011 at 6:54 PM, JasonN <jason at daylife.com> wrote:
> Aside form using sql queries, is there any way to check data consistency
> using slony (ie ensure that the tables are in fact replicated 1:1)?
>

No.  If you don't trust slony's own report that replication is
up-to-date, then you have to run queries on the DB.

From glynastill at yahoo.co.uk  Wed Jun  8 04:05:15 2011
From: glynastill at yahoo.co.uk (Glyn Astill)
Date: Wed, 8 Jun 2011 12:05:15 +0100 (BST)
Subject: [Slony1-general] Lock set doesn't generate event in 2.0.6?
Message-ID: <331907.4657.qm@web26002.mail.ukl.yahoo.com>

Hi Guys,

Last week we upgraded from 1.2.22 to 2.0.6 and today I'm trying to move a set from one node to another.? I'm using my own set of scripts that I've been using for years with 1.2.22, however when I wait for event after lock set I get the message "Error: script did not generate any event on node 1"


Below is the script I'm running:

??????? ECHO 'ATTEMPT: Lock the set and wait for the lock:';
??????? LOCK SET ( ID = 1, ORIGIN = 1);
??????? ECHO 'ATTEMPT: Waiting for confirm on all nodes:';
??????? WAIT FOR EVENT (ORIGIN = 1, CONFIRMED = ALL, WAIT ON = 1, TIMEOUT = 0);

I know we now can't run wait for event in a try block, but what's changed and what am I doing wrong here?


Thanks
Glyn
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20110608/03ba02eb/attachment.htm 

From ssinger at ca.afilias.info  Wed Jun  8 06:16:25 2011
From: ssinger at ca.afilias.info (Steve Singer)
Date: Wed, 08 Jun 2011 09:16:25 -0400
Subject: [Slony1-general] Lock set doesn't generate event in 2.0.6?
In-Reply-To: <331907.4657.qm@web26002.mail.ukl.yahoo.com>
References: <331907.4657.qm@web26002.mail.ukl.yahoo.com>
Message-ID: <4DEF7629.3080701@ca.afilias.info>

On 11-06-08 07:05 AM, Glyn Astill wrote:
> Hi Guys,
>
> Last week we upgraded from 1.2.22 to 2.0.6 and today I'm trying to move
> a set from one node to another. I'm using my own set of scripts that
> I've been using for years with 1.2.22, however when I wait for event
> after lock set I get the message "Error: script did not generate any
> event on node 1"
>
> Below is the script I'm running:
>
> ECHO 'ATTEMPT: Lock the set and wait for the lock:';
> LOCK SET ( ID = 1, ORIGIN = 1);
> ECHO 'ATTEMPT: Waiting for confirm on all nodes:';
> WAIT FOR EVENT (ORIGIN = 1, CONFIRMED = ALL, WAIT ON = 1, TIMEOUT = 0);
>
> I know we now can't run wait for event in a try block, but what's
> changed and what am I doing wrong here?

lock set does not generate an event in either 1.2.22 or 2.0.6

What has changed between them is that if you 'wait for event' in 1.2 
when no event then the 'wait for event' command is treated like a no-op, 
it continues without waiting.  In 2.0 the 'wait for event' command 
generates an error if you try to wait for an event that does not exist.




>
>
> Thanks
> Glyn
>
>
>
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


From glynastill at yahoo.co.uk  Wed Jun  8 07:52:55 2011
From: glynastill at yahoo.co.uk (Glyn Astill)
Date: Wed, 8 Jun 2011 15:52:55 +0100 (BST)
Subject: [Slony1-general] Lock set doesn't generate event in 2.0.6?
In-Reply-To: <4DEF7629.3080701@ca.afilias.info>
References: <331907.4657.qm@web26002.mail.ukl.yahoo.com>
	<4DEF7629.3080701@ca.afilias.info>
Message-ID: <411204.56783.qm@web26006.mail.ukl.yahoo.com>






> From: Steve Singer <ssinger at ca.afilias.info>

>>  I know we now can't run wait for event in a try block, but what's
>>  changed and what am I doing wrong here?
> 
> lock set does not generate an event in either 1.2.22 or 2.0.6
> 
> What has changed between them is that if you 'wait for event' in 1.2 
> when no event then the 'wait for event' command is treated like a no-op, 
> 
> it continues without waiting.? In 2.0 the 'wait for event' command 
> generates an error if you try to wait for an event that does not exist.
> 

Ah, okay.? So there's no need to wait for event after lock set and before running move set then? 

I'm pretty sure that was the way I was advised (or read somewhere) to run move set back in the day.

Looking at the function I see it's going to have done its work by the time it returns anyway.


From ssinger at ca.afilias.info  Wed Jun  8 08:20:52 2011
From: ssinger at ca.afilias.info (Steve Singer)
Date: Wed, 08 Jun 2011 11:20:52 -0400
Subject: [Slony1-general] Lock set doesn't generate event in 2.0.6?
In-Reply-To: <411204.56783.qm@web26006.mail.ukl.yahoo.com>
References: <331907.4657.qm@web26002.mail.ukl.yahoo.com>
	<4DEF7629.3080701@ca.afilias.info>
	<411204.56783.qm@web26006.mail.ukl.yahoo.com>
Message-ID: <4DEF9354.1050504@ca.afilias.info>

On 11-06-08 10:52 AM, Glyn Astill wrote:
>
>
>
>
>

> Ah, okay.  So there's no need to wait for event after lock set and before running move set then?

No there is no need to do a 'wait for event' after a LOCK SET.

>
> I'm pretty sure that was the way I was advised (or read somewhere) to run move set back in the day.
>
> Looking at the function I see it's going to have done its work by the time it returns anyway.





From vivek at khera.org  Wed Jun  8 13:31:04 2011
From: vivek at khera.org (Vick Khera)
Date: Wed, 8 Jun 2011 16:31:04 -0400
Subject: [Slony1-general] Lock set doesn't generate event in 2.0.6?
In-Reply-To: <411204.56783.qm@web26006.mail.ukl.yahoo.com>
References: <331907.4657.qm@web26002.mail.ukl.yahoo.com>
	<4DEF7629.3080701@ca.afilias.info>
	<411204.56783.qm@web26006.mail.ukl.yahoo.com>
Message-ID: <BANLkTi=Z6i7JemBKDbePMr6ONk1or7BQiA@mail.gmail.com>

On Wed, Jun 8, 2011 at 10:52 AM, Glyn Astill <glynastill at yahoo.co.uk> wrote:
> I'm pretty sure that was the way I was advised (or read somewhere) to run move set back in the day.
>

I don't remember *ever* doing a wait for event after a lock set.  it
just waits until the lock is complete.

From glynastill at yahoo.co.uk  Wed Jun  8 20:15:57 2011
From: glynastill at yahoo.co.uk (Glyn Astill)
Date: Thu, 9 Jun 2011 04:15:57 +0100 (BST)
Subject: [Slony1-general] 2.0.6 Subscribe set errors
Message-ID: <165449.30644.qm@web26004.mail.ukl.yahoo.com>

Hi Guys,

Just had an issue with subscribe set in 2.0.6.? From what I can see somehow slonik is passing parameters 
to reshapesubscription in the wrong order, instead of (sub_set, sub_provider, sub_receiver) it seems to be 
sending (sub_provider, sub_set, sub_receiver).? In turn that made slonik hang on me and borked my subscriptions. 

Here's what I submitted to slonik:

??? SUBSCRIBE SET ( ID = 1000, PROVIDER = 4, RECEIVER = 5, FORWARD = YES );

Here's the error message I get from slonik:

??? Way5b:/pgsql/slony# slonik reshape.scr
??? reshape.scr:17: ATTEMPT:? SUBSCRIBE SET
??? reshape.scr:18: NOTICE:? subscribe set: omit_copy=f
??? reshape.scr:18: NOTICE:? subscribe set: omit_copy=f
??? CONTEXT:? SQL statement "SELECT? "_main_replication".subscribeSet_int( $1 ,? $2 ,? $3 ,? $4 ,? $5 )"
??? PL/pgSQL function "subscribeset" line 77 at PERFORM
??? reshape.scr:18: PGRES_FATAL_ERROR select "_main_replication".reshapeSubscription(4,1000,5); - ERROR:? insert or update on table "sl_subscribe" violates foreign key constraint "sl_subscribe-sl_path-ref"
??? DETAIL:? Key (sub_provider,sub_receiver)=(1000,5) is not present in table "sl_path".
??? CONTEXT:? SQL statement "update "_main_replication".sl_subscribe set sub_provider= $1? WHERE sub_set= $2? AND sub_receiver= $3 "
??? PL/pgSQL function "reshapesubscription" line 11 at SQL statement
??? error reshaping subscriber

And here's what my reshapesubscription looks like:

??? CREATE OR REPLACE FUNCTION _main_replication.reshapesubscription(integer, integer, integer)
??? ? RETURNS integer AS
??? $BODY$
??? declare
??? ??? p_sub_set??? ??? ??? alias for $1;
??? ??? p_sub_provider??? ??? alias for $2;
??? ??? p_sub_receiver??? ??? alias for $3;
??? begin
??? ??? -- ----
??? ??? -- Grab the central configuration lock
??? ??? -- ----
??? ??? lock table "_main_replication".sl_config_lock;
??? 
??? ??? update "_main_replication".sl_subscribe set sub_provider=p_sub_provider
??? ??? ??? ?? WHERE sub_set=p_sub_set AND sub_receiver=p_sub_receiver;
??? ??? if found then
??? ??? ?? perform "_main_replication".RebuildListenEntries();
??? ??? ?? notify "_main_replication_Restart";
??? ??? end if;
??? ??? return 0;
??? end
??? $BODY$
??? LANGUAGE plpgsql VOLATILE;

Looking in the slonik.c starting on on line 3541 I can see the following:

??????????????? slon_mkquery(&query,
???????????????????????????????????????? "select \"_%s\".reshapeSubscription(%d,%d,%d);",
???????????????????????????????????????? stmt->hdr.script->clustername,
???????????????????????????????????????? stmt->sub_provider,stmt->sub_setid,
???????????????????????????????????????? stmt->sub_receiver);

Unless I'm going crazy (It is now 4am), that pretty much looks the wrong way around to me?

Thanks
Glyn


